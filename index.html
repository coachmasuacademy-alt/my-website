<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Smart Coach Badminton</title>
  
<link rel="apple-touch-icon" href="icon.png?v=2">
<link rel="icon" type="image/png" href="icon.png?v=2">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Noto Sans JP", sans-serif; margin: 20px; background: #f4f4f4; }
    h2, h3 { color: #333; }
    
    select, input, button, textarea { 
      margin: 5px; 
      padding: 6px 10px; 
      font-size: 14px; 
      color: #333; 
      background: #fff; 
      border: 1px solid #ccc;
    }
    button { background: #00acc1; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #008c9e; }
    .menu-item { margin: 10px 0; padding: 10px; background: white; border: 1px solid #ccc; border-radius: 6px; }
    .selected-item { background: #e0f7fa; border-color: #00acc1; cursor: grab; }
    .dragging { opacity: 0.5; }
    #menu-list, #selected-list { margin-top: 20px; }
    #program-output, #share-preview { margin-top: 30px; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 6px; }
    textarea { width: 100%; height: 60px; }
    .status-message { margin-bottom: 10px; font-weight: bold; color: green; }

    /* ğŸ“ ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨CSS */
    .visual-court-container {
      position: relative;
      width: 100%;
      max-width: 350px; 
      height: 190px;
      margin: 0 auto 20px auto;
      background: #2e7d32;
      border: 2px solid white;
      box-sizing: border-box;
      overflow: hidden; 
    }

    .court-grid {
      display: grid;
      grid-template-columns: 1fr 4fr 4fr 1fr;
      grid-template-rows: 1fr 4fr 4fr 1fr;
      width: 100%;
      height: 100%;
    }

    .c-cell {
      border: 1px solid rgba(255,255,255,0.6);
      position: relative;
    }

    .court-net {
      position: absolute;
      top: 0; left: 50%;
      width: 2px;
      height: 100%;
      background: white;
      z-index: 5;
      transform: translateX(-50%);
      border-left: 1px dashed #ddd;
    }

    .player-label {
      position: absolute;
      transform: translate(-50%, -50%);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      border: 1px solid #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 10;
      white-space: nowrap;
    }

    /* ãƒ€ãƒ–ãƒ«ã‚¹ã®ã‚¨ãƒªã‚¢å¤–ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆç”¨ï¼‰ */
    .area-out {
      background-color: rgba(0,0,0,0.2) !important;
    }

    /* ğŸ—ºï¸ Google Charts ãƒãƒƒãƒ—ç”¨CSS */
    #map-visual-container {
      width: 100%;
      min-height: 300px; 
      margin: 0 auto;
      background-color: #b3e5fc; /* æµ·ã®è‰² */
      border-radius: 8px;
      border: 2px solid #81d4fa;
      overflow: hidden;
    }
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .google-visualization-tooltip {
      border-radius: 4px !important;
      border: none !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3) !important;
    }
  </style>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.9/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.9/build/vfs_fonts.js"></script>
  <script src="custom_fonts.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>


<script>
const firebaseConfig = {
    apiKey: "AIzaSyDSzYUAvn8sOse_twlArlMqQxh1Zug02GM",
    authDomain: "badmintoncoach3work2025.firebaseapp.com",
    projectId: "badmintoncoach3work2025",
    storageBucket: "badmintoncoach3work2025.firebasestorage.app",
    messagingSenderId: "346991672016",
    appId: "1:346991672016:web:7e98ff62c499401bc4bcd5",
    measurementId: "G-YNKCYCSSPC"
};

// Firebaseã‚’åˆæœŸåŒ–
firebase.initializeApp(firebaseConfig);

// Firestoreã¨Authã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆæ¥ç¶šçª“å£ï¼‰
const db = firebase.firestore();
const auth = firebase.auth();

// âš ï¸ ã‚°ãƒ«ãƒ¼ãƒ—ã®ç§˜å¯†ã®åˆè¨€è‘‰ã‚’å…¥åŠ› âš ï¸
const GROUP_SECRET_PASSWORD = "badmintontraining2025"; // ğŸ‘ˆ ã“ã“ã«è‡ªåˆ†ã§æ±ºã‚ãŸåˆè¨€è‘‰ã‚’è¨­å®š

let currentProgramId = "default_program"; 
let isAuthenticated = false; // èªè¨¼çŠ¶æ…‹ãƒ•ãƒ©ã‚°
let feedbackData = []; // æ„Ÿæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—

// ==============================================
// ... æ—¢å­˜ã®å®šæ•°ãƒ»å¤‰æ•°ã®å®šç¾©
const SHEET_URL = "https://script.google.com/macros/s/AKfycbw5dsDBYvacMIqgCUjOF3unkyaNIyqRrQrHJh-1wK5OLuS4N8pWXDNlqnBOFoxD1psFPQ/exec";
let sheetData = [];
let selectedMenus = [];
let editableName = "";
let editablePurpose = "";
let isProgramGenerated = false;

// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
async function loginWithPassword() {
    const passwordInput = document.getElementById("passwordInput");
    const password = passwordInput.value;
    const loginStatus = document.getElementById("login-status");

    if (password === GROUP_SECRET_PASSWORD) {
        try {
            
await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);

            await auth.signInAnonymously();
            
            // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«UIã‚’æ›´æ–° (onAuthStateChangedãŒã“ã‚Œã‚’å—ã‘å–ã£ã¦å‡¦ç†ã—ã¾ã™)
            loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼";
            loginStatus.classList.remove('text-red-500');
            loginStatus.classList.add('text-green-500');

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            passwordInput.value = '';

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çŸ­æ™‚é–“è¡¨ç¤º
            setTimeout(() => {
                loginStatus.textContent = "";
            }, 3000);
        } catch (error) {
            console.error("Authentication Error:", error);
            loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            loginStatus.classList.remove('text-green-500');
            loginStatus.classList.add('text-red-500');
        }
    } else {
        loginStatus.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚/The password is incorrect.";
        loginStatus.classList.remove('text-green-500');
        loginStatus.classList.add('text-red-500');
    }
}

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
function logout() {
    // 1. èª¤æ“ä½œé˜²æ­¢ã®ç¢ºèª
    if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

    // 2. Firebaseã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
    auth.signOut().then(() => {
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
        
        // 3. ã€é‡è¦ã€‘ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€ç”»é¢ã¨å¤‰æ•°ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹
        location.reload(); 
        
    }).catch((error) => {
        console.error("Sign Out Error:", error);
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
    });
}

async function loadFeedbacks() {
    const listEl = document.getElementById("feedback-list");
    listEl.innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";
    
    try {
        const snapshot = await db.collection("feedbacks")
                                 .orderBy("timestamp", "desc")
                                 .limit(20)
                                 .get();
        
        if (snapshot.empty) {
            listEl.innerHTML = "<p>ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            return;
        }

        let html = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ja-JP') : 'æ—¥ä»˜ä¸æ˜';
            const docId = doc.id; // å‰Šé™¤ã™ã‚‹ãŸã‚ã«IDãŒå¿…è¦

            html += `
                <div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #fafafa; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <p style="margin: 0;"><strong>${data.name}</strong> <span style="font-size: 12px; color: #777;">(${date})</span></p>
                        
                        <button onclick="deleteFeedback('${docId}')" style="
                            background: #ff5252; 
                            color: white; 
                            border: none; 
                            border-radius: 4px; 
                            padding: 2px 8px; 
                            font-size: 12px; 
                            cursor: pointer;">
                            å‰Šé™¤
                        </button>
                    </div>
                    <p style="margin: 5px 0 0 0; white-space: pre-wrap;">${data.text}</p>
                </div>
            `;
        });

        listEl.innerHTML = html;

    } catch (error) {
        console.error("Error loading feedbacks: ", error);
        listEl.innerHTML = "<p style='color:red;'>æ„Ÿæƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    }
}

// ===========================
// âœ… æ„Ÿæƒ³å‰Šé™¤å‡¦ç†ï¼ˆæ–°è¦è¿½åŠ ï¼‰
// ===========================
async function deleteFeedback(docId) {
    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    if (!confirm("æœ¬å½“ã«ã“ã®æ„Ÿæƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        return;
    }

    try {
        // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
        await db.collection("feedbacks").doc(docId).delete();
        
        alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        
        // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç”»é¢ã‚’æ›´æ–°
        await loadFeedbacks();

    } catch (error) {
        console.error("Error removing document: ", error);
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
    }
}

// ===========================
// âœ… æ„Ÿæƒ³æŠ•ç¨¿å‡¦ç†
// ===========================
async function handleFeedbackSubmit() {
    const nameInput = document.getElementById("feedback-name");
    const textInput = document.getElementById("feedback-text");
    const statusEl = document.getElementById("feedback-status");

    const name = nameInput.value.trim() || "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼";
    const text = textInput.value.trim();

    if (!text) {
        statusEl.textContent = "æ„Ÿæƒ³æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
    }

    try {
        // 1. Firestoreã«ä¿å­˜
        await db.collection("feedbacks").add({
            name: name,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        statusEl.textContent = "æ„Ÿæƒ³ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼";
        statusEl.style.color = "green";
        textInput.value = ''; 
        nameInput.value = '';

        // 2. ä¿å­˜ãŒæˆåŠŸã—ãŸã‚‰ã€ã™ãã«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦è¡¨ç¤ºæ›´æ–°
        console.log("æŠ•ç¨¿æˆåŠŸã€‚ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã™ã€‚"); 
        await loadFeedbacks(); 

        setTimeout(() => { statusEl.textContent = ""; }, 3000);

    } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹
        console.error("Error writing feedback: ", error);
        statusEl.textContent = "æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: " + error.message; 
        statusEl.style.color = "red";
    }
}

// èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
auth.onAuthStateChanged(user => {
    const authContainer = document.getElementById("auth-container");
    const programContainer = document.getElementById("program-output");
    const shareSection = document.getElementById("share-section");
    const feedbackContainer = document.getElementById("feedback-container");
    const logoutBtn = document.getElementById("logout-button");

    if (user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
        isAuthenticated = true;
        
        // ãƒ­ã‚°ã‚¤ãƒ³UIã‚’éè¡¨ç¤ºã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (authContainer) authContainer.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'block';

        // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚„æ„Ÿæƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        // ğŸš¨ ä¿®æ­£: programContainerã®è¡¨ç¤ºæ¡ä»¶ã‚’å‰Šé™¤ã¾ãŸã¯ç°¡ç´ åŒ–
        if (programContainer) programContainer.style.display = 'block'; 
Â  Â  Â  Â  if (shareSection) shareSection.style.display = 'block';
Â  Â  Â  Â  
Â  Â  Â  Â  if (feedbackContainer) { // ğŸ‘ˆ ã“ã“ã‚’ä¿®æ­£
Â  Â  Â  Â  Â  Â  feedbackContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  loadFeedbacks();Â  Â  Â // ğŸ‘ˆ â˜…â˜…â˜… ã“ã®è¡Œã‚’è¿½åŠ  â˜…â˜…â˜…
Â  Â  Â  Â  }

Â  Â  } else {
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿
        isAuthenticated = false;

        // ãƒ­ã‚°ã‚¤ãƒ³UIã‚’è¡¨ç¤ºã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        if (authContainer) authContainer.style.display = 'block';
        if (logoutBtn) logoutBtn.style.display = 'none';

        // èªè¨¼ãŒå¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        if (programContainer) programContainer.style.display = 'none';
        if (shareSection) shareSection.style.display = 'none';
        if (feedbackContainer) feedbackContainer.style.display = 'none';
    }
});

    async function loadSheet() {
        try {
            let statusEl = document.getElementById("statusMessage");
            if (statusEl) {
                statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...ï¼Retrieving dataâ€¦";
                statusEl.style.color = "orange";
            }

            const res = await fetch(SHEET_URL);
            sheetData = await res.json();
            // â˜…ãƒã‚¤ãƒ³ãƒˆ: Fåˆ—ã®ç”»åƒURLã¯ã€ã“ã“ã§ã¯ã€Œç”»åƒURLã€ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã¦ã„ã‚‹ã¨æƒ³å®šã—ã¾ã™ã€‚
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

renderBeginnerSection();

            // DOM ãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã«ã‚‚å¯¾å¿œ
            statusEl = document.getElementById("statusMessage");
            if (statusEl) {
                statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼ï¼Data acquisition successful!";
                statusEl.style.color = "green";
            }
        } catch (err) {
            alert("ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
            let statusEl = document.getElementById("statusMessage");
            if (statusEl) {
                statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
                statusEl.style.color = "red";
            }
        }
    }

// ==========================================
// âœ… åˆå¿ƒè€…æŒ‡å°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»å‡¦ç†ï¼ˆãƒªãƒ³ã‚¯æ–¹å¼ï¼‰
// ==========================================
function renderBeginnerSection() {
    // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const beginnerMenus = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === "åˆå¿ƒè€…æŒ‡å°");
    const section = document.getElementById("beginner-instruction-section");
    const listContainer = document.getElementById("beginner-menu-list");

    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯éè¡¨ç¤º
    if (!beginnerMenus.length) {
        section.style.display = "none";
        return;
    }

    section.style.display = "block";
    listContainer.innerHTML = "";

    beginnerMenus.forEach((menu) => {
        // å‹•ç”»IDã®æŠ½å‡º
        let videoId = "";
        const url = menu["YouTube URL"] || "";
        const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|v\/|embed\/|user\/\S+|shorts\/))([^#\?&]+)/);
        if (match && match[1]) {
            videoId = match[1];
        }

        // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        const item = document.createElement("div");
        item.style.cssText = `
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
            transition: background 0.2s; 
            display: flex; 
            align-items: center; 
            gap: 15px;
        `;
        // ãƒ›ãƒãƒ¼åŠ¹æœ
        item.onmouseover = () => { item.style.background = "#f1f8e9"; };
        item.onmouseout = () => { item.style.background = "transparent"; };

        // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ
        let thumbHtml = "";
        if (videoId) {
            thumbHtml = `<img src="https://img.youtube.com/vi/${videoId}/default.jpg" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px;">`;
        } else {
            thumbHtml = `<div style="width:80px; height:60px; background:#eee; border-radius:6px; display:flex; align-items:center; justify-content:center;">No Video</div>`;
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸­èº«ï¼ˆã€ŒYouTubeã§è¦‹ã‚‹ã€ã¨ã„ã†æ–‡è¨€ã‚’è¿½åŠ ï¼‰
        item.innerHTML = `
            ${thumbHtml}
            <div>
                <div style="font-weight: bold; font-size: 15px; color: #333; margin-bottom: 4px;">
                    ${menu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å} <span style="font-size:12px; color:#1a73e8;">(YouTube â†—)</span>
                </div>
                <div style="font-size: 12px; color: #666;">${menu.èª¬æ˜ || ""}</div>
            </div>
        `;

        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œï¼šwindow.openã§é–‹ã
        item.onclick = () => {
            if (videoId) {
                const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;
                window.open(watchUrl, '_blank');
            } else {
                alert("å‹•ç”»URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
            }
        };

        listContainer.appendChild(item);
    });
}

    function renderSharePreview(lang = 'ja') {
        const preview = document.getElementById("share-preview");
        if (!preview) return;

        const { name, purpose, totalTime } = generateProgramInfo();
        const t = translations[lang] || translations.ja;


        let html = `
            <h3>${name}</h3>
            <p>${purpose}</p>
            <p id="total-time-display"><strong>${t.totalTimeLabel}ï¼š<span id="total-time">${totalTime}</span> ${lang === 'ja' ? 'åˆ†' : 'min'}</strong></p>
            <hr>
        `;

        selectedMenus.forEach(m => {
            // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã«ã‚‚ç”»åƒURLã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã€m.imgUrlã‚’ã“ã“ã§ã‚‚åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
            html += `
                <p>
                    <strong>[${m.category}] ${m.name}</strong>
                    ${m.time ? `ï¼ˆ${m.time}${lang==='ja'?'åˆ†':'min'}ï¼‰` : ""}
                    <br>
                    ${m.note ? m.note : ""}
                </p>
            `;
        });

        preview.innerHTML = html;
    }

    async function showMenu(category) {
    if (!sheetData.length) {
        await loadSheet();
    }
    const menus = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === category);
    const menuContainer = document.getElementById("menu-list");
    
    if (!menus.length) {
        menuContainer.innerHTML = `<p>ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
    }

    // â–¼ è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®HTML
    const closeBtnHtml = `
        <div style="text-align: right; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 5px;">
            <button id="close-menu-list-btn" style="background: #757575; color: white; border: none; border-radius: 4px; padding: 5px 15px; cursor: pointer;">
                Ã— ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
            </button>
        </div>
    `;

    const menuItemsHtml = menus.map((m, i) => {
        const imageUrl = m["ç”»åƒURL"] && m["ç”»åƒURL"].trim() ? m["ç”»åƒURL"].trim() : null;
        const englishCategories = ["Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength", "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice"];
        const isEnglishCategory = englishCategories.includes(category);
        const descriptionText = m.èª¬æ˜ || "Description is being prepared.";
        
        const readButtonHtml = isEnglishCategory ? 
            `<div style="margin-bottom: 8px; display: block; text-align: left;">
                <button onclick="speakText('${encodeURIComponent(descriptionText)}', 'en-US')" style="font-size: 12px; padding: 6px 10px; background: #3f51b5; color: white; margin-right: 8px;">ğŸ”Š Listen (EN)</button>
                <button onclick="stopSpeech()" style="font-size: 12px; padding: 6px 10px; background: #f44336; color: white;">â¹ï¸ Stop</button>
            </div>` : '';
        
        const descriptionBody = m.èª¬æ˜ ? m.èª¬æ˜ : (isEnglishCategory ? "Description is being prepared." : "èª¬æ˜ã¯æº–å‚™ä¸­ã§ã™ã€‚");
        
        const imageHtml = `<div style="flex: 0 0 auto; width: 120px; height: 120px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; margin-right: 5px; overflow: hidden;">
                ${imageUrl ? `<img src="${imageUrl}" alt="${m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}ã®ç”»åƒ" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">` : ''}
            </div>`;
        
        // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: é…åˆ—ã« "ã‚²ãƒ¼ãƒ ", "Game" ã‚’è¿½åŠ  â–¼â–¼â–¼
        const controlsHtml = `
            <div style="flex: 2; padding-right: 15px; min-width: 250px;"> 
                <h3 style="margin: 0 0 5px 0;">${m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}</h3>
                ${m["YouTube URL"] ? `<a href="${m["YouTube URL"]}" target="_blank" style="display:inline-block; margin-bottom:8px;">ğŸ¥ å‹•ç”»ã‚’è¦‹ã‚‹ï¼Watch on YouTube</a><br>` : ""}
                ${["ãƒãƒƒã‚¯ç³»", "ãƒ©ãƒªãƒ¼ç³»", "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "ã‚²ãƒ¼ãƒ ", "Game", "Knock", "Rally", "Warm-up", "Footwork", "Break (Preparing the next plan)", "Physical"].includes(category)
                    ? `æ™‚é–“(åˆ†): <input type="number" min="0.1" step="0.1" value="${m["å¹³å‡æ™‚é–“ï¼ˆåˆ†ï¼‰"] || ""}" data-time-minutes style="width:60px;">`
                    : ""}
                <button data-add data-index="${i}" style="margin-left:8px;">è¿½åŠ </button>
            </div>
        `;

        const descriptionHtml = `<div style="flex: 3; font-size: 13px; color: #555; background:#fafafa; padding:8px; border-radius:4px; line-height: 1.5;">
                ${readButtonHtml} 
                <p style="margin: 0; padding: 0;">${descriptionBody}</p> 
            </div>`;

        return `<div class="menu-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border-bottom: 1px solid #eee;">
                ${controlsHtml}
                ${imageHtml}
                ${descriptionHtml}
            </div>`;
    }).join("");

    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
    menuContainer.innerHTML = closeBtnHtml + menuItemsHtml;

    // â–¼ è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‹•ä½œè¨­å®š
    document.getElementById("close-menu-list-btn").addEventListener("click", () => {
        menuContainer.innerHTML = ""; // ãƒªã‚¹ãƒˆã‚’æ¶ˆã™
        document.getElementById("category").value = ""; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    });

    // æ—¢å­˜ã®ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    const menusForEvent = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === category); 
    menuContainer.querySelectorAll("[data-add]").forEach(btn => {
        btn.addEventListener("click", e => {
            const idx = parseInt(e.target.dataset.index);
            const menu = menusForEvent[idx];
            let timeValue = 0;

            // æ™‚é–“å…¥åŠ›ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒªã®å ´åˆã®ãƒã‚§ãƒƒã‚¯
            if (!["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(menu.ã‚«ãƒ†ã‚´ãƒª)) {
                
                const inputEl = e.target.closest('.menu-item').querySelector('[data-time-minutes]');
                const inputVal = inputEl ? inputEl.value : "";

                // âœ… ä¿®æ­£ï¼šæ™‚é–“ãŒç©ºæ¬„ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã—ã¦çµ‚äº†
                if (inputVal === "") {
                    alert("æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nPlease enter the time.");
                    return; // ã“ã“ã§å‡¦ç†ã‚’ã‚¹ãƒˆãƒƒãƒ—
                }

                timeValue = parseFloat(inputVal);
            }

            selectedMenus.push({
                category: menu.ã‚«ãƒ†ã‚´ãƒª,
                name: menu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å,
                sets: "",
                perSet: 0,
                time: timeValue,
                url: menu["YouTube URL"] || "",
                note: menu.èª¬æ˜ || "",
                imgUrl: menu["ç”»åƒURL"] || ""
            });
            renderSelectedList();
        });
    });
}


    function renderSelectedList() {
  const selDiv = document.getElementById("selected-list");
  selDiv.innerHTML = "";

  selectedMenus.forEach((m, i) => {
    const div = document.createElement("div");
    div.className = "selected-item menu-item";
    div.draggable = true;
    div.dataset.index = i;

    // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã§å†…å®¹ã‚’è¿½åŠ 
    const textNode = document.createTextNode(`[${m.category}] ${m.name}${m.time ? `ï¼ˆ${m.time}åˆ†ï¼‰` : ""}${m.note ? `ï¼š${m.note}` : ""}`);
    div.appendChild(textNode);

   const btn = document.createElement("button");
    btn.textContent = "Ã—";
    btn.style.marginLeft = "10px";
   btn.addEventListener("click", () => {
      selectedMenus.splice(i, 1);
      renderSelectedList();
  });

    div.appendChild(btn);
    selDiv.appendChild(div);
  });

  // ç·æ™‚é–“æ›´æ–°
let totalTime = selectedMenus.reduce((sum, m) => {
  return sum + (m.time || 0);
}, 0);
document.getElementById("total-time").textContent = totalTime.toFixed(1);

enableDragAndDrop();
updateTimeProgress();
}

// ===========================
// ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
// ===========================
function enableDragAndDrop() {
  const items = document.querySelectorAll("#selected-list .selected-item");
  const container = document.getElementById("selected-list");

  items.forEach(item => {
    item.addEventListener("dragstart", e => {
      item.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });

    item.addEventListener("dragend", () => {
      item.classList.remove("dragging");
    });
  });

  container.addEventListener("dragover", e => {
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    const afterElement = getDragAfterElement(container, e.clientY);

    if (afterElement == null) {
      container.appendChild(dragging);
    } else {
      container.insertBefore(dragging, afterElement);
    }
  });

  container.addEventListener("drop", () => {
    const newOrder = Array.from(
      container.querySelectorAll(".selected-item")
    ).map(el => selectedMenus[parseInt(el.dataset.index)]);

    selectedMenus = newOrder.filter(Boolean);
    renderSelectedList();
   });
}

// ===========================
// æ™‚é–“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
// ===========================
function updateTimeProgress() {
  const targetEl = document.getElementById("target-time");
  const bar = document.getElementById("time-progress-bar");
  const status = document.getElementById("time-status");
  if (!targetEl || !bar || !status) return;

  // total ã¨ target ã‚’1å›ã ã‘è¨ˆç®—
  const total = selectedMenus.reduce((sum, m) => sum + (m.time || 0), 0);
  
  // âœ… ã“ã“ã‚’ä¿®æ­£ (cconst -> const)
  const targetVal = targetEl.value;
  const target = targetVal === "" ? 0 : parseFloat(targetVal);

  const percent = target > 0 ? Math.min((total / target) * 100, 100) : 0;

  bar.style.width = percent + "%";
  bar.style.background = percent >= 100 ? "#e53935" : "#4caf50";

  // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ã£ã¦ç©ºã§ã‚‚è‹±èªè¡¨ç¤ºã•ã‚Œã‚‹
  const t = translations[currentLang];
  status.textContent = `${t.now} ${total} / ${target} ${t.minutes}`;
}

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll(".selected-item:not(.dragging)")];
      return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    window.removeSelected = function (i) {
      selectedMenus.splice(i, 1);
      renderSelectedList();
    };

    function generateProgramInfo() {
      const formName = document.getElementById('editable-name')?.value;
      const formPurpose = document.getElementById('editable-purpose')?.value;
      const totalTime = selectedMenus.reduce((sum, m) => sum + (m.time || 0), 0);
      const timeByCat = {};
      selectedMenus.forEach(m => {
        timeByCat[m.category] = (timeByCat[m.category] || 0) + (m.time || 0);
      });

      const sorted = Object.entries(timeByCat).sort((a, b) => b[1] - a[1]);
      const mainCategory = sorted[0] ? sorted[0][0] : "";
      const mainTime = sorted[0] ? sorted[0][1] : 0;
      const mainShare = totalTime > 0 ? mainTime / totalTime : 0;

      const label = {
  "ãƒ©ãƒªãƒ¼ç³»": "ãƒ©ãƒªãƒ¼", 
    "ãƒãƒƒã‚¯ç³»": "ãƒãƒƒã‚¯", 
    "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯": "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯",
    "ãƒ•ã‚£ã‚¸ã‚«ãƒ«": "ãƒ•ã‚£ã‚¸ã‚«ãƒ«",
    "è£œå¼·": "è£œå¼·",  
    "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—": "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", 
    "çŸ¥è­˜": "çŸ¥è­˜",
    "æ³•æ”¿å¤§å­¦ç·´ç¿’": "æ³•æ”¿å¤§å­¦ç·´ç¿’",
    "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰": "ä¼‘æ†©",
    // â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼
    "ã‚²ãƒ¼ãƒ ": "ã‚²ãƒ¼ãƒ ç·´ç¿’",
    "Game": "Game",
    // AIæŠ½å‡ºãªã©ã§ã€Œç³»ã€ãŒã¤ã‹ãªã„å ´åˆã¸ã®ä¿é™º
    "ãƒ©ãƒªãƒ¼": "ãƒ©ãƒªãƒ¼",
    "ãƒãƒƒã‚¯": "ãƒãƒƒã‚¯"
};

      let programName = (currentLang === 'ja') ? "ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ " : "Comprehensive Training Program";
      if (mainShare >= 0.5) {
        programName = `${label[mainCategory] || mainCategory}é›†ä¸­ãƒ—ãƒ­ã‚°ãƒ©ãƒ `;
      } else if (sorted.length > 1) {
        const second = sorted[1][0], secondTime = sorted[1][1];
        const combinedShare = (mainTime + secondTime) / totalTime;
        if (combinedShare >= 0.65) {
          programName = `${label[mainCategory] || mainCategory}ï¼†${label[second] || second}çµ±åˆãƒ—ãƒ­ã‚°ãƒ©ãƒ `;
        } else {
          programName = `ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆ${label[mainCategory] || mainCategory}ä¸­å¿ƒï¼‰`;
        }
      }

      const keywordMap = [
    { keys: ["ã‚¹ãƒ†ãƒƒãƒ—", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "æ©Ÿå‹•"], goal: "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼æ©Ÿå‹•åŠ›" },
    { keys: ["ãƒ€ãƒƒã‚·ãƒ¥", "ã‚¹ãƒ—ãƒªãƒ³ãƒˆ", "ã‚¹ãƒ”ãƒ¼ãƒ‰", "ç¬ç™º"], goal: "ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ç¬ç™ºåŠ›" },
    { keys: ["æŒä¹…", "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ãƒ©ãƒ³"], goal: "æŒä¹…åŠ›" },
    { keys: ["ã‚¸ãƒ£ãƒ³ãƒ—", "ãƒ—ãƒ©ã‚¤ã‚ª"], goal: "ç¬ç™ºåŠ›ï¼ã‚¸ãƒ£ãƒ³ãƒ—åŠ›" },
    { keys: ["ä½“å¹¹", "ã‚³ã‚¢", "å§¿å‹¢"], goal: "ä½“å¹¹ï¼å®‰å®šæ€§" },
    { keys: ["ç­‹åŠ›", "ã‚¦ã‚§ã‚¤ãƒˆ", "ç­‹ãƒˆãƒ¬"], goal: "ç­‹åŠ›å¼·åŒ–" },
    { keys: ["ãƒ©ãƒªãƒ¼", "ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯", "ãƒ‰ãƒ©ã‚¤ãƒ–"], goal: "ãƒ©ãƒªãƒ¼æŠ€è¡“ï¼å®‰å®šæ€§" },
    { keys: ["ã‚µãƒ¼ãƒ–", "ãƒ¬ã‚·ãƒ¼ãƒ–"], goal: "ã‚µãƒ¼ãƒ–ï¼ãƒ¬ã‚·ãƒ¼ãƒ–" },
    { keys: ["æˆ¦è¡“", "çŸ¥è­˜", "ç†è«–"], goal: "æˆ¦è¡“ç†è§£ï¼æŠ€è¡“ç†è§£" },
    { keys: ["è£œå¼·", "ãƒãƒ©ãƒ³ã‚¹", "ä½“å¹¹ãƒˆãƒ¬", "ãƒªãƒãƒ“ãƒª"], goal: "è£œå¼·ãƒ»ã‚±ã‚¬äºˆé˜²ï¼å®‰å®šæ€§å¼·åŒ–" }
  ];

      const detected = new Set();
      selectedMenus.forEach(m => {
        const text = ((m.name || "") + " " + (m.note || "")).toLowerCase();
        keywordMap.forEach(k => {
          k.keys.forEach(kw => {
            if (text.includes(kw.toLowerCase())) detected.add(k.goal);
          });
        });
      });

      let purpose = "";

// ä¸­å¿ƒã‚«ãƒ†ã‚´ãƒªã®æ¯”ç‡ãŒ50%ä»¥ä¸Šã®å ´åˆã«è©³ç´°æ–‡ç« ã‚’è¨­å®š
if (mainShare >= 0.4) {
    switch (mainCategory) {
      case "ãƒãƒƒã‚¯ç³»":
      case "ãƒãƒƒã‚¯": // â† ä¿é™ºã¨ã—ã¦è¿½åŠ 
        purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ãƒãƒƒã‚¯ç·´ç¿’ã‚’ä¸­å¿ƒã«æ§‹æˆã—ã€ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã¨æŠ€è¡“ã®å®‰å®šæ€§å‘ä¸Šã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
é«˜ã„å¼·åº¦ã§ã®æ‰“æ’ƒã‚„ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’é€šã˜ã¦ã€è©¦åˆä¸­ã§ã‚‚å®‰å®šã—ã¦å‹•ã‘ã‚‹èº«ä½“èƒ½åŠ›ã‚’é¤Šã†ã¨ã¨ã‚‚ã«ã€å„ã‚·ãƒ§ãƒƒãƒˆã®ç²¾åº¦ã‚’é«˜ã‚ã¾ã™ã€‚`;
        break;
      case "ãƒ©ãƒªãƒ¼ç³»":
      case "ãƒ©ãƒªãƒ¼": 
        purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ãƒ©ãƒªãƒ¼ç·´ç¿’ã‚’å¤šãå–ã‚Šå…¥ã‚Œã€å®Ÿè·µçš„ãªçŠ¶æ³ã®ä¸­ã§æŠ€è¡“ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
ç›¸æ‰‹ã¨ã®é§†ã‘å¼•ãã‚„ãƒ©ãƒªãƒ¼å±•é–‹ã‚’é€šã˜ã¦ã€åˆ¤æ–­åŠ›ãƒ»æˆ¦è¡“ç†è§£ãƒ»å¿œç”¨åŠ›ã‚’é¤Šã„ã€è©¦åˆã§ç”Ÿãã‚‹ãƒ—ãƒ¬ãƒ¼ã®è³ªã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚`;
        break;
      case "ã‚²ãƒ¼ãƒ ":
      case "Game":
        purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã‚²ãƒ¼ãƒ ï¼ˆå®Ÿæˆ¦ï¼‰å½¢å¼ã®ç·´ç¿’ã‚’ä¸­å¿ƒã«ã€æˆ¦è¡“ã®ç¢ºèªã¨å¿œç”¨åŠ›ã®å‘ä¸Šã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
ç·´ç¿’ã§åŸ¹ã£ãŸæŠ€è¡“ã‚’å®Ÿæˆ¦ã®ä¸­ã§ã©ã†æ´»ã‹ã™ã‹ã‚’ç¢ºèªã—ã€ã‚²ãƒ¼ãƒ å‹˜ã‚„é§†ã‘å¼•ãã®èƒ½åŠ›ã‚’é¤Šã„ã¾ã™ã€‚`;
        break;
    case "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—":
      purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã€ç·´ç¿’å‰ã«èº«ä½“ã‚’å®‰å…¨ã‹ã¤åŠ¹ç‡çš„ã«å‹•ã‹ã™ãŸã‚ã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚
é–¢ç¯€å¯å‹•åŸŸã®æ‹¡å¤§ã¨ç­‹æ¸©ã®ä¸Šæ˜‡ã‚’ç›®çš„ã¨ã—ã€æ€ªæˆ‘ã®äºˆé˜²ã¨å‹•ä½œã®ã‚­ãƒ¬ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç‹™ã„ã¾ã™ã€‚`;
      break;
    case "ãƒ•ã‚£ã‚¸ã‚«ãƒ«":
      purpose = `ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã«å¿…è¦ãªã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»ç¬ç™ºåŠ›ãƒ»ä½“å¹¹å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸãƒ•ã‚£ã‚¸ã‚«ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä¸­å¿ƒã«å®Ÿæ–½ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒˆä¸Šã§ã®ç´ æ—©ã„å‹•ãå‡ºã—ã‚„å§¿å‹¢åˆ¶å¾¡ã‚’å¼·åŒ–ã—ã€è©¦åˆä¸­ã®å‹•ä½œåŠ¹ç‡ã¨æŒä¹…æ€§ã®å‘ä¸Šã‚’ç‹™ã„ã¾ã™ã€‚`;
      break;
    case "è£œå¼·":
      purpose = "ç­‹åŠ›ãƒ»ä½“å¹¹ã®å®‰å®šæ€§å‘ä¸ŠãŠã‚ˆã³ã‚±ã‚¬ã®äºˆé˜²ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚";
      break;
    default:
      purpose = `${label[mainCategory] || mainCategory}ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚`;
  }
} else {
  // ä¸­å¿ƒã‚«ãƒ†ã‚´ãƒªãŒãªã„å ´åˆã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ®‹ã™
if (detected.size > 0) {
    const arr = Array.from(detected);
    
    // ğŸŒŸ ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: è¨€èªåˆ¤å®šã‚’è¿½åŠ ã—ã€ç›®çš„æ–‡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    if (currentLang === 'ja') {
        purpose = `${arr.slice(0, 3).join("ã€")}ã®å‘ä¸Šã‚’ä¸»ãªç›®çš„ã¨ã™ã‚‹ã€‚`;
    } else {
        // è‹±èªã®ç›®çš„æ–‡ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è‹±èªã§è¡¨ç¤ºã™ã‚‹ã“ã¨ã¯è¤‡é›‘ãªã®ã§ã€ã“ã“ã§ã¯æ±ç”¨çš„ãªè¡¨ç¾ã‚’ä½¿ã†ã‹ã€arrã®å„è¦ç´ ã‚’äº‹å‰ã«ç¿»è¨³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
        // arrã®è¦ç´ ï¼ˆä¾‹: "Rally", "Footwork"ï¼‰ã¯è‹±èªãªã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€ã“ã“ã§ã¯æ±ç”¨çš„ãªè¡¨ç¾ã‚’æ¡ç”¨ã—ã¾ã™ã€‚
        // ã‚‚ã—arrã®è¦ç´ ã‚’ãã®ã¾ã¾ä½¿ã†å ´åˆã¯ã€
        // purpose = `The primary goal is to improve skills such as ${arr.slice(0, 3).join(", ")}.`;
        
        // æ±ç”¨çš„ãªè¡¨ç¾
        purpose = "The main objective is to improve key skills and conditioning detected in the selected menus.";
    }
} else {
    // ğŸ’¡ ã“ã®è¡Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ - ã“ã‚Œã¯å‰å›ã®ä¿®æ­£ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“)
    
    if (currentLang === 'ja') {
        purpose = `${label[mainCategory] || mainCategory}ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚`;
    } else {
        // è‹±èªã®å ´åˆã®é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
        const label_en = {
            "Rally": "Rally", "Knock": "Knock", "Footwork": "Footwork",
            "Physical": "Physical", "Strength": "Strength", "Warm-up": "Warm-up",
            "Knowledge": "Knowledge", "Hosei Univ Practice": "Hosei Univ Practice",
            "Break (Preparing the next plan)": "Break",
            // Generalãªã©ã®ã‚«ãƒ†ã‚´ãƒªãŒãªã„å ´åˆã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            "General": "General Skill"
        };
        const mainCat = mainCategory || 'General';
        purpose = `Aims to strengthen ${label_en[mainCat] || mainCat}.`;
    }
}
}

return {
    name: formName || programName,
    purpose: formPurpose || purpose,
    totalTime: parseFloat(totalTime.toFixed(1))
  };
}
    
async function displayProgram() {
  if (!selectedMenus.length) return alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“\nNo plan has been selected.");

  // â˜…ä½œæˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ONã«ã™ã‚‹
  isProgramGenerated = true;

  // â˜…è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºã™ã‚‹ï¼ˆã“ã‚ŒãŒã€Œè¡¨ç¤ºã•ã‚Œãªã„ã€å¯¾ç­–ã§ã™ï¼‰
  const outputDiv = document.getElementById("program-output");
  outputDiv.style.display = "block";

  try {
    const { name, purpose, totalTime } = generateProgramInfo();
    editableName = name;
    editablePurpose = purpose;

    const startInput = document.getElementById("start-time")?.value || "00:00";
    let [startHour, startMin] = startInput.split(":").map(v => parseInt(v) || 0);
    let currentTime = startHour * 60 + startMin;

    const formatTime = (min) => {
      const h = Math.floor(min / 60);
      const m = min % 60;
      return `${h}:${m.toString().padStart(2, "0")}`;
    };

    const mainCategories = [
    "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ©ãƒªãƒ¼ç³»", "ãƒãƒƒã‚¯ç³»", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "è£œå¼·", 
    "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "æ–°è¦ä½œæˆ",
    // â–¼ è¿½åŠ  â–¼
    "ã‚²ãƒ¼ãƒ ", "ãƒãƒƒã‚¯", "ãƒ©ãƒªãƒ¼", 
    // â–² è¿½åŠ  â–²
    "Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength", 
    "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice",
    // â–¼ è¿½åŠ  â–¼
    "Game"
    // â–² è¿½åŠ  â–²
];
    const mainList = selectedMenus.filter(m => mainCategories.includes(m.category));

    let html = `
    <label id="program-name-label" for="program-name">ãƒ—ãƒ­ã‚°ãƒ©ãƒ åï¼š</label><br>
    <input type="text" id="editable-name" value="${editableName}" style="width:100%;"><br>
    <label id="program-goal-label" for="program-goal">ç›®çš„ï¼š</label><br>
    <textarea id="editable-purpose">${editablePurpose}</textarea>

    <h4 id="program-content-title">ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…å®¹ã€‘</h4>
    <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; table-layout:auto; word-wrap:break-word;">
      <thead style="background:#e0f7fa;">
        <tr>
          <th id="th-time" style="width:15%; text-align:center;">æ™‚é–“</th>
          <th id="th-main-training" style="width:45%; text-align:center;">ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</th>
          <th id="th-additional-info" style="width:25%; text-align:left;">è£œè¶³èª¬æ˜</th>
          <th id="th-youtube" style="width:15%; text-align:center;">YouTube</th>
        </tr>
      </thead>
      <tbody>
    `;

    for (const main of mainList) {
      const start = formatTime(currentTime);
      const duration = (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(main.category)) ? 0 : (main.time || 0);
      currentTime += duration;
      const end = formatTime(currentTime);

      // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
      let urlHtml = "";
      if (main.url) {
        try {
          const cleanUrl = main.url.trim().replace(/\s+/g, "");
          const tempDiv = document.createElement("div");
          new QRCode(tempDiv, { text: cleanUrl, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L });
          const canvas = tempDiv.querySelector("canvas");
          if (canvas) {
            const qrDataUrl = canvas.toDataURL("image/png");
            urlHtml = `<a href="${cleanUrl}" target="_blank"><img src="${qrDataUrl}" alt="QR" width="80" height="80"></a><br><a href="${cleanUrl}" target="_blank" style="font-size:12px; color:#007acc;">Link</a>`;
          } else {
             urlHtml = `<a href="${cleanUrl}" target="_blank" style="font-size:12px;">Link</a>`;
          }
        } catch (qrError) {
          urlHtml = `<a href="${main.url}" target="_blank" style="font-size:12px;">Link</a>`;
        }
      }

      html += `
        <tr>
          <td>${start}â€“${end}</td>
          <td>[${main.category}] ${main.name}${duration ? `ï¼ˆ${duration}åˆ†ï¼‰` : ""}</td>
          <td style="padding:0; text-align:left;">
            <textarea data-note-index="${mainList.indexOf(main)}"
              style="width:95%; height:120%; box-sizing:border-box; border:none; resize:none; padding:6px; font-family:'Noto Sans JP',sans-serif; font-size:13px;">${main.note || ""}</textarea>
          </td>
          <td>${urlHtml}</td>
        </tr>
      `;
    }
    html += `</tbody></table><p><b>ç·æ™‚é–“ï¼š${totalTime}åˆ†</b></p>`;
    
    // ç”Ÿæˆã—ãŸHTMLã‚’æŒ¿å…¥
    outputDiv.innerHTML = html;

    // è£œè¶³èª¬æ˜ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
    document.querySelectorAll("textarea[data-note-index]").forEach(input => {
      input.addEventListener("input", e => {
        const idx = parseInt(e.target.dataset.noteIndex);
        const main = mainList[idx];
        const target = selectedMenus.find(m => m.name === main.name && m.category === main.category);
        if (target) target.note = e.target.value;
      });
    });

  } catch (err) {
    console.error("Display Program Error:", err);
    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
  }
}

  async function copyProgramText() {
  if (!selectedMenus.length) {
    alert("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nThe program has not been created.");
    return;
  }

  editableName = document.getElementById("editable-name")?.value || editableName;
  editablePurpose = document.getElementById("editable-purpose")?.value || editablePurpose;

  const startInput = document.getElementById("start-time")?.value || "00:00";
  let [startHour, startMin] = startInput.split(":").map(v => parseInt(v) || 0);
  let currentTime = startHour * 60 + startMin;

  const formatTime = (min) => {
    const h = Math.floor(min / 60);
    const m = min % 60;
    return `${h}:${m.toString().padStart(2, "0")}`;
  };

  const mainCategories = [
    "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ©ãƒªãƒ¼ç³»", "ãƒãƒƒã‚¯ç³»", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "è£œå¼·", 
    "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "æ–°è¦ä½œæˆ",
    // â–¼ è¿½åŠ  â–¼
    "ã‚²ãƒ¼ãƒ ", "ãƒãƒƒã‚¯", "ãƒ©ãƒªãƒ¼",
    // â–² è¿½åŠ  â–²
    "Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength", 
    "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice",
    // â–¼ è¿½åŠ  â–¼
    "Game"
    // â–² è¿½åŠ  â–²
];
  const mainList = selectedMenus.filter(m => mainCategories.includes(m.category));

  let rows = "";

  for (const main of mainList) {
    const start = formatTime(currentTime);
    const duration = (["è£œå¼·","çŸ¥è­˜","æ³•æ”¿å¤§å­¦ç·´ç¿’","Strength","Knowledge","Hosei Univ Practice"].includes(main.category)) ? 0 : (main.time || 0);
    currentTime += duration;
    const end = formatTime(currentTime);

    let urlHtml = "";
    if (main.url) {
      try {
        const qrDataUrl = await QRCode.toDataURL(main.url, { width: 80, margin: 1 });
        // ãƒªãƒ³ã‚¯ä»˜ãQRã‚³ãƒ¼ãƒ‰
        urlHtml = `<a href="${main.url}" target="_blank"><img src="${qrDataUrl}" width="80" height="80"></a>`;
      } catch (err) {
        console.error("QRç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
        urlHtml = `<a href="${main.url}" target="_blank">${main.url}</a>`;
      }
    }

    rows += `
      <tr>
        <td>${start}â€“${end}</td>
    <td>[${main.category}] ${main.name}</td>
    <td style="text-align:left; white-space:pre-wrap; word-break:break-word;">
      ${(main.note || "").replace(/\n/g, "<br>")}
    </td>
    <td>${urlHtml}</td>
      </tr>
    `;
  }

  const totalTimeFixed = selectedMenus.reduce((sum, m) => {
    if (["è£œå¼·","çŸ¥è­˜","æ³•æ”¿å¤§å­¦ç·´ç¿’","Strength","Knowledge","Hosei Univ Practice"].includes(m.category)) return sum;
    return sum + (m.time || 0);
  }, 0);

  const html = `
    <div style="font-family:'Noto Sans JP',sans-serif; color:#333;">
      <h3 style="color:#00796b;"> ãƒ—ãƒ­ã‚°ãƒ©ãƒ åï¼š${editableName}</h3>
      <p><b> ç›®çš„ï¼š</b>${editablePurpose}</p>
      <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; text-align:center; font-size:13px;">
        <thead style="background:#e0f7fa;">
          <tr>
            <th>æ™‚é–“</th>
            <th>ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</th>
            <th>è£œè¶³èª¬æ˜</th>
            <th>YouTubeï¼ˆQRï¼‰</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <p style="margin-top:10px;"><b>ğŸ•’ ç·æ™‚é–“ï¼š</b>${totalTimeFixed}åˆ†</p>
    </div>
  `;

  // HTMLï¼‹ãƒ†ã‚­ã‚¹ãƒˆã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
  const blobHTML = new Blob([html], { type: "text/html" });
  const blobText = new Blob([html.replace(/<[^>]+>/g, '')], { type: "text/plain" });
  const data = new ClipboardItem({
    "text/html": blobHTML,
    "text/plain": blobText
  });

  await navigator.clipboard.write([data]);
  alert("ğŸ¨ QRã‚³ãƒ¼ãƒ‰ä»˜ãã§ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nWordãƒ»Gmailãƒ»Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘å¯èƒ½ã§ã™ã€‚");
}

function speakText(encodedText, lang = 'en-US') {
    // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
    window.speechSynthesis.cancel();
    
    // èª­ã¿ä¸Šã’ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
    const text = decodeURIComponent(encodedText);

    // SpeechSynthesisãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        
        // è¨€èªè¨­å®š
        utterance.lang = lang;

        // é©åˆ‡ãªè‹±èªã®éŸ³å£°ã‚’é¸æŠ (éåŒæœŸèª­ã¿è¾¼ã¿å¯¾å¿œã®ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä½¿ç”¨)
        const loadVoices = () => {
            const voices = window.speechSynthesis.getVoices();
            const enVoice = voices.find(voice => 
                voice.lang.startsWith(lang.substring(0, 2)) && 
                (voice.name.includes("Google") || voice.name.includes("Alex") || voice.name.includes("Samantha"))
            ); 
            
            if (enVoice) {
                utterance.voice = enVoice;
            } else {
                console.warn(`Voice for ${lang} not explicitly found. Using default.`);
            }
            
            // èª­ã¿ä¸Šã’é–‹å§‹
            window.speechSynthesis.speak(utterance);
        };

        // ãƒœã‚¤ã‚¹ãƒªã‚¹ãƒˆãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (window.speechSynthesis.getVoices().length > 0) {
            loadVoices();
        } else {
            // ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

    } else {
        alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    }
}

// ===========================
// âœ… æ–°è¦è¿½åŠ é–¢æ•°: éŸ³å£°åœæ­¢æ©Ÿèƒ½
// ===========================
function stopSpeech() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
}


// ==========================================
// âœ… çŸ¥è­˜ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ (ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ç†è«–)
// ==========================================
let allKnowledgeData = []; // å…¨ãƒ‡ãƒ¼ã‚¿
let currentKnowledgeCategory = 'basic'; // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒª
let currentKQuizList = [];
let currentKIndex = 0;
let currentKScore = 0;

// 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadKnowledgeData() {
    const statusEl = document.getElementById("knowledge-status-msg");
    const startBtn = document.getElementById("start-knowledge-btn");
    const testBtn = document.getElementById("start-test-btn"); // è¿½åŠ 
    
    try {
        const res = await fetch(SHEET_URL + "?sheet=Knowledge&t=" + new Date().getTime());
        const data = await res.json();

        if (data.error || !data.length) {
             console.warn("Sheet data not found, using dummy data.");
             // ...ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã¯çœç•¥å¯ï¼‰...
             allKnowledgeData = []; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
        } else {
            allKnowledgeData = data;
        }

        statusEl.textContent = `æº–å‚™å®Œäº† (å…¨ãƒ‡ãƒ¼ã‚¿æ•°: ${allKnowledgeData.length})`;
        
        // ä¸¡æ–¹ã®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        if(startBtn) { startBtn.disabled = false; startBtn.style.opacity = "1"; }
        if(testBtn) { testBtn.disabled = false; testBtn.style.opacity = "1"; }

    } catch (e) {
        console.error("Knowledge Load Error:", e);
        statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆKnowledgeã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    }
}

// 2. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchKnowledgeTab(category) {
    currentKnowledgeCategory = category;
    
    // UIãƒªã‚»ãƒƒãƒˆ
    document.getElementById("knowledge-start-screen").style.display = "block";
    document.getElementById("knowledge-play-screen").style.display = "none";
    document.getElementById("knowledge-result-screen").style.display = "none";
    
    // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
    const titles = { basic: "åŸºç¤ç†è«–ã‚¯ã‚¤ã‚º", tactics: "æˆ¦è¡“ç†è«–ã‚¯ã‚¤ã‚º", coaching: "ã‚³ãƒ¼ãƒãƒ³ã‚°ç†è«–ã‚¯ã‚¤ã‚º" };
    document.getElementById("knowledge-category-title").textContent = titles[category];

    // ã‚¿ãƒ–ã®è‰²å¤‰æ›´
    const tabs = ["basic", "tactics", "coaching"];
    tabs.forEach(t => {
        const btn = document.getElementById(`k-tab-${t}`);
        if (!btn) return;

        if (t === category) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼šç™½èƒŒæ™¯ Ã— æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸æ–‡å­—
            btn.style.background = "#fff";
            btn.style.color = "#e65100";
            btn.style.fontWeight = "bold";
        } else {
            // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼šè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ Ã— èŒ¶è‰²ã£ã½ã„æ–‡å­—
            btn.style.background = "#ffe0b2";
            btn.style.color = "#8d6e63";
            btn.style.fontWeight = "normal";
        }
    });
}

// 3. ã‚¯ã‚¤ã‚ºé–‹å§‹
function startKnowledgeQuiz(questionCount = 5) {
    // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const filtered = allKnowledgeData.filter(d => d.category === currentKnowledgeCategory);
    
    if (filtered.length === 0) {
        alert("ã“ã®ã‚«ãƒ†ã‚´ãƒªã®å•é¡ŒãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }

    // å•é¡Œæ•°ãŒãƒ‡ãƒ¼ã‚¿ã®ç·æ•°ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
    const count = Math.min(questionCount, filtered.length);

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æŒ‡å®šæ•°ï¼ˆ5å• or 20å•ï¼‰æŠ½å‡º
    currentKQuizList = [...filtered].sort(() => 0.5 - Math.random()).slice(0, count);
    
    currentKIndex = 0;
    currentKScore = 0;

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById("knowledge-start-screen").style.display = "none";
    document.getElementById("knowledge-play-screen").style.display = "block";
    document.getElementById("knowledge-result-screen").style.display = "none";
    
    showKnowledgeQuestion();
}

// 4. å•é¡Œè¡¨ç¤º
function showKnowledgeQuestion() {
    const q = currentKQuizList[currentKIndex];
    document.getElementById("knowledge-count").textContent = `Q ${currentKIndex + 1} / ${currentKQuizList.length}`;
    document.getElementById("knowledge-score").textContent = `Score: ${currentKScore}`;
    document.getElementById("knowledge-question").textContent = q.question;
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯éè¡¨ç¤º
    document.getElementById("knowledge-feedback").style.display = "none";

    const optDiv = document.getElementById("knowledge-options");
    optDiv.innerHTML = "";
    
    const options = [
        { text: q.option1, id: 1 }, { text: q.option2, id: 2 },
        { text: q.option3, id: 3 }, { text: q.option4, id: 4 }
    ];

    options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt.text;
        btn.style.cssText = "padding:12px; border:2px solid #ddd; background:#fff; color:#333; border-radius:6px; cursor:pointer; font-size:14px; text-align:left;";
        btn.onclick = () => checkKnowledgeAnswer(opt.id, q.answer, q.explanation, btn);
        optDiv.appendChild(btn);
    });
}


// 5. æ­£èª¤åˆ¤å®š
function checkKnowledgeAnswer(selectedId, correctId, explanation, btn) {
    // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
    const btns = document.querySelectorAll("#knowledge-options button");
    btns.forEach(b => b.disabled = true);

    const isCorrect = (parseInt(selectedId) === parseInt(correctId));
    
    if (isCorrect) {
        btn.style.background = "#d4edda";
        btn.style.borderColor = "#28a745";
        btn.textContent += " â­•";
        currentKScore++;
        if(typeof playSportsDrum === 'function') playSportsDrum();
    } else {
        btn.style.background = "#f8d7da";
        btn.style.borderColor = "#dc3545";
        btn.textContent += " âŒ";
        // æ­£è§£ã‚’è¡¨ç¤º
        btns[parseInt(correctId) - 1].style.background = "#d4edda";
        btns[parseInt(correctId) - 1].textContent += " (æ­£è§£)";
        if(typeof playBuzz === 'function') playBuzz(300, 200);
    }

    // è§£èª¬è¡¨ç¤º
    const fbDiv = document.getElementById("knowledge-feedback");
    document.getElementById("knowledge-feedback-title").textContent = isCorrect ? "æ­£è§£ï¼" : "æ®‹å¿µ...";
    document.getElementById("knowledge-feedback-title").style.color = isCorrect ? "green" : "red";
    document.getElementById("knowledge-feedback-text").textContent = explanation || "";
    fbDiv.style.display = "block";
}

// 6. æ¬¡ã¸
function nextKnowledgeQuestion() {
    currentKIndex++;
    if (currentKIndex < currentKQuizList.length) {
        showKnowledgeQuestion();
    } else {
        // çµæœç™ºè¡¨
        document.getElementById("knowledge-play-screen").style.display = "none";
        document.getElementById("knowledge-result-screen").style.display = "block";
        document.getElementById("knowledge-final-score").textContent = `${currentKQuizList.length}å•ä¸­ ${currentKScore}å•æ­£è§£ï¼`;
        
        // ãƒ©ãƒ³ã‚¯è¡¨ç¤ºæ›´æ–°
        const percentage = (currentKScore / currentKQuizList.length) * 100;
        const rankEl = document.getElementById("knowledge-rank-msg");
        if(rankEl) {
            if (percentage === 100) rankEl.textContent = "è©•ä¾¡: S (å®Œç’§ï¼)";
            else if (percentage >= 80) rankEl.textContent = "è©•ä¾¡: A (ç´ æ™´ã‚‰ã—ã„)";
            else if (percentage >= 60) rankEl.textContent = "è©•ä¾¡: B (åˆæ ¼åœå†…)";
            else rankEl.textContent = "è©•ä¾¡: C (å¾©ç¿’ã—ã¾ã—ã‚‡ã†)";
        }

        if (currentKScore === currentKQuizList.length && typeof playSportsDrum === 'function') {
            playSportsDrum();
        }
    }
} // â† â˜…ã€é‡è¦ã€‘ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã“ã®é–‰ã˜ã‚«ãƒƒã‚³ãŒæŠœã‘ã¦ã„ã¾ã—ãŸï¼

function resetKnowledgeQuiz() {
    document.getElementById("knowledge-result-screen").style.display = "none";
    document.getElementById("knowledge-start-screen").style.display = "block";
}

function resetKnowledgeQuiz() {
    document.getElementById("knowledge-result-screen").style.display = "none";
    document.getElementById("knowledge-start-screen").style.display = "block";
}


document.addEventListener('DOMContentLoaded', () => {
    // ç”»é¢ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹åˆæœŸå‡¦ç†
    loadSheet(); // ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹

    // â˜… TypeErrorã®åŸå› ã¨ãªã£ã¦ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å®‰å…¨ãªè¨­å®š
    const targetTimeInput = document.getElementById("target-time");
    if (targetTimeInput) {
        targetTimeInput.addEventListener("input", updateTimeProgress);
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    const loginBtn = document.getElementById("login-button");
    if (loginBtn) {
        loginBtn.addEventListener("click", loginWithPassword);
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    const logoutBtn = document.getElementById("logout-button");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", logout);
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä¸€åº¦æ›´æ–°ã—ã¦ãŠã
    updateTimeProgress();

    // â–¼â–¼â–¼ ã“ã“ã«è¿½åŠ ã—ã¾ã™ï¼ˆå¿…ãš }); ã®å†…å´ã«å…¥ã‚Œã¾ã™ï¼‰ â–¼â–¼â–¼
    loadEnglishPhrases(); 
    loadQuizData(); 
ã€€ã€€loadKnowledgeData();
loadVideoQuizData(); 
});

// ==========================================
// ğŸ¥ å‹•ç”»ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼†ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½
// ==========================================
let videoQuizData = [];   // ç”Ÿãƒ‡ãƒ¼ã‚¿
let groupedSessions = {}; // GroupIDã”ã¨ã®ãƒ‡ãƒ¼ã‚¿
let currentSessionId = "";

// 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadVideoQuizData() {
    const statusEl = document.getElementById("vq-status-msg");
    const listEl = document.getElementById("vq-list");
    
    try {
        const res = await fetch(SHEET_URL + "?sheet=VideoQuiz&t=" + new Date().getTime());
        const data = await res.json();

        if (data.error || !data.length) {
            statusEl.textContent = "åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
            return;
        }

        videoQuizData = data;
        
        groupedSessions = {};
        videoQuizData.forEach(row => {
            // GroupIDã‚„TitleãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿µã®ãŸã‚ï¼‰
            if (!row.GroupID && !row.Question) return;

            const gid = row.GroupID || "default";
            if (!groupedSessions[gid]) {
                groupedSessions[gid] = {
                    title: row.Title || "ç„¡é¡Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³",
                    url: row.URL || "",
                    questions: []
                };
            }
            
            // â–¼ Option4å¯¾å¿œï¼ˆåŠè§’ãƒ»å…¨è§’ã©ã¡ã‚‰ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ï¼‰
            const opt4 = row.Option4 || row.Optionï¼” || "";

            groupedSessions[gid].questions.push({
                q: row.Question,
                // â–¼ ã“ã“ã‚’4æŠã«ä¿®æ­£
                opts: [row.Option1, row.Option2, row.Option3, opt4],
                ans: row.Answer,
                exp: row.Explanation
            });
        });

        // ãƒªã‚¹ãƒˆæç”»
        statusEl.style.display = "none";
        listEl.innerHTML = "";
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã®è¡¨ç¤º
        if (Object.keys(groupedSessions).length === 0) {
             listEl.innerHTML = "<p>æœ‰åŠ¹ãªå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
             return;
        }

        Object.keys(groupedSessions).forEach(gid => {
            const session = groupedSessions[gid];
            const qCount = session.questions.length;
            
            // å•é¡Œæ•°ãŒ0ã®å ´åˆã¯è¡¨ç¤ºã—ãªã„
            if(qCount === 0) return;

            const card = document.createElement("div");
            card.style.cssText = "background:#fafafa; border:1px solid #eee; border-radius:8px; padding:15px; transition:0.2s; cursor:pointer; border-left:4px solid #ff9800;";
            card.onmouseover = () => { card.style.background = "#fff3e0"; };
            card.onmouseout = () => { card.style.background = "#fafafa"; };
            card.onclick = () => startVideoSession(gid);

            card.innerHTML = `
                <div style="font-weight:bold; color:#1a237e; margin-bottom:5px;">${session.title}</div>
                <div style="font-size:12px; color:#666;">
                    ğŸ“ å•é¡Œæ•°: ${qCount}å•<br>
                    ğŸ¥ YouTubeè¦–è´ã‚ã‚Š
                </div>
            `;
            listEl.appendChild(card);
        });

    } catch (e) {
        console.error("Video Quiz Load Error:", e);
        statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        statusEl.style.color = "red";
    }
}

// 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
function startVideoSession(gid) {
    currentSessionId = gid;
    const session = groupedSessions[gid];
    
    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById("vq-select-screen").style.display = "none";
    document.getElementById("vq-result-screen").style.display = "none";
    document.getElementById("vq-play-screen").style.display = "block";

    // æƒ…å ±ã‚»ãƒƒãƒˆ
    document.getElementById("vq-current-title").textContent = session.title;
    document.getElementById("vq-video-link").href = session.url;

    // å•é¡Œæç”»
    const container = document.getElementById("vq-questions-container");
    container.innerHTML = "";

    session.questions.forEach((qData, idx) => {
        const qDiv = document.createElement("div");
        qDiv.className = "vq-question-block";
        qDiv.style.cssText = "margin-bottom:20px; background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;";
        
        let optionsHtml = "";
        qData.opts.forEach((opt, optIdx) => {
            if(!opt) return;
            const val = optIdx + 1;
            optionsHtml += `
                <label style="display:block; padding:8px; margin-bottom:5px; border:1px solid #eee; border-radius:4px; cursor:pointer;">
                    <input type="radio" name="vq-q-${idx}" value="${val}"> ${opt}
                </label>
            `;
        });

        qDiv.innerHTML = `
            <div style="font-weight:bold; color:#333; margin-bottom:10px;">Q${idx + 1}. ${qData.q}</div>
            <div>${optionsHtml}</div>
            <div id="vq-feedback-${idx}" style="display:none; margin-top:10px; padding:10px; background:#f0f0f0; border-radius:4px; font-size:13px;"></div>
        `;
        container.appendChild(qDiv);
    });
}

// 3. æ¡ç‚¹å‡¦ç†
function submitVideoQuiz() {
    const session = groupedSessions[currentSessionId];
    let score = 0;
    
    // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®HTMLãƒ“ãƒ«ãƒ€ãƒ¼
    let detailsHtml = "";

    session.questions.forEach((qData, idx) => {
        const inputs = document.querySelectorAll(`input[name="vq-q-${idx}"]`);
        const selected = document.querySelector(`input[name="vq-q-${idx}"]:checked`);
        const fbDiv = document.getElementById(`vq-feedback-${idx}`);

        // å…¥åŠ›ãƒ­ãƒƒã‚¯
        inputs.forEach(i => i.disabled = true);
        
        // ç”»é¢ä¸Šã®ç°¡æ˜“ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆã“ã“ã¯â—‹Ã—ã ã‘ã§ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
        fbDiv.style.display = "block";

        const userVal = selected ? parseInt(selected.value) : null;
        const isCorrect = (userVal === parseInt(qData.ans));
        
        // é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const userAnsText = userVal ? qData.opts[userVal - 1] : "ï¼ˆæœªå›ç­”ï¼‰";
        const correctAnsText = qData.opts[parseInt(qData.ans) - 1];

        // --- PDF/çµæœç”»é¢ç”¨ã®è©³ç´°HTMLç”Ÿæˆ ---
        const resultColor = isCorrect ? "#155724" : "#721c24";
        const resultIcon = isCorrect ? "â­• æ­£è§£" : "âŒ ä¸æ­£è§£";

        if (isCorrect) {
            score++;
            fbDiv.style.background = "#d4edda";
            fbDiv.style.color = "#155724";
            fbDiv.textContent = `â­• æ­£è§£ï¼`;
        } else {
            fbDiv.style.background = "#f8d7da";
            fbDiv.style.color = "#721c24";
            fbDiv.textContent = `âŒ ä¸æ­£è§£...`;
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”¨HTMLã®çµ„ã¿ç«‹ã¦ï¼ˆè§£èª¬éƒ¨åˆ†ã‚’å‰Šé™¤ï¼‰
        detailsHtml += `
            <div style="border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; page-break-inside: avoid;">
                <p style="margin:0 0 5px 0; font-weight:bold; color:#333;">Q${idx + 1}. ${qData.q}</p>
                <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                    <span style="color:${resultColor}; font-weight:bold;">ã‚ãªãŸã®å›ç­”: ${userAnsText} (${resultIcon})</span>
                </div>
                ${!isCorrect ? `<p style="margin:0 0 5px 0; font-size:13px; color:#d32f2f;"><strong>æ­£è§£:</strong> ${correctAnsText}</p>` : ""}
            </div>
        `;
    });

    // çµæœç”»é¢ã¸ç§»å‹•
    setTimeout(() => {
        document.getElementById("vq-play-screen").style.display = "none";
        document.getElementById("vq-result-screen").style.display = "block";
        
        // çµæœãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
        document.getElementById("vq-score-display").textContent = `${score} / ${session.questions.length}`;
        document.getElementById("vq-session-name").textContent = session.title;
        document.getElementById("vq-date").textContent = new Date().toLocaleDateString("ja-JP");
        
        // â˜… ã“ã“ã«è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’æŒ¿å…¥
        document.getElementById("vq-feedback-list").innerHTML = detailsHtml;

        // åŠ¹æœéŸ³
        if(score === session.questions.length && typeof playSportsDrum === 'function') {
            playSportsDrum();
        }
    }, 1500);
}

// 4. ä¸€è¦§ã«æˆ»ã‚‹
function backToVideoList() {
    document.getElementById("vq-play-screen").style.display = "none";
    document.getElementById("vq-result-screen").style.display = "none";
    document.getElementById("vq-select-screen").style.display = "block";
}

// 5. PDFå‡ºåŠ›
async function downloadVideoQuizPDF() {
    const element = document.getElementById("vq-result-content");
    const btn = event.target || document.querySelector("#vq-result-screen button");
    const originalText = btn ? btn.textContent : "PDFå‡ºåŠ›";
    
    if (btn) {
        btn.textContent = "PDFç”Ÿæˆä¸­...";
        btn.disabled = true;
    }

    try {
        // --- 1. ãƒãƒ©ã¤ãé˜²æ­¢ï¼šç”»é¢å¤–ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ ---
        // å…ƒã®è¦ç´ ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆè¤‡è£½ï¼‰
        const clone = element.cloneNode(true);
        
        // ç”»é¢å¤–ï¼ˆå·¦å´ -10000pxï¼‰ã«é…ç½®ã—ã¦è¦‹ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
        // å¹…ã‚’å›ºå®š(600px)ã—ã¦ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã
        clone.style.cssText = `
            position: absolute;
            top: 0;
            left: -10000px;
            width: 600px;
            background: #fff;
            padding: 20px;
            z-index: -1;
        `;
        
        // ä¸€æ™‚çš„ã«bodyã«è¿½åŠ ï¼ˆhtml2canvasã¯DOMã«å­˜åœ¨ã—ãªã„ã¨æ’®å½±ã§ããªã„ãŸã‚ï¼‰
        document.body.appendChild(clone);

        // --- 2. ç”»åƒåŒ–å‡¦ç† ---
        const canvas = await html2canvas(clone, { 
            scale: 2, // é«˜ç”»è³ª
            useCORS: true,
            windowWidth: 800 // ä»®æƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¹…ã‚’æŒ‡å®šã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®‰å®šã•ã›ã‚‹
        });
        
        // ç”¨ãŒæ¸ˆã‚“ã ã‚‰å³å‰Šé™¤
        document.body.removeChild(clone);
        
        const imgData = canvas.toDataURL("image/png");

        // --- 3. PDFè¨­å®šï¼ˆ1æšã«åã‚ã‚‹ï¼‰ ---
        const docDefinition = {
            content: [
                {
                    image: imgData,
                    // â˜…ã“ã“ãŒé‡è¦ï¼šA4ã‚µã‚¤ã‚º(ç´„595x842pt)ã‹ã‚‰ä½™ç™½ã‚’å¼•ã„ãŸã‚µã‚¤ã‚ºã«åã¾ã‚‹ã‚ˆã†è‡ªå‹•ç¸®å°
                    fit: [500, 750], 
                    alignment: 'center',
                    margin: [0, 10, 0, 0]
                }
            ],
            pageSize: 'A4',
            pageMargins: [40, 40, 40, 40], // ä¸Šä¸‹å·¦å³ã®ä½™ç™½
            defaultStyle: { font: 'Roboto' }
        };

        const fileName = `VideoQuiz_Result_${new Date().toISOString().slice(0,10)}.pdf`;
        pdfMake.createPdf(docDefinition).download(fileName);

    } catch (e) {
        console.error("PDF Error:", e);
        alert("PDFä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: " + e.message);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å¿µã®ãŸã‚ã‚¯ãƒ­ãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ãŸã‚‰å‰Šé™¤
        const ghosts = document.querySelectorAll('[style*="left: -10000px"]');
        ghosts.forEach(g => g.remove());
    } finally {
        if (btn) {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
}

// ==========================================
// âœ… PDFç™ºè¡Œæ©Ÿèƒ½
// ==========================================
async function downloadKnowledgePDF() {
    const btn = event.target || document.querySelector("button[onclick='downloadKnowledgePDF()']");
    const originalText = btn.textContent;
    
    // 1. ãƒœã‚¿ãƒ³ã‚’ã€Œå‡¦ç†ä¸­ã€ã«ã™ã‚‹
    btn.textContent = "PDFç”Ÿæˆä¸­...";
    btn.disabled = true;

    try {
        // --- ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ï¼ˆçœç•¥ï¼‰---
        const total = currentKQuizList.length || 20;
        const score = currentKScore;
        const percentage = (score / total) * 100;
        const now = new Date();

        const template = document.getElementById("certificate-template");
        template.querySelector("#cert-date").textContent = now.toLocaleDateString("ja-JP");
        template.querySelector("#cert-score").textContent = score;
        template.querySelector("#cert-total").textContent = total;

        let rank = "", comment = "";
        // ... (ãƒ©ãƒ³ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥) ...

        if (percentage === 100) {
            rank = "Sãƒ©ãƒ³ã‚¯ (å…è¨±çš†ä¼)";
            comment = "ç´ æ™´ã‚‰ã—ã„ï¼å®Œç’§ãªçŸ¥è­˜ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã®ç†è«–ã‚’å®Ÿéš›ã®ãƒ—ãƒ¬ãƒ¼ã‚„æŒ‡å°ã«æ´»ã‹ã—ã¦ãã ã•ã„ã€‚";
        } else if (percentage >= 80) {
            rank = "Aãƒ©ãƒ³ã‚¯ (ä¸Šç´šè€…)";
            comment = "éå¸¸ã«é«˜ã„æ­£è§£ç‡ã§ã™ã€‚ç´°ã‹ã„çŸ¥è­˜ã®æŠœã‘æ¼ã‚Œã‚’ç¢ºèªã—ã€æº€ç‚¹ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼";
        } else if (percentage >= 60) {
            rank = "Bãƒ©ãƒ³ã‚¯ (ä¸­ç´šè€…)";
            comment = "åŸºæœ¬çš„ãªç†è«–ã¯ç†è§£ã§ãã¦ã„ã¾ã™ã€‚é–“é•ãˆãŸå•é¡Œã‚’è¦‹ç›´ã—ã€çŸ¥è­˜ã‚’å®šç€ã•ã›ã¾ã—ã‚‡ã†ã€‚";
        } else {
            rank = "Cãƒ©ãƒ³ã‚¯ (å­¦ç¿’ä¸­)";
            comment = "ã¾ãšã¯åŸºç¤çŸ¥è­˜ã‚’ã—ã£ã‹ã‚Šå›ºã‚ã¾ã—ã‚‡ã†ã€‚ç¹°ã‚Šè¿”ã—å­¦ç¿’ã™ã‚‹ã“ã¨ã§å¿…ãšç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚";
        }

        template.querySelector("#cert-rank").textContent = rank;
        template.querySelector("#cert-comment").textContent = comment;

        // --- ç”»åƒåŒ–å‡¦ç†ï¼ˆé‡è¦ï¼šã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦æ’®å½±ã™ã‚‹ï¼‰ ---
        // 1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¤‡è£½
        const clone = template.cloneNode(true);
        
        // 2. æ’®å½±ç”¨ã«ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆç”»é¢å¤–ã®å®‰å…¨ãªå ´æ‰€ã«é…ç½®ã€‚visibilityã‚„opacityã¯ä½¿ç”¨ã—ãªã„ï¼‰
        clone.style.cssText = `
            position: fixed; 
            top: -20000px; /* é¥ã‹ä¸Šæ–¹ã«é…ç½® */
            left: 0; 
            z-index: 99999; /* å¿µã®ãŸã‚æœ€å‰é¢ã«é…ç½® */
            width: 800px; 
            padding: 40px; 
            background: #fff; 
            display: block !important; 
            transform: none; /* ç¢ºå®Ÿã«ã‚¹ã‚±ãƒ¼ãƒ«1.0 */
        `;
        
        // 3. DOMã«è¿½åŠ 
        document.body.appendChild(clone);

        // 4. çŸ­ã„æ™‚é–“å¾…ã£ã¦ã‹ã‚‰æ’®å½±ï¼ˆCSSé©ç”¨ã¨æç”»ã®å®Œäº†ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 100)); // 100msã§å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹
        
        // 5. html2canvasã§ç”»åƒåŒ–
        const canvas = await html2canvas(clone, {
            scale: 2, // é«˜è§£åƒåº¦ã§ç”Ÿæˆ
            useCORS: true,
            logging: false,
            width: 900, 
            height: clone.offsetHeight + 10,
            windowWidth: 900, 
            scrollX: 0,
            scrollY: 0,
        });

        // 6. å‰Šé™¤
        document.body.removeChild(clone);

        const imgData = canvas.toDataURL("image/png");

        // --- PDFç”Ÿæˆ ---
        const docDefinition = {
            content: [
                {
                    image: imgData,
                    width: 550, // A4ã‚µã‚¤ã‚ºã«åã¾ã‚‹ã‚ˆã†èª¿æ•´
                    alignment: 'center'
                }
            ],
            defaultStyle: {
                font: 'Roboto'
            },
            pageMargins: [40, 40, 40, 40]
        };

        const pdfLib = window.pdfMake || window.pdfmake;
        if (pdfLib) {
            pdfLib.createPdf(docDefinition).download(`Badminton_Test_Result_${now.toISOString().slice(0,10)}.pdf`);
        } else {
            throw new Error("pdfMakeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }

    } catch (e) {
        console.error("PDF Export Error:", e);
        alert("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼è©³ç´°: " + e.message);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã«æ®‹ã£ã¦ã—ã¾ã£ãŸã‚¯ãƒ­ãƒ¼ãƒ³è¦ç´ ã‚’å‰Šé™¤
        const cloneElements = document.querySelectorAll("#certificate-template[style*='position: fixed']");
        cloneElements.forEach(el => el.remove());
    } finally {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        btn.textContent = originalText;
        btn.disabled = false;
    }
}
</script>
</head>

<body>
  <header style="
    text-align: center;
    margin-bottom: 30px;
    /* èƒŒæ™¯ï¼šè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¯ã‚„ã‹ã•ã‚’æ¼”å‡º */
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    padding: 25px 10px;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(230, 81, 0, 0.1); /* å½±ã‚‚å°‘ã—æ¸©ã‹ã¿ã®ã‚ã‚‹è‰²ã« */
    border: 1px solid #ffcc80; /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ã®æ ç·šã§è¼ªéƒ­ã‚’æ•´ãˆã‚‹ */
  ">
    <h1 style="
      font-size: 32px;
      color: #1a237e; /* æ–‡å­—è‰²ï¼šãƒã‚¤ãƒ“ãƒ¼ */
      margin-bottom: 8px;
      letter-spacing: 1.5px;
      font-weight: 700;
      font-family: 'Noto Sans JP', sans-serif;
    ">
      Smart Coach Badminton
    </h1>
    <p id="app-title"
       style="font-size:17px; color:#283593; margin:0; font-weight:500;">
      ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼†å­¦ç¿’ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª
    </p>
    <div style="margin-top:12px;">
      <a href="https://www.youtube.com/@MASUBadmintonAcademy" target="_blank" 
         style="display:inline-flex; align-items:center; gap:6px; text-decoration:none;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_(2017).svg" 
             alt="YouTube" 
             style="width:24px; height:24px;">
        <span id="channel-title" style="font-weight:bold; color:#1a237e;">MASU Badminton Academy YouTubeãƒãƒ£ãƒ³ãƒãƒ«</span>
      </a>
   </div>
   
   <div style="margin-top: 15px; text-align: center;">
       <span style="font-size: 12px; color: #666; margin-right: 5px;">Language:</span>
       <div id="google_translate_element" style="display: inline-block;"></div>
   </div>

   <script type="text/javascript">
   function googleTranslateElementInit() {
     new google.translate.TranslateElement({
       pageLanguage: 'ja', 
       includedLanguages: 'en,zh-CN,zh-TW,ko', 
       layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
       autoDisplay: false
     }, 'google_translate_element');
   }
   </script>
   <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit&hl=en"></script>
   </header>
<div class="status-message" id="statusMessage" style="margin: 10px 0; font-weight: bold;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>

<section id="announcement-section" style="
  margin-bottom: 25px;
  padding: 20px;
  background: linear-gradient(to bottom, #fffde7, #fff9c4); /* è–„ã„é»„è‰²ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
  border: 2px solid #fbc02d; /* ã‚´ãƒ¼ãƒ«ãƒ‰ç³»ã®æ ç·š */
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  font-family: 'Noto Sans JP', sans-serif;
  animation: fadeIn 1s ease-in-out;
">
  <h3 style="margin: 0 0 15px 0; color: #f57f17; display: flex; align-items: center; gap: 8px; font-size: 18px; border-bottom: 1px dashed #f9a825; padding-bottom: 10px;">
    ğŸ”” ã€é‡è¦ã€‘ä»Šå¾Œã®å¤§å¹…ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¨ã”å”åŠ›ã®ãŠé¡˜ã„
  </h3>
  
  <p style="font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 15px;">
    ã„ã¤ã‚‚å½“ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
    ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¦ã€çš†æ§˜ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ã‚¤ãƒ•ã‚’ã‚ˆã‚Šå¼·åŠ›ã«ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…äºˆå®šã§ã™ã€‚
  </p>

  <div style="background: rgba(255, 255, 255, 0.7); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #ff9800;">
    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #333; font-weight: bold;">
      <li style="margin-bottom: 8px;">ğŸ” å€‹äººãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ï¼ˆIDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ä¿è­·ã¨æ©Ÿç¨®å¤‰æ›´å¯¾å¿œï¼‰</li>
      <li>ğŸ¤– AIã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åˆ†æï¼†ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ©Ÿèƒ½</li>
    </ul>
  </div>

  <p style="font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 20px;">
    ã“ã‚Œã‚‰ã®é«˜åº¦ãªæ©Ÿèƒ½ã‚’<strong style="color: #d32f2f; font-size: 16px; background: yellow;">ã€Œå®Œå…¨ç„¡æ–™ã€</strong>ã§çš†æ§˜ã«æä¾›ã—ç¶šã‘ã‚‹ãŸã‚ã€é–‹ç™ºè²»ç”¨ã®ç¢ºä¿ã¨ã—ã¦YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã®åç›ŠåŒ–ã‚’ç›®æŒ‡ã—ã¦ãŠã‚Šã¾ã™ã€‚<br>
    çš†æ§˜ã®ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŒã€ãã®ã¾ã¾ã‚¢ãƒ—ãƒªã®é€²åŒ–ï¼ˆé–‹ç™ºè²»ï¼‰ã«ç¹‹ãŒã‚Šã¾ã™ã€‚ã‚ˆã‚Šè‰¯ã„ã‚¢ãƒ—ãƒªã‚’ç„¡æ–™ã§ä½œã‚Šç¶šã‘ã¦ã„ããŸã‚ã«ã€ãœã²ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ã§ã®ã”æ”¯æ´ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
  </p>

  <div style="text-align: center;">
    <a href="https://www.youtube.com/@MASUBadmintonAcademy?sub_confirmation=1" target="_blank" style="
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #d32f2f; /* YouTubeãƒ¬ãƒƒãƒ‰ */
      color: white;
      text-decoration: none;
      padding: 12px 35px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, background 0.2s;
    " onmouseover="this.style.transform='scale(1.05)'; this.style.background='#b71c1c'" onmouseout="this.style.transform='scale(1)'; this.style.background='#d32f2f'">
      <span style="font-size: 20px;">â–¶</span> YouTubeãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ã—ã¦å¿œæ´ã™ã‚‹
    </a>
    <p style="font-size: 11px; color: #666; margin-top: 8px;">â€»ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨YouTubeãŒé–‹ãã¾ã™</p>
  </div>
</section>

<section id="beginner-instruction-section" style="
  margin-bottom: 30px; 
  padding: 20px; 
  background: #e3f2fd; 
  border-radius: 12px; 
  border: 2px solid #90caf9;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
">
  <h2 id="beginner-section-title" style="color: #1565c0; margin-top: 0; display: flex; align-items: center; gap: 10px;">
  ğŸ”° åˆå¿ƒè€…å‘ã‘å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³
</h2>

<p id="beginner-section-desc" style="font-size: 14px; color: #555; margin-bottom: 20px;">
  ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€YouTubeã‚¢ãƒ—ãƒªï¼ˆã¾ãŸã¯æ–°ã—ã„ã‚¿ãƒ–ï¼‰ã§å‹•ç”»ãŒé–‹ãã¾ã™ã€‚
</p>

  <div style="background: #fff; border-radius: 8px; border: 1px solid #ccc; overflow: hidden;">
    <div id="beginner-menu-list" style="max-height: 500px; overflow-y: auto;">
      <p style="padding: 15px; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>
</section>

<!-- ğŸ§  èª²é¡Œãƒ»ç›®çš„ã®å…¥åŠ›æ¬„ï¼ˆAIææ¡ˆï¼‰ -->
<section id="ai-section" style="
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  margin-bottom:25px;
  width:100%;
  max-width:none;
  text-align:left;
  box-sizing:border-box;
">
  <h3 style="margin-bottom:8px; color:#00796b;">èª²é¡Œãƒ»ç›®çš„ã®å…¥åŠ›</h3>
  <textarea id="free-text" 
    placeholder="ä¾‹ï¼‰ã‚¹ãƒãƒƒã‚·ãƒ¥å¾Œã®ãƒªã‚«ãƒãƒªãƒ¼ãŒé…ã„ã€‚å‰å¾Œã®å‹•ãå‡ºã—ã‚’é€Ÿãã—ãŸã„ã€‚" 
    style="width:100%; height:50px; font-size:14px; padding:8px; border:1px solid #ccc; border-radius:6px; resize:none; box-sizing:border-box;">
  </textarea>
  <button id="ai-suggest-btn" onclick="analyzeAndSuggest()" 
    style="margin-top:10px; background:#00796b; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; min-width: 180px;">
    ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆ
  </button>

  <div id="ai-suggested" style="margin-top:12px; font-size:14px; line-height:1.5;">
    </div>

  <button id="add-ai-menus-btn" onclick="addSuggestedMenus()" 
    style="display:none; margin-top:15px; background:#e65100; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-weight:bold;">
    âœ… ææ¡ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¸€æ‹¬ã§ãƒªã‚¹ãƒˆã«è¿½åŠ 
  </button>
</section>


<!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ -->
<div id="create-menu-box" style="margin-top: 15px; padding:10px; background:#fff; border:1px solid #ccc; border-radius:6px;">
  <h3 id="create-menu-title" style="margin-bottom:8px; color:#00796b;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ</h3>

<div style="margin-bottom: 15px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
  <button id="btn-save-local" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
  <button id="btn-load-local" style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
  <button id="btn-clear-local" style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
  <span id="local-save-status" style="font-size:12px; color:#e65100;"></span>
</div>

<div style="background: #f1f8e9; padding: 10px; border-radius: 6px; border: 1px solid #c5e1a5;">

 <h4 id="category-select-title" style="margin-top:15px; color:#008c9e;">
  â‘  ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ
</h4>
  <label id="category-label" for="category">ã‚«ãƒ†ã‚´ãƒªé¸æŠ:</label>
<select id="category">
  <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
  <optgroup label="æ—¥æœ¬èªãƒ¡ãƒ‹ãƒ¥ãƒ¼">
    <option value="ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—">ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—</option>
<option value="ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯">ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</option>
<option value="ãƒãƒƒã‚¯ç³»">ãƒãƒƒã‚¯ç³»</option>
    <option value="ãƒ©ãƒªãƒ¼ç³»">ãƒ©ãƒªãƒ¼ç³»</option>
    <option value="ã‚²ãƒ¼ãƒ ">ã‚²ãƒ¼ãƒ </option>
    <option value="ãƒ•ã‚£ã‚¸ã‚«ãƒ«">ãƒ•ã‚£ã‚¸ã‚«ãƒ«</option>
    <option value="è£œå¼·">è£œå¼·</option>
    <option value="ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰">ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰</option>
    <option value="çŸ¥è­˜">çŸ¥è­˜</option>
    <option value="æ³•æ”¿å¤§å­¦ç·´ç¿’">æ³•æ”¿å¤§å­¦ç·´ç¿’</option>
  </optgroup>
  <optgroup label="English Plan">
    <option value="Warm-up">Warm-up</option>
<option value="Footwork">Footwork</option>
<option value="Knock">Knock</option>
    <option value="Rally">Rally</option>
        <option value="Game">Game</option>
        <option value="Physical">Physical</option>
    <option value="Strength">Strength</option>
    <option value="Break (Preparing the next plan)">Break (Preparing the next plan)</option>
    <option value="Knowledge">Knowledge</option>
    <option value="Hosei Univ Practice">Hosei Univ Practice</option>
  </optgroup>
</select>

  <div id="menu-list"></div>

  <h4 id="newMenuTitle" style="margin-top:15px; color:#008c9e;">â‘¡æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²</h4>

  <label for="new-menu-name">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åï¼š</label>
  <input type="text" id="new-menu-name" 
       style="width:100%; margin-bottom:10px; box-sizing: border-box;"><br>
<label for="new-menu-time">æ™‚é–“(åˆ†)ï¼š</label>
  <input type="number" id="new-menu-time" min="0.1" step="0.1" style="width:80px;">
  <button id="add-new-menu-btn">è¿½åŠ </button><br>

<h4 id="menu-extraction-title" style="margin-top:15px; color:#008c9e;">â‘¢ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
    <label id="random-plan-label">ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º:</label><br>
    <input type="radio" name="random-category" id="random-knock" value="ãƒãƒƒã‚¯ç³»">
    <label for="random-knock" id="label-random-knock">ãƒãƒƒã‚¯</label>
    <input type="radio" name="random-category" id="random-rally" value="ãƒ©ãƒªãƒ¼ç³»">
    <label for="random-rally" id="label-random-rally">ãƒ©ãƒªãƒ¼</label>
    <input type="radio" name="random-category" id="random-strength" value="è£œå¼·">
    <label for="random-strength" id="label-random-strength">è£œå¼·</label>
    <button id="random-btn" style="margin-left:10px;">ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ½å‡º</button>
    
    <div id="random-result" style="margin-top:10px;"></div> 
    
    <h4 style="margin-bottom:8px; color:#008c9e; margin-top: 15px;"> <span id="lbl-template-header">â‘£ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
    </h4>
    <select id="templateSelect" onchange="applyTemplate()">
      <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã¶</option>
    </select>

    <iframe id="templateViewer" style="width:100%; height:600px; border:1px solid #ccc; border-radius:8px; display:none;"></iframe>

</div><br>

<label id="start-time-label" for="start-time">é–‹å§‹æ™‚åˆ»:</label><input type="time" id="start-time" value="00:00">
<label id="total-time-label">ç·´ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰:</label>
  <input type="number" id="target-time" min="10" step="5" style="width:80px;">

<h4 id="selected-menu-title">é¸æŠã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆå¯ï¼‰</h4>

<div id="selected-list"></div>
  
  <p id="total-time-text">ç·æ™‚é–“: <span id="total-time">0</span> åˆ†</p>
  <button id="generate-program">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ</button>
<button id="preview-program">å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
<button id="copy-program-html">å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
<button id="download-program-png">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
<button id="download-program-pdf" style="background: #ef5350;">PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

   <div id="program-output"></div>
   <div id="share-preview"></div>

<div id="time-progress-container" style="margin-top:15px;">
  
  
  <div style="margin-top:10px; background:#ddd; border-radius:6px; height:20px; width:100%; overflow:hidden;">
    <div id="time-progress-bar" style="height:100%; width:0%; background:#4caf50; transition:width 0.4s;"></div>
  </div>
  
  <p id="time-status" style="margin-top:6px; font-size:14px; color:#333;">ç¾åœ¨ 0 / 120 åˆ†</p>
</div>
</div>  

<div id="tactics-board-box" style="margin-top: 15px; padding:15px; background:#fff; border:1px solid #ccc; border-radius:6px;">
  <div style="margin-bottom: 15px;">
    <h3 id="tactics-main-title" style="margin:0; color:#00796b;">æˆ¦è¡“ãƒœãƒ¼ãƒ‰</h3>
  </div>
  
  <div id="tactics-content" style="display:block;">
  <div style="margin-bottom: 10px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
      <button id="btn-t-save" onclick="saveTacticsToBrowser()" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
      <button id="btn-t-restore" onclick="loadTacticsFromBrowser()" style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
      <button id="btn-t-delete" onclick="clearTacticsBrowserData()" style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
      <span id="tactics-local-status" style="font-size:12px; color:#e65100;"></span>
    </div>

   <div style="margin-bottom: 8px; font-size: 14px; font-weight: bold; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
  <label style="cursor: pointer;">
    <input type="radio" name="game-mode" value="doubles" checked onchange="switchGameMode('doubles')"> 
    <span id="lbl-doubles">ãƒ€ãƒ–ãƒ«ã‚¹ (4äºº)</span>
  </label>
  <label style="cursor: pointer;">
    <input type="radio" name="game-mode" value="singles" onchange="switchGameMode('singles')"> 
    <span id="lbl-singles">ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (2äºº)</span>
  </label>
  <label style="cursor: pointer;">
    <input type="radio" name="game-mode" value="custom" onchange="switchGameMode('custom')"> 
    <span id="lbl-custom">å¤‰å‰‡ (è‡ªç”±è¨­å®š)</span>
  </label>
</div>

<div id="custom-tactic-settings" style="display: none; background: #fff3e0; padding: 8px; border-radius: 4px; margin-bottom: 10px; align-items: center; gap: 10px;">
  <label style="font-size:13px; color:#d32f2f;">
    Red: <input type="number" id="custom-red-count" value="1" min="1" max="10" style="width: 40px; padding: 2px;">
  </label>
  <label style="font-size:13px; color:#1976d2;">
    Blue: <input type="number" id="custom-blue-count" value="2" min="1" max="10" style="width: 40px; padding: 2px;">
  </label>
  <button id="btn-apply-custom" onclick="resetTacticPositions()" style="font-size: 12px; padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
    é…ç½®é©ç”¨
  </button>
</div>

<div id="fixed-name-inputs" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
  <div style="display:flex; align-items:center; gap:5px;">
    <span style="color:red; font-weight:bold;">Red:</span>
    <input type="text" id="input-name-A" placeholder="A" value="A" oninput="updatePlayerLabels()" style="width:70px; text-align:center;">
    <span id="container-name-B">
      <input type="text" id="input-name-B" placeholder="B" value="B" oninput="updatePlayerLabels()" style="width:70px; text-align:center;">
    </span>
  </div>
  <div style="display:flex; align-items:center; gap:5px;">
    <span style="color:blue; font-weight:bold;">Blue:</span>
    <input type="text" id="input-name-X" placeholder="X" value="X" oninput="updatePlayerLabels()" style="width:70px; text-align:center;">
    <span id="container-name-Y">
      <input type="text" id="input-name-Y" placeholder="Y" value="Y" oninput="updatePlayerLabels()" style="width:70px; text-align:center;">
    </span>
  </div>
</div>
    </div>

    <div style="margin-bottom: 10px; font-size: 14px; display: flex; flex-wrap: wrap; gap: 10px;">
      <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="move" checked onchange="setTacticMode('move')"> <span id="lbl-move">âœ‹ ç§»å‹•</span></label>
      <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="draw" onchange="setTacticMode('draw')"> <span id="lbl-pen">âœï¸ ãƒšãƒ³</span></label>
      <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="arrow" onchange="setTacticMode('arrow')"> <span id="lbl-arrow">â†—ï¸ çŸ¢å°</span></label>
      <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="text" onchange="setTacticMode('text')"> <span id="lbl-text">ğŸ“ æ–‡å­—</span></label>
      <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="eraser" onchange="setTacticMode('eraser')"> <span id="lbl-eraser">ğŸ§½ æ¶ˆã—ã‚´ãƒ </span></label>
    </div>

    <div style="margin-bottom: 15px;">
      <button id="btn-t-reset" onclick="resetTacticPositions()" style="background:#ff9800; color:white; border:none; border-radius:4px; font-size:12px; padding:5px 10px; cursor:pointer;">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btn-t-clear" onclick="clearTacticLines()" style="background:#e53935; color:white; border:none; border-radius:4px; font-size:12px; padding:5px 10px; cursor:pointer;">æ›¸ãè¾¼ã¿æ¶ˆå»</button>
      <button id="btn-t-saveimg" onclick="saveTacticsImage()" style="background:#3f51b5; color:white; border:none; border-radius:4px; font-size:12px; padding:5px 10px; cursor:pointer;">ç”»åƒä¿å­˜</button>
    </div>

    <div onclick="toggleTacticsCourt()" style="background:#e0f2f1; color:#00796b; padding:8px; text-align:center; cursor:pointer; border-radius:4px; font-weight:bold; user-select:none;">
      <span id="court-toggle-icon">â–¼</span> <span id="court-toggle-text">ã‚³ãƒ¼ãƒˆã‚’è¡¨ç¤º / Open Court</span>
    </div>

    <div id="tactics-court-area" style="display:none; margin-top:15px;">
      <div id="tactics-canvas-container" style="position: relative; width: 100%; max-width: 400px; margin: 0 auto; border: 2px solid #333;">
        <canvas id="tacticsCanvas" width="400" height="550" style="width:100%; display:block; background: #2e7d32; cursor: grab;"></canvas>
      </div>
      <p style="font-size:12px; color:#666; text-align:center; margin-top:5px;">
        â€»<span id="txt-hint">çŸ¢å°ï¼šãƒ‰ãƒ©ãƒƒã‚° / æ–‡å­—ï¼šã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ› / ç§»å‹•ï¼šãƒ‰ãƒ©ãƒƒã‚°</span>
      </p>
    </div>
  </div>
</div>
 
<div id="court-allocation-box" style="margin-top: 15px; padding:15px; background:#fff; border:1px solid #ccc; border-radius:6px;">
  <h3 id="court-allocation-title" style="margin-bottom:10px; color:#00796b;">ã‚³ãƒ¼ãƒˆé…ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h3>
  
  <div style="margin-bottom: 10px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
  <button id="btn-l-save" onclick="saveLayoutToBrowser()" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
  <button id="btn-l-restore" onclick="loadLayoutFromBrowser()" style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
  <button id="btn-l-delete" onclick="clearLayoutBrowserData()" style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
  <span id="layout-local-status" style="font-size:12px; color:#e65100;"></span>
</div>
  <div style="background:#fff; padding:5px 0; margin-bottom:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; border-bottom:1px solid #eee; padding-bottom:10px;">
    <span id="lbl-new-create" style="font-weight:bold; color:#333; font-size:13px;">â‘  æ–°è¦ä½œæˆ:</span>
    <label style="font-size:13px;"><span id="lbl-court-count">ã‚³ãƒ¼ãƒˆ</span> <input type="number" id="init-court-count" value="2" min="0" style="width:40px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
    <label style="font-size:13px;"><span id="lbl-player-count">äººæ•°</span> <input type="number" id="init-player-count" value="10" min="1" style="width:40px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
    <button id="btn-init-layout" onclick="initGymLayout()" style="background:#fff; color:#00796b; border:1px solid #00796b; padding:5px 12px; border-radius:4px; cursor:pointer; font-size:12px; font-weight:bold;">ç”Ÿæˆ / ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div onclick="toggleLayoutBuilder()" style="background:#e0f2f1; color:#00796b; padding:8px; text-align:center; cursor:pointer; border-radius:4px; font-weight:bold; user-select:none;">
    <span id="layout-toggle-icon">â–¼</span> <span id="layout-toggle-text">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ã‚’é–‹ã / Open Layout</span>
  </div>

  <div id="layout-builder-content" style="display:none; margin-top:15px;">
    
    <div style="background:#f5f5f5; padding:10px; border-radius:6px; border:1px solid #ddd; margin-bottom:10px;">
      
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <div style="display:flex; gap:5px;">
          <button id="btn-add-spot" onclick="addSpotToFloor(50, 50)" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ï¼‹ ã€‡è¿½åŠ </button>
          <button id="btn-expand-floor" onclick="toggleFloorHeight()" style="background:#00897b; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">â†• æ‹¡å¼µ</button>
        </div>
        <button id="btn-l-saveimg" onclick="saveGymImage()" style="background:#3f51b5; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ“· ç”»åƒä¿å­˜</button>
      </div>

      <hr style="border:0; border-top:1px solid #ccc; margin:5px 0 10px 0;">

      <div style="display:flex; flex-wrap:wrap; align-items:center; gap:10px;">
        <label style="display:flex; align-items:center; gap:5px; background:#fff; padding:5px 10px; border:1px solid #999; border-radius:4px; cursor:pointer; font-weight:bold; font-size:12px;">
          <input type="checkbox" id="chk-select-mode" onchange="toggleSelectMode(this)">
          <span id="lbl-select-mode">â˜‘ï¸ é¸æŠãƒ¢ãƒ¼ãƒ‰</span>
        </label>

        <div id="align-buttons" style="display:flex; gap:5px; opacity:0.5; pointer-events:none;">
          <button id="btn-align-top" onclick="alignSelected('top')" style="background:#fff; border:1px solid #666; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">â¬†ï¸ ä¸Šæƒãˆ</button>
          <button id="btn-align-left" onclick="alignSelected('left')" style="background:#fff; border:1px solid #666; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">â¬…ï¸ å·¦æƒãˆ</button>
          <button id="btn-align-dist" onclick="alignSelected('distribute')" style="background:#fff; border:1px solid #666; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">â†”ï¸ æ¨ªç­‰é–“éš”</button>
          <button id="btn-l-clear-select" onclick="clearSelection()" style="background:#ef5350; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">é¸æŠè§£é™¤</button>
        </div>
      </div>
      <p style="font-size:11px; color:#d32f2f; margin:5px 0 0 0; display:none;" id="select-mode-msg">
        â€»è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ï¼ˆèµ¤æ ãŒã¤ãã¾ã™ï¼‰
      </p>
    </div>

    <div style="background:#fff3e0; padding:8px; border-radius:4px; border:1px solid #ffe0b2; margin-bottom:10px; display:flex; align-items:center; gap:10px;">
      <button id="btn-start-order" onclick="startOrderingMode()" style="background:#333; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ”¢ ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’æŒ¯ã‚‹</button>
      <span id="ordering-status" style="font-size:12px; color:#d32f2f; font-weight:bold; display:none;">â— 1ç•ªã‹ã‚‰é †ã«ã‚¯ãƒªãƒƒã‚¯</span>
      <button id="btn-end-order" onclick="endOrderingMode()" style="background:#d32f2f; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px; display:none;">å®Œäº†</button>
    </div>
    
    <div id="gym-floor" style="position: relative; width: 100%; height: 400px; background: #e0e0e0; border: 2px solid #999; border-radius: 4px; overflow: hidden; transition: height 0.3s ease;"> 
        <p id="layout-hint-text" style="position:absolute; top:5px; left:5px; margin:0; font-size:11px; color:#666; pointer-events:none;">
          è¦ç´ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•
        </p>
    </div>
  </div>
</div>

<div class="timer-container" style="
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  margin-top: 15px;
">
<h3 id="random-plan-title" style="margin-bottom:15px; color:#00796b;">ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯</h3>

  <div style="background: #f1f8e9; padding: 10px; border-radius: 6px; border: 1px solid #c5e1a5;">
    <label id="lbl-name-list" style="font-weight:bold; color:#33691e;">å‚åŠ è€…åç°¿ (æ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›):</label>
    
    <textarea id="name-list-input" placeholder="ä¾‹ï¼š
ä½è—¤
éˆ´æœ¨
é«˜æ©‹
ç”°ä¸­" style="width:100%; height:80px; box-sizing:border-box; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></textarea>
    
    <div id="note-name-list" style="font-size:12px; color:#555; margin-bottom:10px;">
      â€»ã“ã“ã«åå‰ãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æŠ½é¸ã•ã‚Œã¾ã™ã€‚
    </div>

    <h4 id="h-pick-winner" style="margin:10px 0 5px 0; color:#008c9e;">â‘  å½“é¸è€…ã‚’é¸ã¶ (1å)</h4>
    
    <button id="btn-pick-winner" onclick="extractNameRandomly()" style="background:#008c9e; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
      1åæŠ½å‡º
    </button>

    <h4 id="h-group-divide" style="margin:15px 0 5px 0; color:#008c9e;">â‘¡ ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</h4>
    
    <label>
        <span id="lbl-group-num-text">ã‚°ãƒ«ãƒ¼ãƒ—æ•°:</span> 
        <input type="number" id="group-num-input" value="2" min="2" style="width:50px; padding:4px;">
    </label>
    
    <button id="btn-group-divide" onclick="groupNamesRandomly()" style="background:#008c9e; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
      ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ
    </button>

    <div style="text-align:right; margin-top:5px;">
        <button id="btn-clear-history" onclick="clearHistory()" style="background:#9e9e9e; color:white; border:none; padding:4px 8px; font-size:12px; border-radius:4px; cursor:pointer;">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
</div>

<div id="history-container" style="margin-top:15px; border-top:2px solid #ddd; padding-top:10px;">
    <p id="h-history-title" style="color:#666; font-size:13px; margin:0 0 5px 0;">â–¼ æŠ½é¸çµæœå±¥æ­´ (æ–°ã—ã„é †)</p>
    <div id="history-list" style="max-height: 300px; overflow-y: auto;">
    </div>
</div>

  <h3 id="program-timer-title" style="margin-bottom:8px; color:#00796b;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼</h3>

<div id="steps-container" class="steps"></div>
<button id="add-step" type="button">ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ </button>

<div class="set-group" style="margin-top:10px; margin-bottom:15px;">
  <!-- id ã‚’è¿½åŠ  -->
  <label id="set-count-label" for="set-count">ã‚»ãƒƒãƒˆæ•°ï¼š</label>
<input type="number" id="set-count" min="1">
</div>

<div style="display:flex; gap:10px; margin-bottom:15px;">
  <button id="start-timer" type="button">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button id="stop-timer" type="button">â–  ã‚¹ãƒˆãƒƒãƒ—</button>
  <button id="reset-timer" type="button">âŸ³ ãƒªã‚»ãƒƒãƒˆ</button>
</div>

  <div id="timer-display" class="timer-display">
    <h2 id="current-set">Set 1 / 3</h2>
    <h1 id="time-left">00:00</h1>
    <h3 id="step-info">Step 1</h3>
  </div>
</div>

<section id="video-quiz-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #fff3e0; padding: 15px 20px; border-bottom: 1px solid #ffe0b2;">
    <h2 style="color: #1a237e; margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
      Video Learning & Check ï¼ˆå‹•ç”»å­¦ç¿’ï¼†ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ï¼‰
    </h2>
    <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
      å‹•ç”»ã‚’è¦–è´ã—ã€ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã¦æå‡ºç”¨PDFã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
    </p>
  </div>

  <div style="padding: 20px;">
    
    <div id="vq-select-screen">
      <p id="vq-status-msg">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      <div id="vq-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>
    </div>

    <div id="vq-play-screen" style="display: none;">
      <button onclick="backToVideoList()" style="background: #999; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; cursor: pointer;">â—€ ä¸€è¦§ã«æˆ»ã‚‹</button>
      
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; margin-bottom: 20px; text-align: center;">
        <h3 id="vq-current-title" style="margin: 0 0 10px 0; color: #0d47a1;"></h3>
        <p style="font-size: 14px; margin-bottom: 10px;">ã¾ãšã¯å‹•ç”»ã‚’è¦–è´ã—ã¦ãã ã•ã„ï¼ˆåˆ¥ã‚¿ãƒ–ã§é–‹ãã¾ã™ï¼‰</p>
        <a id="vq-video-link" href="#" target="_blank" style="
          display: inline-block; 
          background: #d32f2f; color: white; text-decoration: none; 
          padding: 10px 25px; border-radius: 25px; font-weight: bold; 
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
          â–¶ YouTubeã§å‹•ç”»ã‚’è¦–è´ã™ã‚‹
        </a>
      </div>

      <div id="vq-questions-container"></div>

      <div style="text-align: center; margin-top: 20px;">
        <button onclick="submitVideoQuiz()" style="
          background: #ff9800; color: white; border: none; 
          padding: 12px 40px; border-radius: 30px; font-size: 16px; font-weight: bold; 
          cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          æ¡ç‚¹ã™ã‚‹ / Check Answers
        </button>
      </div>
    </div>

    <div id="vq-result-screen" style="display: none; text-align: center;">
      <h3 style="color: #1a237e;">ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† / Session Completed</h3>
      
      <div id="vq-result-content" style="
        border: 2px solid #ff9800; padding: 20px; margin: 20px auto; 
        max-width: 600px; background: #fff; position: relative;">
        
        <h4 style="margin: 0; color: #555;">ç†è§£åº¦ãƒã‚§ãƒƒã‚¯çµæœ</h4>
        <h2 id="vq-score-display" style="font-size: 40px; color: #e65100; margin: 10px 0;"></h2>
        <p id="vq-session-name" style="font-weight: bold; margin-bottom: 5px;"></p>
        <p style="font-size: 12px; color: #999;">å—é¨“æ—¥: <span id="vq-date"></span></p>
        
        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
        <div id="vq-feedback-list" style="text-align: left; font-size: 13px;"></div>
      </div>

      <button onclick="downloadVideoQuizPDF()" style="
        background: #1a237e; color: white; border: none; 
        padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; 
        cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
        ğŸ“„ çµæœã‚’PDFã§æå‡º
      </button>
      
      <button onclick="backToVideoList()" style="
        background: #ffcc80; color: #e65100; border: none; 
        padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; 
        cursor: pointer; margin-left: 10px;">
        çµ‚äº†ã—ã¦æˆ»ã‚‹
      </button>
    </div>

  </div>
</section>

<section id="english-unified-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #fff3e0; padding: 15px 20px 0 20px; border-bottom: 1px solid #ffe0b2;">
    <h2 style="color: #1a237e; margin: 0 0 15px 0; font-size: 20px;">
      Badminton English Learning
    </h2>
    <div style="display: flex; gap: 5px;">
      <button onclick="switchTab('phrases')" id="tab-btn-phrases" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #fff; color: #e65100; font-weight: bold; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
        ğŸ“– Phrase
      </button>
      <button onclick="switchTab('quiz')" id="tab-btn-quiz" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #e65100; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
        ğŸ“ Quiz
      </button>
      <button onclick="switchTab('listening')" id="tab-btn-listening" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #e65100; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
        ğŸ‘‚ Listening
      </button>
    </div>
  </div>

  <div style="padding: 20px;">
    
    <div id="content-phrases" style="display: block;">
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom: 15px;">
        <p style="font-size: 13px; color: #666; margin:0;">
          å½¹ç«‹ã¤è‹±èªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’éŸ³å£°ä»˜ãã§å­¦ç¿’ã—ã¾ã™ã€‚
        </p>
        <div style="background: #f0f0f0; padding: 5px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size:12px; font-weight:bold; color:#555;">Speed:</span>
          <input type="range" id="speech-rate" min="0.5" max="1.5" step="0.1" value="1.0" style="width: 80px; cursor: pointer;">
          <span id="rate-value" style="font-size:13px; font-weight:bold; color:#e65100; width:30px;">1.0</span>
        </div>
      </div>

      <div id="phrase-tabs" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px;">
        <button onclick="filterPhrases('practice')" class="phrase-tab" style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ¸ ç·´ç¿’ãƒ»åˆæµ</button>
        <button onclick="filterPhrases('coaching')" class="phrase-tab" style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ“£ æŒ‡å°ãƒ»åŠ©è¨€</button>
        <button onclick="filterPhrases('communication')" class="phrase-tab" style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ¤ æŒ¨æ‹¶ãƒ»ä¼šè©±</button>
        <button onclick="filterPhrases('airport')" class="phrase-tab" style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">âœˆï¸ ç©ºæ¸¯ãƒ»ç§»å‹•</button>
        <button onclick="filterPhrases('hotel')" class="phrase-tab" style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ¨ ãƒ›ãƒ†ãƒ«ãƒ»ç”Ÿæ´»</button>
        <button onclick="filterPhrases('tourism')" class="phrase-tab" style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ“· è¦³å…‰ãƒ»é£Ÿäº‹</button>
      </div>

      <div id="english-loading" style="text-align:center; color:#999; padding:20px;">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
      <div id="phrase-list" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <div id="content-quiz" style="display: none;">
      <div style="border-left: 4px solid #ff9800; padding-left: 10px; margin-bottom: 15px;">
        <h3 style="margin:0; color: #ff9800;">Badminton English Quiz</h3>
        <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
          å•é¡Œæ–‡ã‚’èª­ã‚“ã§æ­£è§£ã‚’é¸ã¶ã‚¯ã‚¤ã‚ºã§ã™ã€‚ï¼ˆå…¨5å•ï¼‰
        </p>
      </div>
      
      <div id="quiz-start-screen" style="text-align:center; padding: 20px; background:#fafafa; border-radius:8px;">
        <p id="quiz-status-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <button id="start-quiz-btn" onclick="startQuiz('normal')" disabled style="
          background: #ff9800; color: white; border: none; padding: 10px 25px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5;">
          ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹
        </button>
      </div>

      <div id="quiz-play-screen" style="display:none;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <span id="quiz-count" style="font-weight:bold; color:#ff9800;">Q 1 / 5</span>
          <span id="quiz-score" style="font-weight:bold; color:#333;">Score: 0</span>
        </div>
        <div id="quiz-question" style="font-size:16px; font-weight:bold; margin-bottom:20px; min-height:50px;"></div>
        <div id="quiz-options" style="display: grid; gap: 10px;"></div>
        
        <div id="quiz-feedback" style="display:none; margin-top:15px; padding:15px; border-radius:8px; background:#f0f0f0;">
          <h3 id="quiz-feedback-title" style="margin:0 0 5px 0;"></h3>
          <p id="quiz-feedback-text" style="margin:0; font-size:14px; color:#333; line-height:1.6;"></p>
          <button onclick="nextQuestion()" style="margin-top:10px; background:#333; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æ¬¡ã¸ â¡</button>
        </div>
      </div>

      <div id="quiz-result-screen" style="display:none; text-align:center; padding:20px;">
        <h3 style="color:#333;">çµæœç™ºè¡¨</h3>
        <p id="quiz-final-score" style="font-size:24px; font-weight:bold; color:#ff9800; margin:10px 0;"></p>
        <button onclick="startQuiz('normal')" style="margin-top:20px; background:#ff9800; color:white; border:none; padding:10px 25px; border-radius:25px; cursor:pointer;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
      </div>
    </div>

    <div id="content-listening" style="display: none;">
      <div style="border-left: 4px solid #00acc1; padding-left: 10px; margin-bottom: 15px;">
        <h3 style="margin:0; color: #00acc1;">Listening Test</h3>
        <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
          éŸ³å£°ã‚’èã„ã¦ã€æ­£ã—ã„ç­”ãˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ï¼ˆå…¨5å•ï¼‰
        </p>
      </div>
      
      <div id="listening-start-screen" style="text-align:center; padding: 20px; background:#fafafa; border-radius:8px;">
        <p id="listening-status-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <button id="start-listening-btn" onclick="startQuiz('listening')" disabled style="
          background: #00acc1; color: white; border: none; padding: 10px 25px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5;">
          ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹
        </button>
      </div>

      <div id="listening-play-screen" style="display:none;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <span id="listening-count" style="font-weight:bold; color:#00acc1;">Q 1 / 5</span>
          <span id="listening-score" style="font-weight:bold; color:#333;">Score: 0</span>
        </div>

        <div id="listening-question-area" style="text-align:center; padding: 30px 0; background:#e0f7fa; border-radius:8px; margin-bottom:20px;">
          <p style="font-size:14px; color:#555; margin-bottom:10px;">éŸ³å£°ã‚’å†ç”Ÿã—ã¦å•é¡Œã‚’èã„ã¦ãã ã•ã„</p>
          <button id="listening-speak-btn" style="
              width: 80px; height: 80px; border-radius: 50%; border: none; 
              background: #00acc1; color: white; font-size: 40px; cursor: pointer;
              box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s;
          " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
            ğŸ”Š
          </button>
        </div>

        <div id="listening-options" style="display: grid; gap: 10px;"></div>

        <div id="listening-feedback" style="display:none; margin-top:15px; padding:15px; border-radius:8px; background:#f0f0f0;">
          <h3 id="listening-feedback-title" style="margin:0 0 5px 0;"></h3>
          <p id="listening-feedback-text" style="margin:0; font-size:14px; color:#333; line-height:1.6;"></p>
          <button onclick="nextQuestion()" style="margin-top:10px; background:#333; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æ¬¡ã¸ â¡</button>
        </div>
      </div>

      <div id="listening-result-screen" style="display:none; text-align:center; padding:20px;">
        <h3 style="color:#333;">Result</h3>
        <p id="listening-final-score" style="font-size:24px; font-weight:bold; color:#00acc1; margin:10px 0;"></p>
        <button onclick="startQuiz('listening')" style="margin-top:20px; background:#00acc1; color:white; border:none; padding:10px 25px; border-radius:25px; cursor:pointer;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
      </div>
    </div>

  </div>
</section>


<section id="knowledge-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #fff3e0; padding: 15px 20px 0 20px; border-bottom: 1px solid #ffe0b2;">
    <h2 style="color: #1a237e; margin: 0 0 15px 0; font-size: 20px;">
      Badminton Theory Quiz
    </h2>
    <div style="display: flex; gap: 5px;">
      <button onclick="switchKnowledgeTab('basic')" id="k-tab-basic" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #fff; color: #e65100; font-weight: bold; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
        ğŸ“˜ åŸºç¤ç†è«–
      </button>
      <button onclick="switchKnowledgeTab('tactics')" id="k-tab-tactics" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #8d6e63; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
        âš”ï¸ æˆ¦è¡“ç†è«–
      </button>
      <button onclick="switchKnowledgeTab('coaching')" id="k-tab-coaching" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #8d6e63; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
        ğŸ“£ ã‚³ãƒ¼ãƒãƒ³ã‚°
      </button>
    </div>
  </div>

  <div style="padding: 20px;">
    <div id="knowledge-start-screen" style="text-align:center; padding: 20px; background:#fafafa; border-radius:8px;">
      <h3 id="knowledge-category-title" style="margin:0 0 10px 0; color:#e65100;">åŸºç¤ç†è«–ã‚¯ã‚¤ã‚º</h3>
      <p id="knowledge-status-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button id="start-knowledge-btn" onclick="startKnowledgeQuiz(5)" disabled style="
          background: #ffb74d; color: white; border: none; padding: 10px 20px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5;">
          ç·´ç¿’ (5å•)
        </button>

        <button id="start-test-btn" onclick="startKnowledgeQuiz(20)" disabled style="
          background: #e65100; color: white; border: none; padding: 10px 20px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5; font-weight:bold;">
          å®ŸåŠ›è¨ºæ–­ãƒ†ã‚¹ãƒˆ (20å•)
        </button>
      </div>
    </div>

    <div id="knowledge-play-screen" style="display:none;">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span id="knowledge-count" style="font-weight:bold; color:#e65100;">Q 1 / 5</span>
        <span id="knowledge-score" style="font-weight:bold; color:#333;">Score: 0</span>
      </div>
      <div id="knowledge-question" style="font-size:16px; font-weight:bold; margin-bottom:20px; min-height:50px; padding:15px; background:#fff3e0; border-radius:6px;"></div>
      <div id="knowledge-options" style="display: grid; gap: 10px;"></div>
      
      <div id="knowledge-feedback" style="display:none; margin-top:15px; padding:15px; border-radius:8px; background:#f0f0f0;">
        <h3 id="knowledge-feedback-title" style="margin:0 0 5px 0;"></h3>
        <p id="knowledge-feedback-text" style="margin:0; font-size:14px; color:#333; line-height:1.6;"></p>
        <button onclick="nextKnowledgeQuestion()" style="margin-top:10px; background:#333; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æ¬¡ã¸ â¡</button>
      </div>
    </div>

    <div id="knowledge-result-screen" style="display:none; text-align:center; padding:20px;">
      <h3 style="color:#333;">çµæœç™ºè¡¨</h3>
      <p id="knowledge-final-score" style="font-size:24px; font-weight:bold; color:#e65100; margin:10px 0;"></p>
      <p id="knowledge-rank-msg" style="font-size:16px; font-weight:bold; color:#1a237e; min-height: 20px;"></p>

      <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
        <button onclick="downloadKnowledgePDF()" style="background: #1a237e; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
          ğŸ“„ çµæœã‚’PDFã§ä¿å­˜
        </button>
        <button onclick="resetKnowledgeQuiz()" style="background: #ffb74d; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer;">
          ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
        </button>
      </div>
    </div>
  </div>
</section>

<section id="learning-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #fff3e0; padding: 15px 20px; border-bottom: 1px solid #ffe0b2;">
    <h3 style="margin:0; color:#1a237e; display:flex; align-items:center; gap:8px; font-size: 20px;">
      ğŸ“ ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    </h3>
  </div>

  <div style="padding: 20px;">

    <div id="sim-start-screen" style="text-align: center; padding: 20px 0;">
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        å®Ÿéš›ã®è©¦åˆã®æµã‚Œã‚’è¦‹ãªãŒã‚‰ã€<br>
        ãƒ€ãƒ–ãƒ«ã‚¹ã®è¤‡é›‘ãªã‚µãƒ¼ãƒ–æ¨©ç§»å‹•ã‚„ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚
      </p>
      <button onclick="openSimulation()" style="
        background: #ff9800; color: white; border: none; 
        padding: 12px 30px; border-radius: 30px; 
        font-size: 16px; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: inline-flex; align-items: center; gap: 8px;
        transition: transform 0.2s;
      ">
        â–¶ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
      </button>
    </div>

    <div id="sim-game-screen" style="display: none; animation: fadeIn 0.5s;">
      
      <div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #ffe0b2;">
        <div style="font-weight:bold; color:#d84315; margin-bottom:5px;">Scenario: <span id="scenario-title">ãƒ€ãƒ–ãƒ«ã‚¹ã®åŸºæœ¬</span></div>
        
        <div id="scenario-text" style="font-size:14px; min-height:40px; margin-bottom:10px;">
          è©¦åˆé–‹å§‹ï¼0-0ã§ã™ã€‚ã¾ãšã¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚
        </div>

        <div id="sim-options-container" style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px;">
        </div>

        <div style="display:flex; justify-content:center; gap:10px;">
          <button onclick="prevStep()" style="background:#ccc; color:#333; border:none; padding:8px 15px; border-radius:20px; font-size:12px;">â—€ å‰ã¸</button>
          <button onclick="nextStep()" id="btn-next-step" style="display:none; background:#ff9800; color:white; border:none; padding:8px 25px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);">æ¬¡ã¸é€²ã‚€ â–¶</button>
        </div>
      </div>

      <div class="visual-court-container" style="margin-bottom:10px;">
        <div class="court-net"></div>
        <div class="court-grid">
          <div class="c-cell" id="sim-c-l-odd"  style="grid-row: 2/3; grid-column: 2/3;"></div>
          <div class="c-cell" id="sim-c-l-even" style="grid-row: 3/4; grid-column: 2/3;"></div>
          <div class="c-cell" id="sim-c-r-even" style="grid-row: 3/4; grid-column: 3/4;"></div>
          <div class="c-cell" id="sim-c-r-odd"  style="grid-row: 2/3; grid-column: 3/4;"></div>
          <div class="c-cell area-out" style="grid-row: 2/4; grid-column: 1/2; background:rgba(0,0,0,0.1);"></div>
          <div class="c-cell area-out" style="grid-row: 2/4; grid-column: 4/5; background:rgba(0,0,0,0.1);"></div>
        </div>
        
        <div id="p-A1" class="player-label" style="background:#ffcdd2; color:#b71c1c;">A1</div>
        <div id="p-A2" class="player-label" style="background:#ffcdd2; color:#b71c1c;">A2</div>
        <div id="p-B1" class="player-label" style="background:#bbdefb; color:#0d47a1;">B1</div>
        <div id="p-B2" class="player-label" style="background:#bbdefb; color:#0d47a1;">B2</div>

        <div id="sim-shuttle" style="position:absolute; font-size:20px; z-index:20; transition:all 0.5s;">ğŸ¸</div>
      </div>

      <div style="display:flex; justify-content:center; align-items:center; gap:20px; font-weight:bold; font-size:20px;">
        <span style="color:#d32f2f;">A: <span id="sim-score-a">0</span></span>
        <span>-</span>
        <span style="color:#1976d2;">B: <span id="sim-score-b">0</span></span>
      </div>
      
      <div id="sim-explanation" style="display:none; margin-top:15px; background:#e8f5e9; padding:10px; border-radius:6px; border-left:4px solid #4caf50;">
        <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">ğŸ’¡ è§£èª¬</div>
        <div id="sim-explanation-text" style="font-size:13px;"></div>
      </div>
    </div>

  </div>
</section>

<script>
function openSimulation() {
  document.getElementById('sim-start-screen').style.display = 'none';
  document.getElementById('sim-game-screen').style.display = 'block';
  // å¿…è¦ã§ã‚ã‚Œã°ã“ã“ã§åˆæœŸåŒ–é–¢æ•°ã‚’å‘¼ã¶ (ä¾‹: initSimulation())
}
</script>

<section id="daily-challenge-section" style="
  margin-top: 30px;
  padding: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #fff3e0; padding: 15px 20px; border-bottom: 1px solid #ffe0b2;">
    <h2 style="color: #1a237e; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
       <span id="daily-title">æ—¥æœ¬ä¸€å‘¨ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã®æ—…</span>
    </h2>
    <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
      <span id="daily-desc">ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸè£œå¼·ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€åœ°å›³ã‚’å¡—ã‚Šã¤ã¶ãã†ï¼</span>
    </p>
  </div>

  <div style="padding: 20px; text-align: center;">
    
    <div style="margin-bottom: 20px;">
  <div onclick="toggleMapDisplay()" style="
      background: #f0f4c3; color: #33691e; padding: 10px; border-radius: 8px; border: 2px solid #dce775; 
      cursor: pointer; text-align: center; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  ">
    <span>ğŸ—ºï¸ ãƒãƒƒãƒ—ãƒ»ç¾åœ¨åœ°ã‚’ç¢ºèª</span>
    <span id="map-toggle-icon">â–²</span>
  </div>

  <div id="map-collapsible-area" style="margin-top: 10px; background: #f0f4c3; padding: 15px; border-radius: 10px; border: 2px solid #dce775;">
      
      <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
          <button onclick="switchMapMode('japan')" id="btn-map-japan" style="padding:6px 16px; border-radius:20px; border:none; background:#8bc34a; color:white; font-weight:bold; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
              ğŸ‡¯ğŸ‡µ æ—¥æœ¬ä¸€å‘¨
          </button>
          <button onclick="switchMapMode('world')" id="btn-map-world" disabled style="padding:6px 16px; border-radius:20px; border:none; background:#ccc; color:#666; font-weight:bold; cursor:not-allowed; box-shadow: none;">
              ğŸ”’ ä¸–ç•Œä¸€å‘¨ (æ—¥æœ¬ã‚¯ãƒªã‚¢ã§è§£æ”¾)
          </button>
      </div>
      
      <div style="font-weight:bold; color:#33691e; margin-bottom:5px; text-align: center;">
          ç¾åœ¨åœ°: <span id="current-location-name" style="font-size:18px; color:#d84315;">èª­ã¿è¾¼ã¿ä¸­...</span>
      </div>
      <div style="font-size:12px; color:#555; margin-bottom:10px; text-align: center;">
          <span id="map-progress-text">-- / -- åˆ¶è¦‡</span>
      </div>

      <div id="map-visual-container" style="width:100%; min-height:300px; margin:0 auto; background-color:#b3e5fc; border-radius:8px; border:2px solid #81d4fa; overflow:hidden;"></div>
  </div>
</div>

    <div style="margin-bottom: 15px;">
      <label for="daily-count" style="font-weight:bold; color:#333;"><span id="lbl-daily-count">ç¨®ç›®æ•°:</span></label>
      <input type="number" id="daily-count" value="7" min="1" max="20" style="width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
      <button id="btn-daily-gen" onclick="generateDailyChallenge()" style="
        background: #ff6f00; color: white; border: none; 
        padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-left: 10px;
      ">
        ğŸ° ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆ
      </button>
    </div>

    <div id="daily-menu-list" style="text-align: left; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: none;">
    </div>

    <button id="btn-complete-challenge" onclick="completeDailyChallenge()" disabled style="
      background: #ccc; color: white; border: none; 
      padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold;
      cursor: not-allowed; transition: all 0.3s;
    ">
      âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼ (é€²ã‚€)
    </button>
    <div id="daily-message" style="margin-top:10px; font-weight:bold; color:#e65100; height:20px;"></div>

    <hr style="border: 0; border-top: 1px dashed #ffe0b2; margin: 25px 0;">

    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
      
      <div style="background: #fff; padding: 15px 20px; border-radius: 8px; flex: 1; min-width: 140px; max-width: 200px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;"><span id="lbl-streak">ğŸ”¥ é€£ç¶šé”æˆ</span></div>
        <div style="font-size: 28px; font-weight: bold; color: #ff6f00;">
          <span id="streak-count">0</span> <span style="font-size:14px;">Days</span>
        </div>
      </div>

      <div style="background: #fff; padding: 15px 20px; border-radius: 8px; flex: 1; min-width: 140px; max-width: 200px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;"><span id="lbl-badges">ğŸ–ï¸ ç²å¾—ãƒãƒƒã‚¸</span></div>
        <div style="font-size: 28px; font-weight: bold; color: #fbc02d;">
          <span id="badge-count">0</span> <span style="font-size:14px;">å€‹</span>
        </div>
      </div>
    </div>

    <div style="margin-top: 20px; text-align: right;">
        <button onclick="resetDailyData()" style="
            background: #b0bec5; color: white; border: none; 
            padding: 5px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;
        ">
            ğŸ—‘ï¸ æ—…ã®è¨˜éŒ²ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
        </button>
    </div>
    </div>
</section>

<section id="pose-estimation-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #e1f5fe; padding: 15px 20px; border-bottom: 1px solid #b3e5fc;">
    <h3 style="margin:0; color:#01579b; display:flex; align-items:center; gap:8px; font-size: 20px;">
      AIãƒ•ã‚©ãƒ¼ãƒ è§£æ
    </h3>
    <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
      ã‚«ãƒ¡ãƒ©ã‚„å‹•ç”»ã‹ã‚‰éª¨æ ¼ã‚’æ¤œå‡ºã—ã€å…¨èº«ï¼ˆè‚©ãƒ»è‚˜ãƒ»è…°ãƒ»è†ï¼‰ã®è² è·ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚<br>
      â€»å‡¦ç†ãŒé‡ããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚éŒ²ç”»ãƒœã‚¿ãƒ³ã§è§£æçµæœã‚’ä¿å­˜å¯èƒ½ã§ã™ã€‚
    </p>
  </div>

  <div style="padding: 20px;">
<div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border: 1px solid #ddd;">
      <span style="font-weight: bold; font-size: 12px; color: #555;">âš™ï¸ èº«ä½“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š:</span>
      <label style="font-size: 13px;">èº«é•·(cm): <input type="number" id="bio-height" value="170" style="width:50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></label>
      <label style="font-size: 13px;">ä½“é‡(kg): <input type="number" id="bio-weight" value="65" style="width:50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></label>
      <label style="font-size: 13px;">ãƒ©ã‚±ãƒƒãƒˆ(g): <input type="number" id="bio-racket" value="85" style="width:50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></label>
    </div>

<div style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; display: flex; gap: 15px; align-items: center; border: 1px solid #90caf9;">
  <span style="font-weight: bold; font-size: 13px; color: #0277bd;">ğŸ‘ï¸ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</span>
  <span style="font-size: 14px; font-weight:bold; color:#0277bd;">
     ğŸ’  ãƒãƒªã‚´ãƒ³è¡¨ç¤º (å›ºå®š)
  </span>
  
  <span style="margin-left: 15px; border-left: 1px solid #ccc; padding-left: 15px;">
      <label style="cursor: pointer; font-size: 14px; font-weight: bold; color: #333;">
        <input type="checkbox" id="bg-toggle" checked onchange="toggleBackground()">
        ğŸ–¼ï¸ èƒŒæ™¯ã‚’è¡¨ç¤º
      </label>
  </span>
</div>

    <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
      <button onclick="startCamera()" style="background:#0288d1; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹• (å¤–å´/å†…å´)
      </button>

      <button onclick="toggleCamera()" style="background:#00bcd4; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; margin-left:10px;">
        ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
      </button>
      
      <label style="background:#009688; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; display:inline-block;">
        ğŸ“ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
        <input type="file" id="video-upload" accept="video/*" style="display:none;" onchange="handleVideoUpload(this)">
      </label>

      <div id="pose-video-controls" style="display:none; gap:5px;">
        <button onclick="poseVideoPlay()" style="background:#0277bd; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â–¶ å†ç”Ÿ</button>
        <button onclick="poseVideoPause()" style="background:#f9a825; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â¸ ä¸€æ™‚åœæ­¢</button>
        <button onclick="poseVideoReset()" style="background:#546e7a; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â® æœ€åˆã¸</button>
      </div>

      <button id="btn-record-start" onclick="startRecording()" style="background:#e91e63; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; display:none;">
        â— è§£æçµæœã‚’éŒ²ç”»
      </button>
      <button id="btn-record-stop" onclick="stopRecording()" style="background:#880e4f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; display:none;">
        â–  éŒ²ç”»åœæ­¢ï¼†ä¿å­˜
      </button>

      <button onclick="downloadPoseCSV()" id="btn-pose-csv" disabled style="background:#ccc; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:not-allowed;">
        ğŸ“¥ CSVä¿å­˜
      </button>
      <button onclick="stopTracking()" style="background:#d32f2f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        â¹ å…¨åœæ­¢
      </button>
    </div>

    <div style="position: relative; width: 100%; max-width: 640px; margin: 0 auto; background: #000; border-radius: 8px; overflow: hidden;">
      <video id="input_video" style="display: none;" playsinline></video>
      <canvas id="output_canvas" width="640" height="480" style="width: 100%; display: block;"></canvas>
      </div>

<div style="width: 100%; max-width: 640px; margin: 10px auto; background: #222; border-radius: 8px; padding: 10px; box-sizing: border-box;">
  <div style="font-size:12px; color:#ddd; margin-bottom:5px;">ğŸ“Š è² è·æ¨ç§» (Torque Timeline - L/R)</div>
  
  <div style="margin-bottom:10px; border-left: 3px solid #4fc3f7; padding-left: 5px;">
    <div style="font-size:10px; color:#aaa;">Right Side (å³)</div>
    <div style="margin-bottom:2px; font-size:11px; color:#4fc3f7;">ğŸ’ª å³è‚˜ (R-Elbow)</div>
    <canvas id="graph_r_elbow" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
    
    <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#ff8a65;">ğŸ’ª å³è‚© (R-Shoulder)</div>
    <canvas id="graph_r_shoulder" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
    
    <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#66bb6a;">ğŸ¦µ å³è† (R-Knee)</div>
    <canvas id="graph_r_knee" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
  </div>

  <div style="margin-bottom:10px; border-left: 3px solid #ff4081; padding-left: 5px;">
    <div style="font-size:10px; color:#aaa;">Left Side (å·¦)</div>
    <div style="margin-bottom:2px; font-size:11px; color:#80d8ff;">ğŸ’ª å·¦è‚˜ (L-Elbow)</div>
    <canvas id="graph_l_elbow" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
    
    <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#ffcc80;">ğŸ’ª å·¦è‚© (L-Shoulder)</div>
    <canvas id="graph_l_shoulder" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
    
    <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#a5d6a7;">ğŸ¦µ å·¦è† (L-Knee)</div>
    <canvas id="graph_l_knee" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
  </div>

  <div style="margin-bottom:5px; border-left: 3px solid #fdd835; padding-left: 5px;">
    <div style="font-size:11px; color:#fdd835; margin-bottom:2px;">ğŸ§ ä½“å¹¹ (Trunk)</div>
    <canvas id="graph_trunk" width="600" height="50" style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
  </div>
</div>
</section>

<section id="footwork-analysis-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #e8f5e9; padding: 15px 20px; border-bottom: 1px solid #c8e6c9;">
    <h3 style="margin:0; color:#2e7d32; display:flex; align-items:center; gap:8px; font-size: 20px;">
      ã‚²ãƒ¼ãƒ åˆ†æï¼ˆç§»å‹•é€Ÿåº¦ã€ç§»å‹•è·é›¢ã€è² è·é‡ï¼‰
    </h3>
    <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
      ç§»å‹•è»Œè·¡ã€ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã€é€Ÿåº¦ã€è·é›¢ã€è² è·é‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è§£æã—ã¾ã™ã€‚<br>
    </p>
  </div>

  <div style="padding: 20px;">
<div style="margin-bottom: 10px; background: #fff3e0; padding: 10px 15px; border-radius: 6px; border: 1px solid #ffe0b2; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
      <span style="font-weight:bold; font-size:13px; color:#e65100;">ğŸ‘¤ é¸æ‰‹è¨­å®š:</span>
      <label style="font-size:13px;">èº«é•·: <input type="number" id="fw-player-height" value="170" style="width:50px; padding:4px; border:1px solid #ccc; border-radius:4px;"> cm</label>
      <label style="font-size:13px;">ä½“é‡: <input type="number" id="fw-player-weight" value="65" style="width:50px; padding:4px; border:1px solid #ccc; border-radius:4px;"> kg</label>
      <label style="font-size:13px;">ãƒ©ã‚±ãƒƒãƒˆ: <input type="number" id="fw-player-racket" value="85" style="width:50px; padding:4px; border:1px solid #ccc; border-radius:4px;"> g</label>
    </div>
    <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
<div style="margin-bottom: 15px;">
      <button onclick="toggleFwInstructions()" style="
        background: #0288d1; color: white; border: none; padding: 8px 16px; 
        border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
        â„¹ï¸ åˆ†æãƒ»ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ³¨æ„ç‚¹
      </button>

      <div id="fw-instructions" style="display: none; margin-top: 10px; background: #e1f5fe; padding: 15px; border-radius: 8px; border: 1px solid #b3e5fc; color: #01579b;">
        <h4 style="margin: 0 0 10px 0; border-bottom: 1px solid #81d4fa; padding-bottom: 5px;">ğŸ“¸ æ’®å½±ã¨è¨­å®šã®ãƒã‚¤ãƒ³ãƒˆ</h4>
        
        <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
          <li><strong>æ’®å½±ä½ç½®:</strong> ã‚³ãƒ¼ãƒˆå¾Œæ–¹ã‹ã‚‰ã€ã‚³ãƒ¼ãƒˆå…¨ä½“ãŒå…¥ã‚‹ã‚ˆã†ã«å›ºå®šæ’®å½±ã—ã¦ãã ã•ã„ã€‚</li>
          <li><strong>åˆ†æå¯¾è±¡:</strong> ã€Œã‚³ãƒ¼ãƒˆæ‰‹å‰ã€ã«ã„ã‚‹é¸æ‰‹ã‚’åˆ†æã—ã¾ã™ã€‚</li>
          <li><strong>ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (4ç‚¹æŒ‡å®š):</strong><br>
            ä»¥ä¸‹ã®é †åºã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<br>
            <span style="color: #d32f2f; font-weight: bold;">â‘  ãƒãƒƒãƒˆæ”¯æŸ±ï¼ˆå·¦ï¼‰ã®æ ¹æœ¬</span><br>
            <span style="color: #d32f2f; font-weight: bold;">â‘¡ ãƒãƒƒãƒˆæ”¯æŸ±ï¼ˆå³ï¼‰ã®æ ¹æœ¬</span><br>
            <span style="color: #d32f2f; font-weight: bold;">â‘¢ ãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³ã¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®äº¤ç‚¹ï¼ˆå³ï¼‰</span><br>
            <span style="color: #d32f2f; font-weight: bold;">â‘£ ãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³ã¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®äº¤ç‚¹ï¼ˆå·¦ï¼‰</span>
          </li>
        </ul>

        <div style="margin-top: 15px; width: 100%; max-width: 250px; height: 180px; background: #2e7d32; border: 2px solid white; position: relative; margin-left: auto; margin-right: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #ddd; border-bottom: 1px dashed #999;"></div>
            <div style="position: absolute; top: -15px; width: 100%; text-align: center; color: white; font-size: 10px;">(ãƒãƒƒãƒˆå´)</div>
            
            <div style="position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">1</div>
            
            <div style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">2</div>
            
            <div style="position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">3</div>
            
            <div style="position: absolute; bottom: -5px; left: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">4</div>

            <svg style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
                <line x1="10" y1="10" x2="240" y2="10" style="stroke:rgba(255,255,0,0.7);stroke-width:2" />
                <line x1="240" y1="10" x2="240" y2="170" style="stroke:rgba(255,255,0,0.7);stroke-width:2" />
                <line x1="240" y1="170" x2="10" y2="170" style="stroke:rgba(255,255,0,0.7);stroke-width:2" />
            </svg>

            <div style="position: absolute; bottom: 10px; width: 100%; text-align: center; color: white; font-size: 10px;">(æ‰‹å‰ãƒ»ã‚«ãƒ¡ãƒ©å´)</div>
        </div>
      </div>
    </div>
    <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
      <button onclick="fwStartCamera()" style="background:#2e7d32; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹• (å¤–å´/å†…å´)
      </button>
      <button onclick="fwToggleCamera()" style="background:#00bcd4; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
      </button>
      <label style="background:#00897b; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; display:inline-block;">
        ğŸ“ å‹•ç”»èª­è¾¼
        <input type="file" accept="video/*" style="display:none;" onchange="fwHandleVideoUpload(this)">
      </label>

      <div id="fw-video-controls" style="display:none; gap:5px;">
        <button onclick="fwVideoPlay()" style="background:#0277bd; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â–¶ å†ç”Ÿ</button>
        <button onclick="fwVideoPause()" style="background:#f9a825; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â¸ ä¸€æ™‚åœæ­¢</button>
        <button onclick="fwVideoReset()" style="background:#546e7a; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â® æœ€åˆã¸</button>
      </div>

      <button onclick="fwStopAnalysis()" style="background:#d32f2f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        â¹ çµ‚äº†
      </button>

      <button onclick="fwToggleCSVRecording()" id="btn-fw-rec-data" style="background:#424242; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ”´ ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
      </button>

      <button onclick="fwDownloadCSV()" id="btn-fw-download-csv" disabled style="background:#ccc; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:not-allowed;">
        ğŸ“¥ CSVä¿å­˜
      </button>
      <button onclick="fwGeneratePDFReport()" id="btn-fw-report" style="background:#1565c0; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆ
      </button>

      <button onclick="fwToggleCalibration()" id="btn-fw-calib" style="background:#ff9800; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ“ è·é›¢æ ¡æ­£
      </button>

      <button onclick="fwResetData()" style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ
      </button>
      
      <label style="font-size:13px; display:flex; align-items:center; gap:5px; background:#f1f8e9; padding:5px 10px; border-radius:4px;">
        <input type="checkbox" id="fw-show-heatmap" checked> ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
      </label>
      <label style="font-size:13px; display:flex; align-items:center; gap:5px; background:#f1f8e9; padding:5px 10px; border-radius:4px;">
        <input type="checkbox" id="fw-show-trajectory" checked> è»Œè·¡
      </label>
    </div>

    <div style="max-width: 640px; margin: 0 auto;">

        <div id="fw-calib-guide" style="display:none; background:#fff3e0; padding:15px; border:1px solid #ffe0b2; margin-bottom:10px; border-radius:6px; font-size:14px;">
            <strong style="color:#e65100;">ã€è¨­å®šæ‰‹é †ã€‘</strong><br>
            1. å®Ÿéš›ã®è·é›¢(m)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            <div style="margin: 10px 0; display:flex; gap:15px;">
                <label>æ¨ªå¹…(m): <input type="number" id="fw-real-width" value="6.1" style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
                <label>ç¸¦å¹…(m): <input type="number" id="fw-real-height" value="6.7" style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
            </div>
            <span style="font-size:12px; color:#666;">â€»ãƒ€ãƒ–ãƒ«ã‚¹ç‰‡é¢ãªã‚‰ æ¨ª6.1m Ã— ç¸¦6.7m ãŒç›®å®‰ã§ã™ã€‚</span><br><br>
            
            2. ç”»é¢ä¸Šã®ã‚³ãƒ¼ãƒˆå››éš…ã‚’<span style="color:red; font-weight:bold;">ã€å·¦ä¸Š â†’ å³ä¸Š â†’ å³ä¸‹ â†’ å·¦ä¸‹ã€‘</span>ã®é †ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<br>
            <div id="fw-calib-status" style="margin-top:5px; font-weight:bold; color:#d32f2f;">ç¾åœ¨: 0ç‚¹ç›® / 4ç‚¹</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
            <div style="background:#fafafa; padding:10px; border-radius:6px; border:1px solid #ddd; text-align:center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size:12px; color:#666; font-weight:bold;">ç¾åœ¨ã®é€Ÿåº¦</div>
                <div style="font-size:28px; font-weight:bold; color:#2e7d32; line-height:1.2;">
                    <span id="fw-speed">0.0</span> <span style="font-size:14px; color:#555;">m/s</span>
                </div>
            </div>
            <div style="background:#fafafa; padding:10px; border-radius:6px; border:1px solid #ddd; text-align:center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size:12px; color:#666; font-weight:bold;">ç·ç§»å‹•è·é›¢</div>
                <div style="font-size:28px; font-weight:bold; color:#1565c0; line-height:1.2;">
                    <span id="fw-distance">0.0</span> <span style="font-size:14px; color:#555;">m</span>
                </div>
            </div>
        </div>

       <div id="fw_canvas_container" style="position: relative; width: 100%; height: auto; background: #000; border-radius: 8px; overflow: hidden; cursor: crosshair; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
    
    <video id="fw_video" style="display: none;" playsinline></video>
    
    <canvas id="fw_canvas" width="640" height="480" style="width: 100%; height: auto; display: block;"></canvas>
    
    <canvas id="fw_overlay" width="640" height="480" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
</div>

        <div style="margin-top:10px; padding:12px; background:#fff; border-radius:6px; border:1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:5px;">
                ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è² è· (Joint Torque)
            </div>
            <div style="display:flex; justify-content:space-between; text-align:center;">
                <div style="flex:1; border-right:1px solid #eee;">
                    <div style="font-size:11px; color:#666;">ğŸ¦µ å³è„š (Right)</div>
                    <div id="fw-load-knee-r" style="font-weight:bold; font-size:15px; color:#333;">0% (0Nm)</div>
                </div>
                <div style="flex:1; border-right:1px solid #eee;">
                    <div style="font-size:11px; color:#666;">ğŸ¦µ å·¦è„š (Left)</div>
                    <div id="fw-load-knee-l" style="font-weight:bold; font-size:15px; color:#333;">0% (0Nm)</div>
                </div>
                <div style="flex:1;">
                    <div style="font-size:11px; color:#666;">ğŸ§ ä½“å¹¹ (Trunk)</div>
                    <div id="fw-load-trunk" style="font-weight:bold; font-size:15px; color:#333;">0% (0Nm)</div>
                </div>
            </div>
        </div>
    </div>
</section>

<section id="video-comparison-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #e1f5fe; padding: 15px 20px; border-bottom: 1px solid #b3e5fc;">
    <h3 style="margin:0; color:#01579b; display:flex; align-items:center; gap:8px; font-size: 20px;">
      ãƒ•ã‚©ãƒ¼ãƒ æ¯”è¼ƒãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ (2ç”»é¢)
    </h3>
    <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
      å‹•ç”»ã‚’ä¸¦ã¹ã¦å†ç”Ÿã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã®é•ã„ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚<br>
      â€»ã‚¹ãƒ­ãƒ¼å†ç”Ÿã‚„å·¦å³åè»¢ï¼ˆãƒŸãƒ©ãƒ¼ï¼‰ã‚‚å¯èƒ½ã§ã™ã€‚
    </p>
  </div>

  <div style="padding: 20px;">
    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd; text-align: center;">
      
      <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;">
        <button onclick="compPlayBoth()" style="background:#0288d1; color:white; padding:8px 24px; border-radius:30px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:none; cursor:pointer;">
          â–¶ åŒæ™‚å†ç”Ÿ
        </button>
        <button onclick="compPauseBoth()" style="background:#d32f2f; color:white; padding:8px 24px; border-radius:30px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2); border:none; cursor:pointer;">
          â¸ ä¸€æ™‚åœæ­¢
        </button>
        <button onclick="compResetBoth()" style="background:#757575; color:white; padding:8px 16px; border-radius:30px; font-size:12px; border:none; cursor:pointer;">
          â® æœ€åˆã«æˆ»ã™
        </button>
      </div>

      <div style="display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; font-size: 13px;">
        <label style="color:#333;">
          ğŸ¢ ã‚¹ãƒ”ãƒ¼ãƒ‰: 
          <select id="comp-speed" onchange="compChangeSpeed()" style="padding:4px; border-radius:4px; border:1px solid #ccc;">
            <option value="0.1">0.1x (è¶…ã‚¹ãƒ­ãƒ¼)</option>
            <option value="0.25">0.25x (ã‚¹ãƒ­ãƒ¼)</option>
            <option value="0.5">0.5x (åŠé€Ÿ)</option>
            <option value="1.0" selected>1.0x (æ¨™æº–)</option>
            <option value="1.5">1.5x</option>
          </select>
        </label>
        <span style="color:#999;">|</span>
        <label style="color:#333;">
          ğŸ”„ åŒæœŸã‚·ãƒ¼ã‚¯: 
          <input type="range" id="comp-master-seek" value="0" min="0" max="100" step="0.1" style="vertical-align:middle; width:100px;" oninput="compMasterSeek(this.value)">
        </label>
      </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
      
  <div style="flex: 1; min-width: 300px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 10px;">
    <div style="font-weight:bold; color:#0277bd; margin-bottom:5px; display:flex; justify-content:space-between;">
      <span>ğŸ“º å‹•ç”» A</span>
      <label style="font-size:12px; cursor:pointer; color:#333;"><input type="checkbox" onchange="compToggleMirror('video-a')"> å·¦å³åè»¢</label>
    </div>
    <input type="file" accept="video/*" onchange="compLoadVideo(this, 'video-a')" style="font-size:12px; margin-bottom:5px; width:100%; box-sizing: border-box;">
    
    <div style="position:relative; width:100%; padding-top:56.25%; background:#000; border-radius:4px; overflow:hidden;">
      <video id="video-a" playsinline muted style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain;" ontimeupdate="compUpdateSeek('video-a')"></video>
    </div>
    <input type="range" id="seek-video-a" value="0" min="0" max="100" step="0.1" style="width:100%; margin-top:5px; box-sizing: border-box; display: block;" oninput="compIndividualSeek('video-a', this.value)">
  </div>

  <div style="flex: 1; min-width: 300px; background: #fafafa; border: 1px solid #eee; border-radius: 6px; padding: 10px;">
    <div style="font-weight:bold; color:#c2185b; margin-bottom:5px; display:flex; justify-content:space-between;">
      <span>ğŸ“¸ å‹•ç”» B </span>
      <label style="font-size:12px; cursor:pointer; color:#333;"><input type="checkbox" onchange="compToggleMirror('video-b')"> å·¦å³åè»¢</label>
    </div>
    <input type="file" accept="video/*" onchange="compLoadVideo(this, 'video-b')" style="font-size:12px; margin-bottom:5px; width:100%; box-sizing: border-box;">
    
    <div style="position:relative; width:100%; padding-top:56.25%; background:#000; border-radius:4px; overflow:hidden;">
      <video id="video-b" playsinline muted style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain;" ontimeupdate="compUpdateSeek('video-b')"></video>
    </div>
    <input type="range" id="seek-video-b" value="0" min="0" max="100" step="0.1" style="width:100%; margin-top:5px; box-sizing: border-box; display: block;" oninput="compIndividualSeek('video-b', this.value)">
  </div>
</div>
  </div>
</section>

<section id="formation-analysis-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
  <div style="background: #e0f2f1; padding: 15px 20px; border-bottom: 1px solid #b2dfdb;">
    <h3 style="margin:0; color:#00695c; display:flex; align-items:center; gap:8px; font-size: 20px;">
      ãƒ€ãƒ–ãƒ«ã‚¹é™£å½¢åˆ†æ (Formation Analysis)
    </h3>
    <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
      å‹•ç”»ã‹ã‚‰æ‰‹å‰å´ã‚³ãƒ¼ãƒˆã®é¸æ‰‹ã‚’æ¤œå‡ºã—ã€ã‚µã‚¤ãƒ‰ãƒã‚¤ã‚µã‚¤ãƒ‰(å®ˆå‚™)ã¨ãƒˆãƒƒãƒ—ã‚¢ãƒ³ãƒ‰ãƒãƒƒã‚¯(æ”»æ’ƒ)ã®æ¯”ç‡ã‚’åˆ†æã—ã¾ã™ã€‚<br>
å¥¥å´ã‚³ãƒ¼ãƒˆã®é¸æ‰‹ã‚’èªè­˜ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«åˆ†æã‚¨ãƒªã‚¢ã‚’æŒ‡å®šã—ã¾ã™ã€‚<br>
â€»å‡¦ç†ãŒé‡ã„ãŸã‚PCã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
    </p>
  </div>

  <div style="padding: 20px;">
    <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
      <label style="background:#00897b; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; display:inline-block;">
        ğŸ“ ãƒ€ãƒ–ãƒ«ã‚¹å‹•ç”»ã‚’é¸æŠ
        <input type="file" id="formation-video-upload" accept="video/*" style="display:none;" onchange="handleFormationVideo(this)">
      </label>

      <button onclick="toggleFormationAnalysis()" id="btn-formation-toggle" disabled style="background:#ccc; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:not-allowed;">
        â–¶ åˆ†æé–‹å§‹
      </button>
      
      <button onclick="toggleAreaSelectMode()" id="btn-formation-area" style="background:#ff9800; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ“ åˆ†æã‚¨ãƒªã‚¢æŒ‡å®š
      </button>
      <button onclick="resetFormationData()" style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
        ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ
      </button>
    </div>
    
    <div id="formation-area-msg" style="display:none; color:#d32f2f; font-weight:bold; margin-bottom:10px;">
      â€» ç”»é¢ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€æ‰‹å‰å´ã‚³ãƒ¼ãƒˆã®ç¯„å›²ã‚’å›²ã£ã¦ãã ã•ã„ã€‚
    </div>

    <div style="position: relative; width: 100%; max-width: 640px; margin: 0 auto; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <video id="formation_video" style="display: none;" playsinline muted></video>
      <canvas id="formation_canvas" width="640" height="360" style="width: 100%; height: auto; display: block;"></canvas>
      <div id="formation-loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; background:rgba(0,0,0,0.7); padding:10px 20px; border-radius:8px; display:none;">
        AIãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...
      </div>
    </div>

    <div style="margin-top: 20px; max-width: 640px; margin-left: auto; margin-right: auto;">
      <div style="background:#fafafa; padding:20px; border-radius:8px; border:1px solid #ddd; border-top: 4px solid #d32f2f; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h4 style="margin:0 0 15px 0; color:#d32f2f; text-align:center; font-size: 18px;">
           æ‰‹å‰å´ã‚³ãƒ¼ãƒˆ (Near Side) é™£å½¢åˆ†æ
        </h4>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size: 16px;">
          <span>âš”ï¸ æ”»æ’ƒ (Top & Back):</span>
          <span id="near-tb-val" style="font-weight:bold; color:#ef5350;">0%</span>
        </div>
        <div style="background:#e0e0e0; height:15px; border-radius:8px; overflow:hidden; margin-bottom:15px;">
          <div id="near-tb-bar" style="width:0%; height:100%; background:#ef5350; transition: width 0.3s;"></div>
        </div>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size: 16px;">
          <span>ğŸ›¡ï¸ å®ˆå‚™ (Side by Side):</span>
          <span id="near-ss-val" style="font-weight:bold; color:#1976d2;">0%</span>
        </div>
        <div style="background:#e0e0e0; height:15px; border-radius:8px; overflow:hidden;">
          <div id="near-ss-bar" style="width:0%; height:100%; background:#1976d2; transition: width 0.3s;"></div>
        </div>
      </div>
    </div>
</div>
    
    <p style="font-size:12px; color:#666; margin-top:10px; text-align:center;">
      â€» æ¨ªä¸¦ã³ã¨ç¸¦ä¸¦ã³ã®åˆ¤å®šã¯ã€ãƒšã‚¢é–“ã®è§’åº¦(45åº¦)ã‚’åŸºæº–ã«ã—ã¦ã„ã¾ã™ã€‚
    </p>
  </div>
</section>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<div id="auth-container" class="mb-4 p-4 bg-white border border-gray-200 rounded-lg shadow-inner">
    <h3 class="text-lg font-semibold text-gray-700 mb-2">è¬›ç¿’ä¼šç”¨ãƒ­ã‚°ã‚¤ãƒ³</h3>
    <p class="text-sm text-gray-500 mb-3">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
    <div class="flex items-center space-x-2">
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
               class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300" 
                onclick="loginWithPassword()">
            ãƒ­ã‚°ã‚¤ãƒ³
        </button>
    </div>
    <p id="login-status" class="mt-2 text-sm h-5"></p>
</div>

<button id="logout-button" class="mt-4 text-sm text-gray-500 hover:text-red-500 transition duration-300 ml-4" 
        style="display:none;" onclick="logout()">
    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
</button>

<section id="share-section" style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 6px; display: none;">
  <h3 style="color: #00796b; margin-top: 0;">ğŸ“¤ å—è¬›ç”Ÿã¸ã®è³‡æ–™å…±æœ‰ / Share Materials</h3>
  
  <p style="font-size: 13px; color: #666;">
    äº‹å‰ã«ä½œæˆã—ãŸQRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’é¸æŠã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
    Select and display a pre-made QR code image.
  </p>

  <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
    
    <label style="font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px;">â‘  QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’é¸æŠ (å¿…é ˆ):</label>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
      <input type="file" id="qr-image-file" accept="image/*" style="font-size: 14px;">
    </div>

    <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; color: #555;">â‘¡ ãƒªãƒ³ã‚¯å…ˆURL (ä»»æ„ / Optional):</label>
    <p style="font-size: 11px; color: #999; margin: 0 0 5px 0;">â€»å…¥åŠ›ã™ã‚‹ã¨ã€ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«ãã®ãƒšãƒ¼ã‚¸ã¸é£›ã³ã¾ã™ã€‚</p>
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="target-link-input" placeholder="https://..." style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
      <button onclick="displayPreMadeQR()" style="background: #e65100; color: white; border: none; padding: 8px 24px; border-radius: 4px; cursor: pointer; font-weight: bold;">
        è¡¨ç¤ºã™ã‚‹
      </button>
    </div>

    <div id="premade-qr-result" style="margin-top: 20px; display: none; text-align: center; background: white; padding: 20px; border-radius: 8px; border: 2px dashed #ccc;">
      <p style="font-size: 14px; font-weight: bold; color: #00796b; margin-bottom: 10px;">ğŸ‘‡ å—è¬›ç”Ÿç”¨ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢</p>
      
      <a id="qr-display-link" href="#" target="_blank" style="display: inline-block; cursor: default;">
        <img id="qr-display-img" src="" alt="QR Code" style="max-width: 250px; max-height: 250px; border: 1px solid #eee; display: block; margin: 0 auto;">
      </a>
      
      <p id="qr-link-msg" style="font-size: 11px; color: #999; margin-top: 10px; display: none;">ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒªãƒ³ã‚¯å…ˆã¸é£›ã³ã¾ã™</p>
    </div>
  </div>
</section>

<section id="feedback-container" style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 6px; display: none;">
    <h2> æŒ¯ã‚Šè¿”ã‚Š</h2>
    <hr>

    <div id="feedback-post">
        <p id="feedback-status" class="status-message" style="color:red;"></p>
        <label for="feedback-name">åå‰:</label>
        <input type="text" id="feedback-name" style="width: 150px;">
        <br>
        <label for="feedback-text">æŒ¯ã‚Šè¿”ã‚Š (å¿…é ˆ):</label>
        <textarea id="feedback-text" placeholder="æŒ¯ã‚Šè¿”ã‚Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" required></textarea>
        <button onclick="handleFeedbackSubmit()">æŠ•ç¨¿ã™ã‚‹</button>
    </div>

    <h3 style="margin-top: 30px;">æŠ•ç¨¿å†…å®¹ã®é–²è¦§</h3>
    <div id="feedback-list" style="border-top: 1px solid #eee; padding-top: 10px;">
        <p>æ„Ÿæƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
    </div>
</section>

    
 <script>
function extractNumber() {
    const playersEl = document.getElementById("number-players");
    const resultEl = document.getElementById("number-result");
    const playerCount = parseInt(playersEl.value, 10);

    if (isNaN(playerCount) || playerCount < 1) {
        resultEl.innerHTML = "âš  å‚åŠ äººæ•°ã‚’1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>âš  Please enter a number of 1 or more for the number of participants.";
        resultEl.style.color = "red";
        return;
    }

    // 1ã‹ã‚‰playerCountã¾ã§ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°ã‚’æŠ½å‡º
    const randomNumber = Math.floor(Math.random() * playerCount) + 1;
    
    resultEl.textContent = `æŠ½å‡ºã•ã‚ŒãŸãƒŠãƒ³ãƒãƒ¼: ${randomNumber}`;
    resultEl.style.color = "navy";
}

// ==========================================
// âœ… åå‰å¯¾å¿œï¼šå…¬å¹³ãªæŠ½é¸æ©Ÿèƒ½ï¼ˆå…¨å“¡ä¸€å·¡ã™ã‚‹ã¾ã§é‡è¤‡ãªã—ï¼‰
// ==========================================
let historyCount = 0;

// â˜…ã™ã§ã«é¸ã°ã‚ŒãŸäººã‚’è¨˜æ†¶ã—ã¦ãŠãé…åˆ—
let extractedWinners = [];    // å½“é¸ã—ãŸäººã®è¨˜éŒ²
let pastFacilitators = [];    // é€²è¡Œå½¹ã‚’ã‚„ã£ãŸäººã®è¨˜éŒ²

// å…±é€šï¼šåå‰ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦é…åˆ—ã«ã™ã‚‹
function getNameList() {
    const input = document.getElementById("name-list-input");
    if (!input) return [];
    return input.value.split(/\n/).map(s => s.trim()).filter(s => s !== "");
}

// å…±é€šï¼šå±¥æ­´è¡¨ç¤º
function addHistory(title, content) {
    historyCount++;
    const list = document.getElementById("history-list");
    const item = document.createElement("div");
    
    const now = new Date();
    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

    item.style.cssText = "background:#fff; border:1px solid #ccc; border-radius:4px; padding:10px; margin-bottom:8px; border-left:4px solid #008c9e;";
    item.innerHTML = `
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#555; margin-bottom:4px;">
            <strong>#${historyCount} ${title}</strong>
            <span>${timeStr}</span>
        </div>
        <div style="font-weight:bold; color:#333; white-space: pre-wrap;">${content}</div>
    `;
    list.prepend(item);
}

// ------------------------------------------
// â‘  1åæŠ½å‡ºï¼ˆå…¨å“¡å½“ãŸã‚‹ã¾ã§é‡è¤‡ãªã—ï¼‰
// ------------------------------------------
function extractNameRandomly() {
    const allNames = getNameList();
    if (allNames.length === 0) {
        alert("åç°¿ã«åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // ã¾ã å½“ãŸã£ã¦ã„ãªã„äººã‚’æ¢ã™
    let candidates = allNames.filter(name => !extractedWinners.includes(name));

    // ã‚‚ã—å…¨å“¡å½“ãŸã£ã¦ã„ãŸã‚‰ï¼ˆå€™è£œãŒ0äººãªã‚‰ï¼‰ã€ãƒªã‚»ãƒƒãƒˆã—ã¦å…¨å“¡ã‚’å€™è£œã«æˆ»ã™
    let isReset = false;
    if (candidates.length === 0) {
        extractedWinners = []; // å±¥æ­´ã‚¯ãƒªã‚¢
        candidates = [...allNames]; // å…¨å“¡å¾©æ´»
        isReset = true;
    }

    // å€™è£œã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1äººé¸ã¶
    const winner = candidates[Math.floor(Math.random() * candidates.length)];

    // é¸ã°ã‚ŒãŸäººã‚’è¨˜éŒ²ã«è¿½åŠ 
    extractedWinners.push(winner);

    // çµæœè¡¨ç¤º
    let msg = `ğŸ‰ ${winner}`;
    if (isReset) {
        msg += `\n<span style="font-size:11px; color:blue;">(å…¨å“¡ä¸€å·¡ã—ãŸãŸã‚ã€ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ)</span>`;
    } else {
        msg += `\n<span style="font-size:11px; color:#666;">(æ®‹ã‚Šæœªå½“é¸: ${candidates.length - 1}å)</span>`;
    }

    addHistory("å½“é¸è€…æŠ½å‡º", msg);
}

// ------------------------------------------
// â‘¡ ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ï¼ˆé€²è¡Œå½¹ã¯å…¨å“¡ã‚„ã‚‹ã¾ã§é‡è¤‡ãªã—ï¼‰
// ------------------------------------------
function groupNamesRandomly() {
    const names = getNameList();
    const groupNum = parseInt(document.getElementById("group-num-input").value);

    if (names.length < 2) return alert("2åä»¥ä¸Šã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    if (groupNum < 2 || groupNum > names.length) return alert("ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã¯é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");

    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    const shuffled = [...names];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—ç”Ÿæˆ
    const groups = Array.from({ length: groupNum }, () => []);
    shuffled.forEach((name, i) => groups[i % groupNum].push(name));

    let resultHTML = "";

    groups.forEach((g, i) => {
        if (g.length === 0) return;

        // ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã€Œã¾ã é€²è¡Œå½¹ã‚’ã‚„ã£ã¦ã„ãªã„äººã€ã‚’æ¢ã™
        let candidates = g.filter(member => !pastFacilitators.includes(member));

        // ã‚‚ã—ã‚°ãƒ«ãƒ¼ãƒ—å…¨å“¡ãŒã™ã§ã«çµŒé¨“æ¸ˆã¿ãªã‚‰ã€ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«é–¢ã—ã¦ã¯æ¡ä»¶ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨å“¡å€™è£œï¼‰
        // â€»ãŸã ã—ã€å…¨ä½“ã®å±¥æ­´ã¯æ¶ˆã•ãšã€ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã®ã¿å†é¸å‡ºã‚’è¨±å®¹ã™ã‚‹å½¢ã«ã—ã¾ã™
        let isLoop = false;
        if (candidates.length === 0) {
            candidates = [...g];
            isLoop = true;
        }

        // å€™è£œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é€²è¡Œå½¹ã‚’æ±ºå®š
        const leader = candidates[Math.floor(Math.random() * candidates.length)];

        // å±¥æ­´ã«è¿½åŠ ï¼ˆãŸã ã—ã€ä¸€åº¦ãƒªã‚»ãƒƒãƒˆæ‰±ã„ã§é¸ã°ã‚ŒãŸäººãŒã€ç„¡é™ã«å¢—ãˆãªã„ã‚ˆã†ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
        if (!pastFacilitators.includes(leader)) {
            pastFacilitators.push(leader);
        } else if (isLoop) {
             // å…¨å“¡çµŒé¨“æ¸ˆã¿ã§2å›ç›®ãŒå›ã£ã¦ããŸå ´åˆã€ã©ã†ã™ã‚‹ã‹ã€‚
             // å³å¯†ãªã€Œå…¨å“¡ãƒªã‚»ãƒƒãƒˆã€ã¯ç®¡ç†ãŒé›£ã—ã„ãŸã‚ã€
             // ã€Œã¾ã ã‚„ã£ã¦ãªã„äººãŒã„ã‚Œã°å„ªå…ˆã€ã„ãªã‘ã‚Œã°èª°ã§ã‚‚OKã€ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¦ã„ã¾ã™ã€‚
             // å…¨ä½“ã®ãƒªã‚»ãƒƒãƒˆã‚’ã‹ã‘ãŸã„å ´åˆã¯ã€æ‰‹å‹•ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†é‹ç”¨ãŒå®‰å…¨ã§ã™ã€‚
        }

        // è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
        const memberLinks = g.map(member => {
            if (member === leader) {
                return `<span style="color:red; font-weight:bold;">${member} (é€²è¡Œ)</span>`;
            }
            return member;
        });

        resultHTML += `<strong>[ã‚°ãƒ«ãƒ¼ãƒ— ${i + 1}]</strong> (${g.length}å)<br>${memberLinks.join(", ")}<br><br>`;
    });

    // ã‚‚ã—å…¨å“¡ãŒé€²è¡Œå½¹ã‚’çµŒé¨“ã—ãã£ãŸã‚‰ã€å†…éƒ¨çš„ã«å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚ã’ã‚‹ï¼ˆæ¬¡å›ã®ãŸã‚ã«ï¼‰
    // ç¾åœ¨ã®åç°¿å…¨å“¡ãŒ pastFacilitators ã«å«ã¾ã‚Œã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
    const allDone = names.every(n => pastFacilitators.includes(n));
    if (allDone) {
        resultHTML += `<div style="font-size:11px; color:blue; border-top:1px dashed #ccc;">â€»å…¨å“¡ãŒé€²è¡Œå½¹ã‚’çµŒé¨“ã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</div>`;
        pastFacilitators = []; // æ¬¡å›ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
    }

    addHistory("ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ (é€²è¡Œå½¹ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)", resultHTML);
}

// å±¥æ­´ã¨è¨˜æ†¶ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ã‚¯ãƒªã‚¢
function clearHistory() {
    if(confirm("å±¥æ­´ã¨ã€æŠ½é¸ã®å…¬å¹³åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆèª°ãŒå½“ãŸã£ãŸã‹ç­‰ï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        document.getElementById("history-list").innerHTML = "";
        historyCount = 0;
        extractedWinners = [];   // ãƒªã‚»ãƒƒãƒˆ
        pastFacilitators = [];   // ãƒªã‚»ãƒƒãƒˆ
        alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚å…¨å“¡ãŒæŠ½é¸å¯¾è±¡ã«æˆ»ã‚Šã¾ã™ã€‚");
    }
}

const translations = {
  ja: {
    title: "Smart Coach Badminton",
    appTitle: "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼†å­¦ç¿’ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª",
    channelTitle: "MASU Badminton Academy YouTubeãƒãƒ£ãƒ³ãƒãƒ«",
    categoryLabel: "ã‚«ãƒ†ã‚´ãƒªé¸æŠ",
    totalTime: "ç·æ™‚é–“",
    startTime: "é–‹å§‹æ™‚åˆ»",
    addButton: "è¿½åŠ ",
    aiSectionTitle: "èª²é¡Œãƒ»ç›®çš„ã®å…¥åŠ›",
    aiButton: "ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆ",
    templateHeader: "â‘£ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
    templateSelect: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã¶",
    createMenuTitle: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ",
    selectPrompt: "--é¸æŠã—ã¦ãã ã•ã„--",
    newMenuTitle: "æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²",
    menuNameLabel: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼å",
    newMenuTimeLabel: "æ™‚é–“ï¼ˆåˆ†ï¼‰",
    addNewMenuButton: "è¿½åŠ ",
    selectedMenuTitle: "é¸æŠã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆå¯ï¼‰",
    totalTimeText: "ç·æ™‚é–“",
    generateProgram: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ",
    previewProgram: "å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
    copyProgramText: "å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼",
    downloadProgramImage: "ç”»åƒã¨ã—ã¦ä¿å­˜",
    programNameLabel: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ å",
    programGoalLabel: "ç›®çš„",
    programContentTitle: "ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…å®¹ã€‘",
    thTime: "æ™‚é–“",
    thMainTraining: "ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°",
    thAdditionalInfo: "è£œè¶³èª¬æ˜",
    thYoutube: "YouTube",
    totalTimeLabel: "ç·æ™‚é–“",
    now: "ç¾åœ¨",
    minutes: "åˆ†",
    randomPlanTitle: "ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯",
    randomPlanLabel: "ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º:",
    randomKnock: "ãƒãƒƒã‚¯",
    randomRally: "ãƒ©ãƒªãƒ¼",
    randomStrength: "è£œå¼·",
    randomBtn: "ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ½å‡º",
ã€€ã€€numberExtractionTitle: "ãƒŠãƒ³ãƒãƒ¼æŠ½å‡º",
    ã€€labelNumberPlayers: "å‚åŠ äººæ•°:",
ã€€ã€€extractNumberButton: "ãƒ©ãƒ³ãƒ€ãƒ ãƒŠãƒ³ãƒãƒ¼æŠ½å‡º",
    programTimerTitle: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼",
    addStepButton: "ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ",
    startButton: "â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ",
    stopButton: "â–  ã‚¹ãƒˆãƒƒãƒ—",
    resetButton: "âŸ³ ãƒªã‚»ãƒƒãƒˆ",
    setCountLabel: "ã‚»ãƒƒãƒˆæ•°ï¼š", 
    currentSet: "Set", 
Â  Â  currentStep: "Step", 
ã€€ã€€groupDivisionTitle: "ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘",
Â  Â  labelGroupPlayers: "å‚åŠ äººæ•°:",
Â  Â  labelGroupCount: "ã‚°ãƒ«ãƒ¼ãƒ—æ•°:",
Â  Â  groupPlayersButton: "ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ",
Â  Â  menuExtractionTitle: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ½å‡º",
Â  Â  groupDivisionWarning: "âš  å‚åŠ äººæ•°ã¯2äººä»¥ä¸Šã€ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã¯2ä»¥ä¸Šã§äººæ•°ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚",
    secondsPlaceholder: "ç§’æ•°",
    downloadPdf: "PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
localSaveLabel: "ãƒ–ãƒ©ã‚¦ã‚¶ä¸€æ™‚ä¿å­˜:",
    btnSaveLocal: "ä¿å­˜ã™ã‚‹",
    btnLoadLocal: "å¾©å…ƒã™ã‚‹",
    btnClearLocal: "å‰Šé™¤",
    localSaveMsg: "ä¿å­˜å®Œäº†:",
    restoreMsg: "å¾©å…ƒå®Œäº†:",
    deleteMsg: "ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚",
tacticsTitle: "æˆ¦è¡“ãƒœãƒ¼ãƒ‰",
    btnSave: "ä¿å­˜",
    btnRestore: "å¾©å…ƒ",
    btnDelete: "å‰Šé™¤",
    modeMove: "âœ‹ ç§»å‹•",
    modePen: "âœï¸ ãƒšãƒ³",
    modeArrow: "â†— çŸ¢å°",
    modeText: "ğŸ“ æ–‡å­—",
    modeEraser: "ğŸ§½ æ¶ˆã—ã‚´ãƒ ",
    btnReset: "ãƒªã‚»ãƒƒãƒˆ",
    btnClearDraw: "æ›¸ãè¾¼ã¿æ¶ˆå»",
    btnSaveImg: "ç”»åƒä¿å­˜",
    btnShowCourt: "ã‚³ãƒ¼ãƒˆã‚’è¡¨ç¤º",
    btnHideCourt: "ã‚³ãƒ¼ãƒˆã‚’éš ã™",
    txtHint: "çŸ¢å°ï¼šãƒ‰ãƒ©ãƒƒã‚° / æ–‡å­—ï¼šã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ› / ç§»å‹•ï¼šãƒ‰ãƒ©ãƒƒã‚°",
courtAllocationTitle: "ã‚³ãƒ¼ãƒˆé…ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼",
lblNewCreate: "â‘  æ–°è¦ä½œæˆ:",
lblCourtCount: "ã‚³ãƒ¼ãƒˆ",
lblPlayerCount: "äººæ•°",
btnInitLayout: "ç”Ÿæˆ / ãƒªã‚»ãƒƒãƒˆ",
layoutToggleOpen: "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ã‚’é–‹ã",
layoutToggleClose: "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹",
btnAddSpot: "ï¼‹ ã€‡è¿½åŠ ",
btnExpandFloor: "â†• æ‹¡å¼µ",
lblSelectMode: "â˜‘ï¸ é¸æŠãƒ¢ãƒ¼ãƒ‰",
btnAlignTop: "â¬†ï¸ ä¸Šæƒãˆ",
btnAlignLeft: "â¬…ï¸ å·¦æƒãˆ",
btnAlignDist: "â†” æ¨ªç­‰é–“éš”",
btnClearSelect: "é¸æŠè§£é™¤",
btnStartOrder: "ğŸ”¢ ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’æŒ¯ã‚‹",
btnEndOrder: "å®Œäº†",
categorySelect: "â‘  ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ",
beginnerSectionTitle: "ğŸ”° åˆå¿ƒè€…å‘ã‘å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³",
        beginnerSectionDesc: "ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€YouTubeã‚¢ãƒ—ãƒªï¼ˆã¾ãŸã¯æ–°ã—ã„ã‚¿ãƒ–ï¼‰ã§å‹•ç”»ãŒé–‹ãã¾ã™ã€‚",
lblNameList: "å‚åŠ è€…åç°¿ (æ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›):",
        placeholderNameList: "ä¾‹ï¼š\nä½è—¤\néˆ´æœ¨\né«˜æ©‹\nç”°ä¸­",
        noteNameList: "â€»ã“ã“ã«åå‰ãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æŠ½é¸ã•ã‚Œã¾ã™ã€‚",
        hPickWinner: "â‘  å½“é¸è€…ã‚’é¸ã¶ (1å)",
        btnPickWinner: "1åæŠ½å‡º",
        hGroupDivide: "â‘¡ ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘",
        lblGroupNumText: "ã‚°ãƒ«ãƒ¼ãƒ—æ•°: ",
        btnGroupDivide: "ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ",
        btnClearHistory: "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢",
        hHistoryTitle: "â–¼ æŠ½é¸çµæœå±¥æ­´ (æ–°ã—ã„é †)",
doubles: "ãƒ€ãƒ–ãƒ«ã‚¹ (4äºº)",  
    singles: "ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (2äºº)", 
dailyTitle: "æ—¥æ›¿ã‚ã‚Šè£œå¼·ãƒãƒ£ãƒ¬ãƒ³ã‚¸",
    dailyDesc: "ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸè£œå¼·ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ãƒãƒƒã‚¸ã‚’é›†ã‚ã‚ˆã†ï¼",
    dailyCountLabel: "ç¨®ç›®æ•°:",
    dailyGenBtn: "ğŸ° ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆ",
    dailyCompleteBtn: "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼",
    dailyDoneBtn: "æœ¬æ—¥ã¯é”æˆæ¸ˆã¿ã§ã™",
    dailyStreak: "é€£ç¶šé”æˆ",
    dailyBadges: "ç²å¾—ãƒãƒƒã‚¸",
    dailyWeekly: "é€±é–“ã‚³ãƒ³ãƒ—",
    dailyMsgDone: "ğŸ‰ ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„åŠªåŠ›ã§ã—ãŸï¼æ˜æ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
customMode: "å¤‰å‰‡ (è‡ªç”±è¨­å®š)", 
    applyBtn: "é…ç½®é©ç”¨",
updateMessage: "æœ¬ã‚¢ãƒ—ãƒªã¯æ”¹è‰¯ã‚’é‡ã­ã¦éšæ™‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚<br>æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒ—ãƒªã¯ã€YouTubeã‹ã‚‰ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚"
  },
  en: {
    title: "Smart Coach Badminton",
    appTitle: "Badminton Training Program Creator",
    channelTitle: "MASU Badminton Academy YouTube Channel",
    categoryLabel: "Select Category",
    totalTime: "Total Time",
    startTime: "Start Time",
    addButton: "Add",
    aiSectionTitle: "Enter Challenge / Objective",
    aiButton: "Suggest Plan",
    templateHeader: "â‘£ Template",
    templateSelect: "Select Template",
    createMenuTitle: "Create Training Plan",
    selectPrompt: "--Please select--",
    newMenuTitle: "Register New plan",
    menuNameLabel: "Plan Name",
    newMenuTimeLabel: "Time (min)",
    addNewMenuButton: "Add",
    selectedMenuTitle: "Selected Plan (Drag to Reorder)",
    totalTimeText: "Total Time",
    generateProgram: "Generate Program",
    previewProgram: "Preview Program",
    copyProgramText: "Copy Program Text",
    downloadProgramImage: "Save as Image",
    programNameLabel: "Program Name",
    programGoalLabel: "Goal / Objective",
    programContentTitle: "Program Content",
    thTime: "Time",
    thMainTraining: "Main Training",
    thAdditionalInfo: "Additional Info",
    thYoutube: "YouTube",
    totalTimeLabel: "Total Time",
    now: "Now",
    minutes: "min",
    randomPlanTitle: "Group Work",
    randomPlanLabel: "Select random category:",
    randomKnock: "Knock",
    randomRally: "Rally",
    randomStrength: "Strength",
    randomBtn: "Extract",
    programTimerTitle: "Program Timer",
    addStepButton: "+ Add Step",
    startButton: "â–¶ Start",
    stopButton: "â–  Stop",
    resetButton: "âŸ³ Reset",
    setCountLabel: "Sets:", 
    currentSet: "Set", 
Â  Â  currentStep: "Step" ,
ã€€ã€€numberExtractionTitle: "Number Extraction",
    labelNumberPlayers: "Number of Players:",
    extractNumberButton: "Extract Random Number",
ã€€ã€€groupDivisionTitle: "Group Division",
Â  Â  labelGroupPlayers: "Number of Players:",
Â  Â  labelGroupCount: "Number of Groups:",
Â  Â  groupPlayersButton: "Execute Group Division",
Â  Â  menuExtractionTitle: "Menu Extraction",
Â  Â  groupDivisionWarning: "âš  Please set the number of participants to 2 or more, and the number of groups to 2 or more, but not exceeding the number of participants.",
Â  Â  secondsPlaceholder: "Seconds",
    downloadPdf: "Download as PDF",
localSaveLabel: "Browser Save:",
    btnSaveLocal: "Save",
    btnLoadLocal: "Restore",
    btnClearLocal: "Delete",
    localSaveMsg: "Save Complete:",
    restoreMsg: "Restore Complete:",
    deleteMsg: "Data deleted.",
tacticsTitle: "Tactics Board",
    btnSave: "Save",
    btnRestore: "Restore",
    btnDelete: "Delete",
    modeMove: "âœ‹ Move",
    modePen: "âœï¸ Pen",
    modeArrow: "â†— Arrow",
    modeText: "ğŸ“ Text",
    modeEraser: "ğŸ§½ Eraser",
    btnReset: "Reset",
    btnClearDraw: "Clear Ink",
    btnSaveImg: "Save Image",
    btnShowCourt: "Show Court",
    btnHideCourt: "Hide Court",
    txtHint: "Arrow: Drag / Text: Tap / Move: Drag",
courtAllocationTitle: "Court Allocation Simulator",
lblNewCreate: "â‘  Create New:",
lblCourtCount: "Courts",
lblPlayerCount: "Players",
btnInitLayout: "Generate / Reset",
layoutToggleOpen: "Open Layout Editor",
layoutToggleClose: "Close Layout Editor",
btnAddSpot: "ï¼‹ Add Spot",
btnExpandFloor: "â†• Expand",
lblSelectMode: "â˜‘ï¸ Select Mode",
btnAlignTop: "â¬†ï¸ Align Top",
btnAlignLeft: "â¬…ï¸ Align Left",
btnAlignDist: "â†” Distribute",
btnClearSelect: "Deselect",
btnStartOrder: "ğŸ”¢ Numbering Mode",
btnEndOrder: "Done",
categorySelect: "â‘  Select Menu from Category",
beginnerSectionTitle: "ğŸ”° Beginner's Video Lessons",
        beginnerSectionDesc: "Click on the list to open the video in the YouTube app (or a new tab).",
lblNameList: "Participant List (Line separated):",
        placeholderNameList: "Ex:\nSmith\nJohnson\nWilliams\nBrown",
        noteNameList: "* Enter names here to draw lots.",
        hPickWinner: "â‘  Pick a Winner (1 person)",
        btnPickWinner: "Pick 1 Person",
        hGroupDivide: "â‘¡ Group Division",
        lblGroupNumText: "Number of Groups: ",
        btnGroupDivide: "Execute Grouping",
        btnClearHistory: "Clear History",
        hHistoryTitle: "â–¼ Draw History (Newest First)",
doubles: "Doubles (4 Players)",  
    singles: "Singles (2 Players)",  
dailyTitle: "Daily Strength Challenge",
    dailyDesc: "Clear random strength menus and collect badges!",
    dailyCountLabel: "Exercises:",
    dailyGenBtn: "ğŸ° Generate Challenge",
    dailyCompleteBtn: "âœ… Challenge Complete!",
    dailyDoneBtn: "Completed Today",
    dailyStreak: "Streak",
    dailyBadges: "Total Badges",
    dailyWeekly: "Weekly Comp",
    dailyMsgDone: "ğŸ‰ Great job today! Keep it up tomorrow!",
customMode: "Custom (Irregular)", 
    applyBtn: "Apply Layout",
updateMessage: "We are constantly improving and updating this app.<br>The latest version is available on YouTube."
  }
};

let currentLang = 'ja'; // åˆæœŸå€¤
let dataFetched = false; // ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿ãƒ•ãƒ©ã‚°
let programData = []; // ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨

// è¨€èªåˆ‡æ›¿ãƒœã‚¿ãƒ³
function setLanguage(lang) {
  currentLang = lang;
  updateUI();
  // renderProgram(); // â€»programData ãŒæœªå®šç¾©ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ãã ã•ã„
  updateTimeProgress(); // ã“ã‚Œã‚‚é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
}

// ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¡¨ç¤ºï¼ˆprogramDataãŒå¿…è¦ï¼‰
function renderProgram() {
  const programBox = document.getElementById("program-content");
  if (!programBox || typeof programData === 'undefined') return; // å®‰å…¨ç­–

  programBox.innerHTML = ""; // åˆæœŸåŒ–

  programData.forEach(item => {
    const name = currentLang === "ja" ? item.name : item.name_en;
    const description = currentLang === "ja" ? item.description : item.description_en;
    
    const row = document.createElement("div");
    row.textContent = `${item.time}åˆ†: ${name} - ${description}`;
    programBox.appendChild(row);
  });
}

// UIæ›´æ–°
function updateUI() {
  const t = translations[currentLang];
  const statusEl = document.getElementById("statusMessage");

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: IDãŒå­˜åœ¨ã™ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
  const setText = (id, text) => {
      const el = document.getElementById(id);
      if(el && text) el.textContent = text;
  };

const updateMsgEl = document.getElementById("update-message");
    if (updateMsgEl) {
        updateMsgEl.innerHTML = t.updateMessage;
    }

  // --- â˜…è¿½åŠ é …ç›® ---
  setText("category-select-title", t.categorySelect);
  // ----------------

  setText("local-save-label", t.localSaveLabel);
  setText("btn-save-local", t.btnSaveLocal);
  setText("btn-load-local", t.btnLoadLocal);
  setText("btn-clear-local", t.btnClearLocal);

  setText("tactics-main-title", t.tacticsTitle);
  setText("btn-t-save", t.btnSave);
  setText("btn-t-restore", t.btnRestore);
  setText("btn-t-delete", t.btnDelete);
  
  setText("lbl-move", t.modeMove);
  setText("lbl-pen", t.modePen);
  setText("lbl-arrow", t.modeArrow);
  setText("lbl-text", t.modeText);
  setText("lbl-eraser", t.modeEraser);

  setText("btn-t-reset", t.btnReset);
  setText("btn-t-clear", t.btnClearDraw);
  setText("btn-t-saveimg", t.btnSaveImg);
  
  setText("txt-hint", t.txtHint);

  setText("court-allocation-title", t.courtAllocationTitle);
  setText("lbl-new-create", t.lblNewCreate);
  setText("lbl-court-count", t.lblCourtCount);
  setText("lbl-player-count", t.lblPlayerCount);
  setText("btn-init-layout", t.btnInitLayout);

  setText("lbl-name-list", t.lblNameList);
    
  // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯ textContent ã§ã¯ãªã placeholder å±æ€§ã‚’ä½¿ã„ã¾ã™
  const nameInput = document.getElementById("name-list-input");
  if (nameInput) {
      nameInput.placeholder = t.placeholderNameList;
  }

  setText("note-name-list", t.noteNameList);
  setText("h-pick-winner", t.hPickWinner);
  setText("btn-pick-winner", t.btnPickWinner);
  setText("h-group-divide", t.hGroupDivide);
  setText("lbl-group-num-text", t.lblGroupNumText);
  setText("btn-group-divide", t.btnGroupDivide);
  setText("btn-clear-history", t.btnClearHistory);
  setText("h-history-title", t.hHistoryTitle);
  setText("lbl-doubles", t.doubles);
  setText("lbl-singles", t.singles);
setText("lbl-custom", t.customMode);
  setText("btn-apply-custom", t.applyBtn);
setText("lbl-template-header", t.templateHeader);


  // â–¼â–¼â–¼ æ—¥æ›¿ã‚ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”¨ â–¼â–¼â–¼
  setText("daily-title", t.dailyTitle);
  setText("daily-desc", t.dailyDesc);
  setText("lbl-daily-count", t.dailyCountLabel);
  setText("btn-daily-gen", t.dailyGenBtn);
  setText("lbl-streak", t.dailyStreak);
  setText("lbl-badges", t.dailyBadges);
  setText("lbl-weekly", t.dailyWeekly);
  // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

  // é–‹é–‰ãƒœã‚¿ãƒ³
  const layoutContent = document.getElementById("layout-builder-content");
  if (layoutContent && layoutContent.style.display === "block") {
    setText("layout-toggle-text", t.layoutToggleClose);
  } else {
    setText("layout-toggle-text", t.layoutToggleOpen);
  }

  // å†…éƒ¨ãƒœã‚¿ãƒ³
  setText("btn-l-save", t.btnSave);        
  setText("btn-l-restore", t.btnRestore); 
  setText("btn-l-delete", t.btnDelete);    
  setText("btn-l-saveimg", t.btnSaveImg);  

  setText("btn-add-spot", t.btnAddSpot);
  setText("btn-expand-floor", t.btnExpandFloor);
  setText("lbl-select-mode", t.lblSelectMode);
  setText("btn-align-top", t.btnAlignTop);
  setText("btn-align-left", t.btnAlignLeft);
  setText("btn-align-dist", t.btnAlignDist);
  setText("btn-l-clear-select", t.btnClearSelect);
  setText("btn-start-order", t.btnStartOrder);
  setText("btn-end-order", t.btnEndOrder);

  // ã‚³ãƒ¼ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³
  const courtArea = document.getElementById("tactics-court-area");
  if (courtArea && courtArea.style.display === "block") {
      setText("court-toggle-text", t.btnHideCourt);
  } else {
      setText("court-toggle-text", t.btnShowCourt);
  }

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã¾ã‚ã‚Š
  const headerH1 = document.querySelector("header h1");
  if(headerH1) headerH1.textContent = t.title;

  const catLabel = document.querySelector("label[for='category']");
  if(catLabel) catLabel.textContent = t.categoryLabel;
  
  setText("total-time-label", t.totalTime);

  const startLabel = document.querySelector("label[for='start-time']");
  if(startLabel) startLabel.textContent = t.startTime;

  setText("app-title", t.appTitle);
  setText("channel-title", t.channelTitle);

  document.querySelectorAll(".menu-item button").forEach(btn => {
    btn.textContent = t.addButton;
  });

  const aiTitle = document.querySelector("#ai-section h3");
  if(aiTitle) aiTitle.textContent = t.aiSectionTitle;
  
  const aiBtn = document.querySelector("#ai-section button");
  if(aiBtn) aiBtn.textContent = t.aiButton;

  const trainingH3 = document.querySelector("#training-menu-box h3");
  if(trainingH3) trainingH3.textContent = t.templateTitle;

  const tmplOption = document.querySelector("#templateSelect option");
  if(tmplOption) tmplOption.textContent = t.templateSelect;

  const createH3 = document.querySelector("#create-menu-box h3");
  if(createH3) createH3.textContent = t.createMenuTitle;

  const catOption = document.querySelector("#category option[value='']");
  if(catOption) catOption.textContent = t.selectPrompt;

  const newMenuLabel = document.querySelector("label[for='new-menu-name']");
  if(newMenuLabel) newMenuLabel.textContent = t.menuNameLabel;

  setText("newMenuTitle", t.newMenuTitle);

  const newTimeLabel = document.querySelector("label[for='new-menu-time']");
  if(newTimeLabel) newTimeLabel.textContent = t.newMenuTimeLabel;

  const beginnerTitle = document.getElementById("beginner-section-title");
  if (beginnerTitle) beginnerTitle.textContent = t.beginnerSectionTitle;

  const beginnerDesc = document.getElementById("beginner-section-desc");
  if (beginnerDesc) beginnerDesc.textContent = t.beginnerSectionDesc;

  setText("add-new-menu-btn", t.addNewMenuButton);
  setText("selected-menu-title", t.selectedMenuTitle);

  // æ™‚é–“è¡¨ç¤ºã®ç‰¹æ®Šå‡¦ç†
  const totalTimeTextNode = document.getElementById("total-time-text");
  if(totalTimeTextNode && totalTimeTextNode.childNodes[0]) {
      totalTimeTextNode.childNodes[0].textContent = t.totalTimeText + ": ";
  }
  
  setText("number-extraction-title", t.numberExtractionTitle);
  setText("label-number-players", t.labelNumberPlayers);
  setText("extract-number-btn", t.extractNumberButton);
  setText("download-program-png", t.downloadProgramImage);
  setText("download-program-pdf", t.downloadPdf);

  // ç·æ™‚é–“ã®æ›´æ–°
  const totalTimeSpan = document.getElementById("total-time");
  const totalTimeParent = document.getElementById("total-time-text"); 
  if (totalTimeSpan && totalTimeParent) {
    const timeValue = totalTimeSpan.textContent;
    totalTimeParent.innerHTML = 
        `${t.totalTimeText}: <span id="total-time">${timeValue}</span> ${t.minutes}`;
  }

  // ç·´ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰ãƒ©ãƒ™ãƒ«
  setText("total-time-label", t.totalTimeLabel);

  setText("generate-program", t.generateProgram);
  setText("preview-program", t.previewProgram);
  setText("copy-program-html", t.copyProgramText);
  setText("download-program-png", t.downloadProgramImage);
  
  setText("program-name-label", t.programNameLabel);
  setText("program-goal-label", t.programGoalLabel);
  setText("program-content-title", t.programContentTitle);
  setText("th-time", t.thTime);
  setText("th-main-training", t.thMainTraining);
  setText("th-additional-info", t.thAdditionalInfo);
  setText("th-youtube", t.thYoutube);

  // ãƒ—ãƒ­ã‚°ãƒ©ãƒ åã¨ç›®çš„ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  const editableNameEl = document.getElementById("editable-name");
  const editablePurposeEl = document.getElementById("editable-purpose");

  if (editableNameEl && editablePurposeEl) {
    if (currentLang === 'ja') {
        if (editableNameEl.value === 'Overall Training Program' || editableNameEl.value === '') {
            editableNameEl.value = "ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ";
        }
        if (editablePurposeEl.value === 'Aim to strengthen [Objective].' || editablePurposeEl.value === '') {
            editablePurposeEl.value = "ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚";
        }
    } else {
        if (editableNameEl.value === 'ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ' || editableNameEl.value === '') {
            editableNameEl.value = "Overall Training Program";
        }
        if (editablePurposeEl.value === 'ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚' || editablePurposeEl.value === '') {
            editablePurposeEl.value = "Aim to strengthen [Objective].";
        }
    }
  }

  // ãƒ©ãƒ³ãƒ€ãƒ ãƒ—ãƒ©ãƒ³
  setText("random-plan-title", t.randomPlanTitle);
  setText("random-plan-label", t.randomPlanLabel);
  setText("label-random-knock", t.randomKnock);
  setText("label-random-rally", t.randomRally);
  setText("label-random-strength", t.randomStrength);
  
  const randBtn = document.getElementById("random-btn");
  if(randBtn) randBtn.textContent = t.randomBtn || (currentLang === "ja" ? "æŠ½å‡º" : "Extract");

  setText("group-division-title", t.groupDivisionTitle);
  setText("label-group-players", t.labelGroupPlayers);
  setText("label-group-count", t.labelGroupCount);
  setText("group-players-btn", t.groupPlayersButton);
  setText("menu-extraction-title", t.menuExtractionTitle);

  // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼
  setText("program-timer-title", t.programTimerTitle);
  setText("add-step", t.addStepButton);
  setText("set-count-label", t.setCountLabel);
  setText("start-timer", t.startButton);
  setText("stop-timer", t.stopButton);
  setText("reset-timer", t.resetButton);

  document.querySelectorAll(".step-input").forEach(input => {
        input.placeholder = t.secondsPlaceholder;
    });

  const currentSetEl = document.getElementById("current-set");
  if (currentSetEl) {
    const setNumbers = currentSetEl.textContent.match(/(\d+\s\/\s\d+)/g) ? currentSetEl.textContent.match(/(\d+\s\/\s\d+)/g)[0] : '1 / 3'; 
    currentSetEl.textContent = `${t.currentSet} ${setNumbers}`;
  }

  const stepInfoEl = document.getElementById("step-info");
  if (stepInfoEl) {
    const stepNumber = stepInfoEl.textContent.match(/(\d+)/g) ? stepInfoEl.textContent.match(/(\d+)/g)[0] : '1';
    stepInfoEl.textContent = `${t.currentStep} ${stepNumber}`;
  }

  // UIæ›´æ–°æ™‚ã«æ—¥æ›¿ã‚ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ãƒœã‚¿ãƒ³ã‚‚æœ€æ–°è¨€èªã«æ›´æ–°
  if(typeof updateDailyUI === 'function') {
      updateDailyUI();
  }

}
   
  // ==========================================
// âœ… ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆä¿®æ­£ãƒ»çµ±åˆç‰ˆï¼‰
// ==========================================
document.addEventListener("DOMContentLoaded", () => {
    console.log("åˆæœŸåŒ–å‡¦ç†é–‹å§‹");

    // 1. åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    loadSheet(); 
    
    // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ
    const genBtn = document.getElementById("generate-program");
    if (genBtn) genBtn.addEventListener("click", displayProgram);

    // å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    const preBtn = document.getElementById("preview-program");
    if (preBtn) preBtn.addEventListener("click", showSharePreview);

    // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼
    const copyBtn = document.getElementById("copy-program-html");
    if (copyBtn) copyBtn.addEventListener("click", copyProgramText);

    // ç”»åƒä¿å­˜
    const pngBtn = document.getElementById("download-program-png");
    if (pngBtn) pngBtn.addEventListener("click", () => downloadElementAsPng("program-output"));

    // PDFä¿å­˜
    const pdfBtn = document.getElementById("download-program-pdf");
    if (pdfBtn) pdfBtn.addEventListener("click", exportPreviewPDF);

    // ã‚«ãƒ†ã‚´ãƒªé¸æŠ
    const catSelect = document.getElementById("category");
    if (catSelect) {
        catSelect.addEventListener("change", e => {
            if (e.target.value) showMenu(e.target.value);
        });
    }

    // æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ 
    const addMenuBtn = document.getElementById("add-new-menu-btn");
    if (addMenuBtn) {
        addMenuBtn.addEventListener("click", () => {
             const name = document.getElementById("new-menu-name").value.trim();
             const time = parseFloat(document.getElementById("new-menu-time").value);
             if (!name) return alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nPlease enter the plan name.");

             selectedMenus.push({
               category: "æ–°è¦ä½œæˆ",
               name: name,
               time: time || 0,
               url: "",
               note: ""
             });
             document.getElementById("new-menu-name").value = "";
             document.getElementById("new-menu-time").value = "";
             renderSelectedList();
        });
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    const loginBtn = document.getElementById("login-button");
    if (loginBtn) loginBtn.addEventListener("click", loginWithPassword);
    
    const logoutBtn = document.getElementById("logout-button");
    if (logoutBtn) logoutBtn.addEventListener("click", logout);

    // ãƒŠãƒ³ãƒãƒ¼æŠ½å‡ºãƒ»ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
    const extractNumberBtn = document.getElementById("extract-number-btn");
    if (extractNumberBtn) extractNumberBtn.addEventListener("click", extractNumber);

    const groupPlayersBtn = document.getElementById("group-players-btn");
    if (groupPlayersBtn) groupPlayersBtn.addEventListener("click", groupPlayers);

    // æ™‚é–“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®åˆæœŸåŒ–ã¨ç›£è¦–
    const targetTimeInput = document.getElementById("target-time");
    if (targetTimeInput) targetTimeInput.addEventListener("input", updateTimeProgress);
    updateTimeProgress(); // åˆæœŸè¡¨ç¤ºæ›´æ–°
});


// â–¼â–¼â–¼ ãƒ–ãƒ©ã‚¦ã‚¶ä¸€æ™‚ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² â–¼â–¼â–¼
    const btnSave = document.getElementById("btn-save-local");
    const btnLoad = document.getElementById("btn-load-local");
    const btnClear = document.getElementById("btn-clear-local");

    if (btnSave) btnSave.addEventListener("click", saveToBrowser);
    if (btnLoad) btnLoad.addEventListener("click", loadFromBrowser);
    if (btnClear) btnClear.addEventListener("click", clearBrowserData);

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ï¼ˆä»»æ„ï¼‰
    if (localStorage.getItem("smartCoachDraft")) {
        const statusEl = document.getElementById("local-save-status");
        if (statusEl) statusEl.textContent = "â€»ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™";
    }


  // âœ… PDFå‡ºåŠ›
  async function exportPreviewPDF() {
    const previewDiv = document.getElementById("share-preview");
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒã‚§ãƒƒã‚¯
    if (!previewDiv || !previewDiv.innerHTML.trim()) {
        alert("å…ˆã«ã€Œå…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚\nFirst, press the â€œShare Previewâ€ button to display the preview.");
        return;
    }

    // å‡¦ç†ä¸­ã®è¡¨ç¤º
    const btn = document.getElementById("download-program-pdf");
    const originalText = btn.textContent;
    btn.textContent = "ç”Ÿæˆä¸­...";
    btn.disabled = true;

    try {
        // 1. html2canvasã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éƒ¨åˆ†ã‚’ç”»åƒåŒ– (scale: 2 ã§é«˜ç”»è³ªåŒ–)
        const canvas = await html2canvas(previewDiv, { 
            scale: 2,
            useCORS: true, // å¤–éƒ¨ç”»åƒã®èª­ã¿è¾¼ã¿è¨±å¯ï¼ˆQRãªã©ï¼‰
            logging: false
        });
        const imgData = canvas.toDataURL("image/png");

        // 2. pdfMakeã®å®šç¾©ä½œæˆï¼ˆç”»åƒã‚’åŸ‹ã‚è¾¼ã‚€ï¼‰
        const docDefinition = {
            content: [
                {
                    image: imgData,
                    width: 500, // PDFã®æ¨ªå¹…ã«åˆã‚ã›ã¦èª¿æ•´
                    alignment: 'center'
                }
            ],
            // ä½™ç™½è¨­å®š
            pageMargins: [20, 20, 20, 20]
        };

        // 3. PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        pdfMake.createPdf(docDefinition).download("SmartCoach_Program.pdf");

    } catch (err) {
        console.error("PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
        alert("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    } finally {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

  // âœ… å…±æœ‰URLã‚’ç”Ÿæˆã™ã‚‹å‡¦ç†
  function generateShareLink() {
    if (!selectedMenus.length) {
      alert("å…±æœ‰ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const data = encodeURIComponent(JSON.stringify(selectedMenus));
    const baseUrl = `${location.origin}${location.pathname}`;
    const shareUrl = `${baseUrl}?share=${data}`;

    navigator.clipboard.writeText(shareUrl).then(() => {
      alert("å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nç›¸æ‰‹ã«ã“ã®ãƒªãƒ³ã‚¯ã‚’é€ã‚Œã°åŒã˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å†ç¾ã§ãã¾ã™ã€‚");
    });
  }


// ==========================================
// âœ… ãƒ–ãƒ©ã‚¦ã‚¶ä¸€æ™‚ä¿å­˜æ©Ÿèƒ½ (LocalStorage)
// ==========================================

// 1. ä¿å­˜ã™ã‚‹
function saveToBrowser() {
    if (!selectedMenus.length) {
        alert(currentLang === 'ja' ? "ä¿å­˜ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" : "No menu selected to save.");
        return;
    }

    const currentName = document.getElementById("editable-name")?.value || editableName || "";
    const currentPurpose = document.getElementById("editable-purpose")?.value || editablePurpose || "";

    const saveData = {
        menus: selectedMenus,
        startTime: document.getElementById("start-time").value,
        targetTime: document.getElementById("target-time").value,
        programName: currentName,
        programPurpose: currentPurpose,
        isGenerated: isProgramGenerated,
        timestamp: new Date().toLocaleString()
    };

    localStorage.setItem("smartCoachDraft", JSON.stringify(saveData));
    
    // è¨€èªè¨­å®šã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    const t = translations[currentLang];
    const statusEl = document.getElementById("local-save-status");
    if(statusEl) {
        statusEl.textContent = `${t.localSaveMsg} ${saveData.timestamp}`;
        statusEl.style.color = "#e65100";
        setTimeout(() => { statusEl.textContent = ""; }, 3000);
    }
}

function loadFromBrowser() {
    const json = localStorage.getItem("smartCoachDraft");
    if (!json) {
        alert(currentLang === 'ja' ? "ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" : "No saved data found.");
        return;
    }

    const confirmMsg = currentLang === 'ja' 
        ? "ç¾åœ¨ã®å†…å®¹ã‚’ç ´æ£„ã—ã¦ã€ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ" 
        : "Are you sure you want to restore? Current data will be lost.";

    if (!confirm(confirmMsg)) {
        return;
    }

    try {
        const data = JSON.parse(json);
        
        selectedMenus = data.menus || [];
        if (document.getElementById("start-time")) document.getElementById("start-time").value = data.startTime || "00:00";
        if (document.getElementById("target-time")) document.getElementById("target-time").value = data.targetTime || "";

        renderSelectedList();
        
        if (data.isGenerated || data.programName || data.programPurpose) {
            displayProgram(); 
            const nameEl = document.getElementById("editable-name");
            const purposeEl = document.getElementById("editable-purpose");

            if (data.programName) {
                if (nameEl) nameEl.value = data.programName;
                editableName = data.programName;
            }
            if (data.programPurpose) {
                if (purposeEl) purposeEl.value = data.programPurpose;
                editablePurpose = data.programPurpose;
            }
        }
        
        // è¨€èªè¨­å®šã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const t = translations[currentLang];
        const statusEl = document.getElementById("local-save-status");
        if(statusEl) statusEl.textContent = `${t.restoreMsg} ${data.timestamp || ""}`;
        
    } catch (e) {
        console.error("Restore Error:", e);
        alert("Error restoring data.");
    }
}

function clearBrowserData() {
    if (!localStorage.getItem("smartCoachDraft")) return;
    
    const confirmMsg = currentLang === 'ja'
        ? "ä¿å­˜ã•ã‚ŒãŸä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
        : "Delete saved draft data?";

    if (confirm(confirmMsg)) {
        localStorage.removeItem("smartCoachDraft");
        const t = translations[currentLang];
        document.getElementById("local-save-status").textContent = t.deleteMsg;
        setTimeout(() => { document.getElementById("local-save-status").textContent = ""; }, 3000);
    }
}

  // âœ… URLã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¾©å…ƒã™ã‚‹å‡¦ç†
  function restoreFromShareURL() {
    const params = new URLSearchParams(window.location.search);
    const sharedData = params.get("share");
    if (sharedData) {
      try {
        selectedMenus = JSON.parse(decodeURIComponent(sharedData));
        renderSelectedList();
        alert("å…±æœ‰ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
      } catch (e) {
        console.error(e);
        alert("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }
  }

  // âœ… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å¾©å…ƒ
  window.addEventListener("DOMContentLoaded", restoreFromShareURL);

  // âœ… QRã‚³ãƒ¼ãƒ‰å¯¾å¿œ å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  async function showSharePreview() {
    // â–¼â–¼â–¼ ä½œæˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã“ã“ã§ã‚¹ãƒˆãƒƒãƒ— â–¼â–¼â–¼
    if (!isProgramGenerated) {
       alert("å…ˆã«ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å†…å®¹ã‚’ç¢ºå®šã•ã›ã¦ãã ã•ã„ã€‚\nPlease click the â€œCreate Programâ€ button first to confirm the contents.");
        return;
    }

    if (!selectedMenus.length) {
        alert("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚‚å¼·åˆ¶çš„ã«è¡¨ç¤º
    const previewDiv = document.getElementById("share-preview");
    previewDiv.style.display = "block";

    const { name, purpose } = generateProgramInfo();
    editableName = name;
    editablePurpose = purpose;

    const startInput = document.getElementById("start-time")?.value || "00:00";
    let [startHour, startMin] = startInput.split(":").map(v => parseInt(v) || 0);
    let currentTime = startHour * 60 + startMin;

    const formatTime = (min) => {
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h}:${m.toString().padStart(2, "0")}`;
    };

    const mainCategories = [
    "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ©ãƒªãƒ¼ç³»", "ãƒãƒƒã‚¯ç³»", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "è£œå¼·", 
    "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "æ–°è¦ä½œæˆ",
    // â–¼ è¿½åŠ  â–¼
    "ã‚²ãƒ¼ãƒ ", "ãƒãƒƒã‚¯", "ãƒ©ãƒªãƒ¼",
    // â–² è¿½åŠ  â–²
    "Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength", 
    "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice",
    // â–¼ è¿½åŠ  â–¼
    "Game"
    // â–² è¿½åŠ  â–²
];
    const mainList = selectedMenus.filter(m => mainCategories.includes(m.category));

    let rows = "";
    for (const main of mainList) {
        const start = formatTime(currentTime);
        const duration = (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(main.category)) ? 0 : (main.time || 0);
        currentTime += duration;
        const end = formatTime(currentTime);

        let urlHtml = "";
        if (main.url) {
            try {
                const cleanUrl = main.url.trim().replace(/\s+/g, "");
                const tempDiv = document.createElement("div");
                new QRCode(tempDiv, { text: cleanUrl, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.L });
                const canvas = tempDiv.querySelector("canvas");
                if (canvas) {
                    const qrDataUrl = canvas.toDataURL("image/png");
                    urlHtml = `<a href="${cleanUrl}" target="_blank"><img src="${qrDataUrl}" width="80" height="80" alt="QR"></a>`;
                }
            } catch (e) { console.error(e); }
        }

        rows += `
            <tr>
                <td>${start}â€“${end}</td>
                <td>[${main.category}] ${main.name}${duration ? `ï¼ˆ${duration}åˆ†ï¼‰` : ""}</td>
                <td style="text-align:left; vertical-align:top; white-space:pre-wrap; word-break:break-word;">${(main.note || "").replace(/\n/g, "<br>")}</td>
                <td>${urlHtml}</td>
            </tr>`;
    }

    const totalTimeFixed = selectedMenus.reduce((sum, m) => {
        if (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(m.category)) return sum;
        return sum + (m.time || 0);
    }, 0);

    const html = `
        <div style="font-family:'Noto Sans JP',sans-serif; color:#333;">
            <h3 style="color:#00796b;"> ãƒ—ãƒ­ã‚°ãƒ©ãƒ åï¼š${editableName}</h3>
            <p><b> ç›®çš„ï¼š</b>${editablePurpose}</p>
            <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; text-align:center; font-size:13px;">
                <thead style="background:#e0f7fa;">
                    <tr><th>æ™‚é–“</th><th>ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</th><th>è£œè¶³èª¬æ˜</th><th>YouTubeï¼ˆQRï¼‰</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            <p style="margin-top:10px;"><b>ğŸ•’ ç·æ™‚é–“ï¼š</b>${totalTimeFixed}åˆ†</p>
        </div>`;

    previewDiv.innerHTML = html;
}

</script>

<!-- âœ… PNGä¿å­˜æ©Ÿèƒ½ã‚’æœ€å¾Œã«è¿½åŠ  -->
<script>

// â–¼ input ã‚’ div ã«å¤‰æ›ã—ã¦ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹é–¢æ•°
function cloneForExport(element) {
  const cloned = element.cloneNode(true);

  // ã™ã¹ã¦ã® input ã‚’ div ã«ç½®ãæ›ãˆ
  cloned.querySelectorAll("input, textarea").forEach(el => {
    const div = document.createElement("div");
    div.textContent = el.value;

    // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™æ‰¿
    const style = getComputedStyle(el);
    div.style.cssText = style.cssText;

    // html2canvas ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«ä½™ç™½ã¨ line-height ã‚’è£œå¼·
    div.style.padding = "10px 12px";
    div.style.lineHeight = "1.4";
    div.style.minHeight = style.height;
    div.style.whiteSpace = "pre-wrap";

    el.replaceWith(div);
  });

  return cloned;
}


// â–¼ PNGç”Ÿæˆãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ã‚’æ”¹ä¿®ï¼‰
async function downloadElementAsPng(elementId, fileName = "training_program.png") {
  const target = document.getElementById(elementId);
  if (!target || !target.innerHTML.trim()) {
    alert("ä¿å­˜å¯¾è±¡ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nThe target for saving has not been created.");
    return;
  }

  // ğŸ”¥ ã“ã“ã‹ã‚‰é‡è¦ï¼šã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œã‚Šã€inputå‰Šé™¤ â†’ DOMå¤–ã«é…ç½®
  const cloned = cloneForExport(target);
  cloned.style.position = "absolute";
  cloned.style.top = "-99999px";
  cloned.style.left = "-99999px";
  document.body.appendChild(cloned);

  try {
    const canvas = await html2canvas(cloned, {
      scale: 2,
      useCORS: true,
      backgroundColor: "#ffffff",
      windowWidth: cloned.scrollWidth,
      windowHeight: cloned.scrollHeight,
    });

    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = fileName;
    link.click();

  } catch (err) {
    console.error("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
    alert("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  } finally {
    cloned.remove(); // â­ä¸è¦ã«ãªã£ãŸã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤
  }
}


// ä½¿ç”¨ä¾‹
document.getElementById("download-program-png").addEventListener("click", () => {
  downloadElementAsPng("program-output");
});

const pdfBtn = document.getElementById("download-program-pdf");
if (pdfBtn) {
    pdfBtn.addEventListener("click", exportPreviewPDF);
}

</script>

<script>
// ==========================================
// ğŸš‘ AIææ¡ˆæ©Ÿèƒ½ï¼ˆGASãƒ‡ãƒ¼ã‚¿é€£æºãƒ»ä¿®æ­£ç‰ˆï¼‰
// ==========================================

// å¤‰æ•°ã®åˆæœŸåŒ–
var suggestedMenusData = [];

// ã‚‚ã—SHEET_URLãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã®äºˆå‚™
const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbxNUGti2mki0Jw0Rfsu0Y1VowtXuZP57ADs2rrgydCI84yUdrhTifTce_TvsTzARptKBg/exec";

// âœ… 1. Gemini APIå‘¼ã³å‡ºã—é–¢æ•° (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆ)
window.analyzeAndSuggest = async function() {
  console.log("ğŸš€ AIãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");  
  
  const text = document.getElementById("free-text").value.trim();
  const output = document.getElementById("ai-suggested");
  const addBtn = document.getElementById("add-ai-menus-btn");

  // åˆæœŸåŒ–
  suggestedMenusData = []; 
  if(addBtn) addBtn.style.display = "none";
  if(output) output.style.display = "block";

  if (!text) {
    output.innerHTML = "âš ï¸ èª²é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  // è§£æä¸­ã®è¡¨ç¤º
  output.innerHTML = '<span style="color:#ff9800">ğŸ”„ Gemini AIãŒã‚·ãƒ¼ãƒˆå†…ã‹ã‚‰æœ€é©ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™â€¦</span>';

  try {
    // URLã®æ±ºå®š
    const targetUrl = (typeof SHEET_URL !== 'undefined') ? SHEET_URL : DEFAULT_GAS_URL;
    
    // APIé€šä¿¡
    const res = await fetch(`${targetUrl}?mode=ai&text=${encodeURIComponent(text)}`);
    const jsonString = await res.text();
    
    let data;
    try {
        data = JSON.parse(jsonString);
    } catch (e) {
        console.error("JSON Parse Error:", jsonString);
        output.innerHTML = `âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>è©³ç´°: ${jsonString.substring(0, 50)}...`;
        return;
    }

    // â–¼â–¼â–¼ ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ & ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ†å² (ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸ) â–¼â–¼â–¼
    if (data.error) {
         console.error("API Error Response:", data.error);
         
         // ã‚¨ãƒ©ãƒ¼æ–‡è¨€ã«ã€Œ429ã€ã‚„ã€Œquotaã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
         if (data.error.includes("429") || data.error.includes("RESOURCE_EXHAUSTED") || data.error.includes("quota")) {
             output.innerHTML = `
                <div style="background:#fff3cd; color:#856404; padding:15px; border-radius:6px; border:1px solid #ffeeba; text-align:left; margin-top:10px;">
                    <h4 style="margin:0 0 10px 0; color:#856404;">âš ï¸ AIã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸ</h4>
                    <p style="font-size:13px; line-height:1.6; margin:0;">
                        ã‚¢ã‚¯ã‚»ã‚¹ãŒé›†ä¸­ã—ã¦ã„ã‚‹ã‹ã€1æ—¥ã®ç„¡æ–™åˆ©ç”¨æ ï¼ˆQuotaï¼‰ã‚’è¶…éã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
                        ä»¥ä¸‹ã®æ‰‹é †ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
                    </p>
                    <ul style="font-size:13px; margin:10px 0 0 0; padding-left:20px;">
                        <li style="margin-bottom:5px;"><b>1åˆ†ã»ã©æ™‚é–“ã‚’ç©ºã‘ã¦ã‹ã‚‰</b>ã€ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</li>
                        <li>ãã‚Œã§ã‚‚æ”¹å–„ã—ãªã„å ´åˆã¯ã€æœ¬æ—¥ã®åˆ©ç”¨ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™ã€‚<b>æ˜æ—¥ã¾ãŸã”åˆ©ç”¨ãã ã•ã„ã€‚</b></li>
                    </ul>
                </div>
             `;
         } else {
             // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ (404ãªã©)
             output.innerHTML = `âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.advice || data.error}`;
         }
         return;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ï¼ˆæ–°ã—ã„GASã®å½¢å¼ã«å¯¾å¿œï¼‰
    let parsedMenus = [];
    let adviceText = "";

    // ãƒ‘ã‚¿ãƒ¼ãƒ³: { advice: "...", suggested_menus: [...] }
    if (data.suggested_menus && Array.isArray(data.suggested_menus)) {
        adviceText = data.advice || "";
        parsedMenus = data.suggested_menus.map(m => ({
            category: m.category || m.step || "AIææ¡ˆ", 
            name: m.name,
            note: m.note || m.reason || "",       
            url: m.url || m.video_url || ""      
        }));
    } 
    // å¤ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå¿µã®ãŸã‚æ®‹ã™ï¼‰
    else if (Array.isArray(data)) {
        data.forEach(group => {
            const catName = group.ã‚«ãƒ†ã‚´ãƒª || "AIææ¡ˆ";
            (group.ãƒ¡ãƒ‹ãƒ¥ãƒ¼ || []).forEach(name => parsedMenus.push({ category: catName, name: name }));
        });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´
    suggestedMenusData = parsedMenus.map(m => ({
        category: m.category,
        name: m.name,
        time: 5, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“
        note: m.note || "",
        url: m.url || ""
    }));

    if (suggestedMenusData.length === 0) {
        output.innerHTML = "âš ï¸ æ¡ä»¶ã«åˆã†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
    }

    // HTMLç”Ÿæˆ
    const adviceHtml = adviceText ? `<div style="background:#fff3e0; padding:10px; margin-bottom:10px; border-radius:4px; font-size:13px; line-height:1.5;">ğŸ’¡ <b>ã‚³ãƒ¼ãƒã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹:</b><br>${adviceText}</div>` : "";

    const listHtml = suggestedMenusData.map((m, i) => {
        return `
            <div style="display: flex; align-items: flex-start; margin-bottom: 8px; padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #ddd;">
                <input type="checkbox" id="ai-chk-${i}" checked style="transform: scale(1.2); margin-top: 5px; margin-right: 10px; cursor: pointer;">
                
                <div style="flex: 1;">
                    <div style="margin-bottom:4px;">
                        <span style="font-size: 11px; color: #fff; background: #00796b; padding: 2px 6px; border-radius: 4px; margin-right: 5px;">${m.category}</span>
                        <span style="font-weight: bold; color: #333;">${m.name}</span>
                    </div>
                    ${m.note ? `<div style="font-size: 12px; color: #666; background:#f5f5f5; padding:4px; border-radius:2px;">POINT: ${m.note}</div>` : ""}
                    ${m.url ? `<a href="${m.url}" target="_blank" style="font-size:11px; color:#1a73e8; display:inline-block; margin-top:2px;">ğŸ“º å‹•ç”»ã‚’ç¢ºèª</a>` : ""}
                </div>

                <div style="margin-left: 8px; text-align:right;">
                    <span style="font-size:11px;">æ™‚é–“</span><br>
                    <input type="number" id="ai-time-${i}" value="5" min="1" style="width: 40px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; text-align:center;">
                </div>
            </div>`;
    }).join('');

    output.innerHTML = `
        <div style="background:#e0f7fa; padding:15px; border-radius:6px; border: 1px solid #b2ebf2;">
            ${adviceHtml}
            <p style="margin:0 0 10px 0; font-weight:bold; color:#00796b;">â–¼ ææ¡ˆã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹æˆ</p>
            <div style="max-height: 400px; overflow-y: auto;">
                ${listHtml}
            </div>
        </div>
    `;

    // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if(addBtn) {
        addBtn.textContent = "âœ… ãƒã‚§ãƒƒã‚¯ã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¸€æ‹¬è¿½åŠ ";
        addBtn.style.display = "block";
        addBtn.onclick = window.addSuggestedMenus; 
    }

  } catch (e) {
    console.error("AI Analyze Error:", e);
    output.innerHTML = `âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>è©³ç´°: ${e.message}`;
  }
};

// âœ… 2. é¸æŠã—ãŸææ¡ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹é–¢æ•°
window.addSuggestedMenus = function() {
    if (!suggestedMenusData || suggestedMenusData.length === 0) return;

    let count = 0;

    suggestedMenusData.forEach((menu, i) => {
        const checkbox = document.getElementById(`ai-chk-${i}`);
        const timeInput = document.getElementById(`ai-time-${i}`);

        // ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ 
        if (checkbox && checkbox.checked) {
            const inputTime = timeInput ? parseFloat(timeInput.value) : 5;

            selectedMenus.push({
                category: menu.category,
                name: menu.name,
                sets: "",
                perSet: 0,
                time: inputTime || 5,
                url: menu.url,
                note: menu.note,
                imgUrl: "" 
            });
            count++;
        }
    });

    if (count === 0) {
        alert("è¿½åŠ ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
        return;
    }

    // ç”»é¢æ›´æ–°
    if (typeof renderSelectedList === 'function') {
        renderSelectedList();
    }
    
    alert(`${count}ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nãƒªã‚¹ãƒˆã®ä¸‹ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
    
    // ã‚¨ãƒªã‚¢ãƒªã‚»ãƒƒãƒˆ
    const output = document.getElementById("ai-suggested");
    const addBtn = document.getElementById("add-ai-menus-btn");
    if(output) output.innerHTML = "";
    if(addBtn) addBtn.style.display = "none";
    suggestedMenusData = [];
};

// âœ… 3. DOMèª­ã¿è¾¼ã¿å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
document.addEventListener("DOMContentLoaded", function() {
    const aiBtn = document.getElementById("ai-suggest-btn");
    if (aiBtn) {
        aiBtn.onclick = window.analyzeAndSuggest;
    }
    const addBtn = document.getElementById("add-ai-menus-btn");
    if (addBtn) {
        addBtn.onclick = window.addSuggestedMenus;
    }
});
</script>

<script>
const templates = {

  "Smart Coach Badminton ä½¿ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«":
    "https://drive.google.com/file/d/15rtpsLn_6BVCEH7N8r18kmIoz8EcCSoB/preview",

  "ã‚¸ãƒ¥ãƒ‹ã‚¢åŸºæœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ":
    "https://drive.google.com/file/d/1VrQnzT5A_w2HutCnF2pMgtawMndCixsV/preview",

  "å¤šäººæ•°ã®ç·´ç¿’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ":
    "https://drive.google.com/file/d/1Rnb1FwQhnizYEeF2Z6SuFYghcU6RbCEc/preview"
};

function applyTemplate() {
  const val = document.getElementById("templateSelect").value;
  const viewer = document.getElementById("templateViewer");

  if (val && templates[val]) {
    viewer.src = templates[val];
    viewer.style.display = "block";
  } else {
    viewer.src = "";
    viewer.style.display = "none";
  }
}

window.addEventListener("DOMContentLoaded", () => {
  const select = document.getElementById("templateSelect");

  Object.keys(templates).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
});

document.getElementById("random-btn").addEventListener("click", async () => {
  if (!sheetData.length) await loadSheet();

  // â–¼ ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§1ã¤ã ã‘å–å¾—ã™ã‚‹
  let selectedCategory = null;

  if (document.getElementById("random-knock").checked) selectedCategory = "ãƒãƒƒã‚¯ç³»";
  if (document.getElementById("random-rally").checked) selectedCategory = "ãƒ©ãƒªãƒ¼ç³»";
  if (document.getElementById("random-strength").checked) selectedCategory = "è£œå¼·";

  if (!selectedCategory) {
    return alert("ã‚«ãƒ†ã‚´ãƒªã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„\nPlease select one category.");
  }

  // â–¼ è©²å½“ã‚«ãƒ†ã‚´ãƒªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã ã‘æŠ½å‡º
  const candidates = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === selectedCategory);
  if (!candidates.length) return alert("è©²å½“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“");

  // â–¼ ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
  const randomMenu = candidates[Math.floor(Math.random() * candidates.length)];

  // â–¼ çµæœã‚’è¡¨ç¤º
  const container = document.getElementById("random-result");
  
  // ä¿®æ­£: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’å«ã‚ãŸHTMLã‚’ç”Ÿæˆï¼ˆposition: relative ã‚’è¦ªã«è¿½åŠ ã—ã€ãƒœã‚¿ãƒ³ã‚’ absolute ã§é…ç½®ï¼‰
  container.innerHTML = `
    <div style="background:#fff; border:1px solid #ccc; border-radius:6px; padding:15px 8px 8px 8px; margin-bottom:5px; position: relative;">
      
      <button id="close-random-result-btn" style="position: absolute; top: 5px; right: 5px; background: #9e9e9e; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; padding: 0;">Ã—</button>

      <strong>${randomMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}</strong>
      <div style="margin-top:5px; font-size:13px; color:#555; background:#fafafa; padding:6px; border-radius:4px;">
        ${randomMenu.èª¬æ˜ || "èª¬æ˜ã¯æº–å‚™ä¸­ã§ã™ã€‚"}
      </div>

      ${(selectedCategory === "ãƒ©ãƒªãƒ¼ç³»" || selectedCategory === "ãƒãƒƒã‚¯ç³»") ? `
        <div style="margin-top:6px;">
          æ™‚é–“ï¼ˆåˆ†ï¼‰: <input type="number" id="menu-time-input"
          value="${randomMenu["å¹³å‡æ™‚é–“ï¼ˆåˆ†ï¼‰"] || ""}" placeholder="5" style="width:50px;">
        </div>
      ` : ""}

      <button id="add-to-list-btn"
        style="margin-top:6px; background:#00796b; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px;">
        é¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ 
      </button>
    </div>

    <div style="background:#f0f0f0; border:1px solid #ccc; border-radius:6px; padding:6px; margin-top:10px;">
      <button id="toggle-purpose-btn"
        style="background:#00796b; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px;">
        ä½¿ç”¨ç”¨é€”ã‚’è¡¨ç¤º
      </button>
      <ul id="usage-list" style="display:none; margin-top:6px; font-size:12px; color:#333; padding-left:18px;">
        <li>è‡ªåˆ†ã§ã¯é¸ã°ãªã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå‡ºã‚‹ã“ã¨ã§æ–°ãŸãªæ°—ã¥ããŒå¾—ã‚‰ã‚Œã‚‹</li>
        <li>æŠ½å‡ºã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ç™ºå±•ç·´ç¿’ã‚’è€ƒãˆã‚‹</li>
        <li>è£œå¼·ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®åã‚Šã‚’ãªãã™</li>
        <li>ä¼è¨€ã‚²ãƒ¼ãƒ ï¼ˆæŠ½å‡ºã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¼ãˆã‚‹ï¼‰ã§èª¬æ˜åŠ›ã‚‚é›ãˆã‚‰ã‚Œã‚‹</li>
        <li>æ¥½ã—ã¿ãªãŒã‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã§ãã‚‹</li>
      </ul>
    </div>
  `;

  // â˜… è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  document.getElementById("close-random-result-btn").addEventListener("click", () => {
    container.innerHTML = ""; // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹
  });

  // â–¼ ä½¿ç”¨ç”¨é€”ã®æŠ˜ã‚ŠãŸãŸã¿
  document.getElementById("toggle-purpose-btn").addEventListener("click", () => {
    const usage = document.getElementById("usage-list");
    usage.style.display = usage.style.display === "none" ? "block" : "none";
  });

  // â–¼ é¸æŠãƒªã‚¹ãƒˆã¸è¿½åŠ 
  document.getElementById("add-to-list-btn").addEventListener("click", () => {
    let inputTime = randomMenu["å¹³å‡æ™‚é–“ï¼ˆåˆ†ï¼‰"] || 5;

    if (selectedCategory === "ãƒ©ãƒªãƒ¼ç³»" || selectedCategory === "ãƒãƒƒã‚¯ç³»") {
      const timeInput = document.getElementById("menu-time-input");
      if (timeInput?.value) {
        inputTime = parseInt(timeInput.value, 10);
      }
    }

    selectedMenus.push({
      category: randomMenu.ã‚«ãƒ†ã‚´ãƒª,
      name: randomMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å,
      sets: "",
      perSet: 0,
      time: inputTime,
      url: randomMenu["YouTube URL"] || "",
      note: randomMenu.èª¬æ˜ || ""
    });

    renderSelectedList();
    alert(`ã€Œ${randomMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}ã€ã‚’é¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
  });
});

let audioCtx;
function playBeep(frequency = 440, duration = 200, type = "sine") {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.type = type;
    osc.frequency.value = frequency;
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    osc.start();
    osc.stop(audioCtx.currentTime + duration / 1000);
}

// ã‚¹ãƒãƒ¼ãƒ„ç”¨å¤ªé¼“ï¼‹ä¸­é«˜éŸ³1ç§’
function playSportsDrum() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = audioCtx.currentTime;

    // å¤ªé¼“ä½éŸ³éƒ¨åˆ†ï¼ˆãƒ‘ãƒ³ãƒæ„Ÿï¼‰
    const drumOsc = audioCtx.createOscillator();
    const drumGain = audioCtx.createGain();
    drumOsc.type = "triangle";
    drumOsc.frequency.setValueAtTime(120, now);
    drumOsc.frequency.exponentialRampToValueAtTime(70, now + 0.3);
    drumGain.gain.setValueAtTime(0.8, now);
    drumGain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    drumOsc.connect(drumGain);
    drumGain.connect(audioCtx.destination);
    drumOsc.start(now);
    drumOsc.stop(now + 0.3);

    // æ˜ã‚‹ã‚ä¸­é«˜éŸ³éƒ¨åˆ†ï¼ˆå±‹å¤–ã§ã‚‚èã“ãˆã‚‹ï¼‰
    const hiOsc = audioCtx.createOscillator();
    const hiGain = audioCtx.createGain();
    hiOsc.type = "sine";
    hiOsc.frequency.setValueAtTime(600, now);
    hiGain.gain.setValueAtTime(0.5, now);
    hiGain.gain.exponentialRampToValueAtTime(0.001, now + 0.7);
    hiOsc.connect(hiGain);
    hiGain.connect(audioCtx.destination);
    hiOsc.start(now);
    hiOsc.stop(now + 0.7);
}

// çµ‚äº†æ™‚ãƒ–ã‚¶ãƒ¼éŸ³
function playBuzz(duration = 1000, frequency = 800) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "square";
    osc.frequency.setValueAtTime(frequency, now);
    gain.gain.setValueAtTime(0.5, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + duration / 1000);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + duration / 1000);
}

let stepCount = 0;
let timerTimeout = null;
let remaining = 0;
let currentSet = 1;
let currentStep = 0;
let steps = [];
let totalSets = 0;

// åˆæœŸã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 
addStep();

// ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById("add-step").addEventListener("click", addStep);
document.getElementById("start-timer").addEventListener("click", () => {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    startTimer();
});
document.getElementById("stop-timer").addEventListener("click", stopTimer);
document.getElementById("reset-timer").addEventListener("click", resetTimer);

function addStep() {
    stepCount++;
    const container = document.getElementById("steps-container");
    const div = document.createElement("div");
    div.innerHTML = `
        <input type="number" class="step-input" id="step-${stepCount}" placeholder="ç§’æ•°">
        <button type="button" onclick="this.parentElement.remove()">å‰Šé™¤</button>
    `;
    container.appendChild(div);
}

function startTimer() {
    if (timerTimeout) return;
    steps = [];
    document.querySelectorAll(".step-input").forEach(input => {
        if (input.value && input.value > 0) steps.push(parseInt(input.value));
    });
    totalSets = parseInt(document.getElementById("set-count").value);
    if (!steps.length) return alert("ã‚¹ãƒ†ãƒƒãƒ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nPlease enter the step.");

    currentSet = 1;
    currentStep = 0;

    nextStep();
}

function nextStep() {
    if (currentStep >= steps.length) {
        // ç¾åœ¨ã®ã‚»ãƒƒãƒˆçµ‚äº†
        playBuzz(800, 800); // ã‚»ãƒƒãƒˆçµ‚äº†ãƒ–ã‚¶ãƒ¼

        currentSet++;
        currentStep = 0;

        if (currentSet > totalSets) {
            document.getElementById("time-left").textContent = "çµ‚äº†";
            timerTimeout = null;
            // æœ€çµ‚çµ‚äº†éŸ³ï¼ˆãƒ–ã‚¶ãƒ¼ï¼‰
            playBuzz(1000, 1000);
            return;
        }

        document.getElementById("current-set").textContent = `Set ${currentSet} / ${totalSets}`;
        // ã‚»ãƒƒãƒˆé–‹å§‹éŸ³
        playSportsDrum();
    }

    remaining = steps[currentStep];
    document.getElementById("current-set").textContent = `Set ${currentSet} / ${totalSets}`;
    document.getElementById("step-info").textContent = `Step ${currentStep + 1}`;
    // ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹éŸ³
    playSportsDrum();

    timerTimeout = setTimeout(stepTick, 1000);
}

function stepTick() {
    remaining--;
    document.getElementById("time-left").textContent = formatTime(remaining);

    if (remaining > 0) {
        timerTimeout = setTimeout(stepTick, 1000);
    } else {
        currentStep++;
        nextStep();
    }
}

function stopTimer() {
    if (timerTimeout) {
        clearTimeout(timerTimeout);
        timerTimeout = null;
    }
}


function resetTimer() {
    stopTimer();
    currentSet = 1;
    currentStep = 0;
    remaining = 0;
    document.getElementById("time-left").textContent = "00:00";
    document.getElementById("current-set").textContent = `Set 1 / ${totalSets || 1}`;
    document.getElementById("step-info").textContent = "Step 1";
}

function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
</script>

<script>
// ============================================================
// âœ… è‹±èªãƒ•ãƒ¬ãƒ¼ã‚ºæ©Ÿèƒ½
// ============================================================

let allPhrases = [];  // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
let speechRate = 1.0; // èª­ã¿ä¸Šã’é€Ÿåº¦

// ------------------------------------------------
// 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸåŒ–ï¼‰
// ------------------------------------------------
async function loadEnglishPhrases() {
    const loadingEl = document.getElementById("english-loading");
    
    try {
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        // â€» SHEET_URL ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æã§ã™
        const res = await fetch(SHEET_URL + "?sheet=English");
        const data = await res.json();

        if (data.error) {
            throw new Error("English sheet not found");
        }

        allPhrases = data;
        loadingEl.style.display = "none";
        
        // åˆæœŸçŠ¶æ…‹ï¼šãƒªã‚¹ãƒˆã¯é–‰ã˜ã¦ãŠãï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼‰
        closeEnglishList();

    } catch (error) {
        console.error("English Load Error:", error);
        loadingEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        loadingEl.style.color = "red";
    }
}

// ------------------------------------------------
// 2. ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹ï¼ˆåˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼‰
// ------------------------------------------------
function closeEnglishList() {
    // ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æˆ»ã™
    const listEl = document.getElementById("phrase-list");
    if(listEl) {
        listEl.innerHTML = 
            `<p style="text-align:center; color:#666; padding: 20px; background:#f9f9f9; border-radius:8px; margin-top: 10px;">
                ğŸ‘† ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„
             </p>`;
    }

    // ãƒœã‚¿ãƒ³ã®è‰²ã‚’ã™ã¹ã¦æœªé¸æŠï¼ˆç™½ï¼‰ã«æˆ»ã™
    const tabs = document.querySelectorAll(".phrase-tab");
    tabs.forEach(btn => {
        btn.style.background = "#fff";
        btn.style.border = "1px solid #ccc";
        btn.style.color = "#666";
        btn.style.fontWeight = "normal";
    });
}

// ------------------------------------------------
// 3. ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
// ------------------------------------------------
function filterPhrases(category) {
    // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (!allPhrases || allPhrases.length === 0) return;

    // ã‚¿ãƒ–ã®ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ
    const tabs = document.querySelectorAll(".phrase-tab");
    tabs.forEach(btn => {
        // onclickå±æ€§ã«ã‚«ãƒ†ã‚´ãƒªåãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã§åˆ¤å®š
        if (btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(category)) {
            btn.style.background = "#e8eaf6";
            btn.style.border = "2px solid #3f51b5";
            btn.style.color = "#3f51b5";
            btn.style.fontWeight = "bold";
        } else {
            btn.style.background = "#fff";
            btn.style.border = "1px solid #ccc";
            btn.style.color = "#666";
            btn.style.fontWeight = "normal";
        }
    });

    const listEl = document.getElementById("phrase-list");
    const filtered = allPhrases.filter(p => p.category === category);

    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
    if (filtered.length === 0) {
        listEl.innerHTML = `
            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="closeEnglishList()" style="background: #9e9e9e; color: white; border: none; border-radius: 4px; padding: 4px 12px; cursor: pointer; font-size: 12px;">Ã— é–‰ã˜ã‚‹</button>
            </div>
            <p style="text-align:center; color:#777; padding:20px;">ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚·ãƒ¼ãƒˆã«ã‚«ãƒ†ã‚´ãƒªå(practice/coaching/communication)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        `;
        return;
    }

    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®HTML
    const closeBtnHtml = `
        <div style="text-align: right; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; position: sticky; top: 0; background: #fff; z-index: 10;">
            <button onclick="closeEnglishList()" style="background: #757575; color: white; border: none; border-radius: 4px; padding: 5px 15px; cursor: pointer; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                Ã— ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
            </button>
        </div>
    `;

    // ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
    let html = filtered.map(item => {
        // ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        let enRaw = item.en ? item.en.toString() : "";
        enRaw = enRaw.replace(/â€™/g, "'");     // ã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ãƒˆå¤‰æ›
        enRaw = enRaw.replace(/[\r\n]+/g, " "); // æ”¹è¡Œå‰Šé™¤
        const enText = enRaw.trim();
        
        const jaText = item.ja || "";
        const noteText = item.note || "";

        // URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒã‚¹ãƒˆãƒ­ãƒ•ã‚£å¯¾ç­–å«ã‚€ï¼‰
        const safeEncodedText = encodeURIComponent(enText).replace(/'/g, "%27");

        // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆè‹±èªãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
        const speakerButton = enText 
            ? `<button onclick="speakText('${safeEncodedText}', 'en-US')" 
                    style="flex-shrink: 0; background: #3f51b5; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s;" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                    ğŸ”Š
               </button>`
            : `<div style="width:44px; height:44px;"></div>`;

        return `
            <div style="display: flex; align-items: center; justify-content: space-between; background: #fafafa; margin-bottom: 8px; padding: 12px; border-radius: 8px; border-left: 4px solid #ddd; transition: background 0.2s;" onmouseover="this.style.background='#f0f4c3'" onmouseout="this.style.background='#fafafa'">
                <div style="flex: 1; padding-right:10px;">
                    <p style="margin: 0; font-size:16px; font-weight: bold; color: #333; font-family: sans-serif;">${enText}</p>
                    <p style="margin: 4px 0 0; font-size: 13px; color: #666;">
                        ${jaText} ${noteText ? `<span style="font-size:11px; background:#e0e0e0; color:#444; padding:1px 5px; border-radius:4px; margin-left:6px;">${noteText}</span>` : ""}
                    </p>
                </div>
                ${speakerButton}
            </div>
        `;
    }).join("");

    listEl.innerHTML = closeBtnHtml + html;
}

// ------------------------------------------------
// 4. éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆé€Ÿåº¦èª¿æ•´ãƒ»ã‚¨ãƒ©ãƒ¼å¯¾ç­–æ¸ˆã¿ï¼‰
// ------------------------------------------------
function speakText(encodedText, lang = 'en-US') {
    window.speechSynthesis.cancel(); // å‰ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    
    let text = decodeURIComponent(encodedText);
    if (!text) return;

    // â–¼â–¼â–¼ ä¿®æ­£: [ ] ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ï¼ˆã‚«ãƒ†ã‚´ãƒªåï¼‰ã‚’å‰Šé™¤ã™ã‚‹ â–¼â–¼â–¼
    // æ­£è¦è¡¨ç¾: [ä»»æ„ã®æ–‡å­—] ã‚’ç©ºæ–‡å­—ã«ç½®æ›
    text = text.replace(/\[.*?\]/g, "").trim();
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    if (!('speechSynthesis' in window)) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = speechRate; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ä½¿ç”¨

    // æœ€é©ãªãƒœã‚¤ã‚¹ã‚’é¸æŠ
    const voices = window.speechSynthesis.getVoices();
    const targetVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) 
                      || voices.find(v => v.lang === 'en-US')
                      || voices.find(v => v.lang.startsWith('en'));

    if (targetVoice) utterance.voice = targetVoice;

    // å°‘ã—é…å»¶ã•ã›ã¦å®‰å®šå†ç”Ÿ
    setTimeout(() => {
        window.speechSynthesis.speak(utterance);
    }, 10);
}

// ------------------------------------------------
// 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
// ------------------------------------------------
document.addEventListener("DOMContentLoaded", () => {
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
    loadEnglishPhrases();

    // é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ç›£è¦–
    const slider = document.getElementById("speech-rate");
    if(slider) {
        slider.addEventListener("input", (e) => {
            speechRate = parseFloat(e.target.value);
            const rateVal = document.getElementById("rate-value");
            if(rateVal) rateVal.textContent = speechRate.toFixed(1);
        });
    }

    // ãƒœã‚¤ã‚¹ãƒªã‚¹ãƒˆã®äº‹å‰ãƒ­ãƒ¼ãƒ‰
    window.speechSynthesis.getVoices();
});


// ===========================
// âœ… ã‚¯ã‚¤ã‚º & ãƒªã‚¹ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½
// ===========================

let quizData = [];       
let currentQuizList = []; 
let currentQuizIndex = 0;
let quizScore = 0;
let currentMode = 'normal'; // 'normal' or 'listening'

// 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆå…±é€šï¼‰
async function loadQuizData() {
    const qStatus = document.getElementById("quiz-status-msg");
    const lStatus = document.getElementById("listening-status-msg");
    const qBtn = document.getElementById("start-quiz-btn");
    const lBtn = document.getElementById("start-listening-btn");
    
    // ä¸¡æ–¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    if(qStatus) qStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";
    if(lStatus) lStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";

    try {
        const res = await fetch(SHEET_URL + "?sheet=Quiz&t=" + new Date().getTime());
        const data = await res.json();

        if (data.error || !data.length) {
            throw new Error(data.error || "ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");
        }

        quizData = data;
        const msg = `æº–å‚™å®Œäº† (å…¨${quizData.length}å•)`;
        
        if(qStatus) qStatus.textContent = msg;
        if(lStatus) lStatus.textContent = msg;
        
        if(qBtn) { qBtn.disabled = false; qBtn.style.opacity = "1"; }
        if(lBtn) { lBtn.disabled = false; lBtn.style.opacity = "1"; }

    } catch (error) {
        console.error("Quiz Load Error:", error);
        const errMsg = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼";
        if(qStatus) qStatus.textContent = errMsg;
        if(lStatus) lStatus.textContent = errMsg;
    }
}

// 2. é–‹å§‹å‡¦ç†ï¼ˆãƒ¢ãƒ¼ãƒ‰æŒ‡å®šï¼‰
function startQuiz(mode = 'normal') {
    if (quizData.length === 0) return;
    currentMode = mode;
    quizScore = 0;
    currentQuizIndex = 0;

    // ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    const shuffled = [...quizData].sort(() => 0.5 - Math.random());
    currentQuizList = shuffled.slice(0, 5);

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    if (currentMode === 'normal') {
        document.getElementById("quiz-start-screen").style.display = "none";
        document.getElementById("quiz-result-screen").style.display = "none";
        document.getElementById("quiz-play-screen").style.display = "block";
    } else {
        document.getElementById("listening-start-screen").style.display = "none";
        document.getElementById("listening-result-screen").style.display = "none";
        document.getElementById("listening-play-screen").style.display = "block";
    }

    showQuestion();
}

// 3. å•é¡Œè¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ†å²ï¼‰
function showQuestion() {
    const q = currentQuizList[currentQuizIndex];
    const isListening = (currentMode === 'listening');

    // IDã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ±ºå®š (quiz- ã¾ãŸã¯ listening-)
    const prefix = isListening ? "listening-" : "quiz-";

    // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    document.getElementById(prefix + "count").textContent = `Q ${currentQuizIndex + 1} / ${currentQuizList.length}`;
    document.getElementById(prefix + "score").textContent = `Score: ${quizScore}`;
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ã®ãƒªã‚»ãƒƒãƒˆ
    const fbDiv = document.getElementById(prefix + "feedback");
    fbDiv.style.display = "none";

    // â–¼â–¼â–¼ è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†å² â–¼â–¼â–¼
    if (isListening) {
        // --- ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ ---
        // ãƒ†ã‚­ã‚¹ãƒˆã¯è¡¨ç¤ºã›ãšã€å†ç”Ÿãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
        const btn = document.getElementById("listening-speak-btn");
        // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰èª­ã¿ä¸Šã’
        btn.onclick = () => {
             const text = q.question; 
             // è‹±èªã¨ã—ã¦èª­ã¿ä¸Šã’
             speakText(encodeURIComponent(text), 'en-US');
        };
        
        // å•é¡ŒãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰è‡ªå‹•ã§1å›èª­ã¿ä¸Šã’ã‚‹ã¨è¦ªåˆ‡ï¼ˆä»»æ„ï¼‰
        setTimeout(() => btn.click(), 500);

    } else {
        // --- é€šå¸¸ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ ---
        // å•é¡Œæ–‡ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const qContainer = document.getElementById("quiz-question");
        const safeEncodedText = encodeURIComponent(q.question).replace(/'/g, "%27");
        qContainer.innerHTML = `
            <div style="display:flex; align-items:center;">
                <span>${q.question}</span>
                <button onclick="speakText('${safeEncodedText}', 'en-US')" 
                    style="background: #3f51b5; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-left: 10px; font-size: 16px;">
                    ğŸ”Š
                </button>
            </div>
        `;
    }

    // é¸æŠè‚¢ã®ç”Ÿæˆ
    const optionsDiv = document.getElementById(prefix + "options");
    optionsDiv.innerHTML = "";

    const options = [
        { text: q.option1, id: 1 },
        { text: q.option2, id: 2 },
        { text: q.option3, id: 3 },
        { text: q.option4, id: 4 }
    ];

    options.forEach(opt => {
        if (!opt.text) return;
        const btn = document.createElement("button");
        btn.textContent = opt.text;
        
        // ãƒ‡ã‚¶ã‚¤ãƒ³
        btn.style.cssText = `
            padding: 12px; border: 2px solid #ddd; background: #fff; 
            color: #333; 
            border-radius: 6px; cursor: pointer; font-size: 14px; text-align: left;
            transition: all 0.2s;
        `;

        btn.onclick = () => checkAnswer(opt.id, q.answer, q.explanation, btn);
        optionsDiv.appendChild(btn);
    });
}

// 4. æ­£èª¤åˆ¤å®š
function checkAnswer(selectedId, correctId, explanation, btnElement) {
    const isListening = (currentMode === 'listening');
    const prefix = isListening ? "listening-" : "quiz-";

    // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
    const allBtns = document.querySelectorAll(`#${prefix}options button`);
    allBtns.forEach(b => b.disabled = true);

    const isCorrect = (parseInt(selectedId) === parseInt(correctId));
    
    if (isCorrect) {
        btnElement.style.background = "#d4edda";
        btnElement.style.borderColor = "#28a745";
        btnElement.textContent += " â­•";
        quizScore++;
        if(typeof playSportsDrum === 'function') playSportsDrum(); 
    } else {
        btnElement.style.background = "#f8d7da";
        btnElement.style.borderColor = "#dc3545";
        btnElement.textContent += " âŒ";
        // æ­£è§£ã‚’è¡¨ç¤º
        allBtns[parseInt(correctId) - 1].style.background = "#d4edda";
        allBtns[parseInt(correctId) - 1].textContent += " (æ­£è§£)";
        if(typeof playBuzz === 'function') playBuzz(300, 200); 
    }

    // è§£èª¬è¡¨ç¤º
    const fbDiv = document.getElementById(prefix + "feedback");
    const fbTitle = document.getElementById(prefix + "feedback-title");
    const fbText = document.getElementById(prefix + "feedback-text");

    fbDiv.style.display = "block";
    fbDiv.style.background = isCorrect ? "#e8f5e9" : "#ffebee";
    fbTitle.textContent = isCorrect ? "æ­£è§£ï¼" : "æ®‹å¿µ...";
    fbTitle.style.color = isCorrect ? "green" : "red";
    
    // ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã®å ´åˆã¯ã€ã“ã“ã§åˆã‚ã¦å•é¡Œæ–‡ã‚’è¦‹ã›ã‚‹ã¨å­¦ç¿’åŠ¹æœãŒé«˜ã„
    let feedbackContent = explanation || "";
    if (isListening) {
        feedbackContent = `ã€å•é¡Œæ–‡ã€‘${currentQuizList[currentQuizIndex].question}\n\n${feedbackContent}`;
    }
    
    fbText.innerText = feedbackContent; // innerTextã§æ”¹è¡Œåæ˜ 
}

// 5. æ¬¡ã¸
function nextQuestion() {
    currentQuizIndex++;
    if (currentQuizIndex < currentQuizList.length) {
        showQuestion();
    } else {
        showResult();
    }
}

// 6. çµæœè¡¨ç¤º
function showResult() {
    const isListening = (currentMode === 'listening');
    const prefix = isListening ? "listening-" : "quiz-";

    document.getElementById(prefix + "play-screen").style.display = "none";
    document.getElementById(prefix + "result-screen").style.display = "block";
    
    const scoreText = document.getElementById(prefix + "final-score");
    scoreText.textContent = `${currentQuizList.length}å•ä¸­ ${quizScore}å•æ­£è§£ï¼`;
    
    if (quizScore === currentQuizList.length && typeof playSportsDrum === 'function') {
        playSportsDrum();
    }
}
</script>

<script>
// ===========================
// âœ… è‹±èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ===========================
function switchTab(tabName) {
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ ã®å–å¾—
    const phrasesContent = document.getElementById("content-phrases");
    const quizContent = document.getElementById("content-quiz");
    const listeningContent = document.getElementById("content-listening");
    
    // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿
    if (!phrasesContent || !quizContent || !listeningContent) {
        console.error("Tab content elements not found!");
        return;
    }

    // ãƒœã‚¿ãƒ³è¦ç´ ã®å–å¾—
    const phrasesBtn = document.getElementById("tab-btn-phrases");
    const quizBtn = document.getElementById("tab-btn-quiz");
    const listeningBtn = document.getElementById("tab-btn-listening");

    // å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    phrasesContent.style.display = 'none';
    quizContent.style.display = 'none';
    listeningContent.style.display = 'none';
    
    // â–¼â–¼â–¼ ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ç”¨é–¢æ•°ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸çµ±ä¸€ï¼‰ â–¼â–¼â–¼
    const updateBtnStyle = (btn, isActive) => {
        if (!btn) return; 
        if (isActive) {
            // é¸æŠä¸­ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ï¼šç™½èƒŒæ™¯ Ã— æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸æ–‡å­—
            btn.style.background = "#fff";
            btn.style.color = "#e65100"; 
            btn.style.fontWeight = "bold";
            btn.style.borderBottom = "none"; // ä¸‹ç·šã‚’æ¶ˆã—ã¦ä¸€ä½“æ„Ÿã‚’å‡ºã™ï¼ˆä»»æ„ï¼‰
        } else {
            // éé¸æŠï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ï¼šè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ Ã— èŒ¶è‰²ã£ã½ã„æ–‡å­—
            btn.style.background = "#ffe0b2"; 
            btn.style.color = "#8d6e63"; 
            btn.style.fontWeight = "normal";
            btn.style.borderBottom = "1px solid #ffe0b2";
        }
    };

    // å„ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°ï¼ˆå…¨ã¦åŒã˜ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§çµ±ä¸€ï¼‰
    updateBtnStyle(phrasesBtn, tabName === 'phrases'); 
    updateBtnStyle(quizBtn, tabName === 'quiz');       
    updateBtnStyle(listeningBtn, tabName === 'listening'); 

    // é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã ã‘è¡¨ç¤º
    if (tabName === 'phrases') {
        phrasesContent.style.display = "block";
    } else if (tabName === 'quiz') {
        quizContent.style.display = "block";
    } else if (tabName === 'listening') {
        listeningContent.style.display = "block";
    }
}

// ==========================================
// âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½ (ã‚³ãƒ¼ãƒˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œç‰ˆ)
// ==========================================

let tacticCanvas, tCtx;
let tacticMode = "move"; 
let isDraggingTactic = false;
let isDrawingTactic = false;
let selectedTacticObj = null;

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
let tacticObjects = []; 
let tacticLines = [];   
let tacticArrows = [];  
let tacticTexts = [];   

// ä½œæ¥­ç”¨
let currentLine = null;
let arrowStartPos = null;
let arrowEndPos = null;

// --- ã‚³ãƒ¼ãƒˆé–‹é–‰æ©Ÿèƒ½ ---
function toggleTacticsCourt() {
    const area = document.getElementById("tactics-court-area");
    const icon = document.getElementById("court-toggle-icon");
    const textEl = document.getElementById("court-toggle-text");
    const t = translations[currentLang]; // ç¾åœ¨ã®è¨€èªè¨­å®šã‚’å–å¾—

    if (!area) return;

    if (area.style.display === "none" || area.style.display === "") {
        // é–‹ã
        area.style.display = "block";
        if (icon) icon.textContent = "â–²";
        if (textEl) textEl.textContent = t.btnHideCourt; // "ã‚³ãƒ¼ãƒˆã‚’éš ã™" / "Hide Court"
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹å†æç”»
        if (typeof drawTacticsBoard === "function") {
            requestAnimationFrame(() => {
                drawTacticsBoard();
            });
        }
    } else {
        // é–‰ã˜ã‚‹
        area.style.display = "none";
        if (icon) icon.textContent = "â–¼";
        if (textEl) textEl.textContent = t.btnShowCourt; // "ã‚³ãƒ¼ãƒˆã‚’è¡¨ç¤º" / "Show Court"
    }
}

// åˆæœŸåŒ–
function initTacticsBoard() {
    tacticCanvas = document.getElementById("tacticsCanvas");
    if(!tacticCanvas) return;
    
    tCtx = tacticCanvas.getContext("2d");
    
    if (tacticObjects.length === 0) {
        resetTacticPositions(); 
    } else {
        drawTacticsBoard();
    }
    
    const events = ["mousedown", "mousemove", "mouseup", "mouseout", "touchstart", "touchmove", "touchend"];
    const handlers = [handleTacticStart, handleTacticMove, handleTacticEnd, handleTacticEnd, handleTacticStart, handleTacticMove, handleTacticEnd];
    
    events.forEach((ev, i) => {
        tacticCanvas.removeEventListener(ev, handlers[i]);
        tacticCanvas.addEventListener(ev, handlers[i], { passive: false });
    });
}

// ===========================
// âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰å†…ï¼šã‚³ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®é–‹é–‰æ©Ÿèƒ½
// ===========================
function toggleTacticsCourt() {
    const area = document.getElementById("tactics-court-area");
    const icon = document.getElementById("court-toggle-icon"); // æ‰‹é †1ã§å¤‰æ›´ã—ãŸID
    
    if (!area) return;

    if (area.style.display === "none" || area.style.display === "") {
        // é–‹ãå‡¦ç†
        area.style.display = "block";
        if (icon) icon.textContent = "â–²";
        
        // â˜…é‡è¦: ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºå´©ã‚Œã‚’é˜²ããŸã‚å†æç”»
        if (typeof drawTacticsBoard === "function") {
            requestAnimationFrame(() => {
                drawTacticsBoard();
            });
        }
    } else {
        // é–‰ã˜ã‚‹å‡¦ç†
        area.style.display = "none";
        if (icon) icon.textContent = "â–¼";
    }
}

// ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ç®¡ç†å¤‰æ•° ('doubles' or 'singles')
let currentTacticMode = 'doubles';

// â–¼â–¼â–¼ 1. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿é–¢æ•° (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼
function switchGameMode(mode) {
    currentTacticMode = mode;

    const customSettings = document.getElementById("custom-tactic-settings");
    const fixedInputs = document.getElementById("fixed-name-inputs");
    
    // å¤‰å‰‡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
    if (mode === 'custom') {
        if(customSettings) customSettings.style.display = "flex";
        if(fixedInputs) fixedInputs.style.display = "none";
    } 
    // ãƒ€ãƒ–ãƒ«ã‚¹ãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã®å ´åˆ
    else {
        if(customSettings) customSettings.style.display = "none";
        if(fixedInputs) fixedInputs.style.display = "flex";

        // ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãªã‚‰Bã¨Yã®å…¥åŠ›ã‚’éš ã™
        const displayStyle = (mode === 'singles') ? 'none' : 'inline-block';
        const containerB = document.getElementById("container-name-B");
        const containerY = document.getElementById("container-name-Y");
        
        if(containerB) containerB.style.display = displayStyle;
        if(containerY) containerY.style.display = displayStyle;
    }

    // ã‚³ãƒã‚’å†é…ç½®
    resetTacticPositions();
}

// 2. ã‚³ãƒã®é…ç½®ãƒªã‚»ãƒƒãƒˆ
function resetTacticPositions() {
    tacticObjects = []; // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ

    if (currentTacticMode === 'custom') {
        // --- å¤‰å‰‡ãƒ¢ãƒ¼ãƒ‰ (è‡ªç”±äººæ•°) ---
        const redCount = parseInt(document.getElementById("custom-red-count").value) || 1;
        const blueCount = parseInt(document.getElementById("custom-blue-count").value) || 1;

        // èµ¤ãƒãƒ¼ãƒ  (æ‰‹å‰ y=400) ã‚’æ¨ªã«ä¸¦ã¹ã‚‹
        const redStartX = 400 / (redCount + 1);
        for (let i = 0; i < redCount; i++) {
            tacticObjects.push({
                id: `R${i}`,
                x: redStartX * (i + 1),
                y: 400,
                color: "red",
                label: (i + 1).toString(), // æ•°å­—ã‚’è¡¨ç¤º
                radius: 15
            });
        }

        // é’ãƒãƒ¼ãƒ  (å¥¥ y=150) ã‚’æ¨ªã«ä¸¦ã¹ã‚‹
        const blueStartX = 400 / (blueCount + 1);
        for (let i = 0; i < blueCount; i++) {
            tacticObjects.push({
                id: `B${i}`,
                x: blueStartX * (i + 1),
                y: 150,
                color: "blue",
                label: (i + 1).toString(), // æ•°å­—ã‚’è¡¨ç¤º
                radius: 15
            });
        }

    } else {
        // --- æ—¢å­˜ã®å›ºå®šãƒ¢ãƒ¼ãƒ‰ (åå‰å…¥åŠ›ã‚ã‚Š) ---
        const nameA = document.getElementById("input-name-A") ? document.getElementById("input-name-A").value : "A";
        const nameB = document.getElementById("input-name-B") ? document.getElementById("input-name-B").value : "B";
        const nameX = document.getElementById("input-name-X") ? document.getElementById("input-name-X").value : "X";
        const nameY = document.getElementById("input-name-Y") ? document.getElementById("input-name-Y").value : "Y";

        if (currentTacticMode === 'singles') {
            // ã‚·ãƒ³ã‚°ãƒ«ã‚¹é…ç½®
            tacticObjects = [
                { id: "A", x: 200, y: 400, color: "red", label: nameA || "A", radius: 15 },
                { id: "X", x: 200, y: 150, color: "blue", label: nameX || "X", radius: 15 }
            ];
        } else {
            // ãƒ€ãƒ–ãƒ«ã‚¹é…ç½®
            tacticObjects = [
                { id: "A", x: 100, y: 400, color: "red", label: nameA || "A", radius: 15 },
                { id: "B", x: 300, y: 400, color: "red", label: nameB || "B", radius: 15 },
                { id: "X", x: 100, y: 150, color: "blue", label: nameX || "X", radius: 15 },
                { id: "Y", x: 300, y: 150, color: "blue", label: nameY || "Y", radius: 15 }
            ];
        }
    }
    
    // æç”»æ›´æ–°
    drawTacticsBoard();
}

// â€» updatePlayerLabelsé–¢æ•°ã¯ãã®ã¾ã¾ã§OKã§ã™ãŒã€å¿µã®ãŸã‚å†æ²ã—ã¾ã™ï¼ˆå¤‰æ›´ãªã—ï¼‰
function updatePlayerLabels() {
    const nameA = document.getElementById("input-name-A").value;
    const nameB = document.getElementById("input-name-B").value;
    const nameX = document.getElementById("input-name-X").value;
    const nameY = document.getElementById("input-name-Y").value;

    tacticObjects.forEach(obj => {
        if (obj.id === "A") obj.label = nameA || "A";
        if (obj.id === "B") obj.label = nameB || "B";
        if (obj.id === "X") obj.label = nameX || "X";
        if (obj.id === "Y") obj.label = nameY || "Y";
    });
    drawTacticsBoard();
}

function clearTacticLines() {
    tacticLines = [];
    tacticArrows = [];
    tacticTexts = [];
    drawTacticsBoard();
}

function saveTacticsImage() {
    if (!tacticCanvas) return;
    const image = tacticCanvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = image;
    link.download = "tactics_board.png";
    link.click();
}

function setTacticMode(mode) {
    tacticMode = mode;
    if (!tacticCanvas) return;
    drawTacticsBoard(); // å†æç”»

    if (mode === "move") tacticCanvas.style.cursor = "grab";
    else if (mode === "text") tacticCanvas.style.cursor = "text";
    else if (mode === "eraser") tacticCanvas.style.cursor = "not-allowed";
    else tacticCanvas.style.cursor = "crosshair"; 
}

// ----------------------
// æç”»å‡¦ç†
// ----------------------
function drawTacticsBoard() {
    if(!tCtx) return;
    const W = tacticCanvas.width;
    const H = tacticCanvas.height;

    tCtx.clearRect(0, 0, W, H);

    // èƒŒæ™¯
    tCtx.fillStyle = "#2e7d32";
    tCtx.fillRect(0, 0, W, H);

    // ã‚³ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³
    drawCourtLines();

    // ç·š
    [...tacticLines, currentLine].forEach(line => {
        if (!line || line.points.length < 2) return;
        tCtx.beginPath();
        tCtx.strokeStyle = line.color;
        tCtx.lineWidth = line.width;
        tCtx.lineCap = "round";
        tCtx.moveTo(line.points[0].x, line.points[0].y);
        for (let i = 1; i < line.points.length; i++) tCtx.lineTo(line.points[i].x, line.points[i].y);
        tCtx.stroke();
    });

    // çŸ¢å°
    tCtx.lineWidth = 3;
    tacticArrows.forEach(arrow => {
        if (tacticMode === "move") {
            tCtx.strokeStyle = "rgba(255, 255, 255, 0.4)";
            tCtx.lineWidth = 10; 
            drawArrowPath(arrow.start, arrow.end);
            tCtx.stroke();
        }
        tCtx.strokeStyle = "yellow";
        tCtx.fillStyle = "yellow";
        tCtx.lineWidth = 3;
        drawArrow(arrow.start, arrow.end);
    });
    
    if (tacticMode === "arrow" && isDrawingTactic && arrowStartPos && arrowEndPos) {
        tCtx.strokeStyle = "yellow";
        tCtx.fillStyle = "yellow";
        tCtx.lineWidth = 3;
        drawArrow(arrowStartPos, arrowEndPos);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆ
    tCtx.font = "bold 16px sans-serif";
    tCtx.textAlign = "center";
    tCtx.textBaseline = "middle";
    
    tacticTexts.forEach(t => {
        if (tacticMode === "move") {
            const m = tCtx.measureText(t.text);
            const padding = 10;
            tCtx.fillStyle = "rgba(255, 255, 255, 0.3)";
            tCtx.fillRect(t.x - m.width/2 - padding, t.y - 15, m.width + padding*2, 30);
            tCtx.strokeStyle = "rgba(255, 255, 255, 0.8)";
            tCtx.lineWidth = 1;
            tCtx.strokeRect(t.x - m.width/2 - padding, t.y - 15, m.width + padding*2, 30);
        }
        tCtx.fillStyle = "white";
        tCtx.fillText(t.text, t.x, t.y);
    });

    // ã‚³ãƒ
    tacticObjects.forEach(obj => {
        tCtx.beginPath();
        tCtx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2);
        tCtx.fillStyle = obj.color;
        tCtx.fill();
        tCtx.strokeStyle = "white";
        tCtx.lineWidth = 2;
        tCtx.stroke();
        if (obj.label) {
            tCtx.fillStyle = "white";
            tCtx.font = "bold 14px Arial";
            tCtx.textAlign = "center";
            tCtx.textBaseline = "middle";
            tCtx.fillText(obj.label, obj.x, obj.y);
        }
    });
}

function drawCourtLines() {
    if(!tCtx) return;
    const W = tacticCanvas.width;
    const H = tacticCanvas.height;
    const pad = 20;
    const shortDist = 60;
    const sideDist = 25;
    const backDist = 25;

    tCtx.strokeStyle = "white";
    tCtx.lineWidth = 2;
    tCtx.beginPath();

    tCtx.strokeRect(pad, pad, W - pad * 2, H - pad * 2);
    tCtx.moveTo(pad, H / 2); tCtx.lineTo(W - pad, H / 2);
    tCtx.moveTo(pad, H / 2 - shortDist); tCtx.lineTo(W - pad, H / 2 - shortDist);
    tCtx.moveTo(pad, H / 2 + shortDist); tCtx.lineTo(W - pad, H / 2 + shortDist);
    tCtx.moveTo(W / 2, pad); tCtx.lineTo(W / 2, H / 2 - shortDist);
    tCtx.moveTo(W / 2, H / 2 + shortDist); tCtx.lineTo(W / 2, H - pad);
    tCtx.strokeRect(pad + sideDist, pad, W - (pad + sideDist) * 2, H - pad * 2);
    tCtx.moveTo(pad, pad + backDist); tCtx.lineTo(W - pad, pad + backDist);
    tCtx.moveTo(pad, H - pad - backDist); tCtx.lineTo(W - pad, H - pad - backDist);
    tCtx.stroke();
}

function drawArrowPath(from, to) {
    tCtx.beginPath();
    tCtx.moveTo(from.x, from.y);
    tCtx.lineTo(to.x, to.y);
}

function drawArrow(from, to) {
    const headLength = 15;
    const dx = to.x - from.x;
    const dy = to.y - from.y;
    const angle = Math.atan2(dy, dx);
    tCtx.beginPath();
    tCtx.moveTo(from.x, from.y); tCtx.lineTo(to.x, to.y); tCtx.stroke();
    tCtx.beginPath();
    tCtx.moveTo(to.x, to.y);
    tCtx.lineTo(to.x - headLength * Math.cos(angle - Math.PI / 6), to.y - headLength * Math.sin(angle - Math.PI / 6));
    tCtx.lineTo(to.x - headLength * Math.cos(angle + Math.PI / 6), to.y - headLength * Math.sin(angle + Math.PI / 6));
    tCtx.lineTo(to.x, to.y); tCtx.fill();
}

// ----------------------
// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
// ----------------------
let lastPos = {x:0, y:0};

function getPos(e) {
    const rect = tacticCanvas.getBoundingClientRect();
    let cx = e.clientX, cy = e.clientY;
    if (e.touches && e.touches.length > 0) {
        cx = e.touches[0].clientX; cy = e.touches[0].clientY;
    }
    const scaleX = tacticCanvas.width / rect.width;
    const scaleY = tacticCanvas.height / rect.height;
    return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
}

function getDistanceToSegment(p, v, w) {
    const l2 = (v.x - w.x)**2 + (v.y - w.y)**2;
    if (l2 === 0) return Math.sqrt((p.x - v.x)**2 + (p.y - v.y)**2);
    let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
    t = Math.max(0, Math.min(1, t));
    const proj = { x: v.x + t * (w.x - v.x), y: v.y + t * (w.y - v.y) };
    return Math.sqrt((p.x - proj.x)**2 + (p.y - proj.y)**2);
}

function checkHitObject(pos) {
    // 1. ã‚³ãƒ
    for (let i = tacticObjects.length - 1; i >= 0; i--) {
        const obj = tacticObjects[i];
        if (Math.sqrt((pos.x - obj.x)**2 + (pos.y - obj.y)**2) <= obj.radius + 15) { 
            return { type: 'obj', item: obj };
        }
    }
    // 2. æ–‡å­—
    tCtx.font = "bold 16px sans-serif"; 
    for (let i = tacticTexts.length - 1; i >= 0; i--) {
        const t = tacticTexts[i];
        const metrics = tCtx.measureText(t.text);
        const w = metrics.width;
        const padding = 15;
        if (pos.x >= t.x - w/2 - padding && pos.x <= t.x + w/2 + padding &&
            pos.y >= t.y - 15 - padding && pos.y <= t.y + 15 + padding) {
            return { type: 'text', item: t };
        }
    }
    // 3. çŸ¢å°
    for (let i = tacticArrows.length - 1; i >= 0; i--) {
        const arrow = tacticArrows[i];
        const dist = getDistanceToSegment(pos, arrow.start, arrow.end);
        if (dist < 15) return { type: 'arrow', item: arrow };
    }
    return null;
}

function handleTacticStart(e) {
    e.preventDefault();
    const pos = getPos(e);
    lastPos = pos;

    if (tacticMode === "move") {
        const targetData = checkHitObject(pos);
        if (targetData) {
            isDraggingTactic = true;
            selectedTacticObj = targetData;
            tacticCanvas.style.cursor = "grabbing";
        }
    } else if (tacticMode === "draw") {
        isDrawingTactic = true;
        currentLine = { color: "yellow", width: 3, points: [pos] };
    } else if (tacticMode === "arrow") {
        isDrawingTactic = true;
        arrowStartPos = pos; arrowEndPos = pos;
    } else if (tacticMode === "text") {
        const text = prompt("å…¥åŠ›ã—ãŸã„æ–‡å­—ã‚’å…¥ã‚Œã¦ãã ã•ã„:");
        if (text) {
            tacticTexts.push({ x: pos.x, y: pos.y, text: text });
            tacticMode = "move";
            const moveRadio = document.querySelector('input[name="tactic-mode"][value="move"]');
            if(moveRadio) moveRadio.checked = true;
            setTacticMode("move");
        }
    } else if (tacticMode === "eraser") {
        isDrawingTactic = true;
        eraseObjectAt(pos);
    }
}

function handleTacticMove(e) {
    e.preventDefault();
    const pos = getPos(e);

    if (tacticMode === "move" && !isDraggingTactic) {
        const target = checkHitObject(pos);
        tacticCanvas.style.cursor = target ? "grab" : "default";
    }

    if (!isDraggingTactic && !isDrawingTactic) return;

    if (tacticMode === "move" && selectedTacticObj) {
        const dx = pos.x - lastPos.x;
        const dy = pos.y - lastPos.y;
        const item = selectedTacticObj.item;
        const type = selectedTacticObj.type;

        if (type === 'obj' || type === 'text') {
            item.x += dx;
            item.y += dy;
        } else if (type === 'arrow') {
            item.start.x += dx; item.start.y += dy;
            item.end.x += dx; item.end.y += dy;
        }
        lastPos = pos;
        drawTacticsBoard();

    } else if (tacticMode === "draw" && currentLine) {
        currentLine.points.push(pos);
        drawTacticsBoard();
    } else if (tacticMode === "arrow" && arrowStartPos) {
        arrowEndPos = pos;
        drawTacticsBoard();
    } else if (tacticMode === "eraser") {
        eraseObjectAt(pos);
    }
}

function handleTacticEnd(e) {
    e.preventDefault();
    if (tacticMode === "move") {
        isDraggingTactic = false; selectedTacticObj = null;
        tacticCanvas.style.cursor = "grab"; 
    } else if (tacticMode === "draw") {
        if (currentLine) { tacticLines.push(currentLine); currentLine = null; }
        isDrawingTactic = false;
        drawTacticsBoard();
    } else if (tacticMode === "arrow") {
        if (isDrawingTactic && arrowStartPos && arrowEndPos) {
            tacticArrows.push({ start: arrowStartPos, end: arrowEndPos });
        }
        isDrawingTactic = false;
        arrowStartPos = null; arrowEndPos = null;
        drawTacticsBoard();
    } else if (tacticMode === "eraser") {
        isDrawingTactic = false;
    }
}

function eraseObjectAt(pos) {
    const range = 20;
    let changed = false;
    
    const initLines = tacticLines.length;
    tacticLines = tacticLines.filter(line => !line.points.some(p => Math.sqrt((p.x - pos.x)**2 + (p.y - pos.y)**2) < range));
    if(tacticLines.length !== initLines) changed = true;

    const initArrows = tacticArrows.length;
    tacticArrows = tacticArrows.filter(arrow => {
        return getDistanceToSegment(pos, arrow.start, arrow.end) > 15;
    });
    if(tacticArrows.length !== initArrows) changed = true;

    const initTexts = tacticTexts.length;
    tacticTexts = tacticTexts.filter(t => Math.sqrt((t.x - pos.x)**2 + (t.y - pos.y)**2) > range * 1.5);
    if(tacticTexts.length !== initTexts) changed = true;

    if (changed) drawTacticsBoard();
}

document.addEventListener("DOMContentLoaded", initTacticsBoard);

// ==========================================
// âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰ã®ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜æ©Ÿèƒ½
// ==========================================
function saveTacticsToBrowser() {
    const saveData = {
        objects: tacticObjects,
        lines: tacticLines,
        arrows: tacticArrows,
        texts: tacticTexts,
        timestamp: new Date().toLocaleString()
    };
    localStorage.setItem("smartCoachTactics", JSON.stringify(saveData));
    
    const statusEl = document.getElementById("tactics-local-status");
    if(statusEl) {
        statusEl.textContent = "ä¿å­˜å®Œäº†: " + saveData.timestamp;
        setTimeout(() => { statusEl.textContent = ""; }, 3000);
    }
}

function loadTacticsFromBrowser() {
    const json = localStorage.getItem("smartCoachTactics");
    if (!json) return alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    if (!confirm("ç¾åœ¨ã®å†…å®¹ã‚’ç ´æ£„ã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

    try {
        const data = JSON.parse(json);
        tacticObjects = data.objects || [];
        tacticLines = data.lines || [];
        tacticArrows = data.arrows || [];
        tacticTexts = data.texts || [];
        drawTacticsBoard();
        
        const statusEl = document.getElementById("tactics-local-status");
        if(statusEl) statusEl.textContent = "å¾©å…ƒå®Œäº†";
    } catch (e) {
        console.error(e);
        alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}

function clearTacticsBrowserData() {
    if(confirm("æˆ¦è¡“ãƒœãƒ¼ãƒ‰ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.removeItem("smartCoachTactics");
        const statusEl = document.getElementById("tactics-local-status");
        if(statusEl) {
            statusEl.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
            setTimeout(() => { statusEl.textContent = ""; }, 3000);
        }
    }
}

// ==========================================
// âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰å°‚ç”¨ ç”»åƒä¿å­˜é–¢æ•°
// ==========================================
function saveTacticsImage() {
    const canvas = document.getElementById("tacticsCanvas");
    if (!canvas) return;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”»åƒURLã«å¤‰æ›
    const image = canvas.toDataURL("image/png");

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
    const link = document.createElement("a");
    link.href = image;
    link.download = "tactics_board.png"; // ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
    link.click();
}

// ==========================================
// âœ… è‡ªç”±é…ç½®å‹ã‚³ãƒ¼ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šãƒ»æ•´åˆ—ä¿®æ­£ç‰ˆ)
// ==========================================

let isOrderingMode = false; 
let currentOrderCount = 1; 
let isSelectionMode = false; 
let selectedElements = new Set(); 

// --- æ©Ÿèƒ½ï¼šæŠ˜ã‚ŠãŸãŸã¿ ---
function toggleLayoutBuilder() {
    const content = document.getElementById("layout-builder-content");
    const icon = document.getElementById("layout-toggle-icon");
    if (content.style.display === "none") {
        content.style.display = "block";
        icon.textContent = "â–²";
    } else {
        content.style.display = "none";
        icon.textContent = "â–¼";
    }
}

// 1. åˆæœŸåŒ–ãƒ»ç”Ÿæˆ
function initGymLayout() {
    const floor = document.getElementById("gym-floor");
    const courtCount = parseInt(document.getElementById("init-court-count").value) || 0;
    const playerCount = parseInt(document.getElementById("init-player-count").value) || 0;
    
    const content = document.getElementById("layout-builder-content");
    const icon = document.getElementById("layout-toggle-icon");
    if (content.style.display === "none") {
        content.style.display = "block";
        icon.textContent = "â–²";
    }

    if (floor.children.length > 1 && !confirm("ç¾åœ¨ã®é…ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ")) return;

    floor.innerHTML = ""; 
    currentOrderCount = 1;
    clearSelection(); 

    const note = document.createElement("p");
    note.style.cssText = "position:absolute; top:5px; left:5px; margin:0; font-size:11px; color:#666; pointer-events:none;";
    note.textContent = "ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤";
    floor.appendChild(note);

    for (let i = 0; i < courtCount; i++) {
        createCourt(floor, i);
    }

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ã‚³ãƒ¼ãƒˆã®è¡Œæ•°ã«åˆã‚ã›ã¦ã€é¸æ‰‹ã®ä½ç½®ã¨åºŠã®é«˜ã•ã‚’èª¿æ•´
    const maxCols = 4;
    const rows = Math.ceil(courtCount / maxCols); // ã‚³ãƒ¼ãƒˆã®è¡Œæ•°
    const courtUnitHeight = 300; // ã‚³ãƒ¼ãƒˆé«˜ã•(260) + éš™é–“(40)
    
    // é¸æ‰‹ã‚’é…ç½®ã™ã‚‹Yåº§æ¨™ï¼ˆæœ€å¾Œã®ã‚³ãƒ¼ãƒˆã®ä¸‹ã‚ãŸã‚Šï¼‰
    const playerStartY = 40 + (rows * courtUnitHeight) + 20; 
    
    // åºŠã®æœ€ä½é«˜ã•ã‚’è¨ˆç®—ï¼ˆé¸æ‰‹ã‚¨ãƒªã‚¢åˆ†ã‚‚å«ã‚ã‚‹ï¼‰
    const minHeight = playerStartY + 100;
    floor.style.height = Math.max(400, minHeight) + "px";

    createPlayers(floor, playerCount, playerStartY);
}

function createCourt(container, index) {
    const court = document.createElement("div");
    court.className = "draggable-item gym-court"; 
    
    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: 4ã¤ã”ã¨ã«æ”¹è¡Œã™ã‚‹è¨ˆç®—
    const maxCols = 4; // 1è¡Œã«ä¸¦ã¹ã‚‹æœ€å¤§æ•°ï¼ˆã‚¹ãƒãƒ›ãªã‚‰2ã‚„3ã«æ¸›ã‚‰ã—ã¦ã‚‚OKï¼‰
    const col = index % maxCols;            // åˆ—ç•ªå· (0, 1, 2, 3)
    const row = Math.floor(index / maxCols); // è¡Œç•ªå· (0, 1...)

    const courtWidth = 200;
    const courtHeight = 260;
    const gapX = 40; // æ¨ªã®é–“éš” (240pxãƒ”ãƒƒãƒ)
    const gapY = 40; // ç¸¦ã®é–“éš”

    // åº§æ¨™è¨ˆç®—
    const left = 20 + (col * (courtWidth + gapX)); 
    const top = 40 + (row * (courtHeight + gapY)); 

    court.style.cssText = `
        position: absolute;
        top: ${top}px;
        left: ${left}px;
        width: ${courtWidth}px;
        height: ${courtHeight}px;
        background: #2e7d32;
        border: 2px solid white;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        cursor: grab;
        z-index: 1;
        touch-action: none;
    `;

    const net = document.createElement("div");
    net.style.cssText = "position:absolute; top:50%; left:0; width:100%; border-top:2px dashed rgba(255,255,255,0.7); pointer-events:none;";
    court.appendChild(net);

    // é¸æŠæ©Ÿèƒ½å¯¾å¿œ
    court.addEventListener('click', (e) => {
        if (isSelectionMode) {
            e.stopPropagation();
            toggleSelection(court);
        }
    });

    makeDraggable(court);
    container.appendChild(court);
}

function createPlayers(container, count, startY = 320) {
    const startX = 20;
    // startY ã¯å¼•æ•°ã‹ã‚‰å—ã‘å–ã‚‹ï¼ˆæŒ‡å®šãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ320ï¼‰
    const gapX = 45;
    const gapY = 45;
    const cols = 15; 

    for (let i = 0; i < count; i++) {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const x = startX + (col * gapX);
        const y = startY + (row * gapY); // ã“ã“ã§å—ã‘å–ã£ãŸstartYã‚’ä½¿ã†
        addSpotToFloor(x, y);
    }
}

function addSpotToFloor(x, y) {
    const floor = document.getElementById("gym-floor");
    const spot = document.createElement("div");
    spot.className = "player-spot draggable-item"; // æ•´åˆ—å¯¾è±¡ã‚¯ãƒ©ã‚¹
    
    spot.textContent = "?"; 
    
    spot.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y}px;
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #333;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
        color: #333;
        cursor: grab;
        z-index: 10;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        user-select: none;
        touch-action: none;
    `;
    
    // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‰Šé™¤
    spot.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        if(!isOrderingMode && !isSelectionMode && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            spot.remove();
        }
    });

    makeDraggable(spot);
    floor.appendChild(spot);
}

// --- ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã¨å‡¦ç†ã®ä¸€å…ƒåŒ– ---
function handleItemClick(e, element) {
    // ä¼æ’­é˜²æ­¢
    if(e) e.stopPropagation();

    // 1. ç•ªå·è¨­å®šãƒ¢ãƒ¼ãƒ‰
    if (isOrderingMode && element.classList.contains('player-spot')) {
        element.textContent = currentOrderCount;
        element.style.backgroundColor = "#ffeb3b"; 
        element.style.borderColor = "#f57f17";
        currentOrderCount++;
    } 
    // 2. é¸æŠãƒ¢ãƒ¼ãƒ‰
    else if (isSelectionMode) {
        toggleSelection(element);
    }
}

// --- æ©Ÿèƒ½ï¼šã‚¨ãƒªã‚¢æ‹¡å¼µ ---
function toggleFloorHeight() {
    const floor = document.getElementById("gym-floor");
    if (floor.style.height === "800px") {
        floor.style.height = "400px";
    } else {
        floor.style.height = "800px";
    }
}

// --- æ©Ÿèƒ½ï¼šé¸æŠãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ ---
function toggleSelectMode(checkbox) {
    isSelectionMode = checkbox.checked;
    const btnGroup = document.getElementById("align-buttons");
    const msg = document.getElementById("select-mode-msg");
    
    if (isSelectionMode) {
        btnGroup.style.opacity = "1";
        btnGroup.style.pointerEvents = "auto";
        if(msg) msg.style.display = "block";
    } else {
        btnGroup.style.opacity = "0.5";
        btnGroup.style.pointerEvents = "none";
        if(msg) msg.style.display = "none";
        clearSelection();
    }
}

function toggleSelection(el) {
    if (selectedElements.has(el)) {
        selectedElements.delete(el);
        el.style.outline = "none";
        // å…ƒã®å½±ã«æˆ»ã™
        el.style.boxShadow = el.classList.contains('gym-court') 
            ? "2px 2px 5px rgba(0,0,0,0.3)" 
            : "1px 1px 3px rgba(0,0,0,0.3)";
    } else {
        selectedElements.add(el);
        el.style.outline = "3px solid red";
        el.style.boxShadow = "0 0 10px rgba(255,0,0,0.5)";
    }
}

function clearSelection() {
    selectedElements.forEach(el => {
        el.style.outline = "none";
        el.style.boxShadow = el.classList.contains('gym-court') 
            ? "2px 2px 5px rgba(0,0,0,0.3)" 
            : "1px 1px 3px rgba(0,0,0,0.3)";
    });
    selectedElements.clear();
}

// --- æ©Ÿèƒ½ï¼šæ•´åˆ—å®Ÿè¡Œ ---
function alignSelected(type) {
    if (selectedElements.size < 2) return alert("2ã¤ä»¥ä¸Šã®è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„");
    
    const items = Array.from(selectedElements);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ä¸
    items.forEach(el => el.style.transition = "top 0.2s, left 0.2s");

    if (type === 'top') {
        // æœ€ã‚‚ä¸Šã®Yåº§æ¨™ã«åˆã‚ã›ã‚‹
        const minTop = Math.min(...items.map(el => parseInt(el.style.top || el.offsetTop)));
        items.forEach(el => el.style.top = minTop + "px");
    } 
    else if (type === 'left') {
        // æœ€ã‚‚å·¦ã®Xåº§æ¨™ã«åˆã‚ã›ã‚‹
        const minLeft = Math.min(...items.map(el => parseInt(el.style.left || el.offsetLeft)));
        items.forEach(el => el.style.left = minLeft + "px");
    }
    else if (type === 'distribute') {
        // å·¦ã‹ã‚‰é †ã«ä¸¦ã³æ›¿ãˆ
        items.sort((a, b) => parseInt(a.style.left || a.offsetLeft) - parseInt(b.style.left || b.offsetLeft));
        
        const first = items[0];
        const last = items[items.length - 1];
        const firstLeft = parseInt(first.style.left || first.offsetLeft);
        const lastLeft = parseInt(last.style.left || last.offsetLeft);
        
        const totalDist = lastLeft - firstLeft;
        const interval = totalDist / (items.length - 1);
        
        items.forEach((el, i) => {
            el.style.left = (firstLeft + (interval * i)) + "px";
        });
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è§£é™¤
    setTimeout(() => {
        items.forEach(el => el.style.transition = "");
    }, 250);
}

// æ•´åˆ—ãƒœã‚¿ãƒ³ï¼ˆå…¨ä½“ã‚¹ãƒŠãƒƒãƒ—ï¼‰
function alignElements() {
    // é¸æŠä¸­ãªã‚‰é¸æŠã•ã‚ŒãŸã‚‚ã®ã ã‘ã€ãã†ã§ãªã‘ã‚Œã°å…¨ä½“ã‚’ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—
    const targetItems = selectedElements.size > 0 
        ? Array.from(selectedElements) 
        : document.querySelectorAll("#gym-floor .draggable-item");
    
    const gridSize = 20;

    targetItems.forEach(item => {
        item.style.transition = "top 0.2s, left 0.2s";
        const currentLeft = parseInt(item.style.left || item.offsetLeft);
        const currentTop = parseInt(item.style.top || item.offsetTop);
        const newLeft = Math.round(currentLeft / gridSize) * gridSize;
        const newTop = Math.round(currentTop / gridSize) * gridSize;
        item.style.left = newLeft + "px";
        item.style.top = newTop + "px";
        setTimeout(() => item.style.transition = "", 250);
    });
}

// --- ç•ªå·è¨­å®šãƒ¢ãƒ¼ãƒ‰ ---
function startOrderingMode() {
    isOrderingMode = true;
    currentOrderCount = 1;
    
    // é¸æŠãƒ¢ãƒ¼ãƒ‰è§£é™¤
    if(document.getElementById("chk-select-mode").checked) {
        document.getElementById("chk-select-mode").click();
    }

    document.getElementById("btn-start-order").style.display = "none";
    document.getElementById("ordering-status").style.display = "inline";
    document.getElementById("btn-end-order").style.display = "inline-block";

    const spots = document.querySelectorAll(".player-spot");
    spots.forEach(spot => {
        spot.textContent = ""; 
        spot.style.backgroundColor = "#e0e0e0"; 
        spot.style.borderColor = "#999";
        spot.style.cursor = "pointer"; 
    });
}

function endOrderingMode() {
    isOrderingMode = false;

    document.getElementById("btn-start-order").style.display = "inline-block";
    document.getElementById("ordering-status").style.display = "none";
    document.getElementById("btn-end-order").style.display = "none";

    const spots = document.querySelectorAll(".player-spot");
    spots.forEach(spot => {
        spot.style.backgroundColor = "rgba(255, 255, 255, 0.9)";
        spot.style.borderColor = "#333";
        spot.style.cursor = "grab";
        if(spot.textContent === "") spot.textContent = "?";
    });
}

// --- ç”»åƒä¿å­˜ ---
async function saveGymImage() {
    const floor = document.getElementById("gym-floor");
    if(!floor) return;
    
    // ä¿å­˜å‰ã«é¸æŠæ ã‚’ä¸€æ™‚çš„ã«æ¶ˆã™
    const tempSelected = new Set(selectedElements);
    clearSelection();

    try {
        const canvas = await html2canvas(floor, {
            scale: 2, 
            useCORS: true,
            backgroundColor: "#e0e0e0"
        });
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "court_layout.png";
        link.click();
    } catch (e) {
        console.error(e);
        alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    } finally {
        // é¸æŠçŠ¶æ…‹ã‚’æˆ»ã™
        tempSelected.forEach(el => toggleSelection(el));
    }
}

// ==========================================
// âœ… ã‚³ãƒ¼ãƒˆé…ç½®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½
// ==========================================

function saveLayoutToBrowser() {
    // 1. ä¿å­˜å‰ã«é¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼ˆèµ¤æ ãªã©ã‚’æ¶ˆã™ãŸã‚ï¼‰
    const wasSelected = isSelectionMode;
    if (wasSelected) clearSelection();

    // 2. ãƒ•ãƒ­ã‚¢å†…ã®è¦ç´ ï¼ˆã‚³ãƒ¼ãƒˆã¨ã‚¹ãƒãƒƒãƒˆï¼‰ã®çŠ¶æ…‹ã‚’å–å¾—
    const items = [];
    document.querySelectorAll("#gym-floor .draggable-item").forEach(el => {
        items.push({
            type: el.classList.contains("gym-court") ? "court" : "spot",
            left: el.style.left,
            top: el.style.top,
            text: el.textContent,
            bg: el.style.backgroundColor,
            border: el.style.borderColor
        });
    });

    // 3. ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    const saveData = {
        courtCount: document.getElementById("init-court-count").value,
        playerCount: document.getElementById("init-player-count").value,
        items: items,
        floorHeight: document.getElementById("gym-floor").style.height,
        timestamp: new Date().toLocaleString()
    };

    // 4. LocalStorageã«ä¿å­˜
    localStorage.setItem("smartCoachLayout", JSON.stringify(saveData));

    // 5. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    const statusEl = document.getElementById("layout-local-status");
    if(statusEl) {
        statusEl.textContent = "ä¿å­˜å®Œäº†: " + saveData.timestamp;
        setTimeout(() => { statusEl.textContent = ""; }, 3000);
    }
}

function loadLayoutFromBrowser() {
    const json = localStorage.getItem("smartCoachLayout");
    if (!json) return alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    if (!confirm("ç¾åœ¨ã®é…ç½®ã‚’ç ´æ£„ã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

    try {
        const data = JSON.parse(json);
        
        // è¨­å®šå€¤ã®å¾©å…ƒ
        if(data.courtCount) document.getElementById("init-court-count").value = data.courtCount;
        if(data.playerCount) document.getElementById("init-player-count").value = data.playerCount;
        
        // ãƒ•ãƒ­ã‚¢ã®ã‚¯ãƒªã‚¢
        const floor = document.getElementById("gym-floor");
        floor.innerHTML = ""; 
        
        // èª¬æ˜æ›¸ãå†é…ç½®
        const note = document.createElement("p");
        note.style.cssText = "position:absolute; top:5px; left:5px; margin:0; font-size:11px; color:#666; pointer-events:none;";
        note.textContent = "ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤";
        floor.appendChild(note);

        // åºŠã®é«˜ã•å¾©å…ƒ
        if(data.floorHeight) floor.style.height = data.floorHeight;

        // ã‚¢ã‚¤ãƒ†ãƒ ã®å†é…ç½®
        if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => {
                if (item.type === "court") {
                    restoreCourt(floor, item);
                } else {
                    restoreSpot(floor, item);
                }
            });
        }
        
        // è‡ªå‹•ã§ã‚¨ãƒªã‚¢ã‚’é–‹ã
        const content = document.getElementById("layout-builder-content");
        const icon = document.getElementById("layout-toggle-icon");
        if (content.style.display === "none") {
            content.style.display = "block";
            icon.textContent = "â–²";
        }

        const statusEl = document.getElementById("layout-local-status");
        if(statusEl) statusEl.textContent = "å¾©å…ƒå®Œäº†";

    } catch (e) {
        console.error(e);
        alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}

function clearLayoutBrowserData() {
    if(confirm("é…ç½®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        localStorage.removeItem("smartCoachLayout");
        const statusEl = document.getElementById("layout-local-status");
        if(statusEl) {
            statusEl.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
            setTimeout(() => { statusEl.textContent = ""; }, 3000);
        }
    }
}

// --- å¾©å…ƒç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
function restoreCourt(container, data) {
    const court = document.createElement("div");
    court.className = "draggable-item gym-court";
    court.style.cssText = `
        position: absolute;
        top: ${data.top};
        left: ${data.left};
        width: 200px;
        height: 260px;
        background: #2e7d32;
        border: 2px solid white;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        cursor: grab;
        z-index: 1;
        touch-action: none;
    `;
    const net = document.createElement("div");
    net.style.cssText = "position:absolute; top:50%; left:0; width:100%; border-top:2px dashed rgba(255,255,255,0.7); pointer-events:none;";
    court.appendChild(net);
    
    // é¸æŠæ©Ÿèƒ½å¯¾å¿œ
    court.addEventListener('click', (e) => {
        if (isSelectionMode) {
            e.stopPropagation();
            toggleSelection(court);
        }
    });

    makeDraggable(court);
    container.appendChild(court);
}

function restoreSpot(container, data) {
    const spot = document.createElement("div");
    spot.className = "player-spot draggable-item";
    spot.textContent = data.text;
    
    // è‰²æƒ…å ±ãŒã‚ã‚Œã°å¾©å…ƒã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    const bg = data.bg || 'rgba(255, 255, 255, 0.9)';
    const border = data.border || '#333';

    spot.style.cssText = `
        position: absolute;
        left: ${data.left};
        top: ${data.top};
        width: 36px;
        height: 36px;
        background: ${bg};
        border: 2px solid #333;
        border-color: ${border};
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
        color: #333;
        cursor: grab;
        z-index: 10;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        user-select: none;
        touch-action: none;
    `;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†è¨­å®šï¼ˆæ–°è¦ä½œæˆæ™‚ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    spot.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        if(!isOrderingMode && !isSelectionMode && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            spot.remove();
        }
    });
    
    spot.addEventListener('click', (e) => {
        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆç•ªå·è¨­å®š or é¸æŠï¼‰
        handleItemClick(e, spot);
    });

    makeDraggable(spot);
    container.appendChild(spot);
}


// --- ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ (ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šè¾¼ã¿) ---
function makeDraggable(elmnt) {
    let shiftX = 0;
    let shiftY = 0;
    let isMoved = false; // ç§»å‹•ã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

    const onMouseDown = (e) => {
        // ç•ªå·è¨­å®šä¸­ã¯ãƒ‰ãƒ©ãƒƒã‚°ã•ã›ãªã„(ã‚¯ãƒªãƒƒã‚¯ã®ã¿é€šã™)
        if (typeof isOrderingMode !== 'undefined' && isOrderingMode && elmnt.classList.contains("player-spot")) return;
        // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã•ã›ãªã„(ã‚¯ãƒªãƒƒã‚¯ã®ã¿é€šã™)
        if (typeof isSelectionMode !== 'undefined' && isSelectionMode) return;

        e.preventDefault();
        isMoved = false; // ãƒªã‚»ãƒƒãƒˆ

        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

        const rect = elmnt.getBoundingClientRect();
        shiftX = clientX - rect.left;
        shiftY = clientY - rect.top;

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        document.addEventListener('touchmove', onMouseMove, { passive: false });
        document.addEventListener('touchend', onMouseUp);
    };

    const onMouseMove = (e) => {
        e.preventDefault();
        isMoved = true; // å‹•ã„ãŸï¼

        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

        const parent = elmnt.offsetParent;
        if (!parent) return;
        const parentRect = parent.getBoundingClientRect();

        let newLeft = clientX - shiftX - parentRect.left;
        let newTop = clientY - shiftY - parentRect.top;

        elmnt.style.left = newLeft + 'px';
        elmnt.style.top = newTop + 'px';
    };

    const onMouseUp = (e) => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.removeEventListener('touchmove', onMouseMove);
        document.removeEventListener('touchend', onMouseUp);

        // ã‚‚ã—ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã—ã¦ã„ãªã‘ã‚Œã°ã€ã‚¯ãƒªãƒƒã‚¯ã¨ã¿ãªã™
        if (!isMoved) {
            if(typeof handleItemClick === 'function') {
                handleItemClick(e, elmnt);
            }
        }
    };
    
    // ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠ/ç•ªå·è¨­å®šã®å ´åˆã®ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ç”¨ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ãŸã‚ï¼‰
    elmnt.addEventListener('click', (e) => {
        if ((typeof isSelectionMode !== 'undefined' && isSelectionMode) || (typeof isOrderingMode !== 'undefined' && isOrderingMode)) {
            if(typeof handleItemClick === 'function') {
                handleItemClick(e, elmnt);
            }
        }
    });

    elmnt.addEventListener('mousedown', onMouseDown);
    elmnt.addEventListener('touchstart', onMouseDown, { passive: false });
}
</script>

<div id="certificate-template" style="
    position: fixed; 
    top: -9999px; 
    left: -9999px; 
    width: 700px; 
    box-sizing: border-box;
    padding: 40px; 
    background: #fff; 
    border: 10px solid #1a237e; 
    font-family: 'Noto Sans JP', sans-serif; 
    text-align: center;
">
    <div style="
        border: 2px solid #ff9800; 
        padding: 30px;
        word-wrap: break-word;
        overflow-wrap: break-word; 
        text-align: left;
    ">
        <h1 style="font-size: 40px; color: #1a237e; margin-bottom: 10px; text-align: center;">Badminton Theory Test</h1>
        <h2 style="font-size: 28px; color: #333; margin-top: 0; border-bottom: 2px solid #ccc; padding-bottom: 20px; text-align: center;">å®ŸåŠ›è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ</h2>

        <p style="font-size: 18px; text-align: right; color: #666; margin-top: 20px;">å—é¨“æ—¥: <span id="cert-date">2025/01/01</span></p>

        <div style="margin: 40px 0; background: #f5f5f5; padding: 30px; border-radius: 10px; text-align: center;">
            <p style="font-size: 24px; color: #555; margin: 0;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢</p>
            <p style="font-size: 80px; font-weight: bold; color: #e65100; margin: 10px 0;">
                <span id="cert-score">0</span> / <span id="cert-total">20</span>
            </p>
            <p id="cert-rank" style="font-size: 32px; font-weight: bold; color: #1a237e; margin: 0;">ãƒ©ãƒ³ã‚¯åˆ¤å®šä¸­...</p>
        </div>

        <div style="margin-top: 40px; padding: 0 40px;">
            <h3 style="color: #1a237e; border-left: 5px solid #ff9800; padding-left: 10px;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
            <p id="cert-comment" style="font-size: 18px; color: #333; line-height: 1.8; text-align: left; word-wrap: break-word;"></p>
        </div>

        <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end;">
            <div style="text-align: left;">
                <p style="font-size: 14px; color: #999;">Smart Coach Badminton</p>
                <p style="font-size: 14px; color: #999;">Training Program Creator</p>
            </div>
            <div style="font-size: 20px; font-weight: bold; color: #1a237e;">
                MASU Badminton Academy
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// âœ… å…±æœ‰æ©Ÿèƒ½ (ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…±æœ‰ & è³‡æ–™ãƒªãƒ³ã‚¯QR)
// ==========================================

// 1. ä½œæˆã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å…±æœ‰QRã‚’ç”Ÿæˆ (ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸãŒé–¢æ•°ã¯æ®‹ã—ã¦ãŠãã¾ã™)
function generateAndShowShareLink() {
    if (!selectedMenus.length) {
        alert("å…±æœ‰ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nPlease create a program first.");
        return;
    }

    const data = encodeURIComponent(JSON.stringify(selectedMenus));
    const baseUrl = window.location.origin + window.location.pathname;
    const shareUrl = `${baseUrl}?share=${data}`;

    const urlBox = document.getElementById("share-url-box");
    if (urlBox) urlBox.value = shareUrl;

    const qrBox = document.getElementById("share-qr-box");
    if (qrBox) {
        qrBox.innerHTML = "";
        new QRCode(qrBox, {
            text: shareUrl,
            width: 150,
            height: 150,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.M
        });
    }

    const resultArea = document.getElementById("share-result-area");
    if (resultArea) resultArea.style.display = "block";
}

// URLã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
function copyShareUrl() {
    const urlBox = document.getElementById("share-url-box");
    if (!urlBox) return;
    urlBox.select();
    urlBox.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(urlBox.value).then(() => {
        alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    });
}

// 2. äº‹å‰ã«ä½œæˆã—ãŸQRç”»åƒã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ (ç”»åƒé¸æŠç‰ˆ)
window.displayPreMadeQR = function() {
    console.log("QRè¡¨ç¤ºãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ");

    const urlInput = document.getElementById("target-link-input");
    const fileInput = document.getElementById("qr-image-file");
    const resultArea = document.getElementById("premade-qr-result");
    const displayImg = document.getElementById("qr-display-img");
    const displayLink = document.getElementById("qr-display-link");
    const linkMsg = document.getElementById("qr-link-msg");

    // è¦ç´ ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!fileInput || !resultArea || !displayImg) {
        console.error("å¿…è¦ãªHTMLè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
    }

    // URLã¯ä»»æ„ï¼ˆãªãã¦ã‚‚OKï¼‰
    const url = urlInput ? urlInput.value.trim() : "";
    const file = fileInput.files[0];

    // ãƒ•ã‚¡ã‚¤ãƒ«å¿…é ˆãƒã‚§ãƒƒã‚¯
    if (!file) {
        alert("QRã‚³ãƒ¼ãƒ‰ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nPlease select a QR code image.");
        return;
    }

    const reader = new FileReader();
    
    reader.onload = function(e) {
        displayImg.src = e.target.result;
        
        // URLãŒã‚ã‚Œã°ãƒªãƒ³ã‚¯æœ‰åŠ¹åŒ–ã€ãªã‘ã‚Œã°ç„¡åŠ¹åŒ–
        if (url) {
            displayLink.href = url;
            displayLink.style.cursor = "pointer";
            displayLink.style.pointerEvents = "auto";
            if(linkMsg) linkMsg.style.display = "block";
        } else {
            displayLink.removeAttribute("href");
            displayLink.style.cursor = "default";
            displayLink.style.pointerEvents = "none";
            if(linkMsg) linkMsg.style.display = "none";
        }
        
        resultArea.style.display = "block";
    };

    reader.readAsDataURL(file);
};

// ==========================================
// ğŸ† æ—¥æ›¿ã‚ã‚Šè£œå¼·ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ©Ÿèƒ½
// ==========================================

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
const STORAGE_KEY_DAILY = "smartCoachDailyData";

// --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•° ---

// åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
function loadDailyData() {
    const json = localStorage.getItem(STORAGE_KEY_DAILY);
    return json ? JSON.parse(json) : { 
        streak: 0, 
        lastDate: "", 
        totalBadges: 0, 
        weeklyBadges: 0 
    };
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveDailyData(data) {
    localStorage.setItem(STORAGE_KEY_DAILY, JSON.stringify(data));
    updateDailyUI();
}

// --- 2. ç”»é¢è¡¨ç¤ºæ›´æ–° ---

function updateDailyUI() {
    const data = loadDailyData();
    
    // â–¼ è¨€èªè¨­å®šã‚’å–å¾—
    const t = translations[currentLang] || translations.ja;

    const streakEl = document.getElementById("streak-count");
    const badgeEl = document.getElementById("badge-count");
    const weeklyEl = document.getElementById("weekly-count");

    // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
    if(streakEl) streakEl.textContent = data.streak;
    if(badgeEl) badgeEl.textContent = data.totalBadges;
    if(weeklyEl) weeklyEl.textContent = data.weeklyBadges;

    // ä»Šæ—¥ã®åˆ†ãŒçµ‚ã‚ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const today = new Date().toLocaleDateString("ja-JP");
    const btn = document.getElementById("btn-complete-challenge");
    const msg = document.getElementById("daily-message");

    if (!btn) return; // ãƒœã‚¿ãƒ³ãŒãªã„å ´åˆã¯çµ‚äº†

    if (data.lastDate === today) {
        // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ï¼šç¿»è¨³ãƒ‡ãƒ¼ã‚¿(t)ã‚’ä½¿ã† â–¼â–¼â–¼
        btn.textContent = t.dailyDoneBtn; // "æœ¬æ—¥ã¯é”æˆæ¸ˆã¿ã§ã™" or "Done Today"
        btn.disabled = true;
        btn.style.background = "#81c784"; // è–„ã„ç·‘
        if(msg) msg.textContent = t.dailyMsgDone; // å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    } else {
        // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ï¼šæœªé”æˆæ™‚ã®ãƒ†ã‚­ã‚¹ãƒˆã‚‚ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã† â–¼â–¼â–¼
        btn.textContent = t.dailyCompleteBtn; // "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼" or "Challenge Complete!"
        
        // ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã ã‘æœ‰åŠ¹åŒ–
        const listEl = document.getElementById("daily-menu-list");
        if (listEl && listEl.style.display === "block") {
            btn.disabled = false;
            btn.style.background = "#ff6f00"; // ã‚ªãƒ¬ãƒ³ã‚¸
            btn.style.cursor = "pointer";
        } else {
             btn.disabled = true;
             btn.style.background = "#ccc";
        }
        if(msg) msg.textContent = "";
    }
}

// ==========================================
// ğŸ† æ—¥æ›¿ã‚ã‚Šè£œå¼·ãƒãƒ£ãƒ¬ãƒ³ã‚¸æ©Ÿèƒ½ï¼ˆä¿®æ­£ãƒ»çµ±åˆç‰ˆï¼‰
// ==========================================

// --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢æ•° ---
function loadDailyData() {
    const json = localStorage.getItem("smartCoachDailyData");
    return json ? JSON.parse(json) : { 
        streak: 0, 
        lastDate: "", 
        totalBadges: 0, 
        weeklyBadges: 0 
    };
}

function saveDailyData(data) {
    localStorage.setItem("smartCoachDailyData", JSON.stringify(data));
    updateDailyUI();
}

// --- 2. ç”»é¢è¡¨ç¤ºæ›´æ–° ---
function updateDailyUI() {
    const data = loadDailyData();
    // è¨€èªè¨­å®šã‚’å–å¾—ï¼ˆã‚‚ã—å¤‰æ•°ãŒãªã‘ã‚Œã°æ—¥æœ¬èªã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ï¼‰
    const t = (typeof translations !== 'undefined' && typeof currentLang !== 'undefined') 
              ? (translations[currentLang] || translations.ja) 
              : { dailyDoneBtn: "æœ¬æ—¥ã¯é”æˆæ¸ˆã¿ã§ã™", dailyCompleteBtn: "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼", dailyMsgDone: "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼" };

    const streakEl = document.getElementById("streak-count");
    const badgeEl = document.getElementById("badge-count");
    const weeklyEl = document.getElementById("weekly-count");

    if(streakEl) streakEl.textContent = data.streak;
    if(badgeEl) badgeEl.textContent = data.totalBadges;
    if(weeklyEl) weeklyEl.textContent = data.weeklyBadges;

    const today = new Date().toLocaleDateString("ja-JP");
    const btn = document.getElementById("btn-complete-challenge");
    const msg = document.getElementById("daily-message");

    if (!btn) return;

    if (data.lastDate === today) {
        btn.textContent = t.dailyDoneBtn;
        btn.disabled = true;
        btn.style.background = "#81c784";
        if(msg) msg.textContent = t.dailyMsgDone;
    } else {
        btn.textContent = t.dailyCompleteBtn;
        const listEl = document.getElementById("daily-menu-list");
        if (listEl && listEl.style.display === "block") {
            btn.disabled = false;
            btn.style.background = "#ff6f00";
            btn.style.cursor = "pointer";
        } else {
             btn.disabled = true;
             btn.style.background = "#ccc";
        }
        if(msg) msg.textContent = "";
    }
}

// ==========================================
// ğŸ—ºï¸ ãƒãƒƒãƒ—é–‹é–‰æ©Ÿèƒ½
// ==========================================
function toggleMapDisplay() {
    const mapArea = document.getElementById("map-collapsible-area");
    const icon = document.getElementById("map-toggle-icon");
    
    if (!mapArea) return;

    if (mapArea.style.display === "none") {
        // é–‹ã
        mapArea.style.display = "block";
        if (icon) icon.textContent = "â–²";
        
        // â˜…é‡è¦: Google Chartsã¯éè¡¨ç¤ºçŠ¶æ…‹ã§æç”»ã™ã‚‹ã¨ã‚µã‚¤ã‚ºãŒãŠã‹ã—ããªã‚‹ãŸã‚ã€
        // è¡¨ç¤ºã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å†æç”»(renderMap)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
        if (typeof renderMap === "function" && isChartLoaded) {
            renderMap();
        }
    } else {
        // é–‰ã˜ã‚‹
        mapArea.style.display = "none";
        if (icon) icon.textContent = "â–¼";
    }
}


// --- 3. ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆå‡¦ç† ---
async function generateDailyChallenge() {
    console.log("ğŸ”¥ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ");

    // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ç¢ºèª
    if (typeof sheetData === 'undefined' || !sheetData || sheetData.length === 0) {
        const statusEl = document.getElementById("statusMessage");
        if(statusEl) statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
        if(typeof loadSheet === 'function') {
            await loadSheet();
        } else {
            alert("ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
        }
    }

    if (!sheetData || sheetData.length === 0) {
        alert("ã‚¨ãƒ©ãƒ¼ï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚\nç”»é¢ã‚’æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // ã€Œè£œå¼·ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æŠ½å‡º
    const strengthMenus = sheetData.filter(m => {
        const cat = (m.ã‚«ãƒ†ã‚´ãƒª || m.category || "").toString();
        return cat.includes("è£œå¼·");
    });

    if (strengthMenus.length === 0) {
        const existingCats = [...new Set(sheetData.map(m => m.ã‚«ãƒ†ã‚´ãƒª || m.category))].join(", ");
        alert(`âŒ ã€Œè£œå¼·ã€ã‚«ãƒ†ã‚´ãƒªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nç¾åœ¨èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒª: ${existingCats}`);
        return;
    }

    // æŒ‡å®šã•ã‚ŒãŸæ•°ã‚’å–å¾—
    const countInput = document.getElementById("daily-count");
    let count = parseInt(countInput.value) || 7;
    if (count > strengthMenus.length) count = strengthMenus.length;

    // ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
    const shuffled = strengthMenus.sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, count);

    // ãƒªã‚¹ãƒˆæç”»
    const listContainer = document.getElementById("daily-menu-list");
    if (!listContainer) return;
    
    // â˜…ä¿®æ­£: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’å…ˆé ­ã«è¿½åŠ ã—ã¦åˆæœŸåŒ–
    listContainer.innerHTML = `
        <div style="text-align: right; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
            <button id="btn-close-daily-list" style="background: #757575; color: white; border: none; border-radius: 4px; padding: 5px 15px; cursor: pointer; font-size: 12px;">
                Ã— ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
            </button>
        </div>
    `;

    // â˜…ä¿®æ­£: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‹•ä½œè¨­å®š
    document.getElementById("btn-close-daily-list").addEventListener("click", () => {
        listContainer.style.display = "none";
    });
    
    selected.forEach((m, index) => {
        const menuName = m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å || m.name || "åç§°ä¸æ˜";
        const menuDesc = m.èª¬æ˜ || m.note || "èª¬æ˜ãªã—";
        const menuUrl  = m["YouTube URL"] || m.url || m.video_url || "";
        const menuImg  = m["ç”»åƒURL"] || m.imgUrl || "";

        let videoLink = "";
        if (menuUrl) {
            videoLink = `<a href="${menuUrl}" target="_blank" style="font-size:12px; color:#1e88e5; text-decoration:none; display:block; margin-top:5px;">ğŸ“º å‹•ç”»ã‚’è¦‹ã‚‹</a>`;
        }

        let imageHtml = "";
        if (menuImg) {
            imageHtml = `
                <div style="flex: 0 0 80px; margin-right: 10px; display:flex; align-items:center; justify-content:center;">
                    <img src="${menuImg}" alt="img" style="width:100%; height:auto; max-height:60px; object-fit:contain; border-radius:4px; border:1px solid #eee;">
                </div>
            `;
        }

        const div = document.createElement("div");
        div.style.cssText = "padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: flex-start;";
        
        div.innerHTML = `
            ${imageHtml}
            <div style="flex: 1;">
                <div style="font-weight:bold; color:#333; font-size:15px; margin-bottom:4px;">
                    <span style="color:#ff6f00; margin-right:5px;">${index + 1}.</span>${menuName}
                </div>
                <div style="font-size:13px; color:#666; line-height:1.4;">
                    ${menuDesc}
                </div>
                ${videoLink}
            </div>
        `;
        listContainer.appendChild(div);
    });

    listContainer.style.display = "block";
    
    // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
    const btn = document.getElementById("btn-complete-challenge");
    if(btn) {
        btn.disabled = false;
        btn.textContent = "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼";
        btn.style.background = "#ff6f00";
        btn.style.cursor = "pointer";
    }
}

// --- 4. ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆå‡¦ç† ---
function completeDailyChallenge() {
    if(typeof playSportsDrum === 'function') playSportsDrum();

    const currentData = loadDailyData();
    const today = new Date().toLocaleDateString("ja-JP");
    const yesterday = new Date(Date.now() - 86400000).toLocaleDateString("ja-JP");

    if (currentData.lastDate === today) return;

    if (currentData.lastDate === yesterday) {
        currentData.streak++;
    } else {
        currentData.streak = 1;
    }

    currentData.lastDate = today;
    currentData.totalBadges++;

    let alertMsg = "ğŸ–ï¸ ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼";

    if (currentData.streak > 0 && currentData.streak % 7 === 0) {
        currentData.weeklyBadges++;
        alertMsg += "\nğŸ† 1é€±é–“ç¶™ç¶šé”æˆï¼ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒãƒƒã‚¸ç²å¾—ï¼";
        if(typeof playBuzz === 'function') playBuzz(500, 600);
    }

    saveDailyData(currentData);
    alert(alertMsg);
}

// --- 5. åˆæœŸåŒ–ã‚¤ãƒ™ãƒ³ãƒˆ ---
document.addEventListener("DOMContentLoaded", () => {
    updateDailyUI();
});

// ==========================================
// ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
// ==========================================
function resetDailyData() {
    // èª¤æ“ä½œé˜²æ­¢ã®ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆ
    if (!confirm("âš ï¸ ã€è­¦å‘Šã€‘\nã“ã‚Œã¾ã§ã®æ—¥æœ¬ä¸€å‘¨ãƒ»ä¸–ç•Œä¸€å‘¨ã®é€²æ—ã€ç²å¾—ã—ãŸãƒãƒƒã‚¸ã€é€£ç¶šé”æˆè¨˜éŒ²ãŒã™ã¹ã¦æ¶ˆå»ã•ã‚Œã¾ã™ã€‚\n\næœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
        return;
    }

    // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    localStorage.removeItem("smartCoachDailyData");

    // 2. å¤‰æ•°ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
    mapProgress = { japan: 0, world: 0, japanCompleted: false };
    currentMapMode = "japan";

    // 3. ç”»é¢è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆåˆæœŸåŒ–ï¼‰
    updateDailyUI();  // ãƒãƒƒã‚¸ã‚„ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®æ›´æ–°
    renderMap();      // åœ°å›³ã®æ›´æ–°ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã¸ï¼‰
    
    // 4. ãƒãƒƒãƒ—ã®ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚‚æ›´æ–°ï¼ˆä¸–ç•Œä¸€å‘¨ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒƒã‚¯ï¼‰
    if (typeof updateMapUnlockState === "function") {
        updateMapUnlockState();
    }

    // 5. å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const msgEl = document.getElementById("daily-message");
    if(msgEl) msgEl.textContent = ""; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
    
    alert("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\næ–°ãŸãªæ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼ğŸŒ");
}

// ==========================================
// ğŸ—ºï¸ æ—¥æœ¬ä¸€å‘¨ï¼†ä¸–ç•Œä¸€å‘¨ ãƒãƒƒãƒ—æ©Ÿèƒ½ (Google Chartsç‰ˆ)
// ==========================================

// --- è¨­å®š ---
let chart; // Google Chartã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
let isChartLoaded = false; // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°

// Google Charts ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ­ãƒ¼ãƒ‰
if (typeof google !== 'undefined' && google.charts) {
    google.charts.load('current', {
        'packages': ['geochart']
    });
    google.charts.setOnLoadCallback(() => {
        isChartLoaded = true;
        renderMap(); // æº–å‚™ãŒã§ããŸã‚‰æç”»
    });
}

// ğŸ“ æ—¥æœ¬ä¸€å‘¨ãƒ«ãƒ¼ãƒˆ (JIS X 0401 éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰é †: åŒ—ã‹ã‚‰å—ã¸)
// Google Chartsã§ã¯ "JP-01" ã®ã‚ˆã†ãªISO 3166-2ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™
const JAPAN_ROUTE = [
    {name:"åŒ—æµ·é“", code:"JP-01"}, {name:"é’æ£®", code:"JP-02"}, {name:"å²©æ‰‹", code:"JP-03"}, {name:"å®®åŸ", code:"JP-04"},
    {name:"ç§‹ç”°", code:"JP-05"}, {name:"å±±å½¢", code:"JP-06"}, {name:"ç¦å³¶", code:"JP-07"}, {name:"èŒ¨åŸ", code:"JP-08"},
    {name:"æ ƒæœ¨", code:"JP-09"}, {name:"ç¾¤é¦¬", code:"JP-10"}, {name:"åŸ¼ç‰", code:"JP-11"}, {name:"åƒè‘‰", code:"JP-12"},
    {name:"æ±äº¬", code:"JP-13"}, {name:"ç¥å¥ˆå·", code:"JP-14"}, {name:"æ–°æ½Ÿ", code:"JP-15"}, {name:"å¯Œå±±", code:"JP-16"},
    {name:"çŸ³å·", code:"JP-17"}, {name:"ç¦äº•", code:"JP-18"}, {name:"å±±æ¢¨", code:"JP-19"}, {name:"é•·é‡", code:"JP-20"},
    {name:"å²é˜œ", code:"JP-21"}, {name:"é™å²¡", code:"JP-22"}, {name:"æ„›çŸ¥", code:"JP-23"}, {name:"ä¸‰é‡", code:"JP-24"},
    {name:"æ»‹è³€", code:"JP-25"}, {name:"äº¬éƒ½", code:"JP-26"}, {name:"å¤§é˜ª", code:"JP-27"}, {name:"å…µåº«", code:"JP-28"},
    {name:"å¥ˆè‰¯", code:"JP-29"}, {name:"å’Œæ­Œå±±", code:"JP-30"}, {name:"é³¥å–", code:"JP-31"}, {name:"å³¶æ ¹", code:"JP-32"},
    {name:"å²¡å±±", code:"JP-33"}, {name:"åºƒå³¶", code:"JP-34"}, {name:"å±±å£", code:"JP-35"}, {name:"å¾³å³¶", code:"JP-36"},
    {name:"é¦™å·", code:"JP-37"}, {name:"æ„›åª›", code:"JP-38"}, {name:"é«˜çŸ¥", code:"JP-39"}, {name:"ç¦å²¡", code:"JP-40"},
    {name:"ä½è³€", code:"JP-41"}, {name:"é•·å´", code:"JP-42"}, {name:"ç†Šæœ¬", code:"JP-43"}, {name:"å¤§åˆ†", code:"JP-44"},
    {name:"å®®å´", code:"JP-45"}, {name:"é¹¿å…å³¶", code:"JP-46"}, {name:"æ²–ç¸„", code:"JP-47"}
];

// ğŸ“ ä¸–ç•Œä¸€å‘¨ãƒ«ãƒ¼ãƒˆ (å›½é€£åŠ ç›Ÿå›½193ã‚«å›½ãƒ™ãƒ¼ã‚¹ + ãƒãƒã‚«ãƒ³ç­‰)
// æ—¥æœ¬ç™º â†’ ã‚¢ã‚¸ã‚¢ â†’ ã‚ªã‚»ã‚¢ãƒ‹ã‚¢ â†’ ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ â†’ ã‚¢ãƒ•ãƒªã‚« â†’ å—åŒ—ã‚¢ãƒ¡ãƒªã‚« (ISO 3166-1 alpha-2)
const WORLD_ROUTE = [
    // æ±ã‚¢ã‚¸ã‚¢
    {name:"æ—¥æœ¬", code:"JP"}, {name:"éŸ“å›½", code:"KR"}, {name:"ä¸­å›½", code:"CN"}, {name:"ãƒ¢ãƒ³ã‚´ãƒ«", code:"MN"}, {name:"åŒ—æœé®®", code:"KP"},
    // æ±å—ã‚¢ã‚¸ã‚¢
    {name:"ãƒ™ãƒˆãƒŠãƒ ", code:"VN"}, {name:"ãƒ©ã‚ªã‚¹", code:"LA"}, {name:"ã‚«ãƒ³ãƒœã‚¸ã‚¢", code:"KH"}, {name:"ã‚¿ã‚¤", code:"TH"}, {name:"ãƒŸãƒ£ãƒ³ãƒãƒ¼", code:"MM"},
    {name:"ãƒãƒ¬ãƒ¼ã‚·ã‚¢", code:"MY"}, {name:"ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", code:"SG"}, {name:"ãƒ–ãƒ«ãƒã‚¤", code:"BN"}, {name:"ãƒ•ã‚£ãƒªãƒ”ãƒ³", code:"PH"}, {name:"ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", code:"ID"}, {name:"æ±ãƒ†ã‚£ãƒ¢ãƒ¼ãƒ«", code:"TL"},
    // å—ã‚¢ã‚¸ã‚¢
    {name:"ã‚¤ãƒ³ãƒ‰", code:"IN"}, {name:"ãƒãƒ³ã‚°ãƒ©ãƒ‡ã‚·ãƒ¥", code:"BD"}, {name:"ãƒ–ãƒ¼ã‚¿ãƒ³", code:"BT"}, {name:"ãƒãƒ‘ãƒ¼ãƒ«", code:"NP"}, {name:"ã‚¹ãƒªãƒ©ãƒ³ã‚«", code:"LK"}, {name:"ãƒ¢ãƒ«ãƒ‡ã‚£ãƒ–", code:"MV"}, {name:"ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³", code:"PK"},
    // ã‚ªã‚»ã‚¢ãƒ‹ã‚¢
    {name:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", code:"AU"}, {name:"ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰", code:"NZ"}, {name:"ãƒ‘ãƒ—ã‚¢ãƒ‹ãƒ¥ãƒ¼ã‚®ãƒ‹ã‚¢", code:"PG"}, {name:"ã‚½ãƒ­ãƒ¢ãƒ³è«¸å³¶", code:"SB"}, {name:"ãƒãƒŒã‚¢ãƒ„", code:"VU"}, {name:"ãƒ•ã‚£ã‚¸ãƒ¼", code:"FJ"}, {name:"ã‚µãƒ¢ã‚¢", code:"WS"}, {name:"ãƒˆãƒ³ã‚¬", code:"TO"}, {name:"ãƒ„ãƒãƒ«", code:"TV"}, {name:"ã‚­ãƒªãƒã‚¹", code:"KI"}, {name:"ãƒãƒ¼ã‚·ãƒ£ãƒ«è«¸å³¶", code:"MH"}, {name:"ãƒŸã‚¯ãƒ­ãƒã‚·ã‚¢", code:"FM"}, {name:"ãƒ‘ãƒ©ã‚ª", code:"PW"}, {name:"ãƒŠã‚¦ãƒ«", code:"NR"},
    // ä¸­å¤®ã‚¢ã‚¸ã‚¢ãƒ»è¥¿ã‚¢ã‚¸ã‚¢
    {name:"ã‚¢ãƒ•ã‚¬ãƒ‹ã‚¹ã‚¿ãƒ³", code:"AF"}, {name:"ã‚¿ã‚¸ã‚­ã‚¹ã‚¿ãƒ³", code:"TJ"}, {name:"ã‚­ãƒ«ã‚®ã‚¹", code:"KG"}, {name:"ã‚«ã‚¶ãƒ•ã‚¹ã‚¿ãƒ³", code:"KZ"}, {name:"ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³", code:"UZ"}, {name:"ãƒˆãƒ«ã‚¯ãƒ¡ãƒ‹ã‚¹ã‚¿ãƒ³", code:"TM"}, {name:"ã‚¤ãƒ©ãƒ³", code:"IR"},
    // ä¸­æ±
    {name:"ã‚¤ãƒ©ã‚¯", code:"IQ"}, {name:"ã‚¯ã‚¦ã‚§ãƒ¼ãƒˆ", code:"KW"}, {name:"ãƒãƒ¼ãƒ¬ãƒ¼ãƒ³", code:"BH"}, {name:"ã‚«ã‚¿ãƒ¼ãƒ«", code:"QA"}, {name:"UAE", code:"AE"}, {name:"ã‚ªãƒãƒ¼ãƒ³", code:"OM"}, {name:"ã‚¤ã‚¨ãƒ¡ãƒ³", code:"YE"}, {name:"ã‚µã‚¦ã‚¸ã‚¢ãƒ©ãƒ“ã‚¢", code:"SA"}, {name:"ãƒ¨ãƒ«ãƒ€ãƒ³", code:"JO"}, {name:"ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«", code:"IL"}, {name:"ãƒ¬ãƒãƒãƒ³", code:"LB"}, {name:"ã‚·ãƒªã‚¢", code:"SY"}, {name:"ãƒˆãƒ«ã‚³", code:"TR"},
    // ã‚³ãƒ¼ã‚«ã‚µã‚¹
    {name:"ã‚¢ã‚¼ãƒ«ãƒã‚¤ã‚¸ãƒ£ãƒ³", code:"AZ"}, {name:"ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢", code:"GE"}, {name:"ã‚¢ãƒ«ãƒ¡ãƒ‹ã‚¢", code:"AM"},
    // ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ï¼ˆæ±ãƒ»åŒ—ï¼‰
    {name:"ãƒ­ã‚·ã‚¢", code:"RU"}, {name:"ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠ", code:"UA"}, {name:"ãƒ™ãƒ©ãƒ«ãƒ¼ã‚·", code:"BY"}, {name:"ãƒ¢ãƒ«ãƒ‰ãƒ", code:"MD"}, {name:"ãƒ«ãƒ¼ãƒãƒ‹ã‚¢", code:"RO"}, {name:"ãƒ–ãƒ«ã‚¬ãƒªã‚¢", code:"BG"},
    {name:"ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰", code:"FI"}, {name:"ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³", code:"SE"}, {name:"ãƒãƒ«ã‚¦ã‚§ãƒ¼", code:"NO"}, {name:"ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰", code:"IS"}, {name:"ãƒ‡ãƒ³ãƒãƒ¼ã‚¯", code:"DK"}, {name:"ã‚¨ã‚¹ãƒˆãƒ‹ã‚¢", code:"EE"}, {name:"ãƒ©ãƒˆãƒ“ã‚¢", code:"LV"}, {name:"ãƒªãƒˆã‚¢ãƒ‹ã‚¢", code:"LT"},
    // ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ï¼ˆä¸­ãƒ»è¥¿ãƒ»å—ï¼‰
    {name:"ãƒãƒ¼ãƒ©ãƒ³ãƒ‰", code:"PL"}, {name:"ãƒã‚§ã‚³", code:"CZ"}, {name:"ã‚¹ãƒ­ãƒã‚­ã‚¢", code:"SK"}, {name:"ãƒãƒ³ã‚¬ãƒªãƒ¼", code:"HU"}, {name:"ã‚ªãƒ¼ã‚¹ãƒˆãƒªã‚¢", code:"AT"}, {name:"ãƒ‰ã‚¤ãƒ„", code:"DE"}, {name:"ã‚¹ã‚¤ã‚¹", code:"CH"}, {name:"ãƒªãƒ’ãƒ†ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³", code:"LI"},
    {name:"ã‚ªãƒ©ãƒ³ãƒ€", code:"NL"}, {name:"ãƒ™ãƒ«ã‚®ãƒ¼", code:"BE"}, {name:"ãƒ«ã‚¯ã‚»ãƒ³ãƒ–ãƒ«ã‚¯", code:"LU"}, {name:"ã‚¤ã‚®ãƒªã‚¹", code:"GB"}, {name:"ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰", code:"IE"}, {name:"ãƒ•ãƒ©ãƒ³ã‚¹", code:"FR"}, {name:"ãƒ¢ãƒŠã‚³", code:"MC"},
    {name:"ã‚¹ãƒšã‚¤ãƒ³", code:"ES"}, {name:"ãƒãƒ«ãƒˆã‚¬ãƒ«", code:"PT"}, {name:"ã‚¢ãƒ³ãƒ‰ãƒ©", code:"AD"}, {name:"ã‚¤ã‚¿ãƒªã‚¢", code:"IT"}, {name:"ãƒãƒã‚«ãƒ³", code:"VA"}, {name:"ã‚µãƒ³ãƒãƒªãƒ", code:"SM"}, {name:"ãƒãƒ«ã‚¿", code:"MT"},
    {name:"ã‚®ãƒªã‚·ãƒ£", code:"GR"}, {name:"ã‚­ãƒ—ãƒ­ã‚¹", code:"CY"}, {name:"ã‚¢ãƒ«ãƒãƒ‹ã‚¢", code:"AL"}, {name:"åŒ—ãƒã‚±ãƒ‰ãƒ‹ã‚¢", code:"MK"}, {name:"ã‚»ãƒ«ãƒ“ã‚¢", code:"RS"}, {name:"ãƒ¢ãƒ³ãƒ†ãƒã‚°ãƒ­", code:"ME"}, {name:"ãƒœã‚¹ãƒ‹ã‚¢ãƒ»ãƒ˜ãƒ«ãƒ„ã‚§ã‚´ãƒ“ãƒŠ", code:"BA"}, {name:"ã‚¯ãƒ­ã‚¢ãƒã‚¢", code:"HR"}, {name:"ã‚¹ãƒ­ãƒ™ãƒ‹ã‚¢", code:"SI"},
    // ã‚¢ãƒ•ãƒªã‚«ï¼ˆåŒ—ãƒ»è¥¿ï¼‰
    {name:"ã‚¨ã‚¸ãƒ—ãƒˆ", code:"EG"}, {name:"ãƒªãƒ“ã‚¢", code:"LY"}, {name:"ãƒãƒ¥ãƒ‹ã‚¸ã‚¢", code:"TN"}, {name:"ã‚¢ãƒ«ã‚¸ã‚§ãƒªã‚¢", code:"DZ"}, {name:"ãƒ¢ãƒ­ãƒƒã‚³", code:"MA"}, {name:"ãƒ¢ãƒ¼ãƒªã‚¿ãƒ‹ã‚¢", code:"MR"}, {name:"ãƒãƒª", code:"ML"}, {name:"ãƒ‹ã‚¸ã‚§ãƒ¼ãƒ«", code:"NE"}, {name:"ãƒãƒ£ãƒ‰", code:"TD"}, {name:"ã‚¹ãƒ¼ãƒ€ãƒ³", code:"SD"},
    {name:"ã‚»ãƒã‚¬ãƒ«", code:"SN"}, {name:"ã‚¬ãƒ³ãƒ“ã‚¢", code:"GM"}, {name:"ã‚®ãƒ‹ã‚¢ãƒ“ã‚µã‚¦", code:"GW"}, {name:"ã‚®ãƒ‹ã‚¢", code:"GN"}, {name:"ã‚·ã‚¨ãƒ©ãƒ¬ã‚ªãƒ", code:"SL"}, {name:"ãƒªãƒ™ãƒªã‚¢", code:"LR"}, {name:"ã‚³ãƒ¼ãƒˆã‚¸ãƒœãƒ¯ãƒ¼ãƒ«", code:"CI"}, {name:"ã‚¬ãƒ¼ãƒŠ", code:"GH"}, {name:"ãƒˆãƒ¼ã‚´", code:"TG"}, {name:"ãƒ™ãƒŠãƒ³", code:"BJ"}, {name:"ãƒŠã‚¤ã‚¸ã‚§ãƒªã‚¢", code:"NG"}, {name:"ãƒ–ãƒ«ã‚­ãƒŠãƒ•ã‚¡ã‚½", code:"BF"}, {name:"ã‚«ãƒ¼ãƒœãƒ™ãƒ«ãƒ‡", code:"CV"},
    // ã‚¢ãƒ•ãƒªã‚«ï¼ˆä¸­å¤®ãƒ»æ±ãƒ»å—ï¼‰
    {name:"ã‚«ãƒ¡ãƒ«ãƒ¼ãƒ³", code:"CM"}, {name:"ä¸­å¤®ã‚¢ãƒ•ãƒªã‚«", code:"CF"}, {name:"å—ã‚¹ãƒ¼ãƒ€ãƒ³", code:"SS"}, {name:"ã‚¨ãƒã‚ªãƒ”ã‚¢", code:"ET"}, {name:"ã‚¨ãƒªãƒˆãƒªã‚¢", code:"ER"}, {name:"ã‚¸ãƒ–ãƒ", code:"DJ"}, {name:"ã‚½ãƒãƒªã‚¢", code:"SO"}, {name:"ã‚±ãƒ‹ã‚¢", code:"KE"}, {name:"ã‚¦ã‚¬ãƒ³ãƒ€", code:"UG"}, {name:"ãƒ«ãƒ¯ãƒ³ãƒ€", code:"RW"}, {name:"ãƒ–ãƒ«ãƒ³ã‚¸", code:"BI"}, {name:"ã‚¿ãƒ³ã‚¶ãƒ‹ã‚¢", code:"TZ"},
    {name:"èµ¤é“ã‚®ãƒ‹ã‚¢", code:"GQ"}, {name:"ã‚¬ãƒœãƒ³", code:"GA"}, {name:"ã‚³ãƒ³ã‚´å…±å’Œå›½", code:"CG"}, {name:"ã‚³ãƒ³ã‚´æ°‘ä¸»å…±å’Œå›½", code:"CD"}, {name:"ã‚µãƒ³ãƒˆãƒ¡ãƒ»ãƒ—ãƒªãƒ³ã‚·ãƒš", code:"ST"},
    {name:"ã‚¢ãƒ³ã‚´ãƒ©", code:"AO"}, {name:"ã‚¶ãƒ³ãƒ“ã‚¢", code:"ZM"}, {name:"ãƒãƒ©ã‚¦ã‚¤", code:"MW"}, {name:"ãƒ¢ã‚¶ãƒ³ãƒ“ãƒ¼ã‚¯", code:"MZ"}, {name:"ãƒãƒ€ã‚¬ã‚¹ã‚«ãƒ«", code:"MG"}, {name:"ã‚³ãƒ¢ãƒ­", code:"KM"}, {name:"ãƒ¢ãƒ¼ãƒªã‚·ãƒ£ã‚¹", code:"MU"}, {name:"ã‚»ãƒ¼ã‚·ã‚§ãƒ«", code:"SC"},
    {name:"ã‚¸ãƒ³ãƒãƒ–ã‚¨", code:"ZW"}, {name:"ãƒœãƒ„ãƒ¯ãƒŠ", code:"BW"}, {name:"ãƒŠãƒŸãƒ“ã‚¢", code:"NA"}, {name:"å—ã‚¢ãƒ•ãƒªã‚«", code:"ZA"}, {name:"ãƒ¬ã‚½ãƒˆ", code:"LS"}, {name:"ã‚¨ã‚¹ãƒ¯ãƒ†ã‚£ãƒ‹", code:"SZ"},
    // å—ç±³
    {name:"ãƒ–ãƒ©ã‚¸ãƒ«", code:"BR"}, {name:"ã‚¦ãƒ«ã‚°ã‚¢ã‚¤", code:"UY"}, {name:"ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", code:"AR"}, {name:"ãƒãƒª", code:"CL"}, {name:"ãƒ‘ãƒ©ã‚°ã‚¢ã‚¤", code:"PY"}, {name:"ãƒœãƒªãƒ“ã‚¢", code:"BO"}, {name:"ãƒšãƒ«ãƒ¼", code:"PE"}, {name:"ã‚¨ã‚¯ã‚¢ãƒ‰ãƒ«", code:"EC"}, {name:"ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", code:"CO"}, {name:"ãƒ™ãƒã‚ºã‚¨ãƒ©", code:"VE"}, {name:"ã‚¬ã‚¤ã‚¢ãƒŠ", code:"GY"}, {name:"ã‚¹ãƒªãƒŠãƒ ", code:"SR"},
    // ä¸­ç±³ãƒ»ã‚«ãƒªãƒ–
    {name:"ãƒ‘ãƒŠãƒ", code:"PA"}, {name:"ã‚³ã‚¹ã‚¿ãƒªã‚«", code:"CR"}, {name:"ãƒ‹ã‚«ãƒ©ã‚°ã‚¢", code:"NI"}, {name:"ãƒ›ãƒ³ã‚¸ãƒ¥ãƒ©ã‚¹", code:"HN"}, {name:"ã‚¨ãƒ«ã‚µãƒ«ãƒãƒ‰ãƒ«", code:"SV"}, {name:"ã‚°ã‚¢ãƒ†ãƒãƒ©", code:"GT"}, {name:"ãƒ™ãƒªãƒ¼ã‚º", code:"BZ"}, {name:"ãƒ¡ã‚­ã‚·ã‚³", code:"MX"},
    {name:"ã‚­ãƒ¥ãƒ¼ãƒ", code:"CU"}, {name:"ã‚¸ãƒ£ãƒã‚¤ã‚«", code:"JM"}, {name:"ãƒã‚¤ãƒ", code:"HT"}, {name:"ãƒ‰ãƒŸãƒ‹ã‚«å…±å’Œå›½", code:"DO"}, {name:"ãƒãƒãƒ", code:"BS"}, {name:"ã‚»ãƒ³ãƒˆã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ãƒ»ãƒã‚¤ãƒ“ã‚¹", code:"KN"}, {name:"ã‚¢ãƒ³ãƒ†ã‚£ã‚°ã‚¢ãƒ»ãƒãƒ¼ãƒ–ãƒ¼ãƒ€", code:"AG"}, {name:"ãƒ‰ãƒŸãƒ‹ã‚«å›½", code:"DM"}, {name:"ã‚»ãƒ³ãƒˆãƒ«ã‚·ã‚¢", code:"LC"}, {name:"ã‚»ãƒ³ãƒˆãƒ“ãƒ³ã‚»ãƒ³ãƒˆãƒ»ã‚°ãƒ¬ãƒŠãƒ‡ã‚£ãƒ¼ãƒ³", code:"VC"}, {name:"ãƒãƒ«ãƒãƒ‰ã‚¹", code:"BB"}, {name:"ã‚°ãƒ¬ãƒŠãƒ€", code:"GD"}, {name:"ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´", code:"TT"},
    // åŒ—ç±³
    {name:"ã‚¢ãƒ¡ãƒªã‚«", code:"US"}, {name:"ã‚«ãƒŠãƒ€", code:"CA"}
];

// çŠ¶æ…‹å¤‰æ•°
let currentMapMode = "japan";
let mapProgress = { japan: 0, world: 0 }; 

// --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ ---
function loadMapData() {
    const json = localStorage.getItem("smartCoachDailyData");
    const data = json ? JSON.parse(json) : {};
    mapProgress.japan = data.mapJapanIdx || 0;
    mapProgress.world = data.mapWorldIdx || 0;
    currentMapMode = data.currentMapMode || "japan";
    
    // â˜…è¿½åŠ : ã‚¯ãƒªã‚¢ãƒ•ãƒ©ã‚°ã®èª­ã¿è¾¼ã¿
    // ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ false
    mapProgress.japanCompleted = data.japanCompleted || false;

    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateMapUnlockState();

    return data;
}

// --- â˜…æ–°è¦: ãƒ­ãƒƒã‚¯è§£é™¤çŠ¶æ…‹ã®æ›´æ–° ---
function updateMapUnlockState() {
    const btnWorld = document.getElementById("btn-map-world");
    if (!btnWorld) return;

    if (mapProgress.japanCompleted) {
        // è§£æ”¾æ¸ˆã¿
        btnWorld.disabled = false;
        btnWorld.innerHTML = "ğŸŒ ä¸–ç•Œä¸€å‘¨";
        btnWorld.style.background = (currentMapMode === "world") ? "#0288d1" : "#b0bec5"; // é¸æŠçŠ¶æ…‹ã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
        btnWorld.style.color = "white";
        btnWorld.style.cursor = "pointer";
        btnWorld.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
    } else {
        // ãƒ­ãƒƒã‚¯ä¸­
        btnWorld.disabled = true;
        btnWorld.innerHTML = "ğŸ”’ ä¸–ç•Œä¸€å‘¨ (æ—¥æœ¬ã‚¯ãƒªã‚¢ã§è§£æ”¾)";
        btnWorld.style.background = "#e0e0e0";
        btnWorld.style.color = "#999";
        btnWorld.style.cursor = "not-allowed";
        btnWorld.style.boxShadow = "none";
    }
    
    // æ—¥æœ¬ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚æ›´æ–°ï¼ˆé¸æŠçŠ¶æ…‹ã®åæ˜ ï¼‰
    const btnJapan = document.getElementById("btn-map-japan");
    if (btnJapan) {
        btnJapan.style.background = (currentMapMode === "japan") ? "#8bc34a" : "#b0bec5";
    }
}

function saveMapData() {
    let data = loadDailyData(); 
    data.mapJapanIdx = mapProgress.japan;
    data.mapWorldIdx = mapProgress.world;
    data.currentMapMode = currentMapMode;
    // â˜…è¿½åŠ : ã‚¯ãƒªã‚¢ãƒ•ãƒ©ã‚°ã®ä¿å­˜
    data.japanCompleted = mapProgress.japanCompleted;
    saveDailyData(data);
}

// --- ãƒãƒƒãƒ—æç”» (Google Chartsä½¿ç”¨) ---
function renderMap() {
    if (!isChartLoaded) return;

    const container = document.getElementById('map-visual-container');
    
    // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ãˆãªã„ï¼ˆé–‰ã˜ã¦ã„ã‚‹ï¼‰æ™‚ã¯æç”»ã—ãªã„ï¼ˆã“ã‚Œã§ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆã¾ã™ï¼‰ â–¼â–¼â–¼
    if (!container || container.offsetParent === null) {
        return;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    const isJapan = (currentMapMode === "japan");
    const route = isJapan ? JAPAN_ROUTE : WORLD_ROUTE;
    const currentIdx = isJapan ? mapProgress.japan : mapProgress.world;

    // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
    const dataArray = [['Code', 'Status', {role: 'tooltip'}]];
    
    route.forEach((item, index) => {
        let status = 0; // æœªåˆ°é”
        if (index < currentIdx) status = 1; // é€šéæ¸ˆã¿
        if (index === currentIdx) status = 2; // ç¾åœ¨åœ°
        
        // [å›½ã‚³ãƒ¼ãƒ‰, ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å€¤, è¡¨ç¤ºå(ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—)]
        dataArray.push([item.code, status, item.name]);
    });

    const data = google.visualization.arrayToDataTable(dataArray);

    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
    const options = {
        colorAxis: { values: [0, 1, 2], colors: ['#e0e0e0', '#ffcc80', '#d50000'] },
        backgroundColor: '#b3e5fc',
        datalessRegionColor: '#f5f5f5',
        defaultColor: '#f5f5f5',
        legend: 'none',
        tooltip: { isHtml: true, showColorCode: false } 
    };

    if (isJapan) {
        options.region = 'JP'; 
        options.resolution = 'provinces'; 
    } else {
        options.region = 'world'; 
        options.resolution = 'countries'; 
    }

    chart = new google.visualization.GeoChart(container);
    chart.draw(data, options);

    // ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã®æ›´æ–°
    const currentItem = route[currentIdx];
    const currentName = currentItem ? currentItem.name : "GOAL!";
    
    const nameEl = document.getElementById("current-location-name");
    if(nameEl) nameEl.textContent = currentName;

    const progEl = document.getElementById("map-progress-text");
    if(progEl) progEl.textContent = `${Math.min(currentIdx + 1, route.length)} / ${route.length} ${isJapan ? 'éƒ½é“åºœçœŒ' : 'Countries'}`;

    if (typeof updateMapUnlockState === "function") {
        updateMapUnlockState();
    }
}

// --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
function switchMapMode(mode) {
    currentMapMode = mode;
    saveMapData();
    renderMap();
}

// --- é€²æ—æ›´æ–° ---
function advanceMapProgress() {
    const route = currentMapMode === "japan" ? JAPAN_ROUTE : WORLD_ROUTE;
    const key = currentMapMode === "japan" ? "japan" : "world";
    
    // ã¾ã ã‚´ãƒ¼ãƒ«ã—ã¦ã„ãªã„å ´åˆ
    if (mapProgress[key] < route.length - 1) {
        mapProgress[key]++;
        
    } else {
        // ã‚´ãƒ¼ãƒ«åˆ°é”æ™‚
        if (currentMapMode === "japan") {
            // æ—¥æœ¬ä¸€å‘¨ã‚¯ãƒªã‚¢æ™‚ã®ç‰¹åˆ¥å‡¦ç†
            if (!mapProgress.japanCompleted) {
                alert("ğŸ‰ æ—¥æœ¬ä¸€å‘¨é”æˆãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼\n\nğŸ”“ æ–°ãŸãªæŒ‘æˆ¦ã€Œä¸–ç•Œä¸€å‘¨ãƒ¢ãƒ¼ãƒ‰ã€ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼");
                mapProgress.japanCompleted = true; // ãƒ•ãƒ©ã‚°ON
            } else {
                alert("ğŸ‰ æ—¥æœ¬ä¸€å‘¨é”æˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼");
            }
            mapProgress.japan = 0; // ãƒ«ãƒ¼ãƒ—
        } else {
            // ä¸–ç•Œä¸€å‘¨ã‚¯ãƒªã‚¢æ™‚
            alert("ğŸ‰ ä¸–ç•Œä¸€å‘¨é”æˆï¼Amazing! ç´ æ™´ã‚‰ã—ã„å‰æ¥­ã§ã™ï¼");
            mapProgress.world = 0; // ãƒ«ãƒ¼ãƒ—
        }
    }
    
    saveMapData(); // ä¿å­˜ï¼ˆãƒ•ãƒ©ã‚°å«ã‚€ï¼‰
    renderMap();   // å†æç”»
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
// ç”»é¢ãƒªã‚µã‚¤ã‚ºæ™‚ã«å†æç”»ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
window.addEventListener('resize', () => {
    if(isChartLoaded) renderMap();
});

// åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", () => {
    loadMapData(); 
    // Google Chartsã®ãƒ­ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§renderMapãŒå‘¼ã°ã‚Œã¾ã™
});

// ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆæ™‚ã®ä¸Šæ›¸ã
window.completeDailyChallenge = function() {
    if(typeof playSportsDrum === 'function') playSportsDrum();

    const currentData = loadDailyData(); 
    const today = new Date().toLocaleDateString("ja-JP");
    const yesterday = new Date(Date.now() - 86400000).toLocaleDateString("ja-JP");

    if (currentData.lastDate === today) return;

    if (currentData.lastDate === yesterday) {
        currentData.streak++;
    } else {
        currentData.streak = 1;
    }

    currentData.lastDate = today;
    currentData.totalBadges++;

    let alertMsg = "ğŸ–ï¸ ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼";
    if (currentData.streak > 0 && currentData.streak % 7 === 0) {
        currentData.weeklyBadges++;
        alertMsg += "\nğŸ† 1é€±é–“ç¶™ç¶šé”æˆï¼ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒãƒƒã‚¸ç²å¾—ï¼";
        if(typeof playBuzz === 'function') playBuzz(500, 600);
    }

    // é€²è¡Œå‡¦ç†
    saveDailyData(currentData);
    advanceMapProgress();
    updateDailyUI();
    
    const msgEl = document.getElementById("daily-message");
    if(msgEl) msgEl.textContent = "ğŸ‰ ã‚¨ãƒªã‚¢åˆ¶è¦‡ï¼æ¬¡ã®ç›®çš„åœ°ã¸é€²ã¿ã¾ã™ï¼";
};

// ==========================================
// ğŸ”„ æ—¢å­˜é–¢æ•°ã®ä¿®æ­£ãƒ»ä¸Šæ›¸ã
// ==========================================

// åˆæœŸåŒ–æ™‚ã«ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
const originalDOMReady = window.onload; // ã‚‚ã—ã‚ã‚Œã°
document.addEventListener("DOMContentLoaded", () => {
    // æ—¢å­˜ã®å‡¦ç†...
    updateDailyUI();
    
    // â˜…ãƒãƒƒãƒ—åˆæœŸåŒ–
    loadMapData(); 
    renderMap();
});

// ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆæ™‚ã®å‡¦ç†ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆãƒãƒƒãƒ—é€²è¡Œã‚’è¿½åŠ ï¼‰
// â€»æ—¢å­˜ã® completeDailyChallenge é–¢æ•°ã‚’å®Œå…¨ã«ç½®ãæ›ãˆã¾ã™
window.completeDailyChallenge = function() {
    if(typeof playSportsDrum === 'function') playSportsDrum();

    const currentData = loadDailyData(); // Mapãƒ‡ãƒ¼ã‚¿ã‚‚ã“ã“ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹
    const today = new Date().toLocaleDateString("ja-JP");
    const yesterday = new Date(Date.now() - 86400000).toLocaleDateString("ja-JP");

    if (currentData.lastDate === today) return;

    if (currentData.lastDate === yesterday) {
        currentData.streak++;
    } else {
        currentData.streak = 1;
    }

    currentData.lastDate = today;
    currentData.totalBadges++;

    let alertMsg = "ğŸ–ï¸ ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼";

    if (currentData.streak > 0 && currentData.streak % 7 === 0) {
        currentData.weeklyBadges++;
        alertMsg += "\nğŸ† 1é€±é–“ç¶™ç¶šé”æˆï¼ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒãƒƒã‚¸ç²å¾—ï¼";
        if(typeof playBuzz === 'function') playBuzz(500, 600);
    }

    // â˜… ãƒãƒƒãƒ—ã‚’é€²ã‚ã‚‹
    // currentDataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°ã—ã¦ã‹ã‚‰ä¿å­˜ã™ã‚‹æµã‚Œã«ã™ã‚‹ãŸã‚ã€
    // advanceMapProgressã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«çµ±åˆã™ã‚‹ã‹ã€ä¿å­˜å¾Œã«å‘¼ã¶
    saveDailyData(currentData); // ã¾ãšãƒãƒƒã‚¸ç­‰ã‚’ä¿å­˜

    // ãƒãƒƒãƒ—é€²è¡Œï¼ˆå†…éƒ¨ã§å†ä¿å­˜ãƒ»æç”»ï¼‰
    advanceMapProgress();
    
    // UIæ›´æ–°
    updateDailyUI();
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    const msgEl = document.getElementById("daily-message");
    if(msgEl) msgEl.textContent = "ğŸ‰ æ¬¡ã®ç›®çš„åœ°ã¸é€²ã¿ã¾ã—ãŸï¼";
};



// ==========================================
// ğŸ“ ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (ä¿®æ­£ç‰ˆ)
// ==========================================

// ãƒã‚¸ã‚·ãƒ§ãƒ³åº§æ¨™ã®å®šç¾© (ä¿®æ­£: Bãƒãƒ¼ãƒ ã‚’å¯¾è§’ç·šé…ç½®ã«)
/*
  ã€ç”»é¢ä¸Šã®é…ç½®ã€‘
  [ Aãƒãƒ¼ãƒ (å·¦) ]  vs  [ Bãƒãƒ¼ãƒ (å³) ]
  
  ä¸Šå´(25%): A-Odd(å·¦)  /  B-Even(å³)  <-- å¯¾è§’ç·š
  ä¸‹å´(75%): A-Even(å³) /  B-Odd(å·¦)   <-- å¯¾è§’ç·š
  
  â€»ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã®ã‚³ãƒ¼ãƒˆã¯å¯¾è§’ç·šã§å‘ã‹ã„åˆã„ã¾ã™ã€‚
  A(ä¸‹/Even)ã‹ã‚‰æ‰“ã¤ã¨ã€å—ã‘ã‚‹ã®ã¯B(ä¸Š/Even)ã«ãªã‚Šã¾ã™ã€‚
*/
const posMap = {
    // Aãƒãƒ¼ãƒ  (å·¦å´)
    "l-odd":  {t:"25%", l:"35%"}, // ä¸Š (å¥‡æ•°ã‚³ãƒ¼ãƒˆ)
    "l-even": {t:"75%", l:"35%"}, // ä¸‹ (å¶æ•°ã‚³ãƒ¼ãƒˆ)
    // Bãƒãƒ¼ãƒ  (å³å´) - ã“ã“ã‚’ä¿®æ­£
    "r-even": {t:"25%", l:"65%"}, // ä¸Š (å¶æ•°ã‚³ãƒ¼ãƒˆ) â€»Aã®ä¸‹ã¨å¯¾è§’
    "r-odd":  {t:"75%", l:"65%"}  // ä¸‹ (å¥‡æ•°ã‚³ãƒ¼ãƒˆ) â€»Aã®ä¸Šã¨å¯¾è§’
};

// ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿
const scenarioData = [
  // --- Q1: 0-0 ---
  {
    text: "è©¦åˆé–‹å§‹ï¼ã‚¹ã‚³ã‚¢ 0-0ã€‚\nAãƒãƒ¼ãƒ ãŒã‚µãƒ¼ãƒ–æ¨©ã‚’æŒã£ã¦ã„ã¾ã™ã€‚\nA1ã¯ã©ã“ã‹ã‚‰ã€èª°ã«å‘ã‹ã£ã¦æ‰“ã¡ã¾ã™ã‹ï¼Ÿ",
    score: {a:0, b:0},
    // A1(ä¸‹/Even), A2(ä¸Š/Odd) vs B1(ä¸Š/Even), B2(ä¸‹/Odd)
    pos: {A1:"l-even", A2:"l-odd", B1:"r-even", B2:"r-odd"}, 
    shuttlePos: "l-even",
    options: [
      "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã€B2(å·¦/æ­£é¢)ã¸",
      "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã€B1(å³/å¯¾è§’)ã¸", // æ­£è§£
      "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã€B1ã€B2ã©ã¡ã‚‰ã«ã‚‚æ‰“ã£ã¦è‰¯ã„"
    ],
    correctIdx: 1,
    explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\n0ç‚¹ã¯å¶æ•°ãªã®ã§ã€A1ã¯å³(å¶æ•°ã‚³ãƒ¼ãƒˆ/ç”»é¢ä¸‹)ã‹ã‚‰æ‰“ã¡ã¾ã™ã€‚\nãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã¯å¯¾è§’ç·šã®ã‚¨ãƒªã‚¢(ç”»é¢ä¸Š)ã«ã„ã‚‹B1ã§ã™ã€‚"
  },

  // --- Q2: 1-0 (AãŒå¾—ç‚¹) ---
  {
    text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ å¾—ç‚¹ï¼ 1-0ã€‚\nã‚µãƒ¼ãƒãƒ¼å´ãŒå¾—ç‚¹ã—ãŸã®ã§Aã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚\næ¬¡ã¯èª°ãŒã©ã“ã‹ã‚‰ï¼Ÿ",
    score: {a:1, b:0},
    // Aãƒ­ãƒ¼ãƒ†(A1ä¸Šã¸, A2ä¸‹ã¸)ã€‚ Bä¸å‹•(B1ä¸Šã¾ã¾, B2ä¸‹ã¾ã¾)ã€‚
    pos: {A1:"l-odd", A2:"l-even", B1:"r-even", B2:"r-odd"}, 
    shuttlePos: "l-odd",
    options: [
      "A1ãŒå·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã‚µãƒ¼ãƒ–", // æ­£è§£
      "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã‚µãƒ¼ãƒ–",
      "A2ãŒå·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã‚µãƒ¼ãƒ–"
    ],
    correctIdx: 0,
    explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\nA1ã¯å¾—ç‚¹ã—ãŸã®ã§ä½ç½®ã‚’äº¤ä»£(ãƒ­ãƒ¼ãƒ†)ã—ã€1ç‚¹(å¥‡æ•°)ãªã®ã§å·¦(ç”»é¢ä¸Š)ã‹ã‚‰æ‰“ã¡ã¾ã™ã€‚\nâ˜…Bãƒãƒ¼ãƒ ã¯ãƒ¬ã‚·ãƒ¼ãƒ–å´ã ã£ãŸã®ã§å‹•ãã¾ã›ã‚“ã€‚"
  },

  // --- Q3: 1-1 (BãŒå¾—ç‚¹ / ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ) ---
  {
    text: "ã€ãƒ©ãƒªãƒ¼ã€‘Bãƒãƒ¼ãƒ å¾—ç‚¹ï¼ 1-1ã€‚\nã‚µãƒ¼ãƒ–æ¨©ãŒBã¸ç§»ã‚Šã¾ã™(ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ)ã€‚\nèª°ãŒã‚µãƒ¼ãƒ–ã‚’æ‰“ã¡ã¾ã™ã‹ï¼Ÿ",
    score: {a:1, b:1},
    // ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚ã¯èª°ã‚‚å‹•ã‹ãªã„ã€‚ä½ç½®ã¯Q2ã¨åŒã˜ã€‚
    // B1(ä¸Š/Even), B2(ä¸‹/Odd)ã€‚
    pos: {A1:"l-odd", A2:"l-even", B1:"r-even", B2:"r-odd"}, 
    shuttlePos: "r-odd",
    options: [
      "B1ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–",
      "B2ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–", // æ­£è§£
      "ä½ç½®ã‚’äº¤ä»£ã—ã¦B1ãŒå·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰"
    ],
    correctIdx: 1,
    explain: "ãã®é€šã‚Šï¼ğŸ™†â€â™‚ï¸\nã‚µãƒ¼ãƒ–æ¨©ãŒç§»ã‚‹æ™‚ã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã›ã‚“ã€‚\nBã®å¾—ç‚¹ã¯ã€Œ1ç‚¹(å¥‡æ•°)ã€ã§ã™ã€‚\nç¾åœ¨ã€å¥‡æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸‹)ã«ç«‹ã£ã¦ã„ã‚‹ã€B2ã€‘ãŒã‚µãƒ¼ãƒ–æ¨©ã‚’å¾—ã¾ã™ã€‚"
  },

  // --- Q4: 1-2 (BãŒé€£ç¶šå¾—ç‚¹) ---
  {
    text: "ã€ãƒ©ãƒªãƒ¼ã€‘Bãƒãƒ¼ãƒ é€£ç¶šå¾—ç‚¹ï¼ 1-2ã€‚\nBãƒãƒ¼ãƒ ã®å‹•ãã¯ï¼Ÿ",
    score: {a:1, b:2},
    // BãŒã‚µãƒ¼ãƒãƒ¼å´ã§å¾—ç‚¹ã€‚Bã®ã¿ãƒ­ãƒ¼ãƒ†(B1ä¸‹ã¸, B2ä¸Šã¸)ã€‚Aä¸å‹•ã€‚
    pos: {A1:"l-odd", A2:"l-even", B1:"r-odd", B2:"r-even"}, 
    shuttlePos: "r-even",
    options: [
      "B2ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã¸ç§»å‹•ã—ã¦ã‚µãƒ¼ãƒ–", // æ­£è§£
      "B2ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã®ã¾ã¾ã‚µãƒ¼ãƒ–",
      "B1ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–"
    ],
    correctIdx: 0,
    explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\nã‚µãƒ¼ãƒ–å´ãŒå¾—ç‚¹ã—ãŸã®ã§Bãƒãƒ¼ãƒ ã¯ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚\n2ç‚¹(å¶æ•°)ãªã®ã§ã€B2ã¯å¶æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸Š)ã¸ç§»å‹•ã—ã¦æ‰“ã¡ã¾ã™ã€‚"
  },

  // --- Q5: 2-2 (AãŒå¾—ç‚¹ / ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ) ---
  {
    text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ å¾—ç‚¹ï¼ 2-2ã€‚\nã‚µãƒ¼ãƒ–æ¨©ãŒAã«æˆ»ã‚Šã¾ã—ãŸã€‚\nèª°ãŒã©ã“ã‹ã‚‰ï¼Ÿ",
    score: {a:2, b:2},
    // ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã€‚èª°ã‚‚å‹•ã‹ãªã„ã€‚ä½ç½®ã¯Q4ã¨åŒã˜ã€‚
    // A1(ä¸Š/Odd), A2(ä¸‹/Even)ã€‚
    pos: {A1:"l-odd", A2:"l-even", B1:"r-odd", B2:"r-even"},
    shuttlePos: "l-even",
    options: [
      "A1ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–",
      "A2ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–", // æ­£è§£
      "ãƒ­ãƒ¼ãƒ†ã—ã¦A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰"
    ],
    correctIdx: 1,
    explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\nã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆãªã®ã§ä½ç½®ã¯ãã®ã¾ã¾ã€‚\nAã®å¾—ç‚¹ã¯ã€Œ2ç‚¹(å¶æ•°)ã€ã§ã™ã€‚\nç¾åœ¨ã€å¶æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸‹)ã«ã„ã‚‹ã€A2ã€‘ãŒã‚µãƒ¼ãƒ–æ¨©ã‚’å¾—ã¾ã™ã€‚"
  },

  // --- Q6: 3-2 (AãŒé€£ç¶šå¾—ç‚¹) ---
  {
    text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ é€†è»¢ï¼ 3-2ã€‚\nAãƒãƒ¼ãƒ ã¯ã©ã†å‹•ãï¼Ÿ",
    score: {a:3, b:2},
    // Aã®ã¿ãƒ­ãƒ¼ãƒ†(A1ä¸‹ã¸, A2ä¸Šã¸)ã€‚
    pos: {A1:"l-even", A2:"l-odd", B1:"r-odd", B2:"r-even"},
    shuttlePos: "l-odd",
    options: [
      "A2ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã¸ç§»å‹•ã—ã¦ã‚µãƒ¼ãƒ–", // æ­£è§£
      "A2ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã®ã¾ã¾ã‚µãƒ¼ãƒ–",
      "A1ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã¸ç§»å‹•ã—ã¦ã‚µãƒ¼ãƒ–"
    ],
    correctIdx: 0,
    explain: "ãã®é€šã‚Šï¼ğŸ™†â€â™‚ï¸\nã‚µãƒ¼ãƒãƒ¼å´ãŒå¾—ç‚¹ã—ãŸã®ã§Aã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚\n3ç‚¹(å¥‡æ•°)ãªã®ã§ã€A2ã¯å¥‡æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸Š)ã¸ç§»å‹•ã—ã¦æ‰“ã¡ã¾ã™ã€‚"
  },

  // --- Q7: 5-2 (AãŒé€£å–ã—ã¦è©¦åˆçµ‚äº†) ---
  {
    text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ ãŒå¾—ç‚¹ã‚’é‡ã­ 5-2 ã§å‹åˆ©ï¼(5ç‚¹ãƒãƒƒãƒ)\næœ€å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ï¼Ÿ",
    score: {a:5, b:2},
    // è©¦åˆçµ‚äº†ã€‚
    pos: {A1:"l-even", A2:"l-odd", B1:"r-odd", B2:"r-even"},
    shuttlePos: "l-odd",
    options: [
      "ç›¸äº’ã«æ¡æ‰‹ã—ã¦çµ‚äº†", // æ­£è§£
      "ã‚µãƒ¼ãƒ–æ¨©ç§»å‹•ã‚’ç¢ºèª",
      "ã¾ã çµ‚ã‚ã£ã¦ã„ãªã„"
    ],
    correctIdx: 0,
    explain: "ã‚²ãƒ¼ãƒ ã‚»ãƒƒãƒˆï¼ğŸ‰\nAãƒãƒ¼ãƒ ã®å‹åˆ©ã§ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼\n(â€»å®Ÿéš›ã®è©¦åˆã§ã¯21ç‚¹ã§ã™ãŒã€ä»Šå›ã¯çŸ­ç¸®ç‰ˆã§ã—ãŸ)"
  }
];

let currentStepIndex = 0;

// åˆæœŸåŒ–
function initSimulation() {
  currentStepIndex = 0;
  renderStep(0);
}

// ã‚¹ãƒ†ãƒƒãƒ—æç”»
function renderStep(index) {
  const data = scenarioData[index];
  
  // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
  document.getElementById("scenario-text").textContent = data.text;
  document.getElementById("sim-score-a").textContent = data.score.a;
  document.getElementById("sim-score-b").textContent = data.score.b;
  document.getElementById("sim-explanation").style.display = "none";
  
  // ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚’éš ã™
  const nextBtn = document.getElementById("btn-next-step");
  nextBtn.style.display = "none";
  nextBtn.textContent = "æ¬¡ã®å•é¡Œã¸ â–¶";

  // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
  const optContainer = document.getElementById("sim-options-container");
  optContainer.innerHTML = ""; 

  data.options.forEach((optText, i) => {
    const btn = document.createElement("button");
    btn.textContent = optText;
    btn.style.cssText = "width:100%; padding:10px; border:1px solid #ccc; background:#fff; color:#333; border-radius:6px; cursor:pointer; text-align:left; font-size:14px; transition:background 0.2s; margin-bottom:5px;";
    btn.onclick = () => checkSimulationAnswer(i, btn, data);
    optContainer.appendChild(btn);
  });

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é…ç½®ï¼ˆCSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§ç§»å‹•ï¼‰
  moveSimPlayer("p-A1", posMap[data.pos.A1]);
  moveSimPlayer("p-A2", posMap[data.pos.A2]);
  moveSimPlayer("p-B1", posMap[data.pos.B1]);
  moveSimPlayer("p-B2", posMap[data.pos.B2]);

  // ã‚·ãƒ£ãƒˆãƒ«ã®ä½ç½®ï¼ˆã‚µãƒ¼ãƒ–æ¨©ã®ã‚ã‚‹å ´æ‰€ï¼‰
  const shuttleEl = document.getElementById("sim-shuttle");
  if(data.shuttlePos) {
      const sPos = posMap[data.shuttlePos];
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å°‘ã—æ¨ªã«é…ç½®
      shuttleEl.style.display = "block";
      shuttleEl.style.top = `calc(${sPos.t} - 5px)`;
      shuttleEl.style.left = sPos.l;
  } else {
      shuttleEl.style.display = "none";
  }
  
  // ã‚¨ãƒªã‚¢ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll(".c-cell").forEach(el=>el.style.background="transparent");
}

function moveSimPlayer(id, coords) {
  const el = document.getElementById(id);
  el.style.position = "absolute";
  el.style.transition = "all 0.6s cubic-bezier(0.22, 1, 0.36, 1)"; // æ»‘ã‚‰ã‹ãªç§»å‹•
  el.style.top = coords.t;
  el.style.left = coords.l;
  el.style.transform = "translate(-50%, -50%)";
}

// æ­£èª¤åˆ¤å®š
function checkSimulationAnswer(selectedIndex, btnElement, data) {
  const isCorrect = (selectedIndex === data.correctIdx);
  const allBtns = document.querySelectorAll("#sim-options-container button");

  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  allBtns.forEach(b => b.disabled = true);

  if (isCorrect) {
    // æ­£è§£æ¼”å‡º
    btnElement.style.background = "#d4edda"; 
    btnElement.style.borderColor = "#28a745";
    btnElement.textContent += " âœ…";
    if(typeof playSportsDrum === 'function') playSportsDrum();

    // è§£èª¬è¡¨ç¤º
    document.getElementById("sim-explanation-text").textContent = data.explain;
    document.getElementById("sim-explanation").style.display = "block";
    document.getElementById("sim-explanation").style.borderLeftColor = "#4caf50";

    // æ¬¡ã¸ãƒœã‚¿ãƒ³è¡¨ç¤º
    const nextBtn = document.getElementById("btn-next-step");
    nextBtn.style.display = "inline-block";

  } else {
    // ä¸æ­£è§£æ¼”å‡º
    btnElement.style.background = "#ffebee"; 
    btnElement.style.borderColor = "#d32f2f";
    btnElement.textContent += " âŒ";
    if(typeof playBuzz === 'function') playBuzz(200, 150);

    // æ­£è§£ã®ãƒœã‚¿ãƒ³ã‚’æ•™ãˆã¦ã‚ã’ã‚‹
    allBtns[data.correctIdx].style.background = "#d4edda";
    allBtns[data.correctIdx].textContent += " (æ­£è§£)";
    
    // è§£èª¬è¡¨ç¤º
    document.getElementById("sim-explanation-text").textContent = "æ®‹å¿µï¼æ­£è§£ã¯...\n" + data.explain;
    document.getElementById("sim-explanation").style.display = "block";
    document.getElementById("sim-explanation").style.borderLeftColor = "#d32f2f"; 

    // æ¬¡ã¸ãƒœã‚¿ãƒ³è¡¨ç¤º
    const nextBtn = document.getElementById("btn-next-step");
    nextBtn.style.display = "inline-block";
  }
}

// æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
function nextStep() {
  if (currentStepIndex < scenarioData.length - 1) {
    currentStepIndex++;
    renderStep(currentStepIndex);
  } else {
    // çµ‚äº†æ™‚
    if(confirm("å…¨å•çµ‚äº†ã§ã™ï¼æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
        initSimulation();
    }
  }
}

function prevStep() {
  if (currentStepIndex > 0) {
    currentStepIndex--;
    renderStep(currentStepIndex);
  }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener("DOMContentLoaded", initSimulation);

</script>

<script>
// ==========================================
// ğŸ¤– MediaPipe Pose + ğŸ’ª å…¨èº«ãƒˆãƒ«ã‚¯å¯è¦–åŒ– (ãƒãƒªã‚´ãƒ³/ã‚¹ã‚±ãƒ«ãƒˆãƒ³åˆ‡æ›¿ç‰ˆ)
// ==========================================

const videoElement = document.getElementById('input_video');
const canvasElement = document.getElementById('output_canvas');
const canvasCtx = canvasElement ? canvasElement.getContext('2d') : null;

// ğŸ“ˆ ã‚°ãƒ©ãƒ•è¨­å®š
const MAX_GRAPH_POINTS = 300;
const graphConfigs = {
    r_elbow:    { id: 'graph_r_elbow',    color: '#4fc3f7', max: 60 },
    r_shoulder: { id: 'graph_r_shoulder', color: '#ff8a65', max: 100 },
    r_knee:     { id: 'graph_r_knee',     color: '#66bb6a', max: 250 },
    l_elbow:    { id: 'graph_l_elbow',    color: '#80d8ff', max: 60 },
    l_shoulder: { id: 'graph_l_shoulder', color: '#ffcc80', max: 100 },
    l_knee:     { id: 'graph_l_knee',     color: '#a5d6a7', max: 250 },
    trunk:      { id: 'graph_trunk',      color: '#fdd835', max: 150 }
};

const graphContexts = {};
Object.keys(graphConfigs).forEach(key => {
    const cvs = document.getElementById(graphConfigs[key].id);
    if (cvs) graphContexts[key] = cvs.getContext('2d');
});

let graphData = { r_elbow: [], r_shoulder: [], r_knee: [], l_elbow: [], l_shoulder: [], l_knee: [], trunk: [] };
let maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };

let pose;
let camera;
let animationId;
let isCameraRunning = false;
let currentFacingMode = 'user';

// ğŸ¥ éŒ²ç”»ç”¨
let mediaRecorder;
let recordedChunks = [];
let selectedMimeType = "";
let recordedCSVData = [];
let recordingStartTime = 0;

// ğŸ¨ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç®¡ç†
let isBackgroundVisible = true;


window.toggleBackground = function() {
    const cb = document.getElementById('bg-toggle');
    if(cb) isBackgroundVisible = cb.checked;
}

// 1. PoseåˆæœŸåŒ–
function initPose() {
    if (pose) return; 
    pose = new Pose({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }});
    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        smoothSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    pose.onResults(onPoseResults);
}

// 2. çµæœå‡¦ç† (ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—)
function onPoseResults(results) {
    if (!results.poseLandmarks || !canvasCtx) return;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
    canvasElement.width = videoElement.videoWidth || 640;
    canvasElement.height = videoElement.videoHeight || 480;

    canvasCtx.save();
    
    // ------------------------------------------------
    // 1. èƒŒæ™¯ã®æç”»å‡¦ç†
    // ------------------------------------------------
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    if (isBackgroundVisible) {
        // èƒŒæ™¯ON: ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’æç”»
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        // ãƒãƒªã‚´ãƒ³ãƒ¢ãƒ¼ãƒ‰ãªã®ã§ã€ç™ºå…‰ã‚’ç›®ç«‹ãŸã›ã‚‹ãŸã‚ã«å°‘ã—æš—ãã™ã‚‹
        canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
    } else {
        // èƒŒæ™¯OFF: çœŸã£é»’ã«ã™ã‚‹
        canvasCtx.fillStyle = '#000000';
        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
    }

    const lm = results.poseLandmarks;
    
    // ------------------------------------------------
    // 2. è² è·(ãƒˆãƒ«ã‚¯)ã®è¨ˆç®—å‡¦ç†
    // ------------------------------------------------
    // å³å´
    const visR = (lm[12].visibility + lm[14].visibility + lm[24].visibility + lm[26].visibility) / 4;
    let torqueR = { shoulder: 0, elbow: 0, knee: 0 };
    if (visR > 0.5) {
        const angElbowR    = calculateAngle(lm[12], lm[14], lm[16]);
        const angShoulderR = calculateAngle(lm[24], lm[12], lm[14]);
        const angKneeR     = calculateAngle(lm[24], lm[26], lm[28]);
        
        const midShoulder = { x: (lm[12].x + lm[11].x)/2, y: (lm[12].y + lm[11].y)/2 };
        const midHip      = { x: (lm[24].x + lm[23].x)/2, y: (lm[24].y + lm[23].y)/2 };
        const verticalPt  = { x: midHip.x, y: midHip.y - 0.5 };
        const angTrunk    = calculateAngle(verticalPt, midHip, midShoulder);

        torqueR = calculateFullBodyTorque(angShoulderR, angElbowR, angKneeR, angTrunk);
        updateMaxAndDrawVisual('r', lm, torqueR, {e:angElbowR, s:angShoulderR, k:angKneeR});
    }

    // å·¦å´
    const visL = (lm[11].visibility + lm[13].visibility + lm[23].visibility + lm[25].visibility) / 4;
    let torqueL = { shoulder: 0, elbow: 0, knee: 0 };
    if (visL > 0.5) {
        const angElbowL    = calculateAngle(lm[11], lm[13], lm[15]);
        const angShoulderL = calculateAngle(lm[23], lm[11], lm[13]);
        const angKneeL     = calculateAngle(lm[23], lm[25], lm[27]);
        
        torqueL = calculateFullBodyTorque(angShoulderL, angElbowL, angKneeL, 0); 
        updateMaxAndDrawVisual('l', lm, torqueL, {e:angElbowL, s:angShoulderL, k:angKneeL});
    }

    // ä½“å¹¹è² è·
    let valTrunk = 0;
    if (visR > 0.5 || visL > 0.5) {
        const midShoulder = { x: (lm[12].x + lm[11].x)/2, y: (lm[12].y + lm[11].y)/2 };
        const midHip      = { x: (lm[24].x + lm[23].x)/2, y: (lm[24].y + lm[23].y)/2 };
        const verticalPt  = { x: midHip.x, y: midHip.y - 0.5 };
        const angTrunk    = calculateAngle(verticalPt, midHip, midShoulder);
        const tData = calculateFullBodyTorque(0, 0, 0, angTrunk);
        valTrunk = tData.trunk;
        if (valTrunk > maxTorqueValues.trunk) maxTorqueValues.trunk = valTrunk;
        
        setText("val-trunk", Math.round(angTrunk));
        setText("max-trunk-t", maxTorqueValues.trunk.toFixed(1));
    }

    // ------------------------------------------------
    // 3. æç”»ãƒ¢ãƒ¼ãƒ‰ (ãƒãƒªã‚´ãƒ³ã®ã¿ã«å›ºå®š)
    // ------------------------------------------------
    
    // ===================================
    // ğŸ’  ãƒãƒªã‚´ãƒ³ãƒ¢ãƒ¼ãƒ‰æç”»
    // ===================================
    
    // èƒ´ä½“ã‚’é¢ã§å¡—ã‚‹
    drawPolygonBody(lm);

    // ç­‹è‚‰ (ç¬¬5å¼•æ•°ã‚’ true ã«ã™ã‚‹ = å¤ªãå…‰ã‚‹)
    // å³å´
    drawDynamicMuscle(lm[12], lm[14], torqueR.elbow, 60, true);
    drawDynamicMuscle(lm[14], lm[16], 0, 100, true);
    drawDynamicMuscle(lm[24], lm[26], torqueR.knee, 250, true);
    drawDynamicMuscle(lm[26], lm[28], 0, 100, true);
    // å·¦å´
    drawDynamicMuscle(lm[11], lm[13], torqueL.elbow, 60, true);
    drawDynamicMuscle(lm[13], lm[15], 0, 100, true);
    drawDynamicMuscle(lm[23], lm[25], torqueL.knee, 250, true);
    drawDynamicMuscle(lm[25], lm[27], 0, 100, true);
    
    // ä½“å¹¹
    if(visR > 0.5 || visL > 0.5) {
            const midShoulder = { x: (lm[12].x + lm[11].x)/2, y: (lm[12].y + lm[11].y)/2 };
            const midHip      = { x: (lm[24].x + lm[23].x)/2, y: (lm[24].y + lm[23].y)/2 };
            drawDynamicMuscle(midShoulder, midHip, valTrunk, 150, true);
    }
    
    // é–¢ç¯€ (ç¬¬2å¼•æ•°ã‚’ true = ãƒªãƒƒãƒãªãƒªãƒ³ã‚°)
    drawJoints(lm, true);

    // ------------------------------------------------
    // 4. ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ã¨ã‚°ãƒ©ãƒ•æ›´æ–°
    // ------------------------------------------------
    updateAllGraphData(torqueR, torqueL, valTrunk);
    drawAllGraphs();
    
    if (mediaRecorder && mediaRecorder.state === "recording") {
        const elapsed = (Date.now() - recordingStartTime) / 1000;
        recordedCSVData.push({
            time: elapsed.toFixed(2),
            r_elbow: torqueR.elbow.toFixed(1), r_shoulder: torqueR.shoulder.toFixed(1), r_knee: torqueR.knee.toFixed(1),
            l_elbow: torqueL.elbow.toFixed(1), l_shoulder: torqueL.shoulder.toFixed(1), l_knee: torqueL.knee.toFixed(1),
            trunk: valTrunk.toFixed(1)
        });
    }

    canvasCtx.restore();
}

// --- ğŸ”· ãƒãƒªã‚´ãƒ³ï¼ˆé¢ï¼‰æç”» ---
function drawPolygonBody(lm) {
    if (!canvasCtx) return;
    const w = canvasElement.width;
    const h = canvasElement.height;

    // èƒ´ä½“
    canvasCtx.beginPath();
    canvasCtx.moveTo(lm[11].x * w, lm[11].y * h);
    canvasCtx.lineTo(lm[12].x * w, lm[12].y * h);
    canvasCtx.lineTo(lm[24].x * w, lm[24].y * h);
    canvasCtx.lineTo(lm[23].x * w, lm[23].y * h);
    canvasCtx.closePath();

    canvasCtx.fillStyle = 'rgba(0, 191, 255, 0.15)';
    canvasCtx.fill();
    canvasCtx.strokeStyle = 'rgba(0, 191, 255, 0.8)';
    canvasCtx.lineWidth = 2;
    canvasCtx.stroke();

    // é¡”
    canvasCtx.beginPath();
    canvasCtx.moveTo(lm[0].x * w, lm[0].y * h);
    canvasCtx.lineTo(lm[7].x * w, lm[7].y * h);
    canvasCtx.lineTo(lm[8].x * w, lm[8].y * h);
    canvasCtx.closePath();
    canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
    canvasCtx.fill();
}

// --- ğŸ’ª ç­‹è‚‰æç”» (ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) ---
function drawDynamicMuscle(startPt, endPt, torque, maxVal, isPolygon) {
    if (!startPt || !endPt || !canvasCtx) return;

    let intensity = torque / maxVal;
    if (intensity > 1) intensity = 1;
    if (intensity < 0) intensity = 0;

    let r, g, b;
    if (intensity < 0.5) {
        r = 0; g = 255; b = Math.round(255 * (1 - intensity * 2));
    } else {
        r = Math.round(255 * (intensity - 0.5) * 2); g = Math.round(255 * (1 - (intensity - 0.5) * 2)); b = 0;
    }

    const startX = startPt.x * canvasElement.width;
    const startY = startPt.y * canvasElement.height;
    const endX = endPt.x * canvasElement.width;
    const endY = endPt.y * canvasElement.height;

    canvasCtx.beginPath();
    canvasCtx.moveTo(startX, startY);
    canvasCtx.lineTo(endX, endY);
    canvasCtx.lineCap = "round";

    if (isPolygon) {
        // ğŸ’  ãƒãƒªã‚´ãƒ³ãƒ¢ãƒ¼ãƒ‰: å¤ªãã¦å…‰ã‚‹
        canvasCtx.lineWidth = 6 + (intensity * 14); 
        canvasCtx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.8)`;
        canvasCtx.shadowBlur = 10 + (intensity * 20);
        canvasCtx.shadowColor = `rgb(${r}, ${g}, ${b})`;
        canvasCtx.stroke();
        canvasCtx.shadowBlur = 0; 

        // ç™½ã„èŠ¯
        canvasCtx.beginPath();
        canvasCtx.moveTo(startX, startY);
        canvasCtx.lineTo(endX, endY);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = "rgba(255, 255, 255, 0.7)";
        canvasCtx.stroke();
    } else {
        // ğŸ¦´ ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ¢ãƒ¼ãƒ‰: ç´°ãã¦ã‚·ãƒ³ãƒ—ãƒ«
        canvasCtx.lineWidth = 4; 
        canvasCtx.strokeStyle = `rgb(${r}, ${g}, ${b})`;
        canvasCtx.shadowBlur = 0;
        canvasCtx.stroke();
    }
}

// --- âšª ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆæç”» (ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) ---
function drawJoints(lm, isPolygon) {
    if (!canvasCtx) return;
    const w = canvasElement.width;
    const h = canvasElement.height;
    const joints = [11, 12, 13, 14, 23, 24, 25, 26];

    joints.forEach(idx => {
        const p = lm[idx];
        const cx = p.x * w;
        const cy = p.y * h;

        canvasCtx.fillStyle = "#ffffff";
        if (isPolygon) {
            canvasCtx.beginPath(); canvasCtx.arc(cx, cy, 5, 0, Math.PI * 2); canvasCtx.fill();
            canvasCtx.beginPath(); canvasCtx.arc(cx, cy, 8, 0, Math.PI * 2);
            canvasCtx.strokeStyle = "rgba(0, 191, 255, 0.8)";
            canvasCtx.lineWidth = 2;
            canvasCtx.stroke();
        } else {
            canvasCtx.beginPath(); canvasCtx.arc(cx, cy, 6, 0, Math.PI * 2); canvasCtx.fill();
            canvasCtx.strokeStyle = "#333";
            canvasCtx.lineWidth = 1;
            canvasCtx.stroke();
        }
    });
}

// --- ğŸ¦´ ã‚·ãƒ³ãƒ—ãƒ«æ¥ç¶šç·š ---
function drawSimpleConnector(p1, p2) {
    if (!p1 || !p2 || !canvasCtx) return;
    const w = canvasElement.width;
    const h = canvasElement.height;
    canvasCtx.beginPath();
    canvasCtx.moveTo(p1.x * w, p1.y * h);
    canvasCtx.lineTo(p2.x * w, p2.y * h);
    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = "white";
    canvasCtx.stroke();
}

// --- ä»¥ä¸‹ã€æ—¢å­˜ã®è¨ˆç®—ãƒ»åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ ---

function updateMaxAndDrawVisual(side, lm, tData, angles) {
    const p_shoulder = (side==='r') ? lm[12] : lm[11];
    const p_elbow    = (side==='r') ? lm[14] : lm[13];
    const p_knee     = (side==='r') ? lm[26] : lm[25];
    
    const keyS = side + '_shoulder';
    const keyE = side + '_elbow';
    const keyK = side + '_knee';
    
    if (tData.shoulder > maxTorqueValues[keyS]) maxTorqueValues[keyS] = tData.shoulder;
    if (tData.elbow > maxTorqueValues[keyE])    maxTorqueValues[keyE] = tData.elbow;
    if (tData.knee > maxTorqueValues[keyK])     maxTorqueValues[keyK] = tData.knee;

     // Elbow=60, Shoulder=100, Knee=250 ã‚’åŸºæº–(100%)ã¨ã—ã¾ã™
    drawTorqueVisual(p_shoulder, tData.shoulder, "", angles.s, 100);
    drawTorqueVisual(p_elbow, tData.elbow, "", angles.e, 60);
    drawTorqueVisual(p_knee, tData.knee, "", angles.k, 250); 
        
    if (side === 'r') {
        setText("val-r-elbow", Math.round(angles.e));
        setText("max-r-elbow-t", maxTorqueValues.r_elbow.toFixed(1));
        setText("val-r-shoulder", Math.round(angles.s));
        setText("max-r-shoulder-t", maxTorqueValues.r_shoulder.toFixed(1));
        setText("val-r-knee", Math.round(angles.k));
        setText("max-r-knee-t", maxTorqueValues.r_knee.toFixed(1));
    }
}

function updateAllGraphData(tR, tL, tTrunk) {
    const pushVal = (arr, val) => {
        arr.push(val);
        if (arr.length > MAX_GRAPH_POINTS) arr.shift();
    };
    pushVal(graphData.r_elbow, tR.elbow);
    pushVal(graphData.r_shoulder, tR.shoulder);
    pushVal(graphData.r_knee, tR.knee);
    pushVal(graphData.l_elbow, tL.elbow);
    pushVal(graphData.l_shoulder, tL.shoulder);
    pushVal(graphData.l_knee, tL.knee);
    pushVal(graphData.trunk, tTrunk);
}

function resetGraphData() {
    Object.keys(graphData).forEach(k => graphData[k] = []);
    maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };
    Object.keys(graphContexts).forEach(key => {
        const ctx = graphContexts[key];
        if(ctx) ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    });
}

function drawAllGraphs() {
    Object.keys(graphConfigs).forEach(key => {
        drawSingleGraph(key, graphData[key]);
    });
}

function drawSingleGraph(key, dataArr) {
    const ctx = graphContexts[key];
    if (!ctx) return;
    const config = graphConfigs[key];
    const W = ctx.canvas.width;
    const H = ctx.canvas.height;
    const maxVal = config.max;

    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, W, H);
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1;
    ctx.fillStyle = "#aaa";
    ctx.font = "10px sans-serif";
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";

    [0, 0.5, 1].forEach(ratio => {
        const y = H - (ratio * H);
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
        if (ratio > 0) {
            const val = Math.round(maxVal * ratio);
            ctx.fillText(val + "", W - 5, y + 6);
        }
    });

    if (dataArr.length < 2) return;
    ctx.beginPath();
    ctx.strokeStyle = config.color;
    ctx.lineWidth = 2;

    for (let i = 0; i < dataArr.length; i++) {
        const x = (i / MAX_GRAPH_POINTS) * W;
        let val = dataArr[i];
        if (val > maxVal) val = maxVal; 
        const y = H - (val / maxVal * H);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.stroke();

    const currentVal = dataArr[dataArr.length - 1];
    if (currentVal !== undefined) {
        ctx.fillStyle = config.color;
        ctx.font = "bold 12px sans-serif";
        ctx.textAlign = "left";
        ctx.fillText(currentVal.toFixed(1) + " Nm", 5, 15);
    }
}

function setText(id, val) {
    const el = document.getElementById(id);
    if(el) el.textContent = val;
}

function calculateFullBodyTorque(angShoulder, angElbow, angKnee, angTrunk) {
    const elH = document.getElementById("bio-height");
    const elW = document.getElementById("bio-weight");
    const elR = document.getElementById("bio-racket");
    const H = elH ? (parseFloat(elH.value) || 170) : 170; 
    const W = elW ? (parseFloat(elW.value) || 65) : 65;  
    const R_mass = elR ? ((parseFloat(elR.value) || 85) / 1000) : 0.085;
    const g = 9.81;
    const H_m = H / 100;
    const L_upper = 0.186 * H_m; 
    const L_fore  = 0.146 * H_m;
    const L_trunk = 0.3 * H_m; 
    const M_arm = 0.05 * W; 
    const M_upper_body = 0.6 * W; 
    const M_body_above_knee = 0.85 * W; 

    const radT = angTrunk * (Math.PI / 180);
    const kneeFlexFactor = Math.abs(Math.sin((180 - angKnee) * (Math.PI / 180)));
    const factorS = Math.abs(Math.sin(angShoulder * Math.PI / 180)); 
    
    const t_elbow = (2.0 + R_mass) * g * L_fore * Math.sin(angElbow * Math.PI / 180); 
    const t_shoulder = (M_arm + R_mass) * g * L_upper * factorS + t_elbow;
    const t_trunk = M_upper_body * g * (L_trunk * 0.5) * Math.sin(radT);
    const momentArmKnee = (H_m * 0.25) * kneeFlexFactor; 
    const t_knee = M_body_above_knee * g * momentArmKnee;

    return { shoulder: Math.abs(t_shoulder), elbow: Math.abs(t_elbow), trunk: Math.abs(t_trunk), knee: Math.abs(t_knee) };
}

function drawTorqueVisual(point, torque, label, angle, maxVal) {
    if(!point || !canvasCtx) return;
    const x = point.x * canvasElement.width;
    const y = point.y * canvasElement.height;
    
    // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: ãƒãƒ–ãƒ«ã‚µã‚¤ã‚ºã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ â–¼â–¼â–¼
    
    // åŸºæº–å€¤ï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°100ï¼‰
    const limit = maxVal || 100;
    // ç”»é¢ä¸Šã®ãƒãƒ–ãƒ«ã®æœ€å¤§åŠå¾„(px)
    const maxRadiusPixel = 120; 

    // ã€Œç¾åœ¨ã®ãƒˆãƒ«ã‚¯ / åŸºæº–å€¤ã€ã®å‰²åˆã§å¤§ãã•ã‚’æ±ºã‚ã‚‹
    let radius = (torque / limit) * maxRadiusPixel;

    // æœ€å°ã‚µã‚¤ã‚ºã¨æœ€å¤§ã‚µã‚¤ã‚ºã®åˆ¶é™
    if (radius < 5) radius = 5; 
    if (radius > maxRadiusPixel) radius = maxRadiusPixel;
    
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    const gradient = canvasCtx.createRadialGradient(x, y, radius * 0.1, x, y, radius);
    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
    gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0.0)');
    canvasCtx.beginPath();
    canvasCtx.arc(x, y, radius, 0, 2 * Math.PI);
    canvasCtx.fillStyle = gradient;
    canvasCtx.fill();
}

function calculateAngle(a, b, c) {
    if(!a || !b || !c) return 0;
    const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
    let angle = Math.abs(radians * 180.0 / Math.PI);
    if (angle > 180.0) angle = 360 - angle;
    return angle;
}

// 4. ã‚«ãƒ¡ãƒ© & ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function startCamera() {
    initPose();
    stopTracking(); 
    resetGraphData(); 
    
    recordedCSVData = [];
    recordingStartTime = Date.now();
    maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };

    const constraints = {
        video: {
            facingMode: currentFacingMode,
            width: { ideal: 640 }, height: { ideal: 480 },
            frameRate: { ideal: 30, max: 30 }
        },
        audio: false
    };
    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;
        videoElement.style.display = "none"; 
        videoElement.onloadedmetadata = () => {
            videoElement.play();
            isCameraRunning = true;
            processCameraFrame(); 
        };
        const btnStart = document.getElementById("btn-record-start");
        if(btnStart) btnStart.style.display = "inline-block";
    } catch (err) {
        console.error("Camera Error:", err);
        alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}

function toggleCamera() {
    currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
    if (isCameraRunning) startCamera();
    else alert("ã‚«ãƒ¡ãƒ©èµ·å‹•æ™‚ã«å‘ããŒå¤‰æ›´ã•ã‚Œã¾ã™");
}

function processCameraFrame() {
    if (!isCameraRunning) return;
    pose.send({image: videoElement}).then(() => {
        if (isCameraRunning) animationId = requestAnimationFrame(processCameraFrame);
    });
}

function handleVideoUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // åˆæœŸåŒ–å‡¦ç†
    initPose();
    stopTracking(); 
    resetGraphData(); 
    
    recordedCSVData = [];
    recordingStartTime = Date.now();
    maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };

    // æ“ä½œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    const ctrls = document.getElementById("pose-video-controls");
    if(ctrls) ctrls.style.display = "flex";

    const url = URL.createObjectURL(file);
    videoElement.srcObject = null; 
    videoElement.src = url;
    
    // å‹•ç”»è¦ç´ ã®è¨­å®šï¼ˆéè¡¨ç¤ºã«ã—ã¦ãŠãï¼‰
    videoElement.style.display = "block";
    videoElement.style.position = "absolute";
    videoElement.style.width = "1px";
    videoElement.style.height = "1px";
    videoElement.style.opacity = "0";
    videoElement.style.zIndex = "-1";

    videoElement.muted = true;
    videoElement.playsInline = true;
    videoElement.setAttribute('playsinline', ''); 
    
    videoElement.onloadeddata = () => {
        // ã¾ãšä¸€æ™‚åœæ­¢ã—ã€å…ˆé ­ã¸ã‚·ãƒ¼ã‚¯
        videoElement.pause();
        videoElement.currentTime = 0; 
        isCameraRunning = false;
    };

    videoElement.onseeked = () => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        if (canvasCtx) {
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        }

        setTimeout(() => {
             if(pose) pose.send({image: videoElement});
        }, 100);
    };
    
    const btn = document.getElementById("btn-record-start");
    if(btn) btn.style.display = "inline-block";
    
    input.value = '';
}

function processVideoFrame() {
    if (videoElement.paused || videoElement.ended) return;
    pose.send({image: videoElement}).then(() => {
        if (!videoElement.paused && !videoElement.ended) {
            if ('requestVideoFrameCallback' in videoElement) videoElement.requestVideoFrameCallback(processVideoFrame);
            else animationId = requestAnimationFrame(processVideoFrame);
        }
    });
}

function stopTracking() {
    isCameraRunning = false; 
    if (animationId) cancelAnimationFrame(animationId);
    if (videoElement.srcObject) {
        videoElement.srcObject.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
    }
    if (videoElement.src) {
        videoElement.pause();
        videoElement.removeAttribute('src'); // srcå±æ€§ã‚’å‰Šé™¤
        videoElement.load();
    }
    stopRecording(); 
    if(canvasCtx) canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    
    const btnStart = document.getElementById("btn-record-start");
    const btnStop = document.getElementById("btn-record-stop");
    if(btnStart) btnStart.style.display = "none";
    if(btnStop) btnStop.style.display = "none";

    // â˜…è¿½åŠ : å‹•ç”»æ“ä½œãƒœã‚¿ãƒ³ã‚’éš ã™
    const ctrls = document.getElementById("pose-video-controls");
    if(ctrls) ctrls.style.display = "none";
}

// ğŸ¥ éŒ²ç”»æ©Ÿèƒ½
function startRecording() {
    if(!canvasElement) return;
    const stream = canvasElement.captureStream(30); 
    recordedChunks = [];
    
    recordedCSVData = [];
    recordingStartTime = Date.now();

    // â˜…è¿½åŠ : CSVãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    const btnCsv = document.getElementById("btn-pose-csv");
    if (btnCsv) {
        btnCsv.disabled = true;
        btnCsv.style.background = "#ccc";
        btnCsv.style.cursor = "not-allowed";
    }

    const mimeTypes = ["video/mp4", "video/webkit", "video/webm;codecs=vp9", "video/webm"];
    selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
    if (!selectedMimeType) { alert("éŒ²ç”»éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™"); return; }

    const options = { mimeType: selectedMimeType };
    try { options.videoBitsPerSecond = 2500000; } catch (e) {}

    try {
        mediaRecorder = new MediaRecorder(stream, options);
    } catch (e) { alert("éŒ²ç”»åˆæœŸåŒ–å¤±æ•—"); return; }

    mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) recordedChunks.push(event.data);
    };
    mediaRecorder.onstop = saveVideo;
    mediaRecorder.start(); 
    
    const btnStart = document.getElementById("btn-record-start");
    const btnStop = document.getElementById("btn-record-stop");
    if(btnStart) btnStart.style.display = "none";
    if(btnStop) btnStop.style.display = "inline-block";
    
    const overlay = document.getElementById("pose-data-overlay");
    if(overlay && overlay.parentElement) {
        const recIndicator = document.createElement("div");
        recIndicator.id = "rec-indicator";
        recIndicator.style.cssText = "position:absolute; top:10px; right:10px; color:red; font-weight:bold; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:4px; animation: blink 1s infinite; z-index:100;";
        recIndicator.textContent = "â— REC";
        overlay.parentElement.appendChild(recIndicator);
        if(!document.getElementById('blink-style')) {
            const style = document.createElement('style');
            style.id = 'blink-style';
            style.innerHTML = `@keyframes blink { 50% { opacity: 0; } }`;
            document.head.appendChild(style);
        }
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        const btnStart = document.getElementById("btn-record-start");
        const btnStop = document.getElementById("btn-record-stop");
        if(btnStart) btnStart.style.display = "inline-block";
        if(btnStop) btnStop.style.display = "none";
        const ind = document.getElementById("rec-indicator");
        if(ind) ind.remove();
    }
}

function saveVideo() {
    if (recordedChunks.length === 0) { alert("éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
    
    const timestampStr = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");

    const blob = new Blob(recordedChunks, { type: selectedMimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const ext = selectedMimeType.includes("mp4") ? "mp4" : "webm";
    const filename = `Analysis_${timestampStr}.${ext}`;
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 100);

    // â˜…ä¿®æ­£: è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’å»ƒæ­¢ã—ã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    const btnCsv = document.getElementById("btn-pose-csv");
    if (recordedCSVData.length > 0) {
        if (btnCsv) {
            btnCsv.disabled = false;
            btnCsv.style.background = "#00897b"; // ç·‘ç³»ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‰²
            btnCsv.style.cursor = "pointer";
        }
        alert("å‹•ç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nCSVãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆã¯ã€ŒğŸ“¥ CSVä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
    } else {
        alert("å‹•ç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ï¼ˆCSVãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰");
    }
}

function downloadPoseCSV() {
    if (!recordedCSVData || recordedCSVData.length === 0) {
        alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }

    const timestampStr = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");
    
    let csvContent = "Time(sec),R_Elbow(Nm),R_Shoulder(Nm),R_Knee(Nm),L_Elbow(Nm),L_Shoulder(Nm),L_Knee(Nm),Trunk(Nm)\n";
    recordedCSVData.forEach(row => {
        csvContent += `${row.time},${row.r_elbow},${row.r_shoulder},${row.r_knee},${row.l_elbow},${row.l_shoulder},${row.l_knee},${row.trunk}\n`;
    });

    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `Torque_Data_${timestampStr}.csv`;
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 100);
}

function downloadCSV(timestampStr) {
    let csvContent = "Time(sec),R_Elbow(Nm),R_Shoulder(Nm),R_Knee(Nm),L_Elbow(Nm),L_Shoulder(Nm),L_Knee(Nm),Trunk(Nm)\n";
    recordedCSVData.forEach(row => {
        csvContent += `${row.time},${row.r_elbow},${row.r_shoulder},${row.r_knee},${row.l_elbow},${row.l_shoulder},${row.l_knee},${row.trunk}\n`;
    });

    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = `Torque_Data_${timestampStr}.csv`;
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 100);
}

// ==========================================
// ğŸ¦¶ ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†ææ©Ÿèƒ½ (å®Œå…¨çµ±åˆç‰ˆ v7 - é¸æ‰‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ)
// ==========================================

// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
var fwVideo = document.getElementById('fw_video');
var fwCanvas = document.getElementById('fw_canvas');
var fwOverlay = document.getElementById('fw_overlay');
var fwCtx = fwCanvas ? fwCanvas.getContext('2d') : null;
var fwOvCtx = fwOverlay ? fwOverlay.getContext('2d') : null;

var fwPose = null;
var fwIsRunning = false;
var fwAnimId;
var fwFacingMode = 'environment';

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
var fwPath = []; 
var fwHeatmap = []; 
var HEATMAP_GRID_SIZE = 20; 

// é€Ÿåº¦è¨ˆç®—ç”¨
var fwLastRealPos = null; 
var fwLastTime = 0;
var fwTotalDistance = 0;

// ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
var fwIsCalibrating = false;
var fwCalibPoints = []; 
var fwHomographyMatrix = null; 

// ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ç”¨
var fwIsRecordingCSV = false;
var fwRecordedData = []; 
var fwRecStartTime = 0;

// åˆæœŸåŒ–é–¢æ•°
function initFwPose() {
    if (fwPose) return;
    fwPose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    fwPose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    fwPose.onResults(onFwResults);

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆæœŸåŒ–
    for(let i=0; i<HEATMAP_GRID_SIZE; i++) {
        fwHeatmap[i] = new Array(HEATMAP_GRID_SIZE).fill(0);
    }
}

// ==========================
// ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ»å‹•ç”» æ“ä½œ
// ==========================

// ã‚«ãƒ¡ãƒ©èµ·å‹•
async function fwStartCamera() {
    fwStopAnalysis(); 
    initFwPose();
    if(typeof stopTracking === 'function') stopTracking(); 

    if (fwVideo.src) {
        URL.revokeObjectURL(fwVideo.src);
        fwVideo.removeAttribute('src');
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: fwFacingMode, // â˜…ã“ã“ã‚’å¤‰æ›´
                width: { ideal: 640 }, 
                height: { ideal: 480 }, 
                frameRate: 30 
            },
            audio: false
        });
        fwVideo.srcObject = stream;
        fwVideo.onloadedmetadata = () => {
            fwVideo.play();
            fwIsRunning = true;
            fwProcessFrame();
        };
        setupFwCanvasListener();
    } catch(e) {
        console.error(e);
        alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
}

function fwToggleCamera() {
    // ãƒ¢ãƒ¼ãƒ‰ã‚’åè»¢ (environment <-> user)
    fwFacingMode = (fwFacingMode === 'user') ? 'environment' : 'user';
    
    // ã™ã§ã«ã‚«ãƒ¡ãƒ©ãŒå‹•ã„ã¦ã„ã‚‹å ´åˆã¯ã€æ–°ã—ã„å‘ãã§å†èµ·å‹•
    if (fwVideo.srcObject) {
        fwStartCamera();
    } else {
        alert(`æ¬¡å›ã®ã‚«ãƒ¡ãƒ©èµ·å‹•æ™‚ã¯ã€Œ${fwFacingMode === 'user' ? 'å†…å´' : 'å¤–å´'}ã€ã«ãªã‚Šã¾ã™ã€‚`);
    }
}

// å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function fwHandleVideoUpload(input) {
    const file = input.files[0];
    if (!file) return;

    fwStopAnalysis(); 
    initFwPose();
    
    const ctrls = document.getElementById("fw-video-controls");
    if(ctrls) ctrls.style.display = "flex";

    const url = URL.createObjectURL(file);
    fwVideo.src = url;
    fwVideo.muted = true;
    fwVideo.playsInline = true;

    
    fwVideo.onloadeddata = () => {
        fwVideo.pause();
        fwVideo.currentTime = 0;
        fwIsRunning = false;
    };

   
    fwVideo.onseeked = () => {
        
        fwCanvas.width = fwVideo.videoWidth || 640;
        fwCanvas.height = fwVideo.videoHeight || 480;
        fwOverlay.width = fwCanvas.width;
        fwOverlay.height = fwCanvas.height;

        
        if(fwCtx) {
            fwCtx.drawImage(fwVideo, 0, 0, fwCanvas.width, fwCanvas.height);
        }

       
        setTimeout(() => { 
            if(fwPose) fwPose.send({image: fwVideo}); 
        }, 100);
    };
   

    setupFwCanvasListener();
    input.value = '';
}

function poseVideoPlay() {
    if (!videoElement.src) return alert("å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
    videoElement.play();
    isCameraRunning = true;
    processVideoFrame();
}

function poseVideoPause() {
    if (!videoElement.src) return;
    videoElement.pause();
    isCameraRunning = false;
    if (animationId) cancelAnimationFrame(animationId);
}

function poseVideoReset() {
    if (!videoElement.src) return;
    videoElement.pause();
    isCameraRunning = false;
    if (animationId) cancelAnimationFrame(animationId);
    
    videoElement.currentTime = 0;
    
    // æœ€åˆã®ç”»ã‚’æç”»
    setTimeout(() => {
         if(pose) pose.send({image: videoElement});
    }, 200);
}

function setupFwCanvasListener() {
    // è¦ªè¦ç´ ã§ã¯ãªãã€ä¸€ç•ªä¸Šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    if(fwOverlay) {
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒã‚¯ãƒªãƒƒã‚¯ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        fwOverlay.style.pointerEvents = "auto"; 
        
        fwOverlay.removeEventListener('mousedown', handleFwCanvasClick); 
        fwOverlay.addEventListener('mousedown', handleFwCanvasClick);
    } 
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒãªã„å ´åˆã¯è¦ªè¦ç´ ã«
    else if (fwCanvas && fwCanvas.parentElement) {
        fwCanvas.parentElement.removeEventListener('mousedown', handleFwCanvasClick); 
        fwCanvas.parentElement.addEventListener('mousedown', handleFwCanvasClick);
    }
}

// è§£æãƒ«ãƒ¼ãƒ—
function fwProcessFrame() {
    if (!fwIsRunning) return;
    fwPose.send({image: fwVideo}).then(() => {
        if (fwIsRunning) fwAnimId = requestAnimationFrame(fwProcessFrame);
    });
}

// â¹ åœæ­¢å‡¦ç†
function fwStopAnalysis() {
    fwIsRunning = false;
    if (fwAnimId) { cancelAnimationFrame(fwAnimId); fwAnimId = null; }
    if (fwVideo.srcObject) {
        fwVideo.srcObject.getTracks().forEach(track => track.stop());
        fwVideo.srcObject = null;
    }
    if (fwVideo.src) {
        fwVideo.pause();
        fwVideo.removeAttribute('src'); 
        fwVideo.load();
    }
    if (fwCtx) {
        fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        fwCtx.fillStyle = "#000";
        fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
    }
    const ctrls = document.getElementById("fw-video-controls");
    if(ctrls) ctrls.style.display = "none";
}

// å‹•ç”»æ“ä½œãƒœã‚¿ãƒ³
function fwVideoPlay() {
    if (!fwVideo.src) return alert("å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
    fwVideo.play();
    fwIsRunning = true;
    fwProcessFrame();
}
function fwVideoPause() {
    if (!fwVideo.src) return;
    fwVideo.pause();
    fwIsRunning = false;
    if (fwAnimId) cancelAnimationFrame(fwAnimId);
}
function fwVideoReset() {
    if (!fwVideo.src) return;
    fwVideo.pause();
    fwIsRunning = false;
    if (fwAnimId) cancelAnimationFrame(fwAnimId);
    fwVideo.currentTime = 0;
    setTimeout(() => { if(fwPose) fwPose.send({image: fwVideo}); }, 200);
}

// ==========================
// ğŸ§  ãƒ¡ã‚¤ãƒ³è§£æãƒ­ã‚¸ãƒƒã‚¯
// ==========================
function onFwResults(results) {
    if (!fwCtx) return;
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ˜ åƒã«åˆã‚ã›ã‚‹ï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰
    if (fwCanvas.width !== fwVideo.videoWidth || fwCanvas.height !== fwVideo.videoHeight) {
        fwCanvas.width = fwVideo.videoWidth || 640;
        fwCanvas.height = fwVideo.videoHeight || 480;
        fwOverlay.width = fwCanvas.width;
        fwOverlay.height = fwCanvas.height;
    }

    // èƒŒæ™¯æç”»
    fwCtx.drawImage(results.image, 0, 0, fwCanvas.width, fwCanvas.height);
    fwCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
    fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);

    drawCalibrationRect(); 

    const lm = results.poseLandmarks;
    if (!lm) return;

    // è…°ä½ç½®å–å¾—
    const hipX = (lm[23].x + lm[24].x) / 2;
    const hipY = (lm[23].y + lm[24].y) / 2;
    if(hipX < 0 || hipX > 1 || hipY < 0 || hipY > 1) return;

    const px = hipX * fwCanvas.width;
    const py = hipY * fwCanvas.height;

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
    updateFwHeatmap(hipX, hipY);
    if(document.getElementById('fw-show-heatmap').checked) drawFwHeatmap();

    // è»Œè·¡
    fwPath.push({x: px, y: py});
    if (fwPath.length > 300) fwPath.shift();
    if(document.getElementById('fw-show-trajectory').checked) drawFwTrajectory();

    // é€Ÿåº¦è¨ˆç®— (è£œæ­£ã‚ã‚Š)
    calculateFwSpeedWithCorrection(px, py);

    // --- è² è·è¨ˆç®— (é¸æ‰‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åæ˜ ç‰ˆ) ---
    // è§’åº¦è¨ˆç®—
    const angKneeR = calculateFwAngle(lm[24], lm[26], lm[28]);
    const angKneeL = calculateFwAngle(lm[23], lm[25], lm[27]);
    
    const midShoulder = { x: (lm[12].x + lm[11].x)/2, y: (lm[12].y + lm[11].y)/2 };
    const midHip = { x: hipX, y: hipY };
    const verticalPt = { x: midHip.x, y: midHip.y - 0.5 };
    const angTrunk = calculateFwAngle(verticalPt, midHip, midShoulder);
    
    // ãƒˆãƒ«ã‚¯è¨ˆç®— (å…¥åŠ›ã•ã‚ŒãŸèº«é•·ãƒ»ä½“é‡ã‚’ä½¿ç”¨)
    const tDataR = calculateFwTorque(0, 0, angKneeR, angTrunk);
    const valKneeR = tDataR.knee;
    const valTrunk = tDataR.trunk;

    const tDataL = calculateFwTorque(0, 0, angKneeL, angTrunk);
    const valKneeL = tDataL.knee;

    // %æ›ç®— (åŸºæº–å€¤ã‚‚ä½“æ ¼ã«åˆã‚ã›ã¦å¤‰å‹•ã•ã›ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯)
    // â€»åŸºæº–å€¤: è†200Nm, ä½“å¹¹150Nm ã¯æ¨™æº–ä½“å‹ç”¨ã€‚ã“ã“ã§ã¯å›ºå®šã§è¨ˆç®—ã—ã€çµ¶å¯¾å€¤(Nm)ã§è©•ä¾¡ã—ã¾ã™ã€‚
    const pctKneeR = Math.round((valKneeR / 200) * 100);
    const pctKneeL = Math.round((valKneeL / 200) * 100);
    const pctTrunk = Math.round((valTrunk / 150) * 100);
    
    // ç”»é¢è¡¨ç¤º
    const setLoadDisplay = (id, pct, val) => {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = `${pct}% (${val.toFixed(0)}Nm)`;
            el.style.color = pct > 100 ? "#d50000" : `hsl(${120 - Math.min(120, pct)}, 100%, 40%)`;
        }
    };
    setLoadDisplay("fw-load-knee-r", pctKneeR, valKneeR);
    setLoadDisplay("fw-load-knee-l", pctKneeL, valKneeL);
    setLoadDisplay("fw-load-trunk",  pctTrunk, valTrunk);

    // ãƒ‡ãƒ¼ã‚¿è¨˜éŒ² (CSVç”¨)
    const currentSpeed = parseFloat(document.getElementById("fw-speed").textContent) || 0;
    if (fwIsRecordingCSV) {
        const elapsedTime = (Date.now() - fwRecStartTime) / 1000;
        fwRecordedData.push({
            time: elapsedTime.toFixed(2),
            x: fwLastRealPos ? fwLastRealPos.x.toFixed(2) : 0, 
            y: fwLastRealPos ? fwLastRealPos.y.toFixed(2) : 0,
            speed: currentSpeed,
            valKneeR: valKneeR.toFixed(1),
            valKneeL: valKneeL.toFixed(1),
            valTrunk: valTrunk.toFixed(1),
            pctKneeR: pctKneeR,
            pctKneeL: pctKneeL,
            pctTrunk: pctTrunk
        });
    }

    // ãƒã‚¤ãƒ³ãƒˆæç”»
    fwCtx.beginPath();
    fwCtx.arc(px, py, 8, 0, 2*Math.PI);
    fwCtx.fillStyle = fwIsRecordingCSV ? "red" : "#00e676";
    fwCtx.fill();
    fwCtx.stroke();
}

// -----------------------------------------------------
// âš™ï¸ è² è·è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (é¸æ‰‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ)
// -----------------------------------------------------
function calculateFwAngle(a, b, c) {
    if(!a || !b || !c) return 0;
    const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
    let angle = Math.abs(radians * 180.0 / Math.PI);
    if (angle > 180.0) angle = 360 - angle;
    return angle;
}

function calculateFwTorque(angShoulder, angElbow, angKnee, angTrunk) {
    // HTMLã®å…¥åŠ›æ¬„ã‹ã‚‰å€¤ã‚’å–å¾— (ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ID)
    const elH = document.getElementById("fw-player-height");
    const elW = document.getElementById("fw-player-weight");
    const elR = document.getElementById("fw-player-racket");
    
    // å€¤ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    const H = elH ? (parseFloat(elH.value) || 170) : 170; 
    const W = elW ? (parseFloat(elW.value) || 65) : 65;  
    const R_mass = elR ? ((parseFloat(elR.value) || 85) / 1000) : 0.085;
    
    const g = 9.81;
    const H_m = H / 100;
    
    // ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ãƒ é•· (èº«é•·æ¯”)
    const L_upper = 0.186 * H_m; 
    const L_fore  = 0.146 * H_m;
    const L_trunk = 0.3 * H_m; 
    
    // éƒ¨ä½è³ªé‡ (ä½“é‡æ¯”)
    const M_arm = 0.05 * W; 
    const M_upper_body = 0.6 * W; 
    const M_body_above_knee = 0.85 * W; 

    // ç°¡æ˜“ç‰©ç†ãƒ¢ãƒ‡ãƒ«
    const radT = angTrunk * (Math.PI / 180);
    const kneeFlexFactor = Math.abs(Math.sin((180 - angKnee) * (Math.PI / 180)));
    const factorS = Math.abs(Math.sin(angShoulder * Math.PI / 180)); 
    
    const t_elbow = (2.0 + R_mass) * g * L_fore * Math.sin(angElbow * Math.PI / 180); 
    const t_shoulder = (M_arm + R_mass) * g * L_upper * factorS + t_elbow;
    const t_trunk = M_upper_body * g * (L_trunk * 0.5) * Math.sin(radT);
    const momentArmKnee = (H_m * 0.25) * kneeFlexFactor; 
    const t_knee = M_body_above_knee * g * momentArmKnee;

    return { 
        shoulder: Math.abs(t_shoulder), 
        elbow: Math.abs(t_elbow), 
        trunk: Math.abs(t_trunk), 
        knee: Math.abs(t_knee) 
    };
}

// -----------------------------------------------------
// â˜… ä¿®æ­£æ¸ˆã¿: è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ & ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
// -----------------------------------------------------
function fwToggleCalibration() {
    fwIsCalibrating = !fwIsCalibrating;
    const guide = document.getElementById("fw-calib-guide");
    const btn = document.getElementById("btn-fw-calib");
    
    if (fwIsCalibrating) {
        guide.style.display = "block";
        btn.textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
        btn.style.background = "#999";
        fwCalibPoints = [];
        fwHomographyMatrix = null;
        updateCalibStatus();
        fwOverlay.style.pointerEvents = "auto";
    } else {
        guide.style.display = "none";
        btn.textContent = "ğŸ“ 4ç‚¹ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³";
        btn.style.background = "#ff9800";
        fwOverlay.style.pointerEvents = "none";
        fwOvCtx.clearRect(0,0,fwOverlay.width, fwOverlay.height);
    }
}

function updateCalibStatus() {
    const el = document.getElementById("fw-calib-status");
    const msgs = ["å·¦ä¸Š (å¥¥ã®å·¦éš…)", "å³ä¸Š (å¥¥ã®å³éš…)", "å³ä¸‹ (æ‰‹å‰ã®å³éš…)", "å·¦ä¸‹ (æ‰‹å‰ã®å·¦éš…)"];
    if(fwCalibPoints.length < 4) {
        el.textContent = `ç¾åœ¨: ${fwCalibPoints.length}ç‚¹ç›® / æ¬¡ã¯ã€${msgs[fwCalibPoints.length]}ã€‘ã‚’ã‚¯ãƒªãƒƒã‚¯`;
    } else {
        el.textContent = "è¨­å®šå®Œäº†ï¼";
    }
}

function handleFwCanvasClick(e) {
    if (!fwIsCalibrating) return;

    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¦ªdivã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ãƒã‚¹è‡ªä½“ï¼‰ã‚’å–å¾—
    const target = e.target;
    const rect = target.getBoundingClientRect();

    // è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆCSSä¸Šã®å¹…ãƒ»é«˜ã•ï¼‰
    const displayWidth = rect.width;
    const displayHeight = rect.height;

    // å†…éƒ¨è§£åƒåº¦ï¼ˆå®Ÿéš›ã®ç”»ç´ æ•°ï¼‰
    const actualWidth = fwCanvas.width;
    const actualHeight = fwCanvas.height;

    // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ï¼ˆè¦ç´ å†…ã®ç›¸å¯¾åº§æ¨™ï¼‰ã‚’å–å¾—
    // â€» e.offsetX ãŒä½¿ãˆãªã„å ´åˆï¼ˆè¦ªè¦ç´ ã§ã®ç™ºç«ãªã©ï¼‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ clientX - rect.left ã‚‚ä½¿ç”¨
    const clickX = (e.offsetX !== undefined) ? e.offsetX : (e.clientX - rect.left);
    const clickY = (e.offsetY !== undefined) ? e.offsetY : (e.clientY - rect.top);

    // åº§æ¨™å¤‰æ›: è¡¨ç¤ºã‚µã‚¤ã‚º â†’ å†…éƒ¨è§£åƒåº¦
    const x = clickX * (actualWidth / displayWidth);
    const y = clickY * (actualHeight / displayHeight);

    fwCalibPoints.push({x, y});
    updateCalibStatus();

    // å³åº§ã«ç‚¹ã‚’æç”»ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«æç”»ã—ã¦æ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    // â€»fwOvCtx (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ) ã‚’ä½¿ç”¨ã—ã¾ã™
    if (fwOvCtx) {
        fwOvCtx.beginPath();
        fwOvCtx.arc(x, y, 5, 0, 2*Math.PI); // åŠå¾„5pxã®èµ¤ä¸¸
        fwOvCtx.fillStyle = "red";
        fwOvCtx.fill();
        fwOvCtx.strokeStyle = "white";
        fwOvCtx.lineWidth = 2;
        fwOvCtx.stroke();
    }

    // 4ç‚¹æƒã£ãŸã‚‰è¨ˆç®—
    if (fwCalibPoints.length === 4) {
        // æœ€å¾Œã®ç‚¹ãŒæç”»ã•ã‚Œã‚‹ã®ã‚’ä¸€ç¬å¾…ã¤
        setTimeout(() => {
            computeHomographyMatrix();
            alert("è¨­å®šå®Œäº†ï¼");
            fwToggleCalibration(); 
        }, 50);
    }
}

function drawCalibrationRect() {
    if (fwCalibPoints.length === 0 && !fwHomographyMatrix) return;
    const ctx = fwCtx; 
    ctx.beginPath();
    ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
    ctx.lineWidth = 2;
    if (fwCalibPoints.length > 0) {
        ctx.moveTo(fwCalibPoints[0].x, fwCalibPoints[0].y);
        for(let i=1; i<fwCalibPoints.length; i++) ctx.lineTo(fwCalibPoints[i].x, fwCalibPoints[i].y);
        if (fwCalibPoints.length === 4) ctx.closePath();
    }
    ctx.stroke();
    ctx.fillStyle = "red";
    fwCalibPoints.forEach((p, i) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, 2*Math.PI);
        ctx.fill();
        ctx.font = "12px Arial";
        ctx.fillStyle = "white";
        ctx.fillText(i+1, p.x+5, p.y-5);
        ctx.fillStyle = "red";
    });
}

// 1. è¡Œåˆ—è¨ˆç®—ã®å®Ÿè¡Œ
function computeHomographyMatrix() {
    const elW = document.getElementById("fw-real-width");
    const elH = document.getElementById("fw-real-height");
    const realW = (elW && parseFloat(elW.value)) ? parseFloat(elW.value) : 6.1;
    const realH = (elH && parseFloat(elH.value)) ? parseFloat(elH.value) : 6.7;

    console.log(`Calibration Settings: W=${realW}m, H=${realH}m`);

    const src = fwCalibPoints; 
    const dst = [
        {x: 0, y: 0},
        {x: realW, y: 0},
        {x: realW, y: realH},
        {x: 0, y: realH}
    ];

    fwHomographyMatrix = getPerspectiveTransform(src, dst);
    
    if (fwHomographyMatrix) {
        console.log("Homography Matrix calculated:", fwHomographyMatrix);
    } else {
        alert("è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
    }
}

// 2. 4ç‚¹ã‹ã‚‰å¤‰æ›è¡Œåˆ—ã‚’æ±‚ã‚ã‚‹é–¢æ•° (OpenCVäº’æ›ãƒ»å®‰å®šç‰ˆ)
function getPerspectiveTransform(src, dst) {
    function solveLinearSystem(A, B) {
        const n = 8;
        for (let i = 0; i < n; i++) {
            let pivot = i;
            for (let j = i + 1; j < n; j++) {
                if (Math.abs(A[j][i]) > Math.abs(A[pivot][i])) pivot = j;
            }
            [A[i], A[pivot]] = [A[pivot], A[i]];
            [B[i], B[pivot]] = [B[pivot], B[i]];

            if (Math.abs(A[i][i]) < 1e-10) continue; 

            for (let j = i + 1; j < n; j++) {
                const factor = A[j][i] / A[i][i];
                for (let k = i; k < n; k++) A[j][k] -= factor * A[i][k];
                B[j] -= factor * B[i];
            }
        }
        const X = new Array(n).fill(0);
        for (let i = n - 1; i >= 0; i--) {
            let sum = 0;
            for (let j = i + 1; j < n; j++) sum += A[i][j] * X[j];
            if (Math.abs(A[i][i]) > 1e-10) X[i] = (B[i] - sum) / A[i][i];
        }
        return X;
    }

    const A = [];
    const B = [];
    for (let i = 0; i < 4; i++) {
        const sx = src[i].x; const sy = src[i].y;
        const dx = dst[i].x; const dy = dst[i].y;
        A.push([sx, sy, 1, 0, 0, 0, -sx*dx, -sy*dx]);
        A.push([0, 0, 0, sx, sy, 1, -sx*dy, -sy*dy]);
        B.push(dx); B.push(dy);
    }

    const h = solveLinearSystem(A, B);
    if (!h || h.some(v => isNaN(v) || !isFinite(v))) {
        console.error("Matrix calculation failed (NaN).");
        return null; 
    }
    return [[h[0], h[1], h[2]], [h[3], h[4], h[5]], [h[6], h[7], 1]];
}

// 3. åº§æ¨™å¤‰æ›
function transformPoint(x, y, H) {
    if(!H) return {x:0, y:0};
    const dem = H[2][0]*x + H[2][1]*y + H[2][2];
    if (Math.abs(dem) < 0.0001) return {x:0, y:0};
    return { 
        x: (H[0][0]*x + H[0][1]*y + H[0][2]) / dem, 
        y: (H[1][0]*x + H[1][1]*y + H[1][2]) / dem 
    };
}

// 4. é€Ÿåº¦è¨ˆç®— (m/s å¯¾å¿œãƒ»è£œæ­£ç‰ˆ)
function calculateFwSpeedWithCorrection(px, py) {
    if (!fwHomographyMatrix) return;

    const isVideoFile = (fwVideo.src && fwVideo.src.startsWith("blob:"));
    const currentTime = isVideoFile ? fwVideo.currentTime : (Date.now() / 1000);

    const pt = transformPoint(px, py, fwHomographyMatrix);
    const realX = pt.x;
    const realY = pt.y;

    if (isNaN(realX) || isNaN(realY)) return;

    if (fwLastRealPos) {
        const dx = realX - fwLastRealPos.x;
        const dy = realY - fwLastRealPos.y;
        const distMeters = Math.sqrt(dx*dx + dy*dy);
        
        let dt = currentTime - fwLastTime;
        if (dt < 0) dt = 0; 

        if (distMeters < 10.0 && distMeters > 0.001) {
            fwTotalDistance += distMeters;
            const distEl = document.getElementById("fw-distance");
            if (distEl) distEl.textContent = fwTotalDistance.toFixed(1);

            if (dt > 0.03) { 
                const speedMPS = distMeters / dt; 
                if (speedMPS < 12.5) { 
                    const elSpeed = document.getElementById("fw-speed");
                    if (elSpeed) {
                        const currentDisp = parseFloat(elSpeed.textContent) || 0;
                        const smoothSpeed = (currentDisp * 0.7) + (speedMPS * 0.3);
                        elSpeed.textContent = smoothSpeed.toFixed(1);
                    }
                }
            }
        }
    }
    fwLastRealPos = {x: realX, y: realY};
    fwLastTime = currentTime;
}

// ==========================
// ğŸ› ï¸ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ==========================
function updateFwHeatmap(nx, ny) {
    const gx = Math.floor(nx * HEATMAP_GRID_SIZE);
    const gy = Math.floor(ny * HEATMAP_GRID_SIZE);
    if(gx >= 0 && gx < HEATMAP_GRID_SIZE && gy >= 0 && gy < HEATMAP_GRID_SIZE) {
        fwHeatmap[gy][gx]++;
    }
}

function drawFwHeatmap() {
    const cellW = fwCanvas.width / HEATMAP_GRID_SIZE;
    const cellH = fwCanvas.height / HEATMAP_GRID_SIZE;
    let maxCount = 0;
    for(let y=0; y<HEATMAP_GRID_SIZE; y++) for(let x=0; x<HEATMAP_GRID_SIZE; x++) if(fwHeatmap[y][x] > maxCount) maxCount = fwHeatmap[y][x];
    if (maxCount === 0) return;

    for(let y=0; y<HEATMAP_GRID_SIZE; y++) {
        for(let x=0; x<HEATMAP_GRID_SIZE; x++) {
            const count = fwHeatmap[y][x];
            if(count > 0) {
                const ratio = count / maxCount; 
                const hue = (1.0 - ratio) * 240; 
                fwCtx.fillStyle = `hsla(${hue}, 100%, 50%, 0.4)`;
                fwCtx.fillRect(x * cellW, y * cellH, cellW, cellH);
            }
        }
    }
}

function drawFwTrajectory() {
    if(fwPath.length < 2) return;
    fwCtx.beginPath();
    fwCtx.strokeStyle = "yellow";
    fwCtx.lineWidth = 3;
    fwCtx.moveTo(fwPath[0].x, fwPath[0].y);
    for(let i=1; i<fwPath.length; i++) fwCtx.lineTo(fwPath[i].x, fwPath[i].y);
    fwCtx.stroke();
}

function fwResetData() {
    fwPath = [];
    for(let i=0; i<HEATMAP_GRID_SIZE; i++) fwHeatmap[i].fill(0);
    fwTotalDistance = 0;
    fwLastRealPos = null;
    fwRecordedData = [];
    fwRecStartTime = Date.now();

    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    setTxt("fw-speed", "0.0");
    setTxt("fw-distance", "0.0");
    
    // è² è·è¡¨ç¤ºã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    const elKneeR = document.getElementById("fw-load-knee-r");
    const elKneeL = document.getElementById("fw-load-knee-l");
    const elTrunk = document.getElementById("fw-load-trunk");

    if (elKneeR) { elKneeR.textContent = "0% (0Nm)"; elKneeR.style.color = "#333"; }
    if (elKneeL) { elKneeL.textContent = "0% (0Nm)"; elKneeL.style.color = "#333"; }
    if (elTrunk) { elTrunk.textContent = "0% (0Nm)"; elTrunk.style.color = "#333"; }

    if(fwCtx) {
        fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
        if (!fwIsRunning) {
            fwCtx.fillStyle = "#000";
            fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
        }
    }
    console.log("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
}

function fwToggleCSVRecording() {
    const btn = document.getElementById("btn-fw-rec-data");
    const btnDl = document.getElementById("btn-fw-download-csv");
    
    if (!fwIsRecordingCSV) {
        fwIsRecordingCSV = true;
        fwRecordedData = [];
        fwRecStartTime = Date.now();
        btn.textContent = "â–  è¨˜éŒ²åœæ­¢";
        btn.style.background = "#d32f2f";
        if(btnDl) { btnDl.disabled = true; btnDl.style.background = "#ccc"; }
    } else {
        fwIsRecordingCSV = false;
        btn.textContent = "ğŸ”´ ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²";
        btn.style.background = "#424242";
        if (fwRecordedData.length > 0 && btnDl) {
            btnDl.disabled = false;
            btnDl.style.background = "#1565c0";
            btnDl.style.cursor = "pointer";
            alert("è¨˜éŒ²å®Œäº†ã€‚CSVä¿å­˜ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚");
        }
    }
}

function fwDownloadCSV() {
    if (fwRecordedData.length === 0) return;
    let csvContent = "Time(s),X(m),Y(m),Speed(m/s),Right_Knee(Nm),Left_Knee(Nm),Trunk(Nm),Right_Knee(%),Left_Knee(%),Trunk(%)\n";
    fwRecordedData.forEach(row => {
        csvContent += `${row.time},${row.x},${row.y},${row.speed},${row.valKneeR},${row.valKneeL},${row.valTrunk},${row.pctKneeR},${row.pctKneeL},${row.pctTrunk}\n`;
    });
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); 
    const blob = new Blob([bom, csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Footwork_Data_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

async function fwGeneratePDFReport() {
    const btn = document.getElementById("btn-fw-report");
    const originalText = btn.textContent;
    btn.textContent = "ç”Ÿæˆä¸­...";
    btn.disabled = true;

    try {
        pdfMake.fonts = {
            Roboto: {
                normal: 'Roboto-Regular.ttf',
                bold: 'Roboto-Medium.ttf',
                italics: 'Roboto-Italic.ttf',
                bolditalics: 'Roboto-MediumItalic.ttf'
            }
        };

        const mapImage = fwCanvas.toDataURL("image/png");
        const totalDist = document.getElementById("fw-distance").textContent;
        
        let maxSpeed = 0, avgSpeed = 0;
        let integKneeR = 0, integKneeL = 0, integTrunk = 0;
        let avgKneeR = 0, avgKneeL = 0;
        
        if (fwRecordedData.length > 0) {
            maxSpeed = Math.max(...fwRecordedData.map(d => parseFloat(d.speed))).toFixed(1);
            const sumSpeed = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.speed), 0);
            avgSpeed = (sumSpeed / fwRecordedData.length).toFixed(1);
            
            const sumR = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.valKneeR), 0);
            const sumL = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.valKneeL), 0);
            const sumT = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.valTrunk), 0);

            integKneeR = Math.round(sumR / 100);
            integKneeL = Math.round(sumL / 100);
            integTrunk = Math.round(sumT / 100);

            avgKneeR = (sumR / fwRecordedData.length).toFixed(1);
            avgKneeL = (sumL / fwRecordedData.length).toFixed(1);
        }

        let balanceComment = "Balanced (ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½)";
        if (integKneeR > integKneeL * 1.2) balanceComment = "Right Leg Dominant (å³è¶³åé‡ - å³ã¸ã®è² æ‹…å¤§)";
        else if (integKneeL > integKneeR * 1.2) balanceComment = "Left Leg Dominant (å·¦è¶³åé‡ - å·¦ã¸ã®è² æ‹…å¤§)";

        const docDefinition = {
            content: [
                { text: 'Footwork & Load Analysis Report', style: 'header' },
                { text: `Date: ${new Date().toLocaleString()}`, style: 'subheader' },
                
                { text: 'â–  1. Movement Performance', style: 'sectionHeader' },
                {
                    table: {
                        widths: ['*', '*', '*'],
                        body: [
                            [
                                { text: 'Total Distance', style: 'tableHeader' },
                                { text: 'Max Speed', style: 'tableHeader' },
                                { text: 'Avg Speed', style: 'tableHeader' }
                            ],
                            [
                                { text: `${totalDist} m`, style: 'tableData' },
                                { text: `${maxSpeed} m/s`, style: 'tableData' },
                                { text: `${avgSpeed} m/s`, style: 'tableData' }
                            ]
                        ]
                    },
                    margin: [0, 5, 0, 15]
                },

                { text: 'â–  2. Total Workload (Integral Score)', style: 'sectionHeader' },
                {
                    table: {
                        widths: ['*', '*', '*'],
                        body: [
                            [
                                { text: 'Right Knee (å³è„š)', style: 'tableHeader', fillColor: '#ffccbc' }, 
                                { text: 'Left Knee (å·¦è„š)', style: 'tableHeader', fillColor: '#b3e5fc' },  
                                { text: 'Trunk (ä½“å¹¹)', style: 'tableHeader', fillColor: '#fff9c4' }      
                            ],
                            [
                                { text: `${integKneeR} pts`, style: 'tableDataBold', fontSize: 16 },
                                { text: `${integKneeL} pts`, style: 'tableDataBold', fontSize: 16 },
                                { text: `${integTrunk} pts`, style: 'tableDataBold', fontSize: 16 }
                            ],
                            [
                                { text: `Avg: ${avgKneeR} Nm`, style: 'tableDataSmall' },
                                { text: `Avg: ${avgKneeL} Nm`, style: 'tableDataSmall' },
                                { text: '-' }
                            ]
                        ]
                    },
                    margin: [0, 5, 0, 10]
                },
                { text: `Balance Check: ${balanceComment}`, fontSize: 11, bold: true, color: '#333', margin: [0, 0, 0, 20] },

                { text: 'â–  3. Visualization', style: 'sectionHeader' },
                {
                    image: mapImage,
                    width: 500,
                    alignment: 'center',
                    margin: [0, 10, 0, 20]
                },

                { text: 'â–  Coach Comments', style: 'sectionHeader' },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }] },
                { text: '\n' },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }] },
                { text: '\n' },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }] },

                { text: 'Generated by Smart Coach Badminton', style: 'footer', alignment: 'right', margin: [0, 20, 0, 0] }
            ],
            defaultStyle: { font: 'Roboto' },
            styles: {
                header: { fontSize: 22, bold: true, color: '#2e7d32', margin: [0, 0, 0, 5] },
                subheader: { fontSize: 10, margin: [0, 0, 0, 20], color: '#555' },
                sectionHeader: { fontSize: 14, bold: true, color: '#1565c0', margin: [0, 10, 0, 5] },
                tableHeader: { bold: true, fontSize: 11, color: '#333', alignment: 'center' },
                tableData: { fontSize: 12, alignment: 'center', margin: [0, 5, 0, 5] },
                tableDataBold: { fontSize: 14, bold: true, alignment: 'center', margin: [0, 5, 0, 5] },
                tableDataSmall: { fontSize: 9, alignment: 'center', color: '#666' },
                footer: { fontSize: 9, color: '#999', italics: true }
            }
        };

        pdfMake.createPdf(docDefinition).download(`Analysis_Report_${Date.now()}.pdf`);

    } catch (e) {
        console.error("PDF Error:", e);
        alert("PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}


// ==========================================
// ğŸ¸ å‹•ç”»æ¯”è¼ƒæ©Ÿèƒ½ (Video Comparison)
// ==========================================

// å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
function compLoadVideo(input, videoId) {
    const file = input.files[0];
    if (!file) return;
    const video = document.getElementById(videoId);
    const url = URL.createObjectURL(file);
    video.src = url;
    video.load();
    const seek = document.getElementById('seek-' + videoId);
    if(seek) seek.value = 0;
}

// åŒæ™‚å†ç”Ÿ
async function compPlayBoth() {
    const vA = document.getElementById('video-a');
    const vB = document.getElementById('video-b');
    
    compChangeSpeed();

    if (vA) vA.muted = true;
    if (vB) vB.muted = true;

    try {
        const playPromiseA = vA.src ? vA.play() : Promise.resolve();
        const playPromiseB = vB.src ? vB.play() : Promise.resolve();

        await Promise.all([playPromiseA, playPromiseB]);
    } catch (err) {
        console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err);
    }
}

// åŒæ™‚ä¸€æ™‚åœæ­¢
function compPauseBoth() {
    const vA = document.getElementById('video-a');
    const vB = document.getElementById('video-b');
    if (vA.src) vA.pause();
    if (vB.src) vB.pause();
}

// æœ€åˆã«æˆ»ã™
function compResetBoth() {
    const vA = document.getElementById('video-a');
    const vB = document.getElementById('video-b');
    if (vA.src) { vA.pause(); vA.currentTime = 0; }
    if (vB.src) { vB.pause(); vB.currentTime = 0; }
}

// å†ç”Ÿé€Ÿåº¦å¤‰æ›´
function compChangeSpeed() {
    const speed = parseFloat(document.getElementById('comp-speed').value);
    const vA = document.getElementById('video-a');
    const vB = document.getElementById('video-b');
    if (vA) vA.playbackRate = speed;
    if (vB) vB.playbackRate = speed;
}

// å·¦å³åè»¢ (ãƒŸãƒ©ãƒ¼) åˆ‡ã‚Šæ›¿ãˆ
function compToggleMirror(videoId) {
    const video = document.getElementById(videoId);
    if (video.style.transform === 'scaleX(-1)') {
        video.style.transform = 'scaleX(1)';
    } else {
        video.style.transform = 'scaleX(-1)';
    }
}

// å€‹åˆ¥ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ
function compIndividualSeek(videoId, value) {
    const video = document.getElementById(videoId);
    if (!video.duration) return;
    const time = video.duration * (value / 100);
    video.currentTime = time;
}

// å‹•ç”»å†ç”Ÿä¸­ã®ã‚·ãƒ¼ã‚¯ãƒãƒ¼è‡ªå‹•æ›´æ–°
function compUpdateSeek(videoId) {
    const video = document.getElementById(videoId);
    const seek = document.getElementById('seek-' + videoId);
    if (video.duration && seek) {
        const val = (video.currentTime / video.duration) * 100;
        seek.value = val;
    }
}

// ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ã‚¯ï¼ˆä¸¡æ–¹ã®å‹•ç”»ã‚’åŒã˜å‰²åˆã®ä½ç½®ã¸ç§»å‹•ï¼‰
function compMasterSeek(value) {
    const vA = document.getElementById('video-a');
    const vB = document.getElementById('video-b');
    
    compPauseBoth();

    if (vA.duration) vA.currentTime = vA.duration * (value / 100);
    if (vB.duration) vB.currentTime = vB.duration * (value / 100);
}

// ==========================================
// ğŸ¸ ãƒ€ãƒ–ãƒ«ã‚¹é™£å½¢åˆ†ææ©Ÿèƒ½ (MoveNet MultiPose)
// ==========================================

let formationDetector = null;
let isFormationRunning = false;
let formationAnimId = null;

let lastFormationState = "Side by Side"; // åˆæœŸå€¤
let lastFormationColor = "#1976d2";      // åˆæœŸè‰²
let lostTrackingCount = 0;

// çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
let formationStats = {
    far: { tb: 0, ss: 0, total: 0 },
    near: { tb: 0, ss: 0, total: 0 }
};

const formationVideo = document.getElementById("formation_video");
const formationCanvas = document.getElementById("formation_canvas");
const formationCtx = formationCanvas ? formationCanvas.getContext("2d") : null;

let isSelectingArea = false;
let formationDragStart = null;
let formationAnalysisArea = null; // {x, y, w, h} (nullãªã‚‰å…¨ç”»é¢)

// --- ã‚¨ãƒªã‚¢æŒ‡å®šæ©Ÿèƒ½ ---
function toggleAreaSelectMode() {
    isSelectingArea = !isSelectingArea;
    const btn = document.getElementById("btn-formation-area");
    const msg = document.getElementById("formation-area-msg");
    const canvas = document.getElementById("formation_canvas");

    if (isSelectingArea) {
        btn.textContent = "å®Œäº†";
        btn.style.background = "#d32f2f";
        msg.style.display = "block";
        
        // æ—¢å­˜ã®ã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
        formationAnalysisArea = null;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
        canvas.addEventListener("mousedown", onAreaMouseDown);
        canvas.addEventListener("mousemove", onAreaMouseMove);
        canvas.addEventListener("mouseup", onAreaMouseUp);
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹å†æç”»ï¼ˆæ ã‚’æ¶ˆã™ãŸã‚ï¼‰
        if(!isFormationRunning) {
             formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);
        }
    } else {
        btn.textContent = "ğŸ“ åˆ†æã‚¨ãƒªã‚¢æŒ‡å®š";
        btn.style.background = "#ff9800";
        msg.style.display = "none";
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
        canvas.removeEventListener("mousedown", onAreaMouseDown);
        canvas.removeEventListener("mousemove", onAreaMouseMove);
        canvas.removeEventListener("mouseup", onAreaMouseUp);
    }
}

function onAreaMouseDown(e) {
    const rect = formationCanvas.getBoundingClientRect();
    const scaleX = formationCanvas.width / rect.width;
    const scaleY = formationCanvas.height / rect.height;
    formationDragStart = {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

function onAreaMouseMove(e) {
    if (!formationDragStart) return;
    const rect = formationCanvas.getBoundingClientRect();
    const scaleX = formationCanvas.width / rect.width;
    const scaleY = formationCanvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    // æç”»æ›´æ–°ï¼ˆå‹•ç”»ã®ä¸Šã«æ ç·šã‚’æãï¼‰
    formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);
    
    // æ ç·šæç”»
    formationCtx.strokeStyle = "#00e676";
    formationCtx.lineWidth = 3;
    formationCtx.strokeRect(
        formationDragStart.x, 
        formationDragStart.y, 
        currentX - formationDragStart.x, 
        currentY - formationDragStart.y
    );
}

function onAreaMouseUp(e) {
    if (!formationDragStart) return;
    const rect = formationCanvas.getBoundingClientRect();
    const scaleX = formationCanvas.width / rect.width;
    const scaleY = formationCanvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    // ç¢ºå®šã—ãŸã‚¨ãƒªã‚¢ã‚’ä¿å­˜ (å·¦ä¸Šx, å·¦ä¸Šy, å¹…, é«˜ã• ã«æ­£è¦åŒ–)
    const x = Math.min(formationDragStart.x, currentX);
    const y = Math.min(formationDragStart.y, currentY);
    const w = Math.abs(currentX - formationDragStart.x);
    const h = Math.abs(currentY - formationDragStart.y);

    // å°ã•ã™ãã‚‹èª¤æ“ä½œã¯ç„¡è¦–
    if (w > 20 && h > 20) {
        formationAnalysisArea = { x, y, w, h };
    }
    
    formationDragStart = null;
    toggleAreaSelectMode(); // è‡ªå‹•ã§å®Œäº†ãƒ¢ãƒ¼ãƒ‰ã¸
}



// 1. ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
async function loadFormationModel() {
    const loadingEl = document.getElementById("formation-loading");
    if(loadingEl) loadingEl.style.display = "block";

    try {
        await tf.setBackend('webgl');
        await tf.ready();

        const detectorConfig = {
            modelType: 'MultiPose.Lightning',
            enableTracking: true,
            trackerType: 'boundingBox',
            trackerConfig: {
                maxTracks: 4, 
                maxAge: 800   // è¿½è·¡ä¿æŒæœŸé–“
            },
            modelConfig: {
                enableSmoothing: true // â–¼ è¿½åŠ : åº§æ¨™ã®ãƒ–ãƒ¬ã‚’æŠ‘ãˆã‚‹
            },
            minPoseScore: 0.2 
        };
        
        formationDetector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
        
        console.log("Model Loaded: High Sensitivity & Smoothing ON");
        if(loadingEl) loadingEl.style.display = "none";
        
        const btn = document.getElementById("btn-formation-toggle");
        if(btn) {
            btn.textContent = "â–¶ åˆ†æé–‹å§‹";
            btn.disabled = false;
            btn.style.background = "#00897b";
            btn.style.cursor = "pointer";
        }
    } catch (e) {
        console.error("Model Load Error:", e);
        alert("ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n" + e.message);
        if(loadingEl) loadingEl.style.display = "none";
    }
}

// 2. å‹•ç”»é¸æŠæ™‚ã®å‡¦ç†
function handleFormationVideo(input) {
    const file = input.files[0];
    if (!file) return;

    // å‰å›ã®åˆ†æãŒå‹•ã„ã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
    if (isFormationRunning) {
        toggleFormationAnalysis();
    }
    
    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    resetFormationData();

    const url = URL.createObjectURL(file);
    formationVideo.src = url;
    
    // 1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚
    formationVideo.onloadeddata = () => {
        formationVideo.pause();   // åœæ­¢
        formationVideo.currentTime = 0; // å…ˆé ­ã¸
        isFormationRunning = false;
        
        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
        const btn = document.getElementById("btn-formation-toggle");
        if(btn) {
            btn.textContent = "â–¶ åˆ†æé–‹å§‹";
            btn.style.background = "#00897b";
        }
    };

    // 2. å…ˆé ­ã¸ã®ã‚·ãƒ¼ã‚¯ï¼ˆé ­å‡ºã—ï¼‰å®Œäº†æ™‚
    // â˜…ã“ã“ãŒé‡è¦ï¼šå‹•ç”»ã®æº–å‚™ãŒæ•´ã£ãŸç¬é–“ã«ç”»åƒã‚’æç”»ã™ã‚‹
    formationVideo.onseeked = () => {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å‹•ç”»ã«åˆã‚ã›ã‚‹
        formationCanvas.width = formationVideo.videoWidth;
        formationCanvas.height = formationVideo.videoHeight;
        
        if (formationCtx) {
            // ã¾ãšã‚¯ãƒªã‚¢
            formationCtx.clearRect(0, 0, formationCanvas.width, formationCanvas.height);
            // å‹•ç”»ã®1ãƒ•ãƒ¬ãƒ¼ãƒ ç›®ã‚’ãã®ã¾ã¾æç”»ï¼ˆæ˜ã‚‹ã„çŠ¶æ…‹ã§è¡¨ç¤ºï¼‰
            formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);
        }

        // ãƒ¢ãƒ‡ãƒ«ãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰è£ã§ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã—ã¦ãŠãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ãŸã›ãªã„ãŸã‚ï¼‰
        if (!formationDetector) {
            loadFormationModel();
        }
    };
}

// 3. åˆ†æã®é–‹å§‹ãƒ»åœæ­¢
function toggleFormationAnalysis() {
    const btn = document.getElementById("btn-formation-toggle");
    
    if (!isFormationRunning) {
        // é–‹å§‹
        formationVideo.play();
        isFormationRunning = true;
        btn.textContent = "â¸ ä¸€æ™‚åœæ­¢";
        btn.style.background = "#fb8c00";
        analyzeFormationFrame();
    } else {
        // åœæ­¢
        formationVideo.pause();
        isFormationRunning = false;
        btn.textContent = "â–¶ åˆ†æå†é–‹";
        btn.style.background = "#00897b";
        if (formationAnimId) cancelAnimationFrame(formationAnimId);
    }
}

// 4. ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®å‡¦ç†ãƒ«ãƒ¼ãƒ—
async function analyzeFormationFrame() {
    if (!isFormationRunning || !formationDetector) return;

    formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);

    const poses = await formationDetector.estimatePoses(formationCanvas, {
        // â–¼ ä¿®æ­£: æ‰‹å‰å´ã ã‘ãªã‚‰æœ€å¤§3ã€œ4äººã§ååˆ†ã€‚å‡¦ç†ã‚‚è»½ããªã‚Šç²¾åº¦ãŒä¸ŠãŒã‚‹ã€‚
        maxPoses: 4, 
        flipHorizontal: false
    });

    // ç”»é¢æ¼”å‡ºï¼ˆå°‘ã—æš—ãã™ã‚‹ï¼‰
    formationCtx.fillStyle = "rgba(0, 0, 0, 0.3)";
    formationCtx.fillRect(0, 0, formationCanvas.width, formationCanvas.height);

    processFormationLogic(poses);

    if (!formationVideo.paused && !formationVideo.ended) {
        formationAnimId = requestAnimationFrame(analyzeFormationFrame);
    } else if (formationVideo.ended) {
        isFormationRunning = false;
        document.getElementById("btn-formation-toggle").textContent = "â–¶ æœ€åˆã‹ã‚‰";
        toggleFormationAnalysis();
    }
}

// 5. é™£å½¢åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
function processFormationLogic(poses) {
    // ã‚¹ã‚³ã‚¢åŸºæº–ï¼ˆå°‘ã—ç”˜ã‚ã«è¨­å®šã—ã¦æ‹¾ã„ã‚„ã™ãã™ã‚‹ï¼‰
    const validPoses = poses.filter(p => p.score > 0.15);

    const nearTeam = [];

    // ã‚¨ãƒªã‚¢ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€‚ãªã‘ã‚Œã°å…¨ç”»é¢ã€‚
    const area = formationAnalysisArea || { 
        x: 0, 
        y: 0, 
        w: formationCanvas.width, 
        h: formationCanvas.height 
    };

    // æç”»: æŒ‡å®šã‚¨ãƒªã‚¢ã‚’ç·‘æ ã§è¡¨ç¤ºï¼ˆç¢ºèªç”¨ï¼‰
    if (formationAnalysisArea) {
        formationCtx.strokeStyle = "rgba(0, 230, 118, 0.5)";
        formationCtx.lineWidth = 2;
        formationCtx.strokeRect(area.x, area.y, area.w, area.h);
    }

    validPoses.forEach(pose => {
        const kp = pose.keypoints;
        let yCenter = 0;
        let xCenter = 0;

        // è…°ã®ä½ç½®ï¼ˆãªã‘ã‚Œã°è‚©ï¼‰ã‚’å–å¾—
        if (kp[11].score > 0.1 && kp[12].score > 0.1) {
            xCenter = (kp[11].x + kp[12].x) / 2;
            yCenter = (kp[11].y + kp[12].y) / 2;
        } else {
            xCenter = (kp[5].x + kp[6].x) / 2;
            yCenter = (kp[5].y + kp[6].y) / 2;
        }
        
        // â˜…é‡è¦: ãã®ä½ç½®ãŒã€ŒæŒ‡å®šã‚¨ãƒªã‚¢å†…ã€ã«ã‚ã‚‹ã‹åˆ¤å®š
        const inAreaX = xCenter >= area.x && xCenter <= (area.x + area.w);
        const inAreaY = yCenter >= area.y && yCenter <= (area.y + area.h);

        // ã‚¨ãƒªã‚¢å†…ãªã‚‰æ¡ç”¨
        if (inAreaX && inAreaY) {
            nearTeam.push(pose);
        }
    });

    evaluateTeamFormation(nearTeam);
    updateFormationUI();
}

// ãƒãƒ¼ãƒ ã”ã¨ã®è©³ç´°åˆ¤å®š (é è¿‘è£œæ­£ã‚ã‚Š)
function evaluateTeamFormation(teamPoses) {
    const canvasWidth = formationCanvas.width;

    // -----------------------------------------------------
    // ãƒ‘ã‚¿ãƒ¼ãƒ³A: 2äººã¨ã‚‚æ¤œå‡ºã§ãã¦ã„ã‚‹å ´åˆ (æ­£å¸¸åˆ¤å®š)
    // -----------------------------------------------------
    if (teamPoses.length >= 2) {
        lostTrackingCount = 0; // è¦‹å¤±ã„ã‚«ã‚¦ãƒ³ã‚¿ãƒªã‚»ãƒƒãƒˆ

        // ã‚¹ã‚³ã‚¢ãŒé«˜ã„é †ã«2åé¸å‡º
        const players = teamPoses.sort((a, b) => b.score - a.score).slice(0, 2);
        
        // åº§æ¨™å–å¾— (è…°å„ªå…ˆã€ãªã‘ã‚Œã°è‚©)
        const getPos = (p) => {
            const kp = p.keypoints;
            if (kp[11].score > 0.1 && kp[12].score > 0.1) {
                return { x: (kp[11].x + kp[12].x)/2, y: (kp[11].y + kp[12].y)/2 };
            } else {
                return { x: (kp[5].x + kp[6].x)/2, y: (kp[5].y + kp[6].y)/2 };
            }
        };
        
        const pos1 = getPos(players[0]);
        const pos2 = getPos(players[1]);

        // è·é›¢è¨ˆç®—
        const dx = Math.abs(pos1.x - pos2.x);
        const dy = Math.abs(pos1.y - pos2.y);

        // â˜…æ”¹è‰¯1: é è¿‘æ³•è£œæ­£ (4.0å€ã§ç¶­æŒ)
        // å¥¥ã«è¡Œãã»ã©ç¸¦è·é›¢ãŒæ½°ã‚Œã‚‹ãŸã‚ã€å¼·åŠ›ã«è£œæ­£ã—ã¦ç¸¦åˆ¤å®šã—ã‚„ã™ãã™ã‚‹
        const weightedDy = dy * 4.0;

        // â˜…æ”¹è‰¯2: å¼·åˆ¶ãƒˆãƒƒãƒ—ï¼†ãƒãƒƒã‚¯åˆ¤å®š (Overlap Check)
        // æ¨ªå¹…(dx)ãŒç”»é¢å¹…ã®15%ä»¥ä¸‹ãªã‚‰ã€ã»ã¼ç¸¦ã«é‡ãªã£ã¦ã„ã‚‹ã¨ã¿ãªã—ã¦å¼·åˆ¶çš„ã«T&Bã«ã™ã‚‹
        const isOverlappingX = dx < (canvasWidth * 0.15);

        // åˆ¤å®š: ã€Œè£œæ­£ç¸¦è·é›¢ > æ¨ªè·é›¢ã€ ã¾ãŸã¯ ã€Œæ¨ªã«é‡ãªã£ã¦ã„ã‚‹ã€
        let isTopAndBack = (weightedDy > dx) || isOverlappingX;
        
        // çµæœã‚’æ›´æ–°ã—ã¦è¨˜æ†¶
        if (isTopAndBack) {
            lastFormationState = "Top & Back";
            lastFormationColor = "#ef5350"; // èµ¤:æ”»æ’ƒ
            formationStats.near.tb++;
        } else {
            lastFormationState = "Side by Side";
            lastFormationColor = "#1976d2"; // é’:å®ˆå‚™
            formationStats.near.ss++;
        }
        formationStats.near.total++;

        // ç¾åœ¨ã®ç·šã‚’æç”»
        formationCtx.beginPath();
        formationCtx.moveTo(pos1.x, pos1.y);
        formationCtx.lineTo(pos2.x, pos2.y);
        formationCtx.strokeStyle = lastFormationColor;
        formationCtx.lineWidth = 4;
        formationCtx.stroke();

        players.forEach(p => drawSkeleton(p, lastFormationColor));
        
        // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
        const midX = (pos1.x + pos2.x) / 2;
        const midY = (pos1.y + pos2.y) / 2;
        formationCtx.fillStyle = lastFormationColor;
        formationCtx.font = "bold 16px sans-serif";
        formationCtx.fillText(lastFormationState, midX - 40, midY - 10);
    } 
    // -----------------------------------------------------
    // ãƒ‘ã‚¿ãƒ¼ãƒ³B: é¸æ‰‹ãŒé‡ãªã£ã¦1äººã—ã‹è¦‹ãˆãªã„å ´åˆ (è‡ªå‹•è¿½å¾“)
    // -----------------------------------------------------
    else if (teamPoses.length === 1) {
        lostTrackingCount++;

        // â˜…æ”¹è‰¯3: 1äººã—ã‹ã„ãªã„ = ã€Œé‡ãªã£ã¦ã„ã‚‹(Top & Back)ã€ã¨ã¿ãªã™
        // ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã«ãŠã„ã¦ã‚¨ãƒªã‚¢å†…ã§1äººã«ãªã‚‹ã®ã¯ã€æ‰‹å‰ã®é¸æ‰‹ã«å¥¥ã®é¸æ‰‹ãŒéš ã‚ŒãŸæ™‚ã§ã™ã€‚
        // ã¤ã¾ã‚Šã€ã“ã‚Œã¯ã€Œç©¶æ¥µã®Top & Backã€çŠ¶æ…‹ã¨è¨€ãˆã¾ã™ã€‚
        
        // 3ç§’(90ãƒ•ãƒ¬ãƒ¼ãƒ )ä»¥å†…ãªã‚‰è¿½å¾“ã™ã‚‹ï¼ˆæ°¸é ã«1äººã®å ´åˆã¯é™¤å¤–ã™ã‚‹ãŸã‚ï¼‰
        if (lostTrackingCount < 90) {
            
            // å¼·åˆ¶çš„ã« T&B ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹
            lastFormationState = "Top & Back"; 
            lastFormationColor = "#ef5350"; // èµ¤
            
            formationStats.near.tb++; // â˜…T&Bã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆåŠ ç®—
            formationStats.near.total++;

            // 1äººã ã‘ã§ã‚‚éª¨æ ¼ã‚’æç”»ï¼ˆèµ¤è‰²ã§ï¼‰
            const p = teamPoses[0];
            drawSkeleton(p, lastFormationColor); 

            // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºä½ç½®ã®è¨ˆç®—
            const kp = p.keypoints;
            let px = 0, py = 0;
            // è…°ãŒã‚ã‚Œã°è…°ã€ãªã‘ã‚Œã°é¼»
            if(kp[11].score > 0.1) { 
                px = (kp[11].x + kp[12].x)/2; 
                py = (kp[11].y + kp[12].y)/2; 
            } else { 
                px = kp[0].x; 
                py = kp[0].y; 
            }

            formationCtx.fillStyle = lastFormationColor;
            formationCtx.font = "bold 16px sans-serif";
            // è‡ªå‹•åˆ¤å®šä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ©ãƒ™ãƒ«
            formationCtx.fillText("Top & Back (Auto)", px - 60, py - 40);
        }
    }
}

// ç°¡æ˜“éª¨æ ¼æç”»
function drawSkeleton(pose, color) {
    const kps = pose.keypoints;
    const edges = [
        [5,7], [7,9], [6,8], [8,10], // è…•
        [11,13], [13,15], [12,14], [14,16], // è„š
        [5,6], [11,12], [5,11], [6,12] // èƒ´ä½“
    ];

    formationCtx.strokeStyle = "white";
    formationCtx.lineWidth = 2;

    edges.forEach(([i, j]) => {
        if (kps[i].score > 0.3 && kps[j].score > 0.3) {
            formationCtx.beginPath();
            formationCtx.moveTo(kps[i].x, kps[i].y);
            formationCtx.lineTo(kps[j].x, kps[j].y);
            formationCtx.stroke();
        }
    });

    // é–¢ç¯€ç‚¹
    formationCtx.fillStyle = color;
    kps.forEach(kp => {
        if (kp.score > 0.3) {
            formationCtx.beginPath();
            formationCtx.arc(kp.x, kp.y, 4, 0, 2*Math.PI);
            formationCtx.fill();
        }
    });
}

// 6. UIæ›´æ–°
function updateFormationUI() {
    const calcPct = (val, total) => total > 0 ? Math.round((val / total) * 100) : 0;

    // æ‰‹å‰å´ (Near Side) ã®é›†è¨ˆ
    const nearTotal = formationStats.near.total;
    const nearTbPct = calcPct(formationStats.near.tb, nearTotal);
    const nearSsPct = calcPct(formationStats.near.ss, nearTotal);
    
    // è¦ç´ ã‚’IDã§å–å¾—
    const elTbVal = document.getElementById("near-tb-val");
    const elTbBar = document.getElementById("near-tb-bar");
    const elSsVal = document.getElementById("near-ss-val");
    const elSsBar = document.getElementById("near-ss-bar");

    // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›¸ãæ›ãˆã‚‹ï¼ˆã“ã“ãŒã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
    if (elTbVal) elTbVal.textContent = `${nearTbPct}%`;
    if (elTbBar) elTbBar.style.width = `${nearTbPct}%`;
    
    if (elSsVal) elSsVal.textContent = `${nearSsPct}%`;
    if (elSsBar) elSsBar.style.width = `${nearSsPct}%`;
}

// 7. ãƒªã‚»ãƒƒãƒˆ (ä¿®æ­£ç‰ˆ)
function resetFormationData() {
    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¼ãƒ­ãƒªã‚»ãƒƒãƒˆ
    formationStats = {
        far: { tb: 0, ss: 0, total: 0 },
        near: { tb: 0, ss: 0, total: 0 }
    };
    
    // UIè¡¨ç¤ºã‚‚ãƒªã‚»ãƒƒãƒˆ
    updateFormationUI();
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
    if(formationCtx && formationCanvas) {
        formationCtx.clearRect(0, 0, formationCanvas.width, formationCanvas.height);
    }
}

</script>
</body>
</html>
   
