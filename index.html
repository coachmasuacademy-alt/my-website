<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>Smart Coach Badminton</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description"
    content="ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã®ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼è‡ªå‹•ä½œæˆã€AIãƒ•ã‚©ãƒ¼ãƒ åˆ†æã€æˆ¦è¡“ãƒœãƒ¼ãƒ‰ã€ã‚²ãƒ¼ãƒ åˆ†æãŒã§ãã‚‹ç„¡æ–™Webã‚¢ãƒ—ãƒªã§ã™ã€‚åˆå¿ƒè€…æŒ‡å°ã‹ã‚‰ä¸Šç´šè€…ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã¾ã§ã€æŒ‡å°è€…ã‚„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ´»å‹•ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚">

  <meta name="keywords" content="ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³,ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼,ã‚¢ãƒ—ãƒª,AIåˆ†æ,ãƒ•ã‚©ãƒ¼ãƒ è§£æ,æˆ¦è¡“ãƒœãƒ¼ãƒ‰,æŒ‡å°,Smart Coach">

  <meta property="og:title" content="Smart Coach Badminton - ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼†AIåˆ†æã‚¢ãƒ—ãƒª">
  <meta property="og:description" content="AIã§ã®ãƒ•ã‚©ãƒ¼ãƒ åˆ†æã‚„ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆãŒã§ãã‚‹ç„¡æ–™ã‚¢ãƒ—ãƒªã§ã™ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://coachmasuacademy-alt.github.io/my-website/">
  <meta property="og:image" content="https://coachmasuacademy-alt.github.io/my-website/icon.png">

  <meta name="google-site-verification" content="Uv91Wg1kjqKD8qo3dV3MgIcSqo0z7cS3aH9yzpriLYE" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon2.png">
  <link rel="icon" type="image/png" href="icon2.png">
  <meta name="theme-color" content="#00acc1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Noto Sans JP", sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }

    h2,
    h3 {
      color: #333;
    }

    select,
    input,
    button,
    textarea {
      margin: 5px;
      padding: 6px 10px;
      font-size: 14px;
      color: #333;
      background: #fff;
      border: 1px solid #ccc;
    }

    button {
      background: #00acc1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #008c9e;
    }

    .menu-item {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .selected-item {
      background: #e0f7fa;
      border-color: #00acc1;
      cursor: grab;
    }

    .dragging {
      opacity: 0.5;
    }

    #menu-list,
    #selected-list {
      margin-top: 20px;
    }

    #program-output,
    #share-preview {
      margin-top: 30px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    textarea {
      width: 100%;
      height: 60px;
    }

    .status-message {
      margin-bottom: 10px;
      font-weight: bold;
      color: green;
    }

    /* ğŸ“ ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨CSS */
    .visual-court-container {
      position: relative;
      width: 100%;
      max-width: 350px;
      height: 190px;
      margin: 0 auto 20px auto;
      background: #2e7d32;
      border: 2px solid white;
      box-sizing: border-box;
      overflow: hidden;
    }

    .court-grid {
      display: grid;
      grid-template-columns: 1fr 4fr 4fr 1fr;
      grid-template-rows: 1fr 4fr 4fr 1fr;
      width: 100%;
      height: 100%;
    }

    .c-cell {
      border: 1px solid rgba(255, 255, 255, 0.6);
      position: relative;
    }

    .court-net {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 100%;
      background: white;
      z-index: 5;
      transform: translateX(-50%);
      border-left: 1px dashed #ddd;
    }

    .player-label {
      position: absolute;
      transform: translate(-50%, -50%);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      border: 1px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      z-index: 10;
      white-space: nowrap;
    }

    /* ãƒ€ãƒ–ãƒ«ã‚¹ã®ã‚¨ãƒªã‚¢å¤–ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆç”¨ï¼‰ */
    .area-out {
      background-color: rgba(0, 0, 0, 0.2) !important;
    }

    /* ğŸ—ºï¸ Google Charts ãƒãƒƒãƒ—ç”¨CSS */
    #map-visual-container {
      width: 100%;
      min-height: 300px;
      margin: 0 auto;
      background-color: #b3e5fc;
      /* æµ·ã®è‰² */
      border-radius: 8px;
      border: 2px solid #81d4fa;
      overflow: hidden;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .google-visualization-tooltip {
      border-radius: 4px !important;
      border: none !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3) !important;
    }

    /* ğŸ”´ éŒ²ç”»ä¸­ãƒ»åˆ†æä¸­ã®æ ç·šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .recording-active {
      border: 5px solid #ff3d00 !important;
      /* é®®ã‚„ã‹ãªèµ¤æ  */
      box-shadow: 0 0 15px rgba(255, 61, 0, 0.7) !important;
      /* èµ¤ãå…‰ã‚‰ã›ã‚‹ */
      transition: all 0.1s ease;
      /* ãƒ‘ã‚«ãƒ‘ã‚«ã—ãªã„ã‚ˆã†å°‘ã—æ»‘ã‚‰ã‹ã« */
    }

    /* ğŸŸ¡ ã‚¹ã‚¿ãƒ³ãƒã‚¤ä¸­ï¼ˆæ‰‹å‹•ONã ã‘ã©äººãŒã„ãªã„ï¼‰ã®æ ç·š */
    .recording-standby {
      border: 5px solid #ffd600 !important;
      /* é»„è‰²æ  */
      box-shadow: 0 0 10px rgba(255, 214, 0, 0.5) !important;
    }

    /* New CSS for Navigation and Screen Management (Homepage Layout) */
    .screen-content {
      display: none;
      /* å…¨ã¦ã®æ©Ÿèƒ½ç”»é¢ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º */
      padding: 10px 0;
    }

    .screen-content.active {
      display: block;
      /* é¸æŠã•ã‚ŒãŸç”»é¢ã®ã¿è¡¨ç¤º */
    }

    /* ---------------------------------------------------- */
    /* â˜…â˜…â˜… 1. ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ (ã‚¿ã‚°åŒ–) â˜…â˜…â˜… */
    /* ---------------------------------------------------- */
    #main-nav {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      /* ãƒœã‚¿ãƒ³é–“ã®é–“éš” */
      justify-content: center;
      padding: 10px 0;
      border-bottom: 2px solid #ddd;
      border-top: 2px solid #ddd;
    }

    #main-nav button {
      flex-grow: 1;
      min-width: 150px;
      max-width: 250px;
      padding: 8px 12px;

      /* åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³: è§’ã‚’ä¸¸ãã€èƒŒæ™¯ã‚’ç™½ã€æ ç·šã‚’è–„ã„é’ã« */
      border: 2px solid #b3e5fc;
      background: #ffffff;
      color: #1a237e;
      /* ãƒã‚¤ãƒ“ãƒ¼ */
      font-weight: 500;
      border-radius: 20px;
      /* ã‚¿ã‚°ã‚‰ã—ã„ä¸¸ã¿ */
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      text-align: left;
    }

    #main-nav button:hover {
      background: #e0f7fa;
      /* ãƒ›ãƒãƒ¼æ™‚ã«æ˜ã‚‹ã„é’ */
      color: #01579b;
      border-color: #01579b;
    }

    #main-nav button.active {
      /* é¸æŠçŠ¶æ…‹: èƒŒæ™¯ã‚’æ¿ƒã„é’ç·‘ã«ã—ã€æ–‡å­—ã‚’ç™½ã« */
      background: #00acc1;
      /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ */
      color: white;
      border-color: #00acc1;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    /* ---------------------------------------------------- */
    /* â˜…â˜…â˜… 2. ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„ â˜…â˜…â˜… */
    /* ---------------------------------------------------- */
    #screen-home {
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .category-card {
      /* ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å·¦å´ã®ã¿ã«ã—ã€ç«‹ä½“æ„Ÿã¨ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚’å‡ºã™ */
      border: 1px solid #e0e0e0;
      border-left: 5px solid #00acc1;
      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f8f8;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .category-card:hover {
      background: #e0f7fa;
      /* ãƒ›ãƒãƒ¼æ™‚ã«æ˜ã‚‹ã„é’ */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .category-card h4 {
      margin-top: 0;
      margin-bottom: 5px;
      color: #01579b;
      /* æ¿ƒã„é’ */
      font-size: 16px;
    }

    /* ã‚³ãƒ¼ãƒˆå›³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #court-diagram-container {
      background-color: #f9fbe7;
      /* è–„ã„ç·‘ã®èƒŒæ™¯ */
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #c5e1a5;
    }

    /* SVGè‡ªä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #court-diagram-container svg {
      width: 100%;
      /* æ¨ªå¹…ã„ã£ã±ã„ã«è¡¨ç¤º */
      height: auto;
      /* é«˜ã•ã¯è‡ªå‹• */
      max-height: 50vh;
      /* ç”»é¢åŠåˆ†ãã‚‰ã„ã®é«˜ã•ã¾ã§è¨±å®¹ */
      margin: 0 auto;
      display: block;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* SVGå†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚‚ã—ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã‚‹ãªã‚‰ï¼‰ */
    .court-label {
      font-family: sans-serif;
      font-size: 10px;
      fill: #d32f2f;
      /* èµ¤ã£ã½ã„è‰²ã§ç›®ç«‹ãŸã›ã‚‹ */
      font-weight: bold;
    }

    /* ç¿»è¨³ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰é¢ã«å‡ºã™ */
    #google_translate_element {
      position: relative;
      z-index: 2000;
      min-width: 120px;
      /* ã‚¹ãƒãƒ›ã§ã‚‚æ½°ã‚Œãªã„ã‚ˆã†ã«å¹…ã‚’ç¢ºä¿ */
      display: inline-block;
    }

    /* 2. ç¿»è¨³ãƒœã‚¿ãƒ³è‡ªä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .goog-te-gadget-simple {
      background-color: #fff !important;
      border: 1px solid #ccc !important;
      padding: 10px 15px !important;
      /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã†ã«åºƒã’ã‚‹ */
      border-radius: 30px !important;
      font-size: 14px !important;
      line-height: 1.5 !important;
      display: inline-flex !important;
      /* ä¸­èº«ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ */
      align-items: center !important;
      cursor: pointer !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: auto !important;
      /* å¹…ã‚’è‡ªå‹•èª¿æ•´ */
    }

    /* 3. ã€Œè¨€èªã‚’é¸æŠã€ãªã©ã®æ–‡å­—ã‚’ã€å¼·åˆ¶çš„ã«è¡¨ç¤ºã€‘ã•ã›ã‚‹ */
    .goog-te-gadget-simple span {
      display: inline-block !important;
      /* éè¡¨ç¤ºè¨­å®šã‚’ä¸Šæ›¸ãã—ã¦è¡¨ç¤º */
      color: #333 !important;
      font-weight: bold !important;
    }

    /* 4. ä¸è¦ãªGoogleãƒ­ã‚´ç”»åƒï¼ˆGãƒãƒ¼ã‚¯ï¼‰ã ã‘ã‚’æ¶ˆã™ */
    .goog-te-gadget-simple img {
      display: none !important;
    }

    /* 5. ç¿»è¨³ãƒœã‚¿ãƒ³ã®ä¸­ã®ã€Œ|ï¼ˆç¸¦æ£’ï¼‰ã€ã‚’æ¶ˆã™ */
    .goog-te-gadget-simple .goog-te-menu-value span[style*="border-left"] {
      border-left: none !important;
    }

    /* 6. ç¿»è¨³å¾Œã«ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã«å‡ºã‚‹ã€ŒGoogleç¿»è¨³ãƒãƒ¼ã€ã‚’æ¶ˆã™ */
    .goog-te-banner-frame.skiptranslate {
      display: none !important;
    }

    body {
      top: 0px !important;
    }

    /* 7. è¨€èªé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¹ãƒãƒ›ã§ã‚‚å¤§ããè¦‹ã‚„ã™ã */
    .goog-te-menu-frame {
      max-width: 100% !important;
      width: 100% !important;
      z-index: 10000000 !important;
      /* ç¢ºå®Ÿã«æœ€å‰é¢ã¸ */
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2) !important;
    }

    /* â–¼â–¼â–¼ ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼å´©ã‚Œä¿®æ­£ç”¨CSS â–¼â–¼â–¼ */
    @media screen and (max-width: 768px) {

      /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å…¨ä½“ã‚’ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
      .menu-item {
        flex-direction: column !important;
        /* å¼·åˆ¶çš„ã«ç¸¦ç©ã¿ã«å¤‰æ›´ */
        align-items: stretch !important;
      }

      /* å†…éƒ¨ã®è¦ç´ ï¼ˆãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã€ç”»åƒã€èª¬æ˜æ–‡ï¼‰ã‚’æ¨ªå¹…ã„ã£ã±ã„ã«ã™ã‚‹ */
      .menu-item>div {
        min-width: 0 !important;
        /* JSã§è¨­å®šã•ã‚ŒãŸ250pxåˆ¶é™ã‚’è§£é™¤ */
        width: 100% !important;
        padding-right: 0 !important;
        margin-bottom: 10px;
        /* è¦ç´ ã”ã¨ã®é–“éš” */
        flex: auto !important;
      }

      /* ç”»åƒãŒã‚ã‚‹å ´åˆã®èª¿æ•´ */
      .menu-item img {
        display: block;
        margin: 0 auto;
        /* ä¸­å¤®å¯„ã› */
        max-width: 100% !important;
        height: auto !important;
      }

      /* èª¬æ˜æ–‡ã‚¨ãƒªã‚¢ã®è¦‹ãŸç›®èª¿æ•´ */
      .menu-item>div:last-child {
        margin-bottom: 0;
      }
    }

.jump-res-card {
    background:#fafafa; 
    border:1px solid #ddd; 
    padding:10px 5px; 
    border-radius:8px; 
    font-size:12px; 
    text-align:center; 
    font-weight:bold;
    color: #444;
}
  </style>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.9/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.9/build/vfs_fonts.js"></script>
  <script src="custom_fonts.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('./sw.js').then(function (registration) {
          console.log('ServiceWorker registration successful');

          // å®šæœŸçš„ã«æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯ (ä¾‹: 1æ™‚é–“ã”ã¨)
          setInterval(() => {
            registration.update();
            console.log('Checking for updates...');
          }, 60 * 60 * 1000);

          // ã‚¢ãƒ—ãƒªã«æˆ»ã£ã¦ããŸæ™‚ã«æ›´æ–°ã‚’ãƒã‚§ãƒƒã‚¯
          document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã‚„å¾…æ©Ÿä¸­ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒãªã„ã‹ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è©¦ã¿ã‚‹
        if (registration && !registration.installing && !registration.waiting) {
            registration.update().catch(err => {
                // å†—é•·ãªã‚¨ãƒ©ãƒ¼ï¼ˆInvalidStateErrorç­‰ï¼‰ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«æµã•ãªã„ã‚ˆã†ã«å‡¦ç†
                console.warn('ServiceWorker update skipped or failed:', err.message);
            });
            console.log('App visible, checking for updates...');
        }
    }
});

          // æ›´æ–°ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
          registration.onupdatefound = function () {
            const installingWorker = registration.installing;
            installingWorker.onstatechange = function () {
              if (installingWorker.state === 'installed') {
                if (navigator.serviceWorker.controller) {
                  // æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚ã‚Š
                  if (confirm("æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå±Šã„ã¦ã„ã¾ã™ï¼\næ›´æ–°ã—ã¦æœ€æ–°æ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿ\n\n(New version available. Update?)")) {
                    // ã€ä¿®æ­£ç‚¹ã€‘ã“ã“ã§ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã€æ–°ã—ã„SWã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
                    // ã“ã‚Œã«ã‚ˆã‚Š sw.js å´ã® skipWaiting ãŒç™ºå‹•ã—ã¾ã™
                    installingWorker.postMessage({ type: 'SKIP_WAITING' });
                  }
                }
              }
            };
          };

        }, function (err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });

      // ã€é‡è¦ã€‘æ–°ã—ã„SWãŒåˆ¶å¾¡ã‚’é–‹å§‹ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆSKIP_WAITINGå¾Œï¼‰ã§ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDSzYUAvn8sOse_twlArlMqQxh1Zug02GM",
      authDomain: "badmintoncoach3work2025.firebaseapp.com",
      projectId: "badmintoncoach3work2025",
      storageBucket: "badmintoncoach3work2025.firebasestorage.app",
      messagingSenderId: "346991672016",
      appId: "1:346991672016:web:7e98ff62c499401bc4bcd5",
      measurementId: "G-YNKCYCSSPC"
    };

    // Firebaseã‚’åˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);

    // Firestoreã¨Authã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆæ¥ç¶šçª“å£ï¼‰
    const db = firebase.firestore();
    const auth = firebase.auth();

    // âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ› âš ï¸
    const GROUP_SECRET_PASSWORD = "badmintontraining2025"; // ğŸ‘ˆ ã“ã“ã«è‡ªåˆ†ã§æ±ºã‚ãŸåˆè¨€è‘‰ã‚’è¨­å®š

    let currentProgramId = "default_program";
    let isAuthenticated = false; // èªè¨¼çŠ¶æ…‹ãƒ•ãƒ©ã‚°
    let feedbackData = []; // æ„Ÿæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—

    // ==============================================
    // ... æ—¢å­˜ã®å®šæ•°ãƒ»å¤‰æ•°ã®å®šç¾©
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbw_ltWsvwzLKuMO7XUEPr8WRG-m76YnR6ZriwGId1-fBYFK0HNvrGO86ds_VU8T7sLCfA/exec";
    let sheetData = [];
    let selectedMenus = [];
    let editableName = "";
    let editablePurpose = "";
    let isProgramGenerated = false;
    let isPoseModelLoaded = false;
    let isFwModelLoaded = false;
    

// --- AIã‚¸ãƒ£ãƒ³ãƒ—æ¸¬å®šç”¨å¤‰æ•° ---
let jumpModeActive = false;
let isJumpAirborne = false;
let jumpTakeoffTime = 0;
let jumpGroundY = 0;
let jumpFacingMode = 'environment';
let prevWristPos = { x: 0, y: 0 };
let isJumpMeasuring = false; 
let latestJumpAnkleY = null;

let jumpLog = []; // æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ï¼ˆCSVå‡ºåŠ›ã«ä½¿ç”¨ï¼‰
let prevKneeAngle = 0; // å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã®è§’åº¦ï¼ˆè§’é€Ÿåº¦ã®è¨ˆç®—ã«ä½¿ç”¨ï¼‰
let jumpMaxStats = { angle: 0, av: 0, torque: 0, armV: 0 }; // 1å›ã®ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã®æœ€å¤§å€¤ã‚’ä¿æŒ
let lastFrameTime = 0; // ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã®æ™‚é–“å·®è¨ˆç®—ç”¨

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    async function loginWithPassword() {
      const passwordInput = document.getElementById("passwordInput");
      const password = passwordInput.value;
      const loginStatus = document.getElementById("login-status");

      if (password === GROUP_SECRET_PASSWORD) {
        try {

          await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);

          await auth.signInAnonymously();

          // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«UIã‚’æ›´æ–° (onAuthStateChangedãŒã“ã‚Œã‚’å—ã‘å–ã£ã¦å‡¦ç†ã—ã¾ã™)
          loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼";
          loginStatus.classList.remove('text-red-500');
          loginStatus.classList.add('text-green-500');

          // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
          passwordInput.value = '';

          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çŸ­æ™‚é–“è¡¨ç¤º
          setTimeout(() => {
            loginStatus.textContent = "";
          }, 3000);
        } catch (error) {
          console.error("Authentication Error:", error);
          loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
          loginStatus.classList.remove('text-green-500');
          loginStatus.classList.add('text-red-500');
        }
      } else {
        loginStatus.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚/The password is incorrect.";
        loginStatus.classList.remove('text-green-500');
        loginStatus.classList.add('text-red-500');
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    function logout() {
      // 1. èª¤æ“ä½œé˜²æ­¢ã®ç¢ºèª
      if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

      // 2. Firebaseã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
      auth.signOut().then(() => {
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");

        // 3. ã€é‡è¦ã€‘ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€ç”»é¢ã¨å¤‰æ•°ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹
        location.reload();

      }).catch((error) => {
        console.error("Sign Out Error:", error);
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
      });
    }

    async function loadFeedbacks() {
      const listEl = document.getElementById("feedback-list");
      listEl.innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";

      try {
        const snapshot = await db.collection("feedbacks")
          .orderBy("timestamp", "desc")
          .limit(20)
          .get();

        if (snapshot.empty) {
          listEl.innerHTML = "<p>ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString('ja-JP') : 'æ—¥ä»˜ä¸æ˜';
          const docId = doc.id; // å‰Šé™¤ã™ã‚‹ãŸã‚ã«IDãŒå¿…è¦

          html += `
                <div style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #fafafa; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <p style="margin: 0;"><strong>${data.name}</strong> <span style="font-size: 12px; color: #777;">(${date})</span></p>
                        
                        <button onclick="deleteFeedback('${docId}')" style="
                            background: #ff5252; 
                            color: white; 
                            border: none; 
                            border-radius: 4px; 
                            padding: 2px 8px; 
                            font-size: 12px; 
                            cursor: pointer;">
                            å‰Šé™¤
                        </button>
                    </div>
                    <p style="margin: 5px 0 0 0; white-space: pre-wrap;">${data.text}</p>
                </div>
            `;
        });

        listEl.innerHTML = html;

      } catch (error) {
        console.error("Error loading feedbacks: ", error);
        listEl.innerHTML = "<p style='color:red;'>æ„Ÿæƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
      }
    }

    // ===========================
    // âœ… æ„Ÿæƒ³å‰Šé™¤å‡¦ç†ï¼ˆæ–°è¦è¿½åŠ ï¼‰
    // ===========================
    async function deleteFeedback(docId) {
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      if (!confirm("æœ¬å½“ã«ã“ã®æ„Ÿæƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        return;
      }

      try {
        // Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
        await db.collection("feedbacks").doc(docId).delete();

        alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");

        // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ç”»é¢ã‚’æ›´æ–°
        await loadFeedbacks();

      } catch (error) {
        console.error("Error removing document: ", error);
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
      }
    }

    // ==============================================
    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•° (æ–°è¦è¿½åŠ )
    // ==============================================
    function showScreen(screenId, senderButton) {
      // 1. å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
      document.querySelectorAll('.screen-content').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
      });

      // 2. é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
      const targetScreen = document.getElementById(`screen-${screenId}`);
      if (targetScreen) {
        targetScreen.classList.add('active');
        targetScreen.style.display = 'block';

        // 3. ç”»é¢ã”ã¨ã®ç‰¹æ®Šå‡¦ç†
        if (screenId === 'beginner' && typeof renderBeginnerSection === 'function') {
          renderBeginnerSection();
        }

        // â–¼â–¼â–¼ è¿½åŠ : ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç”»é¢ãŒé–‹ã‹ã‚ŒãŸã‚‰ãƒãƒƒãƒ—ã‚’æç”» â–¼â–¼â–¼
        if (screenId === 'utility' && typeof renderMap === 'function') {
          // ç”»é¢æç”»ã®å®Œäº†ã‚’å°‘ã—ã ã‘å¾…ã£ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚’æç”»
          setTimeout(renderMap, 200);
        }
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

        // è¬›ç¿’ä¼šç”»é¢ã®èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        if (screenId === 'course') {
          const authContainer = document.getElementById("auth-container");
          const shareSection = document.getElementById("share-section");
          const feedbackContainer = document.getElementById("feedback-container");

          if (typeof isAuthenticated !== 'undefined' && isAuthenticated) {
            if (authContainer) authContainer.style.display = 'none';
            if (shareSection) shareSection.style.display = 'block';
            if (feedbackContainer) {
              feedbackContainer.style.display = 'block';
              if (typeof loadFeedbacks === 'function') loadFeedbacks();
            }
          } else {
            if (authContainer) authContainer.style.display = 'block';
            if (shareSection) shareSection.style.display = 'none';
            if (feedbackContainer) feedbackContainer.style.display = 'none';
          }
        }
      }

      // 4. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('#main-nav button').forEach(btn => {
        btn.classList.remove('active');
      });
      if (senderButton) {
        senderButton.classList.add('active');
      }

      // 5. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒˆãƒƒãƒ—ã«æˆ»ã™
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===========================
    // âœ… æ„Ÿæƒ³æŠ•ç¨¿å‡¦ç†
    // ===========================
    async function handleFeedbackSubmit() {
      const nameInput = document.getElementById("feedback-name");
      const textInput = document.getElementById("feedback-text");
      const statusEl = document.getElementById("feedback-status");

      const name = nameInput.value.trim() || "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼";
      const text = textInput.value.trim();

      if (!text) {
        statusEl.textContent = "æ„Ÿæƒ³æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      try {
        // 1. Firestoreã«ä¿å­˜
        await db.collection("feedbacks").add({
          name: name,
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        statusEl.textContent = "æ„Ÿæƒ³ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼";
        statusEl.style.color = "green";
        textInput.value = '';
        nameInput.value = '';

        // 2. ä¿å­˜ãŒæˆåŠŸã—ãŸã‚‰ã€ã™ãã«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦è¡¨ç¤ºæ›´æ–°
        console.log("æŠ•ç¨¿æˆåŠŸã€‚ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã™ã€‚");
        await loadFeedbacks();

        setTimeout(() => { statusEl.textContent = ""; }, 3000);

      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹
        console.error("Error writing feedback: ", error);
        statusEl.textContent = "æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: " + error.message;
        statusEl.style.color = "red";
      }
    }

    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    auth.onAuthStateChanged(user => {
      const authContainer = document.getElementById("auth-container");
      const shareSection = document.getElementById("share-section");
      const feedbackContainer = document.getElementById("feedback-container");
      const logoutBtn = document.getElementById("logout-button");

      if (user) {
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
        isAuthenticated = true;

        if (authContainer) authContainer.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'block';

        // â˜…â˜…â˜… è¬›ç¿’ä¼šç”»é¢ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã®ã¿è¡¨ç¤ºã‚’åˆ¶å¾¡ â˜…â˜…â˜…
        if (document.getElementById('screen-course')?.classList.contains('active')) {
          if (shareSection) shareSection.style.display = 'block';
          if (feedbackContainer) {
            feedbackContainer.style.display = 'block';
            // loadFeedbacks é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
            if (typeof loadFeedbacks === 'function') loadFeedbacks();
          }
        }
      } else {
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿
        isAuthenticated = false;

        if (authContainer) authContainer.style.display = 'block';
        if (logoutBtn) logoutBtn.style.display = 'none';

        // èªè¨¼ãŒå¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¸¸ã«éè¡¨ç¤º
        if (shareSection) shareSection.style.display = 'none';
        if (feedbackContainer) feedbackContainer.style.display = 'none';
      }
    });

    async function loadSheet() {
      try {
        let statusEl = document.getElementById("statusMessage");
        if (statusEl) {
          statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...ï¼Retrieving dataâ€¦";
          statusEl.style.color = "orange";
        }

        const res = await fetch(SHEET_URL);
        sheetData = await res.json();
        // â˜…ãƒã‚¤ãƒ³ãƒˆ: Fåˆ—ã®ç”»åƒURLã¯ã€ã“ã“ã§ã¯ã€Œç”»åƒURLã€ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã§ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã¦ã„ã‚‹ã¨æƒ³å®šã—ã¾ã™ã€‚
        // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

        renderBeginnerSection();

        // DOM ãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã«ã‚‚å¯¾å¿œ
        statusEl = document.getElementById("statusMessage");
        if (statusEl) {
          statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼ï¼Data acquisition successful!";
          statusEl.style.color = "green";
        }
      } catch (err) {
        alert("ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        let statusEl = document.getElementById("statusMessage");
        if (statusEl) {
          statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
          statusEl.style.color = "red";
        }
      }
    }

    // ==========================================
    // âœ… åˆå¿ƒè€…æŒ‡å°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æç”»å‡¦ç†ï¼ˆãƒªãƒ³ã‚¯æ–¹å¼ï¼‰
    // ==========================================
    function renderBeginnerSection() {
      // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const beginnerMenus = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === "åˆå¿ƒè€…æŒ‡å°");
      const section = document.getElementById("beginner-instruction-section");
      const listContainer = document.getElementById("beginner-menu-list");

      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯éè¡¨ç¤º
      if (!beginnerMenus.length) {
        section.style.display = "none";
        return;
      }

      section.style.display = "block";
      listContainer.innerHTML = "";

      beginnerMenus.forEach((menu) => {
        // å‹•ç”»IDã®æŠ½å‡º
        let videoId = "";
        const url = menu["YouTube URL"] || "";
        const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|v\/|embed\/|user\/\S+|shorts\/))([^#\?&]+)/);
        if (match && match[1]) {
          videoId = match[1];
        }

        // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        const item = document.createElement("div");
        item.style.cssText = `
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
            transition: background 0.2s; 
            display: flex; 
            align-items: center; 
            gap: 15px;
        `;
        // ãƒ›ãƒãƒ¼åŠ¹æœ
        item.onmouseover = () => { item.style.background = "#f1f8e9"; };
        item.onmouseout = () => { item.style.background = "transparent"; };

        // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ
        let thumbHtml = "";
        if (videoId) {
          thumbHtml = `<img src="https://img.youtube.com/vi/${videoId}/default.jpg" style="width: 80px; height: 60px; object-fit: cover; border-radius: 6px;">`;
        } else {
          thumbHtml = `<div style="width:80px; height:60px; background:#eee; border-radius:6px; display:flex; align-items:center; justify-content:center;">No Video</div>`;
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸­èº«ï¼ˆã€ŒYouTubeã§è¦‹ã‚‹ã€ã¨ã„ã†æ–‡è¨€ã‚’è¿½åŠ ï¼‰
        item.innerHTML = `
            ${thumbHtml}
            <div>
                <div style="font-weight: bold; font-size: 15px; color: #333; margin-bottom: 4px;">
                    ${menu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å} <span style="font-size:12px; color:#1a73e8;">(YouTube â†—)</span>
                </div>
                <div style="font-size: 12px; color: #666;">${menu.èª¬æ˜ || ""}</div>
            </div>
        `;

        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œï¼šwindow.openã§é–‹ã
        item.onclick = () => {
          if (videoId) {
            const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;
            window.open(watchUrl, '_blank');
          } else {
            alert("å‹•ç”»URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
          }
        };

        listContainer.appendChild(item);
      });
    }

    function renderSharePreview(lang = 'ja') {
      const preview = document.getElementById("share-preview");
      if (!preview) return;

      const { name, purpose, totalTime } = generateProgramInfo();
      const t = translations[lang] || translations.ja;


      let html = `
            <h3>${name}</h3>
            <p>${purpose}</p>
            <p id="total-time-display"><strong>${t.totalTimeLabel}ï¼š<span id="total-time">${totalTime}</span> ${lang === 'ja' ? 'åˆ†' : 'min'}</strong></p>
            <hr>
        `;

      selectedMenus.forEach(m => {
        // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã«ã‚‚ç”»åƒURLã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ã€m.imgUrlã‚’ã“ã“ã§ã‚‚åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
        html += `
                <p>
                    <strong>[${m.category}] ${m.name}</strong>
                    ${m.time ? `ï¼ˆ${m.time}${lang === 'ja' ? 'åˆ†' : 'min'}ï¼‰` : ""}
                    <br>
                    ${m.note ? m.note : ""}
                </p>
            `;
      });

      preview.innerHTML = html;
    }

    async function showMenu(category) {
      if (!sheetData.length) {
        await loadSheet();
      }
      const menus = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === category);
      const menuContainer = document.getElementById("menu-list");

      if (!menus.length) {
        menuContainer.innerHTML = `<p>ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
      }

      // â–¼ è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®HTML
      const closeBtnHtml = `
        <div style="text-align: right; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 5px;">
            <button id="close-menu-list-btn" style="background: #757575; color: white; border: none; border-radius: 4px; padding: 5px 15px; cursor: pointer;">
                Ã— ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
            </button>
        </div>
    `;

      const menuItemsHtml = menus.map((m, i) => {
        const imageUrl = m["ç”»åƒURL"] && m["ç”»åƒURL"].trim() ? m["ç”»åƒURL"].trim() : null;
        const englishCategories = ["Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength", "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice"];
        const isEnglishCategory = englishCategories.includes(category);
        const descriptionText = m.èª¬æ˜ || "Description is being prepared.";

        const readButtonHtml = isEnglishCategory ?
          `<div style="margin-bottom: 8px; display: block; text-align: left;">
                <button onclick="speakText('${encodeURIComponent(descriptionText)}', 'en-US')" style="font-size: 12px; padding: 6px 10px; background: #3f51b5; color: white; margin-right: 8px;">ğŸ”Š Listen (EN)</button>
                <button onclick="stopSpeech()" style="font-size: 12px; padding: 6px 10px; background: #f44336; color: white;">â¹ï¸ Stop</button>
            </div>` : '';

        const descriptionBody = m.èª¬æ˜ ? m.èª¬æ˜ : (isEnglishCategory ? "Description is being prepared." : "èª¬æ˜ã¯æº–å‚™ä¸­ã§ã™ã€‚");

        const imageHtml = `<div style="flex: 0 0 auto; width: 120px; height: 120px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; margin-right: 5px; overflow: hidden;">
                ${imageUrl ? `<img src="${imageUrl}" alt="${m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}ã®ç”»åƒ" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">` : ''}
            </div>`;

        // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: é…åˆ—ã« "ã‚²ãƒ¼ãƒ ", "Game" ã‚’è¿½åŠ  â–¼â–¼â–¼
        const controlsHtml = `
            <div style="flex: 2; padding-right: 15px; min-width: 250px;"> 
                <h3 style="margin: 0 0 5px 0;">${m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}</h3>
                ${m["YouTube URL"] ? `<a href="${m["YouTube URL"]}" target="_blank" style="display:inline-block; margin-bottom:8px;">ğŸ¥ å‹•ç”»ã‚’è¦‹ã‚‹ï¼Watch on YouTube</a><br>` : ""}
                ${["ãƒãƒƒã‚¯ç³»", "ãƒ©ãƒªãƒ¼ç³»", "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "ã‚²ãƒ¼ãƒ ", "Game", "Knock", "Rally", "Warm-up", "Footwork", "Break (Preparing the next plan)", "Physical"].includes(category)
            ? `æ™‚é–“(åˆ†): <input type="number" min="0.1" step="0.1" value="${m["å¹³å‡æ™‚é–“ï¼ˆåˆ†ï¼‰"] || ""}" data-time-minutes style="width:60px;">`
            : ""}
                <button data-add data-index="${i}" style="margin-left:8px;">è¿½åŠ </button>
            </div>
        `;

        const descriptionHtml = `<div style="flex: 3; font-size: 13px; color: #555; background:#fafafa; padding:8px; border-radius:4px; line-height: 1.5;">
                ${readButtonHtml} 
                <p style="margin: 0; padding: 0;">${descriptionBody}</p> 
            </div>`;

        return `<div class="menu-item" style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border-bottom: 1px solid #eee;">
                ${controlsHtml}
                ${imageHtml}
                ${descriptionHtml}
            </div>`;
      }).join("");

      // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
      menuContainer.innerHTML = closeBtnHtml + menuItemsHtml;

      // â–¼ è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‹•ä½œè¨­å®š
      document.getElementById("close-menu-list-btn").addEventListener("click", () => {
        menuContainer.innerHTML = ""; // ãƒªã‚¹ãƒˆã‚’æ¶ˆã™
        document.getElementById("category").value = ""; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      });

      // æ—¢å­˜ã®ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      const menusForEvent = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === category);
      menuContainer.querySelectorAll("[data-add]").forEach(btn => {
        btn.addEventListener("click", e => {
          const idx = parseInt(e.target.dataset.index);
          const menu = menusForEvent[idx];
          let timeValue = 0;

          // æ™‚é–“å…¥åŠ›ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒªã®å ´åˆã®ãƒã‚§ãƒƒã‚¯
          if (!["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(menu.ã‚«ãƒ†ã‚´ãƒª)) {

            const inputEl = e.target.closest('.menu-item').querySelector('[data-time-minutes]');
            const inputVal = inputEl ? inputEl.value : "";

            // âœ… ä¿®æ­£ï¼šæ™‚é–“ãŒç©ºæ¬„ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã—ã¦çµ‚äº†
            if (inputVal === "") {
              alert("æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nPlease enter the time.");
              return; // ã“ã“ã§å‡¦ç†ã‚’ã‚¹ãƒˆãƒƒãƒ—
            }

            timeValue = parseFloat(inputVal);
          }

          selectedMenus.push({
            category: menu.ã‚«ãƒ†ã‚´ãƒª,
            name: menu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å,
            sets: "",
            perSet: 0,
            time: timeValue,
            url: menu["YouTube URL"] || "",
            note: menu.èª¬æ˜ || "",
            imgUrl: menu["ç”»åƒURL"] || ""
          });
          renderSelectedList();
        });
      });
    }


    function renderSelectedList() {
      const selDiv = document.getElementById("selected-list");
      selDiv.innerHTML = "";

      selectedMenus.forEach((m, i) => {
        const div = document.createElement("div");
        div.className = "selected-item menu-item";
        div.draggable = true;
        div.dataset.index = i;

        // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã§å†…å®¹ã‚’è¿½åŠ 
        const textNode = document.createTextNode(`[${m.category}] ${m.name}${m.time ? `ï¼ˆ${m.time}åˆ†ï¼‰` : ""}${m.note ? `ï¼š${m.note}` : ""}`);
        div.appendChild(textNode);

        const btn = document.createElement("button");
        btn.textContent = "Ã—";
        btn.style.marginLeft = "10px";
        btn.addEventListener("click", () => {
          selectedMenus.splice(i, 1);
          renderSelectedList();
        });

        div.appendChild(btn);
        selDiv.appendChild(div);
      });

      // ç·æ™‚é–“æ›´æ–°
      let totalTime = selectedMenus.reduce((sum, m) => {
        return sum + (m.time || 0);
      }, 0);
      document.getElementById("total-time").textContent = totalTime.toFixed(1);

      enableDragAndDrop();
      updateTimeProgress();
    }

    // ===========================
    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    // ===========================
    function enableDragAndDrop() {
      const items = document.querySelectorAll("#selected-list .selected-item");
      const container = document.getElementById("selected-list");

      items.forEach(item => {
        item.addEventListener("dragstart", e => {
          item.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });

        item.addEventListener("dragend", () => {
          item.classList.remove("dragging");
        });
      });

      container.addEventListener("dragover", e => {
        e.preventDefault();
        const dragging = document.querySelector(".dragging");
        const afterElement = getDragAfterElement(container, e.clientY);

        if (afterElement == null) {
          container.appendChild(dragging);
        } else {
          container.insertBefore(dragging, afterElement);
        }
      });

      container.addEventListener("drop", () => {
        const newOrder = Array.from(
          container.querySelectorAll(".selected-item")
        ).map(el => selectedMenus[parseInt(el.dataset.index)]);

        selectedMenus = newOrder.filter(Boolean);
        renderSelectedList();
      });
    }

    // ===========================
    // æ™‚é–“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
    // ===========================
    function updateTimeProgress() {
      const targetEl = document.getElementById("target-time");
      const bar = document.getElementById("time-progress-bar");
      const status = document.getElementById("time-status");
      if (!targetEl || !bar || !status) return;

      // total ã¨ target ã‚’1å›ã ã‘è¨ˆç®—
      const total = selectedMenus.reduce((sum, m) => sum + (m.time || 0), 0);

      // âœ… ã“ã“ã‚’ä¿®æ­£ (cconst -> const)
      const targetVal = targetEl.value;
      const target = targetVal === "" ? 0 : parseFloat(targetVal);

      const percent = target > 0 ? Math.min((total / target) * 100, 100) : 0;

      bar.style.width = percent + "%";
      bar.style.background = percent >= 100 ? "#e53935" : "#4caf50";

      // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ã£ã¦ç©ºã§ã‚‚è‹±èªè¡¨ç¤ºã•ã‚Œã‚‹
      const t = translations[currentLang];
      status.textContent = `${t.now} ${total} / ${target} ${t.minutes}`;
    }

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll(".selected-item:not(.dragging)")];
      return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    window.removeSelected = function (i) {
      selectedMenus.splice(i, 1);
      renderSelectedList();
    };

    function generateProgramInfo() {
      const formName = document.getElementById('editable-name')?.value;
      const formPurpose = document.getElementById('editable-purpose')?.value;
      const totalTime = selectedMenus.reduce((sum, m) => sum + (m.time || 0), 0);
      const timeByCat = {};
      selectedMenus.forEach(m => {
        timeByCat[m.category] = (timeByCat[m.category] || 0) + (m.time || 0);
      });

      const sorted = Object.entries(timeByCat).sort((a, b) => b[1] - a[1]);
      const mainCategory = sorted[0] ? sorted[0][0] : "";
      const mainTime = sorted[0] ? sorted[0][1] : 0;
      const mainShare = totalTime > 0 ? mainTime / totalTime : 0;

      const label = {
        "ãƒ©ãƒªãƒ¼ç³»": "ãƒ©ãƒªãƒ¼",
        "ãƒãƒƒã‚¯ç³»": "ãƒãƒƒã‚¯",
        "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯": "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯",
        "ãƒ•ã‚£ã‚¸ã‚«ãƒ«": "ãƒ•ã‚£ã‚¸ã‚«ãƒ«",
        "è£œå¼·": "è£œå¼·",
        "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—": "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—",
        "çŸ¥è­˜": "çŸ¥è­˜",
        "æ³•æ”¿å¤§å­¦ç·´ç¿’": "æ³•æ”¿å¤§å­¦ç·´ç¿’",
        "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰": "ä¼‘æ†©",
        // â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼
        "ã‚²ãƒ¼ãƒ ": "ã‚²ãƒ¼ãƒ ç·´ç¿’",
        "Game": "Game",
        // AIæŠ½å‡ºãªã©ã§ã€Œç³»ã€ãŒã¤ã‹ãªã„å ´åˆã¸ã®ä¿é™º
        "ãƒ©ãƒªãƒ¼": "ãƒ©ãƒªãƒ¼",
        "ãƒãƒƒã‚¯": "ãƒãƒƒã‚¯"
      };

      let programName = (currentLang === 'ja') ? "ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ " : "Comprehensive Training Program";
      if (mainShare >= 0.5) {
        programName = `${label[mainCategory] || mainCategory}é›†ä¸­ãƒ—ãƒ­ã‚°ãƒ©ãƒ `;
      } else if (sorted.length > 1) {
        const second = sorted[1][0], secondTime = sorted[1][1];
        const combinedShare = (mainTime + secondTime) / totalTime;
        if (combinedShare >= 0.65) {
          programName = `${label[mainCategory] || mainCategory}ï¼†${label[second] || second}çµ±åˆãƒ—ãƒ­ã‚°ãƒ©ãƒ `;
        } else {
          programName = `ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆ${label[mainCategory] || mainCategory}ä¸­å¿ƒï¼‰`;
        }
      }

      const keywordMap = [
        { keys: ["ã‚¹ãƒ†ãƒƒãƒ—", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "æ©Ÿå‹•"], goal: "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼æ©Ÿå‹•åŠ›" },
        { keys: ["ãƒ€ãƒƒã‚·ãƒ¥", "ã‚¹ãƒ—ãƒªãƒ³ãƒˆ", "ã‚¹ãƒ”ãƒ¼ãƒ‰", "ç¬ç™º"], goal: "ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ç¬ç™ºåŠ›" },
        { keys: ["æŒä¹…", "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ãƒ©ãƒ³"], goal: "æŒä¹…åŠ›" },
        { keys: ["ã‚¸ãƒ£ãƒ³ãƒ—", "ãƒ—ãƒ©ã‚¤ã‚ª"], goal: "ç¬ç™ºåŠ›ï¼ã‚¸ãƒ£ãƒ³ãƒ—åŠ›" },
        { keys: ["ä½“å¹¹", "ã‚³ã‚¢", "å§¿å‹¢"], goal: "ä½“å¹¹ï¼å®‰å®šæ€§" },
        { keys: ["ç­‹åŠ›", "ã‚¦ã‚§ã‚¤ãƒˆ", "ç­‹ãƒˆãƒ¬"], goal: "ç­‹åŠ›å¼·åŒ–" },
        { keys: ["ãƒ©ãƒªãƒ¼", "ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯", "ãƒ‰ãƒ©ã‚¤ãƒ–"], goal: "ãƒ©ãƒªãƒ¼æŠ€è¡“ï¼å®‰å®šæ€§" },
        { keys: ["ã‚µãƒ¼ãƒ–", "ãƒ¬ã‚·ãƒ¼ãƒ–"], goal: "ã‚µãƒ¼ãƒ–ï¼ãƒ¬ã‚·ãƒ¼ãƒ–" },
        { keys: ["æˆ¦è¡“", "çŸ¥è­˜", "ç†è«–"], goal: "æˆ¦è¡“ç†è§£ï¼æŠ€è¡“ç†è§£" },
        { keys: ["è£œå¼·", "ãƒãƒ©ãƒ³ã‚¹", "ä½“å¹¹ãƒˆãƒ¬", "ãƒªãƒãƒ“ãƒª"], goal: "è£œå¼·ãƒ»ã‚±ã‚¬äºˆé˜²ï¼å®‰å®šæ€§å¼·åŒ–" }
      ];

      const detected = new Set();
      selectedMenus.forEach(m => {
        const text = ((m.name || "") + " " + (m.note || "")).toLowerCase();
        keywordMap.forEach(k => {
          k.keys.forEach(kw => {
            if (text.includes(kw.toLowerCase())) detected.add(k.goal);
          });
        });
      });

      let purpose = "";

      // ä¸­å¿ƒã‚«ãƒ†ã‚´ãƒªã®æ¯”ç‡ãŒ50%ä»¥ä¸Šã®å ´åˆã«è©³ç´°æ–‡ç« ã‚’è¨­å®š
      if (mainShare >= 0.4) {
        switch (mainCategory) {
          case "ãƒãƒƒã‚¯ç³»":
          case "ãƒãƒƒã‚¯": // â† ä¿é™ºã¨ã—ã¦è¿½åŠ 
            purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ãƒãƒƒã‚¯ç·´ç¿’ã‚’ä¸­å¿ƒã«æ§‹æˆã—ã€ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã¨æŠ€è¡“ã®å®‰å®šæ€§å‘ä¸Šã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
é«˜ã„å¼·åº¦ã§ã®æ‰“æ’ƒã‚„ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’é€šã˜ã¦ã€è©¦åˆä¸­ã§ã‚‚å®‰å®šã—ã¦å‹•ã‘ã‚‹èº«ä½“èƒ½åŠ›ã‚’é¤Šã†ã¨ã¨ã‚‚ã«ã€å„ã‚·ãƒ§ãƒƒãƒˆã®ç²¾åº¦ã‚’é«˜ã‚ã¾ã™ã€‚`;
            break;
          case "ãƒ©ãƒªãƒ¼ç³»":
          case "ãƒ©ãƒªãƒ¼":
            purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ãƒ©ãƒªãƒ¼ç·´ç¿’ã‚’å¤šãå–ã‚Šå…¥ã‚Œã€å®Ÿè·µçš„ãªçŠ¶æ³ã®ä¸­ã§æŠ€è¡“ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
ç›¸æ‰‹ã¨ã®é§†ã‘å¼•ãã‚„ãƒ©ãƒªãƒ¼å±•é–‹ã‚’é€šã˜ã¦ã€åˆ¤æ–­åŠ›ãƒ»æˆ¦è¡“ç†è§£ãƒ»å¿œç”¨åŠ›ã‚’é¤Šã„ã€è©¦åˆã§ç”Ÿãã‚‹ãƒ—ãƒ¬ãƒ¼ã®è³ªã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚`;
            break;
          case "ã‚²ãƒ¼ãƒ ":
          case "Game":
            purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã‚²ãƒ¼ãƒ ï¼ˆå®Ÿæˆ¦ï¼‰å½¢å¼ã®ç·´ç¿’ã‚’ä¸­å¿ƒã«ã€æˆ¦è¡“ã®ç¢ºèªã¨å¿œç”¨åŠ›ã®å‘ä¸Šã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚
ç·´ç¿’ã§åŸ¹ã£ãŸæŠ€è¡“ã‚’å®Ÿæˆ¦ã®ä¸­ã§ã©ã†æ´»ã‹ã™ã‹ã‚’ç¢ºèªã—ã€ã‚²ãƒ¼ãƒ å‹˜ã‚„é§†ã‘å¼•ãã®èƒ½åŠ›ã‚’é¤Šã„ã¾ã™ã€‚`;
            break;
          case "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—":
            purpose = `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã€ç·´ç¿’å‰ã«èº«ä½“ã‚’å®‰å…¨ã‹ã¤åŠ¹ç‡çš„ã«å‹•ã‹ã™ãŸã‚ã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚
é–¢ç¯€å¯å‹•åŸŸã®æ‹¡å¤§ã¨ç­‹æ¸©ã®ä¸Šæ˜‡ã‚’ç›®çš„ã¨ã—ã€æ€ªæˆ‘ã®äºˆé˜²ã¨å‹•ä½œã®ã‚­ãƒ¬ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç‹™ã„ã¾ã™ã€‚`;
            break;
          case "ãƒ•ã‚£ã‚¸ã‚«ãƒ«":
            purpose = `ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã«å¿…è¦ãªã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»ç¬ç™ºåŠ›ãƒ»ä½“å¹¹å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ãŸãƒ•ã‚£ã‚¸ã‚«ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä¸­å¿ƒã«å®Ÿæ–½ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒˆä¸Šã§ã®ç´ æ—©ã„å‹•ãå‡ºã—ã‚„å§¿å‹¢åˆ¶å¾¡ã‚’å¼·åŒ–ã—ã€è©¦åˆä¸­ã®å‹•ä½œåŠ¹ç‡ã¨æŒä¹…æ€§ã®å‘ä¸Šã‚’ç‹™ã„ã¾ã™ã€‚`;
            break;
          case "è£œå¼·":
            purpose = "ç­‹åŠ›ãƒ»ä½“å¹¹ã®å®‰å®šæ€§å‘ä¸ŠãŠã‚ˆã³ã‚±ã‚¬ã®äºˆé˜²ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚";
            break;
          default:
            purpose = `${label[mainCategory] || mainCategory}ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚`;
        }
      } else {
        // ä¸­å¿ƒã‚«ãƒ†ã‚´ãƒªãŒãªã„å ´åˆã¯æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ®‹ã™
        if (detected.size > 0) {
          const arr = Array.from(detected);

          // ğŸŒŸ ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: è¨€èªåˆ¤å®šã‚’è¿½åŠ ã—ã€ç›®çš„æ–‡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
          if (currentLang === 'ja') {
            purpose = `${arr.slice(0, 3).join("ã€")}ã®å‘ä¸Šã‚’ä¸»ãªç›®çš„ã¨ã™ã‚‹ã€‚`;
          } else {
            // è‹±èªã®ç›®çš„æ–‡ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è‹±èªã§è¡¨ç¤ºã™ã‚‹ã“ã¨ã¯è¤‡é›‘ãªã®ã§ã€ã“ã“ã§ã¯æ±ç”¨çš„ãªè¡¨ç¾ã‚’ä½¿ã†ã‹ã€arrã®å„è¦ç´ ã‚’äº‹å‰ã«ç¿»è¨³ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
            // arrã®è¦ç´ ï¼ˆä¾‹: "Rally", "Footwork"ï¼‰ã¯è‹±èªãªã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€ã“ã“ã§ã¯æ±ç”¨çš„ãªè¡¨ç¾ã‚’æ¡ç”¨ã—ã¾ã™ã€‚
            // ã‚‚ã—arrã®è¦ç´ ã‚’ãã®ã¾ã¾ä½¿ã†å ´åˆã¯ã€
            // purpose = `The primary goal is to improve skills such as ${arr.slice(0, 3).join(", ")}.`;

            // æ±ç”¨çš„ãªè¡¨ç¾
            purpose = "The main objective is to improve key skills and conditioning detected in the selected menus.";
          }
        } else {
          // ğŸ’¡ ã“ã®è¡Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ - ã“ã‚Œã¯å‰å›ã®ä¿®æ­£ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“)

          if (currentLang === 'ja') {
            purpose = `${label[mainCategory] || mainCategory}ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚`;
          } else {
            // è‹±èªã®å ´åˆã®é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
            const label_en = {
              "Rally": "Rally", "Knock": "Knock", "Footwork": "Footwork",
              "Physical": "Physical", "Strength": "Strength", "Warm-up": "Warm-up",
              "Knowledge": "Knowledge", "Hosei Univ Practice": "Hosei Univ Practice",
              "Break (Preparing the next plan)": "Break",
              // Generalãªã©ã®ã‚«ãƒ†ã‚´ãƒªãŒãªã„å ´åˆã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              "General": "General Skill"
            };
            const mainCat = mainCategory || 'General';
            purpose = `Aims to strengthen ${label_en[mainCat] || mainCat}.`;
          }
        }
      }

      return {
        name: formName || programName,
        purpose: formPurpose || purpose,
        totalTime: parseFloat(totalTime.toFixed(1))
      };
    }

    async function displayProgram() {
      if (!selectedMenus.length) return alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“\nNo plan has been selected.");

      // â˜…ä½œæˆæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ONã«ã™ã‚‹
      isProgramGenerated = true;

      // â˜…è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºã™ã‚‹ï¼ˆã“ã‚ŒãŒã€Œè¡¨ç¤ºã•ã‚Œãªã„ã€å¯¾ç­–ã§ã™ï¼‰
      const outputDiv = document.getElementById("program-output");
      outputDiv.style.display = "block";

      try {
        const { name, purpose, totalTime } = generateProgramInfo();
        editableName = name;
        editablePurpose = purpose;

        const startInput = document.getElementById("start-time")?.value || "00:00";
        let [startHour, startMin] = startInput.split(":").map(v => parseInt(v) || 0);
        let currentTime = startHour * 60 + startMin;

        const formatTime = (min) => {
          const h = Math.floor(min / 60);
          const m = min % 60;
          return `${h}:${m.toString().padStart(2, "0")}`;
        };

        const mainCategories = [
          "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ©ãƒªãƒ¼ç³»", "ãƒãƒƒã‚¯ç³»", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "è£œå¼·",
          "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "æ–°è¦ä½œæˆ",
          // â–¼ è¿½åŠ  â–¼
          "ã‚²ãƒ¼ãƒ ", "ãƒãƒƒã‚¯", "ãƒ©ãƒªãƒ¼",
          // â–² è¿½åŠ  â–²
          "Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength",
          "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice",
          // â–¼ è¿½åŠ  â–¼
          "Game"
          // â–² è¿½åŠ  â–²
        ];
        const mainList = selectedMenus.filter(m => mainCategories.includes(m.category));

        let html = `
    <label id="program-name-label" for="program-name">ãƒ—ãƒ­ã‚°ãƒ©ãƒ åï¼š</label><br>
    <input type="text" id="editable-name" value="${editableName}" style="width:100%;"><br>
    <label id="program-goal-label" for="program-goal">ç›®çš„ï¼š</label><br>
    <textarea id="editable-purpose">${editablePurpose}</textarea>

    <h4 id="program-content-title">ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…å®¹ã€‘</h4>
    <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; table-layout:auto; word-wrap:break-word;">
      <thead style="background:#e0f7fa;">
        <tr>
          <th id="th-time" style="width:15%; text-align:center;">æ™‚é–“</th>
          <th id="th-main-training" style="width:45%; text-align:center;">ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</th>
          <th id="th-additional-info" style="width:25%; text-align:left;">è£œè¶³èª¬æ˜</th>
          <th id="th-youtube" style="width:15%; text-align:center;">YouTube</th>
        </tr>
      </thead>
      <tbody>
    `;

        for (const main of mainList) {
          const start = formatTime(currentTime);
          const duration = (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(main.category)) ? 0 : (main.time || 0);
          currentTime += duration;
          const end = formatTime(currentTime);

          // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
          let urlHtml = "";
          if (main.url) {
            try {
              const cleanUrl = main.url.trim().replace(/\s+/g, "");
              const tempDiv = document.createElement("div");
              new QRCode(tempDiv, { text: cleanUrl, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.L });
              const canvas = tempDiv.querySelector("canvas");
              if (canvas) {
                const qrDataUrl = canvas.toDataURL("image/png");
                urlHtml = `<a href="${cleanUrl}" target="_blank"><img src="${qrDataUrl}" alt="QR" width="80" height="80"></a><br><a href="${cleanUrl}" target="_blank" style="font-size:12px; color:#007acc;">Link</a>`;
              } else {
                urlHtml = `<a href="${cleanUrl}" target="_blank" style="font-size:12px;">Link</a>`;
              }
            } catch (qrError) {
              urlHtml = `<a href="${main.url}" target="_blank" style="font-size:12px;">Link</a>`;
            }
          }

          html += `
        <tr>
          <td>${start}â€“${end}</td>
          <td>[${main.category}] ${main.name}${duration ? `ï¼ˆ${duration}åˆ†ï¼‰` : ""}</td>
          <td style="padding:0; text-align:left;">
            <textarea data-note-index="${mainList.indexOf(main)}"
              style="width:95%; height:120%; box-sizing:border-box; border:none; resize:none; padding:6px; font-family:'Noto Sans JP',sans-serif; font-size:13px;">${main.note || ""}</textarea>
          </td>
          <td>${urlHtml}</td>
        </tr>
      `;
        }
        html += `</tbody></table><p><b>ç·æ™‚é–“ï¼š${totalTime}åˆ†</b></p>`;

        // ç”Ÿæˆã—ãŸHTMLã‚’æŒ¿å…¥
        outputDiv.innerHTML = html;

        // è£œè¶³èª¬æ˜ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
        document.querySelectorAll("textarea[data-note-index]").forEach(input => {
          input.addEventListener("input", e => {
            const idx = parseInt(e.target.dataset.noteIndex);
            const main = mainList[idx];
            const target = selectedMenus.find(m => m.name === main.name && m.category === main.category);
            if (target) target.note = e.target.value;
          });
        });

      } catch (err) {
        console.error("Display Program Error:", err);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
      }
    }

    async function copyProgramText() {
      if (!selectedMenus.length) {
        alert("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nThe program has not been created.");
        return;
      }

      editableName = document.getElementById("editable-name")?.value || editableName;
      editablePurpose = document.getElementById("editable-purpose")?.value || editablePurpose;

      const startInput = document.getElementById("start-time")?.value || "00:00";
      let [startHour, startMin] = startInput.split(":").map(v => parseInt(v) || 0);
      let currentTime = startHour * 60 + startMin;

      const formatTime = (min) => {
        const h = Math.floor(min / 60);
        const m = min % 60;
        return `${h}:${m.toString().padStart(2, "0")}`;
      };

      const mainCategories = [
        "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ©ãƒªãƒ¼ç³»", "ãƒãƒƒã‚¯ç³»", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "è£œå¼·",
        "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "æ–°è¦ä½œæˆ",
        // â–¼ è¿½åŠ  â–¼
        "ã‚²ãƒ¼ãƒ ", "ãƒãƒƒã‚¯", "ãƒ©ãƒªãƒ¼",
        // â–² è¿½åŠ  â–²
        "Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength",
        "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice",
        // â–¼ è¿½åŠ  â–¼
        "Game"
        // â–² è¿½åŠ  â–²
      ];
      const mainList = selectedMenus.filter(m => mainCategories.includes(m.category));

      let rows = "";

      for (const main of mainList) {
        const start = formatTime(currentTime);
        const duration = (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(main.category)) ? 0 : (main.time || 0);
        currentTime += duration;
        const end = formatTime(currentTime);

        let urlHtml = "";
        if (main.url) {
          try {
            const qrDataUrl = await QRCode.toDataURL(main.url, { width: 80, margin: 1 });
            // ãƒªãƒ³ã‚¯ä»˜ãQRã‚³ãƒ¼ãƒ‰
            urlHtml = `<a href="${main.url}" target="_blank"><img src="${qrDataUrl}" width="80" height="80"></a>`;
          } catch (err) {
            console.error("QRç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
            urlHtml = `<a href="${main.url}" target="_blank">${main.url}</a>`;
          }
        }

        rows += `
      <tr>
        <td>${start}â€“${end}</td>
    <td>[${main.category}] ${main.name}</td>
    <td style="text-align:left; white-space:pre-wrap; word-break:break-word;">
      ${(main.note || "").replace(/\n/g, "<br>")}
    </td>
    <td>${urlHtml}</td>
      </tr>
    `;
      }

      const totalTimeFixed = selectedMenus.reduce((sum, m) => {
        if (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(m.category)) return sum;
        return sum + (m.time || 0);
      }, 0);

      const html = `
    <div style="font-family:'Noto Sans JP',sans-serif; color:#333;">
      <h3 style="color:#00796b;"> ãƒ—ãƒ­ã‚°ãƒ©ãƒ åï¼š${editableName}</h3>
      <p><b> ç›®çš„ï¼š</b>${editablePurpose}</p>
      <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; text-align:center; font-size:13px;">
        <thead style="background:#e0f7fa;">
          <tr>
            <th>æ™‚é–“</th>
            <th>ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</th>
            <th>è£œè¶³èª¬æ˜</th>
            <th>YouTubeï¼ˆQRï¼‰</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <p style="margin-top:10px;"><b>ğŸ•’ ç·æ™‚é–“ï¼š</b>${totalTimeFixed}åˆ†</p>
    </div>
  `;

      // HTMLï¼‹ãƒ†ã‚­ã‚¹ãƒˆã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      const blobHTML = new Blob([html], { type: "text/html" });
      const blobText = new Blob([html.replace(/<[^>]+>/g, '')], { type: "text/plain" });
      const data = new ClipboardItem({
        "text/html": blobHTML,
        "text/plain": blobText
      });

      await navigator.clipboard.write([data]);
      alert("ğŸ¨ QRã‚³ãƒ¼ãƒ‰ä»˜ãã§ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nWordãƒ»Gmailãƒ»Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘å¯èƒ½ã§ã™ã€‚");
    }

    function speakText(encodedText, lang = 'en-US') {
      // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
      window.speechSynthesis.cancel();

      // èª­ã¿ä¸Šã’ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
      const text = decodeURIComponent(encodedText);

      // SpeechSynthesisãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);

        // è¨€èªè¨­å®š
        utterance.lang = lang;

        // é©åˆ‡ãªè‹±èªã®éŸ³å£°ã‚’é¸æŠ (éåŒæœŸèª­ã¿è¾¼ã¿å¯¾å¿œã®ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä½¿ç”¨)
        const loadVoices = () => {
          const voices = window.speechSynthesis.getVoices();
          const enVoice = voices.find(voice =>
            voice.lang.startsWith(lang.substring(0, 2)) &&
            (voice.name.includes("Google") || voice.name.includes("Alex") || voice.name.includes("Samantha"))
          );

          if (enVoice) {
            utterance.voice = enVoice;
          } else {
            console.warn(`Voice for ${lang} not explicitly found. Using default.`);
          }

          // èª­ã¿ä¸Šã’é–‹å§‹
          window.speechSynthesis.speak(utterance);
        };

        // ãƒœã‚¤ã‚¹ãƒªã‚¹ãƒˆãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (window.speechSynthesis.getVoices().length > 0) {
          loadVoices();
        } else {
          // ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
          window.speechSynthesis.onvoiceschanged = loadVoices;
        }

      } else {
        alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
      }
    }

    // ===========================
    // âœ… æ–°è¦è¿½åŠ é–¢æ•°: éŸ³å£°åœæ­¢æ©Ÿèƒ½
    // ===========================
    function stopSpeech() {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    }


    // ==========================================
    // âœ… çŸ¥è­˜ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ (ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ç†è«–)
    // ==========================================
    let allKnowledgeData = []; // å…¨ãƒ‡ãƒ¼ã‚¿
    let currentKnowledgeCategory = 'basic'; // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒª
    let currentKQuizList = [];
    let currentKIndex = 0;
    let currentKScore = 0;

    // 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadKnowledgeData() {
      const statusEl = document.getElementById("knowledge-status-msg");
      const startBtn = document.getElementById("start-knowledge-btn");
      const testBtn = document.getElementById("start-test-btn"); // è¿½åŠ 

      try {
        const res = await fetch(SHEET_URL + "?sheet=Knowledge&t=" + new Date().getTime());
        const data = await res.json();

        if (data.error || !data.length) {
          console.warn("Sheet data not found, using dummy data.");
          // ...ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã¯çœç•¥å¯ï¼‰...
          allKnowledgeData = []; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
        } else {
          allKnowledgeData = data;
        }

        statusEl.textContent = `æº–å‚™å®Œäº† (å…¨ãƒ‡ãƒ¼ã‚¿æ•°: ${allKnowledgeData.length})`;

        // ä¸¡æ–¹ã®ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        if (startBtn) { startBtn.disabled = false; startBtn.style.opacity = "1"; }
        if (testBtn) { testBtn.disabled = false; testBtn.style.opacity = "1"; }

      } catch (e) {
        console.error("Knowledge Load Error:", e);
        statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆKnowledgeã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
      }
    }

    // 2. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchKnowledgeTab(category) {
      currentKnowledgeCategory = category;

      // UIãƒªã‚»ãƒƒãƒˆ
      document.getElementById("knowledge-start-screen").style.display = "block";
      document.getElementById("knowledge-play-screen").style.display = "none";
      document.getElementById("knowledge-result-screen").style.display = "none";

      // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
      const titles = { basic: "åŸºç¤ç†è«–ã‚¯ã‚¤ã‚º", tactics: "æˆ¦è¡“ç†è«–ã‚¯ã‚¤ã‚º", coaching: "ã‚³ãƒ¼ãƒãƒ³ã‚°ç†è«–ã‚¯ã‚¤ã‚º" };
      document.getElementById("knowledge-category-title").textContent = titles[category];

      // ã‚¿ãƒ–ã®è‰²å¤‰æ›´
      const tabs = ["basic", "tactics", "coaching"];
      tabs.forEach(t => {
        const btn = document.getElementById(`k-tab-${t}`);
        if (!btn) return;

        if (t === category) {
          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼šç™½èƒŒæ™¯ Ã— æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸æ–‡å­—
          btn.style.background = "#fff";
          btn.style.color = "#e65100";
          btn.style.fontWeight = "bold";
        } else {
          // éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼šè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ Ã— èŒ¶è‰²ã£ã½ã„æ–‡å­—
          btn.style.background = "#ffe0b2";
          btn.style.color = "#8d6e63";
          btn.style.fontWeight = "normal";
        }
      });
    }

    // 3. ã‚¯ã‚¤ã‚ºé–‹å§‹
    function startKnowledgeQuiz(questionCount = 5) {
      // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const filtered = allKnowledgeData.filter(d => d.category === currentKnowledgeCategory);

      if (filtered.length === 0) {
        alert("ã“ã®ã‚«ãƒ†ã‚´ãƒªã®å•é¡ŒãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      // å•é¡Œæ•°ãŒãƒ‡ãƒ¼ã‚¿ã®ç·æ•°ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´
      const count = Math.min(questionCount, filtered.length);

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æŒ‡å®šæ•°ï¼ˆ5å• or 20å•ï¼‰æŠ½å‡º
      currentKQuizList = [...filtered].sort(() => 0.5 - Math.random()).slice(0, count);

      currentKIndex = 0;
      currentKScore = 0;

      // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById("knowledge-start-screen").style.display = "none";
      document.getElementById("knowledge-play-screen").style.display = "block";
      document.getElementById("knowledge-result-screen").style.display = "none";

      showKnowledgeQuestion();
    }

    // 4. å•é¡Œè¡¨ç¤º
    function showKnowledgeQuestion() {
      const q = currentKQuizList[currentKIndex];
      document.getElementById("knowledge-count").textContent = `Q ${currentKIndex + 1} / ${currentKQuizList.length}`;
      document.getElementById("knowledge-score").textContent = `Score: ${currentKScore}`;
      document.getElementById("knowledge-question").textContent = q.question;

      // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯éè¡¨ç¤º
      document.getElementById("knowledge-feedback").style.display = "none";

      const optDiv = document.getElementById("knowledge-options");
      optDiv.innerHTML = "";

      const options = [
        { text: q.option1, id: 1 }, { text: q.option2, id: 2 },
        { text: q.option3, id: 3 }, { text: q.option4, id: 4 }
      ];

      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt.text;
        btn.style.cssText = "padding:12px; border:2px solid #ddd; background:#fff; color:#333; border-radius:6px; cursor:pointer; font-size:14px; text-align:left;";
        btn.onclick = () => checkKnowledgeAnswer(opt.id, q.answer, q.explanation, btn);
        optDiv.appendChild(btn);
      });
    }


    // 5. æ­£èª¤åˆ¤å®š
    function checkKnowledgeAnswer(selectedId, correctId, explanation, btn) {
      // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
      const btns = document.querySelectorAll("#knowledge-options button");
      btns.forEach(b => b.disabled = true);

      const isCorrect = (parseInt(selectedId) === parseInt(correctId));

      if (isCorrect) {
        btn.style.background = "#d4edda";
        btn.style.borderColor = "#28a745";
        btn.textContent += " â­•";
        currentKScore++;
        if (typeof playSportsDrum === 'function') playSportsDrum();
      } else {
        btn.style.background = "#f8d7da";
        btn.style.borderColor = "#dc3545";
        btn.textContent += " âŒ";
        // æ­£è§£ã‚’è¡¨ç¤º
        btns[parseInt(correctId) - 1].style.background = "#d4edda";
        btns[parseInt(correctId) - 1].textContent += " (æ­£è§£)";
        if (typeof playBuzz === 'function') playBuzz(300, 200);
      }

      // è§£èª¬è¡¨ç¤º
      const fbDiv = document.getElementById("knowledge-feedback");
      document.getElementById("knowledge-feedback-title").textContent = isCorrect ? "æ­£è§£ï¼" : "æ®‹å¿µ...";
      document.getElementById("knowledge-feedback-title").style.color = isCorrect ? "green" : "red";
      document.getElementById("knowledge-feedback-text").textContent = explanation || "";
      fbDiv.style.display = "block";
    }

    // 6. æ¬¡ã¸
    function nextKnowledgeQuestion() {
      currentKIndex++;
      if (currentKIndex < currentKQuizList.length) {
        showKnowledgeQuestion();
      } else {
        // çµæœç™ºè¡¨
        document.getElementById("knowledge-play-screen").style.display = "none";
        document.getElementById("knowledge-result-screen").style.display = "block";
        document.getElementById("knowledge-final-score").textContent = `${currentKQuizList.length}å•ä¸­ ${currentKScore}å•æ­£è§£ï¼`;

        // ãƒ©ãƒ³ã‚¯è¡¨ç¤ºæ›´æ–°
        const percentage = (currentKScore / currentKQuizList.length) * 100;
        const rankEl = document.getElementById("knowledge-rank-msg");
        if (rankEl) {
          if (percentage === 100) rankEl.textContent = "è©•ä¾¡: S (å®Œç’§ï¼)";
          else if (percentage >= 80) rankEl.textContent = "è©•ä¾¡: A (ç´ æ™´ã‚‰ã—ã„)";
          else if (percentage >= 60) rankEl.textContent = "è©•ä¾¡: B (åˆæ ¼åœå†…)";
          else rankEl.textContent = "è©•ä¾¡: C (å¾©ç¿’ã—ã¾ã—ã‚‡ã†)";
        }

        if (currentKScore === currentKQuizList.length && typeof playSportsDrum === 'function') {
          playSportsDrum();
        }
      }
    } // â† â˜…ã€é‡è¦ã€‘ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã“ã®é–‰ã˜ã‚«ãƒƒã‚³ãŒæŠœã‘ã¦ã„ã¾ã—ãŸï¼

    function resetKnowledgeQuiz() {
      document.getElementById("knowledge-result-screen").style.display = "none";
      document.getElementById("knowledge-start-screen").style.display = "block";
    }

    function resetKnowledgeQuiz() {
      document.getElementById("knowledge-result-screen").style.display = "none";
      document.getElementById("knowledge-start-screen").style.display = "block";
    }


    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOMå®Œå…¨èª­ã¿è¾¼ã¿å®Œäº†: å„æ©Ÿèƒ½ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™");

      // 1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
      try {
        loadSheet();
        loadEnglishPhrases();
        loadQuizData();
        loadKnowledgeData();
        loadVideoQuizData();
      } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e); }

      // 2. ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆâ˜…ã“ã“ã‚’å¼·åŒ–ï¼‰
      if (typeof setupProgramTimer === 'function') {
        setupProgramTimer();
        console.log("ã‚¿ã‚¤ãƒãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†");
      } else {
        console.error("setupProgramTimer é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰ã®è²¼ã‚Šä»˜ã‘ä½ç½®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }

      // 3. å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      const safeSetClick = (id, func) => {
        const el = document.getElementById(id);
        if (el) el.onclick = func;
      };

      safeSetClick("login-button", loginWithPassword);
      safeSetClick("logout-button", logout);

      // æ™‚é–“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ç›£è¦–
      const targetTimeInput = document.getElementById("target-time");
      if (targetTimeInput) {
        targetTimeInput.addEventListener("input", updateTimeProgress);
      }

      const slOffset = document.getElementById("plot-y-offset");
      if (slOffset) {
        slOffset.addEventListener("input", (e) => {
          const valEl = document.getElementById("val-y-offset");
          if (valEl) valEl.textContent = e.target.value;
        });
      }

      // 4. åˆæœŸã®è¡¨ç¤ºæ›´æ–°
      if (typeof updateTimeProgress === 'function') updateTimeProgress();

      // 5. é‡ã„AIå‡¦ç†ã¯æœ€å¾Œã«å°‘ã—é…ã‚‰ã›ã¦å®Ÿè¡Œ
      setTimeout(() => {
        if (typeof initPose === 'function') initPose();
      }, 1500);
    });

    // ==========================================
    // ğŸ¥ å‹•ç”»ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼†ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½
    // ==========================================
    let videoQuizData = [];   // ç”Ÿãƒ‡ãƒ¼ã‚¿
    let groupedSessions = {}; // GroupIDã”ã¨ã®ãƒ‡ãƒ¼ã‚¿
    let currentSessionId = "";

    // 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadVideoQuizData() {
      const statusEl = document.getElementById("vq-status-msg");
      const listEl = document.getElementById("vq-list");

      try {
        const res = await fetch(SHEET_URL + "?sheet=VideoQuiz&t=" + new Date().getTime());
        const data = await res.json();

        if (data.error || !data.length) {
          statusEl.textContent = "åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }

        videoQuizData = data;

        groupedSessions = {};
        videoQuizData.forEach(row => {
          // GroupIDã‚„TitleãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¿µã®ãŸã‚ï¼‰
          if (!row.GroupID && !row.Question) return;

          const gid = row.GroupID || "default";
          if (!groupedSessions[gid]) {
            groupedSessions[gid] = {
              title: row.Title || "ç„¡é¡Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³",
              url: row.URL || "",
              questions: []
            };
          }

          // â–¼ Option4å¯¾å¿œï¼ˆåŠè§’ãƒ»å…¨è§’ã©ã¡ã‚‰ã§ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ï¼‰
          const opt4 = row.Option4 || row.Optionï¼” || "";

          groupedSessions[gid].questions.push({
            q: row.Question,
            // â–¼ ã“ã“ã‚’4æŠã«ä¿®æ­£
            opts: [row.Option1, row.Option2, row.Option3, opt4],
            ans: row.Answer,
            exp: row.Explanation
          });
        });

        // ãƒªã‚¹ãƒˆæç”»
        statusEl.style.display = "none";
        listEl.innerHTML = "";

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã®è¡¨ç¤º
        if (Object.keys(groupedSessions).length === 0) {
          listEl.innerHTML = "<p>æœ‰åŠ¹ãªå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
          return;
        }

        Object.keys(groupedSessions).forEach(gid => {
          const session = groupedSessions[gid];
          const qCount = session.questions.length;

          // å•é¡Œæ•°ãŒ0ã®å ´åˆã¯è¡¨ç¤ºã—ãªã„
          if (qCount === 0) return;

          const card = document.createElement("div");
          card.style.cssText = "background:#fafafa; border:1px solid #eee; border-radius:8px; padding:15px; transition:0.2s; cursor:pointer; border-left:4px solid #ff9800;";
          card.onmouseover = () => { card.style.background = "#fff3e0"; };
          card.onmouseout = () => { card.style.background = "#fafafa"; };
          card.onclick = () => startVideoSession(gid);

          card.innerHTML = `
                <div style="font-weight:bold; color:#1a237e; margin-bottom:5px;">${session.title}</div>
                <div style="font-size:12px; color:#666;">
                    ğŸ“ å•é¡Œæ•°: ${qCount}å•<br>
                    ğŸ¥ YouTubeè¦–è´ã‚ã‚Š
                </div>
            `;
          listEl.appendChild(card);
        });

      } catch (e) {
        console.error("Video Quiz Load Error:", e);
        statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        statusEl.style.color = "red";
      }
    }

    // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
    function startVideoSession(gid) {
      currentSessionId = gid;
      const session = groupedSessions[gid];

      // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById("vq-select-screen").style.display = "none";
      document.getElementById("vq-result-screen").style.display = "none";
      document.getElementById("vq-play-screen").style.display = "block";

      // æƒ…å ±ã‚»ãƒƒãƒˆ
      document.getElementById("vq-current-title").textContent = session.title;
      document.getElementById("vq-video-link").href = session.url;

      // å•é¡Œæç”»
      const container = document.getElementById("vq-questions-container");
      container.innerHTML = "";

      session.questions.forEach((qData, idx) => {
        const qDiv = document.createElement("div");
        qDiv.className = "vq-question-block";
        qDiv.style.cssText = "margin-bottom:20px; background:#fff; padding:15px; border-radius:8px; border:1px solid #ddd;";

        let optionsHtml = "";
        qData.opts.forEach((opt, optIdx) => {
          if (!opt) return;
          const val = optIdx + 1;
          optionsHtml += `
                <label style="display:block; padding:8px; margin-bottom:5px; border:1px solid #eee; border-radius:4px; cursor:pointer;">
                    <input type="radio" name="vq-q-${idx}" value="${val}"> ${opt}
                </label>
            `;
        });

        qDiv.innerHTML = `
            <div style="font-weight:bold; color:#333; margin-bottom:10px;">Q${idx + 1}. ${qData.q}</div>
            <div>${optionsHtml}</div>
            <div id="vq-feedback-${idx}" style="display:none; margin-top:10px; padding:10px; background:#f0f0f0; border-radius:4px; font-size:13px;"></div>
        `;
        container.appendChild(qDiv);
      });
    }

    // 3. æ¡ç‚¹å‡¦ç†
    function submitVideoQuiz() {
      const session = groupedSessions[currentSessionId];
      let score = 0;

      // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®HTMLãƒ“ãƒ«ãƒ€ãƒ¼
      let detailsHtml = "";

      session.questions.forEach((qData, idx) => {
        const inputs = document.querySelectorAll(`input[name="vq-q-${idx}"]`);
        const selected = document.querySelector(`input[name="vq-q-${idx}"]:checked`);
        const fbDiv = document.getElementById(`vq-feedback-${idx}`);

        // å…¥åŠ›ãƒ­ãƒƒã‚¯
        inputs.forEach(i => i.disabled = true);

        // ç”»é¢ä¸Šã®ç°¡æ˜“ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆã“ã“ã¯â—‹Ã—ã ã‘ã§ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
        fbDiv.style.display = "block";

        const userVal = selected ? parseInt(selected.value) : null;
        const isCorrect = (userVal === parseInt(qData.ans));

        // é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        const userAnsText = userVal ? qData.opts[userVal - 1] : "ï¼ˆæœªå›ç­”ï¼‰";
        const correctAnsText = qData.opts[parseInt(qData.ans) - 1];

        // --- PDF/çµæœç”»é¢ç”¨ã®è©³ç´°HTMLç”Ÿæˆ ---
        const resultColor = isCorrect ? "#155724" : "#721c24";
        const resultIcon = isCorrect ? "â­• æ­£è§£" : "âŒ ä¸æ­£è§£";

        if (isCorrect) {
          score++;
          fbDiv.style.background = "#d4edda";
          fbDiv.style.color = "#155724";
          fbDiv.textContent = `â­• æ­£è§£ï¼`;
        } else {
          fbDiv.style.background = "#f8d7da";
          fbDiv.style.color = "#721c24";
          fbDiv.textContent = `âŒ ä¸æ­£è§£...`;
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”¨HTMLã®çµ„ã¿ç«‹ã¦ï¼ˆè§£èª¬éƒ¨åˆ†ã‚’å‰Šé™¤ï¼‰
        detailsHtml += `
            <div style="border-bottom: 1px solid #ccc; padding: 10px 0; margin-bottom: 10px; page-break-inside: avoid;">
                <p style="margin:0 0 5px 0; font-weight:bold; color:#333;">Q${idx + 1}. ${qData.q}</p>
                <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px;">
                    <span style="color:${resultColor}; font-weight:bold;">ã‚ãªãŸã®å›ç­”: ${userAnsText} (${resultIcon})</span>
                </div>
                ${!isCorrect ? `<p style="margin:0 0 5px 0; font-size:13px; color:#d32f2f;"><strong>æ­£è§£:</strong> ${correctAnsText}</p>` : ""}
            </div>
        `;
      });

      // çµæœç”»é¢ã¸ç§»å‹•
      setTimeout(() => {
        document.getElementById("vq-play-screen").style.display = "none";
        document.getElementById("vq-result-screen").style.display = "block";

        // çµæœãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
        document.getElementById("vq-score-display").textContent = `${score} / ${session.questions.length}`;
        document.getElementById("vq-session-name").textContent = session.title;
        document.getElementById("vq-date").textContent = new Date().toLocaleDateString("ja-JP");

        // â˜… ã“ã“ã«è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’æŒ¿å…¥
        document.getElementById("vq-feedback-list").innerHTML = detailsHtml;

        // åŠ¹æœéŸ³
        if (score === session.questions.length && typeof playSportsDrum === 'function') {
          playSportsDrum();
        }
      }, 1500);
    }

    // 4. ä¸€è¦§ã«æˆ»ã‚‹
    function backToVideoList() {
      document.getElementById("vq-play-screen").style.display = "none";
      document.getElementById("vq-result-screen").style.display = "none";
      document.getElementById("vq-select-screen").style.display = "block";
    }

    // 5. PDFå‡ºåŠ›
    async function downloadVideoQuizPDF() {
      const element = document.getElementById("vq-result-content");
      const btn = event.target || document.querySelector("#vq-result-screen button");
      const originalText = btn ? btn.textContent : "PDFå‡ºåŠ›";

      if (btn) {
        btn.textContent = "PDFç”Ÿæˆä¸­...";
        btn.disabled = true;
      }

      try {
        // --- 1. ãƒãƒ©ã¤ãé˜²æ­¢ï¼šç”»é¢å¤–ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ ---
        // å…ƒã®è¦ç´ ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆè¤‡è£½ï¼‰
        const clone = element.cloneNode(true);

        // ç”»é¢å¤–ï¼ˆå·¦å´ -10000pxï¼‰ã«é…ç½®ã—ã¦è¦‹ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
        // å¹…ã‚’å›ºå®š(600px)ã—ã¦ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã
        clone.style.cssText = `
            position: absolute;
            top: 0;
            left: -10000px;
            width: 600px;
            background: #fff;
            padding: 20px;
            z-index: -1;
        `;

        // ä¸€æ™‚çš„ã«bodyã«è¿½åŠ ï¼ˆhtml2canvasã¯DOMã«å­˜åœ¨ã—ãªã„ã¨æ’®å½±ã§ããªã„ãŸã‚ï¼‰
        document.body.appendChild(clone);

        // --- 2. ç”»åƒåŒ–å‡¦ç† ---
        const canvas = await html2canvas(clone, {
          scale: 2, // é«˜ç”»è³ª
          useCORS: true,
          windowWidth: 800 // ä»®æƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¹…ã‚’æŒ‡å®šã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®‰å®šã•ã›ã‚‹
        });

        // ç”¨ãŒæ¸ˆã‚“ã ã‚‰å³å‰Šé™¤
        document.body.removeChild(clone);

        const imgData = canvas.toDataURL("image/png");

        // --- 3. PDFè¨­å®šï¼ˆ1æšã«åã‚ã‚‹ï¼‰ ---
        const docDefinition = {
          content: [
            {
              image: imgData,
              // â˜…ã“ã“ãŒé‡è¦ï¼šA4ã‚µã‚¤ã‚º(ç´„595x842pt)ã‹ã‚‰ä½™ç™½ã‚’å¼•ã„ãŸã‚µã‚¤ã‚ºã«åã¾ã‚‹ã‚ˆã†è‡ªå‹•ç¸®å°
              fit: [500, 750],
              alignment: 'center',
              margin: [0, 10, 0, 0]
            }
          ],
          pageSize: 'A4',
          pageMargins: [40, 40, 40, 40], // ä¸Šä¸‹å·¦å³ã®ä½™ç™½
          defaultStyle: { font: 'Roboto' }
        };

        const fileName = `VideoQuiz_Result_${new Date().toISOString().slice(0, 10)}.pdf`;
        pdfMake.createPdf(docDefinition).download(fileName);

      } catch (e) {
        console.error("PDF Error:", e);
        alert("PDFä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: " + e.message);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å¿µã®ãŸã‚ã‚¯ãƒ­ãƒ¼ãƒ³ãŒæ®‹ã£ã¦ã„ãŸã‚‰å‰Šé™¤
        const ghosts = document.querySelectorAll('[style*="left: -10000px"]');
        ghosts.forEach(g => g.remove());
      } finally {
        if (btn) {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }
    }

    // ==========================================
    // âœ… PDFç™ºè¡Œæ©Ÿèƒ½
    // ==========================================
    async function downloadKnowledgePDF() {
      const btn = event.target || document.querySelector("button[onclick='downloadKnowledgePDF()']");
      const originalText = btn.textContent;

      // 1. ãƒœã‚¿ãƒ³ã‚’ã€Œå‡¦ç†ä¸­ã€ã«ã™ã‚‹
      btn.textContent = "PDFç”Ÿæˆä¸­...";
      btn.disabled = true;

      try {
        // --- ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ï¼ˆçœç•¥ï¼‰---
        const total = currentKQuizList.length || 20;
        const score = currentKScore;
        const percentage = (score / total) * 100;
        const now = new Date();

        const template = document.getElementById("certificate-template");
        template.querySelector("#cert-date").textContent = now.toLocaleDateString("ja-JP");
        template.querySelector("#cert-score").textContent = score;
        template.querySelector("#cert-total").textContent = total;

        let rank = "", comment = "";
        // ... (ãƒ©ãƒ³ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥) ...

        if (percentage === 100) {
          rank = "Sãƒ©ãƒ³ã‚¯ (å…è¨±çš†ä¼)";
          comment = "ç´ æ™´ã‚‰ã—ã„ï¼å®Œç’§ãªçŸ¥è­˜ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã®ç†è«–ã‚’å®Ÿéš›ã®ãƒ—ãƒ¬ãƒ¼ã‚„æŒ‡å°ã«æ´»ã‹ã—ã¦ãã ã•ã„ã€‚";
        } else if (percentage >= 80) {
          rank = "Aãƒ©ãƒ³ã‚¯ (ä¸Šç´šè€…)";
          comment = "éå¸¸ã«é«˜ã„æ­£è§£ç‡ã§ã™ã€‚ç´°ã‹ã„çŸ¥è­˜ã®æŠœã‘æ¼ã‚Œã‚’ç¢ºèªã—ã€æº€ç‚¹ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼";
        } else if (percentage >= 60) {
          rank = "Bãƒ©ãƒ³ã‚¯ (ä¸­ç´šè€…)";
          comment = "åŸºæœ¬çš„ãªç†è«–ã¯ç†è§£ã§ãã¦ã„ã¾ã™ã€‚é–“é•ãˆãŸå•é¡Œã‚’è¦‹ç›´ã—ã€çŸ¥è­˜ã‚’å®šç€ã•ã›ã¾ã—ã‚‡ã†ã€‚";
        } else {
          rank = "Cãƒ©ãƒ³ã‚¯ (å­¦ç¿’ä¸­)";
          comment = "ã¾ãšã¯åŸºç¤çŸ¥è­˜ã‚’ã—ã£ã‹ã‚Šå›ºã‚ã¾ã—ã‚‡ã†ã€‚ç¹°ã‚Šè¿”ã—å­¦ç¿’ã™ã‚‹ã“ã¨ã§å¿…ãšç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚";
        }

        template.querySelector("#cert-rank").textContent = rank;
        template.querySelector("#cert-comment").textContent = comment;

        // --- ç”»åƒåŒ–å‡¦ç†ï¼ˆé‡è¦ï¼šã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦æ’®å½±ã™ã‚‹ï¼‰ ---
        // 1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¤‡è£½
        const clone = template.cloneNode(true);

        // 2. æ’®å½±ç”¨ã«ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆç”»é¢å¤–ã®å®‰å…¨ãªå ´æ‰€ã«é…ç½®ã€‚visibilityã‚„opacityã¯ä½¿ç”¨ã—ãªã„ï¼‰
        clone.style.cssText = `
            position: fixed; 
            top: -20000px; /* é¥ã‹ä¸Šæ–¹ã«é…ç½® */
            left: 0; 
            z-index: 99999; /* å¿µã®ãŸã‚æœ€å‰é¢ã«é…ç½® */
            width: 800px; 
            padding: 40px; 
            background: #fff; 
            display: block !important; 
            transform: none; /* ç¢ºå®Ÿã«ã‚¹ã‚±ãƒ¼ãƒ«1.0 */
        `;

        // 3. DOMã«è¿½åŠ 
        document.body.appendChild(clone);

        // 4. çŸ­ã„æ™‚é–“å¾…ã£ã¦ã‹ã‚‰æ’®å½±ï¼ˆCSSé©ç”¨ã¨æç”»ã®å®Œäº†ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 100)); // 100msã§å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹

        // 5. html2canvasã§ç”»åƒåŒ–
        const canvas = await html2canvas(clone, {
          scale: 2, // é«˜è§£åƒåº¦ã§ç”Ÿæˆ
          useCORS: true,
          logging: false,
          width: 900,
          height: clone.offsetHeight + 10,
          windowWidth: 900,
          scrollX: 0,
          scrollY: 0,
        });

        // 6. å‰Šé™¤
        document.body.removeChild(clone);

        const imgData = canvas.toDataURL("image/png");

        // --- PDFç”Ÿæˆ ---
        const docDefinition = {
          content: [
            {
              image: imgData,
              width: 550, // A4ã‚µã‚¤ã‚ºã«åã¾ã‚‹ã‚ˆã†èª¿æ•´
              alignment: 'center'
            }
          ],
          defaultStyle: {
            font: 'Roboto'
          },
          pageMargins: [40, 40, 40, 40]
        };

        const pdfLib = window.pdfMake || window.pdfmake;
        if (pdfLib) {
          pdfLib.createPdf(docDefinition).download(`Badminton_Test_Result_${now.toISOString().slice(0, 10)}.pdf`);
        } else {
          throw new Error("pdfMakeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }

      } catch (e) {
        console.error("PDF Export Error:", e);
        alert("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼è©³ç´°: " + e.message);

        // ã‚¨ãƒ©ãƒ¼æ™‚ã«æ®‹ã£ã¦ã—ã¾ã£ãŸã‚¯ãƒ­ãƒ¼ãƒ³è¦ç´ ã‚’å‰Šé™¤
        const cloneElements = document.querySelectorAll("#certificate-template[style*='position: fixed']");
        cloneElements.forEach(el => el.remove());
      } finally {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }
  </script>
</head>

<body onload="showScreen('home', document.getElementById('nav-home'))">
  <header style="
    text-align: center;
    margin-bottom: 30px;
    /* èƒŒæ™¯ï¼šè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¯ã‚„ã‹ã•ã‚’æ¼”å‡º */
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    padding: 25px 10px;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(230, 81, 0, 0.1); /* å½±ã‚‚å°‘ã—æ¸©ã‹ã¿ã®ã‚ã‚‹è‰²ã« */
    border: 1px solid #ffcc80; /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ã®æ ç·šã§è¼ªéƒ­ã‚’æ•´ãˆã‚‹ */
  ">
    <h1 style="
      font-size: 32px;
      color: #1a237e; /* æ–‡å­—è‰²ï¼šãƒã‚¤ãƒ“ãƒ¼ */
      margin-bottom: 8px;
      letter-spacing: 1.5px;
      font-weight: 700;
      font-family: 'Noto Sans JP', sans-serif;
    ">
      Smart Coach Badminton
    </h1>
    <p id="app-title" style="font-size:17px; color:#283593; margin:0; font-weight:500;">
      ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼†å­¦ç¿’ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª
    </p>
    <div style="margin-top:12px;">
      <a href="https://www.youtube.com/@MASUBadmintonAcademy" target="_blank"
        style="display:inline-flex; align-items:center; gap:6px; text-decoration:none;">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_(2017).svg" alt="YouTube"
          style="width:24px; height:24px;">
        <span id="channel-title" style="font-weight:bold; color:#1a237e;">MASU Badminton Academy YouTubeãƒãƒ£ãƒ³ãƒãƒ«</span>
      </a>
    </div>

    <div
      style="margin-top: 15px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; position: relative; z-index: 2000;">

      <div id="google_translate_element" style="display: inline-block;"></div>

      <button onclick="resetToJapanese()" class="notranslate" translate="no" style="
           background: #fff; 
           border: 1px solid #ccc; 
           color: #333; 
           padding: 8px 15px; /* ã“ã“ã‚‚å°‘ã—å¤§ãã */
           border-radius: 20px; 
           font-size: 13px; 
           cursor: pointer;
           display: flex;
           align-items: center;
           gap: 5px;
           box-shadow: 0 1px 3px rgba(0,0,0,0.1);
       ">
        ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªã«æˆ»ã™ (Reset)
      </button>
    </div>

    <script type="text/javascript">
      function googleTranslateElementInit() {
        new google.translate.TranslateElement({
          pageLanguage: 'ja',
          includedLanguages: 'en,zh-CN,zh-TW,ko',
          layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
          autoDisplay: false
        }, 'google_translate_element');
      }

      function resetToJapanese() {
        // Googleç¿»è¨³ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’å‰Šé™¤
        document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.cookie = "googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=" + document.domain;

        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åŸæ–‡ã«æˆ»ã™
        window.location.reload();
      }
    </script>

    <script type="text/javascript"
      src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit&hl=en"></script>
  </header>

  <nav id="main-nav">
    <button id="nav-home" onclick="showScreen('home', this)">ğŸ  ãƒ›ãƒ¼ãƒ </button>
    <button id="nav-training" onclick="showScreen('training', this)">1. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨ˆç”»</button>
    <button id="nav-analysis" onclick="showScreen('analysis', this)">2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ</button>
    <button id="nav-tactics" onclick="showScreen('tactics', this)">3. æˆ¦è¡“ãƒ»ã‚³ãƒ¼ãƒˆãƒ»ãƒªãƒ¼ã‚°</button>
    <button id="nav-beginner" onclick="showScreen('beginner', this)">4. åˆå¿ƒè€…æŒ‡å°</button>
    <button id="nav-learning" onclick="showScreen('learning', this)">5. çŸ¥è­˜ãƒ»ã‚¹ã‚­ãƒ«å­¦ç¿’</button>
    <button id="nav-utility" onclick="showScreen('utility', this)">6. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</button>
    <button id="nav-studio" onclick="showScreen('studio', this)">7. ãƒ“ãƒ‡ã‚ªã‚¹ã‚¿ã‚¸ã‚ª</button>
    <button id="nav-library" onclick="showScreen('library', this); loadLibraryFromDB(); updateStorageInfo();">8.
      ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</button>
    <button id="nav-course" onclick="showScreen('course', this)">9. è¬›ç¿’ä¼šç”¨ (Login)</button>
  </nav>
  <div class="status-message" id="statusMessage" style="margin: 10px 0; font-weight: bold;">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>

  <section id="screen-home" class="screen-content active">
    <div style="
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
        border: 2px solid #2196f3; 
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        font-family: 'Noto Sans JP', sans-serif;
    ">
      <h3
        style="margin: 0 0 15px 0; color: #0d47a1; display: flex; align-items: center; gap: 8px; font-size: 18px; border-bottom: 1px dashed #1976d2; padding-bottom: 10px;">
        ğŸ“± ã€æ–°æ©Ÿèƒ½ã€‘ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼
      </h3>

      <p style="font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 15px;">
        ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’è¡Œã†ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®æ ãŒæ¶ˆãˆã€å…¨ç”»é¢ã®ã‚¢ãƒ—ãƒªã¨ã—ã¦å¿«é©ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br>
        <strong>âš ï¸ ãŸã ã—ã€ãƒ‡ãƒ¼ã‚¿ã®å¼•ãç¶™ãã«é–¢ã—ã¦é‡è¦ãªæ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚</strong>
      </p>

      <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
        <div
          style="background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border-left: 5px solid #757575;">
          <div style="font-weight: bold; color: #424242; margin-bottom: 4px;">ğŸ…°ï¸ ä»Šã¾ã§ä½¿ã£ã¦ã„ãŸã‚¢ã‚¤ã‚³ãƒ³ (ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆ)</div>
          <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #333;">
            <li><strong>ç”»é¢ï¼š</strong> ä¸Šä¸‹ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®æ ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ãªã©ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿ï¼š</strong> <span
                style="color: #d32f2f; font-weight: bold;">ã“ã‚Œã¾ã§ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„é…ç½®ï¼‰ã¯ã“ã“ã«æ®‹ã£ã¦ã„ã¾ã™ã€‚</span></li>
          </ul>
        </div>

        <div
          style="background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border-left: 5px solid #00acc1;">
          <div style="font-weight: bold; color: #006064; margin-bottom: 4px;">ğŸ…±ï¸ æ–°ã—ãè¿½åŠ ã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ (ã‚¢ãƒ—ãƒªç‰ˆ)</div>
          <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #333;">
            <li><strong>ç”»é¢ï¼š</strong> å…¨ç”»é¢ã§åºƒãä½¿ãˆã¾ã™ï¼ˆã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚</li>
            <li><strong>ãƒ‡ãƒ¼ã‚¿ï¼š</strong> <span style="color: #d32f2f; font-weight: bold;">ç©ºã£ã½ã®çŠ¶æ…‹ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚</span><br><span
                style="font-size: 11px; color: #666;">â€»ã‚¹ãƒãƒ›ã®ä»•æ§˜ä¸Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿ã¯å¼•ãç¶™ãŒã‚Œã¾ã›ã‚“ã€‚</span></li>
          </ul>
        </div>
      </div>

      <p style="font-size: 13px; color: #333; background: #fff; padding: 10px; border-radius: 6px;">
        <strong>ğŸ’¡ ãŠã™ã™ã‚ã®ç§»è¡Œæ–¹æ³•ï¼š</strong><br>
        éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ãŸã„æ™‚ã¯ã€ŒğŸ…°ï¸ å¤ã„ã‚¢ã‚¤ã‚³ãƒ³ã€ã‚’ä½¿ã„ã€ã“ã‚Œã‹ã‚‰ã®æ–°ã—ã„ç·´ç¿’ä½œæˆã¯ã€ŒğŸ…±ï¸ æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ã€ã‚’ä½¿ã†ã‚ˆã†ã«ä½¿ã„åˆ†ã‘ã¦ãã ã•ã„ã€‚<br>
        ï¼ˆâ€»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã©ã¯ã€Œå…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã€æ©Ÿèƒ½ãªã©ã‚’ä½¿ã„ã€æ‰‹å‹•ã§ç§»ã™ã“ã¨ã¯å¯èƒ½ã§ã™ï¼‰
      </p>

      <div style="text-align: center; margin-top: 20px;">
        <p style="font-weight: bold; color: #0d47a1; margin-bottom: 5px;">ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•</p>
        <p style="font-size: 12px; color: #555;">
          <strong>iPhone (Safari):</strong> ç”»é¢ä¸‹ã®å…±æœ‰ãƒœã‚¿ãƒ³ <span style="font-size:16px;">ğŸ›«</span> â†’ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
          <strong>Android (Chrome):</strong> å³ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span style="font-size:16px;">ï¸™</span> â†’ ã€Œã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€
        </p>
      </div>
    </div>


    <h2 style="color: #1a237e; margin-top: 0;">Smart Coach Badminton ã¸ã‚ˆã†ã“ã</h2>

    <div id="home-youtube-request-section" style="
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(to bottom, #fffde7, #fff9c4);
        border: 2px solid #fbc02d; 
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        font-family: 'Noto Sans JP', sans-serif;
    ">
      <h3
        style="margin: 0 0 15px 0; color: #f57f17; display: flex; align-items: center; gap: 8px; font-size: 18px; border-bottom: 1px dashed #f9a825; padding-bottom: 10px;">
        ğŸ”” ã€é‡è¦ã€‘ä»Šå¾Œã®å¤§å¹…ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¨ã”å”åŠ›ã®ãŠé¡˜ã„
      </h3>
      <p style="font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 15px;">
        ã„ã¤ã‚‚å½“ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
        ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¦ã€çš†æ§˜ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ã‚¤ãƒ•ã‚’ã‚ˆã‚Šå¼·åŠ›ã«ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…äºˆå®šã§ã™ã€‚
      </p>
      <div
        style="background: rgba(255, 255, 255, 0.7); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #ff9800;">
        <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #333; font-weight: bold;">
          <li style="margin-bottom: 8px;">ğŸ” å€‹äººãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç®¡ç†ï¼ˆIDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ä¿è­·ã¨æ©Ÿç¨®å¤‰æ›´å¯¾å¿œï¼‰</li>
          <li>ğŸ¤– AIã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åˆ†æï¼†ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ©Ÿèƒ½</li>
        </ul>
      </div>
      <p style="font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 20px;">
        ã“ã‚Œã‚‰ã®é«˜åº¦ãªæ©Ÿèƒ½ã‚’<strong
          style="color: #d32f2f; font-size: 16px; background: yellow;">ã€Œå®Œå…¨ç„¡æ–™ã€</strong>ã§çš†æ§˜ã«æä¾›ã—ç¶šã‘ã‚‹ãŸã‚ã€é–‹ç™ºè²»ç”¨ã®ç¢ºä¿ã¨ã—ã¦YouTubeãƒãƒ£ãƒ³ãƒãƒ«ã®åç›ŠåŒ–ã‚’ç›®æŒ‡ã—ã¦ãŠã‚Šã¾ã™ã€‚<br>
        çš†æ§˜ã®ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŒã€ãã®ã¾ã¾ã‚¢ãƒ—ãƒªã®é€²åŒ–ï¼ˆé–‹ç™ºè²»ï¼‰ã«ç¹‹ãŒã‚Šã¾ã™ã€‚ã‚ˆã‚Šè‰¯ã„ã‚¢ãƒ—ãƒªã‚’ç„¡æ–™ã§ä½œã‚Šç¶šã‘ã¦ã„ããŸã‚ã«ã€ãœã²ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ã§ã®ã”æ”¯æ´ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </p>
      <div style="text-align: center;">
        <a href="https://www.youtube.com/@MASUBadmintonAcademy?sub_confirmation=1" target="_blank" style="
                display: inline-flex;
                align-items: center;
                gap: 10px;
                background: #d32f2f;
                color: white;
                text-decoration: none;
                padding: 12px 35px;
                border-radius: 30px;
                font-weight: bold;
                font-size: 16px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                transition: transform 0.2s, background 0.2s;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='#b71c1c'"
          onmouseout="this.style.transform='scale(1)'; this.style.background='#d32f2f'">
          <span style="font-size: 20px;">â–¶</span> YouTubeãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ã—ã¦å¿œæ´ã™ã‚‹
        </a>
        <p style="font-size: 11px; color: #666; margin-top: 8px;">â€»ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨YouTubeãŒé–‹ãã¾ã™</p>
      </div>
    </div>

    <h3 style="color: #1a237e; border-bottom: 1px solid #ccc; padding-bottom: 5px;">æ©Ÿèƒ½ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</h3>

    <div class="category-card" onclick="showScreen('training', document.getElementById('nav-training'))">
      <h4>1. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨ˆç”»ãƒ»å®Ÿè¡Œã‚µãƒãƒ¼ãƒˆ</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        ç›®çš„ãƒ»èª²é¡Œã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒæœ€é©ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã€‚ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç°¡å˜ã«ç·´ç¿’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã€PDFã‚„ç”»åƒã§å…±æœ‰ã§ãã¾ã™ã€‚ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆã€èª²é¡Œç›®çš„ã®å…¥åŠ›ï¼‰</p>
    </div>

    <div class="category-card" onclick="showScreen('analysis', document.getElementById('nav-analysis'))">
      <h4>2. AI/å‹•ç”»ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        AIãƒ•ã‚©ãƒ¼ãƒ è§£æã€ç§»å‹•é€Ÿåº¦/è·é›¢è¨ˆæ¸¬ï¼ˆã‚²ãƒ¼ãƒ åˆ†æï¼‰ã€ãƒ€ãƒ–ãƒ«ã‚¹é™£å½¢æ¯”ç‡åˆ†æãªã©ã€è©¦åˆã‚„ç·´ç¿’ã‚’ç§‘å­¦çš„ã«è©•ä¾¡ã—ã¾ã™ã€‚ï¼ˆAIãƒ•ã‚©ãƒ¼ãƒ è§£æã€ã‚²ãƒ¼ãƒ åˆ†æã€AIãƒ•ã‚©ãƒ¼ãƒ æ¯”è¼ƒã‚³ãƒ¼ãƒã€ãƒ€ãƒ–ãƒ«ã‚¹é™£å½¢åˆ†æï¼‰
      </p>
    </div>

    <div class="category-card" onclick="showScreen('tactics', document.getElementById('nav-tactics'))">
      <h4>3. æˆ¦è¡“ãƒ»ã‚³ãƒ¼ãƒˆé–¢é€£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        æˆ¦è¡“ãƒœãƒ¼ãƒ‰ï¼ˆæ‰‹æ›¸ããƒ»çŸ¢å°ï¼‰ã§ãƒ—ãƒ¬ãƒ¼ã®æ„å›³ã‚’å…±æœ‰ã€‚ã‚³ãƒ¼ãƒˆé…ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã€ä½“è‚²é¤¨ã®ã‚³ãƒ¼ãƒˆã‚„äººã‚’è‡ªç”±ã«é…ç½®ãƒ»ç®¡ç†ã§ãã¾ã™ã€‚ï¼ˆã‚³ãƒ¼ãƒˆæç”»ã€ã‚³ãƒ¼ãƒˆé…ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰</p>
    </div>

    <div class="category-card" onclick="showScreen('beginner', document.getElementById('nav-beginner'))">
      <h4>4. åˆå¿ƒè€…æŒ‡å°</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³åˆå¿ƒè€…ã«å¿…è¦ãªãƒ«ãƒ¼ãƒ«ã‚„æŠ€è¡“ã‚’ã€å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ã¨ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ä½“ç³»çš„ã«å­¦ç¿’ã§ãã¾ã™ã€‚ï¼ˆåˆå¿ƒè€…å‘ã‘å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ã€ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰</p>
    </div>

    <div class="category-card" onclick="showScreen('learning', document.getElementById('nav-learning'))">
      <h4>5. çŸ¥è­˜ãƒ»ã‚¹ã‚­ãƒ«å­¦ç¿’</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">æŠ€è¡“ãƒ»æˆ¦è¡“ã®ç†è«–ã‚¯ã‚¤ã‚ºã€å‹•ç”»ã‚’è¦‹ã¦è¡Œã†ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ã€ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ç‰¹åŒ–ã®è‹±ä¼šè©±ãƒ•ãƒ¬ãƒ¼ã‚ºå­¦ç¿’æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ï¼ˆVideo
        Learningï¼†Checkã€Badminton English Learningã€Badminton Theory Quizï¼‰</p>
    </div>

    <div class="category-card" onclick="showScreen('utility', document.getElementById('nav-utility'))">
      <h4>6. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ãã®ä»–</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã™ã‚‹ã€Œæ—¥æœ¬ä¸€å‘¨ã®æ—…ã€ãƒãƒƒãƒ—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼ã€å…¬å¹³ãªæŠ½é¸ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãƒ„ãƒ¼ãƒ«ãªã©ã®ä¾¿åˆ©æ©Ÿèƒ½ã€‚ï¼ˆæ—¥æœ¬ä¸€å‘¨ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã®æ—…ã€ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯ï¼‰</p>
    </div>

    <div class="category-card" onclick="showScreen('studio', document.getElementById('nav-studio'))">
      <h4>7. ãƒ“ãƒ‡ã‚ªã‚¹ã‚¿ã‚¸ã‚ª</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">æ•™æã‚„åˆ†æç”»é¢ã‚’æ“ä½œã—ãªãŒã‚‰éŸ³å£°ã‚’å¹ãè¾¼ã¿ã€æˆæ¥­å‹•ç”»ã‚’ä½œæˆã—ã¾ã™ã€‚ç”»é¢å…±æœ‰ã¨ã‚«ãƒ¡ãƒ©ãƒ¯ã‚¤ãƒ—ã‚’åˆæˆã—ã¦éŒ²ç”»ã§ãã¾ã™ã€‚</p>
    </div>

    <div class="category-card"
      onclick="showScreen('library', document.getElementById('nav-library')); loadLibraryFromDB();">
      <h4>8. å‹•ç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        éŒ²ç”»ã—ãŸæˆæ¥­å‹•ç”»ãªã©ãŒè‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã‚‚å†ç”Ÿã‚„å‰Šé™¤ã€PCã¸ã®æ›¸ãå‡ºã—ãŒå¯èƒ½ã§ã™ã€‚
      </p>
    </div>

    <div class="category-card" onclick="showScreen('course', document.getElementById('nav-course'))">
      <h4>9. è¬›ç¿’ä¼šç”¨</h4>
      <p style="margin: 0; font-size: 13px; color: #555;">
        æŒ‡å°è€…ãƒ»è¬›å¸«å‘ã‘ã®æ©Ÿèƒ½ã§ã™ã€‚å—è¬›ç”Ÿã¸ã®è³‡æ–™QRã‚³ãƒ¼ãƒ‰å…±æœ‰ã‚„ã€å—è¬›ç”Ÿã‹ã‚‰ã®æ„Ÿæƒ³ãƒ»æŒ¯ã‚Šè¿”ã‚Šï¼ˆæ²ç¤ºæ¿ï¼‰ã‚’ä¸€å…ƒç®¡ç†ã§ãã¾ã™ã€‚ï¼ˆå—è¬›ç”Ÿã¸ã®è³‡æ–™å…±æœ‰ã€æŒ¯ã‚Šè¿”ã‚Šï¼‰</p>
    </div>

  </section>

  <section id="screen-beginner" class="screen-content">
    <section id="beginner-instruction-section" style="
  margin-bottom: 30px; 
  padding: 20px; 
  background: #e3f2fd; 
  border-radius: 12px; 
  border: 2px solid #90caf9;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
">
      <h2 id="beginner-section-title"
        style="color: #1565c0; margin-top: 0; display: flex; align-items: center; gap: 10px;">
        ğŸ”° åˆå¿ƒè€…å‘ã‘å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³
      </h2>

      <p id="beginner-section-desc" style="font-size: 14px; color: #555; margin-bottom: 20px;">
        ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€YouTubeã‚¢ãƒ—ãƒªï¼ˆã¾ãŸã¯æ–°ã—ã„ã‚¿ãƒ–ï¼‰ã§å‹•ç”»ãŒé–‹ãã¾ã™ã€‚
      </p>

      <div style="background: #fff; border-radius: 8px; border: 1px solid #ccc; overflow: hidden;">
        <div id="beginner-menu-list" style="max-height: 500px; overflow-y: auto;">
          <p style="padding: 15px; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </section>

    <section id="learning-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #fff3e0; padding: 15px 20px; border-bottom: 1px solid #ffe0b2;">
        <h3 style="margin:0; color:#1a237e; display:flex; align-items:center; gap:8px; font-size: 20px;">
          ğŸ“ ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        </h3>
      </div>

      <div style="padding: 20px;">

        <div id="sim-start-screen" style="text-align: center; padding: 20px 0;">
          <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            å®Ÿéš›ã®è©¦åˆã®æµã‚Œã‚’è¦‹ãªãŒã‚‰ã€<br>
            ãƒ€ãƒ–ãƒ«ã‚¹ã®è¤‡é›‘ãªã‚µãƒ¼ãƒ–æ¨©ç§»å‹•ã‚„ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚<br>
            <strong>â€»æœ€åˆã«ç°¡å˜ãªãƒ«ãƒ¼ãƒ«ç¢ºèªã‚¯ã‚¤ã‚ºãŒã‚ã‚Šã¾ã™ã€‚</strong>
          </p>
          <button onclick="startQuizMode()" style="
    background: #ff9800; color: white; border: none; 
    padding: 12px 30px; border-radius: 30px; 
    font-size: 16px; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: inline-flex; align-items: center; gap: 8px;
    transition: transform 0.2s;
  ">
            â–¶ ãƒ«ãƒ¼ãƒ«ç¢ºèªã‚’ã—ã¦é–‹å§‹
          </button>
        </div>

        <div id="sim-quiz-screen" style="display: none; animation: fadeIn 0.5s;">
          <div
            style="background:#e3f2fd; padding:15px; border-radius:8px; border:1px solid #90caf9; margin-bottom:15px;">
            <div style="font-weight:bold; color:#1565c0; margin-bottom:10px;">ğŸ“‹ ãƒ«ãƒ¼ãƒ«ç¢ºèªã‚¯ã‚¤ã‚º <span
                id="quiz-progress">(1/3)</span></div>

            <div id="quiz-text" style="font-size:15px; margin-bottom:15px; font-weight:bold; color: #333;"></div>

            <div id="quiz-options-container" style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
            </div>

            <div id="court-diagram-container" style="display:none; text-align:center; margin-bottom:20px;">
            </div>

            <div id="quiz-explanation"
              style="display:none; background:#fff; padding:10px; border-radius:6px; margin-bottom:10px; border-left:4px solid #1565c0;">
              <div id="quiz-explanation-text" style="font-size:13px;"></div>
            </div>

            <div style="text-align:center;">
              <button id="btn-next-quiz" onclick="nextQuiz()"
                style="display:none; background:#1565c0; color:white; border:none; padding:8px 25px; border-radius:20px;">æ¬¡ã¸
                â–¶</button>
            </div>
          </div>
        </div>

        <div id="sim-game-screen" style="display: none; animation: fadeIn 0.5s;">
          <div
            style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #ffe0b2;">
            <div style="font-weight:bold; color:#d84315; margin-bottom:5px;">Scenario: <span
                id="scenario-title">è©¦åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span></div>

            <div id="scenario-text" style="font-size:14px; min-height:40px; margin-bottom:10px;"></div>

            <div id="sim-options-container" style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px;">
            </div>

            <div style="display:flex; justify-content:center; gap:10px;">
              <button onclick="prevStep()"
                style="background:#ccc; color:#333; border:none; padding:8px 15px; border-radius:20px; font-size:12px;">â—€
                å‰ã¸</button>
              <button onclick="nextStep()" id="btn-next-step"
                style="display:none; background:#ff9800; color:white; border:none; padding:8px 25px; border-radius:20px; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.2);">æ¬¡ã¸é€²ã‚€
                â–¶</button>
            </div>
          </div>

          <div class="visual-court-container" style="margin-bottom:10px;">
            <div class="court-net"></div>
            <div class="court-grid">
              <div class="c-cell" id="sim-c-l-odd" style="grid-row: 2/3; grid-column: 2/3;"></div>
              <div class="c-cell" id="sim-c-l-even" style="grid-row: 3/4; grid-column: 2/3;"></div>
              <div class="c-cell" id="sim-c-r-even" style="grid-row: 3/4; grid-column: 3/4;"></div>
              <div class="c-cell" id="sim-c-r-odd" style="grid-row: 2/3; grid-column: 3/4;"></div>
              <div class="c-cell area-out" style="grid-row: 2/4; grid-column: 1/2; background:rgba(0,0,0,0.1);"></div>
              <div class="c-cell area-out" style="grid-row: 2/4; grid-column: 4/5; background:rgba(0,0,0,0.1);"></div>
            </div>
            <div id="p-A1" class="player-label" style="background:#ffcdd2; color:#b71c1c;">A1</div>
            <div id="p-A2" class="player-label" style="background:#ffcdd2; color:#b71c1c;">A2</div>
            <div id="p-B1" class="player-label" style="background:#bbdefb; color:#0d47a1;">B1</div>
            <div id="p-B2" class="player-label" style="background:#bbdefb; color:#0d47a1;">B2</div>
            <div id="sim-shuttle" style="position:absolute; font-size:20px; z-index:20; transition:all 0.5s;">ğŸ¸</div>
          </div>

          <div
            style="display:flex; justify-content:center; align-items:center; gap:20px; font-weight:bold; font-size:20px;">
            <span style="color:#d32f2f;">A: <span id="sim-score-a">0</span></span>
            <span>-</span>
            <span style="color:#1976d2;">B: <span id="sim-score-b">0</span></span>
          </div>

          <div id="sim-explanation"
            style="display:none; margin-top:15px; background:#e8f5e9; padding:10px; border-radius:6px; border-left:4px solid #4caf50;">
            <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">ğŸ’¡ è§£èª¬</div>
            <div id="sim-explanation-text" style="font-size:13px;"></div>
          </div>
        </div>

      </div>
    </section>
  </section>

  <section id="screen-training" class="screen-content">
    <div id="team-plan-section"
      style="display:none; background:#e3f2fd; padding:15px; border-radius:12px; border:2px solid #1976d2; margin-bottom:25px;">
      <h3 style="margin-top:0; color:#0d47a1; display:flex; align-items:center; gap:5px;">
        ğŸ“‹ ãƒãƒ¼ãƒ ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆ (é‹å–¶é€£æº)
      </h3>

      <div style="margin-bottom:10px;">
        <label style="font-weight:bold; font-size:13px; color:#555;">å—ä¿¡ãƒ‡ãƒ¼ã‚¿ (å¯¾è±¡ãƒ»èª²é¡Œ):</label>
        <textarea id="team-input-text" readonly
          style="width:100%; height:80px; background:#fff; border:1px solid #ccc; border-radius:6px; padding:8px; font-size:13px; color:#555; resize:none;"></textarea>
      </div>

      <button onclick="executeTeamMenuGen()" id="btn-team-gen"
        style="width:100%; background:linear-gradient(135deg, #1565c0, #0d47a1); color:white; border:none; padding:12px; border-radius:30px; font-weight:bold; cursor:pointer; font-size:16px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
        ğŸ¤– AIã§ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆã™ã‚‹
      </button>

      <div id="team-plan-result"
        style="display:none; margin-top:20px; background:#fff; padding:15px; border-radius:8px; border:1px solid #ccc;">
        <h4 style="margin-top:0; color:#333;">ç”Ÿæˆçµæœ:</h4>
        <div id="team-plan-output"
          style="white-space: pre-wrap; font-size:13px; line-height:1.6; color:#333; max-height:500px; overflow-y:auto; font-family:monospace;">
        </div>
        <button onclick="copyTeamPlan()"
          style="margin-top:10px; background:#00796b; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
    <section id="ai-section" style="
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  margin-bottom:25px;
  width:100%;
  max-width:none;
  text-align:left;
  box-sizing:border-box;
">
      <h3 style="margin-bottom:8px; color:#00796b;">èª²é¡Œãƒ»ç›®çš„ã®å…¥åŠ›</h3>

      <textarea id="free-text" maxlength="300" placeholder="ä¾‹ï¼‰ã‚¹ãƒãƒƒã‚·ãƒ¥ã®å¨åŠ›ã‚’ä¸Šã’ãŸã„ã€‚å¾ŒåŠãƒãƒ†ãªã„ä½“åŠ›ã‚’ã¤ã‘ãŸã„ã€‚ï¼ˆ150æ–‡å­—ä»¥å†…ï¼‰"
        style="width:100%; height:80px; font-size:14px; padding:8px; border:1px solid #ccc; border-radius:6px; resize:none; box-sizing:border-box; background-color: #fff;">
</textarea>
      <div id="char-count" style="text-align: right; font-size: 12px; color: #666; margin-bottom: 5px;">0 / 150</div>

      <button id="ai-suggest-btn" onclick="analyzeAndSuggest()"
        style="display: inline-block; margin-top:10px; background:#00796b; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; min-width: 180px;">
        ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆ
      </button>

      <div id="ai-suggested" style="margin-top:12px; font-size:14px; line-height:1.5;"></div>

      <div id="ai-text-result-area"
        style="display:none; margin-top:15px; background:#fafafa; padding:15px; border:1px solid #ccc; border-radius:8px;">
        <h4 style="margin:0 0 10px 0; color:#00796b;">ğŸ“‹ ãƒãƒ¼ãƒ ç·´ç¿’ãƒ—ãƒ©ãƒ³</h4>
        <div id="ai-text-output"
          style="white-space: pre-wrap; font-family: monospace; font-size:13px; line-height:1.6; color:#333;"></div>
        <button onclick="copyAiTextResult()"
          style="margin-top:15px; background:#00796b; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
          ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        </button>
      </div>

      <button id="add-ai-menus-btn" onclick="addSuggestedMenus()"
        style="display:none; margin-top:15px; background:#e65100; color:white; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-weight:bold;">
        âœ… ææ¡ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¸€æ‹¬ã§ãƒªã‚¹ãƒˆã«è¿½åŠ 
      </button>
    </section>

    <!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ -->
    <div id="create-menu-box"
      style="margin-top: 15px; padding:10px; background:#fff; border:1px solid #ccc; border-radius:6px;">
      <h3 id="create-menu-title" style="margin-bottom:8px; color:#00796b;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ</h3>

      <div
        style="margin-bottom: 15px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button id="btn-save-local"
          style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
        <button id="btn-load-local"
          style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
        <button id="btn-clear-local"
          style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
        <span id="local-save-status" style="font-size:12px; color:#e65100;"></span>
      </div>

      <div style="background: #f1f8e9; padding: 10px; border-radius: 6px; border: 1px solid #c5e1a5;">

        <h4 id="category-select-title" style="margin-top:15px; color:#008c9e;">
          â‘  ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ
        </h4>
        <label id="category-label" for="category">ã‚«ãƒ†ã‚´ãƒªé¸æŠ:</label>
        <select id="category">
          <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
          <optgroup label="æ—¥æœ¬èªãƒ¡ãƒ‹ãƒ¥ãƒ¼">
            <option value="ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—">ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—</option>
            <option value="ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯">ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</option>
            <option value="ãƒãƒƒã‚¯ç³»">ãƒãƒƒã‚¯ç³»</option>
            <option value="ãƒ©ãƒªãƒ¼ç³»">ãƒ©ãƒªãƒ¼ç³»</option>
            <option value="ã‚²ãƒ¼ãƒ ">ã‚²ãƒ¼ãƒ </option>
            <option value="ãƒ•ã‚£ã‚¸ã‚«ãƒ«">ãƒ•ã‚£ã‚¸ã‚«ãƒ«</option>
            <option value="è£œå¼·">è£œå¼·</option>
            <option value="ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰">ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰</option>
            <option value="çŸ¥è­˜">çŸ¥è­˜</option>
            <option value="æ³•æ”¿å¤§å­¦ç·´ç¿’">æ³•æ”¿å¤§å­¦ç·´ç¿’</option>
          </optgroup>
          <optgroup label="English Plan">
            <option value="Warm-up">Warm-up</option>
            <option value="Footwork">Footwork</option>
            <option value="Knock">Knock</option>
            <option value="Rally">Rally</option>
            <option value="Game">Game</option>
            <option value="Physical">Physical</option>
            <option value="Strength">Strength</option>
            <option value="Break (Preparing the next plan)">Break (Preparing the next plan)</option>
            <option value="Knowledge">Knowledge</option>
            <option value="Hosei Univ Practice">Hosei Univ Practice</option>
          </optgroup>
        </select>

        <div id="menu-list"></div>

        <h4 id="newMenuTitle" style="margin-top:15px; color:#008c9e;">â‘¡æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²</h4>

        <label for="new-menu-name">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åï¼š</label>
        <input type="text" id="new-menu-name" autocomplete="off"
          style="width:100%; margin-bottom:10px; box-sizing: border-box;"><br>
        <label for="new-menu-time">æ™‚é–“(åˆ†)ï¼š</label>
        <input type="number" id="new-menu-time" min="0.1" step="0.1" style="width:80px;">
        <button id="add-new-menu-btn">è¿½åŠ </button><br>

        <h4 id="menu-extraction-title" style="margin-top:15px; color:#008c9e;">â‘¢ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
        <label id="random-plan-label">ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º:</label><br>
        <input type="radio" name="random-category" id="random-knock" value="ãƒãƒƒã‚¯ç³»">
        <label for="random-knock" id="label-random-knock">ãƒãƒƒã‚¯</label>
        <input type="radio" name="random-category" id="random-rally" value="ãƒ©ãƒªãƒ¼ç³»">
        <label for="random-rally" id="label-random-rally">ãƒ©ãƒªãƒ¼</label>
        <input type="radio" name="random-category" id="random-strength" value="è£œå¼·">
        <label for="random-strength" id="label-random-strength">è£œå¼·</label>
        <button id="random-btn" style="margin-left:10px;">ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ½å‡º</button>

        <div id="random-result" style="margin-top:10px;"></div>

        <h4 style="margin-bottom:8px; color:#008c9e; margin-top: 15px;"> <span id="lbl-template-header">â‘£ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
        </h4>
        <select id="templateSelect" onchange="applyTemplate()">
          <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã¶</option>
        </select>

        <iframe id="templateViewer"
          style="width:100%; height:600px; border:1px solid #ccc; border-radius:8px; display:none;"></iframe>

      </div><br>

      <label id="start-time-label" for="start-time">é–‹å§‹æ™‚åˆ»:</label><input type="time" id="start-time" value="00:00">
      <label id="total-time-label">ç·´ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰:</label>
      <input type="number" id="target-time" min="10" step="5" style="width:80px;">

      <h4 id="selected-menu-title">é¸æŠã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆå¯ï¼‰</h4>

      <div id="selected-list"></div>

      <p id="total-time-text">ç·æ™‚é–“: <span id="total-time">0</span> åˆ†</p>
      <button id="generate-program">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ</button>
      <button id="preview-program">å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
      <button id="copy-program-html">å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="download-program-png">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
      <button id="download-program-pdf" style="background: #ef5350;">PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

      <div id="program-output"></div>
      <div id="share-preview"></div>

      <div id="time-progress-container" style="margin-top:15px;">


        <div style="margin-top:10px; background:#ddd; border-radius:6px; height:20px; width:100%; overflow:hidden;">
          <div id="time-progress-bar" style="height:100%; width:0%; background:#4caf50; transition:width 0.4s;"></div>
        </div>

        <p id="time-status" style="margin-top:6px; font-size:14px; color:#333;">ç¾åœ¨ 0 / 120 åˆ†</p>
      </div>
    </div>
  </section>

  <section id="screen-tactics" class="screen-content">
    <div id="tactics-board-box"
      style="margin-top: 15px; padding:15px; background:#fff; border:1px solid #ccc; border-radius:6px;">
      <div style="margin-bottom: 15px;">
        <h3 id="tactics-main-title" style="margin:0; color:#00796b;">æˆ¦è¡“ãƒœãƒ¼ãƒ‰</h3>
      </div>

      <div id="tactics-content" style="display:block;">
        <div
          style="margin-bottom: 10px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <button id="btn-t-save" onclick="saveTacticsToBrowser()"
            style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
          <button id="btn-t-restore" onclick="loadTacticsFromBrowser()"
            style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
          <button id="btn-t-delete" onclick="clearTacticsBrowserData()"
            style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
          <span id="tactics-local-status" style="font-size:12px; color:#e65100;"></span>
        </div>

        <div
          style="margin-bottom: 8px; font-size: 14px; font-weight: bold; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <label style="cursor: pointer;">
            <input type="radio" name="game-mode" value="doubles" checked onchange="switchGameMode('doubles')">
            <span id="lbl-doubles">ãƒ€ãƒ–ãƒ«ã‚¹ (4äºº)</span>
          </label>
          <label style="cursor: pointer;">
            <input type="radio" name="game-mode" value="singles" onchange="switchGameMode('singles')">
            <span id="lbl-singles">ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (2äºº)</span>
          </label>
          <label style="cursor: pointer;">
            <input type="radio" name="game-mode" value="custom" onchange="switchGameMode('custom')">
            <span id="lbl-custom">å¤‰å‰‡ (è‡ªç”±è¨­å®š)</span>
          </label>
        </div>

        <div id="custom-tactic-settings"
          style="display: none; background: #fff3e0; padding: 8px; border-radius: 4px; margin-bottom: 10px; align-items: center; gap: 10px;">
          <label style="font-size:13px; color:#d32f2f;">
            Red: <input type="number" id="custom-red-count" value="1" min="1" max="10"
              style="width: 40px; padding: 2px;">
          </label>
          <label style="font-size:13px; color:#1976d2;">
            Blue: <input type="number" id="custom-blue-count" value="2" min="1" max="10"
              style="width: 40px; padding: 2px;">
          </label>
          <button id="btn-apply-custom" onclick="resetTacticPositions()"
            style="font-size: 12px; padding: 4px 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
            é…ç½®é©ç”¨
          </button>
        </div>

        <div id="fixed-name-inputs"
          style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
          <div style="display:flex; align-items:center; gap:5px;">
            <span style="color:red; font-weight:bold;">Red:</span>
            <input type="text" id="input-name-A" placeholder="A" value="A" oninput="updatePlayerLabels()"
              style="width:70px; text-align:center;">
            <span id="container-name-B">
              <input type="text" id="input-name-B" placeholder="B" value="B" oninput="updatePlayerLabels()"
                style="width:70px; text-align:center;">
            </span>
          </div>
          <div style="display:flex; align-items:center; gap:5px;">
            <span style="color:blue; font-weight:bold;">Blue:</span>
            <input type="text" id="input-name-X" placeholder="X" value="X" oninput="updatePlayerLabels()"
              style="width:70px; text-align:center;">
            <span id="container-name-Y">
              <input type="text" id="input-name-Y" placeholder="Y" value="Y" oninput="updatePlayerLabels()"
                style="width:70px; text-align:center;">
            </span>
          </div>
        </div>
      </div>

      <div style="margin-bottom: 10px; font-size: 14px; display: flex; flex-wrap: wrap; gap: 10px;">
        <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="move" checked
            onchange="setTacticMode('move')"> <span id="lbl-move">âœ‹ ç§»å‹•</span></label>
        <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="draw"
            onchange="setTacticMode('draw')"> <span id="lbl-pen">âœï¸ ãƒšãƒ³</span></label>
        <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="arrow"
            onchange="setTacticMode('arrow')"> <span id="lbl-arrow">â†—ï¸ çŸ¢å°</span></label>
        <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="text"
            onchange="setTacticMode('text')"> <span id="lbl-text">ğŸ“ æ–‡å­—</span></label>
        <label style="cursor:pointer;"><input type="radio" name="tactic-mode" value="eraser"
            onchange="setTacticMode('eraser')"> <span id="lbl-eraser">ğŸ§½ æ¶ˆã—ã‚´ãƒ </span></label>
      </div>

      <div style="margin-bottom: 15px;">
        <button id="btn-t-reset" onclick="resetTacticPositions()"
          style="background:#ff9800; color:white; border:none; border-radius:4px; font-size:12px; padding:5px 10px; cursor:pointer;">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="btn-t-clear" onclick="clearTacticLines()"
          style="background:#e53935; color:white; border:none; border-radius:4px; font-size:12px; padding:5px 10px; cursor:pointer;">æ›¸ãè¾¼ã¿æ¶ˆå»</button>
        <button id="btn-t-saveimg" onclick="saveTacticsImage()"
          style="background:#3f51b5; color:white; border:none; border-radius:4px; font-size:12px; padding:5px 10px; cursor:pointer;">ç”»åƒä¿å­˜</button>
      </div>

      <div onclick="toggleTacticsCourt()"
        style="background:#e0f2f1; color:#00796b; padding:8px; text-align:center; cursor:pointer; border-radius:4px; font-weight:bold; user-select:none;">
        <span id="court-toggle-icon">â–¼</span> <span id="court-toggle-text">ã‚³ãƒ¼ãƒˆã‚’è¡¨ç¤º / Open Court</span>
      </div>

      <div id="tactics-court-area" style="display:none; margin-top:15px;">
        <div id="tactics-canvas-container"
          style="position: relative; width: 100%; max-width: 400px; margin: 0 auto; border: 2px solid #333;">
          <canvas id="tacticsCanvas" width="400" height="550"
            style="width:100%; display:block; background: #2e7d32; cursor: grab;"></canvas>
        </div>
        <p style="font-size:12px; color:#666; text-align:center; margin-top:5px;">
          â€»<span id="txt-hint">çŸ¢å°ï¼šãƒ‰ãƒ©ãƒƒã‚° / æ–‡å­—ï¼šã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ› / ç§»å‹•ï¼šãƒ‰ãƒ©ãƒƒã‚°</span>
        </p>
      </div>
    </div>
    </div>

    <div id="court-allocation-box"
      style="margin-top: 15px; padding:15px; background:#fff; border:1px solid #ccc; border-radius:6px;">
      <h3 id="court-allocation-title" style="margin-bottom:10px; color:#00796b;">ã‚³ãƒ¼ãƒˆé…ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h3>

      <div
        style="margin-bottom: 10px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
        <button id="btn-l-save" onclick="saveLayoutToBrowser()"
          style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
        <button id="btn-l-restore" onclick="loadLayoutFromBrowser()"
          style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
        <button id="btn-l-delete" onclick="clearLayoutBrowserData()"
          style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
        <span id="layout-local-status" style="font-size:12px; color:#e65100;"></span>
      </div>
      <div
        style="background:#fff; padding:5px 0; margin-bottom:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; border-bottom:1px solid #eee; padding-bottom:10px;">
        <span id="lbl-new-create" style="font-weight:bold; color:#333; font-size:13px;">â‘  æ–°è¦ä½œæˆ:</span>
        <label style="font-size:13px;"><span id="lbl-court-count">ã‚³ãƒ¼ãƒˆ</span> <input type="number" id="init-court-count"
            value="2" min="0" style="width:40px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
        <label style="font-size:13px;"><span id="lbl-player-count">äººæ•°</span> <input type="number" id="init-player-count"
            value="10" min="1" style="width:40px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
        <button id="btn-init-layout" onclick="initGymLayout()"
          style="background:#fff; color:#00796b; border:1px solid #00796b; padding:5px 12px; border-radius:4px; cursor:pointer; font-size:12px; font-weight:bold;">ç”Ÿæˆ
          / ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div onclick="toggleLayoutBuilder()"
        style="background:#e0f2f1; color:#00796b; padding:8px; text-align:center; cursor:pointer; border-radius:4px; font-weight:bold; user-select:none;">
        <span id="layout-toggle-icon">â–¼</span> <span id="layout-toggle-text">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ã‚’é–‹ã / Open Layout</span>
      </div>

      <div id="layout-builder-content" style="display:none; margin-top:15px;">

        <div style="background:#f5f5f5; padding:10px; border-radius:6px; border:1px solid #ddd; margin-bottom:10px;">

          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
              <button id="btn-add-spot" onclick="addSpotToFloor(50, 50)"
                style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ï¼‹
                ã€‡è¿½åŠ </button>
              <button id="btn-expand-floor" onclick="toggleFloorHeight()"
                style="background:#00897b; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">â†•
                æ‹¡å¼µ</button>
            </div>
            <button id="btn-l-saveimg" onclick="saveGymImage()"
              style="background:#3f51b5; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ“·
              ç”»åƒä¿å­˜</button>
          </div>

          <hr style="border:0; border-top:1px solid #ccc; margin:5px 0 10px 0;">

          <div style="display:flex; flex-wrap:wrap; align-items:center; gap:10px;">
            <label
              style="display:flex; align-items:center; gap:5px; background:#fff; padding:5px 10px; border:1px solid #999; border-radius:4px; cursor:pointer; font-weight:bold; font-size:12px;">
              <input type="checkbox" id="chk-select-mode" onchange="toggleSelectMode(this)">
              <span id="lbl-select-mode">â˜‘ï¸ é¸æŠãƒ¢ãƒ¼ãƒ‰</span>
            </label>

            <div id="align-buttons" style="display:flex; gap:5px; opacity:0.5; pointer-events:none;">
              <button id="btn-align-top" onclick="alignSelected('top')"
                style="background:#fff; border:1px solid #666; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">â¬†ï¸
                ä¸Šæƒãˆ</button>
              <button id="btn-align-left" onclick="alignSelected('left')"
                style="background:#fff; border:1px solid #666; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">â¬…ï¸
                å·¦æƒãˆ</button>
              <button id="btn-align-dist" onclick="alignSelected('distribute')"
                style="background:#fff; border:1px solid #666; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">â†”ï¸
                æ¨ªç­‰é–“éš”</button>
              <button id="btn-l-clear-select" onclick="clearSelection()"
                style="background:#ef5350; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">é¸æŠè§£é™¤</button>
            </div>
          </div>
          <p style="font-size:11px; color:#d32f2f; margin:5px 0 0 0; display:none;" id="select-mode-msg">
            â€»è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„ï¼ˆèµ¤æ ãŒã¤ãã¾ã™ï¼‰
          </p>
        </div>

        <div
          style="background:#fff3e0; padding:8px; border-radius:4px; border:1px solid #ffe0b2; margin-bottom:10px; display:flex; align-items:center; gap:10px;">
          <button id="btn-start-order" onclick="startOrderingMode()"
            style="background:#333; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ğŸ”¢
            ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’æŒ¯ã‚‹</button>
          <span id="ordering-status" style="font-size:12px; color:#d32f2f; font-weight:bold; display:none;">â—
            1ç•ªã‹ã‚‰é †ã«ã‚¯ãƒªãƒƒã‚¯</span>
          <button id="btn-end-order" onclick="endOrderingMode()"
            style="background:#d32f2f; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px; display:none;">å®Œäº†</button>
        </div>

        <div id="gym-floor"
          style="position: relative; width: 100%; height: 400px; background: #e0e0e0; border: 2px solid #999; border-radius: 4px; overflow: hidden; transition: height 0.3s ease;">
          <p id="layout-hint-text"
            style="position:absolute; top:5px; left:5px; margin:0; font-size:11px; color:#666; pointer-events:none;">
            è¦ç´ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•
          </p>
        </div>
      </div>
    </div>

<div id="league-management-box" style="margin-top: 30px; padding:15px; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin:0; color:#00796b;">ğŸ† ãƒªãƒ¼ã‚°æˆ¦ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h3>
        <div style="display: flex; gap: 5px;">
            <button onclick="saveLeagueToBrowser()" style="background:#ff9800; font-size:12px; padding:5px 10px;">ä¿å­˜</button>
            <button onclick="clearLeagueData()" style="background:#bdbdbd; font-size:12px; padding:5px 10px;">å‰Šé™¤</button>
        </div>
    </div>
    
    <div id="league-setup-area" style="background:#f1f8e9; padding:15px; border-radius:8px; border:1px solid #c5e1a5; margin-bottom:20px;">
    <label style="font-weight:bold; font-size:14px; color: #33691e;">â‘  å‚åŠ è€…ãƒ»ãƒãƒ¼ãƒ åã‚’å…¥åŠ›</label>
    <p style="font-size: 11px; color: #666; margin: 4px 0;">åå‰ã‚’æ”¹è¡Œã—ã¦è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã¾ã¨ã‚ã¦è¿½åŠ ã§ãã¾ã™ã€‚</p>
    
    <textarea id="league-player-bulk" placeholder="ä½è—¤&#13;&#10;éˆ´æœ¨&#13;&#10;é«˜æ©‹" style="width:100%; height:80px; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; font-size:14px; line-height:1.5;"></textarea>
    
    <button onclick="addLeaguePlayersBulk()" style="width:100%; margin-top:8px; background:#00897b; font-weight:bold;">ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹</button>
    
    <div id="league-player-list" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:8px;"></div>
    
    <button onclick="generateLeagueSchedule()" id="btn-generate-league" style="width:100%; margin-top:15px; background:#ef6c00; font-weight:bold; height:44px; border-radius:22px; display:none;">
        ğŸ“Š ãƒªãƒ¼ã‚°æˆ¦è¡¨ã‚’ç”Ÿæˆã™ã‚‹
    </button>
</div>

    <div id="league-table-area" style="display:none;">
        <h4 style="color:#00796b; border-left:4px solid #00796b; padding-left:10px; margin-bottom:10px;">ğŸ“… é€²è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»çµæœå…¥åŠ›</h4>
        <div style="overflow-x: auto;">
            <table id="match-schedule-table" style="width:100%; border-collapse:collapse; font-size:14px; background:#fff; min-width:320px;">
                <thead style="background:#f5f5f5;">
                    <tr>
                        <th style="border:1px solid #ddd; padding:8px; width:40px;">No.</th>
                        <th style="border:1px solid #ddd; padding:8px;">å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰</th>
                        <th style="border:1px solid #ddd; padding:8px; width:120px;">ã‚¹ã‚³ã‚¢å…¥åŠ›</th>
                        <th style="border:1px solid #ddd; padding:8px; width:50px;">çŠ¶æ…‹</th>
                    </tr>
                </thead>
                <tbody id="league-matches-body"></tbody>
            </table>
        </div>

        <h4 style="color:#00796b; border-left:4px solid #00796b; padding-left:10px; margin:25px 0 10px 0;">ğŸ“ˆ ç¾åœ¨ã®é †ä½è¡¨</h4>
        <div id="league-ranking-container" style="overflow-x: auto;"></div>
        
        <p style="font-size:11px; color:#666; margin-top:10px;">â€»é †ä½æ±ºå®šå„ªå…ˆåº¦ï¼š1.å‹æ•° / 2.å¾—å¤±ç‚¹å·® / 3.ç·å¾—ç‚¹</p>
    </div>
</div>

  </section>
  <section id="screen-learning" class="screen-content">
    <section id="video-quiz-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #fff3e0; padding: 15px 20px; border-bottom: 1px solid #ffe0b2;">
        <h2 style="color: #1a237e; margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
          Video Learning & Check ï¼ˆå‹•ç”»å­¦ç¿’ï¼†ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ï¼‰
        </h2>
        <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
          å‹•ç”»ã‚’è¦–è´ã—ã€ç†è§£åº¦ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã¦æå‡ºç”¨PDFã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
        </p>
      </div>

      <div style="padding: 20px;">

        <div id="vq-select-screen">
          <p id="vq-status-msg">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          <div id="vq-list"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>
        </div>

        <div id="vq-play-screen" style="display: none;">
          <button onclick="backToVideoList()"
            style="background: #999; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; cursor: pointer;">â—€
            ä¸€è¦§ã«æˆ»ã‚‹</button>

          <div
            style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; margin-bottom: 20px; text-align: center;">
            <h3 id="vq-current-title" style="margin: 0 0 10px 0; color: #0d47a1;"></h3>
            <p style="font-size: 14px; margin-bottom: 10px;">ã¾ãšã¯å‹•ç”»ã‚’è¦–è´ã—ã¦ãã ã•ã„ï¼ˆåˆ¥ã‚¿ãƒ–ã§é–‹ãã¾ã™ï¼‰</p>
            <a id="vq-video-link" href="#" target="_blank" style="
          display: inline-block; 
          background: #d32f2f; color: white; text-decoration: none; 
          padding: 10px 25px; border-radius: 25px; font-weight: bold; 
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
              â–¶ YouTubeã§å‹•ç”»ã‚’è¦–è´ã™ã‚‹
            </a>
          </div>

          <div id="vq-questions-container"></div>

          <div style="text-align: center; margin-top: 20px;">
            <button onclick="submitVideoQuiz()" style="
          background: #ff9800; color: white; border: none; 
          padding: 12px 40px; border-radius: 30px; font-size: 16px; font-weight: bold; 
          cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              æ¡ç‚¹ã™ã‚‹ / Check Answers
            </button>
          </div>
        </div>

        <div id="vq-result-screen" style="display: none; text-align: center;">
          <h3 style="color: #1a237e;">ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† / Session Completed</h3>

          <div id="vq-result-content" style="
        border: 2px solid #ff9800; padding: 20px; margin: 20px auto; 
        max-width: 600px; background: #fff; position: relative;">

            <h4 style="margin: 0; color: #555;">ç†è§£åº¦ãƒã‚§ãƒƒã‚¯çµæœ</h4>
            <h2 id="vq-score-display" style="font-size: 40px; color: #e65100; margin: 10px 0;"></h2>
            <p id="vq-session-name" style="font-weight: bold; margin-bottom: 5px;"></p>
            <p style="font-size: 12px; color: #999;">å—é¨“æ—¥: <span id="vq-date"></span></p>

            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
            <div id="vq-feedback-list" style="text-align: left; font-size: 13px;"></div>
          </div>

          <button onclick="downloadVideoQuizPDF()" style="
        background: #1a237e; color: white; border: none; 
        padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; 
        cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
            ğŸ“„ çµæœã‚’PDFã§æå‡º
          </button>

          <button onclick="backToVideoList()" style="
        background: #ffcc80; color: #e65100; border: none; 
        padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; 
        cursor: pointer; margin-left: 10px;">
            çµ‚äº†ã—ã¦æˆ»ã‚‹
          </button>
        </div>

      </div>
    </section>

    <section id="english-unified-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #fff3e0; padding: 15px 20px 0 20px; border-bottom: 1px solid #ffe0b2;">
        <h2 style="color: #1a237e; margin: 0 0 15px 0; font-size: 20px;">
          Badminton English Learning
        </h2>
        <div style="display: flex; gap: 5px;">
          <button onclick="switchTab('phrases')" id="tab-btn-phrases" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #fff; color: #e65100; font-weight: bold; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
            ğŸ“– Phrase
          </button>
          <button onclick="switchTab('quiz')" id="tab-btn-quiz" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #e65100; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
            ğŸ“ Quiz
          </button>
          <button onclick="switchTab('listening')" id="tab-btn-listening" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #e65100; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
            ğŸ‘‚ Listening
          </button>
        </div>
      </div>

      <div style="padding: 20px;">

        <div id="content-phrases" style="display: block;">
          <div
            style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom: 15px;">
            <p style="font-size: 13px; color: #666; margin:0;">
              å½¹ç«‹ã¤è‹±èªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’éŸ³å£°ä»˜ãã§å­¦ç¿’ã—ã¾ã™ã€‚
            </p>
            <div
              style="background: #f0f0f0; padding: 5px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px;">
              <span style="font-size:12px; font-weight:bold; color:#555;">Speed:</span>
              <input type="range" id="speech-rate" min="0.5" max="1.5" step="0.1" value="1.0"
                style="width: 80px; cursor: pointer;">
              <span id="rate-value" style="font-size:13px; font-weight:bold; color:#e65100; width:30px;">1.0</span>
            </div>
          </div>

          <div id="phrase-tabs"
            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px;">
            <button onclick="filterPhrases('practice')" class="phrase-tab"
              style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ¸
              ç·´ç¿’ãƒ»åˆæµ</button>
            <button onclick="filterPhrases('coaching')" class="phrase-tab"
              style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ“£
              æŒ‡å°ãƒ»åŠ©è¨€</button>
            <button onclick="filterPhrases('communication')" class="phrase-tab"
              style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ¤
              æŒ¨æ‹¶ãƒ»ä¼šè©±</button>
            <button onclick="filterPhrases('airport')" class="phrase-tab"
              style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">âœˆï¸
              ç©ºæ¸¯ãƒ»ç§»å‹•</button>
            <button onclick="filterPhrases('hotel')" class="phrase-tab"
              style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ¨
              ãƒ›ãƒ†ãƒ«ãƒ»ç”Ÿæ´»</button>
            <button onclick="filterPhrases('tourism')" class="phrase-tab"
              style="padding: 8px 5px; background: #fff; border: 1px solid #ccc; color:#666; cursor: pointer; border-radius: 4px; width: 100%; font-size: 13px;">ğŸ“·
              è¦³å…‰ãƒ»é£Ÿäº‹</button>
          </div>

          <div id="english-loading" style="text-align:center; color:#999; padding:20px;">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
          <div id="phrase-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <div id="content-quiz" style="display: none;">
          <div style="border-left: 4px solid #ff9800; padding-left: 10px; margin-bottom: 15px;">
            <h3 style="margin:0; color: #ff9800;">Badminton English Quiz</h3>
            <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
              å•é¡Œæ–‡ã‚’èª­ã‚“ã§æ­£è§£ã‚’é¸ã¶ã‚¯ã‚¤ã‚ºã§ã™ã€‚ï¼ˆå…¨5å•ï¼‰
            </p>
          </div>

          <div id="quiz-start-screen" style="text-align:center; padding: 20px; background:#fafafa; border-radius:8px;">
            <p id="quiz-status-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <button id="start-quiz-btn" onclick="startQuiz('normal')" disabled style="
          background: #ff9800; color: white; border: none; padding: 10px 25px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5;">
              ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹
            </button>
          </div>

          <div id="quiz-play-screen" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
              <span id="quiz-count" style="font-weight:bold; color:#ff9800;">Q 1 / 5</span>
              <span id="quiz-score" style="font-weight:bold; color:#333;">Score: 0</span>
            </div>
            <div id="quiz-question" style="font-size:16px; font-weight:bold; margin-bottom:20px; min-height:50px;">
            </div>
            <div id="quiz-options" style="display: grid; gap: 10px;"></div>

            <div id="quiz-feedback"
              style="display:none; margin-top:15px; padding:15px; border-radius:8px; background:#f0f0f0;">
              <h3 id="quiz-feedback-title" style="margin:0 0 5px 0;"></h3>
              <p id="quiz-feedback-text" style="margin:0; font-size:14px; color:#333; line-height:1.6;"></p>
              <button onclick="nextQuestion()"
                style="margin-top:10px; background:#333; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æ¬¡ã¸
                â¡</button>
            </div>
          </div>

          <div id="quiz-result-screen" style="display:none; text-align:center; padding:20px;">
            <h3 style="color:#333;">çµæœç™ºè¡¨</h3>
            <p id="quiz-final-score" style="font-size:24px; font-weight:bold; color:#ff9800; margin:10px 0;"></p>
            <button onclick="startQuiz('normal')"
              style="margin-top:20px; background:#ff9800; color:white; border:none; padding:10px 25px; border-radius:25px; cursor:pointer;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
          </div>
        </div>

        <div id="content-listening" style="display: none;">
          <div style="border-left: 4px solid #00acc1; padding-left: 10px; margin-bottom: 15px;">
            <h3 style="margin:0; color: #00acc1;">Listening Test</h3>
            <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
              éŸ³å£°ã‚’èã„ã¦ã€æ­£ã—ã„ç­”ãˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ï¼ˆå…¨5å•ï¼‰
            </p>
          </div>

          <div id="listening-start-screen"
            style="text-align:center; padding: 20px; background:#fafafa; border-radius:8px;">
            <p id="listening-status-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <button id="start-listening-btn" onclick="startQuiz('listening')" disabled style="
          background: #00acc1; color: white; border: none; padding: 10px 25px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5;">
              ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹
            </button>
          </div>

          <div id="listening-play-screen" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
              <span id="listening-count" style="font-weight:bold; color:#00acc1;">Q 1 / 5</span>
              <span id="listening-score" style="font-weight:bold; color:#333;">Score: 0</span>
            </div>

            <div id="listening-question-area"
              style="text-align:center; padding: 30px 0; background:#e0f7fa; border-radius:8px; margin-bottom:20px;">
              <p style="font-size:14px; color:#555; margin-bottom:10px;">éŸ³å£°ã‚’å†ç”Ÿã—ã¦å•é¡Œã‚’èã„ã¦ãã ã•ã„</p>
              <button id="listening-speak-btn" style="
              width: 80px; height: 80px; border-radius: 50%; border: none; 
              background: #00acc1; color: white; font-size: 40px; cursor: pointer;
              box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s;
          " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                ğŸ”Š
              </button>
            </div>

            <div id="listening-options" style="display: grid; gap: 10px;"></div>

            <div id="listening-feedback"
              style="display:none; margin-top:15px; padding:15px; border-radius:8px; background:#f0f0f0;">
              <h3 id="listening-feedback-title" style="margin:0 0 5px 0;"></h3>
              <p id="listening-feedback-text" style="margin:0; font-size:14px; color:#333; line-height:1.6;"></p>
              <button onclick="nextQuestion()"
                style="margin-top:10px; background:#333; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æ¬¡ã¸
                â¡</button>
            </div>
          </div>

          <div id="listening-result-screen" style="display:none; text-align:center; padding:20px;">
            <h3 style="color:#333;">Result</h3>
            <p id="listening-final-score" style="font-size:24px; font-weight:bold; color:#00acc1; margin:10px 0;"></p>
            <button onclick="startQuiz('listening')"
              style="margin-top:20px; background:#00acc1; color:white; border:none; padding:10px 25px; border-radius:25px; cursor:pointer;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
          </div>
        </div>

      </div>
    </section>


    <section id="knowledge-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #fff3e0; padding: 15px 20px 0 20px; border-bottom: 1px solid #ffe0b2;">
        <h2 style="color: #1a237e; margin: 0 0 15px 0; font-size: 20px;">
          Badminton Theory Quiz
        </h2>
        <div style="display: flex; gap: 5px;">
          <button onclick="switchKnowledgeTab('basic')" id="k-tab-basic" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #fff; color: #e65100; font-weight: bold; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
            ğŸ“˜ åŸºç¤ç†è«–
          </button>
          <button onclick="switchKnowledgeTab('tactics')" id="k-tab-tactics" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #8d6e63; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
            âš”ï¸ æˆ¦è¡“ç†è«–
          </button>
          <button onclick="switchKnowledgeTab('coaching')" id="k-tab-coaching" style="
        flex: 1; padding: 10px; border: none; 
        border-radius: 8px 8px 0 0; 
        background: #ffe0b2; color: #8d6e63; font-weight: normal; cursor: pointer;
        transition: all 0.2s; font-size: 13px;
      ">
            ğŸ“£ ã‚³ãƒ¼ãƒãƒ³ã‚°
          </button>
        </div>
      </div>

      <div style="padding: 20px;">
        <div id="knowledge-start-screen"
          style="text-align:center; padding: 20px; background:#fafafa; border-radius:8px;">
          <h3 id="knowledge-category-title" style="margin:0 0 10px 0; color:#e65100;">åŸºç¤ç†è«–ã‚¯ã‚¤ã‚º</h3>
          <p id="knowledge-status-msg">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>

          <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button id="start-knowledge-btn" onclick="startKnowledgeQuiz(5)" disabled style="
          background: #ffb74d; color: white; border: none; padding: 10px 20px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5;">
              ç·´ç¿’ (5å•)
            </button>

            <button id="start-test-btn" onclick="startKnowledgeQuiz(20)" disabled style="
          background: #e65100; color: white; border: none; padding: 10px 20px; 
          font-size: 16px; border-radius: 25px; cursor: pointer; opacity: 0.5; font-weight:bold;">
              å®ŸåŠ›è¨ºæ–­ãƒ†ã‚¹ãƒˆ (20å•)
            </button>
          </div>
        </div>

        <div id="knowledge-play-screen" style="display:none;">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="knowledge-count" style="font-weight:bold; color:#e65100;">Q 1 / 5</span>
            <span id="knowledge-score" style="font-weight:bold; color:#333;">Score: 0</span>
          </div>
          <div id="knowledge-question"
            style="font-size:16px; font-weight:bold; margin-bottom:20px; min-height:50px; padding:15px; background:#fff3e0; border-radius:6px;">
          </div>
          <div id="knowledge-options" style="display: grid; gap: 10px;"></div>

          <div id="knowledge-feedback"
            style="display:none; margin-top:15px; padding:15px; border-radius:8px; background:#f0f0f0;">
            <h3 id="knowledge-feedback-title" style="margin:0 0 5px 0;"></h3>
            <p id="knowledge-feedback-text" style="margin:0; font-size:14px; color:#333; line-height:1.6;"></p>
            <button onclick="nextKnowledgeQuestion()"
              style="margin-top:10px; background:#333; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;">æ¬¡ã¸
              â¡</button>
          </div>
        </div>

        <div id="knowledge-result-screen" style="display:none; text-align:center; padding:20px;">
          <h3 style="color:#333;">çµæœç™ºè¡¨</h3>
          <p id="knowledge-final-score" style="font-size:24px; font-weight:bold; color:#e65100; margin:10px 0;"></p>
          <p id="knowledge-rank-msg" style="font-size:16px; font-weight:bold; color:#1a237e; min-height: 20px;"></p>

          <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
            <button onclick="downloadKnowledgePDF()"
              style="background: #1a237e; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
              ğŸ“„ çµæœã‚’PDFã§ä¿å­˜
            </button>
            <button onclick="resetKnowledgeQuiz()"
              style="background: #ffb74d; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer;">
              ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
            </button>
          </div>
        </div>
      </div>
    </section>
  </section>
  
<script>
    function openSimulation() {
      document.getElementById('sim-start-screen').style.display = 'none';
      document.getElementById('sim-game-screen').style.display = 'block';
      // å¿…è¦ã§ã‚ã‚Œã°ã“ã“ã§åˆæœŸåŒ–é–¢æ•°ã‚’å‘¼ã¶ (ä¾‹: initSimulation())
    }
  </script>

  <section id="screen-utility" class="screen-content">
    <section id="daily-challenge-section" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  ">
      <div style="background: #fff3e0; padding: 15px 20px; border-bottom: 1px solid #ffe0b2;">
        <h2 style="color: #1a237e; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
          <span id="daily-title">æ—¥æœ¬ä¸€å‘¨ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã®æ—…</span>
        </h2>
        <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
          <span id="daily-desc">ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸè£œå¼·ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€åœ°å›³ã‚’å¡—ã‚Šã¤ã¶ãã†ï¼</span>
        </p>
      </div>

      <div
        style="background: #fff9c4; padding: 10px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #fbc02d;">
        <label style="font-size: 12px; font-weight: bold; color: #f57f17;">ğŸ‘¤ æ—…äºº:</label>
        <select id="daily-user-select" onchange="switchDailyUser()"
          style="flex: 1; padding: 5px; border-radius: 4px; border: 1px solid #fbc02d;">
        </select>
        <button onclick="addDailyUser()"
          style="background: #fbc02d; color: #333; border: none; border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer; font-weight: bold;">ï¼‹è¿½åŠ </button>
        <button onclick="renameDailyUser()"
          style="background: #ffa000; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer;">åå‰å¤‰æ›´</button>
        <button onclick="deleteDailyUser()"
          style="background: #ef5350; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer;">å‰Šé™¤</button>
      </div>
      <div style="padding: 20px; text-align: center;">

        <div style="margin-bottom: 20px;">
          <div id="map-collapsible-area"
            style="background: #f0f4c3; padding: 15px; border-radius: 10px; border: 2px solid #dce775; display: block;">
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
              <button onclick="switchMapMode('japan')" id="btn-map-japan"
                style="padding:6px 16px; border-radius:20px; border:none; background:#8bc34a; color:white; font-weight:bold; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ğŸ‡¯ğŸ‡µ æ—¥æœ¬ä¸€å‘¨
              </button>
              <button onclick="switchMapMode('world')" id="btn-map-world" disabled
                style="padding:6px 16px; border-radius:20px; border:none; background:#ccc; color:#666; font-weight:bold; cursor:not-allowed; box-shadow: none;">
                ğŸ”’ ä¸–ç•Œä¸€å‘¨ (æ—¥æœ¬ã‚¯ãƒªã‚¢ã§è§£æ”¾)
              </button>
            </div>

            <div style="font-weight:bold; color:#33691e; margin-bottom:5px; text-align: center;">
              ç¾åœ¨åœ°: <span id="current-location-name" style="font-size:18px; color:#d84315;">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div style="font-size:12px; color:#555; margin-bottom:10px; text-align: center;">
              <span id="map-progress-text">-- / -- åˆ¶è¦‡</span>
            </div>

            <div id="map-visual-container"
              style="width:100%; min-height:300px; margin:0 auto; background-color:#b3e5fc; border-radius:8px; border:2px solid #81d4fa; overflow:hidden;">
            </div>
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <label for="daily-count" style="font-weight:bold; color:#333;"><span id="lbl-daily-count">ç¨®ç›®æ•°:</span></label>
          <input type="number" id="daily-count" value="7" min="1" max="20"
            style="width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 4px; padding: 4px;">
          <button id="btn-daily-gen" onclick="generateDailyChallenge()" style="
          background: #ff6f00; color: white; border: none; 
          padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-left: 10px;
        ">
            ğŸ° ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆ
          </button>
        </div>

        <div id="daily-menu-list"
          style="text-align: left; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; display: none;">
        </div>

        <button id="btn-complete-challenge" onclick="completeDailyChallenge()" disabled style="
        background: #ccc; color: white; border: none; 
        padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold;
        cursor: not-allowed; transition: all 0.3s;
      ">
          âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼ (é€²ã‚€)
        </button>
        <div id="daily-message" style="margin-top:10px; font-weight:bold; color:#e65100; height:20px;"></div>

        <hr style="border: 0; border-top: 1px dashed #ffe0b2; margin: 25px 0;">

        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px;">
          <div
            style="background: #fff; padding: 15px 20px; border-radius: 8px; flex: 1; min-width: 140px; max-width: 200px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;"><span id="lbl-streak">ğŸ”¥ é€£ç¶šé”æˆ</span></div>
            <div style="font-size: 28px; font-weight: bold; color: #ff6f00;">
              <span id="streak-count">0</span> <span style="font-size:14px;">Days</span>
            </div>
          </div>

          <div
            style="background: #fff; padding: 15px 20px; border-radius: 8px; flex: 1; min-width: 140px; max-width: 200px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #eee; text-align: center;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;"><span id="lbl-badges">ğŸ–ï¸ ç²å¾—ãƒãƒƒã‚¸</span></div>
            <div style="font-size: 28px; font-weight: bold; color: #fbc02d;">
              <span id="badge-count">0</span> <span style="font-size:14px;">å€‹</span>
            </div>
          </div>
        </div>

        <div style="margin-top: 20px; text-align: right;">
          <button onclick="resetDailyData()" style="
              background: #b0bec5; color: white; border: none; 
              padding: 5px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;
          ">
            ğŸ—‘ï¸ æ—…ã®è¨˜éŒ²ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>
    </section>

    <section id="wrist-drill-section" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #e0f2f1; padding: 15px 20px; border-bottom: 1px solid #b2dfdb;">
        <h2 style="color: #00695c; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
          ãƒªã‚¹ãƒˆå¼·åŒ–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        </h2>
        <p style="font-size: 13px; color: #00796b; margin: 5px 0 0 0;">
          ã€Œãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«ã€ã‚’ç¶™ç¶šã—ã¦ã€ã‚·ãƒ§ãƒƒãƒˆã®é‹­ã•ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
        </p>
      </div>

      <div
        style="background: #b2dfdb; padding: 10px 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #00695c;">
        <label style="font-size: 12px; font-weight: bold; color: #004d40;">ğŸ‘¤ è¨˜éŒ²ã™ã‚‹äºº:</label>
        <select id="wrist-user-select" onchange="switchWristUser()"
          style="flex: 1; padding: 5px; border-radius: 4px; border: 1px solid #00695c;">
        </select>
        <button onclick="addWristUser()"
          style="background: #00695c; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer;">ï¼‹è¿½åŠ </button>
        <button onclick="renameWristUser()"
          style="background: #ffa000; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer;">åå‰å¤‰æ›´</button>
        <button onclick="deleteWristUser()"
          style="background: #ef5350; color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 12px; cursor: pointer;">å‰Šé™¤</button>
      </div>
      <div style="padding: 20px;">

        <div style="
    margin-bottom: 25px; 
    background: #f1f8e9; 
    border: 1px solid #c5e1a5; 
    border-radius: 8px; 
    padding: 15px; 
    display: flex; 
    gap: 15px; 
    align-items: flex-start;
">
          <div id="wrist-thumb-area" style="flex: 0 0 130px; cursor: pointer; position: relative;"
            onclick="window.open('https://youtu.be/NSLZMGqPgB0', '_blank')">

            <img id="wrist-img" src="https://img.youtube.com/vi/NSLZMGqPgB0/mqdefault.jpg" alt="å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«"
              style="width: 100%; height: auto; border-radius: 6px; border: 1px solid #ccc; background: #000; display: block;">

            <div style="
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold;
        ">
              â–¶ å†ç”Ÿ
            </div>
          </div>

          <div style="flex: 1;">
            <h4 id="wrist-title" style="margin: 0 0 5px 0; color: #2e7d32; font-size: 16px;">
              ğŸ“‹ ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«
            </h4>
            <p id="wrist-desc"
              style="margin: 0 0 10px 0; font-size: 13px; color: #555; line-height: 1.5; white-space: pre-wrap;">
              ï¼œå›æ•°ç›®å®‰ï¼š10å›Ã—11æ–¹å‘ï¼ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«ã¯ã€ãƒ©ã‚±ãƒƒãƒˆã«ãƒ©ã‚±ãƒƒãƒˆã‚«ãƒãƒ¼ã‚„è»½ã„ã‚¦ã‚§ã‚¤ãƒˆã‚’è£…ç€ã—ã¦æŒ¯ã‚‹ã“ã¨ã§ã€æ‰‹é¦–ï¼ˆãƒªã‚¹ãƒˆï¼‰ã®ç­‹åŠ›ã¨å®‰å®šæ€§ã‚’å¼·åŒ–ã™ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã™ã€‚
              ãƒ©ã‚±ãƒƒãƒˆã‚’å¤šæ§˜ãªæ–¹å‘ã«æŒ¯ã‚‹ã“ã¨ãŒé‡è¦ã§ã€ã“ã‚Œã«ã‚ˆã‚Šã‚·ãƒ§ãƒƒãƒˆã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«åŠ›ã‚„ã‚¹ã‚¤ãƒ³ã‚°ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’é«˜ã‚ã€å®Ÿéš›ã®è©¦åˆã§ã®å¯¾å¿œåŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
            </p>
            <a id="wrist-link" href="https://youtu.be/NSLZMGqPgB0" target="_blank"
              style="font-size: 13px; color: #1565c0; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 4px;">
              ğŸ“º YouTubeã§å‹•ç”»ã‚’è¦‹ã‚‹ â†—
            </a>
          </div>
        </div>
      </div>

      <div style="text-align: center; margin-bottom: 20px;">
        <button id="btn-wrist-done" onclick="markWristDrillDone()" style="
                background: #00897b; color: white; border: none;
                padding: 12px 40px; border-radius: 30px;
                font-size: 16px; font-weight: bold; cursor: pointer;
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                transition: transform 0.1s;
                display: inline-flex; align-items: center; gap: 8px;
            " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
          <span>âœ…</span> ä»Šæ—¥å®Ÿæ–½ã—ãŸï¼
        </button>
        <p id="wrist-status-msg" style="margin-top: 10px; color: #00695c; font-weight: bold; height: 20px;"></p>
      </div>

      <div
        style="background: #e0f7fa; padding: 15px; border-radius: 8px; max-width: 400px; margin: 0 auto; border: 1px solid #b2ebf2;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <button onclick="changeWristMonth(-1)"
            style="background:none; border:none; cursor:pointer; font-size:18px; color:#006064;">â—€</button>
          <span id="wrist-cal-title" style="font-weight:bold; font-size:16px; color:#006064;">2025å¹´ 1æœˆ</span>
          <button onclick="changeWristMonth(1)"
            style="background:none; border:none; cursor:pointer; font-size:18px; color:#006064;">â–¶</button>
        </div>

        <div
          style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">
          <span style="color:#d32f2f;">æ—¥</span>
          <span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span>
          <span style="color:#1976d2;">åœŸ</span>
        </div>

        <div id="wrist-cal-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
        </div>
      </div>

      <div style="text-align: right; margin-top: 10px;">
        <div style="font-size: 12px; color: #666;">
          ä»Šæœˆã®å®Ÿæ–½å›æ•°: <span id="wrist-monthly-count" style="font-weight:bold; font-size:16px; color:#00897b;">0</span> å›
        </div>
      </div>
      </div>
    </section>

    <section id="group-work-section" class="utility-sub-section" style="
      margin-top: 30px; 
      padding: 20px; 
      background: #fff; 
      border: 1px solid #ccc; 
      border-radius: 10px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  ">
      <h3 id="random-plan-title" style="margin-bottom:15px; color:#00796b;">ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯</h3>

      <div style="background: #f1f8e9; padding: 10px; border-radius: 6px; border: 1px solid #c5e1a5;">
        <label id="lbl-name-list" style="font-weight:bold; color:#33691e;">å‚åŠ è€…åç°¿ (æ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›):</label>
        <textarea id="name-list-input" placeholder="ä¾‹ï¼š
  ä½è—¤
  éˆ´æœ¨
  é«˜æ©‹
  ç”°ä¸­" style="width:100%; height:80px; box-sizing:border-box; border:1px solid #ccc; padding:5px; margin-bottom:10px;"></textarea>

        <div id="note-name-list" style="font-size:12px; color:#555; margin-bottom:10px;">
          â€»ã“ã“ã«åå‰ãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æŠ½é¸ã•ã‚Œã¾ã™ã€‚
        </div>

        <h4 id="h-pick-winner" style="margin:10px 0 5px 0; color:#008c9e;">â‘  å½“é¸è€…ã‚’é¸ã¶ (1å)</h4>
        <button id="btn-pick-winner" onclick="extractNameRandomly()"
          style="background:#008c9e; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
          1åæŠ½å‡º
        </button>

        <h4 id="h-group-divide" style="margin:15px 0 5px 0; color:#008c9e;">â‘¡ ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</h4>
        <label>
          <span id="lbl-group-num-text">ã‚°ãƒ«ãƒ¼ãƒ—æ•°:</span>
          <input type="number" id="group-num-input" value="2" min="2" style="width:50px; padding:4px;">
        </label>
        <button id="btn-group-divide" onclick="groupNamesRandomly()"
          style="background:#008c9e; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">
          ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ
        </button>

        <div style="text-align:right; margin-top:5px;">
          <button id="btn-clear-history" onclick="clearHistory()"
            style="background:#9e9e9e; color:white; border:none; padding:4px 8px; font-size:12px; border-radius:4px; cursor:pointer;">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div id="history-container" style="margin-top:15px; border-top:2px solid #ddd; padding-top:10px;">
        <p id="h-history-title" style="color:#666; font-size:13px; margin:0 0 5px 0;">â–¼ æŠ½é¸çµæœå±¥æ­´ (æ–°ã—ã„é †)</p>
        <div id="history-list" style="max-height: 300px; overflow-y: auto;">
        </div>
      </div>
    </section>

    <section id="program-timer-section" class="utility-sub-section" style="
      margin-top: 30px; 
      padding: 20px; 
      background: #fff; 
      border: 1px solid #ccc; 
      border-radius: 10px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  ">
      <h3 id="program-timer-title" style="margin-bottom:8px; color:#00796b;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼</h3>

      <div id="steps-container" class="steps"></div>
      <button id="add-step" type="button">ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ </button>

      <div class="set-group" style="margin-top:10px; margin-bottom:15px;">
        <label id="set-count-label" for="set-count">ã‚»ãƒƒãƒˆæ•°ï¼š</label>
        <input type="number" id="set-count" min="1">
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button id="start-timer" type="button">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="stop-timer" type="button">â–  ã‚¹ãƒˆãƒƒãƒ—</button>
        <button id="reset-timer" type="button">âŸ³ ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div id="timer-display" class="timer-display">
        <h2 id="current-set">Set 1 / 3</h2>
        <h1 id="time-left">00:00</h1>
        <h3 id="step-info">Step 1</h3>
      </div>
    </section>
    <div
      style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 10px; text-align: center;">
      <h3 style="color: #555; margin-top: 0;">ğŸ”§ ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h3>
      <p style="font-size: 13px; color: #666;">
        ã€Œç”»é¢ãŒå¤ã„ã¾ã¾æ›´æ–°ã•ã‚Œãªã„ã€ã€Œå‹•ããŒãŠã‹ã—ã„ã€ã¨ã„ã†å ´åˆã«æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
        ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã€æœ€æ–°ã®çŠ¶æ…‹ã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
      </p>
      <button onclick="forceUpdateApp()" style="
        background: #d32f2f; 
        color: white; 
        border: none; 
        padding: 12px 30px; 
        border-radius: 30px; 
        font-weight: bold; 
        cursor: pointer; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    ">
        ğŸ”„ ã‚¢ãƒ—ãƒªã‚’å¼·åˆ¶æ›´æ–°ã™ã‚‹
      </button>
    </div>
  </section>
  </section>


  <section id="screen-studio" class="screen-content">
    <div id="class-studio-section" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  ">
      <div style="background: #f3e5f5; padding: 15px 20px; border-bottom: 1px solid #e1bee7;">
        <h2 style="color: #4a148c; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
          ğŸ¥ æˆæ¥­å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ª
        </h2>
        <p style="font-size: 13px; color: #666; margin: 5px 0 0 0;">
          æ•™æã‚„åˆ†æç”»é¢ã‚’æ“ä½œã—ãªãŒã‚‰éŸ³å£°ã‚’å¹ãè¾¼ã¿ã€æˆæ¥­å‹•ç”»ã‚’ä½œæˆã—ã¾ã™ã€‚<br>
          <strong>éŒ²ç”»ä¸­ã§ã‚‚å…±æœ‰ç”»é¢ã®å¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚</strong>
        </p>
      </div>

      <div style="padding: 20px;">

        <div style="margin-bottom: 20px; text-align: center;">
          <button onclick="startStudioScreenShare()" style="
          background: linear-gradient(135deg, #7b1fa2, #ba68c8); 
          color: white; border: none; padding: 15px 40px; 
          border-radius: 30px; font-weight: bold; font-size: 16px;
          cursor: pointer; display: inline-flex; align-items: center; gap: 10px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            ğŸš€ ã‚¹ã‚¿ã‚¸ã‚ªã‚’é–‹å§‹ã™ã‚‹ (ç”»é¢é¸æŠ)
          </button>
          <p
            style="font-size:13px; color:#333; margin-top:10px; background:#e3f2fd; padding:10px; border-radius:6px; text-align:left;">
            <strong>ğŸ’¡ ç”»é¢å…¨ä½“ã‚’éŒ²ç”»ã™ã‚‹å ´åˆã®ã‚³ãƒ„:</strong><br>
            ã€Œç”»é¢å…¨ä½“ã€ã‚’é¸ã¶ã¨ã€ã“ã®ç”»é¢è‡ªä½“ãŒæ˜ ã‚Šè¾¼ã‚“ã§ã€Œåˆã‚ã›é¡ï¼ˆç„¡é™ãƒŸãƒ©ãƒ¼ï¼‰ã€ã«ãªã‚Šã¾ã™ã€‚<br>
            éŒ²ç”»ã‚’é–‹å§‹ã—ãŸã‚‰ã€æ“ä½œãƒ‘ãƒãƒ«ã® <span style="background:#555; color:white; padding:2px 6px; border-radius:4px;">ğŸ¥
              Preview</span> ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º(ğŸ™ˆ)</strong>ã«ã™ã‚‹ã¨ã€åˆã‚ã›é¡ã‚’é˜²ã„ã§ç¶ºéº—ã«éŒ²ç”»ã§ãã¾ã™ã€‚
          </p>
        </div>

        <div id="studio-container" style="
        max-width: 800px; margin: 0 auto; 
        background: #000; border-radius: 8px; 
        overflow: hidden; position: relative; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        display: flex; flex-direction: column;
      ">

          <div
            style="position: relative; flex: 1; background: #000; display: flex; align-items: center; justify-content: center; min-height: 400px;">
            <video id="studio-preview" playsinline muted autoplay
              style="width: 100%; height: 100%; max-height: 80vh; object-fit: contain;"></video>

            <div id="studio-rec-indicator"
              style="display:none; position: absolute; top: 20px; right: 20px; background: rgba(255, 0, 0, 0.9); color: white; padding: 6px 15px; border-radius: 4px; font-weight: bold; font-size: 14px; animation: blink 1s infinite; z-index: 20;">
              â— REC
            </div>
          </div>

          <div id="studio-controls" style="
          background: rgba(30, 30, 30, 0.95); 
          padding: 10px 15px; 
          display: flex; align-items: center; justify-content: space-between;
          border-top: 1px solid #444;
          flex-wrap: wrap; gap: 10px;
        ">

            <div style="display: flex; gap: 10px; align-items: center;">
              <div style="text-align: center;">
                <button id="btn-toggle-mic" onclick="toggleStudioMic()" disabled
                  style="background:#444; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:not-allowed; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                  ğŸ¤
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Mic</span>
              </div>

              <div style="text-align: center;">
                <button id="btn-toggle-cam" onclick="toggleStudioCamera()" disabled
                  style="background:#444; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:not-allowed; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                  ğŸ“·
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Cam</span>
              </div>

              <div style="text-align: center;">
                <button id="btn-change-screen" onclick="changeStudioSource()" disabled
                  style="background:#0277bd; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:not-allowed; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                  ğŸ”„
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Change</span>
              </div>

              <div style="text-align: center;">
                <button id="btn-toggle-preview" onclick="toggleStudioPreview()"
                  style="background:#555; color:white; border:none; padding:0; border-radius:50%; width:40px; height:40px; cursor:pointer; font-size: 18px; display:flex; align-items:center; justify-content:center; transition: background 0.2s;">
                  ğŸ¥
                </button>
                <span style="font-size:9px; color:#aaa; display:block; margin-top:2px;">Preview</span>
              </div>
            </div>

            <div
              style="flex: 1; margin: 0 15px; display: flex; flex-direction: column; justify-content: center; min-width: 80px;">
              <div
                style="display: flex; justify-content: space-between; color: #bbb; font-size: 10px; margin-bottom: 4px;">
                <span>Mic Level</span>
                <span id="mic-status-text">OFF</span>
              </div>
              <div
                style="background: #555; height: 6px; border-radius: 3px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);">
                <div id="audio-level-bar"
                  style="width: 0%; height: 100%; background: linear-gradient(to right, #00e676, #ffeb3b, #ff1744); transition: width 0.05s;">
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 15px; align-items: center;">
              <button onclick="toggleStudioFullScreen()" title="å…¨ç”»é¢è¡¨ç¤º"
                style="background:transparent; color:white; border:1px solid #777; padding:6px 10px; border-radius:6px; cursor:pointer; font-size: 16px;">
                â›¶
              </button>

              <button id="btn-studio-record" onclick="toggleStudioRecording()" disabled style="
              background: #ccc; color: white; border: none; 
              width: 54px; height: 54px; border-radius: 50%; 
              font-size: 20px; cursor: not-allowed; 
              display: flex; align-items: center; justify-content: center;
              box-shadow: 0 4px 8px rgba(0,0,0,0.3);
              transition: all 0.2s;
            ">
                â—
              </button>
            </div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
          <button onclick="stopStudioStream()" id="btn-studio-stop-stream"
            style="display:none; background:#546e7a; color:white; border:none; padding:10px 30px; border-radius:6px; cursor:pointer; font-weight:bold;">
            â¹ çµ‚äº†ã™ã‚‹
          </button>
        </div>

        <video id="hidden-source-video" playsinline muted autoplay
          style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;"></video>
        <canvas id="studio-mixing-canvas"
          style="position:fixed; top:0; left:0; width:1px; height:1px; opacity:0; pointer-events:none; z-index:-1;"></canvas>
      </div>
    </div>

    <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">
    <div id="video-editor-area" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #e0f2f1; padding: 15px 20px; border-bottom: 1px solid #b2dfdb;">
        <h2 style="color: #00695c; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
          âœ‚ï¸ å‹•ç”»ç·¨é›†ãƒ»åˆ†æãƒã‚¹ã‚¯ä½œæˆ
        </h2>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          å‹•ç”»ã®ãƒˆãƒªãƒŸãƒ³ã‚°ã€ã‚µã‚¤ã‚ºå¤‰æ›´(16:9 / 9:16)ã€é»’ãƒã‚¹ã‚¯åŠ å·¥ãŒã§ãã¾ã™ã€‚
        </p>
      </div>

      <div style="padding: 20px;">

        <div style="margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #ccc;">
          <h4 style="margin-top:0; color:#00796b;">1. ç´ æå‹•ç”»ã‚’é¸æŠ</h4>
          <input type="file" id="editor-file-input" accept="video/*" onchange="loadEditorVideo(this)"
            style="width:100%;">
        </div>

        <div id="editor-controls" style="display:none;">

          <div style="display:flex; flex-wrap:wrap; gap:20px;">
            <div
              style="flex:1; min-width:250px; background:#fafafa; padding:15px; border-radius:8px; border:1px solid #ddd;">
              <h4 style="margin-top:0; color:#00796b; font-size:14px;">2. ç”»é¢ã‚µã‚¤ã‚º (æ¯”ç‡)</h4>
              <div style="display:flex; gap:10px; font-size:13px;">
                <label style="cursor:pointer;"><input type="radio" name="aspect" value="16:9" checked
                    onchange="updateEditorCanvas()"> æ¨ª (16:9) YouTube</label>
                <label style="cursor:pointer;"><input type="radio" name="aspect" value="9:16"
                    onchange="updateEditorCanvas()"> ç¸¦ (9:16) Shorts</label>
              </div>
            </div>

            <div
              style="flex:1; min-width:250px; background:#fafafa; padding:15px; border-radius:8px; border:1px solid #ddd;">
              <h4 style="margin-top:0; color:#00796b; font-size:14px;">3. ãƒˆãƒªãƒŸãƒ³ã‚° (ç§’)</h4>
              <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px; font-size:13px;">
                <label>é–‹å§‹:<input type="number" id="trim-start" value="0" min="0" step="0.01" style="width:60px;"></label>
                <span>ï½</span>
                <label>çµ‚äº†:<input type="number" id="trim-end" value="0" min="0" step="0.01" style="width:60px;"></label>
            </div>
              <div style="display:flex; gap:5px;">
                <button onclick="updateTrimValue('start')" style="background:#ddd; border:none; padding:4px 8px; font-size:11px; cursor:pointer; border-radius:4px; color:#333;">ç¾åœ¨åœ°ã‚’é–‹å§‹ã¸</button>
<button onclick="updateTrimValue('end')" style="background:#ddd; border:none; padding:4px 8px; font-size:11px; cursor:pointer; border-radius:4px; color:#333;">ç¾åœ¨åœ°ã‚’çµ‚äº†ã¸</button>
              </div>
            </div>
          </div>

          <div style="margin-top:15px; background:#fafafa; padding:15px; border-radius:8px; border:1px solid #ddd;">
            <h4 style="margin-top:0; color:#00796b; display:flex; align-items:center; gap:10px; font-size:14px;">
              4. åˆ†æç”¨ãƒã‚¹ã‚¯ (é»’å¡—ã‚Š)
              <button id="btn-editor-mask" onclick="toggleEditorMaskMode()"
                style="background:#424242; color:white; border:none; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:12px;">
                â¬› ã‚¨ãƒªã‚¢æŒ‡å®š
              </button>
              <button onclick="undoEditorMask()"
                style="background:#9e9e9e; color:white; border:none; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:12px;">
                â†© 1ã¤æ¶ˆã™
              </button>
              <button onclick="clearEditorMasks()"
                style="background:#d32f2f; color:white; border:none; padding:4px 12px; border-radius:20px; cursor:pointer; font-size:12px;">
                ğŸ—‘ï¸ å…¨æ¶ˆå»
              </button>
            </h4>
            <p style="font-size:11px; color:#666; margin:0;">
              ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€éš ã—ãŸã„ç¯„å›²ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„ã€‚ï¼ˆè¤‡æ•°æŒ‡å®šå¯èƒ½ï¼‰
            </p>
          </div>

          <div style="margin-top:20px; text-align:center;">
            <div
              style="position:relative; display:inline-block; border:2px solid #333; background:#000; margin-bottom:10px;">
              <canvas id="editor-canvas"
                style="max-width:100%; max-height:50vh; display:block; cursor:crosshair;"></canvas>
              <video id="editor-source-video" playsinline muted style="display:none;"></video>
            </div>

           <div style="max-width: 640px; margin: 10px auto 15px auto; background: #eee; padding: 10px; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <span id="current-time-display" style="font-family: monospace; font-size: 14px; width: 50px; color:#333;">0.00</span>
                    <input type="range" id="editor-seekbar" value="0" step="0.01" style="flex: 1; cursor: pointer;">
                    <span id="total-time-display" style="font-family: monospace; font-size: 14px; width: 50px; color:#333;">0.00</span>
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button onclick="stepEditorVideo(-0.1)" style="background:#fff; color:#333; border:1px solid #ccc; padding:4px 8px; border-radius:4px; font-size:12px;">-0.1s</button>
                    <button onclick="previewEditorVideo()" style="background:#0288d1; color:white; padding:8px 20px; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">â–¶ å†ç”Ÿ</button>
                    <button onclick="stopEditorPreview()" style="background:#fbc02d; color:#333; padding:8px 20px; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">â¸ åœæ­¢</button>
                    <button onclick="stepEditorVideo(0.1)" style="background:#fff; color:#333; border:1px solid #ccc; padding:4px 8px; border-radius:4px; font-size:12px;">+0.1s</button>
                </div>
            </div>

            <div style="margin-top:20px; padding-top:15px; border-top:2px dashed #ccc;">
              <button id="btn-editor-export" onclick="startEditorExport()"
                style="background:#d32f2f; color:white; padding:12px 30px; border:none; border-radius:30px; font-size:15px; font-weight:bold; cursor:pointer; box-shadow:0 3px 5px rgba(0,0,0,0.2);">
                ğŸ¬ å‹•ç”»ã‚’ä½œæˆãƒ»ä¿å­˜
              </button>
              <p id="editor-status"
                style="margin-top:10px; font-size:13px; color:#e65100; font-weight:bold; min-height: 20px;"></p>
            </div>
          </div>
          <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">

          <div
            style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2;">
            <h4 style="margin-top:0; color:#e65100; display:flex; align-items:center; gap:10px;">
              ğŸ–¼ï¸ YouTubeã‚µãƒ ãƒã‚¤ãƒ«ä½œæˆ
            </h4>
            <p style="font-size:12px; color:#555;">
              æ–‡å­—ã‚’è¿½åŠ ã—ã¦ã‚‚ç”»é¢ãŒä¼¸ã³ã™ããªã„ã‚ˆã†ã€è¨­å®šã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¼ã«ã—ã¾ã—ãŸã€‚<br>
              ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¿½å¾“ã—ã¾ã™ã€‚
            </p>

            <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:15px; align-items: flex-start;">

              <div style="flex:1; min-width:300px;">

                <button onclick="captureCurrentFrame()"
                  style="background:#00897b; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer; width:100%; margin-bottom:15px; font-weight:bold;">
                  ğŸ“¸ 1. ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã‚’å–ã‚Šè¾¼ã‚€
                </button>

                <div style="display:flex; gap:10px; margin-bottom:10px;">
                  <button onclick="addTextLayer('main')"
                    style="flex:1; background:#d84315; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; font-size:12px;">
                    â• ãƒ¡ã‚¤ãƒ³æ–‡å­—
                  </button>
                  <button onclick="addTextLayer('sub')"
                    style="flex:1; background:#1565c0; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer; font-size:12px;">
                    â• ã‚µãƒ–æ–‡å­—
                  </button>
                </div>

                <div id="text-layers-scroll-area" style="
              max-height: 400px; 
              overflow-y: auto; 
              border: 1px solid #ccc; 
              background: #fafafa;
              padding: 10px; 
              border-radius: 6px; 
              margin-bottom: 15px;
              box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
          ">
                  <div id="text-layers-container"></div>
                  <p id="empty-msg" style="text-align:center; color:#999; font-size:12px; margin-top:20px;">
                    æ–‡å­—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œâ•ãƒœã‚¿ãƒ³ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                  </p>
                </div>

                <div
                  style="margin-bottom:15px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ccc;">
                  <label style="font-size:12px; font-weight:bold;">å…¨ä½“ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ:</label><br>
                  <div
                    style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:5px; border-bottom:1px dashed #eee; padding-bottom:8px;">
                    <label style="font-size:11px;"><input type="checkbox" id="eff-vivid" onchange="updateThumbnail()">
                      ğŸ¨ é®®ã‚„ã‹</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-gray" onchange="updateThumbnail()"> âš«
                      ç™½é»’</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-sepia" onchange="updateThumbnail()">
                      ğŸï¸ ã‚»ãƒ”ã‚¢</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-blur" onchange="updateThumbnail()">
                      ğŸŒ«ï¸ ã¼ã‹ã—</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-dim" onchange="updateThumbnail()"> ğŸŒ‘
                      æš—ã</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-glitch" onchange="updateThumbnail()">
                      ğŸ“º è‰²ã‚ºãƒ¬</label>
                  </div>

                  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                    <label style="font-size:11px;"><input type="checkbox" id="eff-line" onchange="updateThumbnail()"> ğŸ’¥
                      é›†ä¸­ç·š (æ”¾å°„)</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-speed" onchange="updateThumbnail()">
                      ğŸ’¨ ã‚¹ãƒ”ãƒ¼ãƒ‰ç·š (æ¨ª)</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-scan" onchange="updateThumbnail()"> ğŸ“º
                      ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-vignette"
                        onchange="updateThumbnail()"> ğŸ”³ éš…ã‚’æš—ã</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-vs" onchange="updateThumbnail()"> âš”ï¸
                      VSãƒ¢ãƒ¼ãƒ‰</label>
                    <label style="font-size:11px;"><input type="checkbox" id="eff-border" onchange="updateThumbnail()">
                      ğŸ”² èµ¤æ </label>
                  </div>
                </div>

                <button onclick="downloadThumbnail()"
                  style="background:#e65100; color:white; border:none; padding:12px 15px; border-radius:30px; cursor:pointer; width:100%; font-weight:bold; box-shadow:0 3px 5px rgba(0,0,0,0.2);">
                  ğŸ“¥ ç”»åƒã‚’ä¿å­˜ (.jpg)
                </button>
              </div>

              <div style="
            flex:1; 
            min-width:300px; 
            text-align:center;
            position: sticky; /* â˜…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¿½å¾“ */
            top: 20px;        /* â˜…ç”»é¢ä¸Šéƒ¨ã‹ã‚‰20pxã®ä½ç½®ã§å›ºå®š */
            z-index: 10;
        ">
                <div
                  style="border:2px solid #333; background:#000; line-height:0; display:inline-block; max-width:100%;">
                  <canvas id="thumbnail-canvas" width="1280" height="720"
                    style="width:100%; max-width:480px; height:auto;"></canvas>
                </div>
                <p
                  style="font-size:11px; color:#999; margin-top:5px; background:rgba(255,255,255,0.8); display:inline-block; padding:2px 5px; border-radius:4px;">
                  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™)
                </p>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <hr style="margin: 40px 0; border: 0; border-top: 2px dashed #ccc;">

    <div id="photo-collage-area" style="
    margin-top: 30px;
    padding: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #e8eaf6; padding: 15px 20px; border-bottom: 1px solid #c5cae9;">
        <h2 style="color: #3f51b5; margin: 0; font-size: 20px; display:flex; align-items:center; gap:10px;">
          ğŸ§© ãƒ•ã‚©ãƒˆã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥ä½œæˆ
        </h2>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          è¤‡æ•°æšã®å†™çœŸã‚’é¸æŠã—ã€1æšã®ç”»åƒã«ãã‚Œã„ã«ã¾ã¨ã‚ã¾ã™ã€‚
        </p>
      </div>

      <div style="padding: 20px;">

        <div
          style="margin-bottom: 15px; padding: 15px; background: #fafafa; border-radius: 8px; border: 1px solid #ddd;">
          <label style="font-weight:bold; display:block; margin-bottom:5px; color:#333;">1. å†™çœŸã‚’é¸æŠ (è¤‡æ•°å¯)</label>
          <input type="file" id="collage-input" accept="image/*" multiple onchange="loadCollageImages(this)"
            style="width:100%;">
        </div>

        <div id="collage-controls"
          style="display:none; margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
          <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:center;">

            <div>
              <span style="font-size:12px; font-weight:bold;">ãƒ‡ã‚¶ã‚¤ãƒ³:</span>
              <select id="collage-layout-mode" onchange="updateCollage()" style="padding:4px;">

                <optgroup label="ğŸ“ æšæ•°åˆ¥ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (Layout)">
                  <option value="grid">â–¦ è‡ªå‹•ã‚°ãƒªãƒƒãƒ‰ (Auto Grid)</option>
                  <option value="layout_1_full">ğŸ”² 1æš: å…¨ç”»é¢ (Full)</option>
                  <option value="layout_2_v">â—« 2æš: å·¦å³åˆ†å‰² (Split V)</option>
                  <option value="layout_2_h">æ—¥ 2æš: ä¸Šä¸‹åˆ†å‰² (Split H)</option>
                  <option value="layout_3_t">â•§ 3æš: Tå­—å‹ (T-Layout)</option>
                  <option value="layout_3_inv">â•¤ 3æš: é€†Tå­— (Inverted T)</option>
                  <option value="layout_3_col">||| 3æš: 3åˆ—ç¸¦ (3 Columns)</option>
                </optgroup>

                <optgroup label="ğŸ¨ é›°å›²æ°—ãƒ»è£…é£¾ (Theme)">
                  <option value="winner">ğŸ† å„ªå‹ãƒ»è¡¨å½°å¼ (Winner)</option>
                  <option value="news">ğŸ“¢ ãƒ‹ãƒ¥ãƒ¼ã‚¹é€Ÿå ± (News)</option>
                  <option value="vs">âš”ï¸ VSãƒ»å¯¾æ±º (Versus)</option>
                  <option value="effort">ğŸ”¥ åŠªåŠ›ãƒ»ç†±è¡€ (Passion)</option>
                  <option value="practice">ğŸ« ç·´ç¿’ãƒ»é»’æ¿ (Chalkboard)</option>
                  <option value="crown">ğŸ‘‘ ç‹å† ãƒ»ã‚´ãƒ¼ã‚¸ãƒ£ã‚¹ (Royal)</option>

                  <option value="feminine">ğŸŒ¸ ãƒ•ã‚§ãƒŸãƒ‹ãƒ³ãƒ»èŠ±æŸ„ (Floral)</option>
                  <option value="cute">ğŸ€ ã‹ã‚ã„ã„ãƒ»ãƒãƒƒãƒ— (Pop)</option>
                  <option value="impact">âš¡ åŠ›å¼·ã„ãƒ»ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ (Impact)</option>
                  <option value="cool">ğŸ˜ ã‹ã£ã“ã„ã„ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆ (Street)</option>
                  <option value="sparkle">âœ¨ è¯ã‚„ã‹ãƒ»ã‚­ãƒ©ã‚­ãƒ© (Sparkle)</option>
                  <option value="magazine">ğŸ“° é›‘èªŒã®è¡¨ç´™é¢¨ (Magazine)</option>
                  <option value="film">ğŸ¬ æ˜ ç”»ãƒ•ã‚£ãƒ«ãƒ é¢¨ (Film)</option>
                  <option value="polaroid">ğŸ“· ãƒãƒ©ãƒ­ã‚¤ãƒ‰é¢¨ (Scatter)</option>
                  <option value="wanted">ğŸ¤  æ‰‹é…æ›¸ (Wanted)</option>
                  <option value="gallery">ğŸ–¼ï¸ ç¾è¡“é¤¨ãƒ»é¡ç¸ (Gallery)</option>
                  <option value="cyber">ğŸ‘¾ ã‚µã‚¤ãƒãƒ¼ãƒ»åˆ†æ (Cyber)</option>
                  <option value="manga">ğŸ“– æ¼«ç”»ãƒ»ã‚³ãƒŸãƒƒã‚¯ (Manga)</option>
                  <option value="retro">ğŸï¸ ãƒ¬ãƒˆãƒ­ãƒ»æ€ã„å‡º (Retro)</option>
                  <option value="scrap">ğŸ““ ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ãƒ–ãƒƒã‚¯ (Scrap)</option>
                  <option value="minimal">â¬œ ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ãƒŸãƒ‹ãƒãƒ« (Minimal)</option>
                  <option value="nature">ğŸŒ¿ ãƒã‚¤ãƒãƒ£ãƒ¼ãƒ»åˆå®¿ (Nature)</option>
                </optgroup>

              </select>
            </div>

            <div>
              <span style="font-size:12px; font-weight:bold;">ä½™ç™½(px):</span>
              <input type="range" id="collage-gap" min="0" max="50" value="10" oninput="updateCollage()">
            </div>

            <div>
              <span style="font-size:12px; font-weight:bold;">èƒŒæ™¯è‰²:</span>
              <input type="color" id="collage-bg-color" value="#ffffff" oninput="updateCollage()">
            </div>

            <div>
              <span style="font-size:12px; font-weight:bold;">æ¯”ç‡:</span>
              <select id="collage-aspect" onchange="updateCollage()" style="padding:4px;">
                <option value="16:9">16:9 (YouTube)</option>
                <option value="4:3">4:3 (Photo)</option>
                <option value="1:1">1:1 (Square)</option>
                <option value="9:16">9:16 (Story)</option>
                <option value="auto">è‡ªå‹• (Auto)</option>
              </select>
            </div>

          </div>
        </div>

        <div style="text-align:center; background:#333; padding:10px; border-radius:4px; overflow:auto;">
          <p id="collage-placeholder" style="color:#999; font-size:12px;">å†™çœŸã‚’é¸æŠã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          <p style="font-size:11px; color:#555; margin-top:5px;">
            ğŸ‘† <strong>æ“ä½œæ–¹æ³•:</strong> å†™çœŸã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠï¼ˆèµ¤æ ï¼‰â†’ åˆ¥ã®å†™çœŸã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨<strong>å ´æ‰€ãŒå…¥ã‚Œæ›¿ã‚ã‚Šã¾ã™</strong>
            <canvas id="collage-canvas" style="max-width:100%; height:auto; display:none;"></canvas>
        </div>

        <div style="margin-top: 20px; text-align: center;">
          <button onclick="downloadCollage()" id="btn-download-collage" disabled style="
        background: #ccc; color: white; border: none; 
        padding: 12px 30px; border-radius: 30px; font-size: 16px; font-weight: bold; 
        cursor: not-allowed; box-shadow: none; transition: all 0.3s;
      ">
            ğŸ’¾ ç”»åƒã‚’ä¿å­˜ (.png)
          </button>
        </div>

      </div>
    </div>
  </section>


  <section id="screen-analysis" class="screen-content">
    <section id="pose-estimation-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #e1f5fe; padding: 15px 20px; border-bottom: 1px solid #b3e5fc;">
        <h3 style="margin:0; color:#01579b; display:flex; align-items:center; gap:8px; font-size: 20px;">
          AIãƒ•ã‚©ãƒ¼ãƒ è§£æ
        </h3>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          ã‚«ãƒ¡ãƒ©ã‚„å‹•ç”»ã‹ã‚‰éª¨æ ¼ã‚’æ¤œå‡ºã—ã€å…¨èº«ï¼ˆè‚©ãƒ»è‚˜ãƒ»è…°ãƒ»è†ï¼‰ã®è² è·ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚<br>
          â€»å‡¦ç†ãŒé‡ããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚éŒ²ç”»ãƒœã‚¿ãƒ³ã§è§£æçµæœã‚’ä¿å­˜å¯èƒ½ã§ã™ã€‚
        </p>
      </div>

      <div style="padding: 20px;">
        <div
          style="margin-bottom: 10px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <span style="font-size:12px; font-weight:bold; color:#555;">è¨­å®šä¿å­˜:</span>
          <button onclick="savePoseParams()"
            style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
          <button onclick="loadPoseParams()"
            style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
          <button onclick="clearPoseParams()"
            style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
          <span id="pose-local-status" style="font-size:12px; color:#e65100;"></span>
        </div>
        <div
          style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border: 1px solid #ddd;">
          <span style="font-weight: bold; font-size: 12px; color: #555;">âš™ï¸ èº«ä½“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š:</span>
          <label style="font-size: 13px;">èº«é•·(cm): <input type="number" id="bio-height" value="170"
              style="width:50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></label>
          <label style="font-size: 13px;">ä½“é‡(kg): <input type="number" id="bio-weight" value="65"
              style="width:50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></label>
          <label style="font-size: 13px;">ãƒ©ã‚±ãƒƒãƒˆ(g): <input type="number" id="bio-racket" value="85"
              style="width:50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;"></label>
        </div>

        <div
          style="margin-bottom: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; border: 1px solid #90caf9;">
          <span style="font-weight: bold; font-size: 13px; color: #0277bd;">ğŸ‘ï¸ è¡¨ç¤ºè¨­å®š:</span>

          <label style="cursor: pointer; font-size: 13px; font-weight: bold; color: #0277bd;">
            <input type="checkbox" id="polygon-toggle" checked> ğŸ’  éª¨æ ¼
          </label>

          <span style="border-left: 1px solid #999; height: 20px;"></span>

          <label style="cursor: pointer; font-size: 13px; font-weight: bold; color: #333;">
            <input type="checkbox" id="bg-toggle" checked onchange="toggleBackground()"> ğŸ–¼ï¸ èƒŒæ™¯
          </label>

          <label style="cursor: pointer; font-size: 13px; font-weight: bold; color: #555;">
            <input type="checkbox" id="dim-toggle"> ğŸŒ‘ æš—ãã™ã‚‹
          </label>

          <span style="border-left: 1px solid #999; height: 20px;"></span>

          <label style="cursor: pointer; font-size: 13px; font-weight: bold; color: #e91e63;">
            <input type="checkbox" id="strobe-toggle"> ğŸï¸ ç”»åƒæ®‹åƒ
          </label>

          <div style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
            <span>é–“éš”:å¯†</span>
            <input type="range" id="strobe-interval" min="5" max="60" value="15" step="5" style="width: 60px;">
            <span>ç–</span>
          </div>

          <div style="display: flex; align-items: center; gap: 5px; font-size: 12px; margin-left: 5px;">
            <span>æšæ•°:å°‘</span>
            <input type="range" id="strobe-count" min="10" max="100" value="50" step="10" style="width: 60px;">
            <span>å¤š</span>
          </div>

          <button onclick="clearStrobeData()"
            style="font-size: 12px; padding: 3px 8px; background: #e91e63; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ğŸ—‘ï¸ æ¶ˆå»
          </button>
        </div>

        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
          <button onclick="startCamera()"
            style="background:#0288d1; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
            ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹• (å¤–å´/å†…å´)
          </button>

          <button onclick="toggleCamera()"
            style="background:#00bcd4; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; margin-left:10px;">
            ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
          </button>

          <label
            style="background:#009688; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; display:inline-block;">
            ğŸ“ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
            <input type="file" id="video-upload" accept="video/*" style="display:none;"
              onchange="handleVideoUpload(this)">
          </label>

          <div id="pose-video-controls" style="display:none; gap:5px;">
            <button onclick="poseVideoPlay()"
              style="background:#0277bd; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â–¶
              å†ç”Ÿ</button>
            <button onclick="poseVideoPause()"
              style="background:#f9a825; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â¸
              ä¸€æ™‚åœæ­¢</button>
            <button onclick="poseVideoReset()"
              style="background:#546e7a; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â®
              æœ€åˆã¸</button>
          </div>

          <button id="btn-record-start" onclick="startRecording()"
            style="background:#e91e63; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; display:none;">
            â— è§£æçµæœã‚’éŒ²ç”»
          </button>
          <button id="btn-record-stop" onclick="stopRecording()"
            style="background:#880e4f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; display:none;">
            â–  éŒ²ç”»åœæ­¢ï¼†ä¿å­˜
          </button>

          <button onclick="downloadPoseCSV()" id="btn-pose-csv" disabled
            style="background:#ccc; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:not-allowed;">
            ğŸ“¥ CSVä¿å­˜
          </button>
          <button onclick="stopTracking()"
            style="background:#d32f2f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
            â¹ å…¨åœæ­¢
          </button>
        </div>

        <div style="position: relative; margin: 20px auto; max-width: 640px;">
          <video id="input_video" style="display: none;" playsinline muted></video>
          <canvas id="output_canvas" width="640" height="480"
            style="width: 100%; height: auto; background: #000; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
          </canvas>
          <div id="pose-data-overlay"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
        </div>
        <div style="position: absolute; top: -9999px; left: -9999px; visibility: visible;">
          <video id="hidden-source-video" playsinline muted autoplay></video>
          <canvas id="studio-mixing-canvas"></canvas>
        </div>

        <div
          style="width: 100%; max-width: 640px; margin: 10px auto; background: #222; border-radius: 8px; padding: 10px; box-sizing: border-box;">
          <div style="font-size:12px; color:#ddd; margin-bottom:5px;">ğŸ“Š è² è·æ¨ç§» (Torque Timeline - L/R)</div>

          <div style="margin-bottom:10px; border-left: 3px solid #4fc3f7; padding-left: 5px;">
            <div style="font-size:10px; color:#aaa;">Right Side (å³)</div>
            <div style="margin-bottom:2px; font-size:11px; color:#4fc3f7;">ğŸ’ª å³è‚˜ (R-Elbow)</div>
            <canvas id="graph_r_elbow" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>

            <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#ff8a65;">ğŸ’ª å³è‚© (R-Shoulder)</div>
            <canvas id="graph_r_shoulder" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>

            <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#66bb6a;">ğŸ¦µ å³è† (R-Knee)</div>
            <canvas id="graph_r_knee" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
          </div>

          <div style="margin-bottom:10px; border-left: 3px solid #ff4081; padding-left: 5px;">
            <div style="font-size:10px; color:#aaa;">Left Side (å·¦)</div>
            <div style="margin-bottom:2px; font-size:11px; color:#80d8ff;">ğŸ’ª å·¦è‚˜ (L-Elbow)</div>
            <canvas id="graph_l_elbow" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>

            <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#ffcc80;">ğŸ’ª å·¦è‚© (L-Shoulder)</div>
            <canvas id="graph_l_shoulder" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>

            <div style="margin-bottom:2px; margin-top:2px; font-size:11px; color:#a5d6a7;">ğŸ¦µ å·¦è† (L-Knee)</div>
            <canvas id="graph_l_knee" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
          </div>

          <div style="margin-bottom:5px; border-left: 3px solid #fdd835; padding-left: 5px;">
            <div style="font-size:11px; color:#fdd835; margin-bottom:2px;">ğŸ§ ä½“å¹¹ (Trunk)</div>
            <canvas id="graph_trunk" width="600" height="50"
              style="width:100%; height:50px; background:#000; display:block; border-bottom:1px solid #333;"></canvas>
          </div>
        </div>
    </section>

    <section id="footwork-analysis-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #e8f5e9; padding: 15px 20px; border-bottom: 1px solid #c8e6c9;">
        <h3 style="margin:0; color:#2e7d32; display:flex; align-items:center; gap:8px; font-size: 20px;">
          ã‚²ãƒ¼ãƒ åˆ†æï¼ˆç§»å‹•é€Ÿåº¦ã€ç§»å‹•è·é›¢ã€è² è·é‡ï¼‰
        </h3>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          ç§»å‹•è»Œè·¡ã€ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã€é€Ÿåº¦ã€è·é›¢ã€è² è·é‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è§£æã—ã¾ã™ã€‚<br>
        </p>
      </div>

      <div style="padding: 20px;">
        <div
          style="margin-bottom: 10px; padding: 10px; background: #fff; border: none; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <span style="font-size:12px; font-weight:bold; color:#555;">è¨­å®šä¿å­˜:</span>
          <button onclick="saveFwParams()"
            style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ä¿å­˜ã™ã‚‹</button>
          <button onclick="loadFwParams()"
            style="background:#fb8c00; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å¾©å…ƒã™ã‚‹</button>
          <button onclick="clearFwParams()"
            style="background:#bdbdbd; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">å‰Šé™¤</button>
          <span id="fw-local-status" style="font-size:12px; color:#e65100;"></span>
        </div>
        <div
          style="margin-bottom: 10px; background: #fff3e0; padding: 10px 15px; border-radius: 6px; border: 1px solid #ffe0b2; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
          <span style="font-weight:bold; font-size:13px; color:#e65100;">ğŸ‘¤ é¸æ‰‹è¨­å®š:</span>
          <label style="font-size:13px;">èº«é•·: <input type="number" id="fw-player-height" value="170"
              style="width:50px; padding:4px; border:1px solid #ccc; border-radius:4px;"> cm</label>
          <label style="font-size:13px;">ä½“é‡: <input type="number" id="fw-player-weight" value="65"
              style="width:50px; padding:4px; border:1px solid #ccc; border-radius:4px;"> kg</label>
          <label style="font-size:13px;">ãƒ©ã‚±ãƒƒãƒˆ: <input type="number" id="fw-player-racket" value="85"
              style="width:50px; padding:4px; border:1px solid #ccc; border-radius:4px;"> g</label>
        </div>
        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
          <div style="margin-bottom: 15px;">
            <button onclick="toggleFwInstructions()"
              style="
        background: #0288d1; color: white; border: none; padding: 8px 16px; 
        border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
              â„¹ï¸ åˆ†æãƒ»ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ³¨æ„ç‚¹
            </button>

            <div id="fw-instructions"
              style="display: none; margin-top: 10px; background: #e1f5fe; padding: 15px; border-radius: 8px; border: 1px solid #b3e5fc; color: #01579b;">
              <h4 style="margin: 0 0 10px 0; border-bottom: 1px solid #81d4fa; padding-bottom: 5px;">ğŸ“¸ æ’®å½±ã¨è¨­å®šã®ãƒã‚¤ãƒ³ãƒˆ</h4>

              <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.6;">
                <li><strong>æ’®å½±ä½ç½®:</strong> ã‚³ãƒ¼ãƒˆå¾Œæ–¹ã‹ã‚‰ã€ã‚³ãƒ¼ãƒˆå…¨ä½“ãŒå…¥ã‚‹ã‚ˆã†ã«å›ºå®šæ’®å½±ã—ã¦ãã ã•ã„ã€‚</li>
                <li><strong>åˆ†æå¯¾è±¡:</strong> ã€Œã‚³ãƒ¼ãƒˆæ‰‹å‰ã€ã«ã„ã‚‹é¸æ‰‹ã‚’åˆ†æã—ã¾ã™ã€‚</li>
                <li><strong>ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (4ç‚¹æŒ‡å®š):</strong><br>
                  ä»¥ä¸‹ã®é †åºã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<br>
                  <span style="color: #d32f2f; font-weight: bold;">â‘  ãƒãƒƒãƒˆæ”¯æŸ±ï¼ˆå·¦ï¼‰ã®æ ¹æœ¬</span><br>
                  <span style="color: #d32f2f; font-weight: bold;">â‘¡ ãƒãƒƒãƒˆæ”¯æŸ±ï¼ˆå³ï¼‰ã®æ ¹æœ¬</span><br>
                  <span style="color: #d32f2f; font-weight: bold;">â‘¢ ãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³ã¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®äº¤ç‚¹ï¼ˆå³ï¼‰</span><br>
                  <span style="color: #d32f2f; font-weight: bold;">â‘£ ãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³ã¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®äº¤ç‚¹ï¼ˆå·¦ï¼‰</span>
                </li>
              </ul>

              <div
                style="margin-top: 15px; width: 100%; max-width: 250px; height: 180px; background: #2e7d32; border: 2px solid white; position: relative; margin-left: auto; margin-right: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                <div
                  style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #ddd; border-bottom: 1px dashed #999;">
                </div>
                <div
                  style="position: absolute; top: -15px; width: 100%; text-align: center; color: white; font-size: 10px;">
                  (ãƒãƒƒãƒˆå´)</div>

                <div
                  style="position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                  1</div>

                <div
                  style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                  2</div>

                <div
                  style="position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                  3</div>

                <div
                  style="position: absolute; bottom: -5px; left: -5px; width: 20px; height: 20px; background: red; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-weight: bold; font-size: 12px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                  4</div>

                <svg style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
                  <line x1="10" y1="10" x2="240" y2="10" style="stroke:rgba(255,255,0,0.7);stroke-width:2" />
                  <line x1="240" y1="10" x2="240" y2="170" style="stroke:rgba(255,255,0,0.7);stroke-width:2" />
                  <line x1="240" y1="170" x2="10" y2="170" style="stroke:rgba(255,255,0,0.7);stroke-width:2" />
                </svg>

                <div
                  style="position: absolute; bottom: 10px; width: 100%; text-align: center; color: white; font-size: 10px;">
                  (æ‰‹å‰ãƒ»ã‚«ãƒ¡ãƒ©å´)</div>
              </div>
            </div>
          </div>
          <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <button onclick="fwStartCamera()"
              style="background:#2e7d32; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹• (å¤–å´/å†…å´)
            </button>
            <button onclick="fwToggleCamera()"
              style="background:#00bcd4; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
            </button>
            <label
              style="background:#00897b; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; display:inline-block;">
              ğŸ“ å‹•ç”»èª­è¾¼
              <input type="file" accept="video/*" style="display:none;" onchange="fwHandleVideoUpload(this)">
            </label>

            <div id="fw-video-controls" style="display:none; gap:5px;">
              <button onclick="fwVideoPlay()"
                style="background:#0277bd; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â–¶
                å†ç”Ÿ</button>
              <button onclick="fwVideoPause()"
                style="background:#f9a825; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â¸
                ä¸€æ™‚åœæ­¢</button>
              <button onclick="fwVideoReset()"
                style="background:#546e7a; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">â®
                æœ€åˆã¸</button>
            </div>

            <button onclick="fwStopAnalysis()"
              style="background:#d32f2f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              â¹ çµ‚äº†
            </button>

            <button id="btn-fw-record-start" onclick="fwStartRecording()"
              style="background:#e91e63; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              â— éŒ²ç”»ï¼†è¨ˆæ¸¬é–‹å§‹
            </button>
            <button id="btn-fw-record-stop" onclick="fwStopRecording()"
              style="background:#880e4f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; display:none;">
              â–  åœæ­¢ï¼†ä¿å­˜ (å‹•ç”»/ãƒ‡ãƒ¼ã‚¿)
            </button>

            <button onclick="fwDownloadCSV()" id="btn-fw-download-csv" disabled
              style="background:#ccc; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:not-allowed;">
              ğŸ“¥ CSVä¿å­˜
            </button>
            <button onclick="fwGeneratePDFReport()" id="btn-fw-report"
              style="background:#1565c0; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆ
            </button>

            <button id="btn-fw-area" onclick="toggleFwAreaSelectMode()"
              style="background:#ff9800; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">
              ğŸ“ åˆ†æã‚¨ãƒªã‚¢æŒ‡å®š
            </button>

            <button onclick="fwToggleCalibration()" id="btn-fw-calib"
              style="background:#ff9800; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              ğŸ“ è·é›¢æ ¡æ­£
            </button>

            <button onclick="fwResetData()"
              style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
              ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ
            </button>
            <label
              style="background:#fff3e0; padding:10px 15px; border-radius:4px; border:1px solid #ffe0b2; display:flex; align-items:center; gap:5px; margin-left:10px; cursor:pointer;">
              <input type="checkbox" id="fw-rally-mode">
              <span style="font-weight:bold; font-size:13px; color:#e65100;">ğŸŸ¢ ãƒ©ãƒªãƒ¼ä¸­ã®ã¿è¨˜éŒ² (Spaceã‚­ãƒ¼)</span>
            </label>
            <label
              style="font-size:13px; display:flex; align-items:center; gap:5px; background:#f1f8e9; padding:5px 10px; border-radius:4px;">
              <input type="checkbox" id="fw-show-heatmap" checked> ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
            </label>
            <label
              style="font-size:13px; display:flex; align-items:center; gap:5px; background:#f1f8e9; padding:5px 10px; border-radius:4px;">
              <input type="checkbox" id="fw-show-trajectory" checked> è»Œè·¡
            </label>
          </div>

          <div style="max-width: 640px; margin: 0 auto;">

            <div id="fw-area-msg"
              style="display:none; color:#d32f2f; font-weight:bold; font-size:12px; margin-bottom:5px;">
              â€» ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€åˆ†æã—ãŸã„ç¯„å›²ï¼ˆæ‰‹å‰ã‚³ãƒ¼ãƒˆãªã©ï¼‰ã‚’å›²ã£ã¦ãã ã•ã„ã€‚
            </div>
            <div id="fw-calib-guide"
              style="display:none; background:#fff3e0; padding:15px; border:1px solid #ffe0b2; margin-bottom:10px; border-radius:6px; font-size:14px;">
              <strong style="color:#e65100;">ã€è¨­å®šæ‰‹é †ã€‘</strong><br>
              1. å®Ÿéš›ã®è·é›¢(m)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
              <div style="margin: 10px 0; display:flex; gap:15px;">
                <label>æ¨ªå¹…(m): <input type="number" id="fw-real-width" value="6.1"
                    style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
                <label>ç¸¦å¹…(m): <input type="number" id="fw-real-height" value="6.7"
                    style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;"></label>
              </div>
              <span style="font-size:12px; color:#666;">â€»ãƒ€ãƒ–ãƒ«ã‚¹ç‰‡é¢ãªã‚‰ æ¨ª6.1m Ã— ç¸¦6.7m ãŒç›®å®‰ã§ã™ã€‚</span><br><br>

              2. ç”»é¢ä¸Šã®ã‚³ãƒ¼ãƒˆå››éš…ã‚’<span style="color:red; font-weight:bold;">ã€å·¦ä¸Š â†’ å³ä¸Š â†’ å³ä¸‹ â†’ å·¦ä¸‹ã€‘</span>ã®é †ã«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚<br>
              <div id="fw-calib-status" style="margin-top:5px; font-weight:bold; color:#d32f2f;">ç¾åœ¨: 0ç‚¹ç›® / 4ç‚¹</div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
              <div
                style="background:#fafafa; padding:10px; border-radius:6px; border:1px solid #ddd; text-align:center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size:12px; color:#666; font-weight:bold;">ç¾åœ¨ã®é€Ÿåº¦</div>
                <div style="font-size:28px; font-weight:bold; color:#2e7d32; line-height:1.2;">
                  <span id="fw-speed">0.0</span> <span style="font-size:14px; color:#555;">m/s</span>
                </div>
              </div>
              <div
                style="background:#fafafa; padding:10px; border-radius:6px; border:1px solid #ddd; text-align:center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="font-size:12px; color:#666; font-weight:bold;">ç·ç§»å‹•è·é›¢</div>
                <div style="font-size:28px; font-weight:bold; color:#1565c0; line-height:1.2;">
                  <span id="fw-distance">0.0</span> <span style="font-size:14px; color:#555;">m</span>
                </div>
              </div>
            </div>

            <div id="fw_canvas_container"
              style="position: relative; width: 100%; height: auto; background: #000; border-radius: 8px; overflow: hidden; cursor: crosshair; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">

              <video id="fw_video" style="display: none;" playsinline></video>

              <canvas id="fw_canvas" width="640" height="480"
                style="width: 100%; height: auto; display: block;"></canvas>

              <canvas id="fw_overlay" width="640" height="480"
                style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></canvas>
            </div>

            <div
              style="margin-top:10px; padding:12px; background:#fff; border-radius:6px; border:1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <div
                style="font-size:12px; font-weight:bold; color:#555; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:5px;">
                ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è² è· (Joint Torque)
              </div>
              <div style="display:flex; justify-content:space-between; text-align:center;">
                <div style="flex:1; border-right:1px solid #eee;">
                  <div style="font-size:11px; color:#666;">ğŸ¦µ å³è„š (Right)</div>
                  <div id="fw-load-knee-r" style="font-weight:bold; font-size:15px; color:#333;">0% (0Nm)</div>
                </div>
                <div style="flex:1; border-right:1px solid #eee;">
                  <div style="font-size:11px; color:#666;">ğŸ¦µ å·¦è„š (Left)</div>
                  <div id="fw-load-knee-l" style="font-weight:bold; font-size:15px; color:#333;">0% (0Nm)</div>
                </div>
                <div style="flex:1;">
                  <div style="font-size:11px; color:#666;">ğŸ§ ä½“å¹¹ (Trunk)</div>
                  <div id="fw-load-trunk" style="font-weight:bold; font-size:15px; color:#333;">0% (0Nm)</div>
                </div>
              </div>
            </div>
          </div>
    </section>

    <section id="video-comparison-section"
      style="margin-top: 30px; padding: 0; background: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05);">
      <div style="background: #e1f5fe; padding: 15px 20px; border-bottom: 1px solid #b3e5fc;">
        <h3 style="margin:0; color:#01579b; display:flex; align-items:center; gap:8px; font-size: 20px;">
          AIãƒ•ã‚©ãƒ¼ãƒ æ¯”è¼ƒã‚³ãƒ¼ãƒ
        </h3>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          å‹•ç”»Aã¨å‹•ç”»Bã‚’é¸æŠã—ã€ŒAIæ¯”è¼ƒè¨ºæ–­ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
          å‹•ç”»å…¨ä½“ã®å‹•ãï¼ˆç§»å‹•â†’ãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯â†’ã‚¹ã‚¤ãƒ³ã‚°ï¼‰ã‚’è§£æã—ã€æ”¹å–„ç‚¹ã‚’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™ã€‚
        </p>
      </div>

      <div style="padding: 20px;">
        <div
          style="background: #fff9c4; padding: 15px; border-radius: 8px; border: 1px solid #fbc02d; margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; color: #f57f17; font-size: 15px;">ğŸ“¥ è¦‹æœ¬å‹•ç”»ã®æº–å‚™</h4>
          <p style="font-size: 12px; color: #333; margin-bottom: 10px;">
            1. ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚’é–‹ã â¡ 2. å³ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³ã§ä¿å­˜ â¡ 3. ä¸‹ã®ã€Œè¦‹æœ¬ (Video B)ã€ã§é¸æŠ
          </p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">

            <a href="https://drive.google.com/file/d/1t5U0Jxan59WPnkOXI56C-ao77bviXIqv/view?usp=sharing" target="_blank"
              style="text-decoration: none;"><button
                style="background:#fbc02d; color:#333; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">ğŸ“‚
                ç´ æŒ¯ã‚Š1ï¼ˆå‹•ã„ã¦æŒ¯ã‚‹ï¼‰</button></a>
            <a href="https://drive.google.com/file/d/1ST5G4k68hg5UqWvwlGpJgzRWlrQ1-u4r/view?usp=sharing" target="_blank"
              style="text-decoration: none;"><button
                style="background:#fbc02d; color:#333; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">ğŸ“‚
                ç´ æŒ¯ã‚Š2ï¼ˆã‚¹ãƒãƒƒã‚·ãƒ¥ãƒ»ãƒ—ãƒƒã‚·ãƒ¥ï¼‰</button></a>
          </div>
        </div>

        <div
          style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd; text-align: center;">
          <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
            <button onclick="compPlayBoth()"
              style="background:#0288d1; color:white; padding:8px 20px; border-radius:30px; border:none; cursor:pointer;">â–¶
              å†ç”Ÿ</button>
            <button onclick="compPauseBoth()"
              style="background:#d32f2f; color:white; padding:8px 20px; border-radius:30px; border:none; cursor:pointer;">â¸
              åœæ­¢</button>
            <button onclick="compResetBoth()"
              style="background:#757575; color:white; padding:8px 20px; border-radius:30px; border:none; cursor:pointer;">â®
              ãƒªã‚»ãƒƒãƒˆ</button>

            <button onclick="compToggleMirror('video-a')"
              style="background:#5e35b1; color:white; padding:8px 15px; border-radius:30px; border:none; cursor:pointer; font-size:12px;">â—€â–¶
              Aåè»¢</button>
            <button onclick="compToggleMirror('video-b')"
              style="background:#5e35b1; color:white; padding:8px 15px; border-radius:30px; border:none; cursor:pointer; font-size:12px;">â—€â–¶
              Båè»¢</button>
            <button onclick="toggleOverlayMode()" id="btn-overlay-toggle"
              style="background:#673ab7; color:white; padding:8px 20px; border-radius:30px; border:none; cursor:pointer;">
              ğŸ”² é‡ã­åˆã‚ã› (Overlay)
            </button>
          </div>
          <div id="overlay-controls"
            style="display:none; flex-direction:column; gap:5px; margin-bottom:10px; background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #d1c4e9;">

            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
              <span style="font-size:12px; font-weight:bold; color:#5e35b1; width:60px;">é€æ˜åº¦:</span>
              <input type="range" id="overlay-opacity" min="0" max="1" step="0.1" value="0.5" style="width:150px;"
                oninput="updateOverlayOpacity(this.value)">
            </div>

            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
              <span style="font-size:12px; font-weight:bold; color:#5e35b1; width:60px;">æ¨ªä½ç½®:</span>
              <input type="range" id="overlay-pos-x" min="-300" max="300" step="5" value="0" style="width:150px;"
                oninput="updateOverlayPosition()">
            </div>

            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
              <span style="font-size:12px; font-weight:bold; color:#5e35b1; width:60px;">ç¸¦ä½ç½®:</span>
              <input type="range" id="overlay-pos-y" min="-300" max="300" step="5" value="0" style="width:150px;"
                oninput="updateOverlayPosition()">
            </div>

            <div style="text-align:center; margin-top:5px;">
              <button onclick="resetOverlayPosition()"
                style="font-size:11px; padding:3px 10px; background:#b39ddb; color:white; border:none; border-radius:4px; cursor:pointer;">ä½ç½®ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
          <button onclick="runFullAnalysis()"
            style="background:#ff9800; color:white; padding:10px 30px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; font-size:16px; box-shadow: 0 4px 0 #e65100;">
            ğŸ¤– AIæ¯”è¼ƒè¨ºæ–­ã‚’å®Ÿè¡Œ (å…¨ä½“è§£æ)
          </button>
        </div>

        <div id="ai-comparison-result"
          style="display:none; margin-bottom:15px; background:#fff; padding:15px; border:2px solid #0288d1; border-radius:8px;">
          <h4 style="margin:0 0 10px 0; color:#01579b; border-bottom:1px solid #ddd; padding-bottom:5px;">ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h4>
          <div id="ai-advice-text" style="font-size:14px; line-height:1.6; color:#333;"></div>
        </div>

        <div id="comp-video-container"
          style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; position: relative;">
          <div style="flex: 1; min-width: 300px;">
            <div style="font-weight:bold; color:#0277bd; margin-bottom:5px;">ğŸ‘¤ ã‚ãªãŸ (Video A)</div>
            <input type="file" accept="video/*" onchange="compLoadVideo(this, 'video-a')"
              style="width:100%; margin-bottom:5px;">
            <div style="position:relative; padding-top:56.25%; background:#000; border-radius:4px;"><video id="video-a"
                playsinline muted
                style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain;"></video></div>
          </div>
          <div style="flex: 1; min-width: 300px;">
            <div style="font-weight:bold; color:#c2185b; margin-bottom:5px;">ğŸ† è¦‹æœ¬ (Video B)</div>
            <input type="file" accept="video/*" onchange="compLoadVideo(this, 'video-b')"
              style="width:100%; margin-bottom:5px;">
            <div style="position:relative; padding-top:56.25%; background:#000; border-radius:4px;"><video id="video-b"
                playsinline muted
                style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain;"></video></div>
          </div>
        </div>
      </div>
    </section>

    <section id="formation-analysis-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #e0f2f1; padding: 15px 20px; border-bottom: 1px solid #b2dfdb;">
        <h3 style="margin:0; color:#00695c; display:flex; align-items:center; gap:8px; font-size: 20px;">
          ãƒ€ãƒ–ãƒ«ã‚¹é™£å½¢åˆ†æ (Formation Analysis)
        </h3>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          å‹•ç”»ã‹ã‚‰æ‰‹å‰å´ã‚³ãƒ¼ãƒˆã®é¸æ‰‹ã‚’æ¤œå‡ºã—ã€ã‚µã‚¤ãƒ‰ãƒã‚¤ã‚µã‚¤ãƒ‰(å®ˆå‚™)ã¨ãƒˆãƒƒãƒ—ã‚¢ãƒ³ãƒ‰ãƒãƒƒã‚¯(æ”»æ’ƒ)ã®æ¯”ç‡ã‚’åˆ†æã—ã¾ã™ã€‚<br>
          å¥¥å´ã‚³ãƒ¼ãƒˆã®é¸æ‰‹ã‚’èªè­˜ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«åˆ†æã‚¨ãƒªã‚¢ã‚’æŒ‡å®šã—ã¾ã™ã€‚<br>
          â€»å‡¦ç†ãŒé‡ã„ãŸã‚PCã§ã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
        </p>
      </div>

      <div style="padding: 20px;">
        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
          <label
            style="background:#00897b; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; display:inline-block;">
            ğŸ“ ãƒ€ãƒ–ãƒ«ã‚¹å‹•ç”»ã‚’é¸æŠ
            <input type="file" id="formation-video-upload" accept="video/*" style="display:none;"
              onchange="handleFormationVideo(this)">
          </label>

          <button onclick="toggleFormationAnalysis()" id="btn-formation-toggle" disabled
            style="background:#ccc; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:not-allowed;">
            â–¶ åˆ†æé–‹å§‹
          </button>

          <button onclick="toggleAreaSelectMode()" id="btn-formation-area"
            style="background:#ff9800; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
            ğŸ“ åˆ†æã‚¨ãƒªã‚¢æŒ‡å®š
          </button>
          <label
            style="background:#fff3e0; padding:10px 15px; border-radius:4px; border:1px solid #ffe0b2; display:flex; align-items:center; gap:5px; margin-left:10px; cursor:pointer;">
            <input type="checkbox" id="formation-rally-mode">
            <span style="font-weight:bold; font-size:13px; color:#e65100;">ğŸŸ¢ ãƒ©ãƒªãƒ¼ä¸­ã®ã¿é›†è¨ˆ (Spaceã‚­ãƒ¼)</span>
          </label>
          <button onclick="resetFormationData()"
            style="background:#757575; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
            ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>

        <div id="formation-area-msg" style="display:none; color:#d32f2f; font-weight:bold; margin-bottom:10px;">
          â€» ç”»é¢ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€æ‰‹å‰å´ã‚³ãƒ¼ãƒˆã®ç¯„å›²ã‚’å›²ã£ã¦ãã ã•ã„ã€‚
        </div>

        <div
          style="position: relative; width: 100%; max-width: 640px; margin: 0 auto; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
          <video id="formation_video" style="display: none;" playsinline muted></video>
          <canvas id="formation_canvas" width="640" height="360"
            style="width: 100%; height: auto; display: block;"></canvas>
          <div id="formation-loading"
            style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white; background:rgba(0,0,0,0.7); padding:10px 20px; border-radius:8px; display:none;">
            AIãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...
          </div>
        </div>

        <div style="margin-top: 20px; max-width: 640px; margin-left: auto; margin-right: auto;">
          <div
            style="background:#fafafa; padding:20px; border-radius:8px; border:1px solid #ddd; border-top: 4px solid #d32f2f; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <h4 style="margin:0 0 15px 0; color:#d32f2f; text-align:center; font-size: 18px;">
              æ‰‹å‰å´ã‚³ãƒ¼ãƒˆ (Near Side) é™£å½¢åˆ†æ
            </h4>

            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size: 16px;">
              <span>âš”ï¸ æ”»æ’ƒ (Top & Back):</span>
              <span id="near-tb-val" style="font-weight:bold; color:#ef5350;">0%</span>
            </div>
            <div style="background:#e0e0e0; height:15px; border-radius:8px; overflow:hidden; margin-bottom:15px;">
              <div id="near-tb-bar" style="width:0%; height:100%; background:#ef5350; transition: width 0.3s;"></div>
            </div>

            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size: 16px;">
              <span>ğŸ›¡ï¸ å®ˆå‚™ (Side by Side):</span>
              <span id="near-ss-val" style="font-weight:bold; color:#1976d2;">0%</span>
            </div>
            <div style="background:#e0e0e0; height:15px; border-radius:8px; overflow:hidden;">
              <div id="near-ss-bar" style="width:0%; height:100%; background:#1976d2; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>
      </div>

      <p style="font-size:12px; color:#666; margin-top:10px; text-align:center;">
        â€» æ¨ªä¸¦ã³ã¨ç¸¦ä¸¦ã³ã®åˆ¤å®šã¯ã€ãƒšã‚¢é–“ã®è§’åº¦(45åº¦)ã‚’åŸºæº–ã«ã—ã¦ã„ã¾ã™ã€‚
      </p>
      </div>
    </section>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>

    
<section id="jump-analysis-box" style="margin-top: 30px; padding:20px; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin:0; color:#d81b60;">ğŸš€ AIã‚¸ãƒ£ãƒ³ãƒ—åŠ›æ¸¬å®š</h3>
        <button onclick="saveJumpData()" style="background:#ff9800; font-size:12px; padding:5px 10px;">è¨˜éŒ²ä¿å­˜</button>
    </div>

    <div style="background:#fce4ec; padding:15px; border-radius:8px; border:1px solid #f8bbd0; margin-bottom:15px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:15px;">
            <button onclick="startJumpAICamera()" style="background:#e91e63; font-weight:bold;">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
            <button onclick="toggleJumpCamera()" style="background:#00bcd4;">ğŸ”„ åˆ‡æ›¿</button>
<button id="btn-jump-trigger" onclick="prepareJumpMeasurement()" style="background:#ff9800; font-weight:bold; color:white;">â± è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
           <button onclick="resetJumpGround()" style="background:#546e7a;">ğŸ“ åœ°é¢ãƒªã‚»ãƒƒãƒˆ</button>
<button onclick="stopJumpAICamera()" style="background:#424242; font-weight:bold;">â¹ åœæ­¢</button>
        </div>

       <div id="jump-monitor-wrapper" style="position: relative; width: 100%; max-width: 480px; margin: 0 auto 15px auto; background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 3/4; border: 3px solid #f06292; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <canvas id="jump_canvas" style="width: 100%; height: 100%; object-fit: contain;"></canvas>
            <div id="jump-ai-status" style="position: absolute; top: 10px; left: 10px; background: rgba(233, 30, 99, 0.8); color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none;">
                OFFLINE
            </div>
            <div id="ground-line-guide" style="position: absolute; left: 0; width: 100%; height: 2px; border-top: 2px dashed #ffeb3b; display: none; pointer-events: none;"></div>
        </div>
        
        <div style="text-align:center;">
            <div id="jump-timer-display" style="font-size:42px; font-weight:bold; color:#333; font-family:monospace;">0.000 <span style="font-size:18px;">s</span></div>
        </div>
    </div>

    <div id="jump-result-area" style="display:none; animation: fadeIn 0.5s; margin-top:15px;">
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
        <div style="background:#fff; border:2px solid #e91e63; padding:10px; border-radius:8px; text-align:center;">
            <div style="font-size:10px; color:#666;">ä»Šå›ã®è·³èºé«˜</div>
            <div style="font-size:24px; font-weight:bold; color:#e91e63;"><span id="val-jump-height">0.0</span> <small style="font-size:12px;">cm</small></div>
        </div>
        <div style="background:#fff; border:2px solid #3f51b5; padding:10px; border-radius:8px; text-align:center;">
            <div style="font-size:10px; color:#666;">æœ€é«˜åˆ°é”ç‚¹(æ¨å®š)</div>
            <div style="font-size:24px; font-weight:bold; color:#3f51b5;"><span id="val-jump-reach">0.0</span> <small style="font-size:12px;">cm</small></div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
        <div class="jump-res-card">æœ€å¤§å±ˆæ›²è§’åº¦: <span id="max-knee-angle" style="color:#ff9800;">0</span>Â°</div>
        <div class="jump-res-card">æœ€å¤§è†è§’é€Ÿåº¦: <span id="max-knee-av" style="color:#ff9800;">0</span>Â°/s</div>
        <div class="jump-res-card">æœ€å¤§è†ãƒˆãƒ«ã‚¯: <span id="max-knee-t-val" style="color:#ff9800;">0</span> <small>Nm</small></div>
        <div class="jump-res-card">æœ€å¤§è…•é€Ÿåº¦: <span id="max-arm-v" style="color:#4caf50;">0</span></div>
    </div>
    
    <button onclick="downloadJumpCSV()" style="width:100%; height:44px; background:#00897b; color:white; border:none; border-radius:22px; font-weight:bold; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; gap:8px;">
        <span>ğŸ“¥</span> æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ä¿å­˜
    </button>
</div>
        </div>
    </div>
    
    <div id="jump-history" style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
        <h4 style="font-size:13px; color:#666; margin-bottom:8px;">ğŸ“Š æ¸¬å®šå±¥æ­´</h4>
        <div id="jump-history-list" style="max-height:120px; overflow-y:auto; font-size:12px;"></div>
    </div>
</div>
</section>

    <section id="video-tagging-section" style="
  margin-top: 30px; 
  padding: 0; 
  background: #fff; 
  border: 1px solid #ccc; 
  border-radius: 10px; 
  overflow: hidden; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
">
      <div style="background: #fff8e1; padding: 15px 20px; border-bottom: 1px solid #ffecb3;">
        <h3 style="margin:0; color:#ff6f00; display:flex; align-items:center; gap:8px; font-size: 20px;">
          ğŸ·ï¸ å‹•ç”»ã‚¿ã‚®ãƒ³ã‚°ï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆå†ç”Ÿ
        </h3>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          å‹•ç”»ã®é‡è¦ãªã‚·ãƒ¼ãƒ³ã‚’ã‚¿ã‚°ä»˜ã‘ã—ã€ãã®å‰å¾Œæ•°ç§’ã®ã¿ã‚’é€£ç¶šå†ç”Ÿï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã—ã¾ã™ã€‚
        </p>
      </div>

      <div style="padding: 20px;">
        <div
          style="margin-bottom: 15px; padding: 15px; background: #fafafa; border-radius: 8px; border: 1px solid #ddd;">
          <label style="font-weight:bold; display:block; margin-bottom:5px; color:#333;">1. å‹•ç”»ã‚’é¸æŠ</label>
          <input type="file" accept="video/*" onchange="vtLoadVideo(this)" style="width:100%;">
        </div>

        <div id="vt-container" style="display:none;">
          <div
            style="position:relative; width:100%; max-width:640px; margin:0 auto; background:#000; border-radius:8px; overflow:hidden;">
            <video id="vt-video" controls playsinline style="width:100%; height:auto; display:block;"></video>
            <div id="vt-indicator"
              style="display:none; position:absolute; top:10px; right:10px; background:rgba(255,0,0,0.8); color:white; padding:5px 10px; border-radius:4px; font-weight:bold; font-size:12px;">
              â–¶ ãƒã‚¤ãƒ©ã‚¤ãƒˆå†ç”Ÿä¸­
            </div>
          </div>

          <div
            style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; background:#eee; padding:10px; border-radius:8px;">
            <div style="display:flex; align-items:center; gap:5px;">
              <span style="font-size:12px; font-weight:bold;">å‰å¾Œ(ç§’):</span>
              <input type="number" id="vt-buffer" value="3" min="1" max="10"
                style="width:50px; padding:5px; text-align:center;">
            </div>
            <button onclick="vtAddTag()"
              style="background:#ff6f00; color:white; border:none; padding:10px 20px; border-radius:30px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px;">
              ğŸ“Œ ä»Šã®ã‚·ãƒ¼ãƒ³ã‚’ã‚¿ã‚°ä»˜ã‘
            </button>
          </div>

          <div style="margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <h4 style="margin:0; color:#333;">ç™»éŒ²ã•ã‚ŒãŸã‚¿ã‚°ä¸€è¦§</h4>
              <button onclick="vtPlayHighlights()" id="btn-vt-play" disabled
                style="background:#1565c0; color:white; border:none; padding:8px 20px; border-radius:4px; cursor:not-allowed; font-size:14px;">
                â–¶ ãƒã‚¤ãƒ©ã‚¤ãƒˆé€£ç¶šå†ç”Ÿ
              </button>
            </div>

            <div id="vt-tag-list"
              style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:4px; background:#fafafa;">
              <p style="padding:15px; text-align:center; color:#999; font-size:12px;">
                ã¾ã ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å†ç”Ÿä½ç½®ã‚’åˆã‚ã›ã¦ã€Œã‚¿ã‚°ä»˜ã‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
              <button onclick="vtSaveHighlightsToLibrary()" id="btn-vt-save" disabled
                style="background:#00897b; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:not-allowed; font-size:12px; display:flex; align-items:center; gap:5px;">
                ğŸ’¾ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ (çµåˆ)
              </button>

              <button onclick="vtClearTags()"
                style="font-size:11px; color:#d32f2f; background:none; border:none; cursor:pointer; text-decoration:underline;">å…¨ã‚¿ã‚°æ¶ˆå»</button>
            </div>

            <p id="vt-save-status"
              style="font-size:12px; color:#e65100; font-weight:bold; margin-top:5px; height:20px;"></p>
          </div>
        </div>
      </div>
    </section>
</section>
    <section id="screen-library" class="screen-content">
      <div style="background: #e8eaf6; padding: 15px 20px; border-bottom: 1px solid #c5cae9;">
        <h2 style="color: #3f51b5; margin: 0; font-size: 22px;">
          ğŸ“š å‹•ç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (ç«¯æœ«å†…ä¿å­˜)
        </h2>
        <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
          éŒ²ç”»ã—ãŸå‹•ç”»ã¯ã“ã“ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãŒãªãã¦ã‚‚å†ç”Ÿå¯èƒ½ã§ã™ã€‚<br>
          â€»ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã‚‹ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚
        </p>
      </div>

      <div style="padding: 20px;">
        <div style="text-align:right; font-size:12px; color:#666; margin-bottom:10px;">
          <span style="margin-right: 15px;">ğŸ’¾ ä½¿ç”¨é‡: <span id="storage-usage">è¨ˆç®—ä¸­...</span></span>
          ä¿å­˜ä»¶æ•°: <span id="db-count">0</span> ä»¶
        </div>

        <div id="library-list"
          style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
          <p style="padding:20px; color:#999;">èª­ã¿è¾¼ã¿ä¸­ã€ã¾ãŸã¯ä¿å­˜ã•ã‚ŒãŸå‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
      </div>
    </section>
    <section id="screen-course" class="screen-content">
      <div id="auth-container" class="mb-4 p-4 bg-white border border-gray-200 rounded-lg shadow-inner">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">è¬›ç¿’ä¼šç”¨ãƒ­ã‚°ã‚¤ãƒ³</h3>
        <p class="text-sm text-gray-500 mb-3">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</p>
        <div class="flex items-center space-x-2">
          <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
            class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <button
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300"
            onclick="loginWithPassword()">
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
        <p id="login-status" class="mt-2 text-sm h-5"></p>
      </div>

      <button id="logout-button" class="mt-4 text-sm text-gray-500 hover:text-red-500 transition duration-300 ml-4"
        style="display:none;" onclick="logout()">
        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>

      <section id="share-section"
        style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 6px; display: none;">
        <h3 style="color: #00796b; margin-top: 0;">ğŸ“¤ å—è¬›ç”Ÿã¸ã®è³‡æ–™å…±æœ‰ / Share Materials</h3>

        <p style="font-size: 13px; color: #666;">
          äº‹å‰ã«ä½œæˆã—ãŸQRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’é¸æŠã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
          Select and display a pre-made QR code image.
        </p>

        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">

          <label style="font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px;">â‘  QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’é¸æŠ
            (å¿…é ˆ):</label>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
            <input type="file" id="qr-image-file" accept="image/*" style="font-size: 14px;">
          </div>

          <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; color: #555;">â‘¡ ãƒªãƒ³ã‚¯å…ˆURL
            (ä»»æ„ / Optional):</label>
          <p style="font-size: 11px; color: #999; margin: 0 0 5px 0;">â€»å…¥åŠ›ã™ã‚‹ã¨ã€ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«ãã®ãƒšãƒ¼ã‚¸ã¸é£›ã³ã¾ã™ã€‚</p>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="target-link-input" placeholder="https://..."
              style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="displayPreMadeQR()"
              style="background: #e65100; color: white; border: none; padding: 8px 24px; border-radius: 4px; cursor: pointer; font-weight: bold;">
              è¡¨ç¤ºã™ã‚‹
            </button>
          </div>

          <div id="premade-qr-result"
            style="margin-top: 20px; display: none; text-align: center; background: white; padding: 20px; border-radius: 8px; border: 2px dashed #ccc;">
            <p style="font-size: 14px; font-weight: bold; color: #00796b; margin-bottom: 10px;">ğŸ‘‡ å—è¬›ç”Ÿç”¨ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒªã‚¢</p>

            <a id="qr-display-link" href="#" target="_blank" style="display: inline-block; cursor: default;">
              <img id="qr-display-img" src="" alt="QR Code"
                style="max-width: 250px; max-height: 250px; border: 1px solid #eee; display: block; margin: 0 auto;">
            </a>

            <p id="qr-link-msg" style="font-size: 11px; color: #999; margin-top: 10px; display: none;">
              ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒªãƒ³ã‚¯å…ˆã¸é£›ã³ã¾ã™</p>
          </div>
        </div>
      </section>


      <section id="feedback-container"
        style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 6px; display: none;">
        <h2> æŒ¯ã‚Šè¿”ã‚Š</h2>
        <hr>

        <div id="feedback-post">
          <p id="feedback-status" class="status-message" style="color:red;"></p>
          <label for="feedback-name">åå‰:</label>
          <input type="text" id="feedback-name" style="width: 150px;">
          <br>
          <label for="feedback-text">æŒ¯ã‚Šè¿”ã‚Š (å¿…é ˆ):</label>
          <textarea id="feedback-text" placeholder="æŒ¯ã‚Šè¿”ã‚Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" required></textarea>
          <button onclick="handleFeedbackSubmit()">æŠ•ç¨¿ã™ã‚‹</button>
        </div>

        <h3 style="margin-top: 30px;">æŠ•ç¨¿å†…å®¹ã®é–²è¦§</h3>
        <div id="feedback-list" style="border-top: 1px solid #eee; padding-top: 10px;">
          <p>æ„Ÿæƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
        </div>
      </section>




      <script>
        function extractNumber() {
          const playersEl = document.getElementById("number-players");
          const resultEl = document.getElementById("number-result");
          const playerCount = parseInt(playersEl.value, 10);

          if (isNaN(playerCount) || playerCount < 1) {
            resultEl.innerHTML = "âš  å‚åŠ äººæ•°ã‚’1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>âš  Please enter a number of 1 or more for the number of participants.";
            resultEl.style.color = "red";
            return;
          }

          // 1ã‹ã‚‰playerCountã¾ã§ã®é–“ã§ãƒ©ãƒ³ãƒ€ãƒ ãªæ•´æ•°ã‚’æŠ½å‡º
          const randomNumber = Math.floor(Math.random() * playerCount) + 1;

          resultEl.textContent = `æŠ½å‡ºã•ã‚ŒãŸãƒŠãƒ³ãƒãƒ¼: ${randomNumber}`;
          resultEl.style.color = "navy";
        }

        // ==========================================
        // âœ… åå‰å¯¾å¿œï¼šå…¬å¹³ãªæŠ½é¸æ©Ÿèƒ½ï¼ˆå…¨å“¡ä¸€å·¡ã™ã‚‹ã¾ã§é‡è¤‡ãªã—ï¼‰
        // ==========================================
        let historyCount = 0;

        // â˜…ã™ã§ã«é¸ã°ã‚ŒãŸäººã‚’è¨˜æ†¶ã—ã¦ãŠãé…åˆ—
        let extractedWinners = [];    // å½“é¸ã—ãŸäººã®è¨˜éŒ²
        let pastFacilitators = [];    // é€²è¡Œå½¹ã‚’ã‚„ã£ãŸäººã®è¨˜éŒ²

        // å…±é€šï¼šåå‰ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦é…åˆ—ã«ã™ã‚‹
        function getNameList() {
          const input = document.getElementById("name-list-input");
          if (!input) return [];
          return input.value.split(/\n/).map(s => s.trim()).filter(s => s !== "");
        }

        // å…±é€šï¼šå±¥æ­´è¡¨ç¤º
        function addHistory(title, content) {
          historyCount++;
          const list = document.getElementById("history-list");
          const item = document.createElement("div");

          const now = new Date();
          const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

          item.style.cssText = "background:#fff; border:1px solid #ccc; border-radius:4px; padding:10px; margin-bottom:8px; border-left:4px solid #008c9e;";
          item.innerHTML = `
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#555; margin-bottom:4px;">
            <strong>#${historyCount} ${title}</strong>
            <span>${timeStr}</span>
        </div>
        <div style="font-weight:bold; color:#333; white-space: pre-wrap;">${content}</div>
    `;
          list.prepend(item);
        }

        // ------------------------------------------
        // â‘  1åæŠ½å‡ºï¼ˆå…¨å“¡å½“ãŸã‚‹ã¾ã§é‡è¤‡ãªã—ï¼‰
        // ------------------------------------------
        function extractNameRandomly() {
          const allNames = getNameList();
          if (allNames.length === 0) {
            alert("åç°¿ã«åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          // ã¾ã å½“ãŸã£ã¦ã„ãªã„äººã‚’æ¢ã™
          let candidates = allNames.filter(name => !extractedWinners.includes(name));

          // ã‚‚ã—å…¨å“¡å½“ãŸã£ã¦ã„ãŸã‚‰ï¼ˆå€™è£œãŒ0äººãªã‚‰ï¼‰ã€ãƒªã‚»ãƒƒãƒˆã—ã¦å…¨å“¡ã‚’å€™è£œã«æˆ»ã™
          let isReset = false;
          if (candidates.length === 0) {
            extractedWinners = []; // å±¥æ­´ã‚¯ãƒªã‚¢
            candidates = [...allNames]; // å…¨å“¡å¾©æ´»
            isReset = true;
          }

          // å€™è£œã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1äººé¸ã¶
          const winner = candidates[Math.floor(Math.random() * candidates.length)];

          // é¸ã°ã‚ŒãŸäººã‚’è¨˜éŒ²ã«è¿½åŠ 
          extractedWinners.push(winner);

          // çµæœè¡¨ç¤º
          let msg = `ğŸ‰ ${winner}`;
          if (isReset) {
            msg += `\n<span style="font-size:11px; color:blue;">(å…¨å“¡ä¸€å·¡ã—ãŸãŸã‚ã€ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ)</span>`;
          } else {
            msg += `\n<span style="font-size:11px; color:#666;">(æ®‹ã‚Šæœªå½“é¸: ${candidates.length - 1}å)</span>`;
          }

          addHistory("å½“é¸è€…æŠ½å‡º", msg);
        }

        // ------------------------------------------
        // â‘¡ ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ï¼ˆé€²è¡Œå½¹ã¯å…¨å“¡ã‚„ã‚‹ã¾ã§é‡è¤‡ãªã—ï¼‰
        // ------------------------------------------
        function groupNamesRandomly() {
          const names = getNameList();
          const groupNum = parseInt(document.getElementById("group-num-input").value);

          if (names.length < 2) return alert("2åä»¥ä¸Šã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          if (groupNum < 2 || groupNum > names.length) return alert("ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã¯é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");

          // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
          const shuffled = [...names];
          for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }

          // ã‚°ãƒ«ãƒ¼ãƒ—ç”Ÿæˆ
          const groups = Array.from({ length: groupNum }, () => []);
          shuffled.forEach((name, i) => groups[i % groupNum].push(name));

          let resultHTML = "";

          groups.forEach((g, i) => {
            if (g.length === 0) return;

            // ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã€Œã¾ã é€²è¡Œå½¹ã‚’ã‚„ã£ã¦ã„ãªã„äººã€ã‚’æ¢ã™
            let candidates = g.filter(member => !pastFacilitators.includes(member));

            // ã‚‚ã—ã‚°ãƒ«ãƒ¼ãƒ—å…¨å“¡ãŒã™ã§ã«çµŒé¨“æ¸ˆã¿ãªã‚‰ã€ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«é–¢ã—ã¦ã¯æ¡ä»¶ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨å“¡å€™è£œï¼‰
            // â€»ãŸã ã—ã€å…¨ä½“ã®å±¥æ­´ã¯æ¶ˆã•ãšã€ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã®ã¿å†é¸å‡ºã‚’è¨±å®¹ã™ã‚‹å½¢ã«ã—ã¾ã™
            let isLoop = false;
            if (candidates.length === 0) {
              candidates = [...g];
              isLoop = true;
            }

            // å€™è£œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é€²è¡Œå½¹ã‚’æ±ºå®š
            const leader = candidates[Math.floor(Math.random() * candidates.length)];

            // å±¥æ­´ã«è¿½åŠ ï¼ˆãŸã ã—ã€ä¸€åº¦ãƒªã‚»ãƒƒãƒˆæ‰±ã„ã§é¸ã°ã‚ŒãŸäººãŒã€ç„¡é™ã«å¢—ãˆãªã„ã‚ˆã†ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
            if (!pastFacilitators.includes(leader)) {
              pastFacilitators.push(leader);
            } else if (isLoop) {
              // å…¨å“¡çµŒé¨“æ¸ˆã¿ã§2å›ç›®ãŒå›ã£ã¦ããŸå ´åˆã€ã©ã†ã™ã‚‹ã‹ã€‚
              // å³å¯†ãªã€Œå…¨å“¡ãƒªã‚»ãƒƒãƒˆã€ã¯ç®¡ç†ãŒé›£ã—ã„ãŸã‚ã€
              // ã€Œã¾ã ã‚„ã£ã¦ãªã„äººãŒã„ã‚Œã°å„ªå…ˆã€ã„ãªã‘ã‚Œã°èª°ã§ã‚‚OKã€ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¦ã„ã¾ã™ã€‚
              // å…¨ä½“ã®ãƒªã‚»ãƒƒãƒˆã‚’ã‹ã‘ãŸã„å ´åˆã¯ã€æ‰‹å‹•ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†é‹ç”¨ãŒå®‰å…¨ã§ã™ã€‚
            }

            // è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
            const memberLinks = g.map(member => {
              if (member === leader) {
                return `<span style="color:red; font-weight:bold;">${member} (é€²è¡Œ)</span>`;
              }
              return member;
            });

            resultHTML += `<strong>[ã‚°ãƒ«ãƒ¼ãƒ— ${i + 1}]</strong> (${g.length}å)<br>${memberLinks.join(", ")}<br><br>`;
          });

          // ã‚‚ã—å…¨å“¡ãŒé€²è¡Œå½¹ã‚’çµŒé¨“ã—ãã£ãŸã‚‰ã€å†…éƒ¨çš„ã«å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚ã’ã‚‹ï¼ˆæ¬¡å›ã®ãŸã‚ã«ï¼‰
          // ç¾åœ¨ã®åç°¿å…¨å“¡ãŒ pastFacilitators ã«å«ã¾ã‚Œã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
          const allDone = names.every(n => pastFacilitators.includes(n));
          if (allDone) {
            resultHTML += `<div style="font-size:11px; color:blue; border-top:1px dashed #ccc;">â€»å…¨å“¡ãŒé€²è¡Œå½¹ã‚’çµŒé¨“ã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</div>`;
            pastFacilitators = []; // æ¬¡å›ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
          }

          addHistory("ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ (é€²è¡Œå½¹ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)", resultHTML);
        }

        // å±¥æ­´ã¨è¨˜æ†¶ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ã‚¯ãƒªã‚¢
        function clearHistory() {
          if (confirm("å±¥æ­´ã¨ã€æŠ½é¸ã®å…¬å¹³åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆèª°ãŒå½“ãŸã£ãŸã‹ç­‰ï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            document.getElementById("history-list").innerHTML = "";
            historyCount = 0;
            extractedWinners = [];   // ãƒªã‚»ãƒƒãƒˆ
            pastFacilitators = [];   // ãƒªã‚»ãƒƒãƒˆ
            alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚å…¨å“¡ãŒæŠ½é¸å¯¾è±¡ã«æˆ»ã‚Šã¾ã™ã€‚");
          }
        }

        const translations = {
          ja: {
            title: "Smart Coach Badminton",
            appTitle: "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼†å­¦ç¿’ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª",
            channelTitle: "MASU Badminton Academy YouTubeãƒãƒ£ãƒ³ãƒãƒ«",
            categoryLabel: "ã‚«ãƒ†ã‚´ãƒªé¸æŠ",
            totalTime: "ç·æ™‚é–“",
            startTime: "é–‹å§‹æ™‚åˆ»",
            addButton: "è¿½åŠ ",
            aiSectionTitle: "èª²é¡Œãƒ»ç›®çš„ã®å…¥åŠ›",
            aiButton: "ãŠã™ã™ã‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆ",
            templateHeader: "â‘£ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
            templateSelect: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã¶",
            createMenuTitle: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ",
            selectPrompt: "--é¸æŠã—ã¦ãã ã•ã„--",
            newMenuTitle: "æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç™»éŒ²",
            menuNameLabel: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼å",
            newMenuTimeLabel: "æ™‚é–“ï¼ˆåˆ†ï¼‰",
            addNewMenuButton: "è¿½åŠ ",
            selectedMenuTitle: "é¸æŠã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆå¯ï¼‰",
            totalTimeText: "ç·æ™‚é–“",
            generateProgram: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ",
            previewProgram: "å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",
            copyProgramText: "å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼",
            downloadProgramImage: "ç”»åƒã¨ã—ã¦ä¿å­˜",
            programNameLabel: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ å",
            programGoalLabel: "ç›®çš„",
            programContentTitle: "ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…å®¹ã€‘",
            thTime: "æ™‚é–“",
            thMainTraining: "ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°",
            thAdditionalInfo: "è£œè¶³èª¬æ˜",
            thYoutube: "YouTube",
            totalTimeLabel: "ç·æ™‚é–“",
            now: "ç¾åœ¨",
            minutes: "åˆ†",
            randomPlanTitle: "ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¯ãƒ¼ã‚¯",
            randomPlanLabel: "ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º:",
            randomKnock: "ãƒãƒƒã‚¯",
            randomRally: "ãƒ©ãƒªãƒ¼",
            randomStrength: "è£œå¼·",
            randomBtn: "ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ½å‡º",
            numberExtractionTitle: "ãƒŠãƒ³ãƒãƒ¼æŠ½å‡º",
            labelNumberPlayers: "å‚åŠ äººæ•°:",
            extractNumberButton: "ãƒ©ãƒ³ãƒ€ãƒ ãƒŠãƒ³ãƒãƒ¼æŠ½å‡º",
            programTimerTitle: "ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼",
            addStepButton: "ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ",
            startButton: "â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ",
            stopButton: "â–  ã‚¹ãƒˆãƒƒãƒ—",
            resetButton: "âŸ³ ãƒªã‚»ãƒƒãƒˆ",
            setCountLabel: "ã‚»ãƒƒãƒˆæ•°ï¼š",
            currentSet: "Set",
            currentStep: "Step",
            groupDivisionTitle: "ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘",
            labelGroupPlayers: "å‚åŠ äººæ•°:",
            labelGroupCount: "ã‚°ãƒ«ãƒ¼ãƒ—æ•°:",
            groupPlayersButton: "ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ",
            menuExtractionTitle: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ½å‡º",
            groupDivisionWarning: "âš  å‚åŠ äººæ•°ã¯2äººä»¥ä¸Šã€ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã¯2ä»¥ä¸Šã§äººæ•°ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚",
            secondsPlaceholder: "ç§’æ•°",
            downloadPdf: "PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
            localSaveLabel: "ãƒ–ãƒ©ã‚¦ã‚¶ä¸€æ™‚ä¿å­˜:",
            btnSaveLocal: "ä¿å­˜ã™ã‚‹",
            btnLoadLocal: "å¾©å…ƒã™ã‚‹",
            btnClearLocal: "å‰Šé™¤",
            localSaveMsg: "ä¿å­˜å®Œäº†:",
            restoreMsg: "å¾©å…ƒå®Œäº†:",
            deleteMsg: "ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚",
            tacticsTitle: "æˆ¦è¡“ãƒœãƒ¼ãƒ‰",
            btnSave: "ä¿å­˜",
            btnRestore: "å¾©å…ƒ",
            btnDelete: "å‰Šé™¤",
            modeMove: "âœ‹ ç§»å‹•",
            modePen: "âœï¸ ãƒšãƒ³",
            modeArrow: "â†— çŸ¢å°",
            modeText: "ğŸ“ æ–‡å­—",
            modeEraser: "ğŸ§½ æ¶ˆã—ã‚´ãƒ ",
            btnReset: "ãƒªã‚»ãƒƒãƒˆ",
            btnClearDraw: "æ›¸ãè¾¼ã¿æ¶ˆå»",
            btnSaveImg: "ç”»åƒä¿å­˜",
            btnShowCourt: "ã‚³ãƒ¼ãƒˆã‚’è¡¨ç¤º",
            btnHideCourt: "ã‚³ãƒ¼ãƒˆã‚’éš ã™",
            txtHint: "çŸ¢å°ï¼šãƒ‰ãƒ©ãƒƒã‚° / æ–‡å­—ï¼šã‚¿ãƒƒãƒ—ã—ã¦å…¥åŠ› / ç§»å‹•ï¼šãƒ‰ãƒ©ãƒƒã‚°",
            courtAllocationTitle: "ã‚³ãƒ¼ãƒˆé…ç½®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼",
            lblNewCreate: "â‘  æ–°è¦ä½œæˆ:",
            lblCourtCount: "ã‚³ãƒ¼ãƒˆ",
            lblPlayerCount: "äººæ•°",
            btnInitLayout: "ç”Ÿæˆ / ãƒªã‚»ãƒƒãƒˆ",
            layoutToggleOpen: "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ã‚’é–‹ã",
            layoutToggleClose: "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç·¨é›†ã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹",
            btnAddSpot: "ï¼‹ ã€‡è¿½åŠ ",
            btnExpandFloor: "â†• æ‹¡å¼µ",
            lblSelectMode: "â˜‘ï¸ é¸æŠãƒ¢ãƒ¼ãƒ‰",
            btnAlignTop: "â¬†ï¸ ä¸Šæƒãˆ",
            btnAlignLeft: "â¬…ï¸ å·¦æƒãˆ",
            btnAlignDist: "â†” æ¨ªç­‰é–“éš”",
            btnClearSelect: "é¸æŠè§£é™¤",
            btnStartOrder: "ğŸ”¢ ã‚¯ãƒªãƒƒã‚¯ã§ç•ªå·ã‚’æŒ¯ã‚‹",
            btnEndOrder: "å®Œäº†",
            categorySelect: "â‘  ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ",
            beginnerSectionTitle: "ğŸ”° åˆå¿ƒè€…å‘ã‘å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³",
            beginnerSectionDesc: "ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€YouTubeã‚¢ãƒ—ãƒªï¼ˆã¾ãŸã¯æ–°ã—ã„ã‚¿ãƒ–ï¼‰ã§å‹•ç”»ãŒé–‹ãã¾ã™ã€‚",
            lblNameList: "å‚åŠ è€…åç°¿ (æ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›):",
            placeholderNameList: "ä¾‹ï¼š\nä½è—¤\néˆ´æœ¨\né«˜æ©‹\nç”°ä¸­",
            noteNameList: "â€»ã“ã“ã«åå‰ãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æŠ½é¸ã•ã‚Œã¾ã™ã€‚",
            hPickWinner: "â‘  å½“é¸è€…ã‚’é¸ã¶ (1å)",
            btnPickWinner: "1åæŠ½å‡º",
            hGroupDivide: "â‘¡ ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘",
            lblGroupNumText: "ã‚°ãƒ«ãƒ¼ãƒ—æ•°: ",
            btnGroupDivide: "ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè¡Œ",
            btnClearHistory: "å±¥æ­´ã‚’ã‚¯ãƒªã‚¢",
            hHistoryTitle: "â–¼ æŠ½é¸çµæœå±¥æ­´ (æ–°ã—ã„é †)",
            doubles: "ãƒ€ãƒ–ãƒ«ã‚¹ (4äºº)",
            singles: "ã‚·ãƒ³ã‚°ãƒ«ã‚¹ (2äºº)",
            dailyTitle: "æ—¥æ›¿ã‚ã‚Šè£œå¼·ãƒãƒ£ãƒ¬ãƒ³ã‚¸",
            dailyDesc: "ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸè£œå¼·ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ãƒãƒƒã‚¸ã‚’é›†ã‚ã‚ˆã†ï¼",
            dailyCountLabel: "ç¨®ç›®æ•°:",
            dailyGenBtn: "ğŸ° ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆ",
            dailyCompleteBtn: "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼",
            dailyDoneBtn: "æœ¬æ—¥ã¯é”æˆæ¸ˆã¿ã§ã™",
            dailyStreak: "é€£ç¶šé”æˆ",
            dailyBadges: "ç²å¾—ãƒãƒƒã‚¸",
            dailyWeekly: "é€±é–“ã‚³ãƒ³ãƒ—",
            dailyMsgDone: "ğŸ‰ ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„åŠªåŠ›ã§ã—ãŸï¼æ˜æ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
            customMode: "å¤‰å‰‡ (è‡ªç”±è¨­å®š)",
            applyBtn: "é…ç½®é©ç”¨",
            updateMessage: "æœ¬ã‚¢ãƒ—ãƒªã¯æ”¹è‰¯ã‚’é‡ã­ã¦éšæ™‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚<br>æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒ—ãƒªã¯ã€YouTubeã‹ã‚‰ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚"
          },
          en: {
            title: "Smart Coach Badminton",
            appTitle: "Badminton Training Program Creator",
            channelTitle: "MASU Badminton Academy YouTube Channel",
            categoryLabel: "Select Category",
            totalTime: "Total Time",
            startTime: "Start Time",
            addButton: "Add",
            aiSectionTitle: "Enter Challenge / Objective",
            aiButton: "Suggest Plan",
            templateHeader: "â‘£ Template",
            templateSelect: "Select Template",
            createMenuTitle: "Create Training Plan",
            selectPrompt: "--Please select--",
            newMenuTitle: "Register New plan",
            menuNameLabel: "Plan Name",
            newMenuTimeLabel: "Time (min)",
            addNewMenuButton: "Add",
            selectedMenuTitle: "Selected Plan (Drag to Reorder)",
            totalTimeText: "Total Time",
            generateProgram: "Generate Program",
            previewProgram: "Preview Program",
            copyProgramText: "Copy Program Text",
            downloadProgramImage: "Save as Image",
            programNameLabel: "Program Name",
            programGoalLabel: "Goal / Objective",
            programContentTitle: "Program Content",
            thTime: "Time",
            thMainTraining: "Main Training",
            thAdditionalInfo: "Additional Info",
            thYoutube: "YouTube",
            totalTimeLabel: "Total Time",
            now: "Now",
            minutes: "min",
            randomPlanTitle: "Group Work",
            randomPlanLabel: "Select random category:",
            randomKnock: "Knock",
            randomRally: "Rally",
            randomStrength: "Strength",
            randomBtn: "Extract",
            programTimerTitle: "Program Timer",
            addStepButton: "+ Add Step",
            startButton: "â–¶ Start",
            stopButton: "â–  Stop",
            resetButton: "âŸ³ Reset",
            setCountLabel: "Sets:",
            currentSet: "Set",
            currentStep: "Step",
            numberExtractionTitle: "Number Extraction",
            labelNumberPlayers: "Number of Players:",
            extractNumberButton: "Extract Random Number",
            groupDivisionTitle: "Group Division",
            labelGroupPlayers: "Number of Players:",
            labelGroupCount: "Number of Groups:",
            groupPlayersButton: "Execute Group Division",
            menuExtractionTitle: "Menu Extraction",
            groupDivisionWarning: "âš  Please set the number of participants to 2 or more, and the number of groups to 2 or more, but not exceeding the number of participants.",
            secondsPlaceholder: "Seconds",
            downloadPdf: "Download as PDF",
            localSaveLabel: "Browser Save:",
            btnSaveLocal: "Save",
            btnLoadLocal: "Restore",
            btnClearLocal: "Delete",
            localSaveMsg: "Save Complete:",
            restoreMsg: "Restore Complete:",
            deleteMsg: "Data deleted.",
            tacticsTitle: "Tactics Board",
            btnSave: "Save",
            btnRestore: "Restore",
            btnDelete: "Delete",
            modeMove: "âœ‹ Move",
            modePen: "âœï¸ Pen",
            modeArrow: "â†— Arrow",
            modeText: "ğŸ“ Text",
            modeEraser: "ğŸ§½ Eraser",
            btnReset: "Reset",
            btnClearDraw: "Clear Ink",
            btnSaveImg: "Save Image",
            btnShowCourt: "Show Court",
            btnHideCourt: "Hide Court",
            txtHint: "Arrow: Drag / Text: Tap / Move: Drag",
            courtAllocationTitle: "Court Allocation Simulator",
            lblNewCreate: "â‘  Create New:",
            lblCourtCount: "Courts",
            lblPlayerCount: "Players",
            btnInitLayout: "Generate / Reset",
            layoutToggleOpen: "Open Layout Editor",
            layoutToggleClose: "Close Layout Editor",
            btnAddSpot: "ï¼‹ Add Spot",
            btnExpandFloor: "â†• Expand",
            lblSelectMode: "â˜‘ï¸ Select Mode",
            btnAlignTop: "â¬†ï¸ Align Top",
            btnAlignLeft: "â¬…ï¸ Align Left",
            btnAlignDist: "â†” Distribute",
            btnClearSelect: "Deselect",
            btnStartOrder: "ğŸ”¢ Numbering Mode",
            btnEndOrder: "Done",
            categorySelect: "â‘  Select Menu from Category",
            beginnerSectionTitle: "ğŸ”° Beginner's Video Lessons",
            beginnerSectionDesc: "Click on the list to open the video in the YouTube app (or a new tab).",
            lblNameList: "Participant List (Line separated):",
            placeholderNameList: "Ex:\nSmith\nJohnson\nWilliams\nBrown",
            noteNameList: "* Enter names here to draw lots.",
            hPickWinner: "â‘  Pick a Winner (1 person)",
            btnPickWinner: "Pick 1 Person",
            hGroupDivide: "â‘¡ Group Division",
            lblGroupNumText: "Number of Groups: ",
            btnGroupDivide: "Execute Grouping",
            btnClearHistory: "Clear History",
            hHistoryTitle: "â–¼ Draw History (Newest First)",
            doubles: "Doubles (4 Players)",
            singles: "Singles (2 Players)",
            dailyTitle: "Daily Strength Challenge",
            dailyDesc: "Clear random strength menus and collect badges!",
            dailyCountLabel: "Exercises:",
            dailyGenBtn: "ğŸ° Generate Challenge",
            dailyCompleteBtn: "âœ… Challenge Complete!",
            dailyDoneBtn: "Completed Today",
            dailyStreak: "Streak",
            dailyBadges: "Total Badges",
            dailyWeekly: "Weekly Comp",
            dailyMsgDone: "ğŸ‰ Great job today! Keep it up tomorrow!",
            customMode: "Custom (Irregular)",
            applyBtn: "Apply Layout",
            updateMessage: "We are constantly improving and updating this app.<br>The latest version is available on YouTube."
          }
        };

        let currentLang = 'ja'; // åˆæœŸå€¤
        let dataFetched = false; // ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿ãƒ•ãƒ©ã‚°
        let programData = []; // ãƒ‡ãƒ¼ã‚¿æ ¼ç´ç”¨

        // è¨€èªåˆ‡æ›¿ãƒœã‚¿ãƒ³
        function setLanguage(lang) {
          currentLang = lang;
          updateUI();
          // renderProgram(); // â€»programData ãŒæœªå®šç¾©ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ãã ã•ã„
          updateTimeProgress(); // ã“ã‚Œã‚‚é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
        }

        // ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¡¨ç¤ºï¼ˆprogramDataãŒå¿…è¦ï¼‰
        function renderProgram() {
          const programBox = document.getElementById("program-content");
          if (!programBox || typeof programData === 'undefined') return; // å®‰å…¨ç­–

          programBox.innerHTML = ""; // åˆæœŸåŒ–

          programData.forEach(item => {
            const name = currentLang === "ja" ? item.name : item.name_en;
            const description = currentLang === "ja" ? item.description : item.description_en;

            const row = document.createElement("div");
            row.textContent = `${item.time}åˆ†: ${name} - ${description}`;
            programBox.appendChild(row);
          });
        }

        // UIæ›´æ–°
        function updateUI() {
          const t = translations[currentLang];
          const statusEl = document.getElementById("statusMessage");

          // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: IDãŒå­˜åœ¨ã™ã‚Œã°ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
          const setText = (id, text) => {
            const el = document.getElementById(id);
            if (el && text) el.textContent = text;
          };

          const updateMsgEl = document.getElementById("update-message");
          if (updateMsgEl) {
            updateMsgEl.innerHTML = t.updateMessage;
          }

          // --- â˜…è¿½åŠ é …ç›® ---
          setText("category-select-title", t.categorySelect);
          // ----------------

          setText("local-save-label", t.localSaveLabel);
          setText("btn-save-local", t.btnSaveLocal);
          setText("btn-load-local", t.btnLoadLocal);
          setText("btn-clear-local", t.btnClearLocal);

          setText("tactics-main-title", t.tacticsTitle);
          setText("btn-t-save", t.btnSave);
          setText("btn-t-restore", t.btnRestore);
          setText("btn-t-delete", t.btnDelete);

          setText("lbl-move", t.modeMove);
          setText("lbl-pen", t.modePen);
          setText("lbl-arrow", t.modeArrow);
          setText("lbl-text", t.modeText);
          setText("lbl-eraser", t.modeEraser);

          setText("btn-t-reset", t.btnReset);
          setText("btn-t-clear", t.btnClearDraw);
          setText("btn-t-saveimg", t.btnSaveImg);

          setText("txt-hint", t.txtHint);

          setText("court-allocation-title", t.courtAllocationTitle);
          setText("lbl-new-create", t.lblNewCreate);
          setText("lbl-court-count", t.lblCourtCount);
          setText("lbl-player-count", t.lblPlayerCount);
          setText("btn-init-layout", t.btnInitLayout);

          setText("lbl-name-list", t.lblNameList);

          // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯ textContent ã§ã¯ãªã placeholder å±æ€§ã‚’ä½¿ã„ã¾ã™
          const nameInput = document.getElementById("name-list-input");
          if (nameInput) {
            nameInput.placeholder = t.placeholderNameList;
          }

          setText("note-name-list", t.noteNameList);
          setText("h-pick-winner", t.hPickWinner);
          setText("btn-pick-winner", t.btnPickWinner);
          setText("h-group-divide", t.hGroupDivide);
          setText("lbl-group-num-text", t.lblGroupNumText);
          setText("btn-group-divide", t.btnGroupDivide);
          setText("btn-clear-history", t.btnClearHistory);
          setText("h-history-title", t.hHistoryTitle);
          setText("lbl-doubles", t.doubles);
          setText("lbl-singles", t.singles);
          setText("lbl-custom", t.customMode);
          setText("btn-apply-custom", t.applyBtn);
          setText("lbl-template-header", t.templateHeader);


          // â–¼â–¼â–¼ æ—¥æ›¿ã‚ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”¨ â–¼â–¼â–¼
          setText("daily-title", t.dailyTitle);
          setText("daily-desc", t.dailyDesc);
          setText("lbl-daily-count", t.dailyCountLabel);
          setText("btn-daily-gen", t.dailyGenBtn);
          setText("lbl-streak", t.dailyStreak);
          setText("lbl-badges", t.dailyBadges);
          setText("lbl-weekly", t.dailyWeekly);
          // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

          // é–‹é–‰ãƒœã‚¿ãƒ³
          const layoutContent = document.getElementById("layout-builder-content");
          if (layoutContent && layoutContent.style.display === "block") {
            setText("layout-toggle-text", t.layoutToggleClose);
          } else {
            setText("layout-toggle-text", t.layoutToggleOpen);
          }

          // å†…éƒ¨ãƒœã‚¿ãƒ³
          setText("btn-l-save", t.btnSave);
          setText("btn-l-restore", t.btnRestore);
          setText("btn-l-delete", t.btnDelete);
          setText("btn-l-saveimg", t.btnSaveImg);

          setText("btn-add-spot", t.btnAddSpot);
          setText("btn-expand-floor", t.btnExpandFloor);
          setText("lbl-select-mode", t.lblSelectMode);
          setText("btn-align-top", t.btnAlignTop);
          setText("btn-align-left", t.btnAlignLeft);
          setText("btn-align-dist", t.btnAlignDist);
          setText("btn-l-clear-select", t.btnClearSelect);
          setText("btn-start-order", t.btnStartOrder);
          setText("btn-end-order", t.btnEndOrder);

          // ã‚³ãƒ¼ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³
          const courtArea = document.getElementById("tactics-court-area");
          if (courtArea && courtArea.style.display === "block") {
            setText("court-toggle-text", t.btnHideCourt);
          } else {
            setText("court-toggle-text", t.btnShowCourt);
          }

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã¾ã‚ã‚Š
          const headerH1 = document.querySelector("header h1");
          if (headerH1) headerH1.textContent = t.title;

          const catLabel = document.querySelector("label[for='category']");
          if (catLabel) catLabel.textContent = t.categoryLabel;

          setText("total-time-label", t.totalTime);

          const startLabel = document.querySelector("label[for='start-time']");
          if (startLabel) startLabel.textContent = t.startTime;

          setText("app-title", t.appTitle);
          setText("channel-title", t.channelTitle);

          document.querySelectorAll(".menu-item button").forEach(btn => {
            btn.textContent = t.addButton;
          });

          const aiTitle = document.querySelector("#ai-section h3");
          if (aiTitle) aiTitle.textContent = t.aiSectionTitle;

          const aiBtn = document.querySelector("#ai-section button");
          if (aiBtn) aiBtn.textContent = t.aiButton;

          const trainingH3 = document.querySelector("#training-menu-box h3");
          if (trainingH3) trainingH3.textContent = t.templateTitle;

          const tmplOption = document.querySelector("#templateSelect option");
          if (tmplOption) tmplOption.textContent = t.templateSelect;

          const createH3 = document.querySelector("#create-menu-box h3");
          if (createH3) createH3.textContent = t.createMenuTitle;

          const catOption = document.querySelector("#category option[value='']");
          if (catOption) catOption.textContent = t.selectPrompt;

          const newMenuLabel = document.querySelector("label[for='new-menu-name']");
          if (newMenuLabel) newMenuLabel.textContent = t.menuNameLabel;

          setText("newMenuTitle", t.newMenuTitle);

          const newTimeLabel = document.querySelector("label[for='new-menu-time']");
          if (newTimeLabel) newTimeLabel.textContent = t.newMenuTimeLabel;

          const beginnerTitle = document.getElementById("beginner-section-title");
          if (beginnerTitle) beginnerTitle.textContent = t.beginnerSectionTitle;

          const beginnerDesc = document.getElementById("beginner-section-desc");
          if (beginnerDesc) beginnerDesc.textContent = t.beginnerSectionDesc;

          setText("add-new-menu-btn", t.addNewMenuButton);
          setText("selected-menu-title", t.selectedMenuTitle);

          // æ™‚é–“è¡¨ç¤ºã®ç‰¹æ®Šå‡¦ç†
          const totalTimeTextNode = document.getElementById("total-time-text");
          if (totalTimeTextNode && totalTimeTextNode.childNodes[0]) {
            totalTimeTextNode.childNodes[0].textContent = t.totalTimeText + ": ";
          }

          setText("number-extraction-title", t.numberExtractionTitle);
          setText("label-number-players", t.labelNumberPlayers);
          setText("extract-number-btn", t.extractNumberButton);
          setText("download-program-png", t.downloadProgramImage);
          setText("download-program-pdf", t.downloadPdf);

          // ç·æ™‚é–“ã®æ›´æ–°
          const totalTimeSpan = document.getElementById("total-time");
          const totalTimeParent = document.getElementById("total-time-text");
          if (totalTimeSpan && totalTimeParent) {
            const timeValue = totalTimeSpan.textContent;
            totalTimeParent.innerHTML =
              `${t.totalTimeText}: <span id="total-time">${timeValue}</span> ${t.minutes}`;
          }

          // ç·´ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰ãƒ©ãƒ™ãƒ«
          setText("total-time-label", t.totalTimeLabel);

          setText("generate-program", t.generateProgram);
          setText("preview-program", t.previewProgram);
          setText("copy-program-html", t.copyProgramText);
          setText("download-program-png", t.downloadProgramImage);

          setText("program-name-label", t.programNameLabel);
          setText("program-goal-label", t.programGoalLabel);
          setText("program-content-title", t.programContentTitle);
          setText("th-time", t.thTime);
          setText("th-main-training", t.thMainTraining);
          setText("th-additional-info", t.thAdditionalInfo);
          setText("th-youtube", t.thYoutube);

          // ãƒ—ãƒ­ã‚°ãƒ©ãƒ åã¨ç›®çš„ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          const editableNameEl = document.getElementById("editable-name");
          const editablePurposeEl = document.getElementById("editable-purpose");

          if (editableNameEl && editablePurposeEl) {
            if (currentLang === 'ja') {
              if (editableNameEl.value === 'Overall Training Program' || editableNameEl.value === '') {
                editableNameEl.value = "ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ";
              }
              if (editablePurposeEl.value === 'Aim to strengthen [Objective].' || editablePurposeEl.value === '') {
                editablePurposeEl.value = "ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚";
              }
            } else {
              if (editableNameEl.value === 'ç·åˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ' || editableNameEl.value === '') {
                editableNameEl.value = "Overall Training Program";
              }
              if (editablePurposeEl.value === 'ã®å¼·åŒ–ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚' || editablePurposeEl.value === '') {
                editablePurposeEl.value = "Aim to strengthen [Objective].";
              }
            }
          }

          // ãƒ©ãƒ³ãƒ€ãƒ ãƒ—ãƒ©ãƒ³
          setText("random-plan-title", t.randomPlanTitle);
          setText("random-plan-label", t.randomPlanLabel);
          setText("label-random-knock", t.randomKnock);
          setText("label-random-rally", t.randomRally);
          setText("label-random-strength", t.randomStrength);

          const randBtn = document.getElementById("random-btn");
          if (randBtn) randBtn.textContent = t.randomBtn || (currentLang === "ja" ? "æŠ½å‡º" : "Extract");

          setText("group-division-title", t.groupDivisionTitle);
          setText("label-group-players", t.labelGroupPlayers);
          setText("label-group-count", t.labelGroupCount);
          setText("group-players-btn", t.groupPlayersButton);
          setText("menu-extraction-title", t.menuExtractionTitle);

          // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼
          setText("program-timer-title", t.programTimerTitle);
          setText("add-step", t.addStepButton);
          setText("set-count-label", t.setCountLabel);
          setText("start-timer", t.startButton);
          setText("stop-timer", t.stopButton);
          setText("reset-timer", t.resetButton);

          document.querySelectorAll(".step-input").forEach(input => {
            input.placeholder = t.secondsPlaceholder;
          });

          const currentSetEl = document.getElementById("current-set");
          if (currentSetEl) {
            const setNumbers = currentSetEl.textContent.match(/(\d+\s\/\s\d+)/g) ? currentSetEl.textContent.match(/(\d+\s\/\s\d+)/g)[0] : '1 / 3';
            currentSetEl.textContent = `${t.currentSet} ${setNumbers}`;
          }

          const stepInfoEl = document.getElementById("step-info");
          if (stepInfoEl) {
            const stepNumber = stepInfoEl.textContent.match(/(\d+)/g) ? stepInfoEl.textContent.match(/(\d+)/g)[0] : '1';
            stepInfoEl.textContent = `${t.currentStep} ${stepNumber}`;
          }

          // UIæ›´æ–°æ™‚ã«æ—¥æ›¿ã‚ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ãƒœã‚¿ãƒ³ã‚‚æœ€æ–°è¨€èªã«æ›´æ–°
          if (typeof updateDailyUI === 'function') {
            updateDailyUI();
          }

        }

        // ==========================================
        // âœ… ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆä¿®æ­£ãƒ»çµ±åˆç‰ˆï¼‰
        // ==========================================
        document.addEventListener("DOMContentLoaded", () => {
          console.log("åˆæœŸåŒ–å‡¦ç†é–‹å§‹");

          sCourtCanvas = document.getElementById("shuttle_court_canvas");
          if (sCourtCanvas) sCourtCtx = sCourtCanvas.getContext("2d");

          sVideo = document.getElementById("shuttle_video");
          sOverlay = document.getElementById("shuttle_video_overlay");
          if (sOverlay) sOverlayCtx = sOverlay.getContext("2d");

          // ã‚‚ã—ã™ã§ã«æç”»é–¢æ•°ãŒã‚ã‚Œã°å®Ÿè¡Œã—ã¦åˆæœŸè¡¨ç¤º
          if (typeof drawShuttleCourt === 'function') drawShuttleCourt();


          // 1. åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
          loadSheet();

          // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
          // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ
          const genBtn = document.getElementById("generate-program");
          if (genBtn) genBtn.addEventListener("click", displayProgram);

          // å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          const preBtn = document.getElementById("preview-program");
          if (preBtn) preBtn.addEventListener("click", showSharePreview);

          // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼
          const copyBtn = document.getElementById("copy-program-html");
          if (copyBtn) copyBtn.addEventListener("click", copyProgramText);

          // ç”»åƒä¿å­˜
          const pngBtn = document.getElementById("download-program-png");
          if (pngBtn) pngBtn.addEventListener("click", () => downloadElementAsPng("program-output"));

          // PDFä¿å­˜
          const pdfBtn = document.getElementById("download-program-pdf");
          if (pdfBtn) pdfBtn.addEventListener("click", exportPreviewPDF);

          // ã‚«ãƒ†ã‚´ãƒªé¸æŠ
          const catSelect = document.getElementById("category");
          if (catSelect) {
            catSelect.addEventListener("change", e => {
              if (e.target.value) showMenu(e.target.value);
            });
          }

          // æ–°è¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ 
          const addMenuBtn = document.getElementById("add-new-menu-btn");
          if (addMenuBtn) {
            addMenuBtn.addEventListener("click", () => {
              const name = document.getElementById("new-menu-name").value.trim();
              const time = parseFloat(document.getElementById("new-menu-time").value);
              if (!name) return alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nPlease enter the plan name.");

              selectedMenus.push({
                category: "æ–°è¦ä½œæˆ",
                name: name,
                time: time || 0,
                url: "",
                note: ""
              });
              document.getElementById("new-menu-name").value = "";
              document.getElementById("new-menu-time").value = "";
              renderSelectedList();
            });
          }

          // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
          const loginBtn = document.getElementById("login-button");
          if (loginBtn) loginBtn.addEventListener("click", loginWithPassword);

          const logoutBtn = document.getElementById("logout-button");
          if (logoutBtn) logoutBtn.addEventListener("click", logout);

          // ãƒŠãƒ³ãƒãƒ¼æŠ½å‡ºãƒ»ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
          const extractNumberBtn = document.getElementById("extract-number-btn");
          if (extractNumberBtn) extractNumberBtn.addEventListener("click", extractNumber);

          const groupPlayersBtn = document.getElementById("group-players-btn");
          if (groupPlayersBtn) groupPlayersBtn.addEventListener("click", groupPlayers);

          // æ™‚é–“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®åˆæœŸåŒ–ã¨ç›£è¦–
          const targetTimeInput = document.getElementById("target-time");
          if (targetTimeInput) targetTimeInput.addEventListener("input", updateTimeProgress);
          updateTimeProgress(); // åˆæœŸè¡¨ç¤ºæ›´æ–°
        });


        // â–¼â–¼â–¼ ãƒ–ãƒ©ã‚¦ã‚¶ä¸€æ™‚ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² â–¼â–¼â–¼
        const btnSave = document.getElementById("btn-save-local");
        const btnLoad = document.getElementById("btn-load-local");
        const btnClear = document.getElementById("btn-clear-local");

        if (btnSave) btnSave.addEventListener("click", saveToBrowser);
        if (btnLoad) btnLoad.addEventListener("click", loadFromBrowser);
        if (btnClear) btnClear.addEventListener("click", clearBrowserData);

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ï¼ˆä»»æ„ï¼‰
        if (localStorage.getItem("smartCoachDraft")) {
          const statusEl = document.getElementById("local-save-status");
          if (statusEl) statusEl.textContent = "â€»ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™";
        }

        const slOffset = document.getElementById("plot-y-offset");
        if (slOffset) slOffset.addEventListener("input", (e) => {
          document.getElementById("val-y-offset").textContent = e.target.value;
          // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã™ãŸã³ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†è¨ˆç®—ãƒ»å†æç”»
          refreshShuttleAnalysis();
        });


        // âœ… PDFå‡ºåŠ›
        async function exportPreviewPDF() {
          const previewDiv = document.getElementById("share-preview");

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒã‚§ãƒƒã‚¯
          if (!previewDiv || !previewDiv.innerHTML.trim()) {
            alert("å…ˆã«ã€Œå…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚\nFirst, press the â€œShare Previewâ€ button to display the preview.");
            return;
          }

          // å‡¦ç†ä¸­ã®è¡¨ç¤º
          const btn = document.getElementById("download-program-pdf");
          const originalText = btn.textContent;
          btn.textContent = "ç”Ÿæˆä¸­...";
          btn.disabled = true;

          try {
            // 1. html2canvasã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éƒ¨åˆ†ã‚’ç”»åƒåŒ– (scale: 2 ã§é«˜ç”»è³ªåŒ–)
            const canvas = await html2canvas(previewDiv, {
              scale: 2,
              useCORS: true, // å¤–éƒ¨ç”»åƒã®èª­ã¿è¾¼ã¿è¨±å¯ï¼ˆQRãªã©ï¼‰
              logging: false
            });
            const imgData = canvas.toDataURL("image/png");

            // 2. pdfMakeã®å®šç¾©ä½œæˆï¼ˆç”»åƒã‚’åŸ‹ã‚è¾¼ã‚€ï¼‰
            const docDefinition = {
              content: [
                {
                  image: imgData,
                  width: 500, // PDFã®æ¨ªå¹…ã«åˆã‚ã›ã¦èª¿æ•´
                  alignment: 'center'
                }
              ],
              // ä½™ç™½è¨­å®š
              pageMargins: [20, 20, 20, 20]
            };

            // 3. PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            pdfMake.createPdf(docDefinition).download("SmartCoach_Program.pdf");

          } catch (err) {
            console.error("PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
            alert("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          } finally {
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            btn.textContent = originalText;
            btn.disabled = false;
          }
        }

        // âœ… å…±æœ‰URLã‚’ç”Ÿæˆã™ã‚‹å‡¦ç†
        function generateShareLink() {
          if (!selectedMenus.length) {
            alert("å…±æœ‰ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          const data = encodeURIComponent(JSON.stringify(selectedMenus));
          const baseUrl = `${location.origin}${location.pathname}`;
          const shareUrl = `${baseUrl}?share=${data}`;

          navigator.clipboard.writeText(shareUrl).then(() => {
            alert("å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nç›¸æ‰‹ã«ã“ã®ãƒªãƒ³ã‚¯ã‚’é€ã‚Œã°åŒã˜ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å†ç¾ã§ãã¾ã™ã€‚");
          });
        }


        // ==========================================
        // âœ… ãƒ–ãƒ©ã‚¦ã‚¶ä¸€æ™‚ä¿å­˜æ©Ÿèƒ½ (LocalStorage)
        // ==========================================

        // 1. ä¿å­˜ã™ã‚‹
        function saveToBrowser() {
          if (!selectedMenus.length) {
            alert(currentLang === 'ja' ? "ä¿å­˜ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" : "No menu selected to save.");
            return;
          }

          const currentName = document.getElementById("editable-name")?.value || editableName || "";
          const currentPurpose = document.getElementById("editable-purpose")?.value || editablePurpose || "";

          const saveData = {
            menus: selectedMenus,
            startTime: document.getElementById("start-time").value,
            targetTime: document.getElementById("target-time").value,
            programName: currentName,
            programPurpose: currentPurpose,
            isGenerated: isProgramGenerated,
            timestamp: new Date().toLocaleString()
          };

          localStorage.setItem("smartCoachDraft", JSON.stringify(saveData));

          // è¨€èªè¨­å®šã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const t = translations[currentLang];
          const statusEl = document.getElementById("local-save-status");
          if (statusEl) {
            statusEl.textContent = `${t.localSaveMsg} ${saveData.timestamp}`;
            statusEl.style.color = "#e65100";
            setTimeout(() => { statusEl.textContent = ""; }, 3000);
          }
        }

        function loadFromBrowser() {
          const json = localStorage.getItem("smartCoachDraft");
          if (!json) {
            alert(currentLang === 'ja' ? "ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" : "No saved data found.");
            return;
          }

          const confirmMsg = currentLang === 'ja'
            ? "ç¾åœ¨ã®å†…å®¹ã‚’ç ´æ£„ã—ã¦ã€ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ"
            : "Are you sure you want to restore? Current data will be lost.";

          if (!confirm(confirmMsg)) {
            return;
          }

          try {
            const data = JSON.parse(json);

            selectedMenus = data.menus || [];
            if (document.getElementById("start-time")) document.getElementById("start-time").value = data.startTime || "00:00";
            if (document.getElementById("target-time")) document.getElementById("target-time").value = data.targetTime || "";

            renderSelectedList();

            if (data.isGenerated || data.programName || data.programPurpose) {
              displayProgram();
              const nameEl = document.getElementById("editable-name");
              const purposeEl = document.getElementById("editable-purpose");

              if (data.programName) {
                if (nameEl) nameEl.value = data.programName;
                editableName = data.programName;
              }
              if (data.programPurpose) {
                if (purposeEl) purposeEl.value = data.programPurpose;
                editablePurpose = data.programPurpose;
              }
            }

            // è¨€èªè¨­å®šã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const t = translations[currentLang];
            const statusEl = document.getElementById("local-save-status");
            if (statusEl) statusEl.textContent = `${t.restoreMsg} ${data.timestamp || ""}`;

          } catch (e) {
            console.error("Restore Error:", e);
            alert("Error restoring data.");
          }
        }

        function clearBrowserData() {
          if (!localStorage.getItem("smartCoachDraft")) return;

          const confirmMsg = currentLang === 'ja'
            ? "ä¿å­˜ã•ã‚ŒãŸä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
            : "Delete saved draft data?";

          if (confirm(confirmMsg)) {
            localStorage.removeItem("smartCoachDraft");
            const t = translations[currentLang];
            document.getElementById("local-save-status").textContent = t.deleteMsg;
            setTimeout(() => { document.getElementById("local-save-status").textContent = ""; }, 3000);
          }
        }

        // âœ… URLã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¾©å…ƒã™ã‚‹å‡¦ç†
        function restoreFromShareURL() {
          const params = new URLSearchParams(window.location.search);
          const sharedData = params.get("share");
          if (sharedData) {
            try {
              selectedMenus = JSON.parse(decodeURIComponent(sharedData));
              renderSelectedList();
              alert("å…±æœ‰ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
            } catch (e) {
              console.error(e);
              alert("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
          }
        }

        // âœ… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å¾©å…ƒ
        window.addEventListener("DOMContentLoaded", restoreFromShareURL);

        // âœ… QRã‚³ãƒ¼ãƒ‰å¯¾å¿œ å…±æœ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        async function showSharePreview() {
          // â–¼â–¼â–¼ ä½œæˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã“ã“ã§ã‚¹ãƒˆãƒƒãƒ— â–¼â–¼â–¼
          if (!isProgramGenerated) {
            alert("å…ˆã«ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å†…å®¹ã‚’ç¢ºå®šã•ã›ã¦ãã ã•ã„ã€‚\nPlease click the â€œCreate Programâ€ button first to confirm the contents.");
            return;
          }

          if (!selectedMenus.length) {
            alert("ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
          }

          // â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚‚å¼·åˆ¶çš„ã«è¡¨ç¤º
          const previewDiv = document.getElementById("share-preview");
          previewDiv.style.display = "block";

          const { name, purpose } = generateProgramInfo();
          editableName = name;
          editablePurpose = purpose;

          const startInput = document.getElementById("start-time")?.value || "00:00";
          let [startHour, startMin] = startInput.split(":").map(v => parseInt(v) || 0);
          let currentTime = startHour * 60 + startMin;

          const formatTime = (min) => {
            const h = Math.floor(min / 60);
            const m = min % 60;
            return `${h}:${m.toString().padStart(2, "0")}`;
          };

          const mainCategories = [
            "ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—", "ãƒ©ãƒªãƒ¼ç³»", "ãƒãƒƒã‚¯ç³»", "ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", "ãƒ•ã‚£ã‚¸ã‚«ãƒ«", "è£œå¼·",
            "ä¼‘æ†©ï¼ˆæ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼æº–å‚™ï¼‰", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "æ–°è¦ä½œæˆ",
            // â–¼ è¿½åŠ  â–¼
            "ã‚²ãƒ¼ãƒ ", "ãƒãƒƒã‚¯", "ãƒ©ãƒªãƒ¼",
            // â–² è¿½åŠ  â–²
            "Warm-up", "Rally", "Knock", "Footwork", "Physical", "Strength",
            "Break (Preparing the next plan)", "Knowledge", "Hosei Univ Practice",
            // â–¼ è¿½åŠ  â–¼
            "Game"
            // â–² è¿½åŠ  â–²
          ];
          const mainList = selectedMenus.filter(m => mainCategories.includes(m.category));

          let rows = "";
          for (const main of mainList) {
            const start = formatTime(currentTime);
            const duration = (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(main.category)) ? 0 : (main.time || 0);
            currentTime += duration;
            const end = formatTime(currentTime);

            let urlHtml = "";
            if (main.url) {
              try {
                const cleanUrl = main.url.trim().replace(/\s+/g, "");
                const tempDiv = document.createElement("div");
                new QRCode(tempDiv, { text: cleanUrl, width: 80, height: 80, correctLevel: QRCode.CorrectLevel.L });
                const canvas = tempDiv.querySelector("canvas");
                if (canvas) {
                  const qrDataUrl = canvas.toDataURL("image/png");
                  urlHtml = `<a href="${cleanUrl}" target="_blank"><img src="${qrDataUrl}" width="80" height="80" alt="QR"></a>`;
                }
              } catch (e) { console.error(e); }
            }

            rows += `
            <tr>
                <td>${start}â€“${end}</td>
                <td>[${main.category}] ${main.name}${duration ? `ï¼ˆ${duration}åˆ†ï¼‰` : ""}</td>
                <td style="text-align:left; vertical-align:top; white-space:pre-wrap; word-break:break-word;">${(main.note || "").replace(/\n/g, "<br>")}</td>
                <td>${urlHtml}</td>
            </tr>`;
          }

          const totalTimeFixed = selectedMenus.reduce((sum, m) => {
            if (["è£œå¼·", "çŸ¥è­˜", "æ³•æ”¿å¤§å­¦ç·´ç¿’", "Strength", "Knowledge", "Hosei Univ Practice"].includes(m.category)) return sum;
            return sum + (m.time || 0);
          }, 0);

          const html = `
        <div style="font-family:'Noto Sans JP',sans-serif; color:#333;">
            <h3 style="color:#00796b;"> ãƒ—ãƒ­ã‚°ãƒ©ãƒ åï¼š${editableName}</h3>
            <p><b> ç›®çš„ï¼š</b>${editablePurpose}</p>
            <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; text-align:center; font-size:13px;">
                <thead style="background:#e0f7fa;">
                    <tr><th>æ™‚é–“</th><th>ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</th><th>è£œè¶³èª¬æ˜</th><th>YouTubeï¼ˆQRï¼‰</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            <p style="margin-top:10px;"><b>ğŸ•’ ç·æ™‚é–“ï¼š</b>${totalTimeFixed}åˆ†</p>
        </div>`;

          previewDiv.innerHTML = html;
        }

      </script>

      <!-- âœ… PNGä¿å­˜æ©Ÿèƒ½ã‚’æœ€å¾Œã«è¿½åŠ  -->
      <script>

        // â–¼ input ã‚’ div ã«å¤‰æ›ã—ã¦ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹é–¢æ•°
        function cloneForExport(element) {
          const cloned = element.cloneNode(true);

          // ã™ã¹ã¦ã® input ã‚’ div ã«ç½®ãæ›ãˆ
          cloned.querySelectorAll("input, textarea").forEach(el => {
            const div = document.createElement("div");
            div.textContent = el.value;

            // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™æ‰¿
            const style = getComputedStyle(el);
            div.style.cssText = style.cssText;

            // html2canvas ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«ä½™ç™½ã¨ line-height ã‚’è£œå¼·
            div.style.padding = "10px 12px";
            div.style.lineHeight = "1.4";
            div.style.minHeight = style.height;
            div.style.whiteSpace = "pre-wrap";

            el.replaceWith(div);
          });

          return cloned;
        }


        // â–¼ PNGç”Ÿæˆãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ã‚’æ”¹ä¿®ï¼‰
        async function downloadElementAsPng(elementId, fileName = "training_program.png") {
          const target = document.getElementById(elementId);
          if (!target || !target.innerHTML.trim()) {
            alert("ä¿å­˜å¯¾è±¡ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nThe target for saving has not been created.");
            return;
          }

          // ğŸ”¥ ã“ã“ã‹ã‚‰é‡è¦ï¼šã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œã‚Šã€inputå‰Šé™¤ â†’ DOMå¤–ã«é…ç½®
          const cloned = cloneForExport(target);
          cloned.style.position = "absolute";
          cloned.style.top = "-99999px";
          cloned.style.left = "-99999px";
          document.body.appendChild(cloned);

          try {
            const canvas = await html2canvas(cloned, {
              scale: 2,
              useCORS: true,
              backgroundColor: "#ffffff",
              windowWidth: cloned.scrollWidth,
              windowHeight: cloned.scrollHeight,
            });

            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = fileName;
            link.click();

          } catch (err) {
            console.error("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
            alert("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          } finally {
            cloned.remove(); // â­ä¸è¦ã«ãªã£ãŸã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤
          }
        }


        // ä½¿ç”¨ä¾‹
        document.getElementById("download-program-png").addEventListener("click", () => {
          downloadElementAsPng("program-output");
        });

        const pdfBtn = document.getElementById("download-program-pdf");
        if (pdfBtn) {
          pdfBtn.addEventListener("click", exportPreviewPDF);
        }

      </script>

      <script>
        // ==========================================
        // ğŸš‘ AIææ¡ˆæ©Ÿèƒ½ï¼ˆGASãƒ‡ãƒ¼ã‚¿é€£æºãƒ»ä¿®æ­£ç‰ˆï¼‰
        // ==========================================

        // å¤‰æ•°ã®åˆæœŸåŒ–
        var suggestedMenusData = [];

        // ã‚‚ã—SHEET_URLãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã®äºˆå‚™
        const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbw_ltWsvwzLKuMO7XUEPr8WRG-m76YnR6ZriwGId1-fBYFK0HNvrGO86ds_VU8T7sLCfA/exec";

        // âœ… 1. Gemini APIå‘¼ã³å‡ºã—é–¢æ•°

        // APIé€šä¿¡
        window.analyzeAndSuggest = async function () {
          console.log("ğŸš€ AIãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");

          const text = document.getElementById("free-text").value.trim();
          const output = document.getElementById("ai-suggested");
          const addBtn = document.getElementById("add-ai-menus-btn");

          // åˆæœŸåŒ–
          suggestedMenusData = [];
          if (addBtn) addBtn.style.display = "none";
          if (output) output.style.display = "block";

          if (!text) {
            output.innerHTML = "âš ï¸ èª²é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
            return;
          }

          // è§£æä¸­ã®è¡¨ç¤º
          output.innerHTML = `
        <div style="text-align:center; padding: 20px; color:#00796b;">
            <div style="display:inline-block; width:20px; height:20px; border:3px solid #00796b; border-radius:50%; border-top-color:transparent; animation:spin 1s linear infinite;"></div>
            <br>
            <span style="font-weight:bold;">Gemini AIãŒæœ€é©ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ§‹æˆä¸­...</span>
            <style>@keyframes spin {0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}}</style>
        </div>`;

          try {
            const targetUrl = (typeof SHEET_URL !== 'undefined') ? SHEET_URL : DEFAULT_GAS_URL;
            const requestUrl = `${targetUrl}?mode=ai&text=${encodeURIComponent(text)}`;

            // APIé€šä¿¡
            const res = await fetch(requestUrl);
            let jsonString = await res.text();

            // ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç†
            jsonString = jsonString.replace(/```json/g, "").replace(/```/g, "");
            const firstOpen = jsonString.indexOf('{');
            const lastClose = jsonString.lastIndexOf('}');
            if (firstOpen !== -1 && lastClose !== -1) {
              jsonString = jsonString.substring(firstOpen, lastClose + 1);
            }

            let data;
            try {
              data = JSON.parse(jsonString);
            } catch (e) {
              console.error("JSON Parse Error:", jsonString);
              output.innerHTML = `âš ï¸ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`;
              return;
            }

            // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (data.error) {
              console.error("API Error Response:", data.error);

              if (typeof data.error === 'string' && (data.error.includes("429") || data.error.includes("quota"))) {
                output.innerHTML = `
                    <div style="color: #c62828; background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ef5350;">
                        <strong>âš ï¸ æœ¬æ—¥ã®AIåˆ©ç”¨ä¸Šé™ã«é”ã—ã¾ã—ãŸ</strong><br>
                        <span style="font-size:13px;">æ˜æ—¥ã«ãªã‚Œã°ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</span>
                    </div>`;
              } else {
                output.innerHTML = `
                    <div style="color: #ef6c00; background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                        <span style="font-size:13px;">${data.error}</span>
                    </div>`;
              }
              return;
            }

            // æˆåŠŸæ™‚ã®å‡¦ç†ï¼ˆãƒªã‚¹ãƒˆè¡¨ç¤ºï¼‰
            let parsedMenus = [];
            let adviceText = data.advice || "";

            if (data.suggested_menus && Array.isArray(data.suggested_menus)) {
              parsedMenus = data.suggested_menus.map(m => ({
                category: m.category || m.step || "AIææ¡ˆ",
                name: m.name,
                note: m.note || m.reason || "",
                url: m.url || m.video_url || ""
              }));
            }

            suggestedMenusData = parsedMenus.map(m => ({
              category: m.category,
              name: m.name,
              time: 5,
              note: m.note || "",
              url: m.url || ""
            }));

            if (suggestedMenusData.length === 0) {
              output.innerHTML = "âš ï¸ æ¡ä»¶ã«åˆã†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
              return;
            }

            const adviceHtml = adviceText ? `
            <div style="background:#fffde7; border-left: 5px solid #fbc02d; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <div style="font-weight:bold; color:#f57f17; margin-bottom:5px; font-size:15px;">ğŸ’¡ ã‚³ãƒ¼ãƒã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
                <div style="font-size:14px; color:#333; line-height:1.6;">${adviceText}</div>
            </div>` : "";

            const listHtml = suggestedMenusData.map((m, i) => {
              return `
                <div style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03);">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <input type="checkbox" id="ai-chk-${i}" checked style="transform: scale(1.3); margin-top: 4px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 11px; font-weight: bold; color: #fff; background: #00796b; padding: 3px 8px; border-radius: 12px;">${m.category}</span>
                                <span style="font-weight: bold; font-size: 16px; color: #333;">${m.name}</span>
                            </div>
                        </div>
                    </div>
                    ${m.note ? `<div style="margin-left: 32px; background: #f5f5f5; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #555; line-height: 1.5; margin-top:5px;"><span style="font-weight:bold; color:#00796b;">POINT:</span> ${m.note}</div>` : ""}
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-left: 32px; flex-wrap: wrap; gap: 10px; margin-top:5px;">
                        <div>${m.url ? `<a href="${m.url}" target="_blank" style="font-size:13px; color:#1565c0; text-decoration:none; font-weight:bold;">ğŸ“º å‹•ç”»</a>` : ""}</div>
                        <div style="display: flex; align-items: center; background: #e0f2f1; padding: 4px 10px; border-radius: 20px;">
                            <span style="font-size:12px; margin-right:6px; color:#00695c; font-weight:bold;">æ™‚é–“:</span>
                            <input type="number" id="ai-time-${i}" value="5" min="1" style="width: 45px; padding: 4px; border: 1px solid #b2dfdb; border-radius: 4px; text-align:center; font-weight:bold; color:#00695c;">
                            <span style="font-size:12px; margin-left:4px; color:#00695c;">åˆ†</span>
                        </div>
                    </div>
                </div>`;
            }).join('');

            output.innerHTML = `<div style="text-align: left;">${adviceHtml}<div style="max-height: 600px; overflow-y: auto; padding: 2px;">${listHtml}</div></div>`;

            if (addBtn) {
              addBtn.textContent = "âœ… ãƒã‚§ãƒƒã‚¯ã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¸€æ‹¬è¿½åŠ ";
              addBtn.style.display = "block";
              addBtn.onclick = window.addSuggestedMenus;
            }

          } catch (e) {
            console.error("AI Analyze Error:", e);
            output.innerHTML = `<div style="color:red; padding:10px;">âš ï¸ ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
          }
        };

        // âœ… 2. é¸æŠã—ãŸææ¡ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹é–¢æ•°
        window.addSuggestedMenus = function () {
          if (!suggestedMenusData || suggestedMenusData.length === 0) return;

          let count = 0;

          suggestedMenusData.forEach((menu, i) => {
            const checkbox = document.getElementById(`ai-chk-${i}`);
            const timeInput = document.getElementById(`ai-time-${i}`);

            // ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ 
            if (checkbox && checkbox.checked) {
              const inputTime = timeInput ? parseFloat(timeInput.value) : 5;

              selectedMenus.push({
                category: menu.category,
                name: menu.name,
                sets: "",
                perSet: 0,
                time: inputTime || 5,
                url: menu.url,
                note: menu.note,
                imgUrl: ""
              });
              count++;
            }
          });

          if (count === 0) {
            alert("è¿½åŠ ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
            return;
          }

          // ç”»é¢æ›´æ–°
          if (typeof renderSelectedList === 'function') {
            renderSelectedList();
          }

          alert(`${count}ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nãƒªã‚¹ãƒˆã®ä¸‹ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚`);

          // ã‚¨ãƒªã‚¢ãƒªã‚»ãƒƒãƒˆ
          const output = document.getElementById("ai-suggested");
          const addBtn = document.getElementById("add-ai-menus-btn");
          if (output) output.innerHTML = "";
          if (addBtn) addBtn.style.display = "none";
          suggestedMenusData = [];
        };

        // âœ… 3. DOMèª­ã¿è¾¼ã¿å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        document.addEventListener("DOMContentLoaded", function () {
          const aiBtn = document.getElementById("ai-suggest-btn");
          if (aiBtn) {
            aiBtn.onclick = window.analyzeAndSuggest;
          }
          const addBtn = document.getElementById("add-ai-menus-btn");
          if (addBtn) {
            addBtn.onclick = window.addSuggestedMenus;
          }
        });
      </script>

      <script>
        const templates = {

          "Smart Coach Badminton ä½¿ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«":
            "https://drive.google.com/file/d/15rtpsLn_6BVCEH7N8r18kmIoz8EcCSoB/preview",

          "ã‚¸ãƒ¥ãƒ‹ã‚¢åŸºæœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ":
            "https://drive.google.com/file/d/1VrQnzT5A_w2HutCnF2pMgtawMndCixsV/preview",

          "å¤šäººæ•°ã®ç·´ç¿’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ":
            "https://drive.google.com/file/d/1Rnb1FwQhnizYEeF2Z6SuFYghcU6RbCEc/preview"
        };

        function applyTemplate() {
          const val = document.getElementById("templateSelect").value;
          const viewer = document.getElementById("templateViewer");

          if (val && templates[val]) {
            viewer.src = templates[val];
            viewer.style.display = "block";
          } else {
            viewer.src = "";
            viewer.style.display = "none";
          }
        }

        window.addEventListener("DOMContentLoaded", () => {
          const select = document.getElementById("templateSelect");

          Object.keys(templates).forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });
        });

        document.getElementById("random-btn").addEventListener("click", async () => {
          if (!sheetData.length) await loadSheet();

          // â–¼ ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§1ã¤ã ã‘å–å¾—ã™ã‚‹
          let selectedCategory = null;

          if (document.getElementById("random-knock").checked) selectedCategory = "ãƒãƒƒã‚¯ç³»";
          if (document.getElementById("random-rally").checked) selectedCategory = "ãƒ©ãƒªãƒ¼ç³»";
          if (document.getElementById("random-strength").checked) selectedCategory = "è£œå¼·";

          if (!selectedCategory) {
            return alert("ã‚«ãƒ†ã‚´ãƒªã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„\nPlease select one category.");
          }

          // â–¼ è©²å½“ã‚«ãƒ†ã‚´ãƒªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã ã‘æŠ½å‡º
          const candidates = sheetData.filter(m => m.ã‚«ãƒ†ã‚´ãƒª === selectedCategory);
          if (!candidates.length) return alert("è©²å½“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“");

          // â–¼ ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
          const randomMenu = candidates[Math.floor(Math.random() * candidates.length)];

          // â–¼ çµæœã‚’è¡¨ç¤º
          const container = document.getElementById("random-result");

          // ä¿®æ­£: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’å«ã‚ãŸHTMLã‚’ç”Ÿæˆï¼ˆposition: relative ã‚’è¦ªã«è¿½åŠ ã—ã€ãƒœã‚¿ãƒ³ã‚’ absolute ã§é…ç½®ï¼‰
          container.innerHTML = `
    <div style="background:#fff; border:1px solid #ccc; border-radius:6px; padding:15px 8px 8px 8px; margin-bottom:5px; position: relative;">
      
      <button id="close-random-result-btn" style="position: absolute; top: 5px; right: 5px; background: #9e9e9e; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; padding: 0;">Ã—</button>

      <strong>${randomMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}</strong>
      <div style="margin-top:5px; font-size:13px; color:#555; background:#fafafa; padding:6px; border-radius:4px;">
        ${randomMenu.èª¬æ˜ || "èª¬æ˜ã¯æº–å‚™ä¸­ã§ã™ã€‚"}
      </div>

      ${(selectedCategory === "ãƒ©ãƒªãƒ¼ç³»" || selectedCategory === "ãƒãƒƒã‚¯ç³»") ? `
        <div style="margin-top:6px;">
          æ™‚é–“ï¼ˆåˆ†ï¼‰: <input type="number" id="menu-time-input"
          value="${randomMenu["å¹³å‡æ™‚é–“ï¼ˆåˆ†ï¼‰"] || ""}" placeholder="5" style="width:50px;">
        </div>
      ` : ""}

      <button id="add-to-list-btn"
        style="margin-top:6px; background:#00796b; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px;">
        é¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ 
      </button>
    </div>

    <div style="background:#f0f0f0; border:1px solid #ccc; border-radius:6px; padding:6px; margin-top:10px;">
      <button id="toggle-purpose-btn"
        style="background:#00796b; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:12px;">
        ä½¿ç”¨ç”¨é€”ã‚’è¡¨ç¤º
      </button>
      <ul id="usage-list" style="display:none; margin-top:6px; font-size:12px; color:#333; padding-left:18px;">
        <li>è‡ªåˆ†ã§ã¯é¸ã°ãªã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå‡ºã‚‹ã“ã¨ã§æ–°ãŸãªæ°—ã¥ããŒå¾—ã‚‰ã‚Œã‚‹</li>
        <li>æŠ½å‡ºã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ç™ºå±•ç·´ç¿’ã‚’è€ƒãˆã‚‹</li>
        <li>è£œå¼·ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®åã‚Šã‚’ãªãã™</li>
        <li>ä¼è¨€ã‚²ãƒ¼ãƒ ï¼ˆæŠ½å‡ºã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¼ãˆã‚‹ï¼‰ã§èª¬æ˜åŠ›ã‚‚é›ãˆã‚‰ã‚Œã‚‹</li>
        <li>æ¥½ã—ã¿ãªãŒã‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã§ãã‚‹</li>
      </ul>
    </div>
  `;

          // â˜… è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
          document.getElementById("close-random-result-btn").addEventListener("click", () => {
            container.innerHTML = ""; // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹
          });

          // â–¼ ä½¿ç”¨ç”¨é€”ã®æŠ˜ã‚ŠãŸãŸã¿
          document.getElementById("toggle-purpose-btn").addEventListener("click", () => {
            const usage = document.getElementById("usage-list");
            usage.style.display = usage.style.display === "none" ? "block" : "none";
          });

          // â–¼ é¸æŠãƒªã‚¹ãƒˆã¸è¿½åŠ 
          document.getElementById("add-to-list-btn").addEventListener("click", () => {
            let inputTime = randomMenu["å¹³å‡æ™‚é–“ï¼ˆåˆ†ï¼‰"] || 5;

            if (selectedCategory === "ãƒ©ãƒªãƒ¼ç³»" || selectedCategory === "ãƒãƒƒã‚¯ç³»") {
              const timeInput = document.getElementById("menu-time-input");
              if (timeInput?.value) {
                inputTime = parseInt(timeInput.value, 10);
              }
            }

            selectedMenus.push({
              category: randomMenu.ã‚«ãƒ†ã‚´ãƒª,
              name: randomMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å,
              sets: "",
              perSet: 0,
              time: inputTime,
              url: randomMenu["YouTube URL"] || "",
              note: randomMenu.èª¬æ˜ || ""
            });

            renderSelectedList();
            alert(`ã€Œ${randomMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å}ã€ã‚’é¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
          });
        });

        let audioCtx;
        function playBeep(frequency = 440, duration = 200, type = "sine") {
          if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.type = type;
          osc.frequency.value = frequency;
          gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
          osc.start();
          osc.stop(audioCtx.currentTime + duration / 1000);
        }

        // ã‚¹ãƒãƒ¼ãƒ„ç”¨å¤ªé¼“ï¼‹ä¸­é«˜éŸ³1ç§’
        function playSportsDrum() {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const now = audioCtx.currentTime;

          // å¤ªé¼“ä½éŸ³éƒ¨åˆ†ï¼ˆãƒ‘ãƒ³ãƒæ„Ÿï¼‰
          const drumOsc = audioCtx.createOscillator();
          const drumGain = audioCtx.createGain();
          drumOsc.type = "triangle";
          drumOsc.frequency.setValueAtTime(120, now);
          drumOsc.frequency.exponentialRampToValueAtTime(70, now + 0.3);
          drumGain.gain.setValueAtTime(0.8, now);
          drumGain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
          drumOsc.connect(drumGain);
          drumGain.connect(audioCtx.destination);
          drumOsc.start(now);
          drumOsc.stop(now + 0.3);

          // æ˜ã‚‹ã‚ä¸­é«˜éŸ³éƒ¨åˆ†ï¼ˆå±‹å¤–ã§ã‚‚èã“ãˆã‚‹ï¼‰
          const hiOsc = audioCtx.createOscillator();
          const hiGain = audioCtx.createGain();
          hiOsc.type = "sine";
          hiOsc.frequency.setValueAtTime(600, now);
          hiGain.gain.setValueAtTime(0.5, now);
          hiGain.gain.exponentialRampToValueAtTime(0.001, now + 0.7);
          hiOsc.connect(hiGain);
          hiGain.connect(audioCtx.destination);
          hiOsc.start(now);
          hiOsc.stop(now + 0.7);
        }

        // çµ‚äº†æ™‚ãƒ–ã‚¶ãƒ¼éŸ³
        function playBuzz(duration = 1000, frequency = 800) {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const now = audioCtx.currentTime;

          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = "square";
          osc.frequency.setValueAtTime(frequency, now);
          gain.gain.setValueAtTime(0.5, now);
          gain.gain.exponentialRampToValueAtTime(0.001, now + duration / 1000);

          osc.connect(gain);
          gain.connect(audioCtx.destination);

          osc.start(now);
          osc.stop(now + duration / 1000);
        }

        // --- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡ç”¨ ---
        let pTimerStepCount = 0;
        let pTimerTimeout = null;
        let pTimerRemaining = 0;
        let pTimerCurrentSet = 1;
        let pTimerCurrentStep = 0;
        let pTimerSteps = [];
        let pTimerTotalSets = 0;

        // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒœã‚¿ãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹é–¢æ•°
        function setupProgramTimer() {
          const startBtn = document.getElementById("start-timer");
          const stopBtn = document.getElementById("stop-timer");
          const resetBtn = document.getElementById("reset-timer");
          const addStepBtn = document.getElementById("add-step");

          if (startBtn) startBtn.onclick = startPTimer;
          if (stopBtn) stopBtn.onclick = stopPTimer;
          if (resetBtn) resetBtn.onclick = resetPTimer;
          if (addStepBtn) addStepBtn.onclick = addPTimerStep;

          // æœ€åˆã«1ã¤å…¥åŠ›æ¬„ã‚’ä½œã£ã¦ãŠã
          addPTimerStep();
        }

        function addPTimerStep() {
          pTimerStepCount++;
          const container = document.getElementById("steps-container");
          if (!container) return;
          const div = document.createElement("div");
          div.style.marginBottom = "5px";
          div.innerHTML = `
        <input type="number" class="step-input" placeholder="ç§’æ•°" style="width:80px; padding:5px;">
        <button type="button" onclick="this.parentElement.remove()" style="background:#f44336; padding:5px;">å‰Šé™¤</button>
    `;
          container.appendChild(div);
        }

        function startPTimer() {
          if (pTimerTimeout) return;
          pTimerSteps = [];
          document.querySelectorAll(".step-input").forEach(input => {
            const val = parseInt(input.value);
            if (val && val > 0) pTimerSteps.push(val);
          });
          pTimerTotalSets = parseInt(document.getElementById("set-count").value) || 1;

          if (pTimerSteps.length === 0) {
            alert("ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆç§’æ•°ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          pTimerCurrentSet = 1;
          pTimerCurrentStep = 0;
          runPTimerNext();
        }

        function runPTimerNext() {
          if (pTimerCurrentStep >= pTimerSteps.length) {
            if (typeof playBuzz === 'function') playBuzz(800, 800);
            pTimerCurrentSet++;
            pTimerCurrentStep = 0;
            if (pTimerCurrentSet > pTimerTotalSets) {
              document.getElementById("time-left").textContent = "çµ‚äº†";
              if (typeof playBuzz === 'function') playBuzz(1000, 1000);
              pTimerTimeout = null;
              return;
            }
          }
          pTimerRemaining = pTimerSteps[pTimerCurrentStep];
          const t = (translations && translations[currentLang]) ? translations[currentLang] : { currentSet: "Set", currentStep: "Step" };
          document.getElementById("current-set").textContent = `${t.currentSet || 'Set'} ${pTimerCurrentSet} / ${pTimerTotalSets}`;
          document.getElementById("step-info").textContent = `${t.currentStep || 'Step'} ${pTimerCurrentStep + 1}`;
          if (typeof playSportsDrum === 'function') playSportsDrum();
          tickPTimer();
        }

        function tickPTimer() {
          document.getElementById("time-left").textContent = formatPTimerTime(pTimerRemaining);
          if (pTimerRemaining > 0) {
            pTimerRemaining--;
            pTimerTimeout = setTimeout(tickPTimer, 1000);
          } else {
            pTimerCurrentStep++;
            runPTimerNext();
          }
        }

        function stopPTimer() {
          if (pTimerTimeout) {
            clearTimeout(pTimerTimeout);
            pTimerTimeout = null;
          }
        }

        function resetPTimer() {
          stopPTimer();
          document.getElementById("time-left").textContent = "00:00";
          document.getElementById("current-set").textContent = "Set 1 / 1";
          document.getElementById("step-info").textContent = "Step 1";
          pTimerCurrentSet = 1;
          pTimerCurrentStep = 0;
        }

        function formatPTimerTime(sec) {
          const m = Math.floor(sec / 60);
          const s = sec % 60;
          return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        }
      </script>

      <script>
        // ============================================================
        // âœ… è‹±èªãƒ•ãƒ¬ãƒ¼ã‚ºæ©Ÿèƒ½
        // ============================================================

        let allPhrases = [];  // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        let speechRate = 1.0; // èª­ã¿ä¸Šã’é€Ÿåº¦

        // ------------------------------------------------
        // 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸåŒ–ï¼‰
        // ------------------------------------------------
        async function loadEnglishPhrases() {
          const loadingEl = document.getElementById("english-loading");

          try {
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            // â€» SHEET_URL ã¯æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å‰æã§ã™
            const res = await fetch(SHEET_URL + "?sheet=English");
            const data = await res.json();

            if (data.error) {
              throw new Error("English sheet not found");
            }

            allPhrases = data;
            loadingEl.style.display = "none";

            // åˆæœŸçŠ¶æ…‹ï¼šãƒªã‚¹ãƒˆã¯é–‰ã˜ã¦ãŠãï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼‰
            closeEnglishList();

          } catch (error) {
            console.error("English Load Error:", error);
            loadingEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            loadingEl.style.color = "red";
          }
        }

        // ------------------------------------------------
        // 2. ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹ï¼ˆåˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼‰
        // ------------------------------------------------
        function closeEnglishList() {
          // ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æˆ»ã™
          const listEl = document.getElementById("phrase-list");
          if (listEl) {
            listEl.innerHTML =
              `<p style="text-align:center; color:#666; padding: 20px; background:#f9f9f9; border-radius:8px; margin-top: 10px;">
                ğŸ‘† ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„
             </p>`;
          }

          // ãƒœã‚¿ãƒ³ã®è‰²ã‚’ã™ã¹ã¦æœªé¸æŠï¼ˆç™½ï¼‰ã«æˆ»ã™
          const tabs = document.querySelectorAll(".phrase-tab");
          tabs.forEach(btn => {
            btn.style.background = "#fff";
            btn.style.border = "1px solid #ccc";
            btn.style.color = "#666";
            btn.style.fontWeight = "normal";
          });
        }

        // ------------------------------------------------
        // 3. ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        // ------------------------------------------------
        function filterPhrases(category) {
          // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (!allPhrases || allPhrases.length === 0) return;

          // ã‚¿ãƒ–ã®ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ
          const tabs = document.querySelectorAll(".phrase-tab");
          tabs.forEach(btn => {
            // onclickå±æ€§ã«ã‚«ãƒ†ã‚´ãƒªåãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã§åˆ¤å®š
            if (btn.getAttribute("onclick") && btn.getAttribute("onclick").includes(category)) {
              btn.style.background = "#e8eaf6";
              btn.style.border = "2px solid #3f51b5";
              btn.style.color = "#3f51b5";
              btn.style.fontWeight = "bold";
            } else {
              btn.style.background = "#fff";
              btn.style.border = "1px solid #ccc";
              btn.style.color = "#666";
              btn.style.fontWeight = "normal";
            }
          });

          const listEl = document.getElementById("phrase-list");
          const filtered = allPhrases.filter(p => p.category === category);

          // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
          if (filtered.length === 0) {
            listEl.innerHTML = `
            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="closeEnglishList()" style="background: #9e9e9e; color: white; border: none; border-radius: 4px; padding: 4px 12px; cursor: pointer; font-size: 12px;">Ã— é–‰ã˜ã‚‹</button>
            </div>
            <p style="text-align:center; color:#777; padding:20px;">ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚·ãƒ¼ãƒˆã«ã‚«ãƒ†ã‚´ãƒªå(practice/coaching/communication)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        `;
            return;
          }

          // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®HTML
          const closeBtnHtml = `
        <div style="text-align: right; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; position: sticky; top: 0; background: #fff; z-index: 10;">
            <button onclick="closeEnglishList()" style="background: #757575; color: white; border: none; border-radius: 4px; padding: 5px 15px; cursor: pointer; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                Ã— ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
            </button>
        </div>
    `;

          // ãƒªã‚¹ãƒˆã®ç”Ÿæˆ
          let html = filtered.map(item => {
            // ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
            let enRaw = item.en ? item.en.toString() : "";
            enRaw = enRaw.replace(/â€™/g, "'");     // ã‚¹ãƒãƒ¼ãƒˆã‚¯ã‚©ãƒ¼ãƒˆå¤‰æ›
            enRaw = enRaw.replace(/[\r\n]+/g, " "); // æ”¹è¡Œå‰Šé™¤
            const enText = enRaw.trim();

            const jaText = item.ja || "";
            const noteText = item.note || "";

            // URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒã‚¹ãƒˆãƒ­ãƒ•ã‚£å¯¾ç­–å«ã‚€ï¼‰
            const safeEncodedText = encodeURIComponent(enText).replace(/'/g, "%27");

            // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆè‹±èªãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
            const speakerButton = enText
              ? `<button onclick="speakText('${safeEncodedText}', 'en-US')" 
                    style="flex-shrink: 0; background: #3f51b5; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s;" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'">
                    ğŸ”Š
               </button>`
              : `<div style="width:44px; height:44px;"></div>`;

            return `
            <div style="display: flex; align-items: center; justify-content: space-between; background: #fafafa; margin-bottom: 8px; padding: 12px; border-radius: 8px; border-left: 4px solid #ddd; transition: background 0.2s;" onmouseover="this.style.background='#f0f4c3'" onmouseout="this.style.background='#fafafa'">
                <div style="flex: 1; padding-right:10px;">
                    <p style="margin: 0; font-size:16px; font-weight: bold; color: #333; font-family: sans-serif;">${enText}</p>
                    <p style="margin: 4px 0 0; font-size: 13px; color: #666;">
                        ${jaText} ${noteText ? `<span style="font-size:11px; background:#e0e0e0; color:#444; padding:1px 5px; border-radius:4px; margin-left:6px;">${noteText}</span>` : ""}
                    </p>
                </div>
                ${speakerButton}
            </div>
        `;
          }).join("");

          listEl.innerHTML = closeBtnHtml + html;
        }

        // ------------------------------------------------
        // 4. éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆé€Ÿåº¦èª¿æ•´ãƒ»ã‚¨ãƒ©ãƒ¼å¯¾ç­–æ¸ˆã¿ï¼‰
        // ------------------------------------------------
        function speakText(encodedText, lang = 'en-US') {
          window.speechSynthesis.cancel(); // å‰ã®éŸ³å£°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

          let text = decodeURIComponent(encodedText);
          if (!text) return;

          // â–¼â–¼â–¼ ä¿®æ­£: [ ] ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ï¼ˆã‚«ãƒ†ã‚´ãƒªåï¼‰ã‚’å‰Šé™¤ã™ã‚‹ â–¼â–¼â–¼
          // æ­£è¦è¡¨ç¾: [ä»»æ„ã®æ–‡å­—] ã‚’ç©ºæ–‡å­—ã«ç½®æ›
          text = text.replace(/\[.*?\]/g, "").trim();
          // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

          if (!('speechSynthesis' in window)) {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            return;
          }

          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = lang;
          utterance.rate = speechRate; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ä½¿ç”¨

          // æœ€é©ãªãƒœã‚¤ã‚¹ã‚’é¸æŠ
          const voices = window.speechSynthesis.getVoices();
          const targetVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google'))
            || voices.find(v => v.lang === 'en-US')
            || voices.find(v => v.lang.startsWith('en'));

          if (targetVoice) utterance.voice = targetVoice;

          // å°‘ã—é…å»¶ã•ã›ã¦å®‰å®šå†ç”Ÿ
          setTimeout(() => {
            window.speechSynthesis.speak(utterance);
          }, 10);
        }

        // ------------------------------------------------
        // 5. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        // ------------------------------------------------
        document.addEventListener("DOMContentLoaded", () => {
          // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
          loadEnglishPhrases();

          // é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ç›£è¦–
          const slider = document.getElementById("speech-rate");
          if (slider) {
            slider.addEventListener("input", (e) => {
              speechRate = parseFloat(e.target.value);
              const rateVal = document.getElementById("rate-value");
              if (rateVal) rateVal.textContent = speechRate.toFixed(1);
            });
          }

          // ãƒœã‚¤ã‚¹ãƒªã‚¹ãƒˆã®äº‹å‰ãƒ­ãƒ¼ãƒ‰
          window.speechSynthesis.getVoices();
        });


        // ===========================
        // âœ… ã‚¯ã‚¤ã‚º & ãƒªã‚¹ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½
        // ===========================

        let quizData = [];
        let currentQuizList = [];
        let currentQuizIndex = 0;
        let quizScore = 0;
        let currentMode = 'normal'; // 'normal' or 'listening'

        // 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆå…±é€šï¼‰
        async function loadQuizData() {
          const qStatus = document.getElementById("quiz-status-msg");
          const lStatus = document.getElementById("listening-status-msg");
          const qBtn = document.getElementById("start-quiz-btn");
          const lBtn = document.getElementById("start-listening-btn");

          // ä¸¡æ–¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          if (qStatus) qStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";
          if (lStatus) lStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";

          try {
            const res = await fetch(SHEET_URL + "?sheet=Quiz&t=" + new Date().getTime());
            const data = await res.json();

            if (data.error || !data.length) {
              throw new Error(data.error || "ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");
            }

            quizData = data;
            const msg = `æº–å‚™å®Œäº† (å…¨${quizData.length}å•)`;

            if (qStatus) qStatus.textContent = msg;
            if (lStatus) lStatus.textContent = msg;

            if (qBtn) { qBtn.disabled = false; qBtn.style.opacity = "1"; }
            if (lBtn) { lBtn.disabled = false; lBtn.style.opacity = "1"; }

          } catch (error) {
            console.error("Quiz Load Error:", error);
            const errMsg = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼";
            if (qStatus) qStatus.textContent = errMsg;
            if (lStatus) lStatus.textContent = errMsg;
          }
        }

        // 2. é–‹å§‹å‡¦ç†ï¼ˆãƒ¢ãƒ¼ãƒ‰æŒ‡å®šï¼‰
        function startQuiz(mode = 'normal') {
          if (quizData.length === 0) return;
          currentMode = mode;
          quizScore = 0;
          currentQuizIndex = 0;

          // ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
          const shuffled = [...quizData].sort(() => 0.5 - Math.random());
          currentQuizList = shuffled.slice(0, 5);

          // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          if (currentMode === 'normal') {
            document.getElementById("quiz-start-screen").style.display = "none";
            document.getElementById("quiz-result-screen").style.display = "none";
            document.getElementById("quiz-play-screen").style.display = "block";
          } else {
            document.getElementById("listening-start-screen").style.display = "none";
            document.getElementById("listening-result-screen").style.display = "none";
            document.getElementById("listening-play-screen").style.display = "block";
          }

          showQuestion();
        }

        // 3. å•é¡Œè¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ†å²ï¼‰
        function showQuestion() {
          const q = currentQuizList[currentQuizIndex];
          const isListening = (currentMode === 'listening');

          // IDã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æ±ºå®š (quiz- ã¾ãŸã¯ listening-)
          const prefix = isListening ? "listening-" : "quiz-";

          // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
          document.getElementById(prefix + "count").textContent = `Q ${currentQuizIndex + 1} / ${currentQuizList.length}`;
          document.getElementById(prefix + "score").textContent = `Score: ${quizScore}`;

          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ã®ãƒªã‚»ãƒƒãƒˆ
          const fbDiv = document.getElementById(prefix + "feedback");
          fbDiv.style.display = "none";

          // â–¼â–¼â–¼ è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†å² â–¼â–¼â–¼
          if (isListening) {
            // --- ãƒªã‚¹ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ ---
            // ãƒ†ã‚­ã‚¹ãƒˆã¯è¡¨ç¤ºã›ãšã€å†ç”Ÿãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            const btn = document.getElementById("listening-speak-btn");
            // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰èª­ã¿ä¸Šã’
            btn.onclick = () => {
              const text = q.question;
              // è‹±èªã¨ã—ã¦èª­ã¿ä¸Šã’
              speakText(encodeURIComponent(text), 'en-US');
            };

            // å•é¡ŒãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰è‡ªå‹•ã§1å›èª­ã¿ä¸Šã’ã‚‹ã¨è¦ªåˆ‡ï¼ˆä»»æ„ï¼‰
            setTimeout(() => btn.click(), 500);

          } else {
            // --- é€šå¸¸ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ ---
            // å•é¡Œæ–‡ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const qContainer = document.getElementById("quiz-question");
            const safeEncodedText = encodeURIComponent(q.question).replace(/'/g, "%27");
            qContainer.innerHTML = `
            <div style="display:flex; align-items:center;">
                <span>${q.question}</span>
                <button onclick="speakText('${safeEncodedText}', 'en-US')" 
                    style="background: #3f51b5; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-left: 10px; font-size: 16px;">
                    ğŸ”Š
                </button>
            </div>
        `;
          }

          // é¸æŠè‚¢ã®ç”Ÿæˆ
          const optionsDiv = document.getElementById(prefix + "options");
          optionsDiv.innerHTML = "";

          const options = [
            { text: q.option1, id: 1 },
            { text: q.option2, id: 2 },
            { text: q.option3, id: 3 },
            { text: q.option4, id: 4 }
          ];

          options.forEach(opt => {
            if (!opt.text) return;
            const btn = document.createElement("button");
            btn.textContent = opt.text;

            // ãƒ‡ã‚¶ã‚¤ãƒ³
            btn.style.cssText = `
            padding: 12px; border: 2px solid #ddd; background: #fff; 
            color: #333; 
            border-radius: 6px; cursor: pointer; font-size: 14px; text-align: left;
            transition: all 0.2s;
        `;

            btn.onclick = () => checkAnswer(opt.id, q.answer, q.explanation, btn);
            optionsDiv.appendChild(btn);
          });
        }

        // 4. æ­£èª¤åˆ¤å®š
        function checkAnswer(selectedId, correctId, explanation, btnElement) {
          const isListening = (currentMode === 'listening');
          const prefix = isListening ? "listening-" : "quiz-";

          // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
          const allBtns = document.querySelectorAll(`#${prefix}options button`);
          allBtns.forEach(b => b.disabled = true);

          const isCorrect = (parseInt(selectedId) === parseInt(correctId));

          if (isCorrect) {
            btnElement.style.background = "#d4edda";
            btnElement.style.borderColor = "#28a745";
            btnElement.textContent += " â­•";
            quizScore++;
            if (typeof playSportsDrum === 'function') playSportsDrum();
          } else {
            btnElement.style.background = "#f8d7da";
            btnElement.style.borderColor = "#dc3545";
            btnElement.textContent += " âŒ";
            // æ­£è§£ã‚’è¡¨ç¤º
            allBtns[parseInt(correctId) - 1].style.background = "#d4edda";
            allBtns[parseInt(correctId) - 1].textContent += " (æ­£è§£)";
            if (typeof playBuzz === 'function') playBuzz(300, 200);
          }

          // è§£èª¬è¡¨ç¤º
          const fbDiv = document.getElementById(prefix + "feedback");
          const fbTitle = document.getElementById(prefix + "feedback-title");
          const fbText = document.getElementById(prefix + "feedback-text");

          fbDiv.style.display = "block";
          fbDiv.style.background = isCorrect ? "#e8f5e9" : "#ffebee";
          fbTitle.textContent = isCorrect ? "æ­£è§£ï¼" : "æ®‹å¿µ...";
          fbTitle.style.color = isCorrect ? "green" : "red";

          // ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã®å ´åˆã¯ã€ã“ã“ã§åˆã‚ã¦å•é¡Œæ–‡ã‚’è¦‹ã›ã‚‹ã¨å­¦ç¿’åŠ¹æœãŒé«˜ã„
          let feedbackContent = explanation || "";
          if (isListening) {
            feedbackContent = `ã€å•é¡Œæ–‡ã€‘${currentQuizList[currentQuizIndex].question}\n\n${feedbackContent}`;
          }

          fbText.innerText = feedbackContent; // innerTextã§æ”¹è¡Œåæ˜ 
        }

        // 5. æ¬¡ã¸
        function nextQuestion() {
          currentQuizIndex++;
          if (currentQuizIndex < currentQuizList.length) {
            showQuestion();
          } else {
            showResult();
          }
        }

        // 6. çµæœè¡¨ç¤º
        function showResult() {
          const isListening = (currentMode === 'listening');
          const prefix = isListening ? "listening-" : "quiz-";

          document.getElementById(prefix + "play-screen").style.display = "none";
          document.getElementById(prefix + "result-screen").style.display = "block";

          const scoreText = document.getElementById(prefix + "final-score");
          scoreText.textContent = `${currentQuizList.length}å•ä¸­ ${quizScore}å•æ­£è§£ï¼`;

          if (quizScore === currentQuizList.length && typeof playSportsDrum === 'function') {
            playSportsDrum();
          }
        }
      </script>

      <script>
        // ===========================
        // âœ… è‹±èªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        // ===========================
        function switchTab(tabName) {
          // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ ã®å–å¾—
          const phrasesContent = document.getElementById("content-phrases");
          const quizContent = document.getElementById("content-quiz");
          const listeningContent = document.getElementById("content-listening");

          // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼å›é¿
          if (!phrasesContent || !quizContent || !listeningContent) {
            console.error("Tab content elements not found!");
            return;
          }

          // ãƒœã‚¿ãƒ³è¦ç´ ã®å–å¾—
          const phrasesBtn = document.getElementById("tab-btn-phrases");
          const quizBtn = document.getElementById("tab-btn-quiz");
          const listeningBtn = document.getElementById("tab-btn-listening");

          // å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          phrasesContent.style.display = 'none';
          quizContent.style.display = 'none';
          listeningContent.style.display = 'none';

          // â–¼â–¼â–¼ ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ç”¨é–¢æ•°ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸çµ±ä¸€ï¼‰ â–¼â–¼â–¼
          const updateBtnStyle = (btn, isActive) => {
            if (!btn) return;
            if (isActive) {
              // é¸æŠä¸­ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ï¼šç™½èƒŒæ™¯ Ã— æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸æ–‡å­—
              btn.style.background = "#fff";
              btn.style.color = "#e65100";
              btn.style.fontWeight = "bold";
              btn.style.borderBottom = "none"; // ä¸‹ç·šã‚’æ¶ˆã—ã¦ä¸€ä½“æ„Ÿã‚’å‡ºã™ï¼ˆä»»æ„ï¼‰
            } else {
              // éé¸æŠï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ï¼šè–„ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ Ã— èŒ¶è‰²ã£ã½ã„æ–‡å­—
              btn.style.background = "#ffe0b2";
              btn.style.color = "#8d6e63";
              btn.style.fontWeight = "normal";
              btn.style.borderBottom = "1px solid #ffe0b2";
            }
          };

          // å„ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°ï¼ˆå…¨ã¦åŒã˜ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§çµ±ä¸€ï¼‰
          updateBtnStyle(phrasesBtn, tabName === 'phrases');
          updateBtnStyle(quizBtn, tabName === 'quiz');
          updateBtnStyle(listeningBtn, tabName === 'listening');

          // é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã ã‘è¡¨ç¤º
          if (tabName === 'phrases') {
            phrasesContent.style.display = "block";
          } else if (tabName === 'quiz') {
            quizContent.style.display = "block";
          } else if (tabName === 'listening') {
            listeningContent.style.display = "block";
          }
        }

        // ==========================================
        // âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½ (ã‚³ãƒ¼ãƒˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œç‰ˆ)
        // ==========================================

        let tacticCanvas, tCtx;
        let tacticMode = "move";
        let isDraggingTactic = false;
        let isDrawingTactic = false;
        let selectedTacticObj = null;

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
        let tacticObjects = [];
        let tacticLines = [];
        let tacticArrows = [];
        let tacticTexts = [];

        // ä½œæ¥­ç”¨
        let currentLine = null;
        let arrowStartPos = null;
        let arrowEndPos = null;

        // --- ã‚³ãƒ¼ãƒˆé–‹é–‰æ©Ÿèƒ½ ---
        function toggleTacticsCourt() {
          const area = document.getElementById("tactics-court-area");
          const icon = document.getElementById("court-toggle-icon");
          const textEl = document.getElementById("court-toggle-text");
          const t = translations[currentLang]; // ç¾åœ¨ã®è¨€èªè¨­å®šã‚’å–å¾—

          if (!area) return;

          if (area.style.display === "none" || area.style.display === "") {
            // é–‹ã
            area.style.display = "block";
            if (icon) icon.textContent = "â–²";
            if (textEl) textEl.textContent = t.btnHideCourt; // "ã‚³ãƒ¼ãƒˆã‚’éš ã™" / "Hide Court"

            // ã‚­ãƒ£ãƒ³ãƒã‚¹å†æç”»
            if (typeof drawTacticsBoard === "function") {
              requestAnimationFrame(() => {
                drawTacticsBoard();
              });
            }
          } else {
            // é–‰ã˜ã‚‹
            area.style.display = "none";
            if (icon) icon.textContent = "â–¼";
            if (textEl) textEl.textContent = t.btnShowCourt; // "ã‚³ãƒ¼ãƒˆã‚’è¡¨ç¤º" / "Show Court"
          }
        }

        // åˆæœŸåŒ–
        function initTacticsBoard() {
          tacticCanvas = document.getElementById("tacticsCanvas");
          if (!tacticCanvas) return;

          tCtx = tacticCanvas.getContext("2d");

          if (tacticObjects.length === 0) {
            resetTacticPositions();
          } else {
            drawTacticsBoard();
          }

          const events = ["mousedown", "mousemove", "mouseup", "mouseout", "touchstart", "touchmove", "touchend"];
          const handlers = [handleTacticStart, handleTacticMove, handleTacticEnd, handleTacticEnd, handleTacticStart, handleTacticMove, handleTacticEnd];

          events.forEach((ev, i) => {
            tacticCanvas.removeEventListener(ev, handlers[i]);
            tacticCanvas.addEventListener(ev, handlers[i], { passive: false });
          });
        }

        // ===========================
        // âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰å†…ï¼šã‚³ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®é–‹é–‰æ©Ÿèƒ½
        // ===========================
        function toggleTacticsCourt() {
          const area = document.getElementById("tactics-court-area");
          const icon = document.getElementById("court-toggle-icon"); // æ‰‹é †1ã§å¤‰æ›´ã—ãŸID

          if (!area) return;

          if (area.style.display === "none" || area.style.display === "") {
            // é–‹ãå‡¦ç†
            area.style.display = "block";
            if (icon) icon.textContent = "â–²";

            // â˜…é‡è¦: ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºå´©ã‚Œã‚’é˜²ããŸã‚å†æç”»
            if (typeof drawTacticsBoard === "function") {
              requestAnimationFrame(() => {
                drawTacticsBoard();
              });
            }
          } else {
            // é–‰ã˜ã‚‹å‡¦ç†
            area.style.display = "none";
            if (icon) icon.textContent = "â–¼";
          }
        }

        // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ç®¡ç†å¤‰æ•° ('doubles' or 'singles')
        let currentTacticMode = 'doubles';

        // â–¼â–¼â–¼ 1. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿é–¢æ•° (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼
        function switchGameMode(mode) {
          currentTacticMode = mode;

          const customSettings = document.getElementById("custom-tactic-settings");
          const fixedInputs = document.getElementById("fixed-name-inputs");

          // å¤‰å‰‡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
          if (mode === 'custom') {
            if (customSettings) customSettings.style.display = "flex";
            if (fixedInputs) fixedInputs.style.display = "none";
          }
          // ãƒ€ãƒ–ãƒ«ã‚¹ãƒ»ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã®å ´åˆ
          else {
            if (customSettings) customSettings.style.display = "none";
            if (fixedInputs) fixedInputs.style.display = "flex";

            // ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãªã‚‰Bã¨Yã®å…¥åŠ›ã‚’éš ã™
            const displayStyle = (mode === 'singles') ? 'none' : 'inline-block';
            const containerB = document.getElementById("container-name-B");
            const containerY = document.getElementById("container-name-Y");

            if (containerB) containerB.style.display = displayStyle;
            if (containerY) containerY.style.display = displayStyle;
          }

          // ã‚³ãƒã‚’å†é…ç½®
          resetTacticPositions();
        }

        // 2. ã‚³ãƒã®é…ç½®ãƒªã‚»ãƒƒãƒˆ
        function resetTacticPositions() {
          tacticObjects = []; // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ

          if (currentTacticMode === 'custom') {
            // --- å¤‰å‰‡ãƒ¢ãƒ¼ãƒ‰ (è‡ªç”±äººæ•°) ---
            const redCount = parseInt(document.getElementById("custom-red-count").value) || 1;
            const blueCount = parseInt(document.getElementById("custom-blue-count").value) || 1;

            // èµ¤ãƒãƒ¼ãƒ  (æ‰‹å‰ y=400) ã‚’æ¨ªã«ä¸¦ã¹ã‚‹
            const redStartX = 400 / (redCount + 1);
            for (let i = 0; i < redCount; i++) {
              tacticObjects.push({
                id: `R${i}`,
                x: redStartX * (i + 1),
                y: 400,
                color: "red",
                label: (i + 1).toString(), // æ•°å­—ã‚’è¡¨ç¤º
                radius: 15
              });
            }

            // é’ãƒãƒ¼ãƒ  (å¥¥ y=150) ã‚’æ¨ªã«ä¸¦ã¹ã‚‹
            const blueStartX = 400 / (blueCount + 1);
            for (let i = 0; i < blueCount; i++) {
              tacticObjects.push({
                id: `B${i}`,
                x: blueStartX * (i + 1),
                y: 150,
                color: "blue",
                label: (i + 1).toString(), // æ•°å­—ã‚’è¡¨ç¤º
                radius: 15
              });
            }

          } else {
            // --- æ—¢å­˜ã®å›ºå®šãƒ¢ãƒ¼ãƒ‰ (åå‰å…¥åŠ›ã‚ã‚Š) ---
            const nameA = document.getElementById("input-name-A") ? document.getElementById("input-name-A").value : "A";
            const nameB = document.getElementById("input-name-B") ? document.getElementById("input-name-B").value : "B";
            const nameX = document.getElementById("input-name-X") ? document.getElementById("input-name-X").value : "X";
            const nameY = document.getElementById("input-name-Y") ? document.getElementById("input-name-Y").value : "Y";

            if (currentTacticMode === 'singles') {
              // ã‚·ãƒ³ã‚°ãƒ«ã‚¹é…ç½®
              tacticObjects = [
                { id: "A", x: 200, y: 400, color: "red", label: nameA || "A", radius: 15 },
                { id: "X", x: 200, y: 150, color: "blue", label: nameX || "X", radius: 15 }
              ];
            } else {
              // ãƒ€ãƒ–ãƒ«ã‚¹é…ç½®
              tacticObjects = [
                { id: "A", x: 100, y: 400, color: "red", label: nameA || "A", radius: 15 },
                { id: "B", x: 300, y: 400, color: "red", label: nameB || "B", radius: 15 },
                { id: "X", x: 100, y: 150, color: "blue", label: nameX || "X", radius: 15 },
                { id: "Y", x: 300, y: 150, color: "blue", label: nameY || "Y", radius: 15 }
              ];
            }
          }

          // æç”»æ›´æ–°
          drawTacticsBoard();
        }

        // â€» updatePlayerLabelsé–¢æ•°ã¯ãã®ã¾ã¾ã§OKã§ã™ãŒã€å¿µã®ãŸã‚å†æ²ã—ã¾ã™ï¼ˆå¤‰æ›´ãªã—ï¼‰
        function updatePlayerLabels() {
          const nameA = document.getElementById("input-name-A").value;
          const nameB = document.getElementById("input-name-B").value;
          const nameX = document.getElementById("input-name-X").value;
          const nameY = document.getElementById("input-name-Y").value;

          tacticObjects.forEach(obj => {
            if (obj.id === "A") obj.label = nameA || "A";
            if (obj.id === "B") obj.label = nameB || "B";
            if (obj.id === "X") obj.label = nameX || "X";
            if (obj.id === "Y") obj.label = nameY || "Y";
          });
          drawTacticsBoard();
        }

        function clearTacticLines() {
          tacticLines = [];
          tacticArrows = [];
          tacticTexts = [];
          drawTacticsBoard();
        }

        function saveTacticsImage() {
          if (!tacticCanvas) return;
          const image = tacticCanvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.href = image;
          link.download = "tactics_board.png";
          link.click();
        }

        function setTacticMode(mode) {
          tacticMode = mode;
          if (!tacticCanvas) return;
          drawTacticsBoard(); // å†æç”»

          if (mode === "move") tacticCanvas.style.cursor = "grab";
          else if (mode === "text") tacticCanvas.style.cursor = "text";
          else if (mode === "eraser") tacticCanvas.style.cursor = "not-allowed";
          else tacticCanvas.style.cursor = "crosshair";
        }

        // ----------------------
        // æç”»å‡¦ç†
        // ----------------------
        function drawTacticsBoard() {
          if (!tCtx) return;
          const W = tacticCanvas.width;
          const H = tacticCanvas.height;

          tCtx.clearRect(0, 0, W, H);

          // èƒŒæ™¯
          tCtx.fillStyle = "#2e7d32";
          tCtx.fillRect(0, 0, W, H);

          // ã‚³ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³
          drawCourtLines();

          // ç·š
          [...tacticLines, currentLine].forEach(line => {
            if (!line || line.points.length < 2) return;
            tCtx.beginPath();
            tCtx.strokeStyle = line.color;
            tCtx.lineWidth = line.width;
            tCtx.lineCap = "round";
            tCtx.moveTo(line.points[0].x, line.points[0].y);
            for (let i = 1; i < line.points.length; i++) tCtx.lineTo(line.points[i].x, line.points[i].y);
            tCtx.stroke();
          });

          // çŸ¢å°
          tCtx.lineWidth = 3;
          tacticArrows.forEach(arrow => {
            if (tacticMode === "move") {
              tCtx.strokeStyle = "rgba(255, 255, 255, 0.4)";
              tCtx.lineWidth = 10;
              drawArrowPath(arrow.start, arrow.end);
              tCtx.stroke();
            }
            tCtx.strokeStyle = "yellow";
            tCtx.fillStyle = "yellow";
            tCtx.lineWidth = 3;
            drawArrow(arrow.start, arrow.end);
          });

          if (tacticMode === "arrow" && isDrawingTactic && arrowStartPos && arrowEndPos) {
            tCtx.strokeStyle = "yellow";
            tCtx.fillStyle = "yellow";
            tCtx.lineWidth = 3;
            drawArrow(arrowStartPos, arrowEndPos);
          }

          // ãƒ†ã‚­ã‚¹ãƒˆ
          tCtx.font = "bold 16px sans-serif";
          tCtx.textAlign = "center";
          tCtx.textBaseline = "middle";

          tacticTexts.forEach(t => {
            if (tacticMode === "move") {
              const m = tCtx.measureText(t.text);
              const padding = 10;
              tCtx.fillStyle = "rgba(255, 255, 255, 0.3)";
              tCtx.fillRect(t.x - m.width / 2 - padding, t.y - 15, m.width + padding * 2, 30);
              tCtx.strokeStyle = "rgba(255, 255, 255, 0.8)";
              tCtx.lineWidth = 1;
              tCtx.strokeRect(t.x - m.width / 2 - padding, t.y - 15, m.width + padding * 2, 30);
            }
            tCtx.fillStyle = "white";
            tCtx.fillText(t.text, t.x, t.y);
          });

          // ã‚³ãƒ
          tacticObjects.forEach(obj => {
            tCtx.beginPath();
            tCtx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2);
            tCtx.fillStyle = obj.color;
            tCtx.fill();
            tCtx.strokeStyle = "white";
            tCtx.lineWidth = 2;
            tCtx.stroke();
            if (obj.label) {
              tCtx.fillStyle = "white";
              tCtx.font = "bold 14px Arial";
              tCtx.textAlign = "center";
              tCtx.textBaseline = "middle";
              tCtx.fillText(obj.label, obj.x, obj.y);
            }
          });
        }

        function drawCourtLines() {
          if (!tCtx) return;
          const W = tacticCanvas.width;
          const H = tacticCanvas.height;
          const pad = 20;
          const shortDist = 60;
          const sideDist = 25;
          const backDist = 25;

          tCtx.strokeStyle = "white";
          tCtx.lineWidth = 2;
          tCtx.beginPath();

          tCtx.strokeRect(pad, pad, W - pad * 2, H - pad * 2);
          tCtx.moveTo(pad, H / 2); tCtx.lineTo(W - pad, H / 2);
          tCtx.moveTo(pad, H / 2 - shortDist); tCtx.lineTo(W - pad, H / 2 - shortDist);
          tCtx.moveTo(pad, H / 2 + shortDist); tCtx.lineTo(W - pad, H / 2 + shortDist);
          tCtx.moveTo(W / 2, pad); tCtx.lineTo(W / 2, H / 2 - shortDist);
          tCtx.moveTo(W / 2, H / 2 + shortDist); tCtx.lineTo(W / 2, H - pad);
          tCtx.strokeRect(pad + sideDist, pad, W - (pad + sideDist) * 2, H - pad * 2);
          tCtx.moveTo(pad, pad + backDist); tCtx.lineTo(W - pad, pad + backDist);
          tCtx.moveTo(pad, H - pad - backDist); tCtx.lineTo(W - pad, H - pad - backDist);
          tCtx.stroke();
        }

        function drawArrowPath(from, to) {
          tCtx.beginPath();
          tCtx.moveTo(from.x, from.y);
          tCtx.lineTo(to.x, to.y);
        }

        function drawArrow(from, to) {
          const headLength = 15;
          const dx = to.x - from.x;
          const dy = to.y - from.y;
          const angle = Math.atan2(dy, dx);
          tCtx.beginPath();
          tCtx.moveTo(from.x, from.y); tCtx.lineTo(to.x, to.y); tCtx.stroke();
          tCtx.beginPath();
          tCtx.moveTo(to.x, to.y);
          tCtx.lineTo(to.x - headLength * Math.cos(angle - Math.PI / 6), to.y - headLength * Math.sin(angle - Math.PI / 6));
          tCtx.lineTo(to.x - headLength * Math.cos(angle + Math.PI / 6), to.y - headLength * Math.sin(angle + Math.PI / 6));
          tCtx.lineTo(to.x, to.y); tCtx.fill();
        }

        // ----------------------
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        // ----------------------
        let lastPos = { x: 0, y: 0 };

        function getPos(e) {
          const rect = tacticCanvas.getBoundingClientRect();
          let cx = e.clientX, cy = e.clientY;
          if (e.touches && e.touches.length > 0) {
            cx = e.touches[0].clientX; cy = e.touches[0].clientY;
          }
          const scaleX = tacticCanvas.width / rect.width;
          const scaleY = tacticCanvas.height / rect.height;
          return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
        }

        function getDistanceToSegment(p, v, w) {
          const l2 = (v.x - w.x) ** 2 + (v.y - w.y) ** 2;
          if (l2 === 0) return Math.sqrt((p.x - v.x) ** 2 + (p.y - v.y) ** 2);
          let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
          t = Math.max(0, Math.min(1, t));
          const proj = { x: v.x + t * (w.x - v.x), y: v.y + t * (w.y - v.y) };
          return Math.sqrt((p.x - proj.x) ** 2 + (p.y - proj.y) ** 2);
        }

        function checkHitObject(pos) {
          // 1. ã‚³ãƒ
          for (let i = tacticObjects.length - 1; i >= 0; i--) {
            const obj = tacticObjects[i];
            if (Math.sqrt((pos.x - obj.x) ** 2 + (pos.y - obj.y) ** 2) <= obj.radius + 15) {
              return { type: 'obj', item: obj };
            }
          }
          // 2. æ–‡å­—
          tCtx.font = "bold 16px sans-serif";
          for (let i = tacticTexts.length - 1; i >= 0; i--) {
            const t = tacticTexts[i];
            const metrics = tCtx.measureText(t.text);
            const w = metrics.width;
            const padding = 15;
            if (pos.x >= t.x - w / 2 - padding && pos.x <= t.x + w / 2 + padding &&
              pos.y >= t.y - 15 - padding && pos.y <= t.y + 15 + padding) {
              return { type: 'text', item: t };
            }
          }
          // 3. çŸ¢å°
          for (let i = tacticArrows.length - 1; i >= 0; i--) {
            const arrow = tacticArrows[i];
            const dist = getDistanceToSegment(pos, arrow.start, arrow.end);
            if (dist < 15) return { type: 'arrow', item: arrow };
          }
          return null;
        }

        function handleTacticStart(e) {
          e.preventDefault();
          const pos = getPos(e);
          lastPos = pos;

          if (tacticMode === "move") {
            const targetData = checkHitObject(pos);
            if (targetData) {
              isDraggingTactic = true;
              selectedTacticObj = targetData;
              tacticCanvas.style.cursor = "grabbing";
            }
          } else if (tacticMode === "draw") {
            isDrawingTactic = true;
            currentLine = { color: "yellow", width: 3, points: [pos] };
          } else if (tacticMode === "arrow") {
            isDrawingTactic = true;
            arrowStartPos = pos; arrowEndPos = pos;
          } else if (tacticMode === "text") {
            const text = prompt("å…¥åŠ›ã—ãŸã„æ–‡å­—ã‚’å…¥ã‚Œã¦ãã ã•ã„:");
            if (text) {
              tacticTexts.push({ x: pos.x, y: pos.y, text: text });
              tacticMode = "move";
              const moveRadio = document.querySelector('input[name="tactic-mode"][value="move"]');
              if (moveRadio) moveRadio.checked = true;
              setTacticMode("move");
            }
          } else if (tacticMode === "eraser") {
            isDrawingTactic = true;
            eraseObjectAt(pos);
          }
        }

        function handleTacticMove(e) {
          e.preventDefault();
          const pos = getPos(e);

          if (tacticMode === "move" && !isDraggingTactic) {
            const target = checkHitObject(pos);
            tacticCanvas.style.cursor = target ? "grab" : "default";
          }

          if (!isDraggingTactic && !isDrawingTactic) return;

          if (tacticMode === "move" && selectedTacticObj) {
            const dx = pos.x - lastPos.x;
            const dy = pos.y - lastPos.y;
            const item = selectedTacticObj.item;
            const type = selectedTacticObj.type;

            if (type === 'obj' || type === 'text') {
              item.x += dx;
              item.y += dy;
            } else if (type === 'arrow') {
              item.start.x += dx; item.start.y += dy;
              item.end.x += dx; item.end.y += dy;
            }
            lastPos = pos;
            drawTacticsBoard();

          } else if (tacticMode === "draw" && currentLine) {
            currentLine.points.push(pos);
            drawTacticsBoard();
          } else if (tacticMode === "arrow" && arrowStartPos) {
            arrowEndPos = pos;
            drawTacticsBoard();
          } else if (tacticMode === "eraser") {
            eraseObjectAt(pos);
          }
        }

        function handleTacticEnd(e) {
          e.preventDefault();
          if (tacticMode === "move") {
            isDraggingTactic = false; selectedTacticObj = null;
            tacticCanvas.style.cursor = "grab";
          } else if (tacticMode === "draw") {
            if (currentLine) { tacticLines.push(currentLine); currentLine = null; }
            isDrawingTactic = false;
            drawTacticsBoard();
          } else if (tacticMode === "arrow") {
            if (isDrawingTactic && arrowStartPos && arrowEndPos) {
              tacticArrows.push({ start: arrowStartPos, end: arrowEndPos });
            }
            isDrawingTactic = false;
            arrowStartPos = null; arrowEndPos = null;
            drawTacticsBoard();
          } else if (tacticMode === "eraser") {
            isDrawingTactic = false;
          }
        }

        function eraseObjectAt(pos) {
          const range = 20;
          let changed = false;

          const initLines = tacticLines.length;
          tacticLines = tacticLines.filter(line => !line.points.some(p => Math.sqrt((p.x - pos.x) ** 2 + (p.y - pos.y) ** 2) < range));
          if (tacticLines.length !== initLines) changed = true;

          const initArrows = tacticArrows.length;
          tacticArrows = tacticArrows.filter(arrow => {
            return getDistanceToSegment(pos, arrow.start, arrow.end) > 15;
          });
          if (tacticArrows.length !== initArrows) changed = true;

          const initTexts = tacticTexts.length;
          tacticTexts = tacticTexts.filter(t => Math.sqrt((t.x - pos.x) ** 2 + (t.y - pos.y) ** 2) > range * 1.5);
          if (tacticTexts.length !== initTexts) changed = true;

          if (changed) drawTacticsBoard();
        }

        document.addEventListener("DOMContentLoaded", initTacticsBoard);

        // ==========================================
        // âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰ã®ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜æ©Ÿèƒ½
        // ==========================================
        function saveTacticsToBrowser() {
          const saveData = {
            objects: tacticObjects,
            lines: tacticLines,
            arrows: tacticArrows,
            texts: tacticTexts,
            timestamp: new Date().toLocaleString()
          };
          localStorage.setItem("smartCoachTactics", JSON.stringify(saveData));

          const statusEl = document.getElementById("tactics-local-status");
          if (statusEl) {
            statusEl.textContent = "ä¿å­˜å®Œäº†: " + saveData.timestamp;
            setTimeout(() => { statusEl.textContent = ""; }, 3000);
          }
        }

        function loadTacticsFromBrowser() {
          const json = localStorage.getItem("smartCoachTactics");
          if (!json) return alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          if (!confirm("ç¾åœ¨ã®å†…å®¹ã‚’ç ´æ£„ã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

          try {
            const data = JSON.parse(json);
            tacticObjects = data.objects || [];
            tacticLines = data.lines || [];
            tacticArrows = data.arrows || [];
            tacticTexts = data.texts || [];
            drawTacticsBoard();

            const statusEl = document.getElementById("tactics-local-status");
            if (statusEl) statusEl.textContent = "å¾©å…ƒå®Œäº†";
          } catch (e) {
            console.error(e);
            alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        }

        function clearTacticsBrowserData() {
          if (confirm("æˆ¦è¡“ãƒœãƒ¼ãƒ‰ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem("smartCoachTactics");
            const statusEl = document.getElementById("tactics-local-status");
            if (statusEl) {
              statusEl.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
              setTimeout(() => { statusEl.textContent = ""; }, 3000);
            }
          }
        }

        // ==========================================
        // âœ… æˆ¦è¡“ãƒœãƒ¼ãƒ‰å°‚ç”¨ ç”»åƒä¿å­˜é–¢æ•°
        // ==========================================
        function saveTacticsImage() {
          const canvas = document.getElementById("tacticsCanvas");
          if (!canvas) return;

          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”»åƒURLã«å¤‰æ›
          const image = canvas.toDataURL("image/png");

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
          const link = document.createElement("a");
          link.href = image;
          link.download = "tactics_board.png"; // ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å
          link.click();
        }

        // ==========================================
        // âœ… è‡ªç”±é…ç½®å‹ã‚³ãƒ¼ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šãƒ»æ•´åˆ—ä¿®æ­£ç‰ˆ)
        // ==========================================

        let isOrderingMode = false;
        let currentOrderCount = 1;
        let isSelectionMode = false;
        let selectedElements = new Set();

        // --- æ©Ÿèƒ½ï¼šæŠ˜ã‚ŠãŸãŸã¿ ---
        function toggleLayoutBuilder() {
          const content = document.getElementById("layout-builder-content");
          const icon = document.getElementById("layout-toggle-icon");
          if (content.style.display === "none") {
            content.style.display = "block";
            icon.textContent = "â–²";
          } else {
            content.style.display = "none";
            icon.textContent = "â–¼";
          }
        }

        // 1. åˆæœŸåŒ–ãƒ»ç”Ÿæˆ
        function initGymLayout() {
          const floor = document.getElementById("gym-floor");
          const courtCount = parseInt(document.getElementById("init-court-count").value) || 0;
          const playerCount = parseInt(document.getElementById("init-player-count").value) || 0;

          const content = document.getElementById("layout-builder-content");
          const icon = document.getElementById("layout-toggle-icon");
          if (content.style.display === "none") {
            content.style.display = "block";
            icon.textContent = "â–²";
          }

          if (floor.children.length > 1 && !confirm("ç¾åœ¨ã®é…ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ")) return;

          floor.innerHTML = "";
          currentOrderCount = 1;
          clearSelection();

          const note = document.createElement("p");
          note.style.cssText = "position:absolute; top:5px; left:5px; margin:0; font-size:11px; color:#666; pointer-events:none;";
          note.textContent = "ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤";
          floor.appendChild(note);

          for (let i = 0; i < courtCount; i++) {
            createCourt(floor, i);
          }

          // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: ã‚³ãƒ¼ãƒˆã®è¡Œæ•°ã«åˆã‚ã›ã¦ã€é¸æ‰‹ã®ä½ç½®ã¨åºŠã®é«˜ã•ã‚’èª¿æ•´
          const maxCols = 4;
          const rows = Math.ceil(courtCount / maxCols); // ã‚³ãƒ¼ãƒˆã®è¡Œæ•°
          const courtUnitHeight = 300; // ã‚³ãƒ¼ãƒˆé«˜ã•(260) + éš™é–“(40)

          // é¸æ‰‹ã‚’é…ç½®ã™ã‚‹Yåº§æ¨™ï¼ˆæœ€å¾Œã®ã‚³ãƒ¼ãƒˆã®ä¸‹ã‚ãŸã‚Šï¼‰
          const playerStartY = 40 + (rows * courtUnitHeight) + 20;

          // åºŠã®æœ€ä½é«˜ã•ã‚’è¨ˆç®—ï¼ˆé¸æ‰‹ã‚¨ãƒªã‚¢åˆ†ã‚‚å«ã‚ã‚‹ï¼‰
          const minHeight = playerStartY + 100;
          floor.style.height = Math.max(400, minHeight) + "px";

          createPlayers(floor, playerCount, playerStartY);
        }

        function createCourt(container, index) {
          const court = document.createElement("div");
          court.className = "draggable-item gym-court";

          // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: 4ã¤ã”ã¨ã«æ”¹è¡Œã™ã‚‹è¨ˆç®—
          const maxCols = 4; // 1è¡Œã«ä¸¦ã¹ã‚‹æœ€å¤§æ•°ï¼ˆã‚¹ãƒãƒ›ãªã‚‰2ã‚„3ã«æ¸›ã‚‰ã—ã¦ã‚‚OKï¼‰
          const col = index % maxCols;            // åˆ—ç•ªå· (0, 1, 2, 3)
          const row = Math.floor(index / maxCols); // è¡Œç•ªå· (0, 1...)

          const courtWidth = 200;
          const courtHeight = 260;
          const gapX = 40; // æ¨ªã®é–“éš” (240pxãƒ”ãƒƒãƒ)
          const gapY = 40; // ç¸¦ã®é–“éš”

          // åº§æ¨™è¨ˆç®—
          const left = 20 + (col * (courtWidth + gapX));
          const top = 40 + (row * (courtHeight + gapY));

          court.style.cssText = `
        position: absolute;
        top: ${top}px;
        left: ${left}px;
        width: ${courtWidth}px;
        height: ${courtHeight}px;
        background: #2e7d32;
        border: 2px solid white;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        cursor: grab;
        z-index: 1;
        touch-action: none;
    `;

          const net = document.createElement("div");
          net.style.cssText = "position:absolute; top:50%; left:0; width:100%; border-top:2px dashed rgba(255,255,255,0.7); pointer-events:none;";
          court.appendChild(net);

          // é¸æŠæ©Ÿèƒ½å¯¾å¿œ
          court.addEventListener('click', (e) => {
            if (isSelectionMode) {
              e.stopPropagation();
              toggleSelection(court);
            }
          });

          makeDraggable(court);
          container.appendChild(court);
        }

        function createPlayers(container, count, startY = 320) {
          const startX = 20;
          // startY ã¯å¼•æ•°ã‹ã‚‰å—ã‘å–ã‚‹ï¼ˆæŒ‡å®šãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ320ï¼‰
          const gapX = 45;
          const gapY = 45;
          const cols = 15;

          for (let i = 0; i < count; i++) {
            const col = i % cols;
            const row = Math.floor(i / cols);
            const x = startX + (col * gapX);
            const y = startY + (row * gapY); // ã“ã“ã§å—ã‘å–ã£ãŸstartYã‚’ä½¿ã†
            addSpotToFloor(x, y);
          }
        }

        function addSpotToFloor(x, y) {
          const floor = document.getElementById("gym-floor");
          const spot = document.createElement("div");
          spot.className = "player-spot draggable-item"; // æ•´åˆ—å¯¾è±¡ã‚¯ãƒ©ã‚¹

          spot.textContent = "?";

          spot.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y}px;
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #333;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
        color: #333;
        cursor: grab;
        z-index: 10;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        user-select: none;
        touch-action: none;
    `;

          // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‰Šé™¤
          spot.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            if (!isOrderingMode && !isSelectionMode && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
              spot.remove();
            }
          });

          makeDraggable(spot);
          floor.appendChild(spot);
        }

        // --- ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã¨å‡¦ç†ã®ä¸€å…ƒåŒ– ---
        function handleItemClick(e, element) {
          // ä¼æ’­é˜²æ­¢
          if (e) e.stopPropagation();

          // 1. ç•ªå·è¨­å®šãƒ¢ãƒ¼ãƒ‰
          if (isOrderingMode && element.classList.contains('player-spot')) {
            element.textContent = currentOrderCount;
            element.style.backgroundColor = "#ffeb3b";
            element.style.borderColor = "#f57f17";
            currentOrderCount++;
          }
          // 2. é¸æŠãƒ¢ãƒ¼ãƒ‰
          else if (isSelectionMode) {
            toggleSelection(element);
          }
        }

        // --- æ©Ÿèƒ½ï¼šã‚¨ãƒªã‚¢æ‹¡å¼µ ---
        function toggleFloorHeight() {
          const floor = document.getElementById("gym-floor");
          if (floor.style.height === "800px") {
            floor.style.height = "400px";
          } else {
            floor.style.height = "800px";
          }
        }

        // --- æ©Ÿèƒ½ï¼šé¸æŠãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ ---
        function toggleSelectMode(checkbox) {
          isSelectionMode = checkbox.checked;
          const btnGroup = document.getElementById("align-buttons");
          const msg = document.getElementById("select-mode-msg");

          if (isSelectionMode) {
            btnGroup.style.opacity = "1";
            btnGroup.style.pointerEvents = "auto";
            if (msg) msg.style.display = "block";
          } else {
            btnGroup.style.opacity = "0.5";
            btnGroup.style.pointerEvents = "none";
            if (msg) msg.style.display = "none";
            clearSelection();
          }
        }

        function toggleSelection(el) {
          if (selectedElements.has(el)) {
            selectedElements.delete(el);
            el.style.outline = "none";
            // å…ƒã®å½±ã«æˆ»ã™
            el.style.boxShadow = el.classList.contains('gym-court')
              ? "2px 2px 5px rgba(0,0,0,0.3)"
              : "1px 1px 3px rgba(0,0,0,0.3)";
          } else {
            selectedElements.add(el);
            el.style.outline = "3px solid red";
            el.style.boxShadow = "0 0 10px rgba(255,0,0,0.5)";
          }
        }

        function clearSelection() {
          selectedElements.forEach(el => {
            el.style.outline = "none";
            el.style.boxShadow = el.classList.contains('gym-court')
              ? "2px 2px 5px rgba(0,0,0,0.3)"
              : "1px 1px 3px rgba(0,0,0,0.3)";
          });
          selectedElements.clear();
        }

        // --- æ©Ÿèƒ½ï¼šæ•´åˆ—å®Ÿè¡Œ ---
        function alignSelected(type) {
          if (selectedElements.size < 2) return alert("2ã¤ä»¥ä¸Šã®è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„");

          const items = Array.from(selectedElements);

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ä¸
          items.forEach(el => el.style.transition = "top 0.2s, left 0.2s");

          if (type === 'top') {
            // æœ€ã‚‚ä¸Šã®Yåº§æ¨™ã«åˆã‚ã›ã‚‹
            const minTop = Math.min(...items.map(el => parseInt(el.style.top || el.offsetTop)));
            items.forEach(el => el.style.top = minTop + "px");
          }
          else if (type === 'left') {
            // æœ€ã‚‚å·¦ã®Xåº§æ¨™ã«åˆã‚ã›ã‚‹
            const minLeft = Math.min(...items.map(el => parseInt(el.style.left || el.offsetLeft)));
            items.forEach(el => el.style.left = minLeft + "px");
          }
          else if (type === 'distribute') {
            // å·¦ã‹ã‚‰é †ã«ä¸¦ã³æ›¿ãˆ
            items.sort((a, b) => parseInt(a.style.left || a.offsetLeft) - parseInt(b.style.left || b.offsetLeft));

            const first = items[0];
            const last = items[items.length - 1];
            const firstLeft = parseInt(first.style.left || first.offsetLeft);
            const lastLeft = parseInt(last.style.left || last.offsetLeft);

            const totalDist = lastLeft - firstLeft;
            const interval = totalDist / (items.length - 1);

            items.forEach((el, i) => {
              el.style.left = (firstLeft + (interval * i)) + "px";
            });
          }

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è§£é™¤
          setTimeout(() => {
            items.forEach(el => el.style.transition = "");
          }, 250);
        }

        // æ•´åˆ—ãƒœã‚¿ãƒ³ï¼ˆå…¨ä½“ã‚¹ãƒŠãƒƒãƒ—ï¼‰
        function alignElements() {
          // é¸æŠä¸­ãªã‚‰é¸æŠã•ã‚ŒãŸã‚‚ã®ã ã‘ã€ãã†ã§ãªã‘ã‚Œã°å…¨ä½“ã‚’ã‚°ãƒªãƒƒãƒ‰ã‚¹ãƒŠãƒƒãƒ—
          const targetItems = selectedElements.size > 0
            ? Array.from(selectedElements)
            : document.querySelectorAll("#gym-floor .draggable-item");

          const gridSize = 20;

          targetItems.forEach(item => {
            item.style.transition = "top 0.2s, left 0.2s";
            const currentLeft = parseInt(item.style.left || item.offsetLeft);
            const currentTop = parseInt(item.style.top || item.offsetTop);
            const newLeft = Math.round(currentLeft / gridSize) * gridSize;
            const newTop = Math.round(currentTop / gridSize) * gridSize;
            item.style.left = newLeft + "px";
            item.style.top = newTop + "px";
            setTimeout(() => item.style.transition = "", 250);
          });
        }

        // --- ç•ªå·è¨­å®šãƒ¢ãƒ¼ãƒ‰ ---
        function startOrderingMode() {
          isOrderingMode = true;
          currentOrderCount = 1;

          // é¸æŠãƒ¢ãƒ¼ãƒ‰è§£é™¤
          if (document.getElementById("chk-select-mode").checked) {
            document.getElementById("chk-select-mode").click();
          }

          document.getElementById("btn-start-order").style.display = "none";
          document.getElementById("ordering-status").style.display = "inline";
          document.getElementById("btn-end-order").style.display = "inline-block";

          const spots = document.querySelectorAll(".player-spot");
          spots.forEach(spot => {
            spot.textContent = "";
            spot.style.backgroundColor = "#e0e0e0";
            spot.style.borderColor = "#999";
            spot.style.cursor = "pointer";
          });
        }

        function endOrderingMode() {
          isOrderingMode = false;

          document.getElementById("btn-start-order").style.display = "inline-block";
          document.getElementById("ordering-status").style.display = "none";
          document.getElementById("btn-end-order").style.display = "none";

          const spots = document.querySelectorAll(".player-spot");
          spots.forEach(spot => {
            spot.style.backgroundColor = "rgba(255, 255, 255, 0.9)";
            spot.style.borderColor = "#333";
            spot.style.cursor = "grab";
            if (spot.textContent === "") spot.textContent = "?";
          });
        }

        // --- ç”»åƒä¿å­˜ ---
        async function saveGymImage() {
          const floor = document.getElementById("gym-floor");
          if (!floor) return;

          // ä¿å­˜å‰ã«é¸æŠæ ã‚’ä¸€æ™‚çš„ã«æ¶ˆã™
          const tempSelected = new Set(selectedElements);
          clearSelection();

          try {
            const canvas = await html2canvas(floor, {
              scale: 2,
              useCORS: true,
              backgroundColor: "#e0e0e0"
            });
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "court_layout.png";
            link.click();
          } catch (e) {
            console.error(e);
            alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          } finally {
            // é¸æŠçŠ¶æ…‹ã‚’æˆ»ã™
            tempSelected.forEach(el => toggleSelection(el));
          }
        }

        // ==========================================
        // âœ… ã‚³ãƒ¼ãƒˆé…ç½®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¿å­˜ãƒ»å¾©å…ƒæ©Ÿèƒ½
        // ==========================================

        function saveLayoutToBrowser() {
          // 1. ä¿å­˜å‰ã«é¸æŠçŠ¶æ…‹ã‚’è§£é™¤ï¼ˆèµ¤æ ãªã©ã‚’æ¶ˆã™ãŸã‚ï¼‰
          const wasSelected = isSelectionMode;
          if (wasSelected) clearSelection();

          // 2. ãƒ•ãƒ­ã‚¢å†…ã®è¦ç´ ï¼ˆã‚³ãƒ¼ãƒˆã¨ã‚¹ãƒãƒƒãƒˆï¼‰ã®çŠ¶æ…‹ã‚’å–å¾—
          const items = [];
          document.querySelectorAll("#gym-floor .draggable-item").forEach(el => {
            items.push({
              type: el.classList.contains("gym-court") ? "court" : "spot",
              left: el.style.left,
              top: el.style.top,
              text: el.textContent,
              bg: el.style.backgroundColor,
              border: el.style.borderColor
            });
          });

          // 3. ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä½œæˆ
          const saveData = {
            courtCount: document.getElementById("init-court-count").value,
            playerCount: document.getElementById("init-player-count").value,
            items: items,
            floorHeight: document.getElementById("gym-floor").style.height,
            timestamp: new Date().toLocaleString()
          };

          // 4. LocalStorageã«ä¿å­˜
          localStorage.setItem("smartCoachLayout", JSON.stringify(saveData));

          // 5. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
          const statusEl = document.getElementById("layout-local-status");
          if (statusEl) {
            statusEl.textContent = "ä¿å­˜å®Œäº†: " + saveData.timestamp;
            setTimeout(() => { statusEl.textContent = ""; }, 3000);
          }
        }

        function loadLayoutFromBrowser() {
          const json = localStorage.getItem("smartCoachLayout");
          if (!json) return alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          if (!confirm("ç¾åœ¨ã®é…ç½®ã‚’ç ´æ£„ã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

          try {
            const data = JSON.parse(json);

            // è¨­å®šå€¤ã®å¾©å…ƒ
            if (data.courtCount) document.getElementById("init-court-count").value = data.courtCount;
            if (data.playerCount) document.getElementById("init-player-count").value = data.playerCount;

            // ãƒ•ãƒ­ã‚¢ã®ã‚¯ãƒªã‚¢
            const floor = document.getElementById("gym-floor");
            floor.innerHTML = "";

            // èª¬æ˜æ›¸ãå†é…ç½®
            const note = document.createElement("p");
            note.style.cssText = "position:absolute; top:5px; left:5px; margin:0; font-size:11px; color:#666; pointer-events:none;";
            note.textContent = "ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤";
            floor.appendChild(note);

            // åºŠã®é«˜ã•å¾©å…ƒ
            if (data.floorHeight) floor.style.height = data.floorHeight;

            // ã‚¢ã‚¤ãƒ†ãƒ ã®å†é…ç½®
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                if (item.type === "court") {
                  restoreCourt(floor, item);
                } else {
                  restoreSpot(floor, item);
                }
              });
            }

            // è‡ªå‹•ã§ã‚¨ãƒªã‚¢ã‚’é–‹ã
            const content = document.getElementById("layout-builder-content");
            const icon = document.getElementById("layout-toggle-icon");
            if (content.style.display === "none") {
              content.style.display = "block";
              icon.textContent = "â–²";
            }

            const statusEl = document.getElementById("layout-local-status");
            if (statusEl) statusEl.textContent = "å¾©å…ƒå®Œäº†";

          } catch (e) {
            console.error(e);
            alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        }

        function clearLayoutBrowserData() {
          if (confirm("é…ç½®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å†…å®¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem("smartCoachLayout");
            const statusEl = document.getElementById("layout-local-status");
            if (statusEl) {
              statusEl.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
              setTimeout(() => { statusEl.textContent = ""; }, 3000);
            }
          }
        }

        // --- å¾©å…ƒç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function restoreCourt(container, data) {
          const court = document.createElement("div");
          court.className = "draggable-item gym-court";
          court.style.cssText = `
        position: absolute;
        top: ${data.top};
        left: ${data.left};
        width: 200px;
        height: 260px;
        background: #2e7d32;
        border: 2px solid white;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        cursor: grab;
        z-index: 1;
        touch-action: none;
    `;
          const net = document.createElement("div");
          net.style.cssText = "position:absolute; top:50%; left:0; width:100%; border-top:2px dashed rgba(255,255,255,0.7); pointer-events:none;";
          court.appendChild(net);

          // é¸æŠæ©Ÿèƒ½å¯¾å¿œ
          court.addEventListener('click', (e) => {
            if (isSelectionMode) {
              e.stopPropagation();
              toggleSelection(court);
            }
          });

          makeDraggable(court);
          container.appendChild(court);
        }

        function restoreSpot(container, data) {
          const spot = document.createElement("div");
          spot.className = "player-spot draggable-item";
          spot.textContent = data.text;

          // è‰²æƒ…å ±ãŒã‚ã‚Œã°å¾©å…ƒã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          const bg = data.bg || 'rgba(255, 255, 255, 0.9)';
          const border = data.border || '#333';

          spot.style.cssText = `
        position: absolute;
        left: ${data.left};
        top: ${data.top};
        width: 36px;
        height: 36px;
        background: ${bg};
        border: 2px solid #333;
        border-color: ${border};
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 14px;
        color: #333;
        cursor: grab;
        z-index: 10;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        user-select: none;
        touch-action: none;
    `;

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†è¨­å®šï¼ˆæ–°è¦ä½œæˆæ™‚ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
          spot.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            if (!isOrderingMode && !isSelectionMode && confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
              spot.remove();
            }
          });

          spot.addEventListener('click', (e) => {
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆç•ªå·è¨­å®š or é¸æŠï¼‰
            handleItemClick(e, spot);
          });

          makeDraggable(spot);
          container.appendChild(spot);
        }


        // --- ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ (ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šè¾¼ã¿) ---
        function makeDraggable(elmnt) {
          let shiftX = 0;
          let shiftY = 0;
          let isMoved = false; // ç§»å‹•ã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

          const onMouseDown = (e) => {
            // ç•ªå·è¨­å®šä¸­ã¯ãƒ‰ãƒ©ãƒƒã‚°ã•ã›ãªã„(ã‚¯ãƒªãƒƒã‚¯ã®ã¿é€šã™)
            if (typeof isOrderingMode !== 'undefined' && isOrderingMode && elmnt.classList.contains("player-spot")) return;
            // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã•ã›ãªã„(ã‚¯ãƒªãƒƒã‚¯ã®ã¿é€šã™)
            if (typeof isSelectionMode !== 'undefined' && isSelectionMode) return;

            e.preventDefault();
            isMoved = false; // ãƒªã‚»ãƒƒãƒˆ

            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

            const rect = elmnt.getBoundingClientRect();
            shiftX = clientX - rect.left;
            shiftY = clientY - rect.top;

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('touchmove', onMouseMove, { passive: false });
            document.addEventListener('touchend', onMouseUp);
          };

          const onMouseMove = (e) => {
            e.preventDefault();
            isMoved = true; // å‹•ã„ãŸï¼

            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

            const parent = elmnt.offsetParent;
            if (!parent) return;
            const parentRect = parent.getBoundingClientRect();

            let newLeft = clientX - shiftX - parentRect.left;
            let newTop = clientY - shiftY - parentRect.top;

            elmnt.style.left = newLeft + 'px';
            elmnt.style.top = newTop + 'px';
          };

          const onMouseUp = (e) => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.removeEventListener('touchmove', onMouseMove);
            document.removeEventListener('touchend', onMouseUp);

            // ã‚‚ã—ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã—ã¦ã„ãªã‘ã‚Œã°ã€ã‚¯ãƒªãƒƒã‚¯ã¨ã¿ãªã™
            if (!isMoved) {
              if (typeof handleItemClick === 'function') {
                handleItemClick(e, elmnt);
              }
            }
          };

          // ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠ/ç•ªå·è¨­å®šã®å ´åˆã®ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ç”¨ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ãŸã‚ï¼‰
          elmnt.addEventListener('click', (e) => {
            if ((typeof isSelectionMode !== 'undefined' && isSelectionMode) || (typeof isOrderingMode !== 'undefined' && isOrderingMode)) {
              if (typeof handleItemClick === 'function') {
                handleItemClick(e, elmnt);
              }
            }
          });

          elmnt.addEventListener('mousedown', onMouseDown);
          elmnt.addEventListener('touchstart', onMouseDown, { passive: false });
        }
      </script>

      <div id="certificate-template" style="
    position: fixed; 
    top: -9999px; 
    left: -9999px; 
    width: 700px; 
    box-sizing: border-box;
    padding: 40px; 
    background: #fff; 
    border: 10px solid #1a237e; 
    font-family: 'Noto Sans JP', sans-serif; 
    text-align: center;
">
        <div style="
        border: 2px solid #ff9800; 
        padding: 30px;
        word-wrap: break-word;
        overflow-wrap: break-word; 
        text-align: left;
    ">
          <h1 style="font-size: 40px; color: #1a237e; margin-bottom: 10px; text-align: center;">Badminton Theory Test
          </h1>
          <h2
            style="font-size: 28px; color: #333; margin-top: 0; border-bottom: 2px solid #ccc; padding-bottom: 20px; text-align: center;">
            å®ŸåŠ›è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ</h2>

          <p style="font-size: 18px; text-align: right; color: #666; margin-top: 20px;">å—é¨“æ—¥: <span
              id="cert-date">2025/01/01</span></p>

          <div style="margin: 40px 0; background: #f5f5f5; padding: 30px; border-radius: 10px; text-align: center;">
            <p style="font-size: 24px; color: #555; margin: 0;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢</p>
            <p style="font-size: 80px; font-weight: bold; color: #e65100; margin: 10px 0;">
              <span id="cert-score">0</span> / <span id="cert-total">20</span>
            </p>
            <p id="cert-rank" style="font-size: 32px; font-weight: bold; color: #1a237e; margin: 0;">ãƒ©ãƒ³ã‚¯åˆ¤å®šä¸­...</p>
          </div>

          <div style="margin-top: 40px; padding: 0 40px;">
            <h3 style="color: #1a237e; border-left: 5px solid #ff9800; padding-left: 10px;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
            <p id="cert-comment"
              style="font-size: 18px; color: #333; line-height: 1.8; text-align: left; word-wrap: break-word;"></p>
          </div>

          <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end;">
            <div style="text-align: left;">
              <p style="font-size: 14px; color: #999;">Smart Coach Badminton</p>
              <p style="font-size: 14px; color: #999;">Training Program Creator</p>
            </div>
            <div style="font-size: 20px; font-weight: bold; color: #1a237e;">
              MASU Badminton Academy
            </div>
          </div>
        </div>
      </div>

      <script>
        // ==========================================
        // âœ… å…±æœ‰æ©Ÿèƒ½ (ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…±æœ‰ & è³‡æ–™ãƒªãƒ³ã‚¯QR)
        // ==========================================

        // 1. ä½œæˆã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å…±æœ‰QRã‚’ç”Ÿæˆ (ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸãŒé–¢æ•°ã¯æ®‹ã—ã¦ãŠãã¾ã™)
        function generateAndShowShareLink() {
          if (!selectedMenus.length) {
            alert("å…±æœ‰ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nPlease create a program first.");
            return;
          }

          const data = encodeURIComponent(JSON.stringify(selectedMenus));
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?share=${data}`;

          const urlBox = document.getElementById("share-url-box");
          if (urlBox) urlBox.value = shareUrl;

          const qrBox = document.getElementById("share-qr-box");
          if (qrBox) {
            qrBox.innerHTML = "";
            new QRCode(qrBox, {
              text: shareUrl,
              width: 150,
              height: 150,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.M
            });
          }

          const resultArea = document.getElementById("share-result-area");
          if (resultArea) resultArea.style.display = "block";
        }

        // URLã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        function copyShareUrl() {
          const urlBox = document.getElementById("share-url-box");
          if (!urlBox) return;
          urlBox.select();
          urlBox.setSelectionRange(0, 99999);
          navigator.clipboard.writeText(urlBox.value).then(() => {
            alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
          });
        }

        // 2. äº‹å‰ã«ä½œæˆã—ãŸQRç”»åƒã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ (ç”»åƒé¸æŠç‰ˆ)
        window.displayPreMadeQR = function () {
          console.log("QRè¡¨ç¤ºãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ");

          const urlInput = document.getElementById("target-link-input");
          const fileInput = document.getElementById("qr-image-file");
          const resultArea = document.getElementById("premade-qr-result");
          const displayImg = document.getElementById("qr-display-img");
          const displayLink = document.getElementById("qr-display-link");
          const linkMsg = document.getElementById("qr-link-msg");

          // è¦ç´ ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if (!fileInput || !resultArea || !displayImg) {
            console.error("å¿…è¦ãªHTMLè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
          }

          // URLã¯ä»»æ„ï¼ˆãªãã¦ã‚‚OKï¼‰
          const url = urlInput ? urlInput.value.trim() : "";
          const file = fileInput.files[0];

          // ãƒ•ã‚¡ã‚¤ãƒ«å¿…é ˆãƒã‚§ãƒƒã‚¯
          if (!file) {
            alert("QRã‚³ãƒ¼ãƒ‰ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nPlease select a QR code image.");
            return;
          }

          const reader = new FileReader();

          reader.onload = function (e) {
            displayImg.src = e.target.result;

            // URLãŒã‚ã‚Œã°ãƒªãƒ³ã‚¯æœ‰åŠ¹åŒ–ã€ãªã‘ã‚Œã°ç„¡åŠ¹åŒ–
            if (url) {
              displayLink.href = url;
              displayLink.style.cursor = "pointer";
              displayLink.style.pointerEvents = "auto";
              if (linkMsg) linkMsg.style.display = "block";
            } else {
              displayLink.removeAttribute("href");
              displayLink.style.cursor = "default";
              displayLink.style.pointerEvents = "none";
              if (linkMsg) linkMsg.style.display = "none";
            }

            resultArea.style.display = "block";
          };

          reader.readAsDataURL(file);
        };

        // ==========================================
        // ğŸ† æ—¥æ›¿ã‚ã‚Šè£œå¼·ãƒãƒ£ãƒ¬ãƒ³ã‚¸ & ğŸ—ºï¸ ãƒãƒƒãƒ—æ©Ÿèƒ½ (è¤‡æ•°äººå¯¾å¿œç‰ˆ)
        // ==========================================

        const STORAGE_KEY_DAILY = "smartCoachDailyData";

        // å…¨ä½“ãƒ‡ãƒ¼ã‚¿æ§‹é€ : { currentUser: "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼", records: { "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": { ... }, "å¼Ÿ": { ... } } }
        let dailyUserData = {
          currentUser: "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼",
          records: { "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": createDefaultDailyData() }
        };

        // çŠ¶æ…‹å¤‰æ•° (ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€²æ—ã‚’ä¿æŒ)
        let currentMapMode = "japan";
        let mapProgress = { japan: 0, world: 0, japanCompleted: false };

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function createDefaultDailyData() {
          return {
            streak: 0,
            lastDate: "",
            totalBadges: 0,
            weeklyBadges: 0,
            mapJapanIdx: 0,
            mapWorldIdx: 0,
            currentMapMode: "japan",
            japanCompleted: false
          };
        }

        // ------------------------------------------------
        // A. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½
        // ------------------------------------------------

        // åˆæœŸåŒ–æ™‚ã«å®Ÿè¡Œ
        function initDailyUser() {
          // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ï¼ˆç§»è¡Œå‡¦ç†å«ã‚€ï¼‰
          const json = localStorage.getItem(STORAGE_KEY_DAILY);
          if (json) {
            const parsed = JSON.parse(json);
            // æ—§å½¢å¼ï¼ˆrecordsãŒãªã„ï¼‰å ´åˆã®ç§»è¡Œ
            if (!parsed.records) {
              console.log("æ—…ãƒ‡ãƒ¼ã‚¿ã‚’æ–°å½¢å¼ã«ç§»è¡Œã—ã¾ã™...");
              dailyUserData = {
                currentUser: "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                records: { "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": parsed }
              };
              saveGlobalDailyData();
            } else {
              dailyUserData = parsed;
              // ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆé˜²æ­¢
              if (!dailyUserData.records) dailyUserData.records = { "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": createDefaultDailyData() };
              if (!dailyUserData.currentUser) dailyUserData.currentUser = Object.keys(dailyUserData.records)[0];
            }
          } else {
            saveGlobalDailyData(); // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          }

          // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ•°ã«åæ˜ 
          syncCurrentUserData();
          updateDailyUserSelectUI();
        }

        // é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°(mapProgressç­‰)ã«åŒæœŸã•ã›ã‚‹
        function syncCurrentUserData() {
          const currentData = getCurrentUserDailyData();
          mapProgress.japan = currentData.mapJapanIdx || 0;
          mapProgress.world = currentData.mapWorldIdx || 0;
          mapProgress.japanCompleted = currentData.japanCompleted || false;
          currentMapMode = currentData.currentMapMode || "japan";
        }

        function updateDailyUserSelectUI() {
          const select = document.getElementById("daily-user-select");
          if (!select) return;

          select.innerHTML = "";
          Object.keys(dailyUserData.records).forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (name === dailyUserData.currentUser) opt.selected = true;
            select.appendChild(opt);
          });
        }

        function switchDailyUser() {
          const select = document.getElementById("daily-user-select");
          dailyUserData.currentUser = select.value;
          saveGlobalDailyData();

          // å¤‰æ•°åŒæœŸ
          syncCurrentUserData();

          // ç”»é¢ã®æ›´æ–°
          updateDailyUI();
          renderMap();
          updateMapUnlockState();
        }

        function addDailyUser() {
          const name = prompt("æ–°ã—ã„æ—…äººã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šå¼Ÿã€å¦¹ï¼‰");
          if (name && name.trim() !== "") {
            if (dailyUserData.records[name]) {
              alert("ãã®åå‰ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
              return;
            }
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
            dailyUserData.records[name] = createDefaultDailyData();
            dailyUserData.currentUser = name;
            saveGlobalDailyData();

            updateDailyUserSelectUI();
            switchDailyUser(); // åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ã‚’å‘¼ã‚“ã§ç”»é¢æ›´æ–°
            alert(`ã€Œ${name}ã€ã®æ—…ã‚’æ–°ã—ãå§‹ã‚ã¾ã™ï¼ğŸŒ`);
          }
        }

        function deleteDailyUser() {
          const target = dailyUserData.currentUser;
          const users = Object.keys(dailyUserData.records);

          if (users.length <= 1) {
            alert("æœ€å¾Œã®1äººã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
            return;
          }

          if (confirm(`ç¾åœ¨é¸æŠä¸­ã®ã€Œ${target}ã€ã®æ—…ã®è¨˜éŒ²ï¼ˆãƒãƒƒã‚¸ãƒ»åœ°å›³é€²æ—ï¼‰ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
            delete dailyUserData.records[target];
            dailyUserData.currentUser = Object.keys(dailyUserData.records)[0];
            saveGlobalDailyData();

            updateDailyUserSelectUI();
            switchDailyUser(); // åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ã‚’å‘¼ã‚“ã§ç”»é¢æ›´æ–°
          }
        }

        // å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
        function saveGlobalDailyData() {
          localStorage.setItem(STORAGE_KEY_DAILY, JSON.stringify(dailyUserData));
        }

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
        function getCurrentUserDailyData() {
          const user = dailyUserData.currentUser;
          if (!dailyUserData.records[user]) {
            dailyUserData.records[user] = createDefaultDailyData();
          }
          return dailyUserData.records[user];
        }

        // ------------------------------------------------
        // B. ãƒ‡ãƒ¼ã‚¿ç®¡ç† & UIæ›´æ–°
        // ------------------------------------------------

        // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
        function loadDailyData() {
          return getCurrentUserDailyData();
        }

        // å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆå€‹äººãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒ¼ã‚¸ã—ã¦ä¿å­˜
        function saveDailyData(individualData) {
          dailyUserData.records[dailyUserData.currentUser] = individualData;
          saveGlobalDailyData();
          updateDailyUI();
        }

        function updateDailyUI() {
          const data = getCurrentUserDailyData();

          // è¨€èªè¨­å®šã‚’å–å¾—
          const t = (typeof translations !== 'undefined' && typeof currentLang !== 'undefined')
            ? (translations[currentLang] || translations.ja)
            : { dailyDoneBtn: "æœ¬æ—¥ã¯é”æˆæ¸ˆã¿ã§ã™", dailyCompleteBtn: "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼", dailyMsgDone: "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼" };

          const streakEl = document.getElementById("streak-count");
          const badgeEl = document.getElementById("badge-count");
          const weeklyEl = document.getElementById("weekly-count");

          if (streakEl) streakEl.textContent = data.streak;
          if (badgeEl) badgeEl.textContent = data.totalBadges;
          if (weeklyEl) weeklyEl.textContent = data.weeklyBadges;

          const today = new Date().toLocaleDateString("ja-JP");
          const btn = document.getElementById("btn-complete-challenge");
          const msg = document.getElementById("daily-message");

          if (!btn) return;

          if (data.lastDate === today) {
            btn.textContent = t.dailyDoneBtn;
            btn.disabled = true;
            btn.style.background = "#81c784";
            if (msg) msg.textContent = t.dailyMsgDone;
          } else {
            btn.textContent = t.dailyCompleteBtn;
            const listEl = document.getElementById("daily-menu-list");
            // ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã ã‘æœ‰åŠ¹åŒ–
            if (listEl && listEl.style.display === "block") {
              btn.disabled = false;
              btn.style.background = "#ff6f00";
              btn.style.cursor = "pointer";
            } else {
              btn.disabled = true;
              btn.style.background = "#ccc";
            }
            if (msg) msg.textContent = "";
          }
        }

        // ãƒãƒƒãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å‡¦ç†ï¼ˆå€‹äººãƒ‡ãƒ¼ã‚¿ã«åæ˜ ï¼‰
        function saveMapData() {
          let data = loadDailyData();
          data.mapJapanIdx = mapProgress.japan;
          data.mapWorldIdx = mapProgress.world;
          data.currentMapMode = currentMapMode;
          data.japanCompleted = mapProgress.japanCompleted;
          saveDailyData(data); // ã“ã“ã§å…¨ä½“ä¿å­˜ã•ã‚Œã‚‹
        }

        // ------------------------------------------------
        // C. ãƒãƒƒãƒ—æç”»æ©Ÿèƒ½ (Google Charts)
        // ------------------------------------------------

        let chart;
        let isChartLoaded = false;

        if (typeof google !== 'undefined' && google.charts) {
          google.charts.load('current', { 'packages': ['geochart'] });
          google.charts.setOnLoadCallback(() => {
            isChartLoaded = true;
            renderMap();
          });
        }

        // ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ (æ—¥æœ¬)
        const JAPAN_ROUTE = [
          { name: "åŒ—æµ·é“", code: "JP-01" }, { name: "é’æ£®", code: "JP-02" }, { name: "å²©æ‰‹", code: "JP-03" }, { name: "å®®åŸ", code: "JP-04" },
          { name: "ç§‹ç”°", code: "JP-05" }, { name: "å±±å½¢", code: "JP-06" }, { name: "ç¦å³¶", code: "JP-07" }, { name: "èŒ¨åŸ", code: "JP-08" },
          { name: "æ ƒæœ¨", code: "JP-09" }, { name: "ç¾¤é¦¬", code: "JP-10" }, { name: "åŸ¼ç‰", code: "JP-11" }, { name: "åƒè‘‰", code: "JP-12" },
          { name: "æ±äº¬", code: "JP-13" }, { name: "ç¥å¥ˆå·", code: "JP-14" }, { name: "æ–°æ½Ÿ", code: "JP-15" }, { name: "å¯Œå±±", code: "JP-16" },
          { name: "çŸ³å·", code: "JP-17" }, { name: "ç¦äº•", code: "JP-18" }, { name: "å±±æ¢¨", code: "JP-19" }, { name: "é•·é‡", code: "JP-20" },
          { name: "å²é˜œ", code: "JP-21" }, { name: "é™å²¡", code: "JP-22" }, { name: "æ„›çŸ¥", code: "JP-23" }, { name: "ä¸‰é‡", code: "JP-24" },
          { name: "æ»‹è³€", code: "JP-25" }, { name: "äº¬éƒ½", code: "JP-26" }, { name: "å¤§é˜ª", code: "JP-27" }, { name: "å…µåº«", code: "JP-28" },
          { name: "å¥ˆè‰¯", code: "JP-29" }, { name: "å’Œæ­Œå±±", code: "JP-30" }, { name: "é³¥å–", code: "JP-31" }, { name: "å³¶æ ¹", code: "JP-32" },
          { name: "å²¡å±±", code: "JP-33" }, { name: "åºƒå³¶", code: "JP-34" }, { name: "å±±å£", code: "JP-35" }, { name: "å¾³å³¶", code: "JP-36" },
          { name: "é¦™å·", code: "JP-37" }, { name: "æ„›åª›", code: "JP-38" }, { name: "é«˜çŸ¥", code: "JP-39" }, { name: "ç¦å²¡", code: "JP-40" },
          { name: "ä½è³€", code: "JP-41" }, { name: "é•·å´", code: "JP-42" }, { name: "ç†Šæœ¬", code: "JP-43" }, { name: "å¤§åˆ†", code: "JP-44" },
          { name: "å®®å´", code: "JP-45" }, { name: "é¹¿å…å³¶", code: "JP-46" }, { name: "æ²–ç¸„", code: "JP-47" }
        ];

        // ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ (ä¸–ç•Œ)
        const WORLD_ROUTE = [
          { name: "æ—¥æœ¬", code: "JP" }, { name: "éŸ“å›½", code: "KR" }, { name: "ä¸­å›½", code: "CN" }, { name: "ãƒ¢ãƒ³ã‚´ãƒ«", code: "MN" }, { name: "åŒ—æœé®®", code: "KP" },
          { name: "ãƒ™ãƒˆãƒŠãƒ ", code: "VN" }, { name: "ãƒ©ã‚ªã‚¹", code: "LA" }, { name: "ã‚«ãƒ³ãƒœã‚¸ã‚¢", code: "KH" }, { name: "ã‚¿ã‚¤", code: "TH" }, { name: "ãƒŸãƒ£ãƒ³ãƒãƒ¼", code: "MM" },
          { name: "ãƒãƒ¬ãƒ¼ã‚·ã‚¢", code: "MY" }, { name: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", code: "SG" }, { name: "ãƒ–ãƒ«ãƒã‚¤", code: "BN" }, { name: "ãƒ•ã‚£ãƒªãƒ”ãƒ³", code: "PH" }, { name: "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢", code: "ID" }, { name: "æ±ãƒ†ã‚£ãƒ¢ãƒ¼ãƒ«", code: "TL" },
          { name: "ã‚¤ãƒ³ãƒ‰", code: "IN" }, { name: "ãƒãƒ³ã‚°ãƒ©ãƒ‡ã‚·ãƒ¥", code: "BD" }, { name: "ãƒ–ãƒ¼ã‚¿ãƒ³", code: "BT" }, { name: "ãƒãƒ‘ãƒ¼ãƒ«", code: "NP" }, { name: "ã‚¹ãƒªãƒ©ãƒ³ã‚«", code: "LK" }, { name: "ãƒ¢ãƒ«ãƒ‡ã‚£ãƒ–", code: "MV" }, { name: "ãƒ‘ã‚­ã‚¹ã‚¿ãƒ³", code: "PK" },
          { name: "ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", code: "AU" }, { name: "ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ¼ãƒ©ãƒ³ãƒ‰", code: "NZ" }, { name: "ãƒ‘ãƒ—ã‚¢ãƒ‹ãƒ¥ãƒ¼ã‚®ãƒ‹ã‚¢", code: "PG" }, { name: "ã‚½ãƒ­ãƒ¢ãƒ³è«¸å³¶", code: "SB" }, { name: "ãƒãƒŒã‚¢ãƒ„", code: "VU" }, { name: "ãƒ•ã‚£ã‚¸ãƒ¼", code: "FJ" }, { name: "ã‚µãƒ¢ã‚¢", code: "WS" }, { name: "ãƒˆãƒ³ã‚¬", code: "TO" }, { name: "ãƒ„ãƒãƒ«", code: "TV" }, { name: "ã‚­ãƒªãƒã‚¹", code: "KI" }, { name: "ãƒãƒ¼ã‚·ãƒ£ãƒ«è«¸å³¶", code: "MH" }, { name: "ãƒŸã‚¯ãƒ­ãƒã‚·ã‚¢", code: "FM" }, { name: "ãƒ‘ãƒ©ã‚ª", code: "PW" }, { name: "ãƒŠã‚¦ãƒ«", code: "NR" },
          { name: "ã‚¢ãƒ•ã‚¬ãƒ‹ã‚¹ã‚¿ãƒ³", code: "AF" }, { name: "ã‚¿ã‚¸ã‚­ã‚¹ã‚¿ãƒ³", code: "TJ" }, { name: "ã‚­ãƒ«ã‚®ã‚¹", code: "KG" }, { name: "ã‚«ã‚¶ãƒ•ã‚¹ã‚¿ãƒ³", code: "KZ" }, { name: "ã‚¦ã‚ºãƒ™ã‚­ã‚¹ã‚¿ãƒ³", code: "UZ" }, { name: "ãƒˆãƒ«ã‚¯ãƒ¡ãƒ‹ã‚¹ã‚¿ãƒ³", code: "TM" }, { name: "ã‚¤ãƒ©ãƒ³", code: "IR" },
          { name: "ã‚¤ãƒ©ã‚¯", code: "IQ" }, { name: "ã‚¯ã‚¦ã‚§ãƒ¼ãƒˆ", code: "KW" }, { name: "ãƒãƒ¼ãƒ¬ãƒ¼ãƒ³", code: "BH" }, { name: "ã‚«ã‚¿ãƒ¼ãƒ«", code: "QA" }, { name: "UAE", code: "AE" }, { name: "ã‚ªãƒãƒ¼ãƒ³", code: "OM" }, { name: "ã‚¤ã‚¨ãƒ¡ãƒ³", code: "YE" }, { name: "ã‚µã‚¦ã‚¸ã‚¢ãƒ©ãƒ“ã‚¢", code: "SA" }, { name: "ãƒ¨ãƒ«ãƒ€ãƒ³", code: "JO" }, { name: "ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«", code: "IL" }, { name: "ãƒ¬ãƒãƒãƒ³", code: "LB" }, { name: "ã‚·ãƒªã‚¢", code: "SY" }, { name: "ãƒˆãƒ«ã‚³", code: "TR" },
          { name: "ã‚¢ã‚¼ãƒ«ãƒã‚¤ã‚¸ãƒ£ãƒ³", code: "AZ" }, { name: "ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢", code: "GE" }, { name: "ã‚¢ãƒ«ãƒ¡ãƒ‹ã‚¢", code: "AM" },
          { name: "ãƒ­ã‚·ã‚¢", code: "RU" }, { name: "ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠ", code: "UA" }, { name: "ãƒ™ãƒ©ãƒ«ãƒ¼ã‚·", code: "BY" }, { name: "ãƒ¢ãƒ«ãƒ‰ãƒ", code: "MD" }, { name: "ãƒ«ãƒ¼ãƒãƒ‹ã‚¢", code: "RO" }, { name: "ãƒ–ãƒ«ã‚¬ãƒªã‚¢", code: "BG" },
          { name: "ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰", code: "FI" }, { name: "ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³", code: "SE" }, { name: "ãƒãƒ«ã‚¦ã‚§ãƒ¼", code: "NO" }, { name: "ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰", code: "IS" }, { name: "ãƒ‡ãƒ³ãƒãƒ¼ã‚¯", code: "DK" }, { name: "ã‚¨ã‚¹ãƒˆãƒ‹ã‚¢", code: "EE" }, { name: "ãƒ©ãƒˆãƒ“ã‚¢", code: "LV" }, { name: "ãƒªãƒˆã‚¢ãƒ‹ã‚¢", code: "LT" },
          { name: "ãƒãƒ¼ãƒ©ãƒ³ãƒ‰", code: "PL" }, { name: "ãƒã‚§ã‚³", code: "CZ" }, { name: "ã‚¹ãƒ­ãƒã‚­ã‚¢", code: "SK" }, { name: "ãƒãƒ³ã‚¬ãƒªãƒ¼", code: "HU" }, { name: "ã‚ªãƒ¼ã‚¹ãƒˆãƒªã‚¢", code: "AT" }, { name: "ãƒ‰ã‚¤ãƒ„", code: "DE" }, { name: "ã‚¹ã‚¤ã‚¹", code: "CH" }, { name: "ãƒªãƒ’ãƒ†ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³", code: "LI" },
          { name: "ã‚ªãƒ©ãƒ³ãƒ€", code: "NL" }, { name: "ãƒ™ãƒ«ã‚®ãƒ¼", code: "BE" }, { name: "ãƒ«ã‚¯ã‚»ãƒ³ãƒ–ãƒ«ã‚¯", code: "LU" }, { name: "ã‚¤ã‚®ãƒªã‚¹", code: "GB" }, { name: "ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰", code: "IE" }, { name: "ãƒ•ãƒ©ãƒ³ã‚¹", code: "FR" }, { name: "ãƒ¢ãƒŠã‚³", code: "MC" },
          { name: "ã‚¹ãƒšã‚¤ãƒ³", code: "ES" }, { name: "ãƒãƒ«ãƒˆã‚¬ãƒ«", code: "PT" }, { name: "ã‚¢ãƒ³ãƒ‰ãƒ©", code: "AD" }, { name: "ã‚¤ã‚¿ãƒªã‚¢", code: "IT" }, { name: "ãƒãƒã‚«ãƒ³", code: "VA" }, { name: "ã‚µãƒ³ãƒãƒªãƒ", code: "SM" }, { name: "ãƒãƒ«ã‚¿", code: "MT" },
          { name: "ã‚®ãƒªã‚·ãƒ£", code: "GR" }, { name: "ã‚­ãƒ—ãƒ­ã‚¹", code: "CY" }, { name: "ã‚¢ãƒ«ãƒãƒ‹ã‚¢", code: "AL" }, { name: "åŒ—ãƒã‚±ãƒ‰ãƒ‹ã‚¢", code: "MK" }, { name: "ã‚»ãƒ«ãƒ“ã‚¢", code: "RS" }, { name: "ãƒ¢ãƒ³ãƒ†ãƒã‚°ãƒ­", code: "ME" }, { name: "ãƒœã‚¹ãƒ‹ã‚¢ãƒ»ãƒ˜ãƒ«ãƒ„ã‚§ã‚´ãƒ“ãƒŠ", code: "BA" }, { name: "ã‚¯ãƒ­ã‚¢ãƒã‚¢", code: "HR" }, { name: "ã‚¹ãƒ­ãƒ™ãƒ‹ã‚¢", code: "SI" },
          { name: "ã‚¨ã‚¸ãƒ—ãƒˆ", code: "EG" }, { name: "ãƒªãƒ“ã‚¢", code: "LY" }, { name: "ãƒãƒ¥ãƒ‹ã‚¸ã‚¢", code: "TN" }, { name: "ã‚¢ãƒ«ã‚¸ã‚§ãƒªã‚¢", code: "DZ" }, { name: "ãƒ¢ãƒ­ãƒƒã‚³", code: "MA" }, { name: "ãƒ¢ãƒ¼ãƒªã‚¿ãƒ‹ã‚¢", code: "MR" }, { name: "ãƒãƒª", code: "ML" }, { name: "ãƒ‹ã‚¸ã‚§ãƒ¼ãƒ«", code: "NE" }, { name: "ãƒãƒ£ãƒ‰", code: "TD" }, { name: "ã‚¹ãƒ¼ãƒ€ãƒ³", code: "SD" },
          { name: "ã‚»ãƒã‚¬ãƒ«", code: "SN" }, { name: "ã‚¬ãƒ³ãƒ“ã‚¢", code: "GM" }, { name: "ã‚®ãƒ‹ã‚¢ãƒ“ã‚µã‚¦", code: "GW" }, { name: "ã‚®ãƒ‹ã‚¢", code: "GN" }, { name: "ã‚·ã‚¨ãƒ©ãƒ¬ã‚ªãƒ", code: "SL" }, { name: "ãƒªãƒ™ãƒªã‚¢", code: "LR" }, { name: "ã‚³ãƒ¼ãƒˆã‚¸ãƒœãƒ¯ãƒ¼ãƒ«", code: "CI" }, { name: "ã‚¬ãƒ¼ãƒŠ", code: "GH" }, { name: "ãƒˆãƒ¼ã‚´", code: "TG" }, { name: "ãƒ™ãƒŠãƒ³", code: "BJ" }, { name: "ãƒŠã‚¤ã‚¸ã‚§ãƒªã‚¢", code: "NG" }, { name: "ãƒ–ãƒ«ã‚­ãƒŠãƒ•ã‚¡ã‚½", code: "BF" }, { name: "ã‚«ãƒ¼ãƒœãƒ™ãƒ«ãƒ‡", code: "CV" },
          { name: "ã‚«ãƒ¡ãƒ«ãƒ¼ãƒ³", code: "CM" }, { name: "ä¸­å¤®ã‚¢ãƒ•ãƒªã‚«", code: "CF" }, { name: "å—ã‚¹ãƒ¼ãƒ€ãƒ³", code: "SS" }, { name: "ã‚¨ãƒã‚ªãƒ”ã‚¢", code: "ET" }, { name: "ã‚¨ãƒªãƒˆãƒªã‚¢", code: "ER" }, { name: "ã‚¸ãƒ–ãƒ", code: "DJ" }, { name: "ã‚½ãƒãƒªã‚¢", code: "SO" }, { name: "ã‚±ãƒ‹ã‚¢", code: "KE" }, { name: "ã‚¦ã‚¬ãƒ³ãƒ€", code: "UG" }, { name: "ãƒ«ãƒ¯ãƒ³ãƒ€", code: "RW" }, { name: "ãƒ–ãƒ«ãƒ³ã‚¸", code: "BI" }, { name: "ã‚¿ãƒ³ã‚¶ãƒ‹ã‚¢", code: "TZ" },
          { name: "èµ¤é“ã‚®ãƒ‹ã‚¢", code: "GQ" }, { name: "ã‚¬ãƒœãƒ³", code: "GA" }, { name: "ã‚³ãƒ³ã‚´å…±å’Œå›½", code: "CG" }, { name: "ã‚³ãƒ³ã‚´æ°‘ä¸»å…±å’Œå›½", code: "CD" }, { name: "ã‚µãƒ³ãƒˆãƒ¡ãƒ»ãƒ—ãƒªãƒ³ã‚·ãƒš", code: "ST" },
          { name: "ã‚¢ãƒ³ã‚´ãƒ©", code: "AO" }, { name: "ã‚¶ãƒ³ãƒ“ã‚¢", code: "ZM" }, { name: "ãƒãƒ©ã‚¦ã‚¤", code: "MW" }, { name: "ãƒ¢ã‚¶ãƒ³ãƒ“ãƒ¼ã‚¯", code: "MZ" }, { name: "ãƒãƒ€ã‚¬ã‚¹ã‚«ãƒ«", code: "MG" }, { name: "ã‚³ãƒ¢ãƒ­", code: "KM" }, { name: "ãƒ¢ãƒ¼ãƒªã‚·ãƒ£ã‚¹", code: "MU" }, { name: "ã‚»ãƒ¼ã‚·ã‚§ãƒ«", code: "SC" },
          { name: "ã‚¸ãƒ³ãƒãƒ–ã‚¨", code: "ZW" }, { name: "ãƒœãƒ„ãƒ¯ãƒŠ", code: "BW" }, { name: "ãƒŠãƒŸãƒ“ã‚¢", code: "NA" }, { name: "å—ã‚¢ãƒ•ãƒªã‚«", code: "ZA" }, { name: "ãƒ¬ã‚½ãƒˆ", code: "LS" }, { name: "ã‚¨ã‚¹ãƒ¯ãƒ†ã‚£ãƒ‹", code: "SZ" },
          { name: "ãƒ–ãƒ©ã‚¸ãƒ«", code: "BR" }, { name: "ã‚¦ãƒ«ã‚°ã‚¢ã‚¤", code: "UY" }, { name: "ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³", code: "AR" }, { name: "ãƒãƒª", code: "CL" }, { name: "ãƒ‘ãƒ©ã‚°ã‚¢ã‚¤", code: "PY" }, { name: "ãƒœãƒªãƒ“ã‚¢", code: "BO" }, { name: "ãƒšãƒ«ãƒ¼", code: "PE" }, { name: "ã‚¨ã‚¯ã‚¢ãƒ‰ãƒ«", code: "EC" }, { name: "ã‚³ãƒ­ãƒ³ãƒ“ã‚¢", code: "CO" }, { name: "ãƒ™ãƒã‚ºã‚¨ãƒ©", code: "VE" }, { name: "ã‚¬ã‚¤ã‚¢ãƒŠ", code: "GY" }, { name: "ã‚¹ãƒªãƒŠãƒ ", code: "SR" },
          { name: "ãƒ‘ãƒŠãƒ", code: "PA" }, { name: "ã‚³ã‚¹ã‚¿ãƒªã‚«", code: "CR" }, { name: "ãƒ‹ã‚«ãƒ©ã‚°ã‚¢", code: "NI" }, { name: "ãƒ›ãƒ³ã‚¸ãƒ¥ãƒ©ã‚¹", code: "HN" }, { name: "ã‚¨ãƒ«ã‚µãƒ«ãƒãƒ‰ãƒ«", code: "SV" }, { name: "ã‚°ã‚¢ãƒ†ãƒãƒ©", code: "GT" }, { name: "ãƒ™ãƒªãƒ¼ã‚º", code: "BZ" }, { name: "ãƒ¡ã‚­ã‚·ã‚³", code: "MX" },
          { name: "ã‚­ãƒ¥ãƒ¼ãƒ", code: "CU" }, { name: "ã‚¸ãƒ£ãƒã‚¤ã‚«", code: "JM" }, { name: "ãƒã‚¤ãƒ", code: "HT" }, { name: "ãƒ‰ãƒŸãƒ‹ã‚«å…±å’Œå›½", code: "DO" }, { name: "ãƒãƒãƒ", code: "BS" }, { name: "ã‚»ãƒ³ãƒˆã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ãƒ»ãƒã‚¤ãƒ“ã‚¹", code: "KN" }, { name: "ã‚¢ãƒ³ãƒ†ã‚£ã‚°ã‚¢ãƒ»ãƒãƒ¼ãƒ–ãƒ¼ãƒ€", code: "AG" }, { name: "ãƒ‰ãƒŸãƒ‹ã‚«å›½", code: "DM" }, { name: "ã‚»ãƒ³ãƒˆãƒ«ã‚·ã‚¢", code: "LC" }, { name: "ã‚»ãƒ³ãƒˆãƒ“ãƒ³ã‚»ãƒ³ãƒˆãƒ»ã‚°ãƒ¬ãƒŠãƒ‡ã‚£ãƒ¼ãƒ³", code: "VC" }, { name: "ãƒãƒ«ãƒãƒ‰ã‚¹", code: "BB" }, { name: "ã‚°ãƒ¬ãƒŠãƒ€", code: "GD" }, { name: "ãƒˆãƒªãƒ‹ãƒ€ãƒ¼ãƒ‰ãƒ»ãƒˆãƒã‚´", code: "TT" },
          { name: "ã‚¢ãƒ¡ãƒªã‚«", code: "US" }, { name: "ã‚«ãƒŠãƒ€", code: "CA" }
        ];

        function updateMapUnlockState() {
          const btnWorld = document.getElementById("btn-map-world");
          if (!btnWorld) return;

          if (mapProgress.japanCompleted) {
            btnWorld.disabled = false;
            btnWorld.innerHTML = "ğŸŒ ä¸–ç•Œä¸€å‘¨";
            btnWorld.style.background = (currentMapMode === "world") ? "#0288d1" : "#b0bec5";
            btnWorld.style.color = "white";
            btnWorld.style.cursor = "pointer";
            btnWorld.style.boxShadow = "0 2px 4px rgba(0,0,0,0.2)";
          } else {
            btnWorld.disabled = true;
            btnWorld.innerHTML = "ğŸ”’ ä¸–ç•Œä¸€å‘¨ (æ—¥æœ¬ã‚¯ãƒªã‚¢ã§è§£æ”¾)";
            btnWorld.style.background = "#e0e0e0";
            btnWorld.style.color = "#999";
            btnWorld.style.cursor = "not-allowed";
            btnWorld.style.boxShadow = "none";
          }

          const btnJapan = document.getElementById("btn-map-japan");
          if (btnJapan) {
            btnJapan.style.background = (currentMapMode === "japan") ? "#8bc34a" : "#b0bec5";
          }
        }

        function renderMap() {
          if (!isChartLoaded) return;

          const container = document.getElementById('map-visual-container');
          if (!container) return;
          if (container.offsetWidth === 0 || container.offsetHeight === 0 || container.offsetParent === null) return;

          const isJapan = (currentMapMode === "japan");
          const route = isJapan ? JAPAN_ROUTE : WORLD_ROUTE;
          const currentIdx = isJapan ? mapProgress.japan : mapProgress.world;

          const dataArray = [['Code', 'Status', { role: 'tooltip' }]];

          route.forEach((item, index) => {
            let status = 0;
            if (index < currentIdx) status = 1;
            if (index === currentIdx) status = 2;
            dataArray.push([item.code, status, item.name]);
          });

          const data = google.visualization.arrayToDataTable(dataArray);

          const options = {
            colorAxis: { values: [0, 1, 2], colors: ['#e0e0e0', '#ffcc80', '#d50000'] },
            backgroundColor: '#b3e5fc',
            datalessRegionColor: '#f5f5f5',
            defaultColor: '#f5f5f5',
            legend: 'none',
            tooltip: { isHtml: true, showColorCode: false },
            margin: { top: 0, bottom: 0, left: 0, right: 0 }
          };

          if (isJapan) {
            options.region = 'JP';
            options.resolution = 'provinces';
          } else {
            options.region = 'world';
            options.resolution = 'countries';
          }

          chart = new google.visualization.GeoChart(container);
          chart.draw(data, options);

          const currentItem = route[currentIdx];
          const currentName = currentItem ? currentItem.name : "GOAL!";

          const nameEl = document.getElementById("current-location-name");
          if (nameEl) nameEl.textContent = currentName;

          const progEl = document.getElementById("map-progress-text");
          if (progEl) progEl.textContent = `${Math.min(currentIdx + 1, route.length)} / ${route.length} ${isJapan ? 'éƒ½é“åºœçœŒ' : 'Countries'}`;

          if (typeof updateMapUnlockState === "function") {
            updateMapUnlockState();
          }
        }

        function switchMapMode(mode) {
          currentMapMode = mode;
          saveMapData();
          renderMap();
        }

        function advanceMapProgress() {
          const route = currentMapMode === "japan" ? JAPAN_ROUTE : WORLD_ROUTE;
          const key = currentMapMode === "japan" ? "japan" : "world";

          if (mapProgress[key] < route.length - 1) {
            mapProgress[key]++;
          } else {
            if (currentMapMode === "japan") {
              if (!mapProgress.japanCompleted) {
                alert("ğŸ‰ æ—¥æœ¬ä¸€å‘¨é”æˆãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼\n\nğŸ”“ æ–°ãŸãªæŒ‘æˆ¦ã€Œä¸–ç•Œä¸€å‘¨ãƒ¢ãƒ¼ãƒ‰ã€ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼");
                mapProgress.japanCompleted = true;
              } else {
                alert("ğŸ‰ æ—¥æœ¬ä¸€å‘¨é”æˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼");
              }
              mapProgress.japan = 0;
            } else {
              alert("ğŸ‰ ä¸–ç•Œä¸€å‘¨é”æˆï¼Amazing! ç´ æ™´ã‚‰ã—ã„å‰æ¥­ã§ã™ï¼");
              mapProgress.world = 0;
            }
          }

          saveMapData();
          renderMap();
        }

        function toggleMapDisplay() {
          const mapArea = document.getElementById("map-collapsible-area");
          const icon = document.getElementById("map-toggle-icon");
          if (!mapArea) return;

          if (mapArea.style.display === "none") {
            mapArea.style.display = "block";
            if (icon) icon.textContent = "â–²";
            if (typeof renderMap === "function" && isChartLoaded) {
              renderMap();
            }
          } else {
            mapArea.style.display = "none";
            if (icon) icon.textContent = "â–¼";
          }
        }

        window.addEventListener('resize', () => {
          if (isChartLoaded) renderMap();
        });

        // ------------------------------------------------
        // D. ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”Ÿæˆãƒ»é”æˆå‡¦ç†
        // ------------------------------------------------

        // åˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
        document.addEventListener("DOMContentLoaded", () => {
          initDailyUser();
          renderMap();
        });

        async function generateDailyChallenge() {
          // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ç¢ºèª
          if (typeof sheetData === 'undefined' || !sheetData || sheetData.length === 0) {
            const statusEl = document.getElementById("statusMessage");
            if (statusEl) statusEl.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
            if (typeof loadSheet === 'function') {
              await loadSheet();
            } else {
              alert("ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
              return;
            }
          }

          if (!sheetData || sheetData.length === 0) {
            alert("ã‚¨ãƒ©ãƒ¼ï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚\nç”»é¢ã‚’æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          // ã€Œè£œå¼·ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æŠ½å‡ºï¼ˆãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«ã‚’é™¤å¤–ï¼‰
          const strengthMenus = sheetData.filter(m => {
            const cat = (m.ã‚«ãƒ†ã‚´ãƒª || m.category || "").toString();
            const name = (m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å || m.name || "").toString();
            return cat.includes("è£œå¼·") && !name.includes("ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«");
          });

          if (strengthMenus.length === 0) {
            alert(`âŒ æ¡ä»¶ã«åˆã†ã€Œè£œå¼·ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
            return;
          }

          const countInput = document.getElementById("daily-count");
          let count = parseInt(countInput.value) || 7;
          if (count > strengthMenus.length) count = strengthMenus.length;

          const shuffled = strengthMenus.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, count);

          const listContainer = document.getElementById("daily-menu-list");
          if (!listContainer) return;

          listContainer.innerHTML = `
        <div style="text-align: right; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
            <button id="btn-close-daily-list" style="background: #757575; color: white; border: none; border-radius: 4px; padding: 5px 15px; cursor: pointer; font-size: 12px;">
                Ã— ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
            </button>
        </div>
    `;

          document.getElementById("btn-close-daily-list").addEventListener("click", () => {
            listContainer.style.display = "none";
          });

          selected.forEach((m, index) => {
            const menuName = m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å || m.name || "åç§°ä¸æ˜";
            const menuDesc = m.èª¬æ˜ || m.note || "èª¬æ˜ãªã—";
            const menuUrl = m["YouTube URL"] || m.url || m.video_url || "";
            const menuImg = m["ç”»åƒURL"] || m.imgUrl || "";

            let videoLink = "";
            if (menuUrl) {
              videoLink = `<a href="${menuUrl}" target="_blank" style="font-size:12px; color:#1e88e5; text-decoration:none; display:block; margin-top:5px;">ğŸ“º å‹•ç”»ã‚’è¦‹ã‚‹</a>`;
            }

            let imageHtml = "";
            if (menuImg) {
              imageHtml = `
                <div style="flex: 0 0 80px; margin-right: 10px; display:flex; align-items:center; justify-content:center;">
                    <img src="${menuImg}" alt="img" style="width:100%; height:auto; max-height:60px; object-fit:contain; border-radius:4px; border:1px solid #eee;">
                </div>
            `;
            }

            const div = document.createElement("div");
            div.style.cssText = "padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: flex-start;";

            div.innerHTML = `
            ${imageHtml}
            <div style="flex: 1;">
                <div style="font-weight:bold; color:#333; font-size:15px; margin-bottom:4px;">
                    <span style="color:#ff6f00; margin-right:5px;">${index + 1}.</span>${menuName}
                </div>
                <div style="font-size:13px; color:#666; line-height:1.4;">
                    ${menuDesc}
                </div>
                ${videoLink}
            </div>
        `;
            listContainer.appendChild(div);
          });

          listContainer.style.display = "block";

          const btn = document.getElementById("btn-complete-challenge");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "âœ… ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆï¼";
            btn.style.background = "#ff6f00";
            btn.style.cursor = "pointer";
          }
        }

        // é”æˆå‡¦ç†ï¼ˆãƒãƒƒãƒ—é€²è¡Œã¨é€£å‹•ï¼‰
        window.completeDailyChallenge = function () {
          if (typeof playSportsDrum === 'function') playSportsDrum();

          const currentData = loadDailyData(); // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const today = new Date().toLocaleDateString("ja-JP");
          const yesterday = new Date(Date.now() - 86400000).toLocaleDateString("ja-JP");

          if (currentData.lastDate === today) return;

          if (currentData.lastDate === yesterday) {
            currentData.streak++;
          } else {
            currentData.streak = 1;
          }

          currentData.lastDate = today;
          currentData.totalBadges++;

          let alertMsg = `ğŸ–ï¸ ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼(${dailyUserData.currentUser}ã•ã‚“)`;

          if (currentData.streak > 0 && currentData.streak % 7 === 0) {
            currentData.weeklyBadges++;
            alertMsg += "\nğŸ† 1é€±é–“ç¶™ç¶šé”æˆï¼ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒãƒƒã‚¸ç²å¾—ï¼";
            if (typeof playBuzz === 'function') playBuzz(500, 600);
          }

          // ã¾ãšãƒ‡ãƒ¼ã‚¿ä¿å­˜
          saveDailyData(currentData);

          // ãƒãƒƒãƒ—ã‚’é€²ã‚ã‚‹ï¼ˆå†…éƒ¨ã§å†ä¿å­˜ãƒ»æç”»ï¼‰
          advanceMapProgress();

          // UIæ›´æ–°
          updateDailyUI();

          const msgEl = document.getElementById("daily-message");
          if (msgEl) msgEl.textContent = "ğŸ‰ ã‚¨ãƒªã‚¢åˆ¶è¦‡ï¼æ¬¡ã®ç›®çš„åœ°ã¸é€²ã¿ã¾ã™ï¼";
          alert(alertMsg);
        };

        function resetDailyData() {
          if (!confirm(`âš ï¸ ã€è­¦å‘Šã€‘\nç¾åœ¨é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${dailyUserData.currentUser}ã€ã®\næ—¥æœ¬ä¸€å‘¨ãƒ»ä¸–ç•Œä¸€å‘¨ã®é€²æ—ã€ãƒãƒƒã‚¸ã€è¨˜éŒ²ãŒã™ã¹ã¦æ¶ˆå»ã•ã‚Œã¾ã™ã€‚\n\næœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
          }

          // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
          const resetData = createDefaultDailyData();
          saveDailyData(resetData);

          // å¤‰æ•°ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
          mapProgress = { japan: 0, world: 0, japanCompleted: false };
          currentMapMode = "japan";

          updateDailyUI();
          renderMap();

          if (typeof updateMapUnlockState === "function") {
            updateMapUnlockState();
          }

          const msgEl = document.getElementById("daily-message");
          if (msgEl) msgEl.textContent = "";

          alert("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\næ–°ãŸãªæ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼ğŸŒ");
        }


        // ==========================================
        // ğŸ“ ãƒ«ãƒ¼ãƒ«å­¦ç¿’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (ä¿®æ­£ç‰ˆ)
        // ==========================================

        // ãƒã‚¸ã‚·ãƒ§ãƒ³åº§æ¨™ã®å®šç¾© (ä¿®æ­£: Bãƒãƒ¼ãƒ ã‚’å¯¾è§’ç·šé…ç½®ã«)
        /*
          ã€ç”»é¢ä¸Šã®é…ç½®ã€‘
          [ Aãƒãƒ¼ãƒ (å·¦) ]  vs  [ Bãƒãƒ¼ãƒ (å³) ]
          
          ä¸Šå´(25%): A-Odd(å·¦)  /  B-Even(å³)  <-- å¯¾è§’ç·š
          ä¸‹å´(75%): A-Even(å³) /  B-Odd(å·¦)   <-- å¯¾è§’ç·š
          
          â€»ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã®ã‚³ãƒ¼ãƒˆã¯å¯¾è§’ç·šã§å‘ã‹ã„åˆã„ã¾ã™ã€‚
          A(ä¸‹/Even)ã‹ã‚‰æ‰“ã¤ã¨ã€å—ã‘ã‚‹ã®ã¯B(ä¸Š/Even)ã«ãªã‚Šã¾ã™ã€‚
        */
        const posMap = {
          // Aãƒãƒ¼ãƒ  (å·¦å´)
          "l-odd": { t: "25%", l: "35%" }, // ä¸Š (å¥‡æ•°ã‚³ãƒ¼ãƒˆ)
          "l-even": { t: "75%", l: "35%" }, // ä¸‹ (å¶æ•°ã‚³ãƒ¼ãƒˆ)
          // Bãƒãƒ¼ãƒ  (å³å´) - ã“ã“ã‚’ä¿®æ­£
          "r-even": { t: "25%", l: "65%" }, // ä¸Š (å¶æ•°ã‚³ãƒ¼ãƒˆ) â€»Aã®ä¸‹ã¨å¯¾è§’
          "r-odd": { t: "75%", l: "65%" }  // ä¸‹ (å¥‡æ•°ã‚³ãƒ¼ãƒˆ) â€»Aã®ä¸Šã¨å¯¾è§’
        };

        // ==========================================
        // 1. ãƒ«ãƒ¼ãƒ«ç¢ºèªã‚¯ã‚¤ã‚º (è©¦åˆå‰ã®äºˆç¿’)
        // ==========================================
        const ruleQuizData = [
          {
            title: "ãƒ«ãƒ¼ãƒ«ç¢ºèª Q1: ã‚µãƒ¼ãƒ“ã‚¹ã®ç€åœ°(å¥¥)",
            text: "ãƒ€ãƒ–ãƒ«ã‚¹ã®ãƒ­ãƒ³ã‚°ã‚µãƒ¼ãƒ–ã‚’æ‰“ã¡ã¾ã—ãŸã€‚\nãƒ¬ã‚·ãƒ¼ãƒãƒ¼å´ã®ã‚³ãƒ¼ãƒˆã®**ä¸€ç•ªå¥¥ã®ãƒ©ã‚¤ãƒ³**ï¼ˆãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³ï¼‰ã®ä¸Šã«è½ã¡ã¾ã—ãŸã€‚\nåˆ¤å®šã¯ï¼Ÿ",
            options: ["ã‚¤ãƒ³ (æœ‰åŠ¹)", "ã‚¢ã‚¦ãƒˆ (ãƒ•ã‚©ãƒ«ãƒˆ)"],
            correctIdx: 1, // ã‚¢ã‚¦ãƒˆ
            explain: "æ­£è§£ã¯ã€Œã‚¢ã‚¦ãƒˆ(ãƒ•ã‚©ãƒ«ãƒˆ)ã€ã§ã™ã€‚âŒ\nãƒ€ãƒ–ãƒ«ã‚¹ã®ã‚µãƒ¼ãƒ–ã¯ã€**ãƒ­ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ãƒ©ã‚¤ãƒ³(å¥¥ã‹ã‚‰2æœ¬ç›®ã®ç·š)**ã¾ã§ãŒæœ‰åŠ¹ã§ã™ã€‚\nã‚·ãƒ³ã‚°ãƒ«ã‚¹ã¨ã¯é•ã†ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ï¼"
          },
          {
            title: "ãƒ«ãƒ¼ãƒ«ç¢ºèª Q2: ã‚µãƒ¼ãƒ“ã‚¹ã®ç€åœ°(æ‰‹å‰)",
            text: "ã‚µãƒ¼ãƒ–ãŒã€ãƒãƒƒãƒˆè¿‘ãã®**ã‚·ãƒ§ãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹ãƒ©ã‚¤ãƒ³**ã‚ˆã‚Šæ‰‹å‰ã«è½ã¡ã¾ã—ãŸã€‚\nåˆ¤å®šã¯ï¼Ÿ",
            options: ["ã‚¤ãƒ³ (æœ‰åŠ¹)", "ã‚¢ã‚¦ãƒˆ (ãƒ•ã‚©ãƒ«ãƒˆ)", "ãƒ¬ãƒƒãƒˆ (ã‚„ã‚Šç›´ã—)"],
            correctIdx: 1, // ã‚¢ã‚¦ãƒˆ
            explain: "æ­£è§£ã¯ã€Œã‚¢ã‚¦ãƒˆ(ãƒ•ã‚©ãƒ«ãƒˆ)ã€ã§ã™ã€‚âŒ\nã‚µãƒ¼ãƒ–ã¯å¿…ãšã‚·ãƒ§ãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹ãƒ©ã‚¤ãƒ³(ãƒãƒƒãƒˆã‹ã‚‰1.98m)ã‚’è¶…ãˆã¦å¥¥ã®ã‚¨ãƒªã‚¢ã«å…¥ã‚‰ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚"
          },
          {
            title: "ãƒ«ãƒ¼ãƒ«ç¢ºèª Q3: ã‚µãƒ¼ãƒ“ã‚¹ã®é«˜ã•",
            text: "ã‚µãƒ¼ãƒ–ã‚’æ‰“ã¤ç¬é–“ã®æ‰“ç‚¹ãŒã€ãƒãƒƒãƒˆä¸Šéƒ¨ã®ç™½å¸¯ã¨åŒã˜ãã‚‰ã„ã®é«˜ã•ã ã£ãŸã€‚\nåˆ¤å®šã¯ï¼Ÿ",
            options: ["æœ‰åŠ¹", "ãƒ•ã‚©ãƒ«ãƒˆ", "ç›¸æ‰‹ã®åŒæ„ãŒã‚ã‚Œã°æœ‰åŠ¹"],
            correctIdx: 1, // ãƒ•ã‚©ãƒ«ãƒˆ
            explain: "æ­£è§£ã¯ã€Œãƒ•ã‚©ãƒ«ãƒˆã€ã§ã™ã€‚âŒ\nç¾è¡Œãƒ«ãƒ¼ãƒ«ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®èº«é•·ã«é–¢ã‚ã‚‰ãšã€æ‰“ã¤ç¬é–“ã®ã‚·ãƒ£ãƒˆãƒ«ã®ä½ç½®ãŒåºŠã‹ã‚‰**1.15mã®é«˜ã•ä»¥ä¸‹**ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚\nç›®å®‰ã¯ã‚·ãƒ£ãƒˆãƒ«ã®ç­’3æœ¬ã‚’é‡ã­ãŸé«˜ã•ã‚ˆã‚Šä¸‹ã§æ‰“ã¤ã€‚"
          }
        ];

        // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿
        const scenarioData = [
          // --- Q1: 0-0 ---
          {
            text: "è©¦åˆé–‹å§‹ï¼ã‚¹ã‚³ã‚¢ 0-0ã€‚\nAãƒãƒ¼ãƒ ãŒã‚µãƒ¼ãƒ–æ¨©ã‚’æŒã£ã¦ã„ã¾ã™ã€‚\nA1ã¯ã©ã“ã‹ã‚‰ã€èª°ã«å‘ã‹ã£ã¦æ‰“ã¡ã¾ã™ã‹ï¼Ÿ",
            score: { a: 0, b: 0 },
            // A1(ä¸‹/Even), A2(ä¸Š/Odd) vs B1(ä¸Š/Even), B2(ä¸‹/Odd)
            pos: { A1: "l-even", A2: "l-odd", B1: "r-even", B2: "r-odd" },
            shuttlePos: "l-even",
            options: [
              "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã€B2(å·¦/æ­£é¢)ã¸",
              "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã€B1(å³/å¯¾è§’)ã¸", // æ­£è§£
              "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã€B1ã€B2ã©ã¡ã‚‰ã«ã‚‚æ‰“ã£ã¦è‰¯ã„"
            ],
            correctIdx: 1,
            explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\n0ç‚¹ã¯å¶æ•°ãªã®ã§ã€A1ã¯å³(å¶æ•°ã‚³ãƒ¼ãƒˆ/ç”»é¢ä¸‹)ã‹ã‚‰æ‰“ã¡ã¾ã™ã€‚\nãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã¯å¯¾è§’ç·šã®ã‚¨ãƒªã‚¢(ç”»é¢ä¸Š)ã«ã„ã‚‹B1ã§ã™ã€‚"
          },

          // --- Q2: 1-0 (AãŒå¾—ç‚¹) ---
          {
            text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ å¾—ç‚¹ï¼ 1-0ã€‚\nã‚µãƒ¼ãƒãƒ¼å´ãŒå¾—ç‚¹ã—ãŸã®ã§Aã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚\næ¬¡ã¯èª°ãŒã©ã“ã‹ã‚‰ï¼Ÿ",
            score: { a: 1, b: 0 },
            // Aãƒ­ãƒ¼ãƒ†(A1ä¸Šã¸, A2ä¸‹ã¸)ã€‚ Bä¸å‹•(B1ä¸Šã¾ã¾, B2ä¸‹ã¾ã¾)ã€‚
            pos: { A1: "l-odd", A2: "l-even", B1: "r-even", B2: "r-odd" },
            shuttlePos: "l-odd",
            options: [
              "A1ãŒå·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã‚µãƒ¼ãƒ–", // æ­£è§£
              "A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã‚µãƒ¼ãƒ–",
              "A2ãŒå·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰ã‚µãƒ¼ãƒ–"
            ],
            correctIdx: 0,
            explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\nA1ã¯å¾—ç‚¹ã—ãŸã®ã§ä½ç½®ã‚’äº¤ä»£(ãƒ­ãƒ¼ãƒ†)ã—ã€1ç‚¹(å¥‡æ•°)ãªã®ã§å·¦(ç”»é¢ä¸Š)ã‹ã‚‰æ‰“ã¡ã¾ã™ã€‚\nâ˜…Bãƒãƒ¼ãƒ ã¯ãƒ¬ã‚·ãƒ¼ãƒ–å´ã ã£ãŸã®ã§å‹•ãã¾ã›ã‚“ã€‚"
          },

          // --- Q3: 1-1 (BãŒå¾—ç‚¹ / ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ) ---
          {
            text: "ã€ãƒ©ãƒªãƒ¼ã€‘Bãƒãƒ¼ãƒ å¾—ç‚¹ï¼ 1-1ã€‚\nã‚µãƒ¼ãƒ–æ¨©ãŒBã¸ç§»ã‚Šã¾ã™(ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ)ã€‚\nèª°ãŒã‚µãƒ¼ãƒ–ã‚’æ‰“ã¡ã¾ã™ã‹ï¼Ÿ",
            score: { a: 1, b: 1 },
            // ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚ã¯èª°ã‚‚å‹•ã‹ãªã„ã€‚ä½ç½®ã¯Q2ã¨åŒã˜ã€‚
            // B1(ä¸Š/Even), B2(ä¸‹/Odd)ã€‚
            pos: { A1: "l-odd", A2: "l-even", B1: "r-even", B2: "r-odd" },
            shuttlePos: "r-odd",
            options: [
              "B1ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–",
              "B2ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–", // æ­£è§£
              "ä½ç½®ã‚’äº¤ä»£ã—ã¦B1ãŒå·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰"
            ],
            correctIdx: 1,
            explain: "ãã®é€šã‚Šï¼ğŸ™†â€â™‚ï¸\nã‚µãƒ¼ãƒ–æ¨©ãŒç§»ã‚‹æ™‚ã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã›ã‚“ã€‚\nBã®å¾—ç‚¹ã¯ã€Œ1ç‚¹(å¥‡æ•°)ã€ã§ã™ã€‚\nç¾åœ¨ã€å¥‡æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸‹)ã«ç«‹ã£ã¦ã„ã‚‹ã€B2ã€‘ãŒã‚µãƒ¼ãƒ–æ¨©ã‚’å¾—ã¾ã™ã€‚"
          },

          // --- Q4: 1-2 (BãŒé€£ç¶šå¾—ç‚¹) ---
          {
            text: "ã€ãƒ©ãƒªãƒ¼ã€‘Bãƒãƒ¼ãƒ é€£ç¶šå¾—ç‚¹ï¼ 1-2ã€‚\nBãƒãƒ¼ãƒ ã®å‹•ãã¯ï¼Ÿ",
            score: { a: 1, b: 2 },
            // BãŒã‚µãƒ¼ãƒãƒ¼å´ã§å¾—ç‚¹ã€‚Bã®ã¿ãƒ­ãƒ¼ãƒ†(B1ä¸‹ã¸, B2ä¸Šã¸)ã€‚Aä¸å‹•ã€‚
            pos: { A1: "l-odd", A2: "l-even", B1: "r-odd", B2: "r-even" },
            shuttlePos: "r-even",
            options: [
              "B2ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã¸ç§»å‹•ã—ã¦ã‚µãƒ¼ãƒ–", // æ­£è§£
              "B2ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã®ã¾ã¾ã‚µãƒ¼ãƒ–",
              "B1ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–"
            ],
            correctIdx: 0,
            explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\nã‚µãƒ¼ãƒ–å´ãŒå¾—ç‚¹ã—ãŸã®ã§Bãƒãƒ¼ãƒ ã¯ä½ç½®ã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚\n2ç‚¹(å¶æ•°)ãªã®ã§ã€B2ã¯å¶æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸Š)ã¸ç§»å‹•ã—ã¦æ‰“ã¡ã¾ã™ã€‚"
          },

          // --- Q5: 2-2 (AãŒå¾—ç‚¹ / ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆ) ---
          {
            text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ å¾—ç‚¹ï¼ 2-2ã€‚\nã‚µãƒ¼ãƒ–æ¨©ãŒAã«æˆ»ã‚Šã¾ã—ãŸã€‚\nèª°ãŒã©ã“ã‹ã‚‰ï¼Ÿ",
            score: { a: 2, b: 2 },
            // ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã€‚èª°ã‚‚å‹•ã‹ãªã„ã€‚ä½ç½®ã¯Q4ã¨åŒã˜ã€‚
            // A1(ä¸Š/Odd), A2(ä¸‹/Even)ã€‚
            pos: { A1: "l-odd", A2: "l-even", B1: "r-odd", B2: "r-even" },
            shuttlePos: "l-even",
            options: [
              "A1ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–",
              "A2ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã‹ã‚‰ã‚µãƒ¼ãƒ–", // æ­£è§£
              "ãƒ­ãƒ¼ãƒ†ã—ã¦A1ãŒå³(å¶æ•°ã‚³ãƒ¼ãƒˆ)ã‹ã‚‰"
            ],
            correctIdx: 1,
            explain: "æ­£è§£ï¼ğŸ™†â€â™‚ï¸\nã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆãªã®ã§ä½ç½®ã¯ãã®ã¾ã¾ã€‚\nAã®å¾—ç‚¹ã¯ã€Œ2ç‚¹(å¶æ•°)ã€ã§ã™ã€‚\nç¾åœ¨ã€å¶æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸‹)ã«ã„ã‚‹ã€A2ã€‘ãŒã‚µãƒ¼ãƒ–æ¨©ã‚’å¾—ã¾ã™ã€‚"
          },

          // --- Q6: 3-2 (AãŒé€£ç¶šå¾—ç‚¹) ---
          {
            text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ é€†è»¢ï¼ 3-2ã€‚\nAãƒãƒ¼ãƒ ã¯ã©ã†å‹•ãï¼Ÿ",
            score: { a: 3, b: 2 },
            // Aã®ã¿ãƒ­ãƒ¼ãƒ†(A1ä¸‹ã¸, A2ä¸Šã¸)ã€‚
            pos: { A1: "l-even", A2: "l-odd", B1: "r-odd", B2: "r-even" },
            shuttlePos: "l-odd",
            options: [
              "A2ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã¸ç§»å‹•ã—ã¦ã‚µãƒ¼ãƒ–", // æ­£è§£
              "A2ãŒ å³(å¶æ•°ã‚³ãƒ¼ãƒˆ) ã®ã¾ã¾ã‚µãƒ¼ãƒ–",
              "A1ãŒ å·¦(å¥‡æ•°ã‚³ãƒ¼ãƒˆ) ã¸ç§»å‹•ã—ã¦ã‚µãƒ¼ãƒ–"
            ],
            correctIdx: 0,
            explain: "ãã®é€šã‚Šï¼ğŸ™†â€â™‚ï¸\nã‚µãƒ¼ãƒãƒ¼å´ãŒå¾—ç‚¹ã—ãŸã®ã§Aã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚\n3ç‚¹(å¥‡æ•°)ãªã®ã§ã€A2ã¯å¥‡æ•°ã‚³ãƒ¼ãƒˆ(ç”»é¢ä¸Š)ã¸ç§»å‹•ã—ã¦æ‰“ã¡ã¾ã™ã€‚"
          },

          // --- Q7: 5-2 (AãŒé€£å–ã—ã¦è©¦åˆçµ‚äº†) ---
          {
            text: "ã€ãƒ©ãƒªãƒ¼ã€‘Aãƒãƒ¼ãƒ ãŒå¾—ç‚¹ã‚’é‡ã­ 5-2 ã§å‹åˆ©ï¼(5ç‚¹ãƒãƒƒãƒ)\næœ€å¾Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ï¼Ÿ",
            score: { a: 5, b: 2 },
            // è©¦åˆçµ‚äº†ã€‚
            pos: { A1: "l-even", A2: "l-odd", B1: "r-odd", B2: "r-even" },
            shuttlePos: "l-odd",
            options: [
              "ç›¸äº’ã«æ•¬æ„ã‚’æ‰•ã„æ¡æ‰‹ã—ã¦çµ‚äº†", // æ­£è§£
              "æ€–ã„é¡”ã§å¨åœ§ã™ã‚‹",
              "ç„¡è¦–ã—ã¦ã‚³ãƒ¼ãƒˆã‚’å»ã‚‹"
            ],
            correctIdx: 0,
            explain: "æ­£è§£ã§ã™ï¼ğŸ™†â€â™‚ï¸\nå‹æ•—ã«é–¢ã‚ã‚‰ãšã€æœ€å¾Œã¯äº’ã„ã®å¥é—˜ã‚’ç§°ãˆåˆã„ã€æ„Ÿè¬ã‚’è¾¼ã‚ã¦æ¡æ‰‹ï¼ˆæŒ¨æ‹¶ï¼‰ã‚’ã—ã¾ã™ã€‚\nã€Œå¯¾æˆ¦ç›¸æ‰‹ãŒã„ã¦ã“ãè©¦åˆãŒã§ãã‚‹ã€ã¨ã„ã†ãƒªã‚¹ãƒšã‚¯ãƒˆã®ç²¾ç¥ã“ããŒã€ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã¨ã„ã†ã‚¹ãƒãƒ¼ãƒ„ã®ä¾¡å€¤ã‚’é«˜ã‚ã‚‹æœ€ã‚‚ç¾ã—ã„ç¬é–“ã§ã™ã€‚"
          }
        ];

        let currentStepIndex = 0;

        // ==========================================
        // ğŸ•¹ï¸ 2. ãƒ­ã‚¸ãƒƒã‚¯ (åˆ¶å¾¡ãƒ—ãƒ­ã‚°ãƒ©ãƒ )
        // ==========================================

        let currentRuleQuizIndex = 0; // âœ… åå‰ã‚’å¤‰æ›´ã—ã¦é‡è¤‡ã‚’å›é¿

        // --- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡ ---
        window.startQuizMode = function () {
          document.getElementById("sim-start-screen").style.display = "none";
          document.getElementById("sim-quiz-screen").style.display = "block";

          currentRuleQuizIndex = 0; // âœ… å¤‰æ•°åå¤‰æ›´
          renderQuiz();
        };

        function getBadmintonCourtSVG() {
          // ViewBox: å¹…1800, é«˜ã•1000
          const svgCode = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1800 1000">
      <defs>
        <marker id="arrow-black" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#333" />
        </marker>
        <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#d32f2f" />
        </marker>
        <marker id="arrow-gray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
          <path d="M0,0 L0,6 L9,3 z" fill="#555" />
        </marker>
      </defs>

      <rect x="0" y="0" width="1800" height="1000" fill="#ffffff"/>
      
      <g transform="translate(400, 120)">
        
        <text x="250" y="-50" font-size="40" font-weight="bold" fill="#1a237e" text-anchor="middle" font-family="'Noto Sans JP', sans-serif">
          â‘  ã‚µãƒ¼ãƒ“ã‚¹æ™‚ (0-0 å¶æ•°å´)
        </text>

        <rect x="0" y="0" width="500" height="760" fill="#e8f5e9" stroke="none"/>
        
        <rect x="250" y="480" width="250" height="220" fill="#ffeb3b" stroke="none"/>

        <g stroke="#333" stroke-width="4" fill="none">
          <rect x="0" y="0" width="500" height="760" /> 
          <line x1="0" y1="60" x2="500" y2="60" stroke="#bbb" />
          <line x1="0" y1="700" x2="500" y2="700" stroke="#d32f2f" stroke-width="6"/> <line x1="0" y1="280" x2="500" y2="280" stroke="#bbb" />
          <line x1="0" y1="480" x2="500" y2="480" stroke="#333" /> <line x1="40" y1="0" x2="40" y2="760" stroke="#bbb" stroke-dasharray="5,5"/>
          <line x1="460" y1="0" x2="460" y2="760" stroke="#bbb" stroke-dasharray="5,5"/>
          <line x1="250" y1="60" x2="250" y2="280" stroke="#bbb"/>
          <line x1="250" y1="480" x2="250" y2="700" stroke="#333"/>
        </g>

        <line x1="-20" y1="380" x2="520" y2="380" stroke="#1565c0" stroke-width="5" stroke-dasharray="10,5"/>

        <g font-family="'Noto Sans JP', sans-serif" font-weight="bold" font-size="32">
          
          <text x="-40" y="490" fill="#333" text-anchor="end" alignment-baseline="middle">ã‚·ãƒ§ãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹</text>
          <line x1="-30" y1="480" x2="-5" y2="480" stroke="#333" stroke-width="3" marker-end="url(#arrow-black)"/>

          <text x="-40" y="710" fill="#d32f2f" text-anchor="end" alignment-baseline="middle">ãƒ€ãƒ–ãƒ«ã‚¹ãƒ­ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹</text>
          <line x1="-30" y1="700" x2="-5" y2="700" stroke="#d32f2f" stroke-width="3" marker-end="url(#arrow-red)"/>
          
          <text x="250" y="810" fill="#333" text-anchor="middle">ãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³</text>
        </g>
      </g>


      <g transform="translate(1150, 120)">
        
        <text x="250" y="-50" font-size="40" font-weight="bold" fill="#1a237e" text-anchor="middle" font-family="'Noto Sans JP', sans-serif">
          â‘¡ ãƒ©ãƒªãƒ¼ä¸­ã®æœ‰åŠ¹ã‚¨ãƒªã‚¢
        </text>

        <rect x="0" y="0" width="500" height="760" fill="#ffeb3b" stroke="none"/>
        
        <g stroke="#333" stroke-width="4" fill="none">
          <rect x="0" y="0" width="500" height="760" stroke="#333" /> 
          <line x1="0" y1="760" x2="500" y2="760" stroke="#d32f2f" stroke-width="6"/> <line x1="0" y1="60" x2="500" y2="60" stroke="#bbb"/>
          <line x1="0" y1="700" x2="500" y2="700" stroke="#bbb"/>
          <line x1="0" y1="280" x2="500" y2="280" stroke="#bbb"/>
          <line x1="0" y1="480" x2="500" y2="480" stroke="#bbb"/>
          <line x1="40" y1="0" x2="40" y2="760" />
          <line x1="460" y1="0" x2="460" y2="760" />
          <line x1="250" y1="0" x2="250" y2="280" stroke="#bbb"/>
          <line x1="250" y1="480" x2="250" y2="760" stroke="#bbb"/>
        </g>

        <line x1="-20" y1="380" x2="520" y2="380" stroke="#1565c0" stroke-width="5" stroke-dasharray="10,5"/>

        <g font-family="'Noto Sans JP', sans-serif" font-weight="bold" font-size="32">
          
          <text x="540" y="600" fill="#333" alignment-baseline="middle">ãƒ€ãƒ–ãƒ«ã‚¹ã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³</text>
          <line x1="530" y1="600" x2="505" y2="600" stroke="#333" stroke-width="3" marker-end="url(#arrow-black)"/>

          <text x="540" y="200" fill="#555" alignment-baseline="middle" font-size="28">ã‚·ãƒ³ã‚°ãƒ«ã‚¹ã‚µã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³</text>
          <line x1="530" y1="200" x2="465" y2="200" stroke="#555" stroke-width="3" marker-end="url(#arrow-gray)"/>
          
          <text x="250" y="810" fill="#d32f2f" text-anchor="middle">ãƒãƒƒã‚¯ãƒã‚¦ãƒ³ãƒ€ãƒªãƒ¼ãƒ©ã‚¤ãƒ³</text>
        </g>
      </g>

    </svg>
  `;
          return svgCode;
        }

        window.renderQuiz = function () {
          // âœ… ruleQuizData ã¨ currentRuleQuizIndex ã‚’ä½¿ç”¨
          const q = ruleQuizData[currentRuleQuizIndex];

          document.getElementById("quiz-progress").innerText = `(${currentRuleQuizIndex + 1}/${ruleQuizData.length})`;
          document.getElementById("quiz-text").innerText = q.text;

          const diagramContainer = document.getElementById("court-diagram-container");
          // å•é¡Œã‚¿ã‚¤ãƒˆãƒ«ã« Q1, Q2, Q3 ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰å›³ã‚’è¡¨ç¤º
          if (q.title.includes("Q1") || q.title.includes("Q2") || q.title.includes("Q3")) {
            diagramContainer.innerHTML = getBadmintonCourtSVG(); // SVGã‚’ç”Ÿæˆã—ã¦æŒ¿å…¥
            diagramContainer.style.display = "block"; // è¡¨ç¤ºã™ã‚‹
          } else {
            diagramContainer.innerHTML = ""; // ä¸­èº«ã‚’ç©ºã«ã™ã‚‹
            diagramContainer.style.display = "none"; // éè¡¨ç¤ºã«ã™ã‚‹
          }

          const container = document.getElementById("quiz-options-container");
          container.innerHTML = "";
          q.options.forEach((opt, idx) => {
            const btn = document.createElement("button");
            btn.innerText = opt;
            btn.style.padding = "12px";
            btn.style.border = "1px solid #ccc";
            btn.style.borderRadius = "4px";
            btn.style.cursor = "pointer";
            btn.style.background = "white";
            btn.style.color = "#333"; // âœ… ã€è¿½åŠ ã€‘ æ–‡å­—è‰²ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼ˆã»ã¼é»’ï¼‰ã«æŒ‡å®š
            btn.style.textAlign = "left";
            btn.style.fontSize = "15px";
            btn.onclick = () => checkQuizAnswer(idx, btn);
            container.appendChild(btn);
          });

          document.getElementById("quiz-explanation").style.display = "none";
          document.getElementById("btn-next-quiz").style.display = "none";
        };

        window.checkQuizAnswer = function (selectedIdx, btnElement) {
          // âœ… ruleQuizData ã¨ currentRuleQuizIndex ã‚’ä½¿ç”¨
          const q = ruleQuizData[currentRuleQuizIndex];
          const allBtns = document.getElementById("quiz-options-container").children;

          for (let btn of allBtns) btn.disabled = true;

          if (selectedIdx === q.correctIdx) {
            btnElement.style.background = "#c8e6c9";
            btnElement.innerHTML += " â­• æ­£è§£ï¼";
          } else {
            btnElement.style.background = "#ffcdd2";
            btnElement.innerHTML += " âŒ";
            allBtns[q.correctIdx].style.background = "#c8e6c9";
            allBtns[q.correctIdx].innerHTML += " (æ­£è§£)";
          }

          document.getElementById("quiz-explanation-text").innerText = q.explain;
          document.getElementById("quiz-explanation").style.display = "block";

          const nextBtn = document.getElementById("btn-next-quiz");
          nextBtn.style.display = "inline-block";

          // âœ… ruleQuizData ã¨ currentRuleQuizIndex ã‚’ä½¿ç”¨
          if (currentRuleQuizIndex === ruleQuizData.length - 1) {
            nextBtn.innerText = "è©¦åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¸ â–¶";
            nextBtn.onclick = startMatchMode;
          } else {
            nextBtn.innerText = "æ¬¡ã¸ â–¶";
            nextBtn.onclick = nextQuiz;
          }
        };

        window.nextQuiz = function () {
          currentRuleQuizIndex++; // âœ… å¤‰æ•°åå¤‰æ›´
          renderQuiz();
        };

        window.startMatchMode = function () {
          document.getElementById("sim-quiz-screen").style.display = "none";
          document.getElementById("sim-game-screen").style.display = "block";
          currentStepIndex = 0;
          openSimulation();
        };

        window.openSimulation = function () {
          renderStep();
        };

        window.renderStep = function () {
          const step = scenarioData[currentStepIndex];
          document.getElementById("scenario-title").innerText = `Q${currentStepIndex + 1}`;
          document.getElementById("scenario-text").innerText = step.text;
          document.getElementById("sim-score-a").innerText = step.score.a;
          document.getElementById("sim-score-b").innerText = step.score.b;

          movePlayer("p-A1", step.pos.A1);
          movePlayer("p-A2", step.pos.A2);
          movePlayer("p-B1", step.pos.B1);
          movePlayer("p-B2", step.pos.B2);

          const sPos = posMap[step.shuttlePos];
          const shuttle = document.getElementById("sim-shuttle");
          if (sPos) {
            shuttle.style.top = sPos.t;
            shuttle.style.left = sPos.l;
            shuttle.style.display = "block";
          } else {
            shuttle.style.display = "none";
          }

          const container = document.getElementById("sim-options-container");
          container.innerHTML = "";

          step.options.forEach((opt, idx) => {
            const btn = document.createElement("button");
            btn.innerText = opt;
            btn.style.padding = "10px";
            btn.style.border = "1px solid #ccc";
            btn.style.borderRadius = "5px";
            btn.style.cursor = "pointer";
            btn.style.background = "#fff";
            btn.style.color = "#333";
            btn.style.fontSize = "14px";
            btn.onclick = () => checkAnswer(idx, btn);
            container.appendChild(btn);
          });

          document.getElementById("sim-explanation").style.display = "none";
          document.getElementById("btn-next-step").style.display = "none";
        };

        window.movePlayer = function (id, posKey) {
          const el = document.getElementById(id);
          const coords = posMap[posKey];
          if (coords) {
            el.style.top = coords.t;
            el.style.left = coords.l;
            el.style.transform = "translate(-50%, -50%)";
          }
        };

        window.checkAnswer = function (selectedIdx, btnElement) {
          const step = scenarioData[currentStepIndex];
          const allBtns = document.getElementById("sim-options-container").children;

          for (let btn of allBtns) btn.disabled = true;

          if (selectedIdx === step.correctIdx) {
            btnElement.style.background = "#c8e6c9";
            btnElement.innerHTML += " â­•";
          } else {
            btnElement.style.background = "#ffcdd2";
            btnElement.innerHTML += " âŒ";
            allBtns[step.correctIdx].style.background = "#c8e6c9";
          }

          document.getElementById("sim-explanation-text").innerText = step.explain;
          document.getElementById("sim-explanation").style.display = "block";

          const nextBtn = document.getElementById("btn-next-step");
          nextBtn.style.display = "block";

          if (currentStepIndex >= scenarioData.length - 1) {
            nextBtn.innerText = "æœ€åˆã«æˆ»ã‚‹ â†º";
            nextBtn.onclick = resetSim;
          } else {
            nextBtn.innerText = "æ¬¡ã¸é€²ã‚€ â–¶";
            nextBtn.onclick = nextStep;
          }
        };

        window.nextStep = function () {
          currentStepIndex++;
          renderStep();
        };

        window.prevStep = function () {
          if (currentStepIndex > 0) {
            currentStepIndex--;
            renderStep();
          }
        };

        window.resetSim = function () {
          document.getElementById("sim-game-screen").style.display = "none";
          document.getElementById("sim-start-screen").style.display = "block";
        };

        // åˆæœŸåŒ–é–¢æ•° (å¿…è¦ãªã‚‰)
        window.initSimulation = function () {
          currentStepIndex = 0;
          renderStep();
        };

      </script>

      <script>
        // ==========================================
        // ğŸ¤– MediaPipe Pose + ğŸ’ª å…¨èº«ãƒˆãƒ«ã‚¯å¯è¦–åŒ– (ãƒãƒªã‚´ãƒ³/ã‚¹ã‚±ãƒ«ãƒˆãƒ³åˆ‡æ›¿ç‰ˆ)
        // ==========================================

        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement ? canvasElement.getContext('2d') : null;

        // ğŸ“ˆ ã‚°ãƒ©ãƒ•è¨­å®š
        const MAX_GRAPH_POINTS = 300;
        const graphConfigs = {
          r_elbow: { id: 'graph_r_elbow', color: '#4fc3f7', max: 60 },
          r_shoulder: { id: 'graph_r_shoulder', color: '#ff8a65', max: 100 },
          r_knee: { id: 'graph_r_knee', color: '#66bb6a', max: 250 },
          l_elbow: { id: 'graph_l_elbow', color: '#80d8ff', max: 60 },
          l_shoulder: { id: 'graph_l_shoulder', color: '#ffcc80', max: 100 },
          l_knee: { id: 'graph_l_knee', color: '#a5d6a7', max: 250 },
          trunk: { id: 'graph_trunk', color: '#fdd835', max: 150 }
        };

        const graphContexts = {};
        Object.keys(graphConfigs).forEach(key => {
          const cvs = document.getElementById(graphConfigs[key].id);
          if (cvs) graphContexts[key] = cvs.getContext('2d');
        });

        let graphData = { r_elbow: [], r_shoulder: [], r_knee: [], l_elbow: [], l_shoulder: [], l_knee: [], trunk: [] };
        let maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };

        let pose;
        let camera;
        let animationId;
        let isCameraRunning = false;
        let currentFacingMode = 'user';
        let isAnalysisRunning = false;

// --- ã‚¸ãƒ£ãƒ³ãƒ—åŠ›æ¸¬å®šç”¨ã®å¤‰æ•° ---
let isAirborne = false; 
let takeoffTime = 0;    
let groundY = 0;

        // ğŸ¥ éŒ²ç”»ç”¨
        let mediaRecorder;
        let recordedChunks = [];
        let selectedMimeType = "";
        let recordedCSVData = [];
        let recordingStartTime = 0;

        // ğŸ¨ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        let isBackgroundVisible = true;


        window.toggleBackground = function () {
          const cb = document.getElementById('bg-toggle');
          if (cb) isBackgroundVisible = cb.checked;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã® isPoseModelLoaded ã¨ä½µç”¨ï¼‰
        let isPoseModelLoading = false;

        // PoseåˆæœŸåŒ–é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
        async function initPose() {
          // ã™ã§ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã€ã¾ãŸã¯èª­ã¿è¾¼ã¿ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
          if (pose || isPoseModelLoading) return;

          isPoseModelLoading = true; // èª­ã¿è¾¼ã¿é–‹å§‹ãƒ•ãƒ©ã‚°ON

          // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ã€Œæº–å‚™ä¸­ã€ã«å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰
          const btn = document.querySelector("button[onclick='startCamera()']");
          if (btn) {
            btn.disabled = true;
            btn.textContent = "â³ AIæº–å‚™ä¸­...";
            btn.style.background = "#ccc";
          }

          console.log("AIãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™...");

          pose = new Pose({
            locateFile: (file) => {
              return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
            }
          });

          pose.setOptions({
            modelComplexity: 1, // 0:è»½é‡, 1:æ¨™æº–, 2:é«˜ç²¾åº¦ (1ãŒãƒãƒ©ãƒ³ã‚¹è‰¯ã—)
            smoothLandmarks: true,
            enableSegmentation: true,
            smoothSegmentation: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
          });

          pose.onResults(onPoseResults);

          // AIãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–å¾…æ©Ÿ
          await pose.initialize();

          isPoseModelLoaded = true;
          isPoseModelLoading = false;
          console.log("AI Pose Model Loaded successfully. (Preloaded)");

          // æº–å‚™å®Œäº†ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          if (btn) {
            btn.disabled = false;
            btn.textContent = "ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹• (å¤–å´/å†…å´)";
            btn.style.background = "#0288d1";
          }
        }

        // ==========================================
        // ğŸï¸ ã‚³ãƒé€ã‚Šï¼ˆã‚¹ãƒˆãƒ­ãƒœç”»åƒï¼‰æ©Ÿèƒ½ç”¨å¤‰æ•°
        // ==========================================
        var strobeFrames = [];       // éå»ã®ã€Œç”»åƒã€ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
        var strobeFrameCounter = 0;  // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼

        // æ®‹åƒã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        function clearStrobeData() {
          strobeFrames = [];
          strobeFrameCounter = 0;
        }

        // ==========================================
        // ğŸ¤– 2. çµæœå‡¦ç† (ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—) â˜…ç”»åƒã‚¹ãƒˆãƒ­ãƒœç‰ˆ
        // ==========================================
        // è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯
function detectJumpAI(results) {
    if (!jumpModeActive || !results.poseLandmarks) return;

    try {
        const lm = results.poseLandmarks;
        const now = performance.now();
        const canvas = document.getElementById('jump_canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById("jump-ai-status");
        const timerEl = document.getElementById("jump-timer-display");

        // 1. ãƒ¢ãƒ‹ã‚¿ãƒ¼æç”»
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
        if (typeof drawJumpSkeleton === 'function') drawJumpSkeleton(ctx, lm);
        
        // åœ°é¢ãƒ©ã‚¤ãƒ³ã®æç”»
        if (jumpGroundY !== 0) {
            ctx.strokeStyle = "#ffeb3b";
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, jumpGroundY * canvas.height);
            ctx.lineTo(canvas.width, jumpGroundY * canvas.height);
            ctx.stroke();
            ctx.fillStyle = "#ffeb3b";
            ctx.font = "bold 12px Arial";
            ctx.fillText(" GROUND", 5, jumpGroundY * canvas.height - 5);
        }
        ctx.restore();

        // 2. ç‰©ç†é‡è¨ˆç®—
        const dt = (lastFrameTime > 0) ? (now - lastFrameTime) / 1000 : 0.033;
        lastFrameTime = now;

        const currentKneeAngle = calculateFwAngle(lm[24], lm[26], lm[28]);

// â˜…è¿½åŠ ï¼šé–¢ç¯€è§’åº¦(180Â°åŸºæº–)ã‚’å±ˆæ›²è§’åº¦(0Â°åŸºæº–)ã«å¤‰æ›
// 180(ç›´ç·š) - é–¢ç¯€è§’åº¦ = å±ˆæ›²è§’åº¦
const currentFlexion = Math.max(0, 180 - currentKneeAngle); 

let angularVelocity = 0;
// è§’é€Ÿåº¦ã®è¨ˆç®—ã‚‚å±ˆæ›²è§’åº¦ã®å¢—æ¸›ã§è¡Œã†
if (prevKneeAngle !== 0 && dt > 0) {
    angularVelocity = Math.abs(currentFlexion - prevKneeAngle) / dt;
}
prevKneeAngle = currentFlexion; // å±ˆæ›²è§’åº¦ã‚’ä¿å­˜

// â˜…ä¿®æ­£ï¼šæœ€å¤§å±ˆæ›²è§’åº¦ï¼ˆä¸€ç•ªæ·±ãæ›²ã’ãŸç¬é–“ï¼‰ã‚’æ›´æ–°
if (currentFlexion > jumpMaxStats.angle) {
    jumpMaxStats.angle = currentFlexion;
}

        const wrist = lm[10];
        let armSpeed = 0;
        if (prevWristPos && prevWristPos.x !== 0 && dt > 0) {
            armSpeed = Math.sqrt(Math.pow(wrist.x - prevWristPos.x, 2) + Math.pow(wrist.y - prevWristPos.y, 2)) / dt;
        }
        prevWristPos = { x: wrist.x, y: wrist.y };

        // æœ€å¤§å€¤æ›´æ–°
        if (currentKneeAngle > jumpMaxStats.angle) jumpMaxStats.angle = currentKneeAngle;
        if (angularVelocity > jumpMaxStats.av) jumpMaxStats.av = angularVelocity;
        if (armSpeed > jumpMaxStats.armV) jumpMaxStats.armV = armSpeed;

        // 3. ã‚¸ãƒ£ãƒ³ãƒ—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        const currentAnkleY = (lm[27].y + lm[28].y) / 2;
        let eventLabel = "";

        if (jumpGroundY === 0) {
            jumpGroundY = currentAnkleY;
            if(statusEl) statusEl.textContent = "READY";
            if(timerEl) timerEl.innerHTML = `0.000 <span style="font-size:18px;">s</span>`;
            return;
        }

        const takeoffThreshold = 0.04;
        if (!isJumpAirborne && currentAnkleY < jumpGroundY - takeoffThreshold) {
            // é›¢åœ°
            isJumpAirborne = true;
            jumpTakeoffTime = now;
            eventLabel = "TAKE_OFF";
            if(statusEl) statusEl.textContent = "ğŸš€ AIRBORNE";
        } else if (isJumpAirborne) {
            // ç©ºä¸­ï¼ˆã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ï¼‰
            const currentFlightTime = (now - jumpTakeoffTime) / 1000;
            if (timerEl) {
                timerEl.innerHTML = `${currentFlightTime.toFixed(3)} <span style="font-size:18px;">s</span>`;
            }

            // ç€åœ°
            if (currentAnkleY > jumpGroundY - (takeoffThreshold / 2)) {
                isJumpAirborne = false;
                eventLabel = "LANDING";
                const finalTime = (now - jumpTakeoffTime) / 1000;
                const height = (9.80665 * Math.pow(finalTime, 2)) / 8 * 100;
                
                if (timerEl) timerEl.innerHTML = `${finalTime.toFixed(3)} <span style="font-size:18px;">s</span>`;
                processJumpResultDetailed(height, finalTime);
                if(statusEl) statusEl.textContent = "READY";
            }
        }

        jumpLog.push({
            time: (now / 1000).toFixed(3),
            angle: currentKneeAngle.toFixed(1),
            av: angularVelocity.toFixed(1),
            arm: (armSpeed * 10).toFixed(1),
            event: eventLabel
        });

    } catch (e) {
        console.error("Jump Error:", e);
    }
}

// çµæœè¡¨ç¤ºé–¢æ•°ï¼ˆé‡è¤‡ã‚’å‰Šé™¤ã—ã€ã“ã‚Œ1ã¤ã«ã¾ã¨ã‚ã¦ãã ã•ã„ï¼‰
function processJumpResultDetailed(height, time) {
    const resArea = document.getElementById("jump-result-area");
    if (resArea) resArea.style.display = "block";
    
    document.getElementById("val-jump-height").textContent = height.toFixed(1);
    
    // æœ€å¤§å€¤ã®è¡¨ç¤º
    const elAngle = document.getElementById("max-knee-angle");
    const elAv = document.getElementById("max-knee-av");
    const elArm = document.getElementById("max-arm-v");

    if (elAngle) elAngle.textContent = Math.round(jumpMaxStats.angle);
    if (elAv) elAv.textContent = Math.round(jumpMaxStats.av);
    if (elArm) elArm.textContent = (jumpMaxStats.armV * 10).toFixed(1);

    // æœ€é«˜åˆ°é”ç‚¹
    const userH = parseFloat(document.getElementById("bio-height")?.value || 170);
    const elReach = document.getElementById("val-jump-reach");
    if (elReach) elReach.textContent = ((userH * 1.25) + height).toFixed(1);

    saveJumpData();
    jumpMaxStats = { angle: 0, av: 0, torque: 0, armV: 0 };
}
// ãƒ¢ãƒ‹ã‚¿ãƒ¼ç”¨ã®ç°¡æ˜“ã‚¹ã‚±ãƒ«ãƒˆãƒ³æç”»
function drawJumpSkeleton(ctx, landmarks) {
    const w = ctx.canvas.width;
    const h = ctx.canvas.height;
    const color = isJumpAirborne ? "#ffeb3b" : "#00e676";
    
    // ä¸‹åŠèº«ã®ä¸»è¦ç‚¹ã®ã¿æç”»
    const points = [23, 24, 25, 26, 27, 28]; // è…°ã€è†ã€è¶³é¦–
    
    ctx.strokeStyle = color;
    ctx.lineWidth = 4;
    
    // è„šã®æç”»
    const drawLine = (i, j) => {
        if (landmarks[i].score > 0.5 && landmarks[j].score > 0.5) {
            ctx.beginPath();
            ctx.moveTo(landmarks[i].x * w, landmarks[i].y * h);
            ctx.lineTo(landmarks[j].x * w, landmarks[j].y * h);
            ctx.stroke();
        }
    };
    
    drawLine(24, 26); drawLine(26, 28); // å³
    drawLine(23, 25); drawLine(25, 27); // å·¦
    
    // ãƒã‚¤ãƒ³ãƒˆã®æç”»
    ctx.fillStyle = "#fff";
    points.forEach(idx => {
        const p = landmarks[idx];
        if (p.score > 0.5) {
            ctx.beginPath();
            ctx.arc(p.x * w, p.y * h, 5, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}
// åŸºæº–å€¤ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°ï¼ˆã‚«ãƒ¡ãƒ©èµ·å‹•æ™‚ãªã©ã«å‘¼ã¶ã¨è‰¯ã„ï¼‰
function resetGroundLevel() {
    groundY = 0;
    console.log("Ground level reset.");
}

function onPoseResults(results) {
    // æ˜ åƒãƒ‡ãƒ¼ã‚¿è‡ªä½“ãŒå±Šã„ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (!results.image) return;

    // ==========================================
    // ğŸš€ ã‚¸ãƒ£ãƒ³ãƒ—è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰ã®åˆ†å²å‡¦ç†
    // ==========================================
    if (jumpModeActive) {
        // äººç‰©ãŒæ¤œå‡ºã•ã‚Œã¦ã„ãªãã¦ã‚‚ã€æ˜ åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã« detectJumpAI ã‚’å‘¼ã³å‡ºã™
        detectJumpAI(results);
        
        // ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è§£æå´ï¼‰ã¯çœŸã£æš—ã«ã™ã‚‹
        if (canvasCtx) {
            canvasCtx.save();
            canvasCtx.fillStyle = "#000";
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.restore();
        }
        return; 
    }

    // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆAIãƒ•ã‚©ãƒ¼ãƒ è§£æï¼‰---
    // äººç‰©ãŒæ¤œå‡ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã“ã“ã§çµ‚äº†ï¼ˆèƒŒæ™¯ã‚‚æç”»ã—ãªã„ä»•æ§˜ã‚’ç¶­æŒï¼‰
    if (!results.poseLandmarks || !canvasCtx) return;

    canvasElement.width = videoElement.videoWidth || 640;
    canvasElement.height = videoElement.videoHeight || 480;

    // --- UIè¨­å®šå€¤ã®å–å¾— ---
    const showPolygon = document.getElementById('polygon-toggle') ? document.getElementById('polygon-toggle').checked : true;
    const isStrobeOn = document.getElementById('strobe-toggle') ? document.getElementById('strobe-toggle').checked : false;
    const isDimOn = document.getElementById('dim-toggle') ? document.getElementById('dim-toggle').checked : false;

    // é–“éš”ã¨æšæ•°
    const strobeIntervalInput = document.getElementById('strobe-interval');
    const strobeInterval = strobeIntervalInput ? parseInt(strobeIntervalInput.value) : 30;
    const strobeCountInput = document.getElementById('strobe-count');
    const maxStrobeCount = strobeCountInput ? parseInt(strobeCountInput.value) : 50;

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // ------------------------------------------------
    // 1. ç¾åœ¨ã®æ˜ åƒï¼ˆèƒŒæ™¯ï¼‰ã‚’æç”»
    // ------------------------------------------------
    if (isBackgroundVisible) {
        canvasCtx.globalAlpha = 1.0;
        canvasCtx.globalCompositeOperation = 'source-over';
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (isDimOn) {
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
        }
    } else {
        canvasCtx.fillStyle = '#000000';
        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
    }

    // ------------------------------------------------
    // 2. æ®‹åƒã®ä¿å­˜ã¨æç”»ï¼ˆäººç‰©åˆ‡ã‚ŠæŠœãï¼‰
    // ------------------------------------------------
    if (isStrobeOn) {
        strobeFrameCounter++;
        if (strobeFrameCounter % strobeInterval === 0) {
            const snapCanvas = document.createElement('canvas');
            snapCanvas.width = canvasElement.width;
            snapCanvas.height = canvasElement.height;
            const snapCtx = snapCanvas.getContext('2d');

            if (results.segmentationMask) {
                snapCtx.drawImage(results.image, 0, 0, snapCanvas.width, snapCanvas.height);
                snapCtx.globalCompositeOperation = 'destination-in';
                snapCtx.drawImage(results.segmentationMask, 0, 0, snapCanvas.width, snapCanvas.height);
                snapCtx.globalCompositeOperation = 'source-over';
            } else {
                snapCtx.drawImage(results.image, 0, 0, snapCanvas.width, snapCanvas.height);
            }
            strobeFrames.push(snapCanvas);
            if (strobeFrames.length > maxStrobeCount) strobeFrames.shift();
        }
        canvasCtx.globalAlpha = 1.0;
        canvasCtx.globalCompositeOperation = 'source-over';
        strobeFrames.forEach(frame => {
            canvasCtx.drawImage(frame, 0, 0, canvasElement.width, canvasElement.height);
        });
    }

    const lm = results.poseLandmarks;

    // ------------------------------------------------
    // 3. è² è·(ãƒˆãƒ«ã‚¯)ã®è¨ˆç®—å‡¦ç†
    // ------------------------------------------------
    const visR = (lm[12].visibility + lm[14].visibility + lm[24].visibility + lm[26].visibility) / 4;
    let torqueR = { shoulder: 0, elbow: 0, knee: 0 };
    if (visR > 0.5) {
        const angElbowR = calculateAngle(lm[12], lm[14], lm[16]);
        const angShoulderR = calculateAngle(lm[24], lm[12], lm[14]);
        const angKneeR = calculateAngle(lm[24], lm[26], lm[28]);
        const midShoulder = { x: (lm[12].x + lm[11].x) / 2, y: (lm[12].y + lm[11].y) / 2 };
        const midHip = { x: (lm[24].x + lm[23].x) / 2, y: (lm[24].y + lm[23].y) / 2 };
        const verticalPt = { x: midHip.x, y: midHip.y - 0.5 };
        const angTrunk = calculateAngle(verticalPt, midHip, midShoulder);
        torqueR = calculateFullBodyTorque(angShoulderR, angElbowR, angKneeR, angTrunk);
        updateMaxAndDrawVisual('r', lm, torqueR, { e: angElbowR, s: angShoulderR, k: angKneeR });
    }

    const visL = (lm[11].visibility + lm[13].visibility + lm[23].visibility + lm[25].visibility) / 4;
    let torqueL = { shoulder: 0, elbow: 0, knee: 0 };
    if (visL > 0.5) {
        const angElbowL = calculateAngle(lm[11], lm[13], lm[15]);
        const angShoulderL = calculateAngle(lm[23], lm[11], lm[13]);
        const angKneeL = calculateAngle(lm[23], lm[25], lm[27]);
        torqueL = calculateFullBodyTorque(angShoulderL, angElbowL, angKneeL, 0);
        updateMaxAndDrawVisual('l', lm, torqueL, { e: angElbowL, s: angShoulderL, k: angKneeL });
    }

    let valTrunk = 0;
    if (visR > 0.5 || visL > 0.5) {
        const midShoulder = { x: (lm[12].x + lm[11].x) / 2, y: (lm[12].y + lm[11].y) / 2 };
        const midHip = { x: (lm[24].x + lm[23].x) / 2, y: (lm[24].y + lm[23].y) / 2 };
        const verticalPt = { x: midHip.x, y: midHip.y - 0.5 };
        const angTrunk = calculateAngle(verticalPt, midHip, midShoulder);
        const tData = calculateFullBodyTorque(0, 0, 0, angTrunk);
        valTrunk = tData.trunk;
        if (valTrunk > maxTorqueValues.trunk) maxTorqueValues.trunk = valTrunk;
        setText("val-trunk", Math.round(angTrunk));
        setText("max-trunk-t", maxTorqueValues.trunk.toFixed(1));
    }

    // ------------------------------------------------
    // 4. ãƒãƒªã‚´ãƒ³æç”»
    // ------------------------------------------------
    if (showPolygon) {
        drawPolygonBody(lm);
        drawDynamicMuscle(lm[12], lm[14], torqueR.elbow, 60, true);
        drawDynamicMuscle(lm[14], lm[16], 0, 100, true);
        drawDynamicMuscle(lm[24], lm[26], torqueR.knee, 250, true);
        drawDynamicMuscle(lm[26], lm[28], 0, 100, true);
        drawDynamicMuscle(lm[11], lm[13], torqueL.elbow, 60, true);
        drawDynamicMuscle(lm[13], lm[15], 0, 100, true);
        drawDynamicMuscle(lm[23], lm[25], torqueL.knee, 250, true);
        drawDynamicMuscle(lm[25], lm[27], 0, 100, true);
        if (visR > 0.5 || visL > 0.5) {
            const midShoulder = { x: (lm[12].x + lm[11].x) / 2, y: (lm[12].y + lm[11].y) / 2 };
            const midHip = { x: (lm[24].x + lm[23].x) / 2, y: (lm[24].y + lm[23].y) / 2 };
            drawDynamicMuscle(midShoulder, midHip, valTrunk, 150, true);
        }
        drawJoints(lm, true);
    }

    updateAllGraphData(torqueR, torqueL, valTrunk);
    drawAllGraphs();

    if (mediaRecorder && mediaRecorder.state === "recording") {
        const elapsed = (Date.now() - recordingStartTime) / 1000;
        recordedCSVData.push({
            time: elapsed.toFixed(2),
            r_elbow: torqueR.elbow.toFixed(1), r_shoulder: torqueR.shoulder.toFixed(1), r_knee: torqueR.knee.toFixed(1),
            l_elbow: torqueL.elbow.toFixed(1), l_shoulder: torqueL.shoulder.toFixed(1), l_knee: torqueL.knee.toFixed(1),
            trunk: valTrunk.toFixed(1)
        });
    }

    canvasCtx.restore();
}
        // --- ğŸ”· ãƒãƒªã‚´ãƒ³ï¼ˆé¢ï¼‰æç”» ---
        function drawPolygonBody(lm) {
          if (!canvasCtx) return;
          const w = canvasElement.width;
          const h = canvasElement.height;

          // èƒ´ä½“
          canvasCtx.beginPath();
          canvasCtx.moveTo(lm[11].x * w, lm[11].y * h);
          canvasCtx.lineTo(lm[12].x * w, lm[12].y * h);
          canvasCtx.lineTo(lm[24].x * w, lm[24].y * h);
          canvasCtx.lineTo(lm[23].x * w, lm[23].y * h);
          canvasCtx.closePath();

          canvasCtx.fillStyle = 'rgba(0, 191, 255, 0.15)';
          canvasCtx.fill();
          canvasCtx.strokeStyle = 'rgba(0, 191, 255, 0.8)';
          canvasCtx.lineWidth = 2;
          canvasCtx.stroke();

          // é¡”
          canvasCtx.beginPath();
          canvasCtx.moveTo(lm[0].x * w, lm[0].y * h);
          canvasCtx.lineTo(lm[7].x * w, lm[7].y * h);
          canvasCtx.lineTo(lm[8].x * w, lm[8].y * h);
          canvasCtx.closePath();
          canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
          canvasCtx.fill();
        }

        // --- ğŸ’ª ç­‹è‚‰æç”» (ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) ---
        function drawDynamicMuscle(startPt, endPt, torque, maxVal, isPolygon) {
          if (!startPt || !endPt || !canvasCtx) return;

          let intensity = torque / maxVal;
          if (intensity > 1) intensity = 1;
          if (intensity < 0) intensity = 0;

          let r, g, b;
          if (intensity < 0.5) {
            r = 0; g = 255; b = Math.round(255 * (1 - intensity * 2));
          } else {
            r = Math.round(255 * (intensity - 0.5) * 2); g = Math.round(255 * (1 - (intensity - 0.5) * 2)); b = 0;
          }

          const startX = startPt.x * canvasElement.width;
          const startY = startPt.y * canvasElement.height;
          const endX = endPt.x * canvasElement.width;
          const endY = endPt.y * canvasElement.height;

          canvasCtx.beginPath();
          canvasCtx.moveTo(startX, startY);
          canvasCtx.lineTo(endX, endY);
          canvasCtx.lineCap = "round";

          if (isPolygon) {
            // ğŸ’  ãƒãƒªã‚´ãƒ³ãƒ¢ãƒ¼ãƒ‰: å¤ªãã¦å…‰ã‚‹
            canvasCtx.lineWidth = 6 + (intensity * 14);
            canvasCtx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.8)`;
            canvasCtx.shadowBlur = 10 + (intensity * 20);
            canvasCtx.shadowColor = `rgb(${r}, ${g}, ${b})`;
            canvasCtx.stroke();
            canvasCtx.shadowBlur = 0;

            // ç™½ã„èŠ¯
            canvasCtx.beginPath();
            canvasCtx.moveTo(startX, startY);
            canvasCtx.lineTo(endX, endY);
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = "rgba(255, 255, 255, 0.7)";
            canvasCtx.stroke();
          } else {
            // ğŸ¦´ ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ¢ãƒ¼ãƒ‰: ç´°ãã¦ã‚·ãƒ³ãƒ—ãƒ«
            canvasCtx.lineWidth = 4;
            canvasCtx.strokeStyle = `rgb(${r}, ${g}, ${b})`;
            canvasCtx.shadowBlur = 0;
            canvasCtx.stroke();
          }
        }

        // --- âšª ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆæç”» (ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) ---
        function drawJoints(lm, isPolygon) {
          if (!canvasCtx) return;
          const w = canvasElement.width;
          const h = canvasElement.height;
          const joints = [11, 12, 13, 14, 23, 24, 25, 26];

          joints.forEach(idx => {
            const p = lm[idx];
            const cx = p.x * w;
            const cy = p.y * h;

            canvasCtx.fillStyle = "#ffffff";
            if (isPolygon) {
              canvasCtx.beginPath(); canvasCtx.arc(cx, cy, 5, 0, Math.PI * 2); canvasCtx.fill();
              canvasCtx.beginPath(); canvasCtx.arc(cx, cy, 8, 0, Math.PI * 2);
              canvasCtx.strokeStyle = "rgba(0, 191, 255, 0.8)";
              canvasCtx.lineWidth = 2;
              canvasCtx.stroke();
            } else {
              canvasCtx.beginPath(); canvasCtx.arc(cx, cy, 6, 0, Math.PI * 2); canvasCtx.fill();
              canvasCtx.strokeStyle = "#333";
              canvasCtx.lineWidth = 1;
              canvasCtx.stroke();
            }
          });
        }

        // --- ğŸ¦´ ã‚·ãƒ³ãƒ—ãƒ«æ¥ç¶šç·š ---
        function drawSimpleConnector(p1, p2) {
          if (!p1 || !p2 || !canvasCtx) return;
          const w = canvasElement.width;
          const h = canvasElement.height;
          canvasCtx.beginPath();
          canvasCtx.moveTo(p1.x * w, p1.y * h);
          canvasCtx.lineTo(p2.x * w, p2.y * h);
          canvasCtx.lineWidth = 2;
          canvasCtx.strokeStyle = "white";
          canvasCtx.stroke();
        }

        // --- ä»¥ä¸‹ã€æ—¢å­˜ã®è¨ˆç®—ãƒ»åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ ---

        function updateMaxAndDrawVisual(side, lm, tData, angles) {
          const p_shoulder = (side === 'r') ? lm[12] : lm[11];
          const p_elbow = (side === 'r') ? lm[14] : lm[13];
          const p_knee = (side === 'r') ? lm[26] : lm[25];

          const keyS = side + '_shoulder';
          const keyE = side + '_elbow';
          const keyK = side + '_knee';

          if (tData.shoulder > maxTorqueValues[keyS]) maxTorqueValues[keyS] = tData.shoulder;
          if (tData.elbow > maxTorqueValues[keyE]) maxTorqueValues[keyE] = tData.elbow;
          if (tData.knee > maxTorqueValues[keyK]) maxTorqueValues[keyK] = tData.knee;

          // Elbow=60, Shoulder=100, Knee=250 ã‚’åŸºæº–(100%)ã¨ã—ã¾ã™
          drawTorqueVisual(p_shoulder, tData.shoulder, "", angles.s, 100);
          drawTorqueVisual(p_elbow, tData.elbow, "", angles.e, 60);
          drawTorqueVisual(p_knee, tData.knee, "", angles.k, 250);

          if (side === 'r') {
            setText("val-r-elbow", Math.round(angles.e));
            setText("max-r-elbow-t", maxTorqueValues.r_elbow.toFixed(1));
            setText("val-r-shoulder", Math.round(angles.s));
            setText("max-r-shoulder-t", maxTorqueValues.r_shoulder.toFixed(1));
            setText("val-r-knee", Math.round(angles.k));
            setText("max-r-knee-t", maxTorqueValues.r_knee.toFixed(1));
          }
        }

        function updateAllGraphData(tR, tL, tTrunk) {
          const pushVal = (arr, val) => {
            arr.push(val);
            if (arr.length > MAX_GRAPH_POINTS) arr.shift();
          };
          pushVal(graphData.r_elbow, tR.elbow);
          pushVal(graphData.r_shoulder, tR.shoulder);
          pushVal(graphData.r_knee, tR.knee);
          pushVal(graphData.l_elbow, tL.elbow);
          pushVal(graphData.l_shoulder, tL.shoulder);
          pushVal(graphData.l_knee, tL.knee);
          pushVal(graphData.trunk, tTrunk);
        }

        function resetGraphData() {
          Object.keys(graphData).forEach(k => graphData[k] = []);
          maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };
          Object.keys(graphContexts).forEach(key => {
            const ctx = graphContexts[key];
            if (ctx) ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          });
        }

        function drawAllGraphs() {
          Object.keys(graphConfigs).forEach(key => {
            drawSingleGraph(key, graphData[key]);
          });
        }

        function drawSingleGraph(key, dataArr) {
          const ctx = graphContexts[key];
          if (!ctx) return;
          const config = graphConfigs[key];
          const W = ctx.canvas.width;
          const H = ctx.canvas.height;
          const maxVal = config.max;

          ctx.fillStyle = "#000";
          ctx.fillRect(0, 0, W, H);
          ctx.strokeStyle = "#333";
          ctx.lineWidth = 1;
          ctx.fillStyle = "#aaa";
          ctx.font = "10px sans-serif";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";

          [0, 0.5, 1].forEach(ratio => {
            const y = H - (ratio * H);
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
            if (ratio > 0) {
              const val = Math.round(maxVal * ratio);
              ctx.fillText(val + "", W - 5, y + 6);
            }
          });

          if (dataArr.length < 2) return;
          ctx.beginPath();
          ctx.strokeStyle = config.color;
          ctx.lineWidth = 2;

          for (let i = 0; i < dataArr.length; i++) {
            const x = (i / MAX_GRAPH_POINTS) * W;
            let val = dataArr[i];
            if (val > maxVal) val = maxVal;
            const y = H - (val / maxVal * H);
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
          }
          ctx.stroke();

          const currentVal = dataArr[dataArr.length - 1];
          if (currentVal !== undefined) {
            ctx.fillStyle = config.color;
            ctx.font = "bold 12px sans-serif";
            ctx.textAlign = "left";
            ctx.fillText(currentVal.toFixed(1) + " Nm", 5, 15);
          }
        }

        function setText(id, val) {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        }

        function calculateFullBodyTorque(angShoulder, angElbow, angKnee, angTrunk) {
          const elH = document.getElementById("bio-height");
          const elW = document.getElementById("bio-weight");
          const elR = document.getElementById("bio-racket");
          const H = elH ? (parseFloat(elH.value) || 170) : 170;
          const W = elW ? (parseFloat(elW.value) || 65) : 65;
          const R_mass = elR ? ((parseFloat(elR.value) || 85) / 1000) : 0.085;
          const g = 9.81;
          const H_m = H / 100;
          const L_upper = 0.186 * H_m;
          const L_fore = 0.146 * H_m;
          const L_trunk = 0.3 * H_m;
          const M_arm = 0.05 * W;
          const M_upper_body = 0.6 * W;
          const M_body_above_knee = 0.85 * W;

          const radT = angTrunk * (Math.PI / 180);
          const kneeFlexFactor = Math.abs(Math.sin((180 - angKnee) * (Math.PI / 180)));
          const factorS = Math.abs(Math.sin(angShoulder * Math.PI / 180));

          const t_elbow = (2.0 + R_mass) * g * L_fore * Math.sin(angElbow * Math.PI / 180);
          const t_shoulder = (M_arm + R_mass) * g * L_upper * factorS + t_elbow;
          const t_trunk = M_upper_body * g * (L_trunk * 0.5) * Math.sin(radT);
          const momentArmKnee = (H_m * 0.25) * kneeFlexFactor;
          const t_knee = M_body_above_knee * g * momentArmKnee;

          return { shoulder: Math.abs(t_shoulder), elbow: Math.abs(t_elbow), trunk: Math.abs(t_trunk), knee: Math.abs(t_knee) };
        }

        function drawTorqueVisual(point, torque, label, angle, maxVal) {
          if (!point || !canvasCtx) return;
          const x = point.x * canvasElement.width;
          const y = point.y * canvasElement.height;

          // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€: ãƒãƒ–ãƒ«ã‚µã‚¤ã‚ºã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ â–¼â–¼â–¼

          // åŸºæº–å€¤ï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°100ï¼‰
          const limit = maxVal || 100;
          // ç”»é¢ä¸Šã®ãƒãƒ–ãƒ«ã®æœ€å¤§åŠå¾„(px)
          const maxRadiusPixel = 120;

          // ã€Œç¾åœ¨ã®ãƒˆãƒ«ã‚¯ / åŸºæº–å€¤ã€ã®å‰²åˆã§å¤§ãã•ã‚’æ±ºã‚ã‚‹
          let radius = (torque / limit) * maxRadiusPixel;

          // æœ€å°ã‚µã‚¤ã‚ºã¨æœ€å¤§ã‚µã‚¤ã‚ºã®åˆ¶é™
          if (radius < 5) radius = 5;
          if (radius > maxRadiusPixel) radius = maxRadiusPixel;

          // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

          const gradient = canvasCtx.createRadialGradient(x, y, radius * 0.1, x, y, radius);
          gradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
          gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.3)');
          gradient.addColorStop(1, 'rgba(255, 255, 255, 0.0)');
          canvasCtx.beginPath();
          canvasCtx.arc(x, y, radius, 0, 2 * Math.PI);
          canvasCtx.fillStyle = gradient;
          canvasCtx.fill();
        }

        function calculateAngle(a, b, c) {
          if (!a || !b || !c) return 0;
          const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
          let angle = Math.abs(radians * 180.0 / Math.PI);
          if (angle > 180.0) angle = 360 - angle;
          return angle;
        }

        // ==========================================
        // âœ… ä¿®æ­£: stopTrackingé–¢æ•°ã‚’è¿½åŠ 
        // ==========================================
        function stopTracking() {
          isCameraRunning = false;

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã®åœæ­¢
          if (animationId) {
            window.cancelAnimationFrame(animationId);
            animationId = null;
          }

          // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®åœæ­¢
          if (videoElement.srcObject) {
            videoElement.srcObject.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
          }

          // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿåœæ­¢ã¨ã‚¯ãƒªã‚¢
          if (videoElement.src) {
            videoElement.pause();
            videoElement.removeAttribute('src');
            videoElement.load();
          }

          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¯ãƒªã‚¢ï¼ˆé»’ç”»é¢ã«æˆ»ã™ï¼‰
          if (canvasCtx) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.fillStyle = "#000";
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
          }

          // UIãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
          const btnStart = document.getElementById("btn-record-start");
          const btnStop = document.getElementById("btn-record-stop");
          const ctrls = document.getElementById("pose-video-controls");

          if (btnStart) btnStart.style.display = "inline-block";
          if (btnStop) btnStop.style.display = "none";
          if (ctrls) ctrls.style.display = "none";

          // éŒ²ç”»ä¸­ã®å ´åˆã¯åœæ­¢
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
        }

        // 4. ã‚«ãƒ¡ãƒ© & ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function startCamera() {
          // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰åˆ¤å®šï¼ˆå‰å›ã®å›ç­”ã‚’é©ç”¨ã—ã¦ã„ã‚‹å ´åˆï¼‰
          if (typeof isPoseModelLoading !== 'undefined' && isPoseModelLoading) {
            alert("AIãƒ¢ãƒ‡ãƒ«ã‚’æº–å‚™ä¸­ã§ã™ã€‚ã‚ã¨æ•°ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚");
            return;
          }
          if (!pose) await initPose();

          stopTracking();
          resetGraphData();

          recordedCSVData = [];
          recordingStartTime = Date.now();
          maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };

          // â–¼â–¼â–¼ ã“ã“ã‚’ä¿®æ­£ï¼šç”»è³ªã®ä¸Šé™(max)ã‚’è¨­å®šã—ã¦é‡ããªã‚‹ã®ã‚’é˜²ã â–¼â–¼â–¼
          const constraints = {
            video: {
              facingMode: currentFacingMode,
              width: { ideal: 640, max: 1280 },  // æœ€å¤§ã§ã‚‚HDç”»è³ªã¾ã§
              height: { ideal: 480, max: 720 },  // ç¸¦æ¨ªæ¯”ã«ã‚ˆã£ã¦ã¯é€†ã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ä¸¡æ–¹åˆ¶é™
              frameRate: { ideal: 30, max: 30 }  // 30fpsã«å›ºå®š
            },
            audio: false
          };
          // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

          try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoElement.srcObject = stream;
            videoElement.style.display = "none";

            // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            console.log(`Camera Resolution: ${settings.width}x${settings.height}`);

            videoElement.onloadedmetadata = () => {
              videoElement.play();
              isCameraRunning = true;
              processCameraFrame();
            };
            const btnStart = document.getElementById("btn-record-start");
            if (btnStart) btnStart.style.display = "inline-block";
          } catch (err) {
            console.error("Camera Error:", err);
            alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          }
        }

        function toggleCamera() {
          currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
          if (isCameraRunning) startCamera();
          else alert("ã‚«ãƒ¡ãƒ©èµ·å‹•æ™‚ã«å‘ããŒå¤‰æ›´ã•ã‚Œã¾ã™");
        }

        function processCameraFrame() {
          if (!isCameraRunning) return;
          pose.send({ image: videoElement }).then(() => {
            if (isCameraRunning) animationId = requestAnimationFrame(processCameraFrame);
          });
        }

        function handleVideoUpload(input) {
          const file = input.files[0];
          if (!file) return;

          // åˆæœŸåŒ–å‡¦ç†
          initPose();
          stopTracking();
          resetGraphData();

          recordedCSVData = [];
          recordingStartTime = Date.now();
          maxTorqueValues = { r_elbow: 0, r_shoulder: 0, r_knee: 0, l_elbow: 0, l_shoulder: 0, l_knee: 0, trunk: 0 };

          // æ“ä½œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          const ctrls = document.getElementById("pose-video-controls");
          if (ctrls) ctrls.style.display = "flex";

          const url = URL.createObjectURL(file);
          videoElement.srcObject = null;
          videoElement.src = url;

          // å‹•ç”»è¦ç´ ã®è¨­å®šï¼ˆéè¡¨ç¤ºã«ã—ã¦ãŠãï¼‰
          videoElement.style.display = "block";
          videoElement.style.position = "absolute";
          videoElement.style.width = "1px";
          videoElement.style.height = "1px";
          videoElement.style.opacity = "0";
          videoElement.style.zIndex = "-1";

          videoElement.muted = true;
          videoElement.playsInline = true;
          videoElement.setAttribute('playsinline', '');

          videoElement.onloadeddata = () => {
            // ã¾ãšä¸€æ™‚åœæ­¢ã—ã€å…ˆé ­ã¸ã‚·ãƒ¼ã‚¯
            videoElement.pause();
            videoElement.currentTime = 0;
            isCameraRunning = false;
          };

          videoElement.onseeked = () => {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            if (canvasCtx) {
              canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            }

            setTimeout(() => {
              if (pose) pose.send({ image: videoElement });
            }, 100);
          };

          const btn = document.getElementById("btn-record-start");
          if (btn) btn.style.display = "inline-block";

          input.value = '';
        }

        function processVideoFrame() {
          if (!isAnalysisRunning) return;

          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');

          // --- çµ‚äº†åˆ¤å®šã®ä¿®æ­£ ---

          // 1. ä¸¡æ–¹ã®å‹•ç”»ãŒçµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ -> ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã¸
          if (vA.ended && vB.ended) {
            if (realDataA.length > 5) {
              isAnalysisRunning = false;
              compPauseBoth();
              generateRealReport();
            } else {
              // ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã‚¨ãƒ©ãƒ¼
              isAnalysisRunning = false;
              document.getElementById('ai-advice-text').innerHTML = "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦å†ç”Ÿã—ã¦ãã ã•ã„ã€‚";
            }
            return;
          }

          // 2. æ‰‹å‹•ã§ä¸€æ™‚åœæ­¢ã•ã‚ŒãŸå ´åˆ (ã©ã¡ã‚‰ã‹ãŒã€Œçµ‚äº†ã§ã¯ãªã„ã®ã«åœæ­¢ã€ã—ã¦ã„ã‚‹)
          if ((vA.paused && !vA.ended) || (vB.paused && !vB.ended)) {
            // ãƒ«ãƒ¼ãƒ—ã¯æ­¢ã‚ã‚‹ãŒã€isAnalysisRunningã¯trueã®ã¾ã¾ï¼ˆå†é–‹å¾…ã¡ï¼‰
            return;
          }

          // --- AIè§£æå‡¦ç† ---

          // å‹•ç”»AãŒå†ç”Ÿä¸­ã®å ´åˆã®ã¿ã€AIã«ç”»åƒã‚’é€ã‚‹
          if (!vA.paused && !vA.ended) {
            pose.send({ image: vA }).then(() => {
              requestAnimationFrame(processVideoFrame);
            });
          } else {
            // å‹•ç”»AãŒçµ‚ã‚ã£ã¦ã„ã¦ã‚‚ã€å‹•ç”»BãŒå‹•ã„ã¦ã„ã‚‹ãªã‚‰ãƒ«ãƒ¼ãƒ—ã‚’å›ã—ç¶šã‘ã‚‹
            requestAnimationFrame(processVideoFrame);
          }
        }

        // ğŸ¥ éŒ²ç”»æ©Ÿèƒ½
        function startRecording() {
          if (!canvasElement) return;
          const stream = canvasElement.captureStream(30);
          recordedChunks = [];

          recordedCSVData = [];
          recordingStartTime = Date.now();

          // â˜…è¿½åŠ : CSVãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
          const btnCsv = document.getElementById("btn-pose-csv");
          if (btnCsv) {
            btnCsv.disabled = true;
            btnCsv.style.background = "#ccc";
            btnCsv.style.cursor = "not-allowed";
          }

          const mimeTypes = ["video/mp4", "video/webkit", "video/webm;codecs=vp9", "video/webm"];
          selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
          if (!selectedMimeType) { alert("éŒ²ç”»éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™"); return; }

          const options = { mimeType: selectedMimeType };
          try { options.videoBitsPerSecond = 2500000; } catch (e) { }

          try {
            mediaRecorder = new MediaRecorder(stream, options);
          } catch (e) { alert("éŒ²ç”»åˆæœŸåŒ–å¤±æ•—"); return; }

          mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) recordedChunks.push(event.data);
          };
          mediaRecorder.onstop = saveVideo;
          mediaRecorder.start();

          const btnStart = document.getElementById("btn-record-start");
          const btnStop = document.getElementById("btn-record-stop");
          if (btnStart) btnStart.style.display = "none";
          if (btnStop) btnStop.style.display = "inline-block";

          const overlay = document.getElementById("pose-data-overlay");
          if (overlay && overlay.parentElement) {
            const recIndicator = document.createElement("div");
            recIndicator.id = "rec-indicator";
            recIndicator.style.cssText = "position:absolute; top:10px; right:10px; color:red; font-weight:bold; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:4px; animation: blink 1s infinite; z-index:100;";
            recIndicator.textContent = "â— REC";
            overlay.parentElement.appendChild(recIndicator);
            if (!document.getElementById('blink-style')) {
              const style = document.createElement('style');
              style.id = 'blink-style';
              style.innerHTML = `@keyframes blink { 50% { opacity: 0; } }`;
              document.head.appendChild(style);
            }
          }
        }

        function stopRecording() {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            const btnStart = document.getElementById("btn-record-start");
            const btnStop = document.getElementById("btn-record-stop");
            if (btnStart) btnStart.style.display = "inline-block";
            if (btnStop) btnStop.style.display = "none";
            const ind = document.getElementById("rec-indicator");
            if (ind) ind.remove();
          }
        }

        async function shareVideoFile(blob, filename) {
          // ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
          // â€»iOSç­‰ã§æ‰±ã„ã‚„ã™ã„ã‚ˆã†ã€æ‹¡å¼µå­ãŒwebmã§ã‚‚å†…éƒ¨çš„ã«mp4ã¨ã—ã¦æ‰±ã†ãƒˆãƒ©ã‚¤ã‚’ã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒ
          // ã“ã“ã§ã¯ç´ ç›´ã«Blobã®ã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
          const file = new File([blob], filename, { type: blob.type });

          // å…±æœ‰æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({
                files: [file],
                title: 'Smart Coach Video',
                text: 'AIåˆ†æå‹•ç”»ã‚’ä¿å­˜ã—ã¾ã™ã€‚'
              });
              console.log("å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ãã¾ã—ãŸ");
            } catch (error) {
              // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆãªã©ã¯ã“ã“ã«æ¥ã¾ã™ãŒã€ç‰¹ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯ä¸è¦
              console.log("å…±æœ‰ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯å¤±æ•—:", error);
            }
          } else {
            // PCã‚„å…±æœ‰éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ã€å¾“æ¥ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
            }, 100);

            // PCãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            console.log("å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼éå¯¾å¿œã®ãŸã‚ã€ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
          }
        }

        function saveVideo() {
          if (recordedChunks.length === 0) {
            alert("éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
          const timestampStr = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, "");
          const ext = selectedMimeType.includes("mp4") ? "mp4" : "webm";
          const filename = `Analysis_${timestampStr}.${ext}`;

          // Blobã‚’ä½œæˆ
          const blob = new Blob(recordedChunks, { type: selectedMimeType });

          // 1. ã‚¹ãƒãƒ›ã®å…±æœ‰/ä¿å­˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
          shareVideoFile(blob, filename);

          // â–¼â–¼â–¼ 2. â˜…è¿½åŠ â˜… ã‚¢ãƒ—ãƒªå†…ã®ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã«ã‚‚ä¿å­˜ã™ã‚‹ã‹èã â–¼â–¼â–¼
          if (confirm("å‹•ç”»ã‚’ã‚¢ãƒ—ãƒªå†…ã®ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã«ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§è¦‹è¿”ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™)")) {
            saveVideoToDB(blob, filename);
          }
          // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

          // CSVãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
          const btnCsv = document.getElementById("btn-pose-csv");
          if (recordedCSVData.length > 0 && btnCsv) {
            btnCsv.disabled = false;
            btnCsv.style.background = "#00897b";
            btnCsv.style.cursor = "pointer";
          }
        }

        function downloadPoseCSV() {
          if (!recordedCSVData || recordedCSVData.length === 0) {
            alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          const timestampStr = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, "");

          let csvContent = "Time(sec),R_Elbow(Nm),R_Shoulder(Nm),R_Knee(Nm),L_Elbow(Nm),L_Shoulder(Nm),L_Knee(Nm),Trunk(Nm)\n";
          recordedCSVData.forEach(row => {
            csvContent += `${row.time},${row.r_elbow},${row.r_shoulder},${row.r_knee},${row.l_elbow},${row.l_shoulder},${row.l_knee},${row.trunk}\n`;
          });

          const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          const blob = new Blob([bom, csvContent], { type: "text/csv" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `Torque_Data_${timestampStr}.csv`;
          document.body.appendChild(a);
          a.click();

          setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          }, 100);
        }

        function downloadCSV(timestampStr) {
          let csvContent = "Time(sec),R_Elbow(Nm),R_Shoulder(Nm),R_Knee(Nm),L_Elbow(Nm),L_Shoulder(Nm),L_Knee(Nm),Trunk(Nm)\n";
          recordedCSVData.forEach(row => {
            csvContent += `${row.time},${row.r_elbow},${row.r_shoulder},${row.r_knee},${row.l_elbow},${row.l_shoulder},${row.l_knee},${row.trunk}\n`;
          });

          const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          const blob = new Blob([bom, csvContent], { type: "text/csv" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `Torque_Data_${timestampStr}.csv`;
          document.body.appendChild(a);
          a.click();

          setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          }, 100);
        }

        // ==========================================
        // ğŸ¦¶ ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†ææ©Ÿèƒ½ (å®Œå…¨çµ±åˆç‰ˆ v7 - é¸æ‰‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ)
        // ==========================================

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        var fwVideo = document.getElementById('fw_video');
        var fwCanvas = document.getElementById('fw_canvas');
        var isFwAreaSelecting = false;
        var fwDragStart = null;
        var fwAnalysisArea = null; // {x, y, w, h}
        var fwOverlay = document.getElementById('fw_overlay');
        var fwCtx = fwCanvas ? fwCanvas.getContext('2d') : null;
        var fwOvCtx = fwOverlay ? fwOverlay.getContext('2d') : null;

        var fwPose = null;
        var fwIsRunning = false;
        var fwAnimId;
        var fwFacingMode = 'environment';

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
        var fwPath = [];
        var fwHeatmap = [];
        var HEATMAP_GRID_SIZE = 20;

        // é€Ÿåº¦è¨ˆç®—ç”¨
        var fwLastRealPos = null;
        var fwLastTime = 0;
        var fwTotalDistance = 0;

        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
        var fwIsCalibrating = false;
        var fwCalibPoints = [];
        var fwHomographyMatrix = null;

        // ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ç”¨
        var fwIsRecordingCSV = false;
        var fwRecordedData = [];
        var fwRecStartTime = 0;

        // åˆæœŸåŒ–é–¢æ•°
        function initFwPose() {
          if (fwPose) return;
          fwPose = new Pose({ locateFile: (file) => `https://unpkg.com/@mediapipe/pose/${file}` });
          fwPose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
          });
          fwPose.onResults(onFwResults);

          // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆæœŸåŒ–
          for (let i = 0; i < HEATMAP_GRID_SIZE; i++) {
            fwHeatmap[i] = new Array(HEATMAP_GRID_SIZE).fill(0);
          }
        }

        // ==========================
        // ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ»å‹•ç”» æ“ä½œ
        // ==========================

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function fwStartCamera() {
          fwStopAnalysis();
          initFwPose();
          if (typeof stopTracking === 'function') stopTracking();

          if (fwVideo.src) {
            URL.revokeObjectURL(fwVideo.src);
            fwVideo.removeAttribute('src');
          }

          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: fwFacingMode, // â˜…ã“ã“ã‚’å¤‰æ›´
                width: { ideal: 640 },
                height: { ideal: 480 },
                frameRate: 30
              },
              audio: false
            });
            fwVideo.srcObject = stream;
            fwVideo.onloadedmetadata = () => {
              fwVideo.play();
              fwIsRunning = true;
              fwProcessFrame();
            };
            setupFwCanvasListener();
          } catch (e) {
            console.error(e);
            alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        }

        function fwToggleCamera() {
          // ãƒ¢ãƒ¼ãƒ‰ã‚’åè»¢ (environment <-> user)
          fwFacingMode = (fwFacingMode === 'user') ? 'environment' : 'user';

          // ã™ã§ã«ã‚«ãƒ¡ãƒ©ãŒå‹•ã„ã¦ã„ã‚‹å ´åˆã¯ã€æ–°ã—ã„å‘ãã§å†èµ·å‹•
          if (fwVideo.srcObject) {
            fwStartCamera();
          } else {
            alert(`æ¬¡å›ã®ã‚«ãƒ¡ãƒ©èµ·å‹•æ™‚ã¯ã€Œ${fwFacingMode === 'user' ? 'å†…å´' : 'å¤–å´'}ã€ã«ãªã‚Šã¾ã™ã€‚`);
          }
        }

        // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function fwHandleVideoUpload(input) {
          const file = input.files[0];
          if (!file) return;

          fwStopAnalysis();
          initFwPose();

          const ctrls = document.getElementById("fw-video-controls");
          if (ctrls) ctrls.style.display = "flex";

          const url = URL.createObjectURL(file);
          fwVideo.src = url;
          fwVideo.muted = true;
          fwVideo.playsInline = true;


          fwVideo.onloadeddata = () => {
            fwVideo.pause();
            fwVideo.currentTime = 0;
            fwIsRunning = false;
          };


          fwVideo.onseeked = () => {

            fwCanvas.width = fwVideo.videoWidth || 640;
            fwCanvas.height = fwVideo.videoHeight || 480;
            fwOverlay.width = fwCanvas.width;
            fwOverlay.height = fwCanvas.height;


            if (fwCtx) {
              fwCtx.drawImage(fwVideo, 0, 0, fwCanvas.width, fwCanvas.height);
            }


            setTimeout(() => {
              if (fwPose) fwPose.send({ image: fwVideo });
            }, 100);
          };


          setupFwCanvasListener();
          input.value = '';
        }

        function poseVideoPlay() {
          if (!videoElement.src) return alert("å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
          videoElement.play();
          isCameraRunning = true;
          processCameraFrame();
        }

        function poseVideoPause() {
          if (!videoElement.src) return;
          videoElement.pause();
          isCameraRunning = false;
          if (animationId) cancelAnimationFrame(animationId);
        }

        function poseVideoReset() {
          if (!videoElement.src) return;
          videoElement.pause();
          isCameraRunning = false;
          if (animationId) cancelAnimationFrame(animationId);

          videoElement.currentTime = 0;

          // æœ€åˆã®ç”»ã‚’æç”»
          setTimeout(() => {
            if (pose) pose.send({ image: videoElement });
          }, 200);
        }

        function setupFwCanvasListener() {
          // è¦ªè¦ç´ ã§ã¯ãªãã€ä¸€ç•ªä¸Šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
          if (fwOverlay) {
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒã‚¯ãƒªãƒƒã‚¯ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            fwOverlay.style.pointerEvents = "auto";

            fwOverlay.removeEventListener('mousedown', handleFwCanvasClick);
            fwOverlay.addEventListener('mousedown', handleFwCanvasClick);
          }
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒãªã„å ´åˆã¯è¦ªè¦ç´ ã«
          else if (fwCanvas && fwCanvas.parentElement) {
            fwCanvas.parentElement.removeEventListener('mousedown', handleFwCanvasClick);
            fwCanvas.parentElement.addEventListener('mousedown', handleFwCanvasClick);
          }
        }

        // è§£æãƒ«ãƒ¼ãƒ—
        function fwProcessFrame() {
          if (!fwIsRunning) return;
          fwPose.send({ image: fwVideo }).then(() => {
            if (fwIsRunning) fwAnimId = requestAnimationFrame(fwProcessFrame);
          });
        }

        // â¹ åœæ­¢å‡¦ç†
        function fwStopAnalysis() {
          fwIsRunning = false;
          if (fwAnimId) { cancelAnimationFrame(fwAnimId); fwAnimId = null; }
          if (fwVideo.srcObject) {
            fwVideo.srcObject.getTracks().forEach(track => track.stop());
            fwVideo.srcObject = null;
          }
          if (fwVideo.src) {
            fwVideo.pause();
            fwVideo.removeAttribute('src');
            fwVideo.load();
          }
          if (fwCtx) {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            fwCtx.fillStyle = "#000";
            fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
          }
          const ctrls = document.getElementById("fw-video-controls");
          if (ctrls) ctrls.style.display = "none";
          if (typeof fwStopRecording === 'function') fwStopRecording();
        }

        // å‹•ç”»æ“ä½œãƒœã‚¿ãƒ³
        function fwVideoPlay() {
          if (!fwVideo.src) return alert("å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
          fwVideo.play();
          fwIsRunning = true;
          fwProcessFrame();
        }
        function fwVideoPause() {
          if (!fwVideo.src) return;
          fwVideo.pause();
          fwIsRunning = false;
          if (fwAnimId) cancelAnimationFrame(fwAnimId);
        }
        function fwVideoReset() {
          if (!fwVideo.src) return;
          fwVideo.pause();
          fwIsRunning = false;
          if (fwAnimId) cancelAnimationFrame(fwAnimId);
          fwVideo.currentTime = 0;
          setTimeout(() => { if (fwPose) fwPose.send({ image: fwVideo }); }, 200);
        }

        // ==========================
        // ğŸ§  ãƒ¡ã‚¤ãƒ³è§£æãƒ­ã‚¸ãƒƒã‚¯
        // ==========================
        function onFwResults(results) {
          if (!fwCtx) return;

          // --- 1. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´ & èƒŒæ™¯æç”» ---
          if (fwCanvas.width !== fwVideo.videoWidth || fwCanvas.height !== fwVideo.videoHeight) {
            fwCanvas.width = fwVideo.videoWidth || 640;
            fwCanvas.height = fwVideo.videoHeight || 480;
            fwOverlay.width = fwCanvas.width;
            fwOverlay.height = fwCanvas.height;
          }

          fwCtx.drawImage(results.image, 0, 0, fwCanvas.width, fwCanvas.height);
          fwCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
          fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);

          // ã‚¨ãƒªã‚¢æ ã®æç”»
          if (fwAnalysisArea) {
            fwCtx.strokeStyle = "rgba(0, 230, 118, 0.5)";
            fwCtx.lineWidth = 2;
            fwCtx.strokeRect(fwAnalysisArea.x, fwAnalysisArea.y, fwAnalysisArea.w, fwAnalysisArea.h);
          }

          drawCalibrationRect();

          const lm = results.poseLandmarks;
          const isRallyModeOn = document.getElementById('fw-rally-mode').checked;
          const container = document.getElementById('fw_canvas_container');

          // --- 2. ã€Œæœ‰åŠ¹ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒã„ã‚‹ã‹ã€ã‚’å…ˆã«åˆ¤å®š ---
          let hasPose = false;
          let hipX = 0, hipY = 0;

          if (lm) {
            // è…°ä½ç½®ã®è¨ˆç®—
            hipX = (lm[23].x + lm[24].x) / 2;
            hipY = (lm[23].y + lm[24].y) / 2;

            // ç”»é¢å¤–ãªã‚‰ç„¡åŠ¹
            if (hipX < 0 || hipX > 1 || hipY < 0 || hipY > 1) {
              hasPose = false;
            }
            // ã‚¨ãƒªã‚¢æŒ‡å®šãŒã‚ã‚‹å ´åˆ
            else if (fwAnalysisArea) {
              const px = hipX * fwCanvas.width;
              const py = hipY * fwCanvas.height;

              // ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
              const inArea = (px >= fwAnalysisArea.x && px <= fwAnalysisArea.x + fwAnalysisArea.w &&
                py >= fwAnalysisArea.y && py <= fwAnalysisArea.y + fwAnalysisArea.h);

              hasPose = inArea;
            }
            // ã‚¨ãƒªã‚¢æŒ‡å®šãŒãªã„å ´åˆï¼ˆå…¨ç”»é¢ï¼‰
            else {
              hasPose = true;
            }
          }

          // --- 3. åˆ¤å®šçµæœã«åŸºã¥ã„ã¦æ ç·šã®è‰²ã‚’æ›´æ–° ---
          if (isRallyModeOn) {
            if (hasPose) {
              // â˜… æ‰‹å‹•ON ã‹ã¤ ã€Œã‚¨ãƒªã‚¢å†…ã®äººã€ã‚’æ¤œå‡º â” ğŸ”´ èµ¤æ  (è¨˜éŒ²ä¸­)
              if (container) {
                container.classList.add('recording-active');
                container.classList.remove('recording-standby');
              }
            } else {
              // â˜… æ‰‹å‹•ON ã ã‘ã© ã€Œã‚¨ãƒªã‚¢å¤–/äººãŒã„ãªã„ã€ â” ğŸŸ¡ é»„æ  (å¾…æ©Ÿä¸­)
              if (container) {
                container.classList.remove('recording-active');
                container.classList.add('recording-standby');
              }
              // â˜… é‡è¦: å¯¾è±¡ãŒã„ãªã„ã®ã§ã“ã“ã§çµ‚äº†ï¼ˆè¨˜éŒ²ã—ãªã„ï¼‰
              return;
            }
          } else {
            // æ‰‹å‹•OFF â” æ ãªã—
            if (container) {
              container.classList.remove('recording-active');
              container.classList.remove('recording-standby');
            }
            fwLastRealPos = null; // ãƒªã‚»ãƒƒãƒˆ

            // äººãŒã„ãªã‘ã‚Œã°æç”»ã™ã‚‹ã‚‚ã®ã‚‚ãªã„ã®ã§çµ‚äº†
            if (!hasPose) return;
          }

          // --- 4. ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ»æç”» (æœ‰åŠ¹ãªå ´åˆã®ã¿ã“ã“ã¾ã§æ¥ã‚‹) ---
          const px = hipX * fwCanvas.width;
          const py = hipY * fwCanvas.height;

          // ãƒ‡ãƒ¼ã‚¿æ›´æ–° (ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ONæ™‚)
          if (isRallyModeOn) {
            updateFwHeatmap(hipX, hipY);
            fwPath.push({ x: px, y: py });
            if (fwPath.length > 300) fwPath.shift();
            calculateFwSpeedWithCorrection(px, py);
          }

          // æç”»
          if (document.getElementById('fw-show-heatmap').checked) drawFwHeatmap();
          if (document.getElementById('fw-show-trajectory').checked) drawFwTrajectory();

          // è² è·è¨ˆç®—
          const angKneeR = calculateFwAngle(lm[24], lm[26], lm[28]);
          const angKneeL = calculateFwAngle(lm[23], lm[25], lm[27]);

          const midShoulder = { x: (lm[12].x + lm[11].x) / 2, y: (lm[12].y + lm[11].y) / 2 };
          const midHip = { x: hipX, y: hipY };
          const verticalPt = { x: midHip.x, y: midHip.y - 0.5 };
          const angTrunk = calculateFwAngle(verticalPt, midHip, midShoulder);

          const tDataR = calculateFwTorque(0, 0, angKneeR, angTrunk);
          const valKneeR = tDataR.knee;
          const valTrunk = tDataR.trunk;
          const tDataL = calculateFwTorque(0, 0, angKneeL, angTrunk);
          const valKneeL = tDataL.knee;

          const pctKneeR = Math.round((valKneeR / 200) * 100);
          const pctKneeL = Math.round((valKneeL / 200) * 100);
          const pctTrunk = Math.round((valTrunk / 150) * 100);

          const setLoadDisplay = (id, pct, val) => {
            const el = document.getElementById(id);
            if (el) {
              el.textContent = `${pct}% (${val.toFixed(0)}Nm)`;
              el.style.color = pct > 100 ? "#d50000" : `hsl(${120 - Math.min(120, pct)}, 100%, 40%)`;
            }
          };
          setLoadDisplay("fw-load-knee-r", pctKneeR, valKneeR);
          setLoadDisplay("fw-load-knee-l", pctKneeL, valKneeL);
          setLoadDisplay("fw-load-trunk", pctTrunk, valTrunk);

          // CSVè¨˜éŒ²
          const currentSpeed = parseFloat(document.getElementById("fw-speed").textContent) || 0;
          if (fwIsRecordingCSV && isRallyModeOn) {
            const elapsedTime = (Date.now() - fwRecStartTime) / 1000;
            fwRecordedData.push({
              time: elapsedTime.toFixed(2),
              x: fwLastRealPos ? fwLastRealPos.x.toFixed(2) : 0,
              y: fwLastRealPos ? fwLastRealPos.y.toFixed(2) : 0,
              speed: currentSpeed,
              valKneeR: valKneeR.toFixed(1),
              valKneeL: valKneeL.toFixed(1),
              valTrunk: valTrunk.toFixed(1),
              pctKneeR: pctKneeR,
              pctKneeL: pctKneeL,
              pctTrunk: pctTrunk
            });
          }

          // ãƒã‚¤ãƒ³ãƒˆæç”»
          fwCtx.beginPath();
          fwCtx.arc(px, py, 8, 0, 2 * Math.PI);
          // è¨˜éŒ²ä¸­ã¯èµ¤ã€ãã‚Œä»¥å¤–ã¯ç·‘
          fwCtx.fillStyle = (fwIsRecordingCSV && isRallyModeOn) ? "red" : "#00e676";
          fwCtx.fill();
          fwCtx.stroke();
        }

        // -----------------------------------------------------
        // âš™ï¸ è² è·è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (é¸æ‰‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ)
        // -----------------------------------------------------
        function calculateFwAngle(a, b, c) {
          if (!a || !b || !c) return 0;
          const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
          let angle = Math.abs(radians * 180.0 / Math.PI);
          if (angle > 180.0) angle = 360 - angle;
          return angle;
        }

        function calculateFwTorque(angShoulder, angElbow, angKnee, angTrunk) {
          // HTMLã®å…¥åŠ›æ¬„ã‹ã‚‰å€¤ã‚’å–å¾— (ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ID)
          const elH = document.getElementById("fw-player-height");
          const elW = document.getElementById("fw-player-weight");
          const elR = document.getElementById("fw-player-racket");

          // å€¤ãŒãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          const H = elH ? (parseFloat(elH.value) || 170) : 170;
          const W = elW ? (parseFloat(elW.value) || 65) : 65;
          const R_mass = elR ? ((parseFloat(elR.value) || 85) / 1000) : 0.085;

          const g = 9.81;
          const H_m = H / 100;

          // ãƒ¢ãƒ¼ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ãƒ é•· (èº«é•·æ¯”)
          const L_upper = 0.186 * H_m;
          const L_fore = 0.146 * H_m;
          const L_trunk = 0.3 * H_m;

          // éƒ¨ä½è³ªé‡ (ä½“é‡æ¯”)
          const M_arm = 0.05 * W;
          const M_upper_body = 0.6 * W;
          const M_body_above_knee = 0.85 * W;

          // ç°¡æ˜“ç‰©ç†ãƒ¢ãƒ‡ãƒ«
          const radT = angTrunk * (Math.PI / 180);
          const kneeFlexFactor = Math.abs(Math.sin((180 - angKnee) * (Math.PI / 180)));
          const factorS = Math.abs(Math.sin(angShoulder * Math.PI / 180));

          const t_elbow = (2.0 + R_mass) * g * L_fore * Math.sin(angElbow * Math.PI / 180);
          const t_shoulder = (M_arm + R_mass) * g * L_upper * factorS + t_elbow;
          const t_trunk = M_upper_body * g * (L_trunk * 0.5) * Math.sin(radT);
          const momentArmKnee = (H_m * 0.25) * kneeFlexFactor;
          const t_knee = M_body_above_knee * g * momentArmKnee;

          return {
            shoulder: Math.abs(t_shoulder),
            elbow: Math.abs(t_elbow),
            trunk: Math.abs(t_trunk),
            knee: Math.abs(t_knee)
          };
        }

        function toggleFwAreaSelectMode() {
          isFwAreaSelecting = !isFwAreaSelecting;
          const btn = document.getElementById("btn-fw-area");
          const msg = document.getElementById("fw-area-msg");

          // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ãªã‚‰å¼·åˆ¶çµ‚äº†
          if (fwIsCalibrating) fwToggleCalibration();

          if (isFwAreaSelecting) {
            if (btn) {
              btn.textContent = "å®Œäº†";
              btn.style.background = "#d32f2f";
            }
            if (msg) msg.style.display = "block";
            fwAnalysisArea = null; // ãƒªã‚»ãƒƒãƒˆ

            // å‹•ç”»ã‚’ä¸€æ™‚åœæ­¢ã—ã¦é¸æŠã—ã‚„ã™ãã™ã‚‹
            if (fwVideo && !fwVideo.paused) fwVideo.pause();

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            fwOverlay.style.pointerEvents = "auto";
            fwOverlay.addEventListener("mousedown", onFwAreaMouseDown);
            fwOverlay.addEventListener("mousemove", onFwAreaMouseMove);
            fwOverlay.addEventListener("mouseup", onFwAreaMouseUp);

            // ã‚¯ãƒªã‚¢
            if (fwOvCtx) fwOvCtx.clearRect(0, 0, fwOverlay.width, fwOverlay.height);
          } else {
            if (btn) {
              btn.textContent = "ğŸ“ åˆ†æã‚¨ãƒªã‚¢æŒ‡å®š";
              btn.style.background = "#ff9800";
            }
            if (msg) msg.style.display = "none";

            fwOverlay.style.pointerEvents = "none";
            fwOverlay.removeEventListener("mousedown", onFwAreaMouseDown);
            fwOverlay.removeEventListener("mousemove", onFwAreaMouseMove);
            fwOverlay.removeEventListener("mouseup", onFwAreaMouseUp);

            // å‹•ç”»å†é–‹ï¼ˆåˆ†æä¸­ã ã£ãŸå ´åˆï¼‰
            if (fwIsRunning && fwVideo.paused) fwVideo.play();
          }
        }

        function onFwAreaMouseDown(e) {
          const rect = fwOverlay.getBoundingClientRect();
          const scaleX = fwOverlay.width / rect.width;
          const scaleY = fwOverlay.height / rect.height;
          fwDragStart = {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
          };
        }

        function onFwAreaMouseMove(e) {
          if (!fwDragStart) return;
          const rect = fwOverlay.getBoundingClientRect();
          const scaleX = fwOverlay.width / rect.width;
          const scaleY = fwOverlay.height / rect.height;
          const currentX = (e.clientX - rect.left) * scaleX;
          const currentY = (e.clientY - rect.top) * scaleY;

          if (fwOvCtx) {
            fwOvCtx.clearRect(0, 0, fwOverlay.width, fwOverlay.height);
            // èƒŒæ™¯ã‚’æš—ã
            fwOvCtx.fillStyle = "rgba(0,0,0,0.5)";
            fwOvCtx.fillRect(0, 0, fwOverlay.width, fwOverlay.height);

            const x = Math.min(fwDragStart.x, currentX);
            const y = Math.min(fwDragStart.y, currentY);
            const w = Math.abs(currentX - fwDragStart.x);
            const h = Math.abs(currentY - fwDragStart.y);

            // é¸æŠç¯„å›²ã‚’é€æ˜ã«ï¼ˆåˆ‡ã‚ŠæŠœãï¼‰
            fwOvCtx.clearRect(x, y, w, h);

            // æ ç·š
            fwOvCtx.strokeStyle = "#00e676";
            fwOvCtx.lineWidth = 3;
            fwOvCtx.strokeRect(x, y, w, h);
          }
        }

        function onFwAreaMouseUp(e) {
          if (!fwDragStart) return;
          const rect = fwOverlay.getBoundingClientRect();
          const scaleX = fwOverlay.width / rect.width;
          const scaleY = fwOverlay.height / rect.height;
          const currentX = (e.clientX - rect.left) * scaleX;
          const currentY = (e.clientY - rect.top) * scaleY;

          const x = Math.min(fwDragStart.x, currentX);
          const y = Math.min(fwDragStart.y, currentY);
          const w = Math.abs(currentX - fwDragStart.x);
          const h = Math.abs(currentY - fwDragStart.y);

          if (w > 20 && h > 20) {
            fwAnalysisArea = { x, y, w, h };
          }
          fwDragStart = null;
          toggleFwAreaSelectMode(); // å®Œäº†
        }


        // -----------------------------------------------------
        // â˜… ä¿®æ­£æ¸ˆã¿: è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ & ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        // -----------------------------------------------------
        function fwToggleCalibration() {
          fwIsCalibrating = !fwIsCalibrating;
          const guide = document.getElementById("fw-calib-guide");
          const btn = document.getElementById("btn-fw-calib");

          if (isFwAreaSelecting) toggleFwAreaSelectMode();

          if (fwIsCalibrating) {
            guide.style.display = "block";
            btn.textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
            btn.style.background = "#999";
            fwCalibPoints = [];
            fwHomographyMatrix = null;
            updateCalibStatus();
            fwOverlay.style.pointerEvents = "auto";
          } else {
            guide.style.display = "none";
            btn.textContent = "ğŸ“ 4ç‚¹ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³";
            btn.style.background = "#ff9800";
            fwOverlay.style.pointerEvents = "none";
            fwOvCtx.clearRect(0, 0, fwOverlay.width, fwOverlay.height);
          }
        }

        function updateCalibStatus() {
          const el = document.getElementById("fw-calib-status");
          const msgs = ["å·¦ä¸Š (å¥¥ã®å·¦éš…)", "å³ä¸Š (å¥¥ã®å³éš…)", "å³ä¸‹ (æ‰‹å‰ã®å³éš…)", "å·¦ä¸‹ (æ‰‹å‰ã®å·¦éš…)"];
          if (fwCalibPoints.length < 4) {
            el.textContent = `ç¾åœ¨: ${fwCalibPoints.length}ç‚¹ç›® / æ¬¡ã¯ã€${msgs[fwCalibPoints.length]}ã€‘ã‚’ã‚¯ãƒªãƒƒã‚¯`;
          } else {
            el.textContent = "è¨­å®šå®Œäº†ï¼";
          }
        }

        function handleFwCanvasClick(e) {
          if (!fwIsCalibrating) return;

          // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¦ªdivã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ãƒã‚¹è‡ªä½“ï¼‰ã‚’å–å¾—
          const target = e.target;
          const rect = target.getBoundingClientRect();

          // è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆCSSä¸Šã®å¹…ãƒ»é«˜ã•ï¼‰
          const displayWidth = rect.width;
          const displayHeight = rect.height;

          // å†…éƒ¨è§£åƒåº¦ï¼ˆå®Ÿéš›ã®ç”»ç´ æ•°ï¼‰
          const actualWidth = fwCanvas.width;
          const actualHeight = fwCanvas.height;

          // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ï¼ˆè¦ç´ å†…ã®ç›¸å¯¾åº§æ¨™ï¼‰ã‚’å–å¾—
          // â€» e.offsetX ãŒä½¿ãˆãªã„å ´åˆï¼ˆè¦ªè¦ç´ ã§ã®ç™ºç«ãªã©ï¼‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ clientX - rect.left ã‚‚ä½¿ç”¨
          const clickX = (e.offsetX !== undefined) ? e.offsetX : (e.clientX - rect.left);
          const clickY = (e.offsetY !== undefined) ? e.offsetY : (e.clientY - rect.top);

          // åº§æ¨™å¤‰æ›: è¡¨ç¤ºã‚µã‚¤ã‚º â†’ å†…éƒ¨è§£åƒåº¦
          const x = clickX * (actualWidth / displayWidth);
          const y = clickY * (actualHeight / displayHeight);

          fwCalibPoints.push({ x, y });
          updateCalibStatus();

          // å³åº§ã«ç‚¹ã‚’æç”»ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«æç”»ã—ã¦æ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
          // â€»fwOvCtx (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ) ã‚’ä½¿ç”¨ã—ã¾ã™
          if (fwOvCtx) {
            fwOvCtx.beginPath();
            fwOvCtx.arc(x, y, 5, 0, 2 * Math.PI); // åŠå¾„5pxã®èµ¤ä¸¸
            fwOvCtx.fillStyle = "red";
            fwOvCtx.fill();
            fwOvCtx.strokeStyle = "white";
            fwOvCtx.lineWidth = 2;
            fwOvCtx.stroke();
          }

          // 4ç‚¹æƒã£ãŸã‚‰è¨ˆç®—
          if (fwCalibPoints.length === 4) {
            // æœ€å¾Œã®ç‚¹ãŒæç”»ã•ã‚Œã‚‹ã®ã‚’ä¸€ç¬å¾…ã¤
            setTimeout(() => {
              computeHomographyMatrix();
              alert("è¨­å®šå®Œäº†ï¼");
              fwToggleCalibration();
            }, 50);
          }
        }

        function drawCalibrationRect() {
          if (fwCalibPoints.length === 0 && !fwHomographyMatrix) return;
          const ctx = fwCtx;
          ctx.beginPath();
          ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
          ctx.lineWidth = 2;
          if (fwCalibPoints.length > 0) {
            ctx.moveTo(fwCalibPoints[0].x, fwCalibPoints[0].y);
            for (let i = 1; i < fwCalibPoints.length; i++) ctx.lineTo(fwCalibPoints[i].x, fwCalibPoints[i].y);
            if (fwCalibPoints.length === 4) ctx.closePath();
          }
          ctx.stroke();
          ctx.fillStyle = "red";
          fwCalibPoints.forEach((p, i) => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
            ctx.fill();
            ctx.font = "12px Arial";
            ctx.fillStyle = "white";
            ctx.fillText(i + 1, p.x + 5, p.y - 5);
            ctx.fillStyle = "red";
          });
        }

        // 1. è¡Œåˆ—è¨ˆç®—ã®å®Ÿè¡Œ
        function computeHomographyMatrix() {
          const elW = document.getElementById("fw-real-width");
          const elH = document.getElementById("fw-real-height");
          const realW = (elW && parseFloat(elW.value)) ? parseFloat(elW.value) : 6.1;
          const realH = (elH && parseFloat(elH.value)) ? parseFloat(elH.value) : 6.7;

          console.log(`Calibration Settings: W=${realW}m, H=${realH}m`);

          const src = fwCalibPoints;
          const dst = [
            { x: 0, y: 0 },
            { x: realW, y: 0 },
            { x: realW, y: realH },
            { x: 0, y: realH }
          ];

          fwHomographyMatrix = getPerspectiveTransform(src, dst);

          if (fwHomographyMatrix) {
            console.log("Homography Matrix calculated:", fwHomographyMatrix);
          } else {
            alert("è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
          }
        }

        // 2. 4ç‚¹ã‹ã‚‰å¤‰æ›è¡Œåˆ—ã‚’æ±‚ã‚ã‚‹é–¢æ•° (OpenCVäº’æ›ãƒ»å®‰å®šç‰ˆ)
        function getPerspectiveTransform(src, dst) {
          function solveLinearSystem(A, B) {
            const n = 8;
            for (let i = 0; i < n; i++) {
              let pivot = i;
              for (let j = i + 1; j < n; j++) {
                if (Math.abs(A[j][i]) > Math.abs(A[pivot][i])) pivot = j;
              }
              [A[i], A[pivot]] = [A[pivot], A[i]];
              [B[i], B[pivot]] = [B[pivot], B[i]];

              if (Math.abs(A[i][i]) < 1e-10) continue;

              for (let j = i + 1; j < n; j++) {
                const factor = A[j][i] / A[i][i];
                for (let k = i; k < n; k++) A[j][k] -= factor * A[i][k];
                B[j] -= factor * B[i];
              }
            }
            const X = new Array(n).fill(0);
            for (let i = n - 1; i >= 0; i--) {
              let sum = 0;
              for (let j = i + 1; j < n; j++) sum += A[i][j] * X[j];
              if (Math.abs(A[i][i]) > 1e-10) X[i] = (B[i] - sum) / A[i][i];
            }
            return X;
          }

          const A = [];
          const B = [];
          for (let i = 0; i < 4; i++) {
            const sx = src[i].x; const sy = src[i].y;
            const dx = dst[i].x; const dy = dst[i].y;
            A.push([sx, sy, 1, 0, 0, 0, -sx * dx, -sy * dx]);
            A.push([0, 0, 0, sx, sy, 1, -sx * dy, -sy * dy]);
            B.push(dx); B.push(dy);
          }

          const h = solveLinearSystem(A, B);
          if (!h || h.some(v => isNaN(v) || !isFinite(v))) {
            console.error("Matrix calculation failed (NaN).");
            return null;
          }
          return [[h[0], h[1], h[2]], [h[3], h[4], h[5]], [h[6], h[7], 1]];
        }

        // 3. åº§æ¨™å¤‰æ›
        function transformPoint(x, y, H) {
          if (!H) return { x: 0, y: 0 };
          const dem = H[2][0] * x + H[2][1] * y + H[2][2];
          if (Math.abs(dem) < 0.0001) return { x: 0, y: 0 };
          return {
            x: (H[0][0] * x + H[0][1] * y + H[0][2]) / dem,
            y: (H[1][0] * x + H[1][1] * y + H[1][2]) / dem
          };
        }

        // 4. é€Ÿåº¦è¨ˆç®— (m/s å¯¾å¿œãƒ»è£œæ­£ç‰ˆ)
        function calculateFwSpeedWithCorrection(px, py) {
          if (!fwHomographyMatrix) return;

          const isRallyModeOn = document.getElementById('fw-rally-mode').checked;
          const isVideoFile = (fwVideo.src && fwVideo.src.startsWith("blob:"));
          const currentTime = isVideoFile ? fwVideo.currentTime : (Date.now() / 1000);

          const pt = transformPoint(px, py, fwHomographyMatrix);
          const realX = pt.x;
          const realY = pt.y;

          if (isNaN(realX) || isNaN(realY)) return;

          if (fwLastRealPos && isRallyModeOn) { // æ¡ä»¶è¿½åŠ 
            const dx = realX - fwLastRealPos.x;
            const dy = realY - fwLastRealPos.y;
            const distMeters = Math.sqrt(dx * dx + dy * dy);

            let dt = currentTime - fwLastTime;
            if (dt < 0) dt = 0;

            if (distMeters < 10.0 && distMeters > 0.001) {
              fwTotalDistance += distMeters;
              const distEl = document.getElementById("fw-distance");
              if (distEl) distEl.textContent = fwTotalDistance.toFixed(1);

              if (dt > 0.03) {
                const speedMPS = distMeters / dt;
                if (speedMPS < 12.5) {
                  const elSpeed = document.getElementById("fw-speed");
                  if (elSpeed) {
                    const currentDisp = parseFloat(elSpeed.textContent) || 0;
                    const smoothSpeed = (currentDisp * 0.7) + (speedMPS * 0.3);
                    elSpeed.textContent = smoothSpeed.toFixed(1);
                  }
                }
              }
            }
          }
          fwLastRealPos = { x: realX, y: realY };
          fwLastTime = currentTime;
        }

        // ==========================
        // ğŸ› ï¸ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ==========================
        function updateFwHeatmap(nx, ny) {
          const gx = Math.floor(nx * HEATMAP_GRID_SIZE);
          const gy = Math.floor(ny * HEATMAP_GRID_SIZE);
          if (gx >= 0 && gx < HEATMAP_GRID_SIZE && gy >= 0 && gy < HEATMAP_GRID_SIZE) {
            fwHeatmap[gy][gx]++;
          }
        }

        function drawFwHeatmap() {
          const cellW = fwCanvas.width / HEATMAP_GRID_SIZE;
          const cellH = fwCanvas.height / HEATMAP_GRID_SIZE;
          let maxCount = 0;
          for (let y = 0; y < HEATMAP_GRID_SIZE; y++) for (let x = 0; x < HEATMAP_GRID_SIZE; x++) if (fwHeatmap[y][x] > maxCount) maxCount = fwHeatmap[y][x];
          if (maxCount === 0) return;

          for (let y = 0; y < HEATMAP_GRID_SIZE; y++) {
            for (let x = 0; x < HEATMAP_GRID_SIZE; x++) {
              const count = fwHeatmap[y][x];
              if (count > 0) {
                const ratio = count / maxCount;
                const hue = (1.0 - ratio) * 240;
                fwCtx.fillStyle = `hsla(${hue}, 100%, 50%, 0.4)`;
                fwCtx.fillRect(x * cellW, y * cellH, cellW, cellH);
              }
            }
          }
        }

        function drawFwTrajectory() {
          if (fwPath.length < 2) return;
          fwCtx.beginPath();
          fwCtx.strokeStyle = "yellow";
          fwCtx.lineWidth = 3;
          fwCtx.moveTo(fwPath[0].x, fwPath[0].y);
          for (let i = 1; i < fwPath.length; i++) fwCtx.lineTo(fwPath[i].x, fwPath[i].y);
          fwCtx.stroke();
        }

        function fwResetData() {
          fwPath = [];
          for (let i = 0; i < HEATMAP_GRID_SIZE; i++) fwHeatmap[i].fill(0);
          fwTotalDistance = 0;
          fwLastRealPos = null;
          fwRecordedData = [];
          fwRecStartTime = Date.now();

          const setTxt = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
          setTxt("fw-speed", "0.0");
          setTxt("fw-distance", "0.0");

          // è² è·è¡¨ç¤ºã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
          const elKneeR = document.getElementById("fw-load-knee-r");
          const elKneeL = document.getElementById("fw-load-knee-l");
          const elTrunk = document.getElementById("fw-load-trunk");

          if (elKneeR) { elKneeR.textContent = "0% (0Nm)"; elKneeR.style.color = "#333"; }
          if (elKneeL) { elKneeL.textContent = "0% (0Nm)"; elKneeL.style.color = "#333"; }
          if (elTrunk) { elTrunk.textContent = "0% (0Nm)"; elTrunk.style.color = "#333"; }

          if (fwCtx) {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            if (!fwIsRunning) {
              fwCtx.fillStyle = "#000";
              fwCtx.fillRect(0, 0, fwCanvas.width, fwCanvas.height);
            }
          }
          console.log("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
        }

        function fwToggleCSVRecording() {
          const btn = document.getElementById("btn-fw-rec-data");
          const btnDl = document.getElementById("btn-fw-download-csv");

          if (!fwIsRecordingCSV) {
            fwIsRecordingCSV = true;
            fwRecordedData = [];
            fwRecStartTime = Date.now();
            btn.textContent = "â–  è¨˜éŒ²åœæ­¢";
            btn.style.background = "#d32f2f";
            if (btnDl) { btnDl.disabled = true; btnDl.style.background = "#ccc"; }
          } else {
            fwIsRecordingCSV = false;
            btn.textContent = "ğŸ”´ ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²";
            btn.style.background = "#424242";
            if (fwRecordedData.length > 0 && btnDl) {
              btnDl.disabled = false;
              btnDl.style.background = "#1565c0";
              btnDl.style.cursor = "pointer";
              alert("è¨˜éŒ²å®Œäº†ã€‚CSVä¿å­˜ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚");
            }
          }
        }

        function fwDownloadCSV() {
          if (fwRecordedData.length === 0) return;
          let csvContent = "Time(s),X(m),Y(m),Speed(m/s),Right_Knee(Nm),Left_Knee(Nm),Trunk(Nm),Right_Knee(%),Left_Knee(%),Trunk(%)\n";
          fwRecordedData.forEach(row => {
            csvContent += `${row.time},${row.x},${row.y},${row.speed},${row.valKneeR},${row.valKneeL},${row.valTrunk},${row.pctKneeR},${row.pctKneeL},${row.pctTrunk}\n`;
          });
          const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          const blob = new Blob([bom, csvContent], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `Footwork_Data_${Date.now()}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        async function fwGeneratePDFReport() {
          const btn = document.getElementById("btn-fw-report");
          const originalText = btn.textContent;
          btn.textContent = "ç”Ÿæˆä¸­...";
          btn.disabled = true;

          try {
            pdfMake.fonts = {
              Roboto: {
                normal: 'Roboto-Regular.ttf',
                bold: 'Roboto-Medium.ttf',
                italics: 'Roboto-Italic.ttf',
                bolditalics: 'Roboto-MediumItalic.ttf'
              }
            };

            const mapImage = fwCanvas.toDataURL("image/png");
            const totalDist = document.getElementById("fw-distance").textContent;

            let maxSpeed = 0, avgSpeed = 0;
            let integKneeR = 0, integKneeL = 0, integTrunk = 0;
            let avgKneeR = 0, avgKneeL = 0;

            if (fwRecordedData.length > 0) {
              maxSpeed = Math.max(...fwRecordedData.map(d => parseFloat(d.speed))).toFixed(1);
              const sumSpeed = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.speed), 0);
              avgSpeed = (sumSpeed / fwRecordedData.length).toFixed(1);

              const sumR = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.valKneeR), 0);
              const sumL = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.valKneeL), 0);
              const sumT = fwRecordedData.reduce((sum, d) => sum + parseFloat(d.valTrunk), 0);

              integKneeR = Math.round(sumR / 100);
              integKneeL = Math.round(sumL / 100);
              integTrunk = Math.round(sumT / 100);

              avgKneeR = (sumR / fwRecordedData.length).toFixed(1);
              avgKneeL = (sumL / fwRecordedData.length).toFixed(1);
            }

            let balanceComment = "Balanced (ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½)";
            if (integKneeR > integKneeL * 1.2) balanceComment = "Right Leg Dominant (å³è¶³åé‡ - å³ã¸ã®è² æ‹…å¤§)";
            else if (integKneeL > integKneeR * 1.2) balanceComment = "Left Leg Dominant (å·¦è¶³åé‡ - å·¦ã¸ã®è² æ‹…å¤§)";

            const docDefinition = {
              content: [
                { text: 'Footwork & Load Analysis Report', style: 'header' },
                { text: `Date: ${new Date().toLocaleString()}`, style: 'subheader' },

                { text: 'â–  1. Movement Performance', style: 'sectionHeader' },
                {
                  table: {
                    widths: ['*', '*', '*'],
                    body: [
                      [
                        { text: 'Total Distance', style: 'tableHeader' },
                        { text: 'Max Speed', style: 'tableHeader' },
                        { text: 'Avg Speed', style: 'tableHeader' }
                      ],
                      [
                        { text: `${totalDist} m`, style: 'tableData' },
                        { text: `${maxSpeed} m/s`, style: 'tableData' },
                        { text: `${avgSpeed} m/s`, style: 'tableData' }
                      ]
                    ]
                  },
                  margin: [0, 5, 0, 15]
                },

                { text: 'â–  2. Total Workload (Integral Score)', style: 'sectionHeader' },
                {
                  table: {
                    widths: ['*', '*', '*'],
                    body: [
                      [
                        { text: 'Right Knee (å³è„š)', style: 'tableHeader', fillColor: '#ffccbc' },
                        { text: 'Left Knee (å·¦è„š)', style: 'tableHeader', fillColor: '#b3e5fc' },
                        { text: 'Trunk (ä½“å¹¹)', style: 'tableHeader', fillColor: '#fff9c4' }
                      ],
                      [
                        { text: `${integKneeR} pts`, style: 'tableDataBold', fontSize: 16 },
                        { text: `${integKneeL} pts`, style: 'tableDataBold', fontSize: 16 },
                        { text: `${integTrunk} pts`, style: 'tableDataBold', fontSize: 16 }
                      ],
                      [
                        { text: `Avg: ${avgKneeR} Nm`, style: 'tableDataSmall' },
                        { text: `Avg: ${avgKneeL} Nm`, style: 'tableDataSmall' },
                        { text: '-' }
                      ]
                    ]
                  },
                  margin: [0, 5, 0, 10]
                },
                { text: `Balance Check: ${balanceComment}`, fontSize: 11, bold: true, color: '#333', margin: [0, 0, 0, 20] },

                { text: 'â–  3. Visualization', style: 'sectionHeader' },
                {
                  image: mapImage,
                  width: 500,
                  alignment: 'center',
                  margin: [0, 10, 0, 20]
                },

                { text: 'â–  Coach Comments', style: 'sectionHeader' },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }] },
                { text: '\n' },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }] },
                { text: '\n' },
                { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }] },

                { text: 'Generated by Smart Coach Badminton', style: 'footer', alignment: 'right', margin: [0, 20, 0, 0] }
              ],
              defaultStyle: { font: 'Roboto' },
              styles: {
                header: { fontSize: 22, bold: true, color: '#2e7d32', margin: [0, 0, 0, 5] },
                subheader: { fontSize: 10, margin: [0, 0, 0, 20], color: '#555' },
                sectionHeader: { fontSize: 14, bold: true, color: '#1565c0', margin: [0, 10, 0, 5] },
                tableHeader: { bold: true, fontSize: 11, color: '#333', alignment: 'center' },
                tableData: { fontSize: 12, alignment: 'center', margin: [0, 5, 0, 5] },
                tableDataBold: { fontSize: 14, bold: true, alignment: 'center', margin: [0, 5, 0, 5] },
                tableDataSmall: { fontSize: 9, alignment: 'center', color: '#666' },
                footer: { fontSize: 9, color: '#999', italics: true }
              }
            };

            pdfMake.createPdf(docDefinition).download(`Analysis_Report_${Date.now()}.pdf`);

          } catch (e) {
            console.error("PDF Error:", e);
            alert("PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e.message);
          } finally {
            btn.textContent = originalText;
            btn.disabled = false;
          }
        }


        // ==========================================
        // ğŸ¸ å‹•ç”»æ¯”è¼ƒæ©Ÿèƒ½ (Video Comparison)
        // ==========================================

        // å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        function compLoadVideo(input, videoId) {
          const file = input.files[0];
          if (!file) return;
          const video = document.getElementById(videoId);
          const url = URL.createObjectURL(file);
          video.src = url;
          video.load();
          const seek = document.getElementById('seek-' + videoId);
          if (seek) seek.value = 0;
        }

        // åŒæ™‚å†ç”Ÿ
        async function compPlayBoth() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');

          compChangeSpeed();

          if (vA) vA.muted = true;
          if (vB) vB.muted = true;

          try {
            const playPromiseA = vA.src ? vA.play() : Promise.resolve();
            const playPromiseB = vB.src ? vB.play() : Promise.resolve();

            await Promise.all([playPromiseA, playPromiseB]);
          } catch (err) {
            console.error("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err);
          }
        }

        // åŒæ™‚ä¸€æ™‚åœæ­¢
        function compPauseBoth() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          if (vA.src) vA.pause();
          if (vB.src) vB.pause();
        }

        // æœ€åˆã«æˆ»ã™
        function compResetBoth() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          if (vA.src) { vA.pause(); vA.currentTime = 0; }
          if (vB.src) { vB.pause(); vB.currentTime = 0; }
        }

        // å†ç”Ÿé€Ÿåº¦å¤‰æ›´
        function compChangeSpeed() {
          const speed = parseFloat(document.getElementById('comp-speed').value);
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          if (vA) vA.playbackRate = speed;
          if (vB) vB.playbackRate = speed;
        }

        // å·¦å³åè»¢ (ãƒŸãƒ©ãƒ¼) åˆ‡ã‚Šæ›¿ãˆ
        function compToggleMirror(videoId) {
          const video = document.getElementById(videoId);
          if (video.style.transform === 'scaleX(-1)') {
            video.style.transform = 'scaleX(1)';
          } else {
            video.style.transform = 'scaleX(-1)';
          }
        }

        // å€‹åˆ¥ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ“ä½œ
        function compIndividualSeek(videoId, value) {
          const video = document.getElementById(videoId);
          if (!video.duration) return;
          const time = video.duration * (value / 100);
          video.currentTime = time;
        }

        // å‹•ç”»å†ç”Ÿä¸­ã®ã‚·ãƒ¼ã‚¯ãƒãƒ¼è‡ªå‹•æ›´æ–°
        function compUpdateSeek(videoId) {
          const video = document.getElementById(videoId);
          const seek = document.getElementById('seek-' + videoId);
          if (video.duration && seek) {
            const val = (video.currentTime / video.duration) * 100;
            seek.value = val;
          }
        }

        // ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ã‚¯ï¼ˆä¸¡æ–¹ã®å‹•ç”»ã‚’åŒã˜å‰²åˆã®ä½ç½®ã¸ç§»å‹•ï¼‰
        function compMasterSeek(value) {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');

          compPauseBoth();

          if (vA.duration) vA.currentTime = vA.duration * (value / 100);
          if (vB.duration) vB.currentTime = vB.duration * (value / 100);
        }

        // ==========================================
        // ğŸ¸ ãƒ€ãƒ–ãƒ«ã‚¹é™£å½¢åˆ†ææ©Ÿèƒ½ (MoveNet MultiPose)
        // ==========================================

        let formationDetector = null;
        let isFormationRunning = false;
        let formationAnimId = null;

        let lastFormationState = "Side by Side"; // åˆæœŸå€¤
        let lastFormationColor = "#1976d2";      // åˆæœŸè‰²
        let lostTrackingCount = 0;

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        let formationStats = {
          far: { tb: 0, ss: 0, total: 0 },
          near: { tb: 0, ss: 0, total: 0 }
        };

        const formationVideo = document.getElementById("formation_video");
        const formationCanvas = document.getElementById("formation_canvas");
        const formationCtx = formationCanvas ? formationCanvas.getContext("2d") : null;

        let isSelectingArea = false;
        let formationDragStart = null;
        let formationAnalysisArea = null; // {x, y, w, h} (nullãªã‚‰å…¨ç”»é¢)

        // --- ã‚¨ãƒªã‚¢æŒ‡å®šæ©Ÿèƒ½ ---
        function toggleAreaSelectMode() {
          isSelectingArea = !isSelectingArea;
          const btn = document.getElementById("btn-formation-area");
          const msg = document.getElementById("formation-area-msg");
          const canvas = document.getElementById("formation_canvas");

          if (isSelectingArea) {
            btn.textContent = "å®Œäº†";
            btn.style.background = "#d32f2f";
            msg.style.display = "block";

            // æ—¢å­˜ã®ã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
            formationAnalysisArea = null;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
            canvas.addEventListener("mousedown", onAreaMouseDown);
            canvas.addEventListener("mousemove", onAreaMouseMove);
            canvas.addEventListener("mouseup", onAreaMouseUp);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹å†æç”»ï¼ˆæ ã‚’æ¶ˆã™ãŸã‚ï¼‰
            if (!isFormationRunning) {
              formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);
            }
          } else {
            btn.textContent = "ğŸ“ åˆ†æã‚¨ãƒªã‚¢æŒ‡å®š";
            btn.style.background = "#ff9800";
            msg.style.display = "none";

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
            canvas.removeEventListener("mousedown", onAreaMouseDown);
            canvas.removeEventListener("mousemove", onAreaMouseMove);
            canvas.removeEventListener("mouseup", onAreaMouseUp);
          }
        }

        function onAreaMouseDown(e) {
          const rect = formationCanvas.getBoundingClientRect();
          const scaleX = formationCanvas.width / rect.width;
          const scaleY = formationCanvas.height / rect.height;
          formationDragStart = {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
          };
        }

        function onAreaMouseMove(e) {
          if (!formationDragStart) return;
          const rect = formationCanvas.getBoundingClientRect();
          const scaleX = formationCanvas.width / rect.width;
          const scaleY = formationCanvas.height / rect.height;
          const currentX = (e.clientX - rect.left) * scaleX;
          const currentY = (e.clientY - rect.top) * scaleY;

          // æç”»æ›´æ–°ï¼ˆå‹•ç”»ã®ä¸Šã«æ ç·šã‚’æãï¼‰
          formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);

          // æ ç·šæç”»
          formationCtx.strokeStyle = "#00e676";
          formationCtx.lineWidth = 3;
          formationCtx.strokeRect(
            formationDragStart.x,
            formationDragStart.y,
            currentX - formationDragStart.x,
            currentY - formationDragStart.y
          );
        }

        function onAreaMouseUp(e) {
          if (!formationDragStart) return;
          const rect = formationCanvas.getBoundingClientRect();
          const scaleX = formationCanvas.width / rect.width;
          const scaleY = formationCanvas.height / rect.height;
          const currentX = (e.clientX - rect.left) * scaleX;
          const currentY = (e.clientY - rect.top) * scaleY;

          // ç¢ºå®šã—ãŸã‚¨ãƒªã‚¢ã‚’ä¿å­˜ (å·¦ä¸Šx, å·¦ä¸Šy, å¹…, é«˜ã• ã«æ­£è¦åŒ–)
          const x = Math.min(formationDragStart.x, currentX);
          const y = Math.min(formationDragStart.y, currentY);
          const w = Math.abs(currentX - formationDragStart.x);
          const h = Math.abs(currentY - formationDragStart.y);

          // å°ã•ã™ãã‚‹èª¤æ“ä½œã¯ç„¡è¦–
          if (w > 20 && h > 20) {
            formationAnalysisArea = { x, y, w, h };
          }

          formationDragStart = null;
          toggleAreaSelectMode(); // è‡ªå‹•ã§å®Œäº†ãƒ¢ãƒ¼ãƒ‰ã¸
        }



        // 1. ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
        async function loadFormationModel() {
          const loadingEl = document.getElementById("formation-loading");
          if (loadingEl) loadingEl.style.display = "block";

          try {
            await tf.setBackend('webgl');
            await tf.ready();

            const detectorConfig = {
              modelType: 'MultiPose.Lightning',
              enableTracking: true,
              trackerType: 'boundingBox',
              trackerConfig: {
                maxTracks: 4,
                maxAge: 800   // è¿½è·¡ä¿æŒæœŸé–“
              },
              modelConfig: {
                enableSmoothing: true // â–¼ è¿½åŠ : åº§æ¨™ã®ãƒ–ãƒ¬ã‚’æŠ‘ãˆã‚‹
              },
              minPoseScore: 0.2
            };

            formationDetector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);

            console.log("Model Loaded: High Sensitivity & Smoothing ON");
            if (loadingEl) loadingEl.style.display = "none";

            const btn = document.getElementById("btn-formation-toggle");
            if (btn) {
              btn.textContent = "â–¶ åˆ†æé–‹å§‹";
              btn.disabled = false;
              btn.style.background = "#00897b";
              btn.style.cursor = "pointer";
            }
          } catch (e) {
            console.error("Model Load Error:", e);
            alert("ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n" + e.message);
            if (loadingEl) loadingEl.style.display = "none";
          }
        }

        // 2. å‹•ç”»é¸æŠæ™‚ã®å‡¦ç†
        function handleFormationVideo(input) {
          const file = input.files[0];
          if (!file) return;

          // å‰å›ã®åˆ†æãŒå‹•ã„ã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
          if (isFormationRunning) {
            toggleFormationAnalysis();
          }

          // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
          resetFormationData();

          const url = URL.createObjectURL(file);
          formationVideo.src = url;

          // 1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚
          formationVideo.onloadeddata = () => {
            formationVideo.pause();   // åœæ­¢
            formationVideo.currentTime = 0; // å…ˆé ­ã¸
            isFormationRunning = false;

            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ãƒªã‚»ãƒƒãƒˆ
            const btn = document.getElementById("btn-formation-toggle");
            if (btn) {
              btn.textContent = "â–¶ åˆ†æé–‹å§‹";
              btn.style.background = "#00897b";
            }
          };

          // 2. å…ˆé ­ã¸ã®ã‚·ãƒ¼ã‚¯ï¼ˆé ­å‡ºã—ï¼‰å®Œäº†æ™‚
          // â˜…ã“ã“ãŒé‡è¦ï¼šå‹•ç”»ã®æº–å‚™ãŒæ•´ã£ãŸç¬é–“ã«ç”»åƒã‚’æç”»ã™ã‚‹
          formationVideo.onseeked = () => {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å‹•ç”»ã«åˆã‚ã›ã‚‹
            formationCanvas.width = formationVideo.videoWidth;
            formationCanvas.height = formationVideo.videoHeight;

            if (formationCtx) {
              // ã¾ãšã‚¯ãƒªã‚¢
              formationCtx.clearRect(0, 0, formationCanvas.width, formationCanvas.height);
              // å‹•ç”»ã®1ãƒ•ãƒ¬ãƒ¼ãƒ ç›®ã‚’ãã®ã¾ã¾æç”»ï¼ˆæ˜ã‚‹ã„çŠ¶æ…‹ã§è¡¨ç¤ºï¼‰
              formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);
            }

            // ãƒ¢ãƒ‡ãƒ«ãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰è£ã§ãƒ­ãƒ¼ãƒ‰é–‹å§‹ã—ã¦ãŠãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ãŸã›ãªã„ãŸã‚ï¼‰
            if (!formationDetector) {
              loadFormationModel();
            }
          };
        }

        // 3. åˆ†æã®é–‹å§‹ãƒ»åœæ­¢
        function toggleFormationAnalysis() {
          const btn = document.getElementById("btn-formation-toggle");

          if (!isFormationRunning) {
            // é–‹å§‹
            formationVideo.play();
            isFormationRunning = true;
            btn.textContent = "â¸ ä¸€æ™‚åœæ­¢";
            btn.style.background = "#fb8c00";
            analyzeFormationFrame();
          } else {
            // åœæ­¢
            formationVideo.pause();
            isFormationRunning = false;
            btn.textContent = "â–¶ åˆ†æå†é–‹";
            btn.style.background = "#00897b";
            if (formationAnimId) cancelAnimationFrame(formationAnimId);
          }
        }

        // 4. ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®å‡¦ç†ãƒ«ãƒ¼ãƒ—
        async function analyzeFormationFrame() {
          if (!isFormationRunning || !formationDetector) return;

          formationCtx.drawImage(formationVideo, 0, 0, formationCanvas.width, formationCanvas.height);

          const poses = await formationDetector.estimatePoses(formationCanvas, {
            // â–¼ ä¿®æ­£: æ‰‹å‰å´ã ã‘ãªã‚‰æœ€å¤§3ã€œ4äººã§ååˆ†ã€‚å‡¦ç†ã‚‚è»½ããªã‚Šç²¾åº¦ãŒä¸ŠãŒã‚‹ã€‚
            maxPoses: 4,
            flipHorizontal: false
          });

          // ç”»é¢æ¼”å‡ºï¼ˆå°‘ã—æš—ãã™ã‚‹ï¼‰
          formationCtx.fillStyle = "rgba(0, 0, 0, 0.3)";
          formationCtx.fillRect(0, 0, formationCanvas.width, formationCanvas.height);

          processFormationLogic(poses);

          if (!formationVideo.paused && !formationVideo.ended) {
            formationAnimId = requestAnimationFrame(analyzeFormationFrame);
          } else if (formationVideo.ended) {
            isFormationRunning = false;
            document.getElementById("btn-formation-toggle").textContent = "â–¶ æœ€åˆã‹ã‚‰";
            toggleFormationAnalysis();
          }
        }

        // 5. é™£å½¢åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        function processFormationLogic(poses) {
          // ã‚¹ã‚³ã‚¢åŸºæº–ï¼ˆå°‘ã—ç”˜ã‚ã«è¨­å®šã—ã¦æ‹¾ã„ã‚„ã™ãã™ã‚‹ï¼‰
          const validPoses = poses.filter(p => p.score > 0.15);

          const nearTeam = [];

          // ã‚¨ãƒªã‚¢ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€‚ãªã‘ã‚Œã°å…¨ç”»é¢ã€‚
          const area = formationAnalysisArea || {
            x: 0,
            y: 0,
            w: formationCanvas.width,
            h: formationCanvas.height
          };

          // æç”»: æŒ‡å®šã‚¨ãƒªã‚¢ã‚’ç·‘æ ã§è¡¨ç¤ºï¼ˆç¢ºèªç”¨ï¼‰
          if (formationAnalysisArea) {
            formationCtx.strokeStyle = "rgba(0, 230, 118, 0.5)";
            formationCtx.lineWidth = 2;
            formationCtx.strokeRect(area.x, area.y, area.w, area.h);
          }

          validPoses.forEach(pose => {
            const kp = pose.keypoints;
            let yCenter = 0;
            let xCenter = 0;

            // è…°ã®ä½ç½®ï¼ˆãªã‘ã‚Œã°è‚©ï¼‰ã‚’å–å¾—
            if (kp[11].score > 0.1 && kp[12].score > 0.1) {
              xCenter = (kp[11].x + kp[12].x) / 2;
              yCenter = (kp[11].y + kp[12].y) / 2;
            } else {
              xCenter = (kp[5].x + kp[6].x) / 2;
              yCenter = (kp[5].y + kp[6].y) / 2;
            }

            // â˜…é‡è¦: ãã®ä½ç½®ãŒã€ŒæŒ‡å®šã‚¨ãƒªã‚¢å†…ã€ã«ã‚ã‚‹ã‹åˆ¤å®š
            const inAreaX = xCenter >= area.x && xCenter <= (area.x + area.w);
            const inAreaY = yCenter >= area.y && yCenter <= (area.y + area.h);

            // ã‚¨ãƒªã‚¢å†…ãªã‚‰æ¡ç”¨
            if (inAreaX && inAreaY) {
              nearTeam.push(pose);
            }
          });

          evaluateTeamFormation(nearTeam);
          updateFormationUI();
        }


        function evaluateTeamFormation(teamPoses) {
          const canvasWidth = formationCanvas.width;

          // â–¼â–¼â–¼ è¿½åŠ : ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹å–å¾— â–¼â–¼â–¼
          const isRallyModeOn = document.getElementById('formation-rally-mode').checked;
          const canvas = document.getElementById('formation_canvas');

          // â–¼â–¼â–¼ è¿½åŠ : è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (æ ç·šã®è‰²ä»˜ã‘) â–¼â–¼â–¼
          // ãƒã‚§ãƒƒã‚¯ONãªã‚‰ã€äººãŒã„ã‚Œã°èµ¤æ (è¨˜éŒ²ä¸­)ã€ã„ãªã‘ã‚Œã°é»„è‰²æ (å¾…æ©Ÿä¸­)ã«ã™ã‚‹
          if (isRallyModeOn) {
            if (teamPoses.length > 0) {
              // æ‰‹å‹•ON ã‹ã¤ äººã‚’æ¤œå‡º â” ğŸ”´ è¨˜éŒ²ä¸­ (èµ¤æ )
              canvas.style.border = "5px solid #ff3d00";
              canvas.style.boxShadow = "0 0 15px rgba(255, 61, 0, 0.7)";
            } else {
              // æ‰‹å‹•ON ã ã‘ã© äººãŒã„ãªã„ â” ğŸŸ¡ å¾…æ©Ÿä¸­ (é»„è‰²æ )
              canvas.style.border = "5px solid #ffd600";
              canvas.style.boxShadow = "none";
            }
          } else {
            // æ‰‹å‹•OFF â” æ ãªã—
            canvas.style.border = "none";
            canvas.style.boxShadow = "0 4px 6px rgba(0,0,0,0.3)";
          }

          // -----------------------------------------------------
          // ãƒ‘ã‚¿ãƒ¼ãƒ³A: 2äººã¨ã‚‚æ¤œå‡ºã§ãã¦ã„ã‚‹å ´åˆ (æ­£å¸¸åˆ¤å®š)
          // -----------------------------------------------------
          if (teamPoses.length >= 2) {
            lostTrackingCount = 0; // è¦‹å¤±ã„ã‚«ã‚¦ãƒ³ã‚¿ãƒªã‚»ãƒƒãƒˆ

            // ã‚¹ã‚³ã‚¢ãŒé«˜ã„é †ã«2åé¸å‡º
            const players = teamPoses.sort((a, b) => b.score - a.score).slice(0, 2);

            // åº§æ¨™å–å¾— (è…°å„ªå…ˆã€ãªã‘ã‚Œã°è‚©)
            const getPos = (p) => {
              const kp = p.keypoints;
              if (kp[11].score > 0.1 && kp[12].score > 0.1) {
                return { x: (kp[11].x + kp[12].x) / 2, y: (kp[11].y + kp[12].y) / 2 };
              } else {
                return { x: (kp[5].x + kp[6].x) / 2, y: (kp[5].y + kp[6].y) / 2 };
              }
            };

            const pos1 = getPos(players[0]);
            const pos2 = getPos(players[1]);

            // è·é›¢è¨ˆç®—
            const dx = Math.abs(pos1.x - pos2.x);
            const dy = Math.abs(pos1.y - pos2.y);

            // â˜…æ”¹è‰¯1: é è¿‘æ³•è£œæ­£ (4.0å€ã§ç¶­æŒ)
            // å¥¥ã«è¡Œãã»ã©ç¸¦è·é›¢ãŒæ½°ã‚Œã‚‹ãŸã‚ã€å¼·åŠ›ã«è£œæ­£ã—ã¦ç¸¦åˆ¤å®šã—ã‚„ã™ãã™ã‚‹
            const weightedDy = dy * 4.0;

            // â˜…æ”¹è‰¯2: å¼·åˆ¶ãƒˆãƒƒãƒ—ï¼†ãƒãƒƒã‚¯åˆ¤å®š (Overlap Check)
            // æ¨ªå¹…(dx)ãŒç”»é¢å¹…ã®15%ä»¥ä¸‹ãªã‚‰ã€ã»ã¼ç¸¦ã«é‡ãªã£ã¦ã„ã‚‹ã¨ã¿ãªã—ã¦å¼·åˆ¶çš„ã«T&Bã«ã™ã‚‹
            const isOverlappingX = dx < (canvasWidth * 0.15);

            // åˆ¤å®š: ã€Œè£œæ­£ç¸¦è·é›¢ > æ¨ªè·é›¢ã€ ã¾ãŸã¯ ã€Œæ¨ªã«é‡ãªã£ã¦ã„ã‚‹ã€
            let isTopAndBack = (weightedDy > dx) || isOverlappingX;

            // çµæœã‚’æ›´æ–°ã—ã¦è¨˜æ†¶
            if (isTopAndBack) {
              lastFormationState = "Top & Back";
              lastFormationColor = "#ef5350"; // èµ¤:æ”»æ’ƒ

              // â–¼â–¼â–¼ ä¿®æ­£: è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ONã®æ™‚ã ã‘ã‚«ã‚¦ãƒ³ãƒˆ â–¼â–¼â–¼
              if (isRallyModeOn) formationStats.near.tb++;
            } else {
              lastFormationState = "Side by Side";
              lastFormationColor = "#1976d2"; // é’:å®ˆå‚™

              // â–¼â–¼â–¼ ä¿®æ­£: è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ONã®æ™‚ã ã‘ã‚«ã‚¦ãƒ³ãƒˆ â–¼â–¼â–¼
              if (isRallyModeOn) formationStats.near.ss++;
            }

            // â–¼â–¼â–¼ ä¿®æ­£: è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ONã®æ™‚ã ã‘ã‚«ã‚¦ãƒ³ãƒˆ â–¼â–¼â–¼
            if (isRallyModeOn) formationStats.near.total++;

            // ç¾åœ¨ã®ç·šã‚’æç”»
            formationCtx.beginPath();
            formationCtx.moveTo(pos1.x, pos1.y);
            formationCtx.lineTo(pos2.x, pos2.y);
            formationCtx.strokeStyle = lastFormationColor;
            formationCtx.lineWidth = 4;
            formationCtx.stroke();

            players.forEach(p => drawSkeleton(p, lastFormationColor));

            // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
            const midX = (pos1.x + pos2.x) / 2;
            const midY = (pos1.y + pos2.y) / 2;
            formationCtx.fillStyle = lastFormationColor;
            formationCtx.font = "bold 16px sans-serif";
            formationCtx.fillText(lastFormationState, midX - 40, midY - 10);
          }
          // -----------------------------------------------------
          // ãƒ‘ã‚¿ãƒ¼ãƒ³B: é¸æ‰‹ãŒé‡ãªã£ã¦1äººã—ã‹è¦‹ãˆãªã„å ´åˆ (è‡ªå‹•è¿½å¾“)
          // -----------------------------------------------------
          else if (teamPoses.length === 1) {
            lostTrackingCount++;

            // â˜…æ”¹è‰¯3: 1äººã—ã‹ã„ãªã„ = ã€Œé‡ãªã£ã¦ã„ã‚‹(Top & Back)ã€ã¨ã¿ãªã™
            // ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ã«ãŠã„ã¦ã‚¨ãƒªã‚¢å†…ã§1äººã«ãªã‚‹ã®ã¯ã€æ‰‹å‰ã®é¸æ‰‹ã«å¥¥ã®é¸æ‰‹ãŒéš ã‚ŒãŸæ™‚ã§ã™ã€‚
            // ã¤ã¾ã‚Šã€ã“ã‚Œã¯ã€Œç©¶æ¥µã®Top & Backã€çŠ¶æ…‹ã¨è¨€ãˆã¾ã™ã€‚

            // 3ç§’(90ãƒ•ãƒ¬ãƒ¼ãƒ )ä»¥å†…ãªã‚‰è¿½å¾“ã™ã‚‹ï¼ˆæ°¸é ã«1äººã®å ´åˆã¯é™¤å¤–ã™ã‚‹ãŸã‚ï¼‰
            if (lostTrackingCount < 90) {

              // å¼·åˆ¶çš„ã« T&B ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹
              lastFormationState = "Top & Back";
              lastFormationColor = "#ef5350"; // èµ¤

              // â–¼â–¼â–¼ ä¿®æ­£: è¨˜éŒ²ãƒ¢ãƒ¼ãƒ‰ONã®æ™‚ã ã‘ã‚«ã‚¦ãƒ³ãƒˆ â–¼â–¼â–¼
              if (isRallyModeOn) {
                formationStats.near.tb++;
                formationStats.near.total++;
              }

              // 1äººã ã‘ã§ã‚‚éª¨æ ¼ã‚’æç”»ï¼ˆèµ¤è‰²ã§ï¼‰
              const p = teamPoses[0];
              drawSkeleton(p, lastFormationColor);

              // ãƒ©ãƒ™ãƒ«è¡¨ç¤ºä½ç½®ã®è¨ˆç®—
              const kp = p.keypoints;
              let px = 0, py = 0;
              // è…°ãŒã‚ã‚Œã°è…°ã€ãªã‘ã‚Œã°é¼»
              if (kp[11].score > 0.1) {
                px = (kp[11].x + kp[12].x) / 2;
                py = (kp[11].y + kp[12].y) / 2;
              } else {
                px = kp[0].x;
                py = kp[0].y;
              }

              formationCtx.fillStyle = lastFormationColor;
              formationCtx.font = "bold 16px sans-serif";
              // è‡ªå‹•åˆ¤å®šä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ©ãƒ™ãƒ«
              formationCtx.fillText("Top & Back (Auto)", px - 60, py - 40);
            }
          }
        }

        // ç°¡æ˜“éª¨æ ¼æç”»
        function drawSkeleton(pose, color) {
          const kps = pose.keypoints;
          const edges = [
            [5, 7], [7, 9], [6, 8], [8, 10], // è…•
            [11, 13], [13, 15], [12, 14], [14, 16], // è„š
            [5, 6], [11, 12], [5, 11], [6, 12] // èƒ´ä½“
          ];

          formationCtx.strokeStyle = "white";
          formationCtx.lineWidth = 2;

          edges.forEach(([i, j]) => {
            if (kps[i].score > 0.3 && kps[j].score > 0.3) {
              formationCtx.beginPath();
              formationCtx.moveTo(kps[i].x, kps[i].y);
              formationCtx.lineTo(kps[j].x, kps[j].y);
              formationCtx.stroke();
            }
          });

          // é–¢ç¯€ç‚¹
          formationCtx.fillStyle = color;
          kps.forEach(kp => {
            if (kp.score > 0.3) {
              formationCtx.beginPath();
              formationCtx.arc(kp.x, kp.y, 4, 0, 2 * Math.PI);
              formationCtx.fill();
            }
          });
        }

        // 6. UIæ›´æ–°
        function updateFormationUI() {
          const calcPct = (val, total) => total > 0 ? Math.round((val / total) * 100) : 0;

          // æ‰‹å‰å´ (Near Side) ã®é›†è¨ˆ
          const nearTotal = formationStats.near.total;
          const nearTbPct = calcPct(formationStats.near.tb, nearTotal);
          const nearSsPct = calcPct(formationStats.near.ss, nearTotal);

          // è¦ç´ ã‚’IDã§å–å¾—
          const elTbVal = document.getElementById("near-tb-val");
          const elTbBar = document.getElementById("near-tb-bar");
          const elSsVal = document.getElementById("near-ss-val");
          const elSsBar = document.getElementById("near-ss-bar");

          // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ›¸ãæ›ãˆã‚‹ï¼ˆã“ã“ãŒã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
          if (elTbVal) elTbVal.textContent = `${nearTbPct}%`;
          if (elTbBar) elTbBar.style.width = `${nearTbPct}%`;

          if (elSsVal) elSsVal.textContent = `${nearSsPct}%`;
          if (elSsBar) elSsBar.style.width = `${nearSsPct}%`;
        }

        // 7. ãƒªã‚»ãƒƒãƒˆ (ä¿®æ­£ç‰ˆ)
        function resetFormationData() {
          // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¼ãƒ­ãƒªã‚»ãƒƒãƒˆ
          formationStats = {
            far: { tb: 0, ss: 0, total: 0 },
            near: { tb: 0, ss: 0, total: 0 }
          };

          // UIè¡¨ç¤ºã‚‚ãƒªã‚»ãƒƒãƒˆ
          updateFormationUI();

          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
          if (formationCtx && formationCanvas) {
            formationCtx.clearRect(0, 0, formationCanvas.width, formationCanvas.height);
          }
        }

        // ==========================================
        // âœ… AIãƒ•ã‚©ãƒ¼ãƒ è§£æãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ä¿å­˜æ©Ÿèƒ½
        // ==========================================
        function savePoseParams() {
          const height = document.getElementById("bio-height").value;
          const weight = document.getElementById("bio-weight").value;
          const racket = document.getElementById("bio-racket").value;

          const saveData = {
            height: height,
            weight: weight,
            racket: racket,
            timestamp: new Date().toLocaleString()
          };

          localStorage.setItem("smartCoachPoseParams", JSON.stringify(saveData));

          const statusEl = document.getElementById("pose-local-status");
          if (statusEl) {
            statusEl.textContent = "ä¿å­˜å®Œäº†";
            setTimeout(() => { statusEl.textContent = ""; }, 2000);
          }
        }

        function loadPoseParams() {
          const json = localStorage.getItem("smartCoachPoseParams");
          if (!json) {
            alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }
          if (!confirm("ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

          try {
            const data = JSON.parse(json);
            // ã“ã“ã§è¦ç´ ã‚’å–å¾—
            const h = document.getElementById("bio-height");
            const w = document.getElementById("bio-weight");
            const r = document.getElementById("bio-racket");

            // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å€¤ã‚’ã‚»ãƒƒãƒˆ
            if (h && data.height) h.value = data.height;
            if (w && data.weight) w.value = data.weight;
            if (r && data.racket) r.value = data.racket;

            const statusEl = document.getElementById("pose-local-status");
            if (statusEl) {
              statusEl.textContent = "å¾©å…ƒã—ã¾ã—ãŸ: " + (data.timestamp || "");
              setTimeout(() => { statusEl.textContent = ""; }, 3000);
            }
          } catch (e) {
            console.error(e);
            alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        }

        function clearPoseParams() {
          if (confirm("AIãƒ•ã‚©ãƒ¼ãƒ è§£æã®ä¿å­˜è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem("smartCoachPoseParams");
            const statusEl = document.getElementById("pose-local-status");
            if (statusEl) {
              statusEl.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
              setTimeout(() => { statusEl.textContent = ""; }, 2000);
            }
          }
        }

        // ==========================================
        // âœ… ã‚²ãƒ¼ãƒ åˆ†æ(ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯)ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ä¿å­˜æ©Ÿèƒ½
        // ==========================================
        function saveFwParams() {
          const height = document.getElementById("fw-player-height").value;
          const weight = document.getElementById("fw-player-weight").value;
          const racket = document.getElementById("fw-player-racket").value;

          const saveData = {
            height: height,
            weight: weight,
            racket: racket,
            timestamp: new Date().toLocaleString()
          };

          localStorage.setItem("smartCoachFwParams", JSON.stringify(saveData));

          const statusEl = document.getElementById("fw-local-status");
          if (statusEl) {
            statusEl.textContent = "ä¿å­˜å®Œäº†";
            setTimeout(() => { statusEl.textContent = ""; }, 2000);
          }
        }

        function loadFwParams() {
          const json = localStorage.getItem("smartCoachFwParams");
          if (!json) {
            alert("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }
          if (!confirm("ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;

          try {
            const data = JSON.parse(json);
            if (data.height) document.getElementById("fw-player-height").value = data.height;
            if (data.weight) document.getElementById("fw-player-weight").value = data.weight;
            if (data.racket) document.getElementById("fw-player-racket").value = data.racket;

            const statusEl = document.getElementById("fw-local-status");
            if (statusEl) {
              statusEl.textContent = "å¾©å…ƒã—ã¾ã—ãŸ: " + (data.timestamp || "");
              setTimeout(() => { statusEl.textContent = ""; }, 3000);
            }
          } catch (e) {
            console.error(e);
            alert("å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        }

        function clearFwParams() {
          if (confirm("ã‚²ãƒ¼ãƒ åˆ†æã®ä¿å­˜è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem("smartCoachFwParams");
            const statusEl = document.getElementById("fw-local-status");
            if (statusEl) {
              statusEl.textContent = "å‰Šé™¤ã—ã¾ã—ãŸ";
              setTimeout(() => { statusEl.textContent = ""; }, 2000);
            }
          }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è‡ªå‹•å¾©å…ƒã™ã‚‹ã‹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™å‡¦ç†ï¼ˆä»»æ„ï¼‰
        document.addEventListener("DOMContentLoaded", () => {
          if (localStorage.getItem("smartCoachPoseParams")) {
            const statusEl = document.getElementById("pose-local-status");
            if (statusEl) statusEl.textContent = "â€»ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š";
          }
          if (localStorage.getItem("smartCoachFwParams")) {
            const statusEl = document.getElementById("fw-local-status");
            if (statusEl) statusEl.textContent = "â€»ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š";
          }
        });

        // ==========================================
        // âŒ¨ï¸ ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        // ==========================================
        document.addEventListener('keydown', (e) => {
          // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«ã„ã‚‹ã¨ãã¯åå¿œã•ã›ãªã„
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

          if (e.code === 'Space') {
            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢

            // ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆ
            const fwSection = document.getElementById('footwork-analysis-section');
            const fwCheck = document.getElementById('fw-rally-mode');

            // è¦ªè¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆç°¡æ˜“çš„ãªåˆ¤å®šï¼‰
            if (fwCheck && fwSection.offsetParent !== null) {
              fwCheck.checked = !fwCheck.checked;
              // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ›´æ–°ã¯ãƒ«ãƒ¼ãƒ—å†…ã§è‡ªå‹•çš„ã«è¡Œã‚ã‚Œã¾ã™
            }

            // é™£å½¢åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆ
            const formSection = document.getElementById('formation-analysis-section');
            const formCheck = document.getElementById('formation-rally-mode');
            if (formCheck && formSection.offsetParent !== null) {
              formCheck.checked = !formCheck.checked;
            }
          }
        });


        // ==========================================
        // ğŸ¤– AIãƒ•ã‚©ãƒ¼ãƒ æ¯”è¼ƒ (ãƒ€ãƒ–ãƒ«è§£æãƒ»å®Œå…¨æ¯”è¼ƒç‰ˆ)
        // ==========================================

        let isCompAnalysisRunning = false;
        let compData = { A: [], B: [] };
        let compPose = null; // "pose" ã§ã¯ãªã "compPose" ã‚’ä½¿ç”¨
        let currentTargetVideo = 'A';

        // 1. å‹•ç”»èª­ã¿è¾¼ã¿
        function compLoadVideo(input, videoId) {
          if (!input.files || !input.files[0]) return;
          const file = input.files[0];
          const video = document.getElementById(videoId);
          if (!video) return;
          try {
            if (video.src) URL.revokeObjectURL(video.src);
            video.src = URL.createObjectURL(file);
            video.load();
            const seek = document.getElementById('seek-' + videoId);
            if (seek) seek.value = 0;
          } catch (e) {
            console.error(e);
          }
        }

        // 2. PoseåˆæœŸåŒ– (æ¯”è¼ƒæ©Ÿèƒ½å°‚ç”¨)
        function initCompPose() {
          if (typeof Pose === 'undefined') {
            alert("AIãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          // ã™ã§ã«åˆæœŸåŒ–æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
          if (compPose) return;

          compPose = new Pose({ locateFile: (file) => `https://unpkg.com/@mediapipe/pose/${file}` });

          // â–¼ã“ã“ã‚’æ›¸ãæ›ãˆã¾ã™
          compPose.setOptions({
            modelComplexity: 2,           // 1 â†’ 2 (é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´)
            smoothLandmarks: true,
            minDetectionConfidence: 0.3,  // 0.5 â†’ 0.3 (åˆ¤å®šã‚’ç”˜ãã—ã¦é ãã®äººã‚’æ‹¾ã†)
            minTrackingConfidence: 0.3    // 0.5 â†’ 0.3 (è¿½è·¡ã‚‚åˆ‡ã‚Œã«ããã™ã‚‹)
          });

          compPose.onResults(onCompPoseResults);
        }

        // 3. è§£æçµæœã®å‡¦ç†
        function onCompPoseResults(results) {
          if (!isCompAnalysisRunning) return;

          const lm = results.poseLandmarks;

          // è§£æå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          const targetArray = (currentTargetVideo === 'A') ? compData.A : compData.B;
          const videoId = (currentTargetVideo === 'A') ? 'video-a' : 'video-b';
          const video = document.getElementById(videoId);
          const t = video.currentTime;

          // ãƒ‡ãƒ¼ã‚¿è¨ˆç®—ï¼ˆéª¨æ ¼ãŒå–ã‚Œãªã‘ã‚Œã°0æ‰±ã„ï¼‰
          let leanAngle = 0;
          let velElbow = 0;

          if (lm) {
            // --- â‘  è„ŠæŸ±ã®å‰å‚¾è§’åº¦ ---
            const midHipX = (lm[23].x + lm[24].x) / 2;
            const midHipY = (lm[23].y + lm[24].y) / 2;
            const midShoulderX = (lm[11].x + lm[12].x) / 2;
            const midShoulderY = (lm[11].y + lm[12].y) / 2;
            const dx = midShoulderX - midHipX;
            const dy = midShoulderY - midHipY;
            const rad = Math.atan2(dx, -dy);
            leanAngle = Math.abs(rad * (180 / Math.PI));

            // --- â‘¡ è‚˜ã®é€Ÿåº¦ (å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã®å·®åˆ†) ---
            const prev = targetArray[targetArray.length - 1];
            if (prev && (t - prev.time) > 0.01) {
              const dt = t - prev.time;
              // ç”»é¢ä¸Šã®ç›¸å¯¾ç§»å‹•è·é›¢
              const dist = Math.sqrt(Math.pow(lm[14].x - prev.x, 2) + Math.pow(lm[14].y - prev.y, 2));
              velElbow = dist / dt;
            }

            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            targetArray.push({
              time: t,
              x: lm[14].x, y: lm[14].y, // è‚˜åº§æ¨™
              lean: leanAngle,
              velElbow: velElbow
            });
          }

          // äº¤äº’ã«å‡¦ç†ã‚’é€²ã‚ã‚‹
          switchTargetAndContinue();
        }

        function switchTargetAndContinue() {
          if (!isCompAnalysisRunning) return;

          // A -> B -> æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¸
          if (currentTargetVideo === 'A') {
            currentTargetVideo = 'B';
            const vB = document.getElementById('video-b');
            // BãŒå‹•ã„ã¦ã„ã‚Œã°è§£æã€æ­¢ã¾ã£ã¦ã„ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
            if (!vB.paused && !vB.ended) {
              compPose.send({ image: vB });
            } else {
              checkFinishOrNext();
            }
          } else {
            currentTargetVideo = 'A';
            checkFinishOrNext();
          }
        }

        function checkFinishOrNext() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');

          // çµ‚äº†åˆ¤å®š: ä¸¡æ–¹ã¨ã‚‚çµ‚ã‚ã£ã¦ã„ã‚‹ã‹åœæ­¢ã—ã¦ã„ã‚‹
          const isAFinished = vA.paused || vA.ended;
          const isBFinished = vB.paused || vB.ended;

          if (isAFinished && isBFinished) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ç¨‹åº¦ã‚ã‚Œã°ãƒ¬ãƒãƒ¼ãƒˆ
            if (compData.A.length > 5 && compData.B.length > 5) {
              isCompAnalysisRunning = false;
              compPauseBoth();
              generateComparisonReport();
            } else if (vA.currentTime < 0.5) {
              // é–‹å§‹ç›´å¾Œã¯ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
              requestAnimationFrame(processNextFrame);
            } else {
              isCompAnalysisRunning = false;
              document.getElementById('ai-advice-text').innerHTML = "âš ï¸ è§£æãƒ‡ãƒ¼ã‚¿ä¸è¶³ã€‚ã‚‚ã†ä¸€åº¦å†ç”Ÿã—ã¦ãã ã•ã„ã€‚";
            }
            return;
          }

          // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¸
          requestAnimationFrame(processNextFrame);
        }

        function processNextFrame() {
          if (!isCompAnalysisRunning) return;
          const vA = document.getElementById('video-a');

          // Aã‚’è§£æï¼ˆå®Œäº†ã—ãŸã‚‰ callback ã§ B ã¸ï¼‰
          if (!vA.paused && !vA.ended) {
            currentTargetVideo = 'A';
            compPose.send({ image: vA });
          } else {
            // AãŒæ­¢ã¾ã£ã¦ã„ã¦ã‚‚BãŒå‹•ã„ã¦ã„ã‚‹ãªã‚‰Bã¸
            currentTargetVideo = 'B';
            const vB = document.getElementById('video-b');
            if (!vB.paused && !vB.ended) {
              compPose.send({ image: vB });
            } else {
              checkFinishOrNext();
            }
          }
        }

        // 4. åˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³
        async function runFullAnalysis() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          const resBox = document.getElementById('ai-comparison-result');
          const resText = document.getElementById('ai-advice-text');

          if (!vA.src || !vB.src) {
            alert("å‹•ç”»Aã¨å‹•ç”»Bã®ä¸¡æ–¹ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          if (!compPose) initCompPose();

          // ãƒªã‚»ãƒƒãƒˆ
          compData = { A: [], B: [] };
          currentTargetVideo = 'A';
          isCompAnalysisRunning = true;

          resBox.style.display = "block";
          resText.innerHTML = `
        <div style="text-align:center; padding:20px; color:#e65100;">
            <b>ğŸ”„ Wè§£æå®Ÿè¡Œä¸­...</b><br>
            2ã¤ã®å‹•ç”»ã‚’åŒæ™‚ã«è§£æã—ã¦ã„ã¾ã™ã€‚<br>
            <span style="font-size:12px;">â€»å‹•ä½œãŒé‡ããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</span>
        </div>
    `;

          vA.currentTime = 0;
          vB.currentTime = 0;
          compPlayBoth();

          // å‡¦ç†é–‹å§‹
          processNextFrame();
        }

        // 5. æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ (A vs B ã®æ¯”è¼ƒæ¡ç‚¹)
        function generateComparisonReport() {
          const resText = document.getElementById('ai-advice-text');
          const dataA = compData.A;
          const dataB = compData.B;

          // --- æœ€å¤§å€¤ã®å–å¾— ---
          const getMax = (arr) => {
            let mVel = 0, mLean = 0, totalMove = 0;
            arr.forEach(d => {
              if (d.velElbow > mVel) mVel = d.velElbow;
              if (d.lean > mLean) mLean = d.lean;
              totalMove += d.velElbow;
            });
            return { vel: mVel, lean: mLean, move: totalMove };
          };

          const resA = getMax(dataA);
          const resB = getMax(dataB);

          // --- æ¡ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ (ä¸€è‡´åº¦) ---

          // 1. ã‚¹ãƒ”ãƒ¼ãƒ‰ä¸€è‡´åº¦
          let speedScore = 0;
          if (resB.vel > 0) {
            // æ¯”ç‡ã‚’è¨ˆç®— (A / B)
            let ratio = resA.vel / resB.vel;
            // 1.0ã«è¿‘ã„ã»ã©é«˜å¾—ç‚¹ (0.8 -> 80ç‚¹, 1.2 -> 100ç‚¹)
            if (ratio > 1.0) ratio = 1.0;
            speedScore = Math.round(ratio * 100);
          } else {
            // è¦‹æœ¬ãŒå‹•ã„ã¦ã„ãªã„å ´åˆ
            speedScore = 0;
          }

          // 2. å§¿å‹¢ã®ä¸€è‡´åº¦ (å·®åˆ†)
          const leanDiff = Math.abs(resA.lean - resB.lean);
          const postureScore = Math.max(0, 100 - (leanDiff * 3)); // 1åº¦é•ã†ã¨3ç‚¹æ¸›ç‚¹

          // ç·åˆç‚¹
          const totalScore = Math.round((speedScore + postureScore) / 2);

          // --- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ ---
          let speedComment = "";
          if (speedScore > 90) speedComment = "â­• é€Ÿåº¦ã¯å®Œç’§ã§ã™ã€‚è¦‹æœ¬ã¨åŒã˜é‹­ã•ãŒã‚ã‚Šã¾ã™ã€‚";
          else if (speedScore > 70) speedComment = "âš ï¸ ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒå°‘ã—ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è¦‹æœ¬ã‚ˆã‚Šé…ã‚Œã¦ã„ã¾ã™ã€‚";
          else speedComment = "âŒ åŠ é€ŸãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã£ã¨é‹­ãæŒ¯ã‚Šã¾ã—ã‚‡ã†ã€‚";

          let postureComment = "";
          // åŒã˜å‹•ç”»ãªã‚‰ leanDiff ã¯ã»ã¼0ã«ãªã‚‹
          if (leanDiff < 5) postureComment = "â­• å§¿å‹¢ã¯è¦‹æœ¬ã¨ã»ã¼åŒã˜ã§ã™ã€‚ç´ æ™´ã‚‰ã—ã„ï¼";
          else if (resA.lean > resB.lean) postureComment = `âŒ è¦‹æœ¬ã‚ˆã‚Šå‰å‚¾ã—ã¦ã„ã¾ã™(å·®: ${leanDiff.toFixed(1)}Â°)ã€‚ä½“ã‚’èµ·ã“ã—ã¾ã—ã‚‡ã†ã€‚`;
          else postureComment = `âš ï¸ è¦‹æœ¬ã‚ˆã‚Šæ£’ç«‹ã¡æ°—å‘³ã§ã™ã€‚ã‚‚ã†å°‘ã—å‰å‚¾å§¿å‹¢ã‚’å–ã‚Šã¾ã—ã‚‡ã†ã€‚`;

          // åˆ¤å®šçµæœã®å‡ºåŠ›
          resText.innerHTML = `
        <div style="text-align:center; margin-bottom:15px; border-bottom:2px solid #ddd; padding-bottom:10px;">
            <div style="font-size:12px; color:#666;">å†ç¾åº¦ã‚¹ã‚³ã‚¢ (Similarity)</div>
            <div style="font-size:36px; font-weight:bold; color:#0277bd;">${totalScore} <span style="font-size:16px;">/ 100</span></div>
        </div>

        <div style="margin-bottom:10px;">
            <strong style="color:#ef6c00;">âš¡ ã‚¹ã‚¤ãƒ³ã‚°é€Ÿåº¦ (Speed)</strong>
            <div style="background:#fff3e0; padding:8px; border-radius:4px; font-size:13px; margin-top:5px;">
                å†ç¾åº¦: <b>${speedScore}%</b><br>
                ${speedComment}
            </div>
        </div>

        <div style="margin-bottom:10px;">
            <strong style="color:#2e7d32;">ğŸ§ å§¿å‹¢ãƒ»è»¸ (Posture)</strong>
            <div style="background:#e8f5e9; padding:8px; border-radius:4px; font-size:13px; margin-top:5px;">
                å†ç¾åº¦: <b>${postureScore}%</b><br>
                ${postureComment}
            </div>
        </div>

        <div style="font-size:11px; color:#999; text-align:right; margin-top:5px;">
            Max Speed: A(${resA.vel.toFixed(2)}) / B(${resB.vel.toFixed(2)})
        </div>
    `;
        }

        // æ—¢å­˜åˆ¶å¾¡é–¢æ•° (å¤‰æ›´ãªã—)
        function compPlayBoth() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          compChangeSpeed();
          if (vA) { vA.muted = true; vA.play().catch(e => console.log(e)); }
          if (vB) { vB.muted = true; vB.play().catch(e => console.log(e)); }
        }
        function compPauseBoth() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          if (vA) vA.pause();
          if (vB) vB.pause();
        }
        function compResetBoth() {
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          if (vA) { vA.pause(); vA.currentTime = 0; }
          if (vB) { vB.pause(); vB.currentTime = 0; }
          isCompAnalysisRunning = false;
          document.getElementById('ai-comparison-result').style.display = "none";
        }
        function compChangeSpeed() {
          const speedSelect = document.getElementById('comp-speed');
          const speed = speedSelect ? parseFloat(speedSelect.value) : 1.0;
          const vA = document.getElementById('video-a');
          const vB = document.getElementById('video-b');
          if (vA) vA.playbackRate = speed;
          if (vB) vB.playbackRate = speed;
        }
        function compIndividualSeek(videoId, value) {
          const video = document.getElementById(videoId);
          if (!video || !video.duration) return;
          video.currentTime = video.duration * (value / 100);
        }
        function compUpdateSeek(videoId) {
          const video = document.getElementById(videoId);
          const seek = document.getElementById('seek-' + videoId);
          if (video && video.duration && seek) {
            seek.value = (video.currentTime / video.duration) * 100;
          }
        }

        // ==========================================
        // ğŸ”² å‹•ç”»é‡ã­åˆã‚ã› (Overlay) æ©Ÿèƒ½
        // ==========================================
        let isOverlayMode = false;

        function toggleOverlayMode() {
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãŒãªã‘ã‚Œã°å®šç¾©ï¼ˆå¿µã®ãŸã‚ï¼‰
          if (typeof isOverlayMode === 'undefined') isOverlayMode = false;

          isOverlayMode = !isOverlayMode;
          const container = document.getElementById("comp-video-container");
          const btn = document.getElementById("btn-overlay-toggle");
          const controls = document.getElementById("overlay-controls");

          // ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ“ãƒ‡ã‚ªæ ã‚’å–å¾—
          const wrappers = container.children;
          if (wrappers.length < 2) return;

          const wrapperA = wrappers[0]; // å‹•ç”»A
          const wrapperB = wrappers[1]; // å‹•ç”»B (è¦‹æœ¬)

          if (isOverlayMode) {
            // --- ON (é‡ã­åˆã‚ã›) ---
            btn.style.background = "#e91e63";
            btn.textContent = "â—« ä¸¦ã¹ã¦è¡¨ç¤º";
            if (controls) controls.style.display = "flex";

            // ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            wrapperA.style.width = "100%";
            wrapperA.style.maxWidth = "640px";
            wrapperA.style.flex = "none";

            wrapperB.style.position = "absolute";
            wrapperB.style.top = "0";
            wrapperB.style.left = "0";
            wrapperB.style.width = "100%";
            wrapperB.style.height = "100%";
            wrapperB.style.pointerEvents = "none";
            wrapperB.style.display = "flex";
            wrapperB.style.flexDirection = "column";
            wrapperB.style.justifyContent = "flex-end";

            container.style.display = "grid";
            container.style.gridTemplateAreas = "'stack'";

            wrapperA.style.gridArea = "stack";
            wrapperB.style.gridArea = "stack";

            // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å€¤ã‚’é©ç”¨
            const opVal = document.getElementById("overlay-opacity").value;
            wrapperA.style.opacity = "1";
            wrapperB.style.opacity = opVal;

            // ä½ç½®ã‚‚é©ç”¨
            updateOverlayPosition();

          } else {
            // --- OFF (ä¸¦ã¹ã¦è¡¨ç¤º) ---
            btn.style.background = "#673ab7";
            btn.textContent = "ğŸ”² é‡ã­åˆã‚ã› (Overlay)";
            if (controls) controls.style.display = "none";

            container.style.display = "flex";
            container.style.gridTemplateAreas = "none";

            wrapperA.style.width = "";
            wrapperA.style.maxWidth = "";
            wrapperA.style.flex = "1";
            wrapperA.style.gridArea = "";
            wrapperA.style.opacity = "1";

            wrapperB.style.position = "";
            wrapperB.style.top = "";
            wrapperB.style.left = "";
            wrapperB.style.width = "";
            wrapperB.style.height = "";
            wrapperB.style.opacity = "1";
            wrapperB.style.pointerEvents = "auto";
            wrapperB.style.flex = "1";
            wrapperB.style.gridArea = "";

            // ä½ç½®ã‚ºãƒ¬ã‚’ãƒªã‚»ãƒƒãƒˆ
            wrapperB.style.transform = "";
          }
        }

        // 2. é€æ˜åº¦ã®å¤‰æ›´ (ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨)
        function updateOverlayOpacity(val) {
          const container = document.getElementById("comp-video-container");
          if (!container || container.children.length < 2) return;

          // 2ã¤ç›®ã®è¦ç´ ï¼ˆå‹•ç”»Bï¼‰ã®é€æ˜åº¦ã‚’å¤‰ãˆã‚‹
          const wrapperB = container.children[1];
          if (wrapperB) {
            wrapperB.style.opacity = val;
          }
        }

        // 3. ä½ç½®ã®å¤‰æ›´ (X, Yã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨)
        function updateOverlayPosition() {
          const xInput = document.getElementById("overlay-pos-x");
          const yInput = document.getElementById("overlay-pos-y");

          // è¦ç´ ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (!xInput || !yInput) return;

          const x = xInput.value;
          const y = yInput.value;

          const container = document.getElementById("comp-video-container");
          if (container && container.children.length > 1) {
            const wrapperB = container.children[1];
            // transformã‚’ä½¿ã£ã¦ç§»å‹•ã•ã›ã‚‹
            wrapperB.style.transform = `translate(${x}px, ${y}px)`;

            // ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°(åè»¢)ã—ã¦ã„ã‚‹å ´åˆã€scaleX(-1)ã‚’ç¶­æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ãƒã‚§ãƒƒã‚¯
            const videoB = document.getElementById("video-b");
            if (videoB && videoB.style.transform.includes("scaleX(-1)")) {
              // videoã‚¿ã‚°è‡ªä½“ãŒåè»¢ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã®ç§»å‹•ã¯translateã ã‘ã§OK
            }
          }
        }

        // 4. ä½ç½®ãƒªã‚»ãƒƒãƒˆ (ãƒœã‚¿ãƒ³ç”¨)
        function resetOverlayPosition() {
          const xInput = document.getElementById("overlay-pos-x");
          const yInput = document.getElementById("overlay-pos-y");
          if (xInput) xInput.value = 0;
          if (yInput) yInput.value = 0;
          updateOverlayPosition();
        }

        // ==========================================
        // ğŸ¥ æˆæ¥­å‹•ç”»ã‚¹ã‚¿ã‚¸ã‚ªæ©Ÿèƒ½ (ãƒã‚¤ã‚¯ãƒŸãƒ¥ãƒ¼ãƒˆå®Ÿè£…å®Œäº†ç‰ˆ)
        // ==========================================

        let studioRecorder = null;
        let studioChunks = [];
        let studioIsRecording = false;

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ»æ˜ åƒç®¡ç†
        let studioMixedStream = null;
        let studioSourceStream = null;
        let webcamStream = null;

        // å†…éƒ¨å‡¦ç†ç”¨
        let studioDrawAnimId = null;
        let audioContext = null;
        let audioAnalyser = null;
        let audioAnimId = null;

        // â˜…è¿½åŠ : ãƒã‚¤ã‚¯éŸ³é‡åˆ¶å¾¡ç”¨ãƒãƒ¼ãƒ‰
        let studioMicGainNode = null;

        // ãƒ•ãƒ©ã‚°
        let isWebcamVisible = true;

        // DOMè¦ç´ 
        const studioPreview = document.getElementById('studio-preview');
        const hiddenSourceVideo = document.getElementById('hidden-source-video');
        const mixingCanvas = document.getElementById('studio-mixing-canvas');
        const mixingCtx = mixingCanvas ? mixingCanvas.getContext('2d') : null;

        // Webã‚«ãƒ¡ãƒ©ç”¨éš ã—ãƒ“ãƒ‡ã‚ª
        let hiddenWebcamVideo = document.getElementById('hidden-webcam-video');
        if (!hiddenWebcamVideo) {
          hiddenWebcamVideo = document.createElement('video');
          hiddenWebcamVideo.id = 'hidden-webcam-video';
          hiddenWebcamVideo.style.display = 'none';
          hiddenWebcamVideo.muted = true;
          hiddenWebcamVideo.playsInline = true;
          document.body.appendChild(hiddenWebcamVideo);
        }

        const btnStudioRec = document.getElementById('btn-studio-record');
        const studioIndicator = document.getElementById('studio-rec-indicator');
        const btnStopStream = document.getElementById('btn-studio-stop-stream');
        const levelBar = document.getElementById('audio-level-bar');
        const micStatusText = document.getElementById('mic-status-text');

        const btnToggleMic = document.getElementById('btn-toggle-mic');
        const btnToggleCam = document.getElementById('btn-toggle-cam');
        const btnChangeScreen = document.getElementById('btn-change-screen');

        // 1. ã‚¹ã‚¿ã‚¸ã‚ªé–‹å§‹
        async function startStudioScreenShare() {
          if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
            alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ç”»é¢å…±æœ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚PCã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
            return;
          }

          try {
            // --- â‘  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆãƒã‚¤ã‚¯ ï¼† ã‚«ãƒ¡ãƒ©ï¼‰ã®å–å¾— ---
            try {
              const userStream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: true, noiseSuppression: true },
                video: { width: 320, height: 240, facingMode: "user" }
              });

              // æ˜ åƒ
              webcamStream = new MediaStream(userStream.getVideoTracks());
              hiddenWebcamVideo.srcObject = webcamStream;
              hiddenWebcamVideo.play().catch(e => console.log("Webcam play error:", e));

              // éŸ³å£°ï¼ˆãƒã‚¤ã‚¯ï¼‰
              const micOnlyStream = new MediaStream(userStream.getAudioTracks());

              // ãƒã‚¤ã‚¯åˆæœŸåŒ–
              initAudioMeter(micOnlyStream);

              // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
              btnToggleCam.disabled = false;
              btnToggleCam.innerHTML = "ğŸ“·";
              btnToggleCam.style.background = "#555";
              isWebcamVisible = true;

            } catch (e) {
              console.log("ãƒã‚¤ã‚¯/ã‚«ãƒ¡ãƒ©ãªã—ã€ã¾ãŸã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸ:", e);
              btnToggleCam.disabled = true;
              btnToggleCam.innerHTML = "ğŸš«";
              btnToggleMic.disabled = true;
              btnToggleMic.innerHTML = "ğŸš«";
            }

            // --- â‘¡ ç”»é¢å…±æœ‰ ---
            const displayStream = await navigator.mediaDevices.getDisplayMedia({
              video: { cursor: "always", displaySurface: "browser" },
              audio: true,
              systemAudio: "include"
            });

            const sysAudioTracks = displayStream.getAudioTracks();
            if (sysAudioTracks.length === 0) {
              alert("âš ï¸ PCã®éŸ³ãŒå…±æœ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼\nYouTubeã®éŸ³ã‚’å…¥ã‚Œã‚‹ã«ã¯ã€ç”»é¢é¸æŠæ™‚ã«\nã€Œã‚¿ãƒ–ã®éŸ³å£°ã‚’å…±æœ‰ã€ã«å¿…ãšãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");
            }

            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: éŒ²ç”»ä¸­ã ã£ãŸå ´åˆã®ã¿ä¿å­˜å‡¦ç†ã¨ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™ â˜…â˜…â˜…
            const screenTrack = displayStream.getVideoTracks()[0];
            screenTrack.onended = () => {
              if (studioIsRecording) {
                // éŒ²ç”»ä¸­ãªã‚‰åœæ­¢ã—ã¦ä¿å­˜
                toggleStudioRecording();
                alert("ç”»é¢å…±æœ‰ãŒçµ‚äº†ã—ãŸãŸã‚ã€éŒ²ç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
              }
              // éŒ²ç”»ã—ã¦ã„ãªã‘ã‚Œã°ã€ä½•ã‚‚è¨€ã‚ãšã«çµ‚äº†å‡¦ç†ã ã‘è¡Œã†
              stopStudioStream();
            };

            // --- â‘¢ æ˜ åƒã®æº–å‚™ ---
            setSourceStream(displayStream);

            // --- â‘£ éŸ³å£°ã®ãƒŸãƒƒã‚¯ã‚¹ ---
            const micTracks = audioContext ? [] : [];
            const mixedAudio = await mixAudioStreams(displayStream);

            // --- â‘¤ éŒ²ç”»ç”¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ä½œæˆ ---
            const canvasStream = mixingCanvas.captureStream(30);
            let tracks = [...canvasStream.getVideoTracks()];

            if (mixedAudio.length > 0) {
              tracks.push(mixedAudio[0]);
            }

            studioMixedStream = new MediaStream(tracks);

            // --- â‘¥ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹ ---
            setupStudioPreview();

          } catch (err) {
            console.error("Error:", err);
            if (err.name !== 'NotAllowedError') alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
          }
        }

        // 2. æ˜ åƒã‚½ãƒ¼ã‚¹ã‚»ãƒƒãƒˆ
        function setSourceStream(stream) {
          if (studioSourceStream) studioSourceStream.getTracks().forEach(t => t.stop());
          studioSourceStream = stream;
          hiddenSourceVideo.srcObject = stream;

          hiddenSourceVideo.onloadedmetadata = () => {
            hiddenSourceVideo.play().catch(e => console.log("è‡ªå‹•å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
            if (hiddenSourceVideo.videoWidth > 0) {
              mixingCanvas.width = hiddenSourceVideo.videoWidth;
              mixingCanvas.height = hiddenSourceVideo.videoHeight;
            }
          };

          if (studioDrawAnimId) clearInterval(studioDrawAnimId);
          studioDrawAnimId = setInterval(drawVideoToCanvas, 33);
        }

        // 3. Canvasæç”» (ãƒ¯ã‚¤ãƒ—åˆæˆ)
        function drawVideoToCanvas() {
          if (!studioSourceStream || !mixingCtx) return;

          if (hiddenSourceVideo.videoWidth > 0 &&
            (mixingCanvas.width !== hiddenSourceVideo.videoWidth || mixingCanvas.height !== hiddenSourceVideo.videoHeight)) {
            mixingCanvas.width = hiddenSourceVideo.videoWidth;
            mixingCanvas.height = hiddenSourceVideo.videoHeight;
          }

          // A. èƒŒæ™¯
          mixingCtx.drawImage(hiddenSourceVideo, 0, 0, mixingCanvas.width, mixingCanvas.height);

          // B. ãƒ¯ã‚¤ãƒ—
          if (isWebcamVisible && hiddenWebcamVideo && hiddenWebcamVideo.readyState >= 2) {
            const cw = mixingCanvas.width;
            const ch = mixingCanvas.height;

            const wipeW = cw * 0.2;
            const wipeH = (wipeW / 4) * 3;
            const margin = 20;

            const x = cw - wipeW - margin;
            const y = ch - wipeH - margin;

            mixingCtx.save();
            mixingCtx.beginPath();
            const cx = x + wipeW / 2;
            const cy = y + wipeH / 2;
            const radius = Math.min(wipeW, wipeH) / 2;
            mixingCtx.arc(cx, cy, radius, 0, Math.PI * 2);
            mixingCtx.closePath();
            mixingCtx.clip();

            mixingCtx.drawImage(hiddenWebcamVideo, x, y, wipeW, wipeH);

            mixingCtx.strokeStyle = "white";
            mixingCtx.lineWidth = 4;
            mixingCtx.stroke();
            mixingCtx.restore();
          }
        }

        // 4. éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹ (ãƒã‚¤ã‚¯ãƒŸãƒ¥ãƒ¼ãƒˆå¯¾å¿œç‰ˆ)
        async function mixAudioStreams(displayStream) {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          const ctx = audioContext || new AudioContext(); // æ—¢å­˜ãŒã‚ã‚Œã°ä½¿ã†
          const dest = ctx.createMediaStreamDestination();

          if (ctx.state === 'suspended') await ctx.resume();

          // A. ãƒã‚¤ã‚¯éŸ³å£°æ¥ç¶š
          // initAudioMeterã§ä¿æŒã—ãŸã‚½ãƒ¼ã‚¹ã‚’åˆ©ç”¨
          if (window.currentMicSource) {
            const micGain = ctx.createGain();
            micGain.gain.value = 1.5; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
            window.currentMicSource.connect(micGain).connect(dest);

            // â˜…é‡è¦: ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ã—ã¦ã€å¾Œã§åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            studioMicGainNode = micGain;
          }

          // B. ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°æ¥ç¶š
          if (displayStream && displayStream.getAudioTracks().length > 0) {
            const sysSrc = ctx.createMediaStreamSource(displayStream);
            const sysGain = ctx.createGain();
            sysGain.gain.value = 1.0;
            sysSrc.connect(sysGain).connect(dest);
          }

          return dest.stream.getAudioTracks();
        }

        // 5. çµ‚äº†å‡¦ç†
        function stopStudioStream() {
          if (studioSourceStream) { studioSourceStream.getTracks().forEach(t => t.stop()); studioSourceStream = null; }
          if (studioMixedStream) { studioMixedStream.getTracks().forEach(t => t.stop()); studioMixedStream = null; }
          if (webcamStream) { webcamStream.getTracks().forEach(t => t.stop()); webcamStream = null; }

          studioPreview.srcObject = null;
          hiddenSourceVideo.srcObject = null;
          hiddenWebcamVideo.srcObject = null;

          // AudioContextã¯é–‰ã˜ãšã«ä¿æŒã™ã‚‹ãŒã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­¢ã‚ã‚‹
          if (audioAnimId) cancelAnimationFrame(audioAnimId);
          if (studioDrawAnimId) { clearInterval(studioDrawAnimId); studioDrawAnimId = null; }

          // UIãƒªã‚»ãƒƒãƒˆ
          btnStudioRec.disabled = true; btnStudioRec.style.background = "#ccc"; btnStudioRec.innerHTML = "â—";
          btnToggleMic.disabled = true; btnToggleMic.style.background = "#444";
          btnToggleCam.disabled = true; btnToggleCam.style.background = "#444";
          btnChangeScreen.disabled = true; btnChangeScreen.style.background = "#444";

          levelBar.style.width = "0%";
          micStatusText.textContent = "OFF";
          studioIndicator.style.display = "none";
          btnStopStream.style.display = "none";
          studioIsRecording = false;
          studioMicGainNode = null; // ãƒªã‚»ãƒƒãƒˆ

          if (document.fullscreenElement) document.exitFullscreen();
        }

        // 6. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
        function setupStudioPreview() {
          if (!studioMixedStream) return;
          const previewVideo = document.getElementById('studio-preview');
          if (previewVideo) {
            previewVideo.srcObject = studioMixedStream;
            previewVideo.muted = true;
          }
          const buttonsToEnable = [
            { id: 'btn-studio-record', color: '#d32f2f' },
            { id: 'btn-change-screen', color: '#0277bd' },
            { id: 'btn-toggle-preview', color: '#555' }
          ];
          buttonsToEnable.forEach(item => {
            const btn = document.getElementById(item.id);
            if (btn) {
              btn.disabled = false;
              btn.style.cursor = 'pointer';
              btn.style.background = item.color;
            }
          });
          const btnStop = document.getElementById('btn-studio-stop-stream');
          if (btnStop) btnStop.style.display = "inline-block";

          const container = document.getElementById("studio-container");
          if (container) container.scrollIntoView({ behavior: 'smooth' });
        }

        // 7. ãƒã‚¤ã‚¯ãƒ¡ãƒ¼ã‚¿ãƒ¼ & ã‚½ãƒ¼ã‚¹ä¿æŒ
        function initAudioMeter(stream) {
          if (audioContext) audioContext.close();
          try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioAnalyser = audioContext.createAnalyser();
            audioAnalyser.fftSize = 256;

            if (stream.getAudioTracks().length > 0) {
              const audioSource = audioContext.createMediaStreamSource(stream);
              // â˜…ã‚½ãƒ¼ã‚¹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¿å­˜ã—ã¦mixé–¢æ•°ã§ä½¿ã†
              window.currentMicSource = audioSource;

              audioSource.connect(audioAnalyser);

              const dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
              const updateMeter = () => {
                if (!audioContext) return;

                // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°
                audioAnalyser.getByteFrequencyData(dataArray);
                let values = 0;
                for (let i = 0; i < dataArray.length; i++) values += dataArray[i];
                const average = values / dataArray.length;
                let percent = Math.min(100, average * 3.0);

                // ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ã¯ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚‚æ­¢ã‚ã‚‹ï¼ˆè¦–è¦šçš„ã«ã‚ã‹ã‚Šã‚„ã™ãï¼‰
                if (studioMicGainNode && studioMicGainNode.gain.value === 0) {
                  percent = 0;
                }

                if (levelBar) {
                  levelBar.style.width = percent + "%";
                  if (percent > 80) levelBar.style.background = "#ff1744";
                  else levelBar.style.background = "linear-gradient(to right, #00e676, #ffeb3b)";
                }
                audioAnimId = requestAnimationFrame(updateMeter);
              };
              updateMeter();
              if (micStatusText) micStatusText.textContent = "ON";

              // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
              btnToggleMic.disabled = false;
              btnToggleMic.innerHTML = "ğŸ¤";
              btnToggleMic.style.background = "#555";
              btnToggleMic.style.cursor = "pointer";
            }
          } catch (e) { console.error("Audio Meter Init Error:", e); }
        }

        // 8. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿
        function toggleStudioPreview() {
          const preview = document.getElementById('studio-preview');
          const btn = document.getElementById('btn-toggle-preview');
          if (preview.style.opacity === '0') {
            preview.style.opacity = '1';
            btn.style.background = "#555";
            btn.innerHTML = "ğŸ‘ï¸";
          } else {
            preview.style.opacity = '0';
            btn.style.background = "#d32f2f";
            btn.innerHTML = "ğŸ™ˆ";
          }
        }

        // 9. ãƒã‚¤ã‚¯åˆ‡æ›¿ (éŸ³é‡ã‚²ã‚¤ãƒ³åˆ¶å¾¡)
        function toggleStudioMic() {
          // ãƒãƒ¼ãƒ‰ãŒæº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (!studioMicGainNode) return;

          const btn = document.getElementById('btn-toggle-mic');
          const status = document.getElementById('mic-status-text');

          if (studioMicGainNode.gain.value > 0) {
            // ãƒŸãƒ¥ãƒ¼ãƒˆã™ã‚‹
            studioMicGainNode.gain.value = 0;
            if (btn) {
              btn.innerHTML = "ğŸ”‡";
              btn.style.background = "#d32f2f";
              btn.style.color = "white";
            }
            if (status) status.textContent = "Muted";
          } else {
            // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
            studioMicGainNode.gain.value = 1.5;
            if (btn) {
              btn.innerHTML = "ğŸ¤";
              btn.style.background = "#555";
              btn.style.color = "white";
            }
            if (status) status.textContent = "ON";
          }
        }

        // 10. ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ (ãƒ¯ã‚¤ãƒ—)
        function toggleStudioCamera() {
          isWebcamVisible = !isWebcamVisible;
          const btn = document.getElementById('btn-toggle-cam');

          if (isWebcamVisible) {
            btn.innerHTML = "ğŸ“·";
            btn.style.background = "#555";
          } else {
            btn.innerHTML = "ğŸš«";
            btn.style.background = "#d32f2f";
          }
        }

        // 11. ç”»é¢å¤‰æ›´
        async function changeStudioSource() {
          const wasFullScreen = !!document.fullscreenElement;
          try {
            const newDisplayStream = await navigator.mediaDevices.getDisplayMedia({
              video: { cursor: "always" },
              audio: false
            });
            setSourceStream(newDisplayStream);
            if (wasFullScreen) {
              const container = document.getElementById('studio-container');
              if (container) {
                setTimeout(() => {
                  container.requestFullscreen().catch(e => console.log("å…¨ç”»é¢å¾©å¸°å¤±æ•—:", e));
                }, 500);
              }
            }
          } catch (err) { console.log("ç”»é¢å¤‰æ›´ã‚­ãƒ£ãƒ³ã‚»ãƒ«:", err); }
        }

        // 12. éŒ²ç”»é–‹å§‹/åœæ­¢
        function toggleStudioRecording() {
          if (!studioMixedStream) return;
          const btn = document.getElementById('btn-studio-record');
          const indicator = document.getElementById('studio-rec-indicator');

          if (!studioIsRecording) {
            studioChunks = [];
            const mimeTypes = ["video/mp4", "video/webm;codecs=vp9", "video/webm"];
            const selectedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || "video/webm";

            try {
              studioRecorder = new MediaRecorder(studioMixedStream, { mimeType: selectedType });
            } catch (e) {
              alert("éŒ²ç”»ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
              return;
            }

            studioRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) studioChunks.push(e.data);
            };

            studioRecorder.onstop = saveStudioVideo;
            studioRecorder.start();
            studioIsRecording = true;

            if (indicator) indicator.style.display = "block";
            if (btn) {
              btn.innerHTML = "â– ";
              btn.style.borderRadius = "8px";
              btn.style.background = "#fff";
              btn.style.color = "#d32f2f";
            }
          } else {
            studioRecorder.stop();
            studioIsRecording = false;

            if (indicator) indicator.style.display = "none";
            if (btn) {
              btn.innerHTML = "â—";
              btn.style.borderRadius = "50%";
              btn.style.background = "#d32f2f";
              btn.style.color = "#fff";
            }
          }
        }

        // 13. ä¿å­˜
        function saveStudioVideo() {
          // ã€ä¿®æ­£ã€‘ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹
          if (studioChunks.length === 0) {
            alert("éŒ²ç”»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\néŒ²ç”»æ™‚é–“ãŒçŸ­ã™ããŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            return;
          }

          // Blobã®ä½œæˆ
          const blob = new Blob(studioChunks, { type: studioRecorder.mimeType });

          // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
          const now = new Date();
          const timestamp = `${now.getHours()}æ™‚${now.getMinutes()}åˆ†_${now.getSeconds()}ç§’`;
          const ext = studioRecorder.mimeType.includes("mp4") ? "mp4" : "webm";
          const filename = `Lesson_${timestamp}.${ext}`;

          // â‘  PCã¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            // window.URL.revokeObjectURL(url); 
          }, 100);

          // â‘¡ ã‚¢ãƒ—ãƒªå†…ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(IndexedDB)ã¸ä¿å­˜
          if (confirm("å‹•ç”»ã‚’ã‚¢ãƒ—ãƒªå†…ã®ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã«ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n(æ¬¡å›ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚è¦‹ã‚‰ã‚Œã¾ã™)")) {
            saveVideoToDB(blob, filename);
          }
        }

        // 14. å…¨ç”»é¢
        function toggleStudioFullScreen() {
          const container = document.getElementById('studio-container');
          if (!container) return;
          if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
              alert(`å…¨ç”»é¢ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            });
          } else {
            document.exitFullscreen();
          }
        }

        // ==========================================
        // ğŸ“š IndexedDB ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (ä¿®æ­£ç‰ˆ)
        // ==========================================

        const DB_NAME = "SmartCoachVideoDB";
        const DB_VERSION = 1;
        const STORE_NAME = "videos";

        let videoDB = null;

        // 1. DBã‚’é–‹ãï¼ˆåˆæœŸåŒ–ï¼‰
        function openVideoDB() {
          return new Promise((resolve, reject) => {
            // ã™ã§ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’è¿”ã™
            if (videoDB) {
              resolve(videoDB);
              return;
            }

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
                store.createIndex("created", "created", { unique: false });
              }
            };

            request.onsuccess = (event) => {
              videoDB = event.target.result;
              console.log("DB Open Success");
              resolve(videoDB);
            };

            request.onerror = (event) => {
              console.error("DB Open Error:", event.target.error);
              reject(event.target.error);
            };
          });
        }

        // 3. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºå¼·åŒ–ç‰ˆ)
        async function loadLibraryFromDB() {
          const listDiv = document.getElementById("library-list");
          const countSpan = document.getElementById("db-count");

          // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º
          if (listDiv) listDiv.innerHTML = '<p style="padding:20px; text-align:center; color:#666;">â³ èª­ã¿è¾¼ã¿ä¸­...</p>';

          try {
            if (!videoDB) {
              await openVideoDB();
            }

            const transaction = videoDB.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const index = store.index("created");

            const request = index.openCursor(null, 'prev');
            const items = [];

            request.onsuccess = (event) => {
              const cursor = event.target.result;
              if (cursor) {
                items.push(cursor.value);
                cursor.continue();
              } else {
                // å…¨ä»¶å–å¾—å®Œäº†å¾Œã«æç”»
                renderLibraryItems(items);
                if (countSpan) countSpan.textContent = items.length;
              }
            };

            request.onerror = (event) => {
              throw new Error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + event.target.error);
            };

          } catch (e) {
            console.error(e);
            if (listDiv) {
              listDiv.innerHTML = `<p style="padding:20px; color:red; text-align:center;">
                âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>${e.message}
            </p>`;
            }
          }
        }

        // âœ… æ–°è¦è¿½åŠ ï¼šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        async function updateStorageInfo() {
          const infoEl = document.getElementById("storage-usage");
          if (!infoEl) return;

          if ('storage' in navigator && 'estimate' in navigator.storage) {
            try {
              const { usage, quota } = await navigator.storage.estimate();

              // ãƒã‚¤ãƒˆå˜ä½ã‚’MB/GBã«å¤‰æ›
              const usedMB = (usage / (1024 * 1024)).toFixed(0);
              const totalGB = (quota / (1024 * 1024 * 1024)).toFixed(1);
              const percent = Math.round((usage / quota) * 100);

              // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ (ä¾‹: 150MB / 60.5GB (1%))
              // â€»quotaã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¢ãƒ—ãƒªã«è¨±å¯ã—ã¦ã„ã‚‹ä¸Šé™ï¼ˆãƒ‡ãƒã‚¤ã‚¹å…¨å®¹é‡ã§ã¯ãªã„ï¼‰ã§ã™
              infoEl.textContent = `${usedMB} MB / ${totalGB} GB (${percent}%)`;

              // å®¹é‡ãŒã„ã£ã±ã„ï¼ˆ80%ä»¥ä¸Šï¼‰ãªã‚‰èµ¤å­—ã«ã™ã‚‹è­¦å‘Š
              if (percent >= 80) {
                infoEl.style.color = "red";
                infoEl.style.fontWeight = "bold";
              } else {
                infoEl.style.color = "inherit";
                infoEl.style.fontWeight = "normal";
              }

            } catch (error) {
              console.error("Storage estimate error:", error);
              infoEl.textContent = "å–å¾—ã‚¨ãƒ©ãƒ¼";
            }
          } else {
            infoEl.textContent = "æœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶";
          }
        }

        // 4. ç”»é¢æç”» (0ä»¶æ™‚ã®è¡¨ç¤ºã‚’è¿½åŠ )
        function renderLibraryItems(items) {
          const listDiv = document.getElementById("library-list");
          if (!listDiv) return;

          listDiv.innerHTML = ""; // ä¸€æ—¦ã‚¯ãƒªã‚¢

          // ã€é‡è¦ã€‘ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®å ´åˆã®è¡¨ç¤º
          if (items.length === 0) {
            listDiv.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999; background: #f9f9f9; border-radius: 8px;">
                <p style="font-size: 40px; margin-bottom: 10px;">ğŸ“­</p>
                <p>ä¿å­˜ã•ã‚ŒãŸå‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <p style="font-size: 12px;">ã€Œãƒ“ãƒ‡ã‚ªã‚¹ã‚¿ã‚¸ã‚ªã€ã‚„ã€ŒAIåˆ†æã€ã§éŒ²ç”»ã‚’è¡Œã„ã€<br>ä¿å­˜ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        `;
            return;
          }

          // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®æç”»
          items.forEach(item => {
            // Blob URLã®ç”Ÿæˆï¼ˆã‚¨ãƒ©ãƒ¼å¯¾ç­–ä»˜ãï¼‰
            let url = "";
            try {
              url = URL.createObjectURL(item.blob);
            } catch (e) {
              console.error("Blob URLç”Ÿæˆã‚¨ãƒ©ãƒ¼", e);
              return; // ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚¹ã‚­ãƒƒãƒ—
            }

            const dateStr = item.created ? new Date(item.created).toLocaleString() : "æ—¥æ™‚ä¸æ˜";
            const sizeMB = (item.size / (1024 * 1024)).toFixed(1);

            const card = document.createElement("div");
            card.style.cssText = "background:#fff; border:1px solid #ccc; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; flex-direction:column;";

            card.innerHTML = `
            <div style="background:#000; width:100%; height:180px; display:flex; align-items:center; justify-content:center;">
                <video src="${url}" controls style="max-width:100%; max-height:100%;"></video>
            </div>
            <div style="padding:12px; flex:1; display:flex; flex-direction:column;">
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px; color:#333; word-break:break-all;">${item.filename}</div>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">ğŸ“… ${dateStr} <br>(ğŸ’¾ ${sizeMB} MB)</div>
                <div style="margin-top:auto; display:flex; justify-content:space-between; gap:10px;">
                    <a href="${url}" download="${item.filename}" style="flex:1; text-align:center; background:#e3f2fd; color:#1565c0; text-decoration:none; padding:6px; border-radius:4px; font-size:12px; font-weight:bold;">ğŸ“¥ PCã¸ä¿å­˜</a>
                    <button onclick="deleteVideoFromDB(${item.id})" style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2; border-radius:4px; padding:6px 12px; font-size:12px; cursor:pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            </div>
        `;
            listDiv.appendChild(card);
          });
        }

        // 5. å‰Šé™¤æ©Ÿèƒ½
        async function deleteVideoFromDB(id) {
          if (!confirm("ã“ã®å‹•ç”»ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
          if (!videoDB) await openVideoDB(); // â˜… ä¿®æ­£

          const transaction = videoDB.transaction([STORE_NAME], "readwrite"); // â˜… ä¿®æ­£
          const store = transaction.objectStore(STORE_NAME);
          store.delete(id);

          transaction.oncomplete = () => {
            loadLibraryFromDB();
          };
        }

        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«DBã‚’é–‹ã„ã¦ãŠã
        window.addEventListener("DOMContentLoaded", () => {
          openVideoDB(); // â˜… ä¿®æ­£
        });

        // ==========================================
        // ğŸ”„ ã‚¢ãƒ—ãƒªå¼·åˆ¶æ›´æ–°æ©Ÿèƒ½
        // ==========================================
        async function forceUpdateApp() {
          if (!confirm("ã‚¢ãƒ—ãƒªã‚’å¼·åˆ¶çš„ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ï¼‰")) {
            return;
          }

          if ('serviceWorker' in navigator) {
            try {
              // 1. ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹Service Workerã‚’ã™ã¹ã¦è§£é™¤
              const registrations = await navigator.serviceWorker.getRegistrations();
              for (let registration of registrations) {
                await registration.unregister();
              }

              // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å‰Šé™¤ (å¿µã®ãŸã‚)
              if ('caches' in window) {
                const keys = await caches.keys();
                for (let key of keys) {
                  await caches.delete(key);
                }
              }

              // 3. ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã‚’å–ã‚Šç›´ã™
              alert("æ›´æ–°å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
              window.location.reload();

            } catch (error) {
              console.error("Update failed:", error);
              alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
              window.location.reload();
            }
          } else {
            // Service Workeréå¯¾å¿œãªã‚‰å˜ã«ãƒªãƒ­ãƒ¼ãƒ‰
            window.location.reload();
          }
        }

        // ==========================================
        // ğŸ” ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šè©³ç´°ã‚¨ãƒ©ãƒ¼ä»˜ãä¿å­˜é–¢æ•°
        // ==========================================
        async function saveVideoToDB(blob, filename) {
          console.log("ä¿å­˜å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...");

          try {
            // DBãŒé–‹ã„ã¦ã„ãªã‘ã‚Œã°é–‹ã
            if (!videoDB) {
              console.log("DBæ¥ç¶šã‚’è©¦ã¿ã¾ã™...");
              await openVideoDB();
            }

            const transaction = videoDB.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);

            const record = {
              blob: blob,
              filename: filename,
              created: new Date(),
              size: blob.size
            };

            const request = store.add(record);

            request.onsuccess = () => {
              console.log("ä¿å­˜æˆåŠŸï¼");
              alert("âœ… ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã—ãŸï¼\n[8. ãƒ©ã‚¤ãƒ–ãƒ©ãƒª] ã‚¿ãƒ–ã‚’é–‹ã„ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚");

              // å¿µã®ãŸã‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¡¨ç¤ºã‚‚æ›´æ–°ã—ã¦ãŠã
              if (typeof loadLibraryFromDB === 'function') loadLibraryFromDB();
            };

            request.onerror = (e) => {
              console.error("ä¿å­˜å¤±æ•—:", e);
              // è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã§å‡ºã™
              alert("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nåŸå› : " + e.target.error.message + "\n\nâ€» 'file://' ã§é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã§ä¿å­˜ã§ãã¾ã›ã‚“ã€‚Live Serverç­‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
            };

          } catch (err) {
            console.error("äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:", err);
            alert("âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + err.message);
          }
        }

        // ==========================================
        // ğŸ¦¶ ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æï¼šéŒ²ç”»æ©Ÿèƒ½ï¼ˆæ–°è¦è¿½åŠ ï¼‰
        // ==========================================
        let fwMediaRecorder = null;
        let fwRecordedChunks = [];

        // 1. éŒ²ç”»ï¼†ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²é–‹å§‹
        function fwStartRecording() {
          const canvas = document.getElementById('fw_canvas');
          if (!canvas) return;

          // --- A. ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ã®é–‹å§‹å‡¦ç† ---
          fwIsRecordingCSV = true;
          fwRecordedData = [];
          fwRecStartTime = Date.now();

          // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆè¨˜éŒ²ä¸­ã¯DLä¸å¯ï¼‰
          const btnDl = document.getElementById("btn-fw-download-csv");
          if (btnDl) {
            btnDl.disabled = true;
            btnDl.style.background = "#ccc";
            btnDl.style.cursor = "not-allowed";
          }

          // --- B. å‹•ç”»éŒ²ç”»ã®é–‹å§‹å‡¦ç† ---
          const stream = canvas.captureStream(30);
          fwRecordedChunks = [];

          const mimeTypes = ["video/mp4", "video/webkit", "video/webm;codecs=vp9", "video/webm"];
          const selectedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || "video/webm";

          try {
            fwMediaRecorder = new MediaRecorder(stream, { mimeType: selectedType });
          } catch (e) {
            alert("éŒ²ç”»ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            fwIsRecordingCSV = false; // å¤±æ•—ã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ã‚‚æˆ»ã™
            return;
          }

          fwMediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) fwRecordedChunks.push(event.data);
          };

          fwMediaRecorder.onstop = fwSaveVideo;
          fwMediaRecorder.start();

          // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
          document.getElementById("btn-fw-record-start").style.display = "none";
          document.getElementById("btn-fw-record-stop").style.display = "inline-block";
        }

        // 2. éŒ²ç”»ï¼†ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²åœæ­¢
        function fwStopRecording() {
          // --- A. å‹•ç”»åœæ­¢ ---
          if (fwMediaRecorder && fwMediaRecorder.state !== "inactive") {
            fwMediaRecorder.stop();
          }

          // --- B. ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²åœæ­¢ ---
          fwIsRecordingCSV = false;

          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          document.getElementById("btn-fw-record-start").style.display = "inline-block";
          document.getElementById("btn-fw-record-stop").style.display = "none";

          // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          const btnDl = document.getElementById("btn-fw-download-csv");
          if (fwRecordedData.length > 0 && btnDl) {
            btnDl.disabled = false;
            btnDl.style.background = "#1565c0";
            btnDl.style.cursor = "pointer";
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¡ˆå†…
            setTimeout(() => {
              alert("éŒ²ç”»ã¨è¨ˆæ¸¬ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n1. å‹•ç”»ã®ä¿å­˜ç”»é¢ãŒé–‹ãã¾ã™ã€‚\n2. ãƒ‡ãƒ¼ã‚¿ã®CSVä¿å­˜ã¯ã€é’ããªã£ãŸã€ŒCSVä¿å­˜ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚");
            }, 500);
          }
        }

        // 3. ä¿å­˜å‡¦ç†ï¼ˆå‹•ç”»ï¼‰
        function fwSaveVideo() {
          if (fwRecordedChunks.length === 0) {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼ˆå³åœæ­¢ãªã©ï¼‰
            return;
          }

          const now = new Date();
          const timestamp = `${now.getHours()}æ™‚${now.getMinutes()}åˆ†_${now.getSeconds()}ç§’`;
          const ext = fwMediaRecorder.mimeType.includes("mp4") ? "mp4" : "webm";
          const filename = `GameAnalysis_${timestamp}.${ext}`;

          const blob = new Blob(fwRecordedChunks, { type: fwMediaRecorder.mimeType });

          // â‘  ã‚·ã‚§ã‚¢/ä¿å­˜
          shareVideoFile(blob, filename);

          // â‘¡ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜ç¢ºèª
          if (confirm("å‹•ç”»ã‚’ã‚¢ãƒ—ãƒªå†…ã®ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã«ã‚‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) {
            saveVideoToDB(blob, filename);
          }
        }

        // ==========================================
        // âœ‚ï¸ å‹•ç”»ç·¨é›†æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ (è¤‡æ•°ãƒã‚¹ã‚¯ãƒ»æ™‚é–“è¡¨ç¤ºå¯¾å¿œç‰ˆ)
        // ==========================================

        let editorVideo = null;
        let editorCanvas = null;
        let editorCtx = null;
        let editorMaskAreas = []; // [{x, y, w, h}, ...] 
        let isEditorMaskSelecting = false;
        let editorDragStart = null;
        let currentEditorPos = null;
        let editorAnimId = null;
        let isEditorExporting = false;

        // 1. å‹•ç”»èª­ã¿è¾¼ã¿
        function loadEditorVideo(input) {
          const file = input.files[0];
          if (!file) return;

          editorVideo = document.getElementById("editor-source-video");
          editorCanvas = document.getElementById("editor-canvas");
          editorCtx = editorCanvas.getContext("2d");

          const url = URL.createObjectURL(file);
          editorVideo.src = url;
          editorVideo.muted = false;

          editorVideo.onloadedmetadata = () => {
            document.getElementById("editor-controls").style.display = "block";
            // â˜…ã“ã“ã‚’toFixed(2)ã«å¤‰æ›´
            document.getElementById("trim-end").value = editorVideo.duration.toFixed(2);
            
            const seekbar = document.getElementById("editor-seekbar");
            if(seekbar) {
                seekbar.max = editorVideo.duration;
                seekbar.value = 0;
                document.getElementById("total-time-display").textContent = editorVideo.duration.toFixed(2);
                seekbar.oninput = (e) => { editorVideo.currentTime = e.target.value; };
            }
            editorVideo.currentTime = 0;
          };

          editorVideo.onseeked = () => {
            updateEditorCanvas();
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å­—ã‚’åŒæœŸ
            const seekbar = document.getElementById("editor-seekbar");
            if(seekbar) {
                seekbar.value = editorVideo.currentTime;
                document.getElementById("current-time-display").textContent = editorVideo.currentTime.toFixed(2);
            }
          };
        }

        // 2. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºæ›´æ–°ã¨æç”»
        function updateEditorCanvas() {
          if (!editorVideo) return;
          const aspect = document.querySelector('input[name="aspect"]:checked').value;
          if (aspect === "16:9") {
            editorCanvas.width = 1280; editorCanvas.height = 720;
          } else {
            editorCanvas.width = 720; editorCanvas.height = 1280;
          }
          drawEditorFrame();
        }

        function drawEditorFrame() {
          if (!editorCtx) return;
          const w = editorCanvas.width;
          const h = editorCanvas.height;

          editorCtx.fillStyle = "#000";
          editorCtx.fillRect(0, 0, w, h);

          if (editorVideo.readyState >= 2) {
            const vw = editorVideo.videoWidth;
            const vh = editorVideo.videoHeight;
            const scale = Math.min(w / vw, h / vh);
            const drawW = vw * scale;
            const drawH = vh * scale;
            const offsetX = (w - drawW) / 2;
            const offsetY = (h - drawH) / 2;
            editorCtx.drawImage(editorVideo, offsetX, offsetY, drawW, drawH);
          }

          editorCtx.fillStyle = "#000";
          editorMaskAreas.forEach(area => {
            editorCtx.fillRect(area.x, area.y, area.w, area.h);
          });

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ã¿æ™‚é–“ã‚’å³ä¸Šã«è¡¨ç¤ºï¼ˆé»„è‰²ã§ç›®ç«‹ãŸã›ã‚‹ï¼‰
          if (!isEditorExporting && editorVideo) {
            const time = editorVideo.currentTime.toFixed(2);
            editorCtx.fillStyle = "rgba(0, 0, 0, 0.7)";
            editorCtx.fillRect(w - 140, 10, 130, 45); 
            editorCtx.fillStyle = "#ffeb3b";
            editorCtx.font = "bold 28px Arial";
            editorCtx.textAlign = "center";
            editorCtx.textBaseline = "middle";
            editorCtx.fillText(time + "s", w - 75, 33);
          }
        }

        // 3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿãƒ»åœæ­¢
        function previewEditorVideo() {
          const start = parseFloat(document.getElementById("trim-start").value);
          const end = parseFloat(document.getElementById("trim-end").value);

          if (editorVideo.currentTime >= end || editorVideo.currentTime < start) {
            editorVideo.currentTime = start;
          }
          
          editorVideo.muted = false;
          editorVideo.play();

          function loop() {
            if (editorVideo.paused || editorVideo.ended) return;
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åŒæœŸ
            const seekbar = document.getElementById("editor-seekbar");
            if(seekbar) {
                seekbar.value = editorVideo.currentTime;
                document.getElementById("current-time-display").textContent = editorVideo.currentTime.toFixed(2);
            }

            if (editorVideo.currentTime >= end) {
              editorVideo.pause();
              return;
            }
            drawEditorFrame();
            editorAnimId = requestAnimationFrame(loop);
          }
          loop();
        }

        function stopEditorPreview() {
          if(editorVideo) editorVideo.pause();
          if (editorAnimId) cancelAnimationFrame(editorAnimId);
        }

        // --- ã“ã“ã‹ã‚‰è¿½åŠ ãƒ»ä¿®æ­£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ ---

        // ã‚³ãƒé€ã‚Šãƒœã‚¿ãƒ³
        function stepEditorVideo(seconds) {
            if (!editorVideo) return;
            editorVideo.currentTime += seconds;
        }

        // ç¾åœ¨ã®å†ç”Ÿä½ç½®ã‚’å…¥åŠ›æ¬„ã«åæ˜ ã•ã›ã‚‹
        function updateTrimValue(type) {
            if (!editorVideo) return;
            
            // â˜…ã“ã“ã‚’toFixed(2)ã«å¤‰æ›´ï¼ˆ0.01ç§’å˜ä½ã§å–å¾—ï¼‰
            const currentTime = editorVideo.currentTime.toFixed(2);
            const targetInputId = (type === 'start') ? "trim-start" : "trim-end";
            
            const inputEl = document.getElementById(targetInputId);
            if (inputEl) {
                inputEl.value = currentTime;
                
                inputEl.style.backgroundColor = "#fff9c4";
                setTimeout(() => { inputEl.style.backgroundColor = "#fff"; }, 500);
            }
        }

        // æ—¢å­˜ã®é–¢æ•°ã‚’ updateTrimValue ã‚’ä½¿ã†ã‚ˆã†ã«æ›¸ãæ›ãˆ
        function setTrimCurrent(type) {
            updateTrimValue(type);
        }

        // 4. ãƒã‚¹ã‚¯ã‚¨ãƒªã‚¢æŒ‡å®šï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
        function getEditorPos(e) {
          const rect = editorCanvas.getBoundingClientRect();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          const scaleX = editorCanvas.width / rect.width;
          const scaleY = editorCanvas.height / rect.height;
          return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
          };
        }

        function toggleEditorMaskMode() {
          isEditorMaskSelecting = !isEditorMaskSelecting;
          const btn = document.getElementById("btn-editor-mask");

          if (isEditorMaskSelecting) {
            btn.textContent = "æŒ‡å®šä¸­... (ãƒ‰ãƒ©ãƒƒã‚°)";
            btn.style.background = "#d32f2f";

            // ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
            editorCanvas.addEventListener("mousedown", onEditorMouseDown);
            editorCanvas.addEventListener("mousemove", onEditorMouseMove);
            editorCanvas.addEventListener("mouseup", onEditorMouseUp);
            editorCanvas.addEventListener("touchstart", onEditorMouseDown, { passive: false });
            editorCanvas.addEventListener("touchmove", onEditorMouseMove, { passive: false });
            editorCanvas.addEventListener("touchend", onEditorMouseUp);

          } else {
            btn.textContent = "â¬› ã‚¨ãƒªã‚¢æŒ‡å®š";
            btn.style.background = "#424242";

            // ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
            editorCanvas.removeEventListener("mousedown", onEditorMouseDown);
            editorCanvas.removeEventListener("mousemove", onEditorMouseMove);
            editorCanvas.removeEventListener("mouseup", onEditorMouseUp);
            editorCanvas.removeEventListener("touchstart", onEditorMouseDown);
            editorCanvas.removeEventListener("touchmove", onEditorMouseMove);
            editorCanvas.removeEventListener("touchend", onEditorMouseUp);
          }
          // æç”»æ›´æ–°ï¼ˆæ ã‚’æ¶ˆã™ãŸã‚ï¼‰
          drawEditorFrame();
        }

        // â˜…è¿½åŠ : ãƒã‚¹ã‚¯æ“ä½œé–¢æ•°
        function undoEditorMask() {
          if (editorMaskAreas.length > 0) {
            editorMaskAreas.pop();
            drawEditorFrame();
          }
        }
        function clearEditorMasks() {
          if (confirm("ã™ã¹ã¦ã®ãƒã‚¹ã‚¯ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            editorMaskAreas = [];
            drawEditorFrame();
          }
        }

        function onEditorMouseDown(e) {
          if (!isEditorMaskSelecting) return;
          if (e.cancelable && e.type.startsWith('touch')) e.preventDefault();

          editorDragStart = getEditorPos(e);
          currentEditorPos = editorDragStart;
        }

        function onEditorMouseMove(e) {
          if (!isEditorMaskSelecting || !editorDragStart) return;
          if (e.cancelable && e.type.startsWith('touch')) e.preventDefault();

          currentEditorPos = getEditorPos(e);
          drawEditorFrame();
        }

        function onEditorMouseUp(e) {
          if (!isEditorMaskSelecting || !editorDragStart) return;

          const x = Math.min(editorDragStart.x, currentEditorPos.x);
          const y = Math.min(editorDragStart.y, currentEditorPos.y);
          const w = Math.abs(currentEditorPos.x - editorDragStart.x);
          const h = Math.abs(currentEditorPos.y - editorDragStart.y);

          // â˜…å¤‰æ›´: ãƒã‚¹ã‚¯ã‚’é…åˆ—ã«è¿½åŠ 
          if (w > 10 && h > 10) {
            editorMaskAreas.push({ x, y, w, h });
          }

          editorDragStart = null;
          // é€£ç¶šã§æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãƒ¢ãƒ¼ãƒ‰ã¯ç¶­æŒã™ã‚‹ï¼ˆã¾ãŸã¯å¥½ã¿ã§toggleEditorMaskMode()ã‚’å‘¼ã‚“ã§çµ‚äº†ã•ã›ã‚‹ï¼‰
          drawEditorFrame();
        }

        // 5. æ›¸ãå‡ºã— (MediaRecorder) - ğŸ”Š éŸ³å£°çµåˆç‰ˆ
        async function startEditorExport() {
          if (isEditorExporting) return;
          isEditorExporting = true;

          const btn = document.getElementById("btn-editor-export");
          const status = document.getElementById("editor-status");
          const start = parseFloat(document.getElementById("trim-start").value);
          const end = parseFloat(document.getElementById("trim-end").value);
          const duration = end - start;

          if (duration <= 0) {
            alert("çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„ã€‚");
            isEditorExporting = false;
            return;
          }

          btn.disabled = true;
          btn.style.background = "#ccc";
          status.textContent = "â³ éŸ³å£°ã‚’å‡¦ç†ä¸­...";

          // --- ğŸ”Š éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã®å–å¾—ã¨ãƒŸãƒƒã‚¯ã‚¹ ---
          let exportStream;
          try {
            // A. ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ã®æ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒ  (30fps)
            const videoStream = editorCanvas.captureStream(30);
            
            // B. å…ƒã®å‹•ç”»ã‹ã‚‰ã®éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯å–å¾—
            // captureStreamãŒä½¿ãˆãªã„ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariç­‰ï¼‰ã¸ã®å¯¾ç­–ã‚’å«ã‚ãŸå‡¦ç†
            let audioTracks = [];
            if (editorVideo.captureStream) {
              audioTracks = editorVideo.captureStream().getAudioTracks();
            } else if (editorVideo.mozCaptureStream) {
              audioTracks = editorVideo.mozCaptureStream().getAudioTracks();
            }

            // æ˜ åƒã¨éŸ³å£°ã‚’çµåˆ
            if (audioTracks.length > 0) {
              exportStream = new MediaStream([
                ...videoStream.getVideoTracks(),
                audioTracks[0]
              ]);
            } else {
              exportStream = videoStream;
              console.warn("éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
          } catch (e) {
            console.error("Stream capture error:", e);
            alert("éŒ²ç”»ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            isEditorExporting = false;
            btn.disabled = false;
            return;
          }

          // éŒ²ç”»è¨­å®š (é«˜ç”»è³ªè¨­å®š)
          const recorder = new MediaRecorder(exportStream, { 
            mimeType: 'video/webm;codecs=vp9,opus', // opusï¼ˆéŸ³å£°ï¼‰ã‚’è¿½åŠ 
            videoBitsPerSecond: 5000000 // 5Mbps
          });
          
          const chunks = [];
          recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const now = new Date();
            const fname = `Edited_${now.getHours()}${now.getMinutes()}${now.getSeconds()}.webm`;

            if (confirm("å‹•ç”»ãŒå®Œæˆã—ã¾ã—ãŸï¼\nã‚¢ãƒ—ãƒªå†…ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n(ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)")) {
              if (typeof saveVideoToDB === 'function') {
                saveVideoToDB(blob, fname);
              } else {
                downloadBlob(blob, fname);
              }
            } else {
              downloadBlob(blob, fname);
            }

            status.textContent = "âœ… å®Œäº†";
            isEditorExporting = false;
            btn.disabled = false;
            btn.style.background = "#d32f2f";
            drawEditorFrame();
          };

          function downloadBlob(blob, name) {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
          }

          // éŒ²ç”»ãƒ—ãƒ­ã‚»ã‚¹
          editorVideo.muted = false; // ğŸ”Š æ›¸ãå‡ºã—ä¸­ã‚‚éŸ³ã‚’å‡ºã™ï¼ˆå†…éƒ¨å‡¦ç†ç”¨ï¼‰
          editorVideo.currentTime = start;
          
          const onSeekedForRec = () => {
            editorVideo.removeEventListener('seeked', onSeekedForRec);
            recorder.start();
            editorVideo.play();
            recordLoop();
          };
          editorVideo.addEventListener('seeked', onSeekedForRec);
          editorVideo.currentTime = start;

          function recordLoop() {
            if (!isEditorExporting) return;
            drawEditorFrame();

            if (editorVideo.currentTime >= end || editorVideo.ended) {
              editorVideo.pause();
              recorder.stop();
              return;
            }

            const progress = Math.min(100, ((editorVideo.currentTime - start) / duration * 100)).toFixed(0);
            status.textContent = `â³ ä¿å­˜ä¸­... ${progress}%`;
            requestAnimationFrame(recordLoop);
          }
        }

        // ==========================================
        // ğŸ–¼ï¸ ã‚µãƒ ãƒã‚¤ãƒ«ä½œæˆæ©Ÿèƒ½
        // ==========================================
        const thumbCanvas = document.getElementById("thumbnail-canvas");
        const thumbCtx = thumbCanvas ? thumbCanvas.getContext("2d") : null;
        let thumbBgImage = null;

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆåˆæœŸå€¤ã¯ç©ºã«ã—ã¾ã™ï¼‰
        let textLayers = [];

        // åˆæœŸåŒ–
        if (thumbCtx) {
          thumbCtx.fillStyle = "#000";
          thumbCtx.fillRect(0, 0, 1280, 720);
          thumbCtx.fillStyle = "#555";
          thumbCtx.font = "bold 30px sans-serif";
          thumbCtx.textAlign = "center";
          thumbCtx.fillText("Image Preview Area", 640, 360);
          renderTextLayersUI();
        }

        // 1. ã‚·ãƒ¼ãƒ³å–ã‚Šè¾¼ã¿
        function captureCurrentFrame() {
          if (!editorVideo || !thumbCtx) return;

          thumbCtx.filter = "none";
          thumbCtx.fillStyle = "#000";
          thumbCtx.fillRect(0, 0, 1280, 720);

          const vw = editorVideo.videoWidth;
          const vh = editorVideo.videoHeight;
          const scale = Math.max(1280 / vw, 720 / vh);
          const drawW = vw * scale;
          const drawH = vh * scale;
          const offsetX = (1280 - drawW) / 2;
          const offsetY = (720 - drawH) / 2;

          thumbCtx.drawImage(editorVideo, offsetX, offsetY, drawW, drawH);
          thumbBgImage = thumbCtx.getImageData(0, 0, 1280, 720);

          updateThumbnail();

          // åˆã‚ã¦ãªã‚‰æ–‡å­—ã‚’1ã¤è‡ªå‹•è¿½åŠ ã—ã¦ã‚ã’ã‚‹ã¨è¦ªåˆ‡
          if (textLayers.length === 0) {
            addTextLayer('main');
            alert("ã‚·ãƒ¼ãƒ³ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸï¼\nå³å´ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ãªãŒã‚‰ã€å·¦å´ã®ãƒ‘ãƒãƒ«ã§æ–‡å­—ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚");
          } else {
            alert("ã‚·ãƒ¼ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
          }
        }

        // 2. ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ
        function addTextLayer(type) {
          const newLayer = {
            type: type,
            text: type === 'main' ? "ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›" : "ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ",
            x: 50, y: type === 'main' ? 50 : 80,
            size: type === 'main' ? 100 : 60,
            color: type === 'main' ? "#ffffff" : "#ffff00",
            subColor: type === 'main' ? "#ff0000" : "#000000",
            width: type === 'main' ? 20 : 0,
            rotate: 0,
            shadow: type === 'main' ? true : false
          };
          textLayers.push(newLayer);
          renderTextLayersUI();
          updateThumbnail();

          // â˜…æ”¹è‰¯: è¿½åŠ ã—ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸ç§»å‹•
          const scrollArea = document.getElementById("text-layers-scroll-area");
          if (scrollArea) {
            setTimeout(() => {
              scrollArea.scrollTop = scrollArea.scrollHeight;
            }, 50);
          }
        }

        function removeTextLayer(index) {
          if (confirm("ã“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            textLayers.splice(index, 1);
            renderTextLayersUI();
            updateThumbnail();
          }
        }

        function updateLayerParam(index, key, value) {
          if (['x', 'y', 'size', 'width', 'rotate'].includes(key)) {
            textLayers[index][key] = parseInt(value);
          } else if (key === 'shadow') {
            textLayers[index][key] = value;
          } else {
            textLayers[index][key] = value;
          }
          updateThumbnail();
        }

        // 3. UIç”Ÿæˆ
        function renderTextLayersUI() {
          const container = document.getElementById("text-layers-container");
          const emptyMsg = document.getElementById("empty-msg");
          if (!container) return;

          container.innerHTML = "";

          if (textLayers.length === 0) {
            if (emptyMsg) emptyMsg.style.display = "block";
            return;
          }
          if (emptyMsg) emptyMsg.style.display = "none";

          textLayers.forEach((layer, i) => {
            const isMain = layer.type === 'main';
            const title = isMain ? `ğŸ“ ãƒ¡ã‚¤ãƒ³ ${i + 1}` : `ğŸ“ ã‚µãƒ– ${i + 1}`;
            const headerColor = isMain ? "#d84315" : "#1565c0";
            const subLabel = isMain ? "ç¸è‰²" : "èƒŒæ™¯è‰²";
            const widthControl = isMain
              ? `<label>å¤ªã• <input type="range" min="0" max="40" value="${layer.width}" oninput="updateLayerParam(${i}, 'width', this.value)"></label>`
              : ``;

            const html = `
          <div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #ccc; border-left:5px solid ${headerColor}; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <div style="font-weight:bold; color:${headerColor}; font-size:13px;">${title}</div>
                <button onclick="removeTextLayer(${i})" style="background:#eee; color:#333; border:none; border-radius:4px; padding:2px 8px; font-size:11px; cursor:pointer;">å‰Šé™¤ ğŸ—‘ï¸</button>
            </div>
            <input type="text" value="${layer.text}" oninput="updateLayerParam(${i}, 'text', this.value)" style="width:100%; padding:5px; margin-bottom:5px; box-sizing:border-box; border:1px solid #ddd;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:11px;">
              <label>æ–‡å­—è‰² <input type="color" value="${layer.color}" oninput="updateLayerParam(${i}, 'color', this.value)"></label>
              <label>${subLabel} <input type="color" value="${layer.subColor}" oninput="updateLayerParam(${i}, 'subColor', this.value)"></label>
              ${widthControl}
              <label>ã‚µã‚¤ã‚º <input type="range" min="10" max="200" value="${layer.size}" oninput="updateLayerParam(${i}, 'size', this.value)"></label>
              <label>å›è»¢ <input type="range" min="-45" max="45" value="${layer.rotate}" oninput="updateLayerParam(${i}, 'rotate', this.value)"></label>
              ${isMain ? `<label>å½± <input type="checkbox" ${layer.shadow ? "checked" : ""} onchange="updateLayerParam(${i}, 'shadow', this.checked)"></label>` : ""}
            </div>
            <div style="margin-top:5px; font-size:11px;">
              ä½ç½®: <br>
              æ¨ª <input type="range" min="0" max="100" value="${layer.x}" oninput="updateLayerParam(${i}, 'x', this.value)" style="width:40%;">
              ç¸¦ <input type="range" min="0" max="100" value="${layer.y}" oninput="updateLayerParam(${i}, 'y', this.value)" style="width:40%;">
            </div>
          </div>
        `;
            container.insertAdjacentHTML('beforeend', html);
          });
        }

        // 4. æç”»å‡¦ç† (å…¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼†å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼é©ç”¨)
        function updateThumbnail() {
          if (!thumbCtx) return;

          // --- A. èƒŒæ™¯æç”» & CSSãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---
          let filters = [];
          if (document.getElementById("eff-blur").checked) filters.push("blur(10px)");
          if (document.getElementById("eff-gray").checked) filters.push("grayscale(100%)");
          if (document.getElementById("eff-sepia").checked) filters.push("sepia(100%)"); // æ–°è¦
          if (document.getElementById("eff-vivid").checked) filters.push("saturate(200%) contrast(110%)");

          thumbCtx.save();
          thumbCtx.filter = filters.length > 0 ? filters.join(" ") : "none";

          if (thumbBgImage) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 1280; tempCanvas.height = 720;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.putImageData(thumbBgImage, 0, 0);
            thumbCtx.drawImage(tempCanvas, 0, 0);
          } else {
            thumbCtx.fillStyle = "#000";
            thumbCtx.fillRect(0, 0, 1280, 720);
          }
          thumbCtx.restore(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤

          // --- A'. ç‰¹æ®ŠèƒŒæ™¯åŠ å·¥ (ã‚°ãƒªãƒƒãƒ) ---
          if (document.getElementById("eff-glitch").checked) {
            drawGlitchEffect(thumbCtx);
          }

          // --- B. ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ---
          if (document.getElementById("eff-dim").checked) {
            thumbCtx.fillStyle = "rgba(0, 0, 0, 0.5)";
            thumbCtx.fillRect(0, 0, 1280, 720);
          }
          if (document.getElementById("eff-vs").checked) drawVSEffect(thumbCtx);
          if (document.getElementById("eff-line").checked) drawFocusLines(thumbCtx);
          if (document.getElementById("eff-speed").checked) drawSpeedLines(thumbCtx); // æ–°è¦
          if (document.getElementById("eff-scan").checked) drawScanlines(thumbCtx);   // æ–°è¦

          if (document.getElementById("eff-vignette").checked) {
            const grad = thumbCtx.createRadialGradient(640, 360, 300, 640, 360, 800);
            grad.addColorStop(0, "rgba(0,0,0,0)");
            grad.addColorStop(1, "rgba(0,0,0,0.85)");
            thumbCtx.fillStyle = grad;
            thumbCtx.fillRect(0, 0, 1280, 720);
          }
          if (document.getElementById("eff-border").checked) {
            thumbCtx.lineWidth = 40;
            thumbCtx.strokeStyle = "#d32f2f";
            thumbCtx.strokeRect(0, 0, 1280, 720);
          }

          // --- C. ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼æç”» ---
          textLayers.forEach(layer => {
            // ... (æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆæç”»ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾) ...
            const x = (layer.x / 100) * 1280;
            const y = (layer.y / 100) * 720;

            thumbCtx.save();
            thumbCtx.translate(x, y);
            thumbCtx.rotate(layer.rotate * Math.PI / 180);

            const weight = layer.type === 'main' ? "900" : "bold";
            thumbCtx.font = `${weight} ${layer.size}px sans-serif`;
            thumbCtx.textAlign = "center";
            thumbCtx.textBaseline = "middle";
            thumbCtx.lineJoin = "round";

            if (layer.type === 'main') {
              if (layer.shadow) {
                thumbCtx.shadowColor = "rgba(0,0,0,0.8)";
                thumbCtx.shadowBlur = 20;
                thumbCtx.shadowOffsetX = 8;
                thumbCtx.shadowOffsetY = 8;
              }
              if (layer.width > 0) {
                thumbCtx.lineWidth = layer.width;
                thumbCtx.strokeStyle = layer.subColor;
                thumbCtx.strokeText(layer.text, 0, 0);
              }
              thumbCtx.shadowColor = "transparent";
              thumbCtx.fillStyle = layer.color;
              thumbCtx.fillText(layer.text, 0, 0);
            } else {
              const m = thumbCtx.measureText(layer.text);
              const padW = 20;
              thumbCtx.fillStyle = layer.subColor;
              thumbCtx.transform(1, 0, -0.2, 1, 0, 0);
              thumbCtx.fillRect(-m.width / 2 - padW, -layer.size / 2, m.width + padW * 2, layer.size);
              thumbCtx.transform(1, 0, 0.2, 1, 0, 0);
              thumbCtx.fillStyle = layer.color;
              thumbCtx.fillText(layer.text, 0, 5);
            }
            thumbCtx.restore();
          });
        }

        // é›†ä¸­ç·š
        function drawFocusLines(ctx) {
          ctx.save();
          ctx.translate(640, 360);
          ctx.strokeStyle = "rgba(255, 255, 255, 0.7)";
          ctx.lineWidth = 5;
          for (let i = 0; i < 80; i++) {
            ctx.rotate(Math.PI / 40);
            ctx.beginPath();
            const startR = 400 + Math.random() * 50;
            ctx.moveTo(startR, 0);
            ctx.lineTo(900, 0);
            ctx.stroke();
          }
          ctx.restore();
        }

        // 2. ã‚¹ãƒ”ãƒ¼ãƒ‰ç·š (æ¨ªæ–¹å‘ãƒ»ç–¾èµ°æ„Ÿ)
        function drawSpeedLines(ctx) {
          ctx.save();
          ctx.strokeStyle = "rgba(255, 255, 255, 0.5)";
          ctx.lineWidth = 3;
          for (let i = 0; i < 50; i++) {
            const y = Math.random() * 720;
            const len = 200 + Math.random() * 300;
            const x = Math.random() * 1280;

            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + len, y);
            ctx.stroke();
          }
          ctx.restore();
        }

        // 3. ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ (TVé¢¨)
        function drawScanlines(ctx) {
          ctx.save();
          ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
          for (let y = 0; y < 720; y += 4) {
            ctx.fillRect(0, y, 1280, 2);
          }
          ctx.restore();
        }

        // 4. ã‚°ãƒªãƒƒãƒ (è‰²ã‚ºãƒ¬) åŠ¹æœ
        function drawGlitchEffect(ctx) {
          // ç°¡æ˜“çš„ãªRGBãšã‚‰ã—
          // ç¾åœ¨ã®Canvasã®å†…å®¹ã‚’ä¸€åº¦å–å¾—
          const imgData = ctx.getImageData(0, 0, 1280, 720);

          // èµ¤ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å·¦ã«ãšã‚‰ã—ã€é’ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å³ã«ãšã‚‰ã™
          // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Canvasã‚’ä½¿ã†ã¨åˆæˆãƒ¢ãƒ¼ãƒ‰ã§ç°¡å˜ã«ã§ãã‚‹
          const tempC = document.createElement('canvas');
          tempC.width = 1280; tempC.height = 720;
          const tCtx = tempC.getContext('2d');
          tCtx.putImageData(imgData, 0, 0);

          ctx.save();
          ctx.globalCompositeOperation = "lighter"; // åŠ ç®—åˆæˆ

          // å…ƒç”»åƒã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢ï¼ˆé»’ã«ï¼‰
          ctx.fillStyle = "#000";
          ctx.fillRect(0, 0, 1280, 720);

          // èµ¤æˆåˆ†
          ctx.globalAlpha = 0.7;
          ctx.drawImage(tempC, -15, 0); // å·¦ã«ãšã‚‰ã™

          // é’ç·‘æˆåˆ†
          ctx.globalAlpha = 0.7;
          ctx.drawImage(tempC, 15, 0);  // å³ã«ãšã‚‰ã™

          ctx.restore();
        }

        // VSãƒ¢ãƒ¼ãƒ‰
        function drawVSEffect(ctx) {
          const w = 1280, h = 720;
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(w / 2 - 100, 0);
          ctx.lineTo(w / 2 + 50, h / 2);
          ctx.lineTo(w / 2 - 100, h);
          ctx.lineTo(w / 2 + 20, h);
          ctx.lineTo(w / 2 + 170, h / 2);
          ctx.lineTo(w / 2 + 20, 0);
          ctx.closePath();
          const grad = ctx.createLinearGradient(w / 2 - 100, 0, w / 2 + 100, h);
          grad.addColorStop(0, "#ffeb3b");
          grad.addColorStop(0.5, "#ff9800");
          grad.addColorStop(1, "#f44336");
          ctx.fillStyle = grad;
          ctx.shadowColor = "#ff5722";
          ctx.shadowBlur = 30;
          ctx.fill();
          ctx.shadowBlur = 0;
          ctx.fillStyle = "#fff";
          ctx.font = "italic 900 120px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.strokeStyle = "#000";
          ctx.lineWidth = 8;
          const cx = w / 2 + 30;
          const cy = h / 2;
          ctx.strokeText("VS", cx, cy);
          ctx.fillText("VS", cx, cy);
          ctx.restore();
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadThumbnail() {
          const link = document.createElement("a");
          link.href = thumbCanvas.toDataURL("image/jpeg", 0.9);
          link.download = `thumbnail_${Date.now()}.jpg`;
          link.click();
        }

        // ==========================================
        // ğŸ’ª ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ±åˆæ©Ÿèƒ½
        //    (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç®¡ç† + ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿é€£æº)
        // ==========================================

        // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨å¤‰æ•° ---
        const WRIST_STORAGE_KEY = "smartCoachWristData";
        let wristCurrentDate = new Date(); // è¡¨ç¤ºä¸­ã®å¹´æœˆ

        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ : { currentUser: "åå‰", records: { "åå‰": ["2025-1-1", ...], "å¼Ÿ": [] } }
        let wristData = {
          currentUser: "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼",
          records: { "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": [] }
        };

        // --- ãƒ‡ãƒ¼ã‚¿é€£æºç”¨å¤‰æ•° ---
        let currentWristVideoUrl = "";     // å‹•ç”»URLä¿æŒç”¨

        // 1. åˆæœŸåŒ– (ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚)
        document.addEventListener("DOMContentLoaded", () => {
          // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
          loadWristData();

          // UIã®åˆæœŸåŒ–
          updateWristUserSelectUI();
          renderWristCalendar();

          // ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®åæ˜  (å°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ)
          setTimeout(updateWristContentFromSheet, 1000);
        });

        // ==========================================
        // A. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ (æ–°è¦è¿½åŠ )
        // ==========================================

        function updateWristUserSelectUI() {
          const select = document.getElementById("wrist-user-select");
          if (!select) return;

          select.innerHTML = "";
          Object.keys(wristData.records).forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (name === wristData.currentUser) opt.selected = true;
            select.appendChild(opt);
          });
        }

        function switchWristUser() {
          const select = document.getElementById("wrist-user-select");
          wristData.currentUser = select.value;
          saveWristData();
          renderWristCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»
        }

        function addWristUser() {
          const name = prompt("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šå¼Ÿã€å¦¹ï¼‰");
          if (name && name.trim() !== "") {
            if (wristData.records[name]) {
              alert("ãã®åå‰ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
              return;
            }
            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
            wristData.records[name] = [];
            wristData.currentUser = name;
            saveWristData();
            updateWristUserSelectUI();
            renderWristCalendar();
            alert(`ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
          }
        }

        function deleteWristUser() {
          const target = wristData.currentUser;
          const users = Object.keys(wristData.records);

          if (users.length <= 1) {
            alert("æœ€å¾Œã®1äººã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
            return;
          }

          if (confirm(`ç¾åœ¨é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${target}ã€ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
            delete wristData.records[target];
            // åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
            wristData.currentUser = Object.keys(wristData.records)[0];
            saveWristData();
            updateWristUserSelectUI();
            renderWristCalendar();
          }
        }

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿæ–½æ—¥ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function getCurrentUserDates() {
          const user = wristData.currentUser;
          if (!wristData.records[user]) {
            wristData.records[user] = []; // å®‰å…¨ç­–
          }
          return wristData.records[user];
        }

        // ==========================================
        // B. ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿é€£æºæ©Ÿèƒ½ (å‹•ç”»ãƒ»èª¬æ˜ã®æ›´æ–°)
        // ==========================================

        function updateWristContentFromSheet() {
          // ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
          if (typeof sheetData === 'undefined' || !sheetData.length) return;

          // 1. ã€Œè£œå¼·ã€ã‚«ãƒ†ã‚´ãƒªã®ä¸­ã‹ã‚‰ã€Œãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«ã€ã‚’å«ã‚€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ¢ã™
          const targetMenu = sheetData.find(m =>
            (m.ã‚«ãƒ†ã‚´ãƒª === "è£œå¼·" || m.category === "Strength") &&
            (m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å && m.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å.includes("ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«"))
          );

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          let displayData = {
            name: "ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«",
            desc: "æ‰‹é¦–ã®å›å†…ãƒ»å›å¤–é‹å‹•ã‚’é›†ä¸­çš„ã«å¼·åŒ–ã—ã¾ã™ã€‚\nç›®å®‰: 1æ—¥ å·¦å³å„30å› Ã— 3ã‚»ãƒƒãƒˆ\nâ€»ãƒ©ã‚±ãƒƒãƒˆã‚«ãƒãƒ¼ã‚’ä»˜ã‘ã‚‹ã¨åŠ¹æœçš„ã§ã™ã€‚",
            url: "https://youtu.be/NSLZMGqPgB0",
            img: ""
          };

          // ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä¸Šæ›¸ã
          if (targetMenu) {
            displayData.name = targetMenu.ãƒ¡ãƒ‹ãƒ¥ãƒ¼å;
            displayData.desc = targetMenu.èª¬æ˜ || displayData.desc;
            displayData.url = targetMenu["YouTube URL"] || displayData.url;
            displayData.img = targetMenu["ç”»åƒURL"] || "";
          }

          // URLã‹ã‚‰å‹•ç”»IDã‚’æŠ½å‡ºã—ã¦ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ä½œã‚‹
          let videoId = "";
          if (displayData.url) {
            const match = displayData.url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|v\/|embed\/|shorts\/))([^#\?&]+)/);
            if (match && match[1]) {
              videoId = match[1];
            }
          }

          // ç”»åƒãŒãªã„å ´åˆã€YouTubeã‚µãƒ ãƒã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆ
          if (!displayData.img && videoId) {
            displayData.img = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
          }

          currentWristVideoUrl = displayData.url;

          // --- DOMè¦ç´ ã®æ›´æ–° ---
          const elTitle = document.getElementById("wrist-title");
          const elDesc = document.getElementById("wrist-desc");
          const elImg = document.getElementById("wrist-img");
          const elLink = document.getElementById("wrist-link");

          if (elTitle) elTitle.textContent = "ğŸ“‹ " + displayData.name;
          if (elDesc) elDesc.textContent = displayData.desc;

          if (elImg) {
            elImg.src = displayData.img || "https://via.placeholder.com/130x80?text=No+Video";
          }

          if (elLink) {
            elLink.href = displayData.url;
            elLink.style.display = displayData.url ? "inline-flex" : "none";
          }
        }

        // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ
        function openWristVideo() {
          if (currentWristVideoUrl) {
            window.open(currentWristVideoUrl, '_blank');
          } else {
            alert("å‹•ç”»URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã‚·ãƒ¼ãƒˆã«ã€ŒYouTube URLã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          }
        }

        // ==========================================
        // C. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç®¡ç†æ©Ÿèƒ½ (LocalStorage)
        // ==========================================

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ—§å½¢å¼ã‹ã‚‰ã®ç§»è¡Œå¯¾å¿œï¼‰
        function loadWristData() {
          const json = localStorage.getItem(WRIST_STORAGE_KEY);

          if (json) {
            const parsed = JSON.parse(json);

            // â˜…é‡è¦: å¤ã„å½¢å¼ï¼ˆãŸã ã®é…åˆ—ï¼‰ã ã£ãŸå ´åˆã®ç§»è¡Œå‡¦ç†
            if (Array.isArray(parsed)) {
              console.log("æ—§ãƒ‡ãƒ¼ã‚¿ã‚’æ–°å½¢å¼ã«ç§»è¡Œã—ã¾ã™...");
              wristData = {
                currentUser: "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                records: {
                  "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": parsed // æ—§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‰²ã‚Šå½“ã¦
                }
              };
              saveWristData(); // æ–°å½¢å¼ã§ä¿å­˜ã—ç›´ã™
            } else {
              // æ–°å½¢å¼ãªã‚‰ãã®ã¾ã¾èª­ã¿è¾¼ã¿
              wristData = parsed;
              // ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆé˜²æ­¢
              if (!wristData.records) wristData.records = { "Main": [] };
              if (!wristData.currentUser) wristData.currentUser = Object.keys(wristData.records)[0];
            }
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰
            wristData = {
              currentUser: "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼",
              records: { "ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼": [] }
            };
          }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveWristData() {
          localStorage.setItem(WRIST_STORAGE_KEY, JSON.stringify(wristData));
        }

        // ã€Œä»Šæ—¥å®Ÿæ–½ã—ãŸã€ãƒœã‚¿ãƒ³å‡¦ç†
        function markWristDrillDone() {
          const today = new Date();
          const dateStr = getWristDateStr(today);
          const doneDates = getCurrentUserDates();

          // ã™ã§ã«è¨˜éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
          if (!doneDates.includes(dateStr)) {
            doneDates.push(dateStr);
            saveWristData();

            // æ¼”å‡º
            if (typeof playSportsDrum === 'function') playSportsDrum();

            const msgEl = document.getElementById("wrist-status-msg");
            if (msgEl) msgEl.textContent = `ğŸ‰ ${wristData.currentUser}ã•ã‚“ã®è¨˜éŒ²å®Œäº†ï¼`;
            setTimeout(() => { if (msgEl) msgEl.textContent = ""; }, 3000);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»
            renderWristCalendar();
          } else {
            alert(`${wristData.currentUser}ã•ã‚“ã¯ã€æœ¬æ—¥ã¯ã™ã§ã«è¨˜éŒ²æ¸ˆã¿ã§ã™ï¼`);
          }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ãƒ­ã‚¸ãƒƒã‚¯
        function renderWristCalendar() {
          const grid = document.getElementById("wrist-cal-grid");
          const title = document.getElementById("wrist-cal-title");
          const countEl = document.getElementById("wrist-monthly-count");

          if (!grid || !title) return;

          // ç¾åœ¨é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨˜éŒ²ã‚’ä½¿ç”¨
          const doneDates = getCurrentUserDates();

          // è¡¨ç¤ºä¸­ã®å¹´æœˆ
          const year = wristCurrentDate.getFullYear();
          const month = wristCurrentDate.getMonth();

          title.textContent = `${year}å¹´ ${month + 1}æœˆ`;
          grid.innerHTML = "";

          const firstDay = new Date(year, month, 1).getDay();
          const lastDate = new Date(year, month + 1, 0).getDate();
          const todayStr = getWristDateStr(new Date());
          let monthlyCount = 0;

          // ç©ºç™½ã‚»ãƒ«
          for (let i = 0; i < firstDay; i++) {
            const cell = document.createElement("div");
            grid.appendChild(cell);
          }

          // æ—¥ä»˜ã‚»ãƒ«ç”Ÿæˆ
          for (let d = 1; d <= lastDate; d++) {
            const cell = document.createElement("div");
            const dateObj = new Date(year, month, d);
            const dateStr = getWristDateStr(dateObj);

            cell.textContent = d;
            cell.style.cssText = `
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 50%; 
            font-size: 14px;
            position: relative;
            background: #fff;
            border: 1px solid #e0f2f1;
            color: #333;
            transition: all 0.2s;
        `;

            // ä»Šæ—¥ã®æ ç·š (Tealè‰²)
            if (dateStr === todayStr) {
              cell.style.border = "2px solid #00897b";
              cell.style.fontWeight = "bold";
            }

            // å®Ÿæ–½æ¸ˆã¿ (TealèƒŒæ™¯)
            if (doneDates.includes(dateStr)) {
              cell.style.background = "#b2dfdb"; // è–„ã„é’ç·‘
              cell.style.color = "#004d40";      // æ¿ƒã„é’ç·‘æ–‡å­—
              cell.style.fontWeight = "bold";
              cell.innerHTML = `${d}<span style="position:absolute; bottom:2px; font-size:10px;">ğŸ’ª</span>`; // ã‚¢ã‚¤ã‚³ãƒ³
              monthlyCount++;
            }

            cell.onclick = () => toggleWristDate(dateStr);
            cell.style.cursor = "pointer";

            grid.appendChild(cell);
          }

          if (countEl) countEl.textContent = monthlyCount;

          // ãƒœã‚¿ãƒ³ã®è‰²æ›´æ–°
          const btn = document.getElementById("btn-wrist-done");
          if (btn) {
            if (doneDates.includes(todayStr)) {
              btn.textContent = `${wristData.currentUser}: æœ¬æ—¥å®Œäº† âœ…`;
              btn.style.background = "#90a4ae"; // ã‚°ãƒ¬ãƒ¼
              btn.disabled = true;
            } else {
              btn.innerHTML = `<span>âœ…</span> ${wristData.currentUser}: ä»Šæ—¥å®Ÿæ–½ã—ãŸï¼`;
              btn.style.background = "#00897b"; // Teal
              btn.disabled = false;
            }
          }
        }

        // æ—¥ä»˜ã®ä¿®æ­£æ©Ÿèƒ½ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ON/OFFï¼‰
        function toggleWristDate(dateStr) {
          const doneDates = getCurrentUserDates();
          if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${wristData.currentUser}ã€ã®\n${dateStr} ã®è¨˜éŒ²ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
            if (doneDates.includes(dateStr)) {
              // å‰Šé™¤
              const idx = doneDates.indexOf(dateStr);
              if (idx > -1) doneDates.splice(idx, 1);
            } else {
              // è¿½åŠ 
              doneDates.push(dateStr);
            }
            saveWristData();
            renderWristCalendar();
          }
        }

        // æœˆã®ç§»å‹•
        function changeWristMonth(diff) {
          wristCurrentDate.setMonth(wristCurrentDate.getMonth() + diff);
          renderWristCalendar();
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šæ—¥ä»˜æ–‡å­—åˆ—ç”Ÿæˆ
        function getWristDateStr(date) {
          return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
        }

        // ==========================================
        // âœï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´æ©Ÿèƒ½ (æ–°è¦è¿½åŠ )
        // ==========================================

        // 1. ãƒªã‚¹ãƒˆãƒ‘ãƒ¯ãƒ¼ãƒ‰ãƒªãƒ«ã®åå‰å¤‰æ›´
        function renameWristUser() {
          const currentName = wristData.currentUser;
          // ç¾åœ¨ã®åå‰ã‚’åˆæœŸå€¤ã«ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
          const newName = prompt(`ã€Œ${currentName}ã€ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, currentName);

          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„ç©ºæ¬„ã€å¤‰æ›´ãªã—ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (!newName || newName.trim() === "" || newName === currentName) return;

          // é‡è¤‡ãƒã‚§ãƒƒã‚¯
          if (wristData.records[newName]) {
            alert("ãã®åå‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          if (confirm(`ã€Œ${currentName}ã€ã‚’ã€Œ${newName}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
            // ãƒ‡ãƒ¼ã‚¿ã®å¼•ç¶™ãï¼ˆæ–°ã—ã„åå‰ã®ã‚­ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼‰
            wristData.records[newName] = wristData.records[currentName];
            // å¤ã„åå‰ã®ã‚­ãƒ¼ã‚’å‰Šé™¤
            delete wristData.records[currentName];
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°
            wristData.currentUser = newName;

            // ä¿å­˜ã¨ç”»é¢æ›´æ–°
            saveWristData();
            updateWristUserSelectUI();
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãªã©ã¯ãƒ‡ãƒ¼ã‚¿å‚ç…§ãŒå¤‰ã‚ã‚‹ã ã‘ãªã®ã§å†æç”»ä¸è¦ã§ã™ãŒã€å¿µã®ãŸã‚
            renderWristCalendar();

            alert("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
          }
        }

        // 2. æ—¥æœ¬ä¸€å‘¨ã®æ—…ã®åå‰å¤‰æ›´
        function renameDailyUser() {
          const currentName = dailyUserData.currentUser;
          const newName = prompt(`ã€Œ${currentName}ã€ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, currentName);

          if (!newName || newName.trim() === "" || newName === currentName) return;

          if (dailyUserData.records[newName]) {
            alert("ãã®åå‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }

          if (confirm(`ã€Œ${currentName}ã€ã‚’ã€Œ${newName}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
            // ãƒ‡ãƒ¼ã‚¿ã®å¼•ç¶™ã
            dailyUserData.records[newName] = dailyUserData.records[currentName];
            // å¤ã„ã‚­ãƒ¼ã‚’å‰Šé™¤
            delete dailyUserData.records[currentName];
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
            dailyUserData.currentUser = newName;

            // ä¿å­˜ã¨ç”»é¢æ›´æ–°
            saveGlobalDailyData();
            updateDailyUserSelectUI();

            // UIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç­‰ã®æ›´æ–°
            updateDailyUI();

            alert("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
          }
        }

        // ==========================================
        // ğŸ§© ãƒ•ã‚©ãƒˆã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥æ©Ÿèƒ½ (æ–‡å­—ç§»å‹•ãƒ»å®Œå…¨ç‰ˆ)
        // ==========================================

        // --- å¤‰æ•°å®šç¾© ---
        let collageLayers = []; // å†™çœŸ: { img, x, y, w, h }
        let collageDecorations = []; // æ–‡å­—ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—: { text, x, y, size, color, stroke, font, shadow }
        let swapSelectedIndex = -1;  // â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼ˆå†™çœŸã®å…¥ã‚Œæ›¿ãˆç”¨ï¼‰
        let selectedDecoIndex = -1;  // é¸æŠä¸­ã®æ–‡å­—
        let isCollageDragging = false;
        let isCollageResizing = false;
        let isDecoDragging = false; // æ–‡å­—ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãƒ•ãƒ©ã‚°
        let collageDragStart = { x: 0, y: 0 };
        let currentLayoutMode = ""; // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰è¨˜æ†¶ç”¨

        // --- 1. ç”»åƒèª­ã¿è¾¼ã¿ ---
        function loadCollageImages(input) {
          if (!input.files || input.files.length === 0) return;

          const files = Array.from(input.files);
          let loadedCount = 0;
          let tempImages = [];

          // UIè¡¨ç¤º
          document.getElementById("collage-controls").style.display = "block";
          document.getElementById("collage-placeholder").style.display = "none";
          const canvas = document.getElementById("collage-canvas");
          canvas.style.display = "block";

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
          canvas.removeEventListener("mousedown", onCollageDown);
          canvas.removeEventListener("mousemove", onCollageMove);
          canvas.removeEventListener("mouseup", onCollageUp);
          canvas.removeEventListener("touchstart", onCollageDown);
          canvas.removeEventListener("touchmove", onCollageMove);
          canvas.removeEventListener("touchend", onCollageUp);

          canvas.addEventListener("mousedown", onCollageDown);
          canvas.addEventListener("mousemove", onCollageMove);
          canvas.addEventListener("mouseup", onCollageUp);
          canvas.addEventListener("touchstart", onCollageDown, { passive: false });
          canvas.addEventListener("touchmove", onCollageMove, { passive: false });
          canvas.addEventListener("touchend", onCollageUp);

          // ãƒœã‚¿ãƒ³åˆ¶å¾¡
          const btn = document.getElementById("btn-download-collage");
          btn.disabled = true;
          btn.style.background = "#ccc";
          btn.textContent = "ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...";

          files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => {
                tempImages.push(img);
                loadedCount++;
                if (loadedCount === files.length) {
                  initCollageLayers(tempImages);
                  btn.disabled = false;
                  btn.style.background = "#3f51b5";
                  btn.style.cursor = "pointer";
                  btn.textContent = "ğŸ’¾ ç”»åƒã‚’ä¿å­˜ (.png)";
                }
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);
          });
        }

        // --- 2. åˆæœŸåŒ– ---
        function initCollageLayers(images) {
          collageLayers = images.map(img => ({ img: img, x: 0, y: 0, w: 100, h: 100 }));
          currentLayoutMode = ""; // å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
          updateCollage();
        }

        // --- 3. é…ç½®è¨ˆç®— & ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ ---
        function updateCollage() {
          if (collageLayers.length === 0) return;

          const canvas = document.getElementById("collage-canvas");
          const layoutMode = document.getElementById("collage-layout-mode").value;
          const gap = parseInt(document.getElementById("collage-gap").value);
          const aspect = document.getElementById("collage-aspect").value;

          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºæ±ºå®š
          let totalW = 1920, totalH = 1080;
          if (aspect === "16:9") { totalW = 1920; totalH = 1080; }
          else if (aspect === "4:3") { totalW = 1600; totalH = 1200; }
          else if (aspect === "1:1") { totalW = 1200; totalH = 1200; }
          else if (aspect === "9:16") { totalW = 1080; totalH = 1920; }
          else if (aspect === "auto") {
            if (["vertical", "film", "news", "layout_3_col"].includes(layoutMode)) {
              totalW = 1080; totalH = 1080 * Math.max(1, collageLayers.length * 0.7);
            } else if (layoutMode === "layout_2_h") {
              totalW = 1080; totalH = 1920;
            } else if (layoutMode === "horizontal") {
              totalH = 1080; totalW = 1080 * collageLayers.length * 1.3;
            } else {
              totalW = 1920; totalH = 1080;
            }
          }

          canvas.width = totalW;
          canvas.height = totalH;
          const count = collageLayers.length;

          // â˜… ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–‡å­—ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ã®åˆæœŸç”Ÿæˆ
          // ãƒ¢ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘ãƒªã‚»ãƒƒãƒˆãƒ»å†ç”Ÿæˆã™ã‚‹
          if (layoutMode !== currentLayoutMode) {
            currentLayoutMode = layoutMode;
            collageDecorations = []; // ãƒªã‚»ãƒƒãƒˆ

            const cx = totalW / 2;
            const cy = totalH / 2;

            if (layoutMode === "winner") {
              collageDecorations.push({ text: "WINNER", x: cx, y: 100, size: 100, font: "italic 900", color: "#ffd700", stroke: "#8d6e63", shadow: true });
              collageDecorations.push({ text: "ğŸ†", x: totalW - 100, y: totalH - 80, size: 100, font: "bold", color: "#fff", shadow: true });
              collageDecorations.push({ text: "ğŸ¥‡", x: 100, y: totalH - 80, size: 100, font: "bold", color: "#fff", shadow: true });
            }
            else if (layoutMode === "news") {
              collageDecorations.push({ text: "BREAKING NEWS", x: 60, y: totalH - 100, size: 50, font: "bold", color: "#fff", align: "left" });
              collageDecorations.push({ text: "VICTORY!", x: 60, y: totalH - 180, size: 80, font: "bold", color: "#ffeb3b", align: "left" });
              collageDecorations.push({ text: "ğŸ”´ REC", x: 100, y: 80, size: 30, font: "bold", color: "#fff" });
            }
            else if (layoutMode === "vs") {
              collageDecorations.push({ text: "VS", x: cx, y: cy, size: 250, font: "italic 900", color: "#fff", stroke: "#000", shadow: true });
            }
            else if (layoutMode === "effort") {
              collageDecorations.push({ text: "ONE SHOT", x: totalW - 50, y: 150, size: 120, font: "italic 900", color: "#fff", align: "right", shadow: true });
              collageDecorations.push({ text: "NEVER GIVE UP", x: 50, y: totalH - 50, size: 80, font: "bold", color: "rgba(255,255,255,0.8)", align: "left" });
              collageDecorations.push({ text: "ğŸ”¥", x: 80, y: 150, size: 120, font: "bold", color: "#fff" });
            }
            else if (layoutMode === "practice") {
              collageDecorations.push({ text: "TRAINING", x: cx, y: 80, size: 80, font: "bold monospace", color: "rgba(255,255,255,0.9)" });
            }
            else if (layoutMode === "crown") {
              collageDecorations.push({ text: "ğŸ‘‘", x: cx, y: 100, size: 120, font: "bold", color: "#fff" });
              collageDecorations.push({ text: "CHAMPION", x: cx, y: 220, size: 100, font: "900 serif", color: "#ffd700", shadow: true });
            }
            else if (layoutMode === "feminine") {
              collageDecorations.push({ text: "Memories ğŸŒ¸", x: totalW - 50, y: totalH - 50, size: 60, font: "serif", color: "#ec407a", align: "right" });
              collageDecorations.push({ text: "ğŸŒ¸", x: 60, y: 80, size: 80, font: "bold", color: "#fff" });
            }
            else if (layoutMode === "cute") {
              collageDecorations.push({ text: "LOVELY TEAM", x: cx, y: totalH - 80, size: 80, font: "bold", color: "#ff4081", stroke: "#fff" });
              collageDecorations.push({ text: "ğŸ’–", x: 80, y: 100, size: 80, font: "bold", color: "#fff" });
              collageDecorations.push({ text: "ğŸ€", x: totalW - 80, y: 100, size: 80, font: "bold", color: "#fff" });
            }
            else if (layoutMode === "impact") {
              collageDecorations.push({ text: "IMPACT!", x: cx, y: cy, size: 180, font: "italic 900", color: "#d50000", stroke: "#fff", shadow: true });
              collageDecorations.push({ text: "âš¡", x: 100, y: totalH - 100, size: 120, font: "bold", color: "#fff" });
            }
            else if (layoutMode === "cool") {
              collageDecorations.push({ text: ">> SYSTEM ONLINE", x: 50, y: 80, size: 50, font: "bold monospace", color: "#00e5ff", align: "left" });
            }
            else if (layoutMode === "manga") {
              collageDecorations.push({ text: "DON!!", x: totalW - 300, y: totalH - 100, size: 120, font: "bold", color: "#000", stroke: "#fff" });
            }
            else if (layoutMode === "wanted") {
              collageDecorations.push({ text: "WANTED", x: cx, y: 180, size: 150, font: "bold serif", color: "#3e2723" });
              collageDecorations.push({ text: "REWARD: $1,000,000", x: cx, y: totalH - 100, size: 60, font: "bold serif", color: "#3e2723" });
            }
            else if (layoutMode === "magazine") {
              collageDecorations.push({ text: "BADMINTON", x: cx, y: 140, size: 150, font: "900 serif", color: "#fff", shadow: true });
              collageDecorations.push({ text: "SPECIAL ISSUE", x: cx, y: 220, size: 60, font: "bold", color: "#ffeb3b" });
              collageDecorations.push({ text: new Date().toLocaleDateString(), x: totalW - 50, y: totalH - 50, size: 30, font: "bold", color: "#fff", align: "right" });
            }
            else if (layoutMode === "nature") {
              collageDecorations.push({ text: "Summer Camp", x: cx, y: 120, size: 80, font: "bold", color: "#fff", shadow: true });
            }
            else if (layoutMode === "minimal") {
              collageDecorations.push({ text: "Badminton Log", x: cx, y: totalH - 60, size: 30, font: "bold", color: "#000" });
            }
          }

          // --- å†™çœŸã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®— ---
          const applyGrid = (cols, rows, startIndex = 0, areaX = 0, areaY = 0, areaW = totalW, areaH = totalH, localGap = gap) => {
            const cellW = (areaW - (localGap * (cols + 1))) / cols;
            const cellH = (areaH - (localGap * (rows + 1))) / rows;
            for (let i = 0; i < (cols * rows); i++) {
              const targetIdx = startIndex + i;
              if (targetIdx >= count) break;
              const c = i % cols;
              const r = Math.floor(i / cols);
              collageLayers[targetIdx].x = areaX + localGap + c * (cellW + localGap);
              collageLayers[targetIdx].y = areaY + localGap + r * (cellH + localGap);
              collageLayers[targetIdx].w = cellW;
              collageLayers[targetIdx].h = cellH;
            }
          };

          const applySmartLayout = (margin, headerSpace = 0) => {
            const availW = totalW - margin * 2;
            const availH = totalH - margin * 2 - headerSpace;
            const startY = margin + headerSpace;

            if (count === 1) {
              collageLayers[0].x = margin; collageLayers[0].y = startY;
              collageLayers[0].w = availW; collageLayers[0].h = availH;
            } else if (count === 2) {
              const w2 = (availW - gap) / 2;
              collageLayers[0].x = margin; collageLayers[0].y = startY; collageLayers[0].w = w2; collageLayers[0].h = availH;
              collageLayers[1].x = margin + w2 + gap; collageLayers[1].y = startY; collageLayers[1].w = w2; collageLayers[1].h = availH;
            } else if (count === 3) {
              const splitX = availW * 0.6;
              collageLayers[0].x = margin; collageLayers[0].y = startY; collageLayers[0].w = splitX - gap; collageLayers[0].h = availH;
              const subW = availW - splitX; const subH = (availH - gap) / 2;
              collageLayers[1].x = margin + splitX; collageLayers[1].y = startY; collageLayers[1].w = subW; collageLayers[1].h = subH;
              collageLayers[2].x = margin + splitX; collageLayers[2].y = startY + subH + gap; collageLayers[2].w = subW; collageLayers[2].h = subH;
            } else {
              const splitX = availW * 0.6;
              collageLayers[0].x = margin; collageLayers[0].y = startY; collageLayers[0].w = splitX - gap; collageLayers[0].h = availH;
              const subCount = count - 1;
              const subCols = subCount > 4 ? 2 : 1;
              const subRows = Math.ceil(subCount / subCols);
              applyGrid(subCols, subRows, 1, margin + splitX - gap, startY - gap, availW - splitX + gap * 2, availH + gap, gap);
            }
          };

          // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé©ç”¨
          if (["winner", "crown", "effort", "sparkle", "featured", "news", "feminine", "cute", "impact", "cool"].includes(layoutMode)) {
            let margin = gap; let header = 0;
            if (layoutMode === "winner") { margin = 60; header = 80; }
            else if (layoutMode === "crown") { margin = 60; header = 120; }
            else if (layoutMode === "effort") { margin = 40; }
            else if (layoutMode === "sparkle") { margin = 50; }
            else if (layoutMode === "feminine") { margin = 60; }
            else if (layoutMode === "cute") { margin = 50; }
            else if (layoutMode === "impact") { margin = 20; }
            else if (layoutMode === "cool") { margin = 40; }
            else if (layoutMode === "news") { margin = 0; header = 0; }
            applySmartLayout(margin, header);
            if (layoutMode === "news") collageLayers.forEach(l => l.h -= 150);
          }
          else if (["practice", "scrap", "polaroid"].includes(layoutMode)) {
            const cols = Math.ceil(Math.sqrt(count));
            const rows = Math.ceil(count / cols);
            const cellW = totalW / cols; const cellH = totalH / rows;
            collageLayers.forEach((layer, i) => {
              const c = i % cols; const r = Math.floor(i / cols);
              layer.w = cellW * (layoutMode === "practice" ? 0.85 : 0.8);
              layer.h = cellH * (layoutMode === "practice" ? 0.85 : 0.8);
              layer.x = (c * cellW) + (cellW - layer.w) / 2;
              layer.y = (r * cellH) + (cellH - layer.h) / 2;
            });
          }
          else if (layoutMode === "vs") {
            if (count >= 2) {
              collageLayers[0].x = 0; collageLayers[0].y = 0; collageLayers[0].w = totalW / 2 - 5; collageLayers[0].h = totalH;
              collageLayers[1].x = totalW / 2 + 5; collageLayers[1].y = 0; collageLayers[1].w = totalW / 2 - 5; collageLayers[1].h = totalH;
            } else { collageLayers[0].x = 0; collageLayers[0].y = 0; collageLayers[0].w = totalW; collageLayers[0].h = totalH; }
          }
          else if (["wanted", "magazine", "gallery", "retro", "minimal", "nature", "cyber", "manga"].includes(layoutMode)) {
            if (layoutMode === "magazine" || layoutMode === "wanted") {
              if (count >= 1) {
                collageLayers[0].x = 0; collageLayers[0].y = 0; collageLayers[0].w = totalW; collageLayers[0].h = totalH;
                if (count > 1) { const subW = totalW * 0.25; const subH = totalH * 0.25; applyGrid(1, count - 1, 1, totalW - subW - gap, totalH / 2, subW, subH); }
              }
            } else {
              let cols = 1, rows = 1;
              if (count === 2) { cols = 2; } else if (count <= 4) { cols = 2; rows = 2; } else { cols = 4; rows = Math.ceil(count / 4); }
              const pad = (layoutMode === "minimal" || layoutMode === "gallery") ? gap + 40 : gap;
              applyGrid(cols, rows, 0, 0, 0, totalW, totalH, pad);
            }
          }
          else if (layoutMode === "layout_1_full") { if (count >= 1) { collageLayers[0].x = gap; collageLayers[0].y = gap; collageLayers[0].w = totalW - gap * 2; collageLayers[0].h = totalH - gap * 2; } }
          else if (layoutMode === "layout_2_v") { if (count >= 2) { const w2 = (totalW - gap * 3) / 2; collageLayers[0].w = w2; collageLayers[0].h = totalH - gap * 2; collageLayers[0].x = gap; collageLayers[0].y = gap; collageLayers[1].w = w2; collageLayers[1].h = totalH - gap * 2; collageLayers[1].x = gap * 2 + w2; collageLayers[1].y = gap; } else applySmartLayout(gap); }
          else if (layoutMode === "layout_2_h") { if (count >= 2) { const h2 = (totalH - gap * 3) / 2; collageLayers[0].w = totalW - gap * 2; collageLayers[0].h = h2; collageLayers[0].x = gap; collageLayers[0].y = gap; collageLayers[1].w = totalW - gap * 2; collageLayers[1].h = h2; collageLayers[1].x = gap; collageLayers[1].y = gap * 2 + h2; } else applySmartLayout(gap); }
          else if (layoutMode === "layout_3_t") { applySmartLayout(gap); }
          else if (layoutMode === "layout_3_inv") { if (count >= 3) { const h2 = (totalH - gap * 3) / 2; const w2 = (totalW - gap * 3) / 2; collageLayers[0].w = w2; collageLayers[0].h = h2; collageLayers[0].x = gap; collageLayers[0].y = gap; collageLayers[1].w = w2; collageLayers[1].h = h2; collageLayers[1].x = gap * 2 + w2; collageLayers[1].y = gap; collageLayers[2].w = totalW - gap * 2; collageLayers[2].h = h2; collageLayers[2].x = gap; collageLayers[2].y = gap * 2 + h2; } else applySmartLayout(gap); }
          else if (layoutMode === "layout_3_col") { const w3 = (totalW - gap * 4) / 3; for (let i = 0; i < Math.min(3, count); i++) { collageLayers[i].x = gap + i * (w3 + gap); collageLayers[i].y = gap; collageLayers[i].w = w3; collageLayers[i].h = totalH - gap * 2; } }
          else if (layoutMode === "film" || layoutMode === "vertical") { const cellH = totalH / count; const filmPad = (layoutMode === "film") ? cellH * 0.15 : gap; collageLayers.forEach((layer, i) => { layer.h = cellH - filmPad * 2; layer.w = (layoutMode === "film") ? layer.h * 1.5 : totalW - gap * 2; layer.x = (totalW - layer.w) / 2; layer.y = (i * cellH) + filmPad; }); }
          else if (layoutMode === "horizontal") { applyGrid(count, 1); }
          else { let cols = 1, rows = 1; if (count === 2) { cols = 2; } else if (count <= 4) { cols = 2; rows = 2; } else { cols = 4; rows = Math.ceil(count / 4); } applyGrid(cols, rows); }

          drawCollageCanvas();
        }

        // --- 4. æç”»å‡¦ç† ---
        function drawCollageCanvas() {
          const canvas = document.getElementById("collage-canvas");
          const ctx = canvas.getContext("2d");
          const layoutMode = document.getElementById("collage-layout-mode").value;
          const bgColor = document.getElementById("collage-bg-color").value;
          const w = canvas.width, h = canvas.height;

          // === A. èƒŒæ™¯æç”» ===
          if (layoutMode === "news") { ctx.fillStyle = "#003366"; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "vs") { const grad = ctx.createLinearGradient(0, 0, w, h); grad.addColorStop(0, "#d32f2f"); grad.addColorStop(0.5, "#000"); grad.addColorStop(1, "#1976d2"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "cyber") { ctx.fillStyle = "#0d0d0d"; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = "rgba(0, 255, 255, 0.2)"; ctx.lineWidth = 2; for (let i = 0; i < w; i += 100) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); } for (let i = 0; i < h; i += 100) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke(); } }
          else if (layoutMode === "manga") { ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, w, h); ctx.save(); ctx.translate(w / 2, h / 2); ctx.fillStyle = "#000"; for (let i = 0; i < 36; i++) { ctx.rotate(Math.PI / 18); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(w, -10); ctx.lineTo(w, 10); ctx.fill(); } ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0, 0, h / 1.5, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }
          else if (layoutMode === "wanted") { ctx.fillStyle = "#d7ccc8"; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "retro") { ctx.fillStyle = "#3e2723"; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "minimal") { ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "nature") { const grad = ctx.createLinearGradient(0, 0, 0, h); grad.addColorStop(0, "#4fc3f7"); grad.addColorStop(1, "#81c784"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "scrap") { ctx.fillStyle = "#f5f5f5"; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "rgba(0,0,0,0.05)"; for (let i = 0; i < w; i += 40) ctx.fillRect(i, 0, 2, h); for (let i = 0; i < h; i += 40) ctx.fillRect(0, i, w, 2); }
          else if (layoutMode === "winner") { const grad = ctx.createLinearGradient(0, 0, w, h); grad.addColorStop(0, "#fff9c4"); grad.addColorStop(1, "#ffecb3"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); ctx.save(); ctx.translate(w / 2, h / 2); ctx.fillStyle = "rgba(255, 215, 0, 0.1)"; for (let i = 0; i < 12; i++) { ctx.rotate(Math.PI / 6); ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(w, -100); ctx.lineTo(w, 100); ctx.fill(); } ctx.restore(); }
          else if (layoutMode === "effort") { const grad = ctx.createLinearGradient(0, 0, w, h); grad.addColorStop(0, "#212121"); grad.addColorStop(1, "#b71c1c"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "practice") { ctx.fillStyle = "#2e7d32"; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "crown") { const grad = ctx.createLinearGradient(0, 0, 0, h); grad.addColorStop(0, "#1a237e"); grad.addColorStop(1, "#4a148c"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "film") { ctx.fillStyle = "#111"; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "#fff"; for (let y = 10; y < h; y += 40) { ctx.fillRect(20, y, 20, 20); ctx.fillRect(w - 40, y, 20, 20); } }
          else if (layoutMode === "sparkle") { const grad = ctx.createLinearGradient(0, 0, 0, h); grad.addColorStop(0, "#fce4ec"); grad.addColorStop(1, "#e1bee7"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); }
          else if (layoutMode === "feminine") { const grad = ctx.createLinearGradient(0, 0, w, h); grad.addColorStop(0, "#fce4ec"); grad.addColorStop(1, "#fff3e0"); ctx.fillStyle = grad; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "rgba(255, 255, 255, 0.6)"; for (let i = 0; i < 30; i++) { const rx = Math.random() * w; const ry = Math.random() * h; ctx.beginPath(); ctx.arc(rx, ry, 20 + Math.random() * 20, 0, Math.PI * 2); ctx.fill(); } }
          else if (layoutMode === "cute") { ctx.fillStyle = "#ffcdd2"; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "#fff"; for (let y = 0; y < h; y += 80) for (let x = 0; x < w; x += 80) if ((x / 80 + y / 80) % 2 === 0) { ctx.beginPath(); ctx.arc(x, y, 15, 0, Math.PI * 2); ctx.fill(); } }
          else if (layoutMode === "impact") { ctx.fillStyle = "#ffeb3b"; ctx.fillRect(0, 0, w, h); ctx.fillStyle = "#000"; ctx.save(); ctx.translate(w / 2, h / 2); ctx.rotate(Math.PI / 4); for (let i = -w; i < w; i += 100) ctx.fillRect(i, -h, 40, h * 2); ctx.restore(); }
          else if (layoutMode === "cool") { ctx.fillStyle = "#263238"; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = "rgba(0, 229, 255, 0.2)"; ctx.lineWidth = 2; for (let i = 0; i < w; i += 80) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); } }
          else { ctx.fillStyle = bgColor; ctx.fillRect(0, 0, w, h); }

          // === B. ç”»åƒæç”» ===
          collageLayers.forEach((layer, i) => {
            if (layer.w <= 0) return;
            ctx.save();
            if (layoutMode === "polaroid" || layoutMode === "scrap") {
              const centerX = layer.x + layer.w / 2; const centerY = layer.y + layer.h / 2;
              const angle = ((i * 12345) % 11 - 5) * 0.02;
              ctx.translate(centerX, centerY); ctx.rotate(angle); ctx.translate(-centerX, -centerY);
            }
            // è£…é£¾ã®ä¸‹åœ°ãƒ»æ 
            if (layoutMode === "feminine") {
              ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.shadowColor = "rgba(233,30,99,0.2)"; ctx.shadowBlur = 10;
              ctx.fillRect(layer.x - 10, layer.y - 10, layer.w + 20, layer.h + 20); ctx.shadowColor = "transparent";
            } else if (layoutMode === "cute") {
              ctx.fillStyle = "#fff"; ctx.fillRect(layer.x - 8, layer.y - 8, layer.w + 16, layer.h + 16);
            } else if (layoutMode === "impact") {
              ctx.fillStyle = "#000"; ctx.fillRect(layer.x - 10, layer.y - 10, layer.w + 20, layer.h + 20);
            } else if (layoutMode === "cool") {
              ctx.shadowColor = "#00e5ff"; ctx.shadowBlur = 15; ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
              ctx.strokeRect(layer.x, layer.y, layer.w, layer.h); ctx.shadowBlur = 0;
            } else if (layoutMode === "gallery") {
              ctx.fillStyle = "#4e342e"; ctx.fillRect(layer.x - 20, layer.y - 20, layer.w + 40, layer.h + 40);
              ctx.fillStyle = "#fff"; ctx.fillRect(layer.x - 5, layer.y - 5, layer.w + 10, layer.h + 10);
              ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 20;
            } else if (layoutMode === "retro") {
              ctx.fillStyle = "#eee"; ctx.fillRect(layer.x - 10, layer.y - 10, layer.w + 20, layer.h + 20);
            } else if (layoutMode === "manga") {
              ctx.fillStyle = "#000"; ctx.fillRect(layer.x - 8, layer.y - 8, layer.w + 16, layer.h + 16);
            } else if (["polaroid", "scrap", "wanted", "winner", "practice", "crown", "effort"].includes(layoutMode)) {
              if (layoutMode === "winner" || layoutMode === "practice") ctx.fillStyle = "#fff";
              else if (layoutMode === "crown") ctx.fillStyle = "#ffd700";
              else if (layoutMode === "effort") ctx.fillStyle = "#d50000";
              else ctx.fillStyle = "#fff";
              if (["polaroid", "scrap", "winner", "crown", "effort"].includes(layoutMode)) {
                ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 15; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
              }
              if (layoutMode === "wanted") ctx.fillRect(layer.x - 10, layer.y - 10, layer.w + 20, layer.h + 10);
              else if (layoutMode === "polaroid") ctx.fillRect(layer.x - 10, layer.y - 10, layer.w + 20, layer.h + 40);
              else if (layoutMode === "scrap") {
                ctx.fillRect(layer.x - 10, layer.y - 10, layer.w + 20, layer.h + 20); ctx.shadowColor = "transparent";
                ctx.fillStyle = "rgba(255,235,59,0.7)"; ctx.fillRect(layer.x + layer.w / 2 - 30, layer.y - 20, 60, 20);
              } else ctx.fillRect(layer.x - 5, layer.y - 5, layer.w + 10, layer.h + 10);
              ctx.shadowColor = "transparent";
            }
            drawImageCover(ctx, layer.img, layer.x, layer.y, layer.w, layer.h);
            if (layoutMode === "retro" || layoutMode === "wanted") {
              ctx.fillStyle = "rgba(112, 66, 20, 0.3)"; ctx.fillRect(layer.x, layer.y, layer.w, layer.h);
            } else if (layoutMode === "cool") {
              ctx.fillStyle = "rgba(0, 229, 255, 0.1)"; ctx.fillRect(layer.x, layer.y, layer.w, layer.h);
            }
            if (i === swapSelectedIndex) {
              ctx.strokeStyle = "#ff3d00"; ctx.lineWidth = 10; ctx.strokeRect(layer.x, layer.y, layer.w, layer.h);
              ctx.fillStyle = "rgba(255, 61, 0, 0.3)"; ctx.fillRect(layer.x, layer.y, layer.w, layer.h);
              ctx.fillStyle = "#fff"; ctx.font = "bold 40px sans-serif"; ctx.textAlign = "center";
              ctx.fillText("â‡„ Swap", layer.x + layer.w / 2, layer.y + layer.h / 2);
            }
            ctx.restore();
          });

          // === C. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æç”» ===
          if (layoutMode === "news") {
            ctx.fillStyle = "#d32f2f"; ctx.fillRect(0, h - 150, w, 150);
          }

          // æ–‡å­—ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆç§»å‹•å¯èƒ½ï¼‰
          collageDecorations.forEach((dec, i) => {
            ctx.save();
            ctx.font = `${dec.size}px ${dec.font || "sans-serif"}`;
            ctx.textAlign = dec.align || "center";
            ctx.textBaseline = "middle";

            if (dec.shadow) { ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 10; }

            ctx.fillStyle = dec.color;
            ctx.fillText(dec.text, dec.x, dec.y);

            if (dec.stroke) {
              ctx.lineWidth = 4;
              ctx.strokeStyle = dec.stroke;
              ctx.strokeText(dec.text, dec.x, dec.y);
            }

            // é¸æŠä¸­ãªã‚‰æ ã‚’è¡¨ç¤º
            if (i === selectedDecoIndex) {
              const m = ctx.measureText(dec.text);
              const mw = m.width;
              const mh = dec.size; // ç°¡æ˜“é«˜ã•

              ctx.shadowColor = "transparent";
              ctx.strokeStyle = "#00e676";
              ctx.lineWidth = 2;
              let drawX = dec.x;
              if (dec.align === "left") drawX = dec.x + mw / 2;
              if (dec.align === "right") drawX = dec.x - mw / 2;

              ctx.strokeRect(drawX - mw / 2 - 10, dec.y - mh / 2 - 10, mw + 20, mh + 20);
            }
            ctx.restore();
          });
        }

        // --- 5. ã‚¯ãƒªãƒƒã‚¯æ“ä½œ (é¸æŠ & å…¥ã‚Œæ›¿ãˆ & ç§»å‹•) ---
        function getCollagePos(e) {
          const canvas = document.getElementById("collage-canvas");
          const rect = canvas.getBoundingClientRect();
          const cx = e.touches ? e.touches[0].clientX : e.clientX;
          const cy = e.touches ? e.touches[0].clientY : e.clientY;
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
        }

        function onCollageDown(e) {
          if (e.cancelable) e.preventDefault();
          const pos = getCollagePos(e);

          isCollageDragging = false;
          isDecoDragging = false;

          // 1. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®š (æ‰‹å‰ã«ã‚ã‚‹ã®ã§å„ªå…ˆ)
          let hitDeco = -1;
          const ctx = document.getElementById("collage-canvas").getContext("2d");

          for (let i = collageDecorations.length - 1; i >= 0; i--) {
            const d = collageDecorations[i];
            ctx.font = `${d.size}px ${d.font || "sans-serif"}`;
            const m = ctx.measureText(d.text);
            const w = m.width;
            const h = d.size;

            let cx = d.x;
            if (d.align === "left") cx = d.x + w / 2;
            if (d.align === "right") cx = d.x - w / 2;

            if (pos.x >= cx - w / 2 - 20 && pos.x <= cx + w / 2 + 20 &&
              pos.y >= d.y - h / 2 - 20 && pos.y <= d.y + h / 2 + 20) {
              hitDeco = i;
              break;
            }
          }

          if (hitDeco !== -1) {
            selectedDecoIndex = hitDeco;
            isDecoDragging = true;
            collageDragStart = pos;
            swapSelectedIndex = -1; // å†™çœŸé¸æŠã¯è§£é™¤
            drawCollageCanvas();
            return;
          } else {
            selectedDecoIndex = -1;
          }

          // 2. å†™çœŸåˆ¤å®š
          let hitIndex = -1;
          for (let i = collageLayers.length - 1; i >= 0; i--) {
            const l = collageLayers[i];
            if (pos.x >= l.x && pos.x <= l.x + l.w && pos.y >= l.y && pos.y <= l.y + l.h) {
              hitIndex = i;
              break;
            }
          }

          if (hitIndex === -1) {
            swapSelectedIndex = -1;
          } else {
            if (swapSelectedIndex === -1) {
              swapSelectedIndex = hitIndex;
            } else if (swapSelectedIndex === hitIndex) {
              swapSelectedIndex = -1;
            } else {
              // Swap
              const tempImg = collageLayers[swapSelectedIndex].img;
              collageLayers[swapSelectedIndex].img = collageLayers[hitIndex].img;
              collageLayers[hitIndex].img = tempImg;
              swapSelectedIndex = -1;
            }
          }
          drawCollageCanvas();
        }

        function onCollageMove(e) {
          if (!isDecoDragging) return;
          if (e.cancelable) e.preventDefault();
          const pos = getCollagePos(e);
          const dx = pos.x - collageDragStart.x;
          const dy = pos.y - collageDragStart.y;

          if (selectedDecoIndex !== -1) {
            collageDecorations[selectedDecoIndex].x += dx;
            collageDecorations[selectedDecoIndex].y += dy;
            drawCollageCanvas();
          }
          collageDragStart = pos;
        }

        function onCollageUp(e) {
          isDecoDragging = false;
        }

        // ==========================================
        // ğŸ¨ ç”»åƒæç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (ã“ã‚ŒãŒç„¡ã„ã¨ç”»åƒãŒå‡ºã¾ã›ã‚“)
        // ==========================================

        function drawImageCover(ctx, img, x, y, w, h) {
          // ç”»åƒãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯å£Šã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (!img || !img.width || !img.height) return;

          const imgRatio = img.width / img.height;
          const targetRatio = w / h;

          let drawW, drawH;

          // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚ˆã‚Šç”»åƒãŒæ¨ªé•·ã®å ´åˆ -> é«˜ã•ã‚’åˆã‚ã›ã¦æ¨ªã‚’ã‚«ãƒƒãƒˆ
          if (imgRatio > targetRatio) {
            drawH = h;
            drawW = h * imgRatio;
          }
          // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚ˆã‚Šç”»åƒãŒç¸¦é•·ã®å ´åˆ -> å¹…ã‚’åˆã‚ã›ã¦ç¸¦ã‚’ã‚«ãƒƒãƒˆ
          else {
            drawW = w;
            drawH = w / imgRatio;
          }

          // ä¸­å¤®å¯„ã›ã®ãŸã‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—
          const offsetX = (w - drawW) / 2;
          const offsetY = (h - drawH) / 2;

          ctx.save();
          ctx.beginPath();
          ctx.rect(x, y, w, h); // æç”»ã—ãŸã„æ ã‚’å®šç¾©
          ctx.clip();           // ãã®æ ã§ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ï¼ˆåˆ‡ã‚ŠæŠœãï¼‰

          // ç”»åƒã‚’æç”»
          ctx.drawImage(img, x + offsetX, y + offsetY, drawW, drawH);

          ctx.restore(); // ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°è§£é™¤
        }

        // ç”»åƒä¿å­˜æ©Ÿèƒ½
        function downloadCollage() {
          const canvas = document.getElementById("collage-canvas");

          // é¸æŠæ ï¼ˆèµ¤æ ã‚„ç·‘æ ï¼‰ã‚’ä¸€æ™‚çš„ã«æ¶ˆã—ã¦ãã‚Œã„ãªçŠ¶æ…‹ã§ä¿å­˜ã™ã‚‹
          // ç¾åœ¨ã®é¸æŠçŠ¶æ…‹ã‚’è¨˜æ†¶
          const tempSwap = swapSelectedIndex;
          const tempDeco = selectedDecoIndex;

          // é¸æŠã‚’è§£é™¤ã—ã¦å†æç”»
          swapSelectedIndex = -1;
          selectedDecoIndex = -1;
          drawCollageCanvas();

          // ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const link = document.createElement("a");
          link.href = canvas.toDataURL("image/png");
          link.download = `Collage_${Date.now()}.png`;
          link.click();

          // é¸æŠçŠ¶æ…‹ã‚’å…ƒã«æˆ»ã—ã¦å†æç”»
          swapSelectedIndex = tempSwap;
          selectedDecoIndex = tempDeco;
          drawCollageCanvas();
        }

        // â–¼â–¼â–¼ åˆæœŸåŒ–ãƒ»å¤–éƒ¨é€£æºãƒ»æ–‡å­—æ•°åˆ¶é™ã®çµ±åˆæ©Ÿèƒ½ â–¼â–¼â–¼
        document.addEventListener("DOMContentLoaded", () => {
          // 1. è¦ç´ ã®å–å¾—
          const textArea = document.getElementById("free-text");
          const countDisplay = document.getElementById("char-count");
          const aiBtn = document.getElementById("ai-suggest-btn");
          const navTraining = document.getElementById("nav-training");

          // 2. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—
          const params = new URLSearchParams(window.location.search);
          const taskText = params.get("task");
          const mode = params.get("mode");
          const maxLength = 150;

          // -------------------------------------------------------
          // 3. æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ã®è¨­å®š
          // -------------------------------------------------------
          // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ç”¨ã®é–¢æ•°ï¼ˆå…¥åŠ›æ™‚ã¨è‡ªå‹•ã‚»ãƒƒãƒˆæ™‚ã®ä¸¡æ–¹ã§ä½¿ã„ã¾ã™ï¼‰
          const updateCharCount = () => {
            if (!textArea || !countDisplay) return;

            const currentLength = textArea.value.length;
            countDisplay.textContent = `${currentLength} / ${maxLength}`;

            if (currentLength >= maxLength) {
              countDisplay.style.color = "red";
              countDisplay.style.fontWeight = "bold";
            } else {
              countDisplay.style.color = "#666";
              countDisplay.style.fontWeight = "normal";
            }
          };

          if (textArea && countDisplay) {
            // å…¥åŠ›ã™ã‚‹ãŸã³ã«ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
            textArea.addEventListener("input", updateCharCount);
            // èª­ã¿è¾¼ã¿æ™‚ã«ã‚‚ä¸€åº¦å®Ÿè¡Œ
            updateCharCount();
          }

          // -------------------------------------------------------
          // 4. ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ãƒ»å¤–éƒ¨é€£æºã«ã‚ˆã‚‹åˆ¶é™è§£é™¤ãƒ­ã‚¸ãƒƒã‚¯
          // -------------------------------------------------------
          // taskãŒã‚ã‚‹ã€ã¾ãŸã¯ mode=admin ã®å ´åˆ
          if (taskText || mode === "admin") {
            if (textArea) {
              textArea.disabled = false;
              textArea.style.backgroundColor = "#fff";
              textArea.placeholder = "ä¾‹ï¼‰ã‚¹ãƒãƒƒã‚·ãƒ¥å¾Œã®ãƒªã‚«ãƒãƒªãƒ¼ãŒé…ã„ã€‚å‰å¾Œã®å‹•ãå‡ºã—ã‚’é€Ÿãã—ãŸã„ã€‚ï¼ˆ150æ–‡å­—ä»¥å†…ï¼‰";
            }
            if (aiBtn) {
              aiBtn.disabled = false;
              aiBtn.style.display = "inline-block";
            }
          }

          // -------------------------------------------------------
          // 5. taskãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®è‡ªå‹•å®Ÿè¡Œå‡¦ç†
          // -------------------------------------------------------
          if (taskText && textArea) {
            // (1) ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ã‚’è¡¨ç¤º
            if (navTraining && typeof showScreen === 'function') {
              showScreen('training', navTraining);
            }

            // (2) èª²é¡Œã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
            textArea.value = decodeURIComponent(taskText);

            // (3) æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚’æ‰‹å‹•æ›´æ–°ï¼ˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å€¤ã‚’å…¥ã‚ŒãŸå¾Œã¯è‡ªå‹•ã§æ›´æ–°ã•ã‚Œãªã„ãŸã‚ï¼‰
            updateCharCount();

            // (4) AIææ¡ˆãƒœã‚¿ãƒ³ã‚’è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
            setTimeout(() => {
              if (typeof analyzeAndSuggest === 'function') {
                analyzeAndSuggest();
              }
            }, 1000);
          }
        });

        // ==========================================
        // ğŸ·ï¸ å‹•ç”»ã‚¿ã‚®ãƒ³ã‚°ï¼†ãƒã‚¤ãƒ©ã‚¤ãƒˆå†ç”Ÿæ©Ÿèƒ½
        // ==========================================

        let vtVideo = null;
        let vtTags = []; // { id, time, start, end, note }
        let vtIsPlayingHighlights = false;
        let vtCurrentHighlightIndex = 0;

        // 1. å‹•ç”»èª­ã¿è¾¼ã¿
        function vtLoadVideo(input) {
          const file = input.files[0];
          if (!file) return;

          vtVideo = document.getElementById("vt-video");
          const container = document.getElementById("vt-container");

          // ãƒªã‚»ãƒƒãƒˆ
          vtTags = [];
          vtRenderTags();
          vtStopHighlights();

          const url = URL.createObjectURL(file);
          vtVideo.src = url;

          vtVideo.onloadedmetadata = () => {
            container.style.display = "block";
          };

          // å†ç”Ÿä½ç½®ç›£è¦–ç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
          vtVideo.removeEventListener('timeupdate', vtCheckHighlightProgress);
          vtVideo.addEventListener('timeupdate', vtCheckHighlightProgress);
        }

        // 2. ã‚¿ã‚°è¿½åŠ 
        function vtAddTag() {
          if (!vtVideo) return;

          const currentTime = vtVideo.currentTime;
          const buffer = parseFloat(document.getElementById("vt-buffer").value) || 3;

          // é–‹å§‹ãƒ»çµ‚äº†æ™‚é–“ã‚’è¨ˆç®— (å‹•ç”»ã®ç¯„å›²å†…ã«åã‚ã‚‹)
          const startTime = Math.max(0, currentTime - buffer);
          const endTime = Math.min(vtVideo.duration, currentTime + buffer);

          const newTag = {
            id: Date.now(),
            centerTime: currentTime,
            start: startTime,
            end: endTime,
            note: `ã‚·ãƒ¼ãƒ³ ${vtTags.length + 1}`
          };

          // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¿½åŠ 
          vtTags.push(newTag);
          vtTags.sort((a, b) => a.start - b.start);

          vtRenderTags();

          // ä¸€ç¬åœæ­¢ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          const wasPlaying = !vtVideo.paused;
          vtVideo.pause();
          alert("ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼");
          if (wasPlaying) vtVideo.play();
        }

        // 3. ã‚¿ã‚°ãƒªã‚¹ãƒˆæç”»
        function vtRenderTags() {
          const listEl = document.getElementById("vt-tag-list");
          const btnPlay = document.getElementById("btn-vt-play");

          if (vtTags.length === 0) {
            listEl.innerHTML = '<p style="padding:15px; text-align:center; color:#999; font-size:12px;">ã¾ã ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å†ç”Ÿä½ç½®ã‚’åˆã‚ã›ã¦ã€Œã‚¿ã‚°ä»˜ã‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';
            btnPlay.disabled = true;
            btnPlay.style.cursor = "not-allowed";
            btnPlay.style.background = "#90caf9"; // è–„ã„é’
            return;
          }

          btnPlay.disabled = false;
          btnPlay.style.cursor = "pointer";
          btnPlay.style.background = "#1565c0"; // æ¿ƒã„é’

          let html = "";
          vtTags.forEach((tag, index) => {
            // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (åˆ†:ç§’)
            const fmt = (t) => {
              const m = Math.floor(t / 60);
              const s = Math.floor(t % 60).toString().padStart(2, '0');
              return `${m}:${s}`;
            };

            html += `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #eee; background:#fff;">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333; font-size:14px;">
                        <input type="text" value="${tag.note}" onchange="vtUpdateNote(${tag.id}, this.value)" style="border:none; border-bottom:1px dashed #ccc; width:120px; font-weight:bold; color:#333;">
                    </div>
                    <div style="font-size:12px; color:#666;">
                        â± ${fmt(tag.start)} ï½ ${fmt(tag.end)} (ä¸­å¿ƒ: ${fmt(tag.centerTime)})
                    </div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="vtPreviewTag(${index})" style="background:#4caf50; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;">â–¶ å†ç”Ÿ</button>
                    <button onclick="vtDeleteTag(${index})" style="background:#ef5350; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;">å‰Šé™¤</button>
                </div>
            </div>
        `;
          });
          listEl.innerHTML = html;
        }

        // 4. å€‹åˆ¥ã‚¿ã‚°ã®å†ç”Ÿç¢ºèª
        function vtPreviewTag(index) {
          vtStopHighlights(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯è§£é™¤
          const tag = vtTags[index];
          vtVideo.currentTime = tag.start;
          vtVideo.play();

          // ä¸€å›ã ã‘çµ‚äº†åˆ¤å®šã™ã‚‹é–¢æ•°
          const stopAtEnd = () => {
            if (vtVideo.currentTime >= tag.end) {
              vtVideo.pause();
              vtVideo.removeEventListener('timeupdate', stopAtEnd);
            }
          };
          vtVideo.addEventListener('timeupdate', stopAtEnd);
        }

        // 5. ã‚¿ã‚°å‰Šé™¤ãƒ»ç·¨é›†
        function vtDeleteTag(index) {
          if (confirm("ã“ã®ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            vtTags.splice(index, 1);
            vtRenderTags();
          }
        }
        function vtClearTags() {
          if (confirm("ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            vtTags = [];
            vtRenderTags();
          }
        }
        function vtUpdateNote(id, text) {
          const tag = vtTags.find(t => t.id === id);
          if (tag) tag.note = text;
        }

        // 6. ãƒã‚¤ãƒ©ã‚¤ãƒˆé€£ç¶šå†ç”Ÿï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰
        function vtPlayHighlights() {
          if (vtTags.length === 0) return;

          vtIsPlayingHighlights = true;
          vtCurrentHighlightIndex = 0;

          // UIæ›´æ–°
          const indicator = document.getElementById("vt-indicator");
          indicator.style.display = "block";
          const btn = document.getElementById("btn-vt-play");
          btn.textContent = "â–  å†ç”Ÿåœæ­¢";
          btn.onclick = vtStopHighlights;
          btn.style.background = "#d32f2f"; // èµ¤

          // æœ€åˆã®ã‚¿ã‚°ã¸ã‚·ãƒ¼ã‚¯ã—ã¦å†ç”Ÿ
          vtPlayCurrentTag();
        }

        function vtStopHighlights() {
          vtIsPlayingHighlights = false;
          vtVideo.pause();

          // UIæˆ»ã™
          const indicator = document.getElementById("vt-indicator");
          if (indicator) indicator.style.display = "none";
          const btn = document.getElementById("btn-vt-play");
          if (btn) {
            btn.textContent = "â–¶ ãƒã‚¤ãƒ©ã‚¤ãƒˆé€£ç¶šå†ç”Ÿ";
            btn.onclick = vtPlayHighlights;
            btn.style.background = "#1565c0";
          }
        }

        function vtPlayCurrentTag() {
          if (vtCurrentHighlightIndex >= vtTags.length) {
            // å…¨çµ‚äº†
            vtStopHighlights();
            alert("ãƒã‚¤ãƒ©ã‚¤ãƒˆå†ç”ŸãŒçµ‚äº†ã—ã¾ã—ãŸ");
            return;
          }

          const tag = vtTags[vtCurrentHighlightIndex];
          vtVideo.currentTime = tag.start;
          vtVideo.play();
          console.log(`Playing Highlight ${vtCurrentHighlightIndex + 1}: ${tag.note}`);
        }

        // å‹•ç”»å†ç”Ÿä¸­ã«å¸¸ã«å‘¼ã°ã‚Œã‚‹ç›£è¦–é–¢æ•°
        function vtCheckHighlightProgress() {
          if (!vtIsPlayingHighlights || vtTags.length === 0) return;

          const tag = vtTags[vtCurrentHighlightIndex];

          // ç¾åœ¨ã®ã‚¿ã‚°ã®çµ‚äº†æ™‚é–“ã‚’è¶…ãˆãŸã‚‰æ¬¡ã¸
          if (vtVideo.currentTime >= tag.end) {
            vtCurrentHighlightIndex++;
            vtPlayCurrentTag(); // æ¬¡ã®ã‚¿ã‚°ã¸ã‚·ãƒ¼ã‚¯ã—ã¦å†ç”Ÿ
          }
        }

        // ==========================================
        // ğŸ’¾ ãƒã‚¤ãƒ©ã‚¤ãƒˆä¿å­˜æ©Ÿèƒ½ (ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé€£æº)
        // ==========================================

        async function vtSaveHighlightsToLibrary() {
          if (vtTags.length === 0) return alert("ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          if (!vtVideo) return;

          // UIãƒ­ãƒƒã‚¯
          const btnSave = document.getElementById("btn-vt-save");
          const statusEl = document.getElementById("vt-save-status");
          const originalText = btnSave.innerHTML;

          btnSave.disabled = true;
          btnSave.style.background = "#ccc";
          vtStopHighlights(); // å†ç”Ÿä¸­ãªã‚‰æ­¢ã‚ã‚‹

          // éŒ²ç”»ã®æº–å‚™
          const stream = vtVideo.captureStream(); // æ˜ åƒ+éŸ³å£°ã‚’å–å¾—
          const mimeTypes = ["video/mp4", "video/webm;codecs=vp9", "video/webm"];
          const selectedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || "video/webm";

          let recorder;
          let chunks = [];

          try {
            recorder = new MediaRecorder(stream, { mimeType: selectedType });
          } catch (e) {
            alert("éŒ²ç”»ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            btnSave.disabled = false;
            btnSave.style.background = "#00897b";
            return;
          }

          recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };

          // éŒ²ç”»çµ‚äº†æ™‚ã®å‡¦ç†
          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: selectedType });
            const now = new Date();
            const timestamp = `${now.getHours()}æ™‚${now.getMinutes()}åˆ†`;
            const filename = `Highlights_${timestamp}.${selectedType.includes("mp4") ? "mp4" : "webm"}`;

            statusEl.textContent = "ä¿å­˜å‡¦ç†ä¸­...";

            // æ—¢å­˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜é–¢æ•°ã‚’å‘¼ã³å‡ºã—
            if (typeof saveVideoToDB === 'function') {
              saveVideoToDB(blob, filename).then(() => {
                statusEl.textContent = "âœ… ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¿å­˜ã—ã¾ã—ãŸï¼";
                setTimeout(() => statusEl.textContent = "", 3000);
              });
            } else {
              alert("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            }

            // UIå¾©å¸°
            btnSave.disabled = false;
            btnSave.innerHTML = originalText;
            btnSave.style.background = "#00897b";
            vtVideo.controls = true; // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’æˆ»ã™
          };

          // --- è‡ªå‹•å†ç”Ÿï¼†éŒ²ç”»ãƒ—ãƒ­ã‚»ã‚¹ ---
          statusEl.textContent = "â³ ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä½œæˆä¸­... (ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„)";
          vtVideo.controls = false; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯
          vtVideo.pause();

          recorder.start();
          recorder.pause(); // ä¸€æ—¦ãƒãƒ¼ã‚ºï¼ˆã‚·ãƒ¼ã‚¯ä¸­ã®ä½™è¨ˆãªæ˜ åƒã‚’å…¥ã‚Œãªã„ãŸã‚ï¼‰

          for (let i = 0; i < vtTags.length; i++) {
            const tag = vtTags[i];
            statusEl.textContent = `â³ ä½œæˆä¸­... (${i + 1}/${vtTags.length})`;

            // 1. é–‹å§‹ä½ç½®ã¸ã‚·ãƒ¼ã‚¯
            vtVideo.currentTime = tag.start;

            // ã‚·ãƒ¼ã‚¯å®Œäº†ã‚’å¾…ã¤
            await new Promise(resolve => {
              const onSeeked = () => {
                vtVideo.removeEventListener('seeked', onSeeked);
                resolve();
              };
              vtVideo.addEventListener('seeked', onSeeked);
            });

            // 2. éŒ²ç”»å†é–‹ & å†ç”Ÿ
            recorder.resume();
            await vtVideo.play();

            // 3. çµ‚äº†æ™‚é–“ã¾ã§å¾…æ©Ÿ
            await new Promise(resolve => {
              const checkTime = () => {
                if (vtVideo.currentTime >= tag.end || vtVideo.paused) {
                  vtVideo.removeEventListener('timeupdate', checkTime);
                  resolve();
                }
              };
              vtVideo.addEventListener('timeupdate', checkTime);
            });

            // 4. ä¸€æ™‚åœæ­¢
            vtVideo.pause();
            recorder.pause();
          }

          // å…¨å·¥ç¨‹çµ‚äº†
          recorder.stop();
        }

        // æ—¢å­˜ã® vtRenderTags é–¢æ•°ã‚’å°‘ã—ä¿®æ­£ã—ã¦ã€ä¿å­˜ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–ã‚’è¿½åŠ 
        // (ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§æ—¢å­˜ã® vtRenderTags ã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„)
        function vtRenderTags() {
          const listEl = document.getElementById("vt-tag-list");
          const btnPlay = document.getElementById("btn-vt-play");
          const btnSave = document.getElementById("btn-vt-save"); // â˜…è¿½åŠ 

          if (vtTags.length === 0) {
            listEl.innerHTML = '<p style="padding:15px; text-align:center; color:#999; font-size:12px;">ã¾ã ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å†ç”Ÿä½ç½®ã‚’åˆã‚ã›ã¦ã€Œã‚¿ã‚°ä»˜ã‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';
            if (btnPlay) { btnPlay.disabled = true; btnPlay.style.cursor = "not-allowed"; btnPlay.style.background = "#90caf9"; }
            if (btnSave) { btnSave.disabled = true; btnSave.style.cursor = "not-allowed"; btnSave.style.background = "#80cbc4"; } // â˜…è¿½åŠ 
            return;
          }

          if (btnPlay) { btnPlay.disabled = false; btnPlay.style.cursor = "pointer"; btnPlay.style.background = "#1565c0"; }
          if (btnSave) { btnSave.disabled = false; btnSave.style.cursor = "pointer"; btnSave.style.background = "#00897b"; } // â˜…è¿½åŠ 

          let html = "";
          vtTags.forEach((tag, index) => {
            const fmt = (t) => {
              const m = Math.floor(t / 60);
              const s = Math.floor(t % 60).toString().padStart(2, '0');
              return `${m}:${s}`;
            };

            html += `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #eee; background:#fff;">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#333; font-size:14px;">
                        <input type="text" value="${tag.note}" onchange="vtUpdateNote(${tag.id}, this.value)" style="border:none; border-bottom:1px dashed #ccc; width:120px; font-weight:bold; color:#333;">
                    </div>
                    <div style="font-size:12px; color:#666;">
                        â± ${fmt(tag.start)} ï½ ${fmt(tag.end)}
                    </div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="vtPreviewTag(${index})" style="background:#4caf50; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;">â–¶ å†ç”Ÿ</button>
                    <button onclick="vtDeleteTag(${index})" style="background:#ef5350; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer;">å‰Šé™¤</button>
                </div>
            </div>
        `;
          });
          listEl.innerHTML = html;
        }

        // â–¼â–¼â–¼ ãƒãƒ¼ãƒ ç·´ç¿’é€£æºç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (æ—¢å­˜ã®scriptã‚¿ã‚°å†…ã«è¿½åŠ ) â–¼â–¼â–¼

        // 1. ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒã‚§ãƒƒã‚¯
        document.addEventListener("DOMContentLoaded", () => {
          const urlParams = new URLSearchParams(window.location.search);
          const mode = urlParams.get('mode');
          const dataParam = urlParams.get('data');

          // é‹å–¶ã‚¢ãƒ—ãƒªã‹ã‚‰ 'team_link' ãƒ¢ãƒ¼ãƒ‰ã§æ¥ãŸå ´åˆã®ã¿ç™ºå‹•
          if (mode === 'team_link' && dataParam) {
            try {
              // ç”»é¢ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
              if (typeof showScreen === 'function') {
                const nav = document.getElementById('nav-training');
                if (nav) showScreen('training', nav);
              }

              // éš ã—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
              const section = document.getElementById("team-plan-section");
              if (section) section.style.display = "block";

              // ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ã—ã¦è¡¨ç¤º
              const teamData = JSON.parse(decodeURIComponent(dataParam));
              const inputText = `ã€å¯¾è±¡ã€‘${teamData.category}\nã€ä¸»ãªèª²é¡Œã€‘${teamData.issues.join(', ')}`;
              document.getElementById("team-input-text").value = inputText;

              // æ—¢å­˜ã®AIå…¥åŠ›æ¬„ãªã©ã¯éš ã™ï¼ˆä»»æ„ï¼‰
              const normalAi = document.getElementById("ai-section");
              if (normalAi) normalAi.style.display = "none";

            } catch (e) {
              console.error("ãƒ‡ãƒ¼ã‚¿å±•é–‹ã‚¨ãƒ©ãƒ¼", e);
            }
          }
        });

        // 2. GASã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹é–¢æ•°
        async function executeTeamMenuGen() {
          const text = document.getElementById("team-input-text").value;
          const btn = document.getElementById("btn-team-gen");
          const resultArea = document.getElementById("team-plan-result");
          const output = document.getElementById("team-plan-output");

          if (!text) return;

          btn.disabled = true;
          btn.textContent = "â³ AIãŒç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è€ƒæ¡ˆä¸­...";
          resultArea.style.display = "none";

          try {
            // GASã®URL (SHEET_URLå¤‰æ•°ãŒå®šç¾©æ¸ˆã¿å‰æ)
            const requestUrl = `${SHEET_URL}?mode=team_plan&text=${encodeURIComponent(text)}`;

            const res = await fetch(requestUrl);
            const data = await res.json();

            // â–¼â–¼â–¼ ã‚¨ãƒ©ãƒ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„ â–¼â–¼â–¼
            if (data.error) {
              console.error("API Error:", data.error);
              resultArea.style.display = "block";

              // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« "429" ã‚„ "quota" ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã€Œåˆ¶é™ã€ã¨ã¿ãªã™
              if (typeof data.error === 'string' && (data.error.includes("429") || data.error.includes("quota") || data.error.includes("RESOURCE_EXHAUSTED"))) {
                output.innerHTML = `
                    <div style="padding: 15px; border: 2px solid #ef5350; background: #ffebee; color: #c62828; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0;">âš ï¸ æœ¬æ—¥ã®AIåˆ©ç”¨ä¸Šé™ã«é”ã—ã¾ã—ãŸ</h4>
                        <p style="margin: 0; font-size: 14px; line-height: 1.6;">
                            ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚é«˜æ€§èƒ½AIãƒ¢ãƒ‡ãƒ«ï¼ˆGemini 2.5 Flashï¼‰ã®1æ—¥ã®ç„¡æ–™åˆ©ç”¨æ ï¼ˆ20å›ï¼‰ã‚’ä½¿ã„åˆ‡ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚<br>
                            <strong>æ˜æ—¥ã«ãªã‚Œã°å›æ•°ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€å†ã³åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</strong><br>
                            <br>
                            <span style="font-size: 12px; color: #555;">â€»æ™‚é–“ã‚’ç©ºã‘ã¦ã‚‚ä»Šæ—¥ã¯å›å¾©ã—ã¾ã›ã‚“ã€‚æ˜æ—¥ã¾ãŸãŠè©¦ã—ãã ã•ã„ã€‚</span>
                        </p>
                    </div>
                `;
              } else {
                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                output.innerHTML = `
                    <div style="padding: 15px; border: 2px solid #ff9800; background: #fff3e0; color: #ef6c00; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0;">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                        <p style="margin: 0; font-size: 14px;">
                            ä¸€æ™‚çš„ãªé€šä¿¡ã‚¨ãƒ©ãƒ¼ã‹ã€ã‚·ã‚¹ãƒ†ãƒ ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚<br>
                            å°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚<br>
                            <br>
                            <span style="font-size: 11px; color: #777;">ã‚¨ãƒ©ãƒ¼è©³ç´°: ${data.error.substring(0, 100)}...</span>
                        </p>
                    </div>
                `;
              }
            } else {
              // æˆåŠŸæ™‚
              resultArea.style.display = "block";
              output.innerText = data.content;
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

          } catch (e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          } finally {
            btn.disabled = false;
            btn.textContent = "ğŸ¤– AIã§ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆã™ã‚‹";
          }
        }

        // 3. ã‚³ãƒ”ãƒ¼ç”¨
        function copyTeamPlan() {
          const text = document.getElementById("team-plan-output").innerText;
          navigator.clipboard.writeText(text).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
        }

// ==========================================
// ğŸ† ãƒªãƒ¼ã‚°æˆ¦ç®¡ç†ï¼ˆå‡ç­‰é€²è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼‰
// ==========================================

let lPlayers = [];
let lMatches = [];
const L_STORAGE_KEY = "smartCoachLeagueData";

// é¸æ‰‹è¿½åŠ 
function addLeaguePlayersBulk() {
    const textarea = document.getElementById("league-player-bulk");
    if (!textarea) return;

    // æ”¹è¡Œã§åˆ†å‰²ã—ã€ç©ºç™½ã‚’é™¤å»ã€ç©ºè¡Œã‚’ç„¡è¦–
    const names = textarea.value.split(/\r?\n/).map(name => name.trim()).filter(name => name !== "");

    if (names.length === 0) return;

    let addedCount = 0;
    let skipCount = 0;

    names.forEach(name => {
        if (!lPlayers.includes(name)) {
            lPlayers.push(name);
            addedCount++;
        } else {
            skipCount++;
        }
    });

    textarea.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    renderLeaguePlayerList();

    if (skipCount > 0) {
        console.log(`${skipCount}åã®é‡è¤‡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`);
    }
}

// é¸æ‰‹ãƒªã‚¹ãƒˆUI
function renderLeaguePlayerList() {
    const container = document.getElementById("league-player-list");
    const btnGen = document.getElementById("btn-generate-league");
    container.innerHTML = "";
    
    lPlayers.forEach((p, i) => {
        const tag = document.createElement("span");
        tag.style.cssText = "background:#e0f2f1; border:1px solid #00897b; padding:4px 10px; border-radius:20px; font-size:13px; display:flex; align-items:center; gap:6px; color:#00695c;";
        tag.innerHTML = `${p} <span onclick="removeLeaguePlayer(${i})" style="cursor:pointer; color:#d32f2f; font-weight:bold;">Ã—</span>`;
        container.appendChild(tag);
    });
    btnGen.style.display = lPlayers.length >= 2 ? "block" : "none";
}

function removeLeaguePlayer(i) {
    lPlayers.splice(i, 1);
    renderLeaguePlayerList();
}

// å‡ç­‰é€²è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç”Ÿæˆ (ã‚µãƒ¼ã‚¯ãƒ«ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰)
function generateLeagueSchedule() {
    if (lPlayers.length < 2) return;
    if (lMatches.length > 0 && !confirm("ç¾åœ¨ã®çµæœã‚’ç ´æ£„ã—ã¦æ–°ã—ãä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) return;

    let names = [...lPlayers];
    if (names.length % 2 !== 0) names.push(null); // å¥‡æ•°ã®å ´åˆä¼‘ã¿(Bye)ã‚’å…¥ã‚Œã‚‹
    
    const n = names.length;
    const rounds = n - 1;
    const matchesPerRound = n / 2;
    lMatches = [];
    let matchCounter = 1;

    for (let r = 0; r < rounds; r++) {
        for (let i = 0; i < matchesPerRound; i++) {
            const p1 = names[i];
            const p2 = names[n - 1 - i];
            
            // ä¼‘ã¿(null)ã§ã¯ãªã„å ´åˆã®ã¿è©¦åˆè¿½åŠ 
            if (p1 !== null && p2 !== null) {
                lMatches.push({
                    id: matchCounter++,
                    round: r + 1,
                    p1: p1,
                    p2: p2,
                    s1: "",
                    s2: ""
                });
            }
        }
        // å††ç’°å›è»¢ï¼šæœ€åˆã®è¦ç´ ä»¥å¤–ã‚’å›ã™
        names.splice(1, 0, names.pop());
    }

    document.getElementById("league-table-area").style.display = "block";
    renderLeagueMatches();
    updateLeagueRanking();
    
    // ç”Ÿæˆæ™‚ã«è‡ªå‹•ä¿å­˜
    saveLeagueToBrowser(true);
}

// è©¦åˆè¡¨ã®æç”» (è¡¨å½¢å¼)
function renderLeagueMatches() {
    const body = document.getElementById("league-matches-body");
    body.innerHTML = "";

    lMatches.forEach((m, idx) => {
        const isDone = (m.s1 !== "" && m.s2 !== "");
        const tr = document.createElement("tr");
        tr.style.backgroundColor = isDone ? "#f9f9f9" : "#fff";
        
        tr.innerHTML = `
            <td style="border:1px solid #eee; padding:10px; text-align:center; color:#888;">${m.id}</td>
            <td style="border:1px solid #eee; padding:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="flex:1; text-align:right; font-weight:bold; color:#333;">${m.p1}</span>
                    <span style="margin:0 10px; color:#999; font-size:12px;">VS</span>
                    <span style="flex:1; text-align:left; font-weight:bold; color:#333;">${m.p2}</span>
                </div>
            </td>
            <td style="border:1px solid #eee; padding:10px; text-align:center;">
                <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                    <input type="number" value="${m.s1}" oninput="updateLScore(${idx}, 1, this.value)" style="width:40px; text-align:center; padding:5px; border:1px solid #ccc; border-radius:4px;">
                    <span>-</span>
                    <input type="number" value="${m.s2}" oninput="updateLScore(${idx}, 2, this.value)" style="width:40px; text-align:center; padding:5px; border:1px solid #ccc; border-radius:4px;">
                </div>
            </td>
            <td style="border:1px solid #eee; padding:10px; text-align:center; font-size:12px;">
                ${isDone ? '<span style="color:green;">æ¸ˆ</span>' : '<span style="color:#aaa;">å¾…æ©Ÿ</span>'}
            </td>
        `;
        body.appendChild(tr);
    });
}

function updateLScore(idx, playerNum, val) {
    if (playerNum === 1) lMatches[idx].s1 = val;
    else lMatches[idx].s2 = val;
    
    updateLeagueRanking();
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»æ›´æ–°ï¼ˆçŠ¶æ…‹ãƒ©ãƒ™ãƒ«ã®ãŸã‚ï¼‰
    const row = document.getElementById("league-matches-body").children[idx];
    const isDone = (lMatches[idx].s1 !== "" && lMatches[idx].s2 !== "");
    row.style.backgroundColor = isDone ? "#f9f9f9" : "#fff";
    row.children[3].innerHTML = isDone ? '<span style="color:green;">æ¸ˆ</span>' : '<span style="color:#aaa;">å¾…æ©Ÿ</span>';
}

// é †ä½è¡¨ã®æ›´æ–°
function updateLeagueRanking() {
    let stats = {};
    lPlayers.forEach(p => stats[p] = { name:p, win:0, lose:0, pointF:0, pointA:0 });

    lMatches.forEach(m => {
        const s1 = parseInt(m.s1);
        const s2 = parseInt(m.s2);
        if (!isNaN(s1) && !isNaN(s2)) {
            stats[m.p1].pointF += s1; stats[m.p1].pointA += s2;
            stats[m.p2].pointF += s2; stats[m.p2].pointA += s1;
            if (s1 > s2) { stats[m.p1].win++; stats[m.p2].lose++; }
            else if (s2 > s1) { stats[m.p2].win++; stats[m.p1].lose++; }
        }
    });

    let ranking = Object.values(stats).sort((a, b) => {
        if (b.win !== a.win) return b.win - a.win;
        const diffA = a.pointF - a.pointA;
        const diffB = b.pointF - b.pointA;
        if (diffB !== diffA) return diffB - diffA;
        return b.pointF - a.pointF;
    });

    let html = `
        <table style="width:100%; border-collapse:collapse; font-size:13px; text-align:center; border:2px solid #00796b;">
            <thead style="background:#00796b; color:#fff;">
                <tr>
                    <th style="padding:8px;">é †ä½</th>
                    <th style="padding:8px; text-align:left;">åå‰</th>
                    <th style="padding:8px;">å‹-æ•—</th>
                    <th style="padding:8px;">å¾—å¤±ç‚¹å·®</th>
                    <th style="padding:8px;">ç·å¾—ç‚¹</th>
                </tr>
            </thead>
            <tbody>
    `;

    ranking.forEach((r, i) => {
        const diff = r.pointF - r.pointA;
        html += `
            <tr style="background:${i%2===0?'#fff':'#f1f8e9'};">
                <td style="padding:10px; border-bottom:1px solid #ddd;">${i + 1}</td>
                <td style="padding:10px; border-bottom:1px solid #ddd; text-align:left; font-weight:bold;">${r.name}</td>
                <td style="padding:10px; border-bottom:1px solid #ddd;">${r.win}å‹ ${r.lose}æ•—</td>
                <td style="padding:10px; border-bottom:1px solid #ddd; color:${diff>0?'green':(diff<0?'red':'#333')}">${diff>0?'+'+diff:diff}</td>
                <td style="padding:10px; border-bottom:1px solid #ddd;">${r.pointF}</td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    document.getElementById("league-ranking-container").innerHTML = html;
}

// ğŸ’¾ ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ãƒ»å‰Šé™¤
function saveLeagueToBrowser(silent = false) {
    if (lPlayers.length === 0) return;
    const data = { players: lPlayers, matches: lMatches, timestamp: new Date().toLocaleString() };
    localStorage.setItem(L_STORAGE_KEY, JSON.stringify(data));
    if (!silent) alert("ãƒªãƒ¼ã‚°æˆ¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
}

function loadLeagueFromBrowser() {
    const json = localStorage.getItem(L_STORAGE_KEY);
    if (!json) return;
    const data = JSON.parse(json);
    lPlayers = data.players || [];
    lMatches = data.matches || [];
    
    if (lPlayers.length > 0) {
        renderLeaguePlayerList();
        if (lMatches.length > 0) {
            document.getElementById("league-table-area").style.display = "block";
            renderLeagueMatches();
            updateLeagueRanking();
        }
    }
}

function clearLeagueData() {
    if (!confirm("ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒªãƒ¼ã‚°æˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(L_STORAGE_KEY);
    lPlayers = [];
    lMatches = [];
    document.getElementById("league-table-area").style.display = "none";
    document.getElementById("league-player-list").innerHTML = "";
    document.getElementById("btn-generate-league").style.display = "none";
    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
}

// èµ·å‹•æ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
document.addEventListener("DOMContentLoaded", loadLeagueFromBrowser);

// ==========================================
// ğŸš€ AIã‚¸ãƒ£ãƒ³ãƒ—åŠ›æ¸¬å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè‡ªå‹•æ¤œçŸ¥ç‰ˆï¼‰
// ==========================================

// 1. ã‚«ãƒ¡ãƒ©èµ·å‹•
async function startJumpAICamera() {
    jumpModeActive = true;
    jumpGroundY = 0; // åœ°é¢åŸºæº–ã‚’ãƒªã‚»ãƒƒãƒˆ

const canvas = document.getElementById('jump_canvas');
    if (canvas) {
        canvas.width = 480;  // æ¨ªå¹…
        canvas.height = 640; // ç¸¦å¹…ï¼ˆã“ã“ã‚’å¤§ããã™ã‚‹ã“ã¨ã§ç¸¦é•·ã«ãªã‚Šã¾ã™ï¼‰
    }
    const statusEl = document.getElementById("jump-ai-status");
    if (statusEl) statusEl.textContent = "ğŸ“ åœ°é¢ã‚’èªè­˜ä¸­... ã¾ã£ã™ãç«‹ã£ã¦ãã ã•ã„";
    
    // æ—¢å­˜ã®ä»–ã®è§£æã‚«ãƒ¡ãƒ©ãŒå‹•ã„ã¦ã„ã‚Œã°åœæ­¢
    stopTracking(); 
    
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã®ã‚«ãƒ¡ãƒ©è¨­å®šã‚’ã‚¸ãƒ£ãƒ³ãƒ—ç”¨ã«ã‚»ãƒƒãƒˆã—ã¦èµ·å‹•
    currentFacingMode = jumpFacingMode; 
    startCamera(); 
}

// 2. ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
function toggleJumpCamera() {
    jumpFacingMode = (jumpFacingMode === 'user') ? 'environment' : 'user';
    if (jumpModeActive) startJumpAICamera();
}

// 3. åœ°é¢ãƒªã‚»ãƒƒãƒˆ
function resetJumpGround() {
    jumpGroundY = 0;
    const statusEl = document.getElementById("jump-ai-status");
    if (statusEl) statusEl.textContent = "ğŸ“ åœ°é¢ã‚’å†è¨­å®šã—ã¾ã—ãŸã€‚ã¾ã£ã™ãç«‹ã£ã¦ãã ã•ã„";
}


function processJumpResultDetailed(height, time) {
    document.getElementById("jump-result-area").style.display = "block";
    document.getElementById("val-jump-height").textContent = height.toFixed(1);
    
    // UIä¸Šã®å„IDã«æœ€å¤§å€¤ã‚’æ›¸ãè¾¼ã¿
    const elAngle = document.getElementById("max-knee-angle");
    const elAv = document.getElementById("max-knee-av");
    const elT = document.getElementById("max-knee-t-val");
    const elArm = document.getElementById("max-arm-v");

    if (elAngle) elAngle.textContent = Math.round(jumpMaxStats.angle);
    if (elAv) elAv.textContent = Math.round(jumpMaxStats.av);
    if (elT) elT.textContent = jumpMaxStats.torque.toFixed(1);
    if (elArm) elArm.textContent = (jumpMaxStats.armV * 10).toFixed(1);

    // æœ€é«˜åˆ°é”ç‚¹ã®è¨ˆç®—
    const userHeight = parseFloat(document.getElementById("bio-height")?.value || 170);
    const reach = (userHeight * 1.25) + height;
    const elReach = document.getElementById("val-jump-reach");
    if (elReach) elReach.textContent = reach.toFixed(1);

    // å±¥æ­´ä¿å­˜
    saveJumpData();

    // æ¬¡å›ã®è¨ˆæ¸¬ã®ãŸã‚ã«æœ€å¤§å€¤ã ã‘ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ã‚°ã¯downloadJumpCSVã§ä½¿ã†ãŸã‚æ®‹ã™ï¼‰
    jumpMaxStats = { angle: 0, av: 0, torque: 0, armV: 0 };
}

// 5. çµæœå‡¦ç†
function processJumpResultDetailed(height, time) {
    document.getElementById("jump-result-area").style.display = "block";
    document.getElementById("val-jump-height").textContent = height.toFixed(1);
    
    // æœ€å¤§å€¤ã‚’è¡¨ç¤º
    document.getElementById("max-knee-angle").textContent = Math.round(jumpMaxStats.angle);
    document.getElementById("max-knee-av").textContent = Math.round(jumpMaxStats.av);
    document.getElementById("max-knee-t-val").textContent = jumpMaxStats.torque.toFixed(1);
    document.getElementById("max-arm-v").textContent = (jumpMaxStats.armV * 10).toFixed(1);

    // æœ€å¤§å€¤ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡å›ã®è¨ˆæ¸¬ç”¨ï¼‰
    jumpMaxStats = { angle: 0, av: 0, torque: 0, armV: 0 };
}

function downloadJumpCSV() {
    if (jumpLog.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

    let csvContent = "Time(s),KneeAngle(deg),AngularVelocity(deg/s),KneeTorque(Nm),ArmSpeed,Event\n";
    jumpLog.forEach(row => {
        csvContent += `${row.time},${row.angle},${row.angularVelocity},${row.torque},${row.armSpeed},${row.event}\n`;
    });

    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const blob = new Blob([bom, csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `JumpAnalysis_${new Date().getTime()}.csv`;
    a.click();
}

// --- ä»¥ä¸‹ã€æ—¢å­˜ã®å±¥æ­´ç®¡ç† ---
let jumpHistoryData = [];
function saveJumpData() {
    const h = document.getElementById("val-jump-height").textContent;
    if (h === "0.0") return;
    const record = {
        date: new Date().toLocaleString("ja-JP", {month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"}),
        height: h
    };
    jumpHistoryData.unshift(record);
    if (jumpHistoryData.length > 10) jumpHistoryData.pop();
    localStorage.setItem("smartCoachJumpData", JSON.stringify(jumpHistoryData));
    renderJumpHistory();
}
function renderJumpHistory() {
    const container = document.getElementById("jump-history-list");
    if(!container) return;
    container.innerHTML = jumpHistoryData.map(d => `
        <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #f0f0f0;">
            <span style="color:#999;">${d.date}</span>
            <span style="font-weight:bold; color:#d81b60;">${d.height} cm</span>
        </div>
    `).join('');
}

// â˜…è¨ˆæ¸¬æº–å‚™ï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã®è¶³ã®é«˜ã•ã‚’åœ°é¢ã¨ã—ã¦å›ºå®šã™ã‚‹ï¼‰
function prepareJumpMeasurement() {
    if (!jumpModeActive) {
        alert("å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„");
        return;
    }
    if (latestJumpAnkleY) {
        jumpGroundY = latestJumpAnkleY;
        isJumpMeasuring = true;
        
        const statusEl = document.getElementById("jump-ai-status");
        if(statusEl) {
            statusEl.textContent = "â± æ¸¬å®šä¸­... è·³ã‚“ã§ãã ã•ã„ï¼";
            statusEl.style.background = "#ff3d00"; // æ¸¬å®šä¸­ã‚’å¼·èª¿
        }
        
        // æ•°å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
        jumpMaxStats = { angle: 0, av: 0, torque: 0, armV: 0 };
        jumpLog = [];
    } else {
        alert("AIãŒè¶³ã‚’èªè­˜ã§ãã¦ã„ã¾ã›ã‚“ã€‚ç”»é¢ã«å…¨èº«ã‚’æ˜ ã—ã¦ãã ã•ã„ã€‚");
    }
}

// ğŸŸ¥ AIã‚¸ãƒ£ãƒ³ãƒ—æ¸¬å®šã‚’å®Œå…¨ã«åœæ­¢ã™ã‚‹é–¢æ•°
function stopJumpAICamera() {
    // 1. è§£æãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ•ã«ã™ã‚‹
    jumpModeActive = false;
    isJumpAirborne = false;

    // 2. æ—¢å­˜ã®å…±é€šã‚«ãƒ¡ãƒ©åœæ­¢é–¢æ•°ã‚’å‘¼ã³å‡ºã™ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æ­¢ã‚ã‚‹ï¼‰
    stopTracking();

    // 3. ã‚¸ãƒ£ãƒ³ãƒ—å°‚ç”¨ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ã‚’çœŸã£é»’ã«ãƒªã‚»ãƒƒãƒˆ
    const canvas = document.getElementById('jump_canvas');
    if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 4. UIè¡¨ç¤ºã®ãƒªã‚»ãƒƒãƒˆ
    const statusEl = document.getElementById("jump-ai-status");
    if (statusEl) {
        statusEl.textContent = "OFFLINE";
        statusEl.style.background = "rgba(0, 0, 0, 0.6)";
    }
    
    const guideLine = document.getElementById("ground-line-guide");
    if (guideLine) guideLine.style.display = "none";

    console.log("Jump AI Camera Stopped.");
}
</script>
</body>

</html>
